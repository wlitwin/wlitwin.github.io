"use strict";
function _call(f, args) {
  while (args.length > 0) {
    const a = f._arity !== undefined ? f._arity : f.length;
    if (a === 0) { f = f(); continue; }
    if (args.length < a) return _partial(f, a, args);
    const taken = args.splice(0, a);
    f = f.apply(null, taken);
  }
  return f;
}
function _partial(fn, arity, args) {
  const p = function() {
    return _call(fn, args.concat(Array.from(arguments)));
  };
  p._arity = arity - args.length;
  return p;
}
function _eq(a, b) {
  if (a === b) return true;
  if (a == null || b == null) return a === b;
  if (typeof a !== "object") return false;
  if (Array.isArray(a)) {
    if (!Array.isArray(b) || a.length !== b.length) return false;
    for (let i = 0; i < a.length; i++) if (!_eq(a[i], b[i])) return false;
    return true;
  }
  if ("_arr" in a && "_arr" in b) {
    if (a._arr.length !== b._arr.length) return false;
    for (let i = 0; i < a._arr.length; i++) if (!_eq(a._arr[i], b._arr[i])) return false;
    return true;
  }
  if ("_hd" in a && "_hd" in b) {
    let ca = a, cb = b;
    while (ca !== null && cb !== null) {
      if (!("_hd" in ca) || !("_hd" in cb)) return ca === cb;
      if (!_eq(ca._hd, cb._hd)) return false;
      ca = ca._tl; cb = cb._tl;
    }
    return ca === cb;
  }
  if ("_tag" in a) return a._tag === b._tag && _eq(a._val, b._val);
  if ("_ref" in a) return _eq(a._ref, b._ref);
  const ka = Object.keys(a), kb = Object.keys(b);
  if (ka.length !== kb.length) return false;
  for (const k of ka) if (!_eq(a[k], b[k])) return false;
  return true;
}
function _compare(a, b) {
  if (a < b) return -1;
  if (a > b) return 1;
  return 0;
}
function _match_fail(loc) { throw new Error("Match failure at " + loc); }
function _pp(v) {
  if (v === undefined) return "()";
  if (v === null) return "[]";
  if (typeof v === "number") {
    if (!Number.isInteger(v)) {
      const s = String(v);
      return s.includes(".") || s.includes("e") ? s : s + ".";
    }
    return String(v);
  }
  if (typeof v === "boolean") return String(v);
  if (typeof v === "string") return v;
  if (Array.isArray(v)) return "(" + v.map(_pp).join(", ") + ")";
  if (v !== null && typeof v === "object") {
    if ("_arr" in v) return "#[" + v._arr.map(_pp).join("; ") + "]";
    if ("_hd" in v) {
      const r = [];
      let c = v;
      while (c !== null && typeof c === "object" && "_hd" in c) { r.push(_pp(c._hd)); c = c._tl; }
      return "[" + r.join("; ") + "]";
    }
    if ("_tag" in v) {
      if (v._val !== undefined) {
        const pv = _pp(v._val);
        if (Array.isArray(v._val) || (typeof v._val === "object" && v._val !== null && "_tag" in v._val && v._val._val !== undefined))
          return v._name + " (" + pv + ")";
        return v._name + " " + pv;
      }
      return v._name;
    }
    if ("_ref" in v) return "ref(" + _pp(v._ref) + ")";
    if (v instanceof Map) {
      const entries = Array.from(v.entries());
      const isSet = entries.every(([_,val]) => val === undefined);
      if (isSet) return "#{" + entries.map(([k]) => _pp(k)).join("; ") + "}";
      return "#{" + entries.map(([k,val]) => _pp(k) + ": " + _pp(val)).join("; ") + "}";
    }
    return "{ " + Object.entries(v).map(([k,val]) => k + " = " + _pp(val)).join("; ") + " }";
  }
  return String(v);
}
let _h = {};
function _bounce(fn) { fn._tramp = true; return fn; }
const _trampolining = new Set();
function _trampoline(fn, tag) {
  if (tag !== undefined && _trampolining.has(tag)) return fn();
  if (tag !== undefined) _trampolining.add(tag);
  try {
    let result = fn();
    while (typeof result === 'function' && result._tramp) {
      result = result();
    }
    return result;
  } finally { if (tag !== undefined) _trampolining.delete(tag); }
}
// --- Builtins ---
function print(v) {
  const s = (typeof v === "string") ? v : _pp(v);
  if (typeof globalThis._jsOutput === "function") globalThis._jsOutput(s);
  else if (typeof process !== "undefined") process.stdout.write(s);
  return undefined;
}
function println(v) {
  const s = (typeof v === "string") ? v : _pp(v);
  if (typeof globalThis._jsOutput === "function") globalThis._jsOutput(s + "\n");
  else if (typeof process !== "undefined") process.stdout.write(s + "\n");
  return undefined;
}
function string_of_int(n) { return String(n); }
function int_of_string(s) { const n = parseInt(s, 10); if (isNaN(n)) throw new Error("int_of_string: " + s); return n; }
function float_of_int(n) { return n; }
function int_of_float(f) { return Math.trunc(f); }
function float_of_string(s) { const f = parseFloat(s); if (isNaN(f)) throw new Error("float_of_string: " + s); return f; }
function string_of_float(f) {
  const s = String(f);
  return s.includes(".") || s.includes("e") ? s : s + ".";
}
function string_of_bool(b) { return String(b); }
function failwith(msg) { throw new Error(msg); }
const not = (b) => !b;
function $caret(a, b) { return a + b; }
function $mod(a, b) { return a % b; }
function __show_value(v) { return _pp(v); }
function copy_continuation(k) { return k; }
const ignore = (_) => undefined;
function fst(t) { return t[0]; }
function snd(t) { return t[1]; }
function string_length(s) { return s.length; }
function string_sub(s, start, len) { return s.substring(start, start + len); }
function string_get(s, i) { return s.charCodeAt(i); }
function string_contains(s, sub) { return s.includes(sub); }
function string_concat(sep, parts) {
  const arr = [];
  let c = parts;
  while (c !== null) { arr.push(c._hd); c = c._tl; }
  return arr.join(sep);
}
function array_length(a) { return a._arr.length; }
function array_get(a, i) { return a._arr[i]; }
function array_set(a, i, v) { a._arr[i] = v; return undefined; }
function array_make(n, v) { return {_arr: new Array(n).fill(v)}; }
function array_of_list(lst) {
  const arr = [];
  let c = lst;
  while (c !== null) { arr.push(c._hd); c = c._tl; }
  return {_arr: arr};
}
function array_to_list(arr) {
  const a = arr._arr;
  let result = null;
  for (let i = a.length - 1; i >= 0; i--) result = {_hd: a[i], _tl: result};
  return result;
}
function array_copy(a) { return {_arr: a._arr.slice()}; }
function array_sub(a, start, len) { return {_arr: a._arr.slice(start, start + len)}; }
function __math_pow(a, b) { return Math.pow(a, b); }
function __math_sqrt(x) { return Math.sqrt(x); }
function __math_floor(x) { return Math.floor(x); }
function __math_ceil(x) { return Math.ceil(x); }
function __math_round(x) { return Math.round(x); }
function __math_abs(x) { return Math.abs(x); }
function __math_sin(x) { return Math.sin(x); }
function __math_cos(x) { return Math.cos(x); }
function __math_abs_float(x) { return Math.abs(x); }
function __byte_to_char(b) { return String.fromCharCode(b); }
function __byte_to_int(b) { return b; }
function __byte_of_int(n) { return n & 0xFF; }
function __byte_to_string(b) { return String.fromCharCode(b); }
function __char_to_byte(s) { return s.charCodeAt(0); }
function __rune_to_string(cp) {
  return String.fromCodePoint(cp);
}
function __string_to_runes(s) {
  const cps = Array.from(s).map(c => c.codePointAt(0));
  let result = null;
  for (let i = cps.length - 1; i >= 0; i--) result = {_hd: cps[i], _tl: result};
  return result;
}
function __map_has(m, k) { return m.has(k); }
function __map_get(m, k) { return m.get(k); }
function __rune_to_int(r) { return r; }
function __rune_of_int(n) { return n; }
function __int_to_hex(n) { return n.toString(16); }
function __int_to_oct(n) { return n.toString(8); }
function __int_to_bin(n) { return n.toString(2); }
function __fmt_float(prec, f) { return f.toFixed(prec); }
function __fmt_hex(n) { return n.toString(16); }
function __fmt_hex_upper(n) { return n.toString(16).toUpperCase(); }
function __fmt_oct(n) { return n.toString(8); }
function __fmt_bin(n) { return n.toString(2); }
function __fmt_zero_pad(width, s) { return s.padStart(width, "0"); }
function __fmt_pad_left(width, s) { return s.padStart(width, " "); }
function __fmt_pad_right(width, s) { return s.padEnd(width, " "); }
function __sys_time() { return Date.now() / 1000.0; }
function __sys_exit(code) { if (typeof process !== "undefined") process.exit(code); throw new Error("exit: " + code); }
// --- Module extern stubs ---
// String module
function String$length(s) { return s.length; }
function String$sub(s, start, len) {
  if (start < 0 || len < 0 || start + len > s.length)
    throw new Error("String.sub: index out of bounds");
  return s.substring(start, start + len);
}
function String$split(delim, input) {
  if (delim.length === 0) {
    let r = null;
    for (let i = input.length - 1; i >= 0; i--) r = {_hd: input[i], _tl: r};
    return r;
  }
  const parts = input.split(delim);
  let r = null;
  for (let i = parts.length - 1; i >= 0; i--) r = {_hd: parts[i], _tl: r};
  return r;
}
function String$trim(s) { return s.trim(); }
function String$starts_with(prefix, s) { return s.startsWith(prefix); }
function String$contains(sub, s) { return s.includes(sub); }
function String$replace(old_s, new_s, input) {
  if (old_s.length === 0) return input;
  return input.split(old_s).join(new_s);
}
function String$to_int(s) { const n = parseInt(s,10); return isNaN(n) ? {_tag:0,_name:"None"} : {_tag:1,_name:"Some",_val:n}; }
function String$to_float(s) { const f = parseFloat(s); return isNaN(f) ? {_tag:0,_name:"None"} : {_tag:1,_name:"Some",_val:f}; }
function String$uppercase(s) { return s.toUpperCase(); }
function String$lowercase(s) { return s.toLowerCase(); }
function String$get(s, i) {
  if (i < 0 || i >= s.length) throw new Error("String.get: index " + i + " out of bounds (length " + s.length + ")");
  return s.charCodeAt(i);
}
function String$to_bytes(s) {
  let r = null;
  for (let i = s.length - 1; i >= 0; i--) r = {_hd: s.charCodeAt(i), _tl: r};
  return r;
}
function String$of_bytes(lst) {
  let r = "";
  let c = lst;
  while (c !== null) { r += String.fromCharCode(c._hd); c = c._tl; }
  return r;
}
function String$to_byte_array(s) {
  const a = new Array(s.length);
  for (let i = 0; i < s.length; i++) a[i] = s.charCodeAt(i);
  return {_arr: a};
}
function String$of_byte_array(a) {
  let r = "";
  for (let i = 0; i < a._arr.length; i++) r += String.fromCharCode(a._arr[i]);
  return r;
}
function String$to_runes(s) { return __string_to_runes(s); }
function String$of_runes(lst) {
  let r = "";
  let c = lst;
  while (c !== null) { r += String.fromCodePoint(c._hd); c = c._tl; }
  return r;
}
function String$get_rune(s, n) {
  const cps = Array.from(s);
  if (n < 0 || n >= cps.length) throw new Error("String.get_rune: index " + n + " out of bounds");
  return cps[n].codePointAt(0);
}
function String$of_byte(b) { return String.fromCharCode(b); }
function String$rune_length(s) { return Array.from(s).length; }
function String$make(n, b) {
  if (n < 0) throw new Error("String.make: negative length");
  return String.fromCharCode(b).repeat(n);
}
function String$index_opt(s, b) { const i=s.indexOf(String.fromCharCode(b)); return i<0?{_tag:0,_name:"None"}:{_tag:1,_name:"Some",_val:i}; }
function String$rindex_opt(s, b) { const i=s.lastIndexOf(String.fromCharCode(b)); return i<0?{_tag:0,_name:"None"}:{_tag:1,_name:"Some",_val:i}; }
function String$concat(sep, lst) { return string_concat(sep, lst); }
function String$compare(a, b) { return a < b ? -1 : a > b ? 1 : 0; }
// Array module
function Array$make(n, v) { return array_make(n, v); }
function Array$get(a, i) { return array_get(a, i); }
function Array$set(a, i, v) { return array_set(a, i, v); }
function Array$length(a) { return array_length(a); }
function Array$to_list(a) { return array_to_list(a); }
function Array$of_list(l) { return array_of_list(l); }
function Array$copy(a) { return array_copy(a); }
function Array$sub(a, s, l) { return array_sub(a, s, l); }
// IO module
function IO$read_file(path) {
  if (typeof globalThis._jsReadFile === "function") return globalThis._jsReadFile(path);
  if (typeof require !== "undefined") return require("fs").readFileSync(path,"utf8");
  throw new Error("IO.read_file: not available in this environment");
}
function IO$write_file(path, data) {
  if (typeof require !== "undefined") { require("fs").writeFileSync(path,data); return undefined; }
  throw new Error("IO.write_file: not available in this environment");
}
function IO$append_file(path, data) {
  if (typeof require !== "undefined") { require("fs").appendFileSync(path,data); return undefined; }
  throw new Error("IO.append_file: not available in this environment");
}
function IO$read_line(u) {
  if (typeof require !== "undefined") {
    const buf = Buffer.alloc(1);
    let line = "";
    const fd = require("fs").openSync("/dev/stdin", "rs");
    while (true) {
      const n = require("fs").readSync(fd, buf, 0, 1);
      if (n === 0 || buf[0] === 10) break;
      line += String.fromCharCode(buf[0]);
    }
    return line;
  }
  return "";
}
function IO$file_exists(path) {
  if (typeof require !== "undefined") return require("fs").existsSync(path);
  return false;
}
// Sys module
function Sys$args(u) {
  if (globalThis._jsSysArgs) {
    const a = globalThis._jsSysArgs;
    let r = null;
    for (let i = a.length - 1; i >= 0; i--) r = {_hd: a[i], _tl: r};
    return r;
  }
  if (typeof process !== "undefined") {
    const a = process.argv.slice(1);
    let r = null;
    for (let i = a.length - 1; i >= 0; i--) r = {_hd: a[i], _tl: r};
    return r;
  }
  return null;
}
function Sys$getenv(name) {
  if (typeof process !== "undefined") {
    const v = process.env[name];
    return v === undefined ? {_tag:0,_name:"None"} : {_tag:1,_name:"Some",_val:v};
  }
  return {_tag:0,_name:"None"};
}
function Sys$exit(code) { __sys_exit(code); }
function Sys$time(u) { return __sys_time(); }
// Runtime module (stubs â€” eval not supported in compiled JS)
function Runtime$eval(s) { throw new Error("Runtime.eval: not supported in compiled JS"); }
function Runtime$eval_file(s) { throw new Error("Runtime.eval_file: not supported in compiled JS"); }
// --- Typeclass Dictionaries ---
const __dict_Num_int = { $star: (a, b) => a * b, $plus: (a, b) => a + b, $minus: (a, b) => a - b, $slash: (a, b) => (a / b) | 0, neg: (a) => -a };
const __dict_Num_float = { $star: (a, b) => a * b, $plus: (a, b) => a + b, $minus: (a, b) => a - b, $slash: (a, b) => a / b, neg: (a) => -a };
const __dict_Eq_int = { $lt$gt: (a, b) => a !== b, $eq: (a, b) => a === b };
const __dict_Eq_float = { $lt$gt: (a, b) => a !== b, $eq: (a, b) => a === b };
const __dict_Eq_string = { $lt$gt: (a, b) => a !== b, $eq: (a, b) => a === b };
const __dict_Eq_bool = { $lt$gt: (a, b) => a !== b, $eq: (a, b) => a === b };
const __dict_Eq_byte = { $lt$gt: (a, b) => a !== b, $eq: (a, b) => a === b };
const __dict_Eq_rune = { $lt$gt: (a, b) => a !== b, $eq: (a, b) => a === b };
const __dict_Ord_int = { $lt: (a, b) => a < b, $lt$eq: (a, b) => a <= b, $gt: (a, b) => a > b, $gt$eq: (a, b) => a >= b };
const __dict_Ord_float = { $lt: (a, b) => a < b, $lt$eq: (a, b) => a <= b, $gt: (a, b) => a > b, $gt$eq: (a, b) => a >= b };
const __dict_Ord_string = { $lt: (a, b) => a < b, $lt$eq: (a, b) => a <= b, $gt: (a, b) => a > b, $gt$eq: (a, b) => a >= b };
const __dict_Ord_byte = { $lt: (a, b) => a < b, $lt$eq: (a, b) => a <= b, $gt: (a, b) => a > b, $gt$eq: (a, b) => a >= b };
const __dict_Ord_rune = { $lt: (a, b) => a < b, $lt$eq: (a, b) => a <= b, $gt: (a, b) => a > b, $gt$eq: (a, b) => a >= b };
const __dict_Bitwise_int = { land: (a, b) => a & b, lnot: (a) => ~a, lor: (a, b) => a | b, lsl: (a, b) => a << b, lsr: (a, b) => a >> b, lxor: (a, b) => a ^ b };
const __dict_Show_int = { show: (a) => String(a) };
const __dict_Show_float = { show: string_of_float };
const __dict_Show_bool = { show: (a) => String(a) };
const __dict_Show_string = { show: (a) => a };
const __dict_Show_unit = { show: (_) => "()" };
const __dict_Show_byte = { show: (a) => "#" + a.toString(16).padStart(2, "0") };
const __dict_Show_rune = { show: (a) => String.fromCodePoint(a) };
// --- Canvas builtins (browser only) ---
function Canvas$init(w, h) {
  if (typeof globalThis._canvasInit === "function") globalThis._canvasInit(w, h);
  return undefined;
}
function Canvas$clear(color) {
  const ctx = globalThis._canvasCtx;
  if (ctx) { ctx.fillStyle = color; ctx.fillRect(0, 0, ctx.canvas.width, ctx.canvas.height); }
  return undefined;
}
function Canvas$fill_rect(x, y, w, h, color) {
  const ctx = globalThis._canvasCtx;
  if (ctx) { ctx.fillStyle = color; ctx.fillRect(x, y, w, h); }
  return undefined;
}
function Canvas$stroke_rect(x, y, w, h, color) {
  const ctx = globalThis._canvasCtx;
  if (ctx) { ctx.strokeStyle = color; ctx.lineWidth = 1; ctx.strokeRect(x, y, w, h); }
  return undefined;
}
function Canvas$fill_circle(x, y, r, color) {
  const ctx = globalThis._canvasCtx;
  if (ctx) { ctx.fillStyle = color; ctx.beginPath(); ctx.arc(x, y, r, 0, 2*Math.PI); ctx.fill(); }
  return undefined;
}
function Canvas$draw_text(text, x, y, color) {
  const ctx = globalThis._canvasCtx;
  if (ctx) { ctx.fillStyle = color; ctx.textBaseline = "top"; ctx.fillText(text, x, y); }
  return undefined;
}
function Canvas$set_font(font) {
  const ctx = globalThis._canvasCtx;
  if (ctx) { ctx.font = font; }
  return undefined;
}
function Canvas$mouse_x(_) { return globalThis._canvasMouseX || 0; }
function Canvas$mouse_y(_) { return globalThis._canvasMouseY || 0; }
function Canvas$mouse_down(_) { return !!globalThis._canvasMouseDown; }
function Canvas$mouse_clicked(_) { return !!globalThis._canvasMouseClicked; }
function Canvas$key_down(key) { return !!(globalThis._canvasKeysDown && globalThis._canvasKeysDown[key]); }
function Canvas$key_pressed(key) { return !!(globalThis._canvasKeysPressed && globalThis._canvasKeysPressed[key]); }
function Canvas$start_app(init_fn, frame_fn) {
  globalThis._canvasApp = { initFn: init_fn, frameFn: frame_fn, jsMode: true, call: _call };
  return undefined;
}
// --- Stdlib ---
function _t0(f, acc, xs) {
  function go(a, l) {
    while (true) {
      let _t2;
      const _t1 = l;
      _t3: {
        if (_t1 === null) {
          _t2 = a;
          break _t3;
        }
        if (_t1 !== null) {
          const x = _t1._hd;
          const rest = _t1._tl;
          const _t4 = f(a, x);
          const _t5 = rest;
          a = _t4;
          l = _t5;
          continue;
          _t2 = undefined;
          break _t3;
        }
        _match_fail("line 14");
      }
      return _t2;
    }
  }
  const _t6 = go(acc, xs);
  return _t6;
}
const __dict_Iter_g0_list__g0 = ({fold: _t0});
function _t7(f, acc, arr) {
  function go(a, i) {
    while (true) {
      let _t8;
      if ((i === array_length(arr))) {
        _t8 = a;
      } else {
        const _t9 = f(a, array_get(arr, i));
        const _t10 = (i + 1);
        a = _t9;
        i = _t10;
        continue;
        _t8 = undefined;
      }
      return _t8;
    }
  }
  const _t11 = go(acc, 0);
  return _t11;
}
const __dict_Iter_g0_array__g0 = ({fold: _t7});
function __dict_Show_g0_list(__dict_Show_0) {
  function _t12(xs) {
    let _t14;
    const _t13 = xs;
    _t15: {
      if (_t13 === null) {
        _t14 = "[]";
        break _t15;
      }
      if (true) {
        function _t16(acc, x) {
          let _t17;
          if ((acc === "")) {
            _t17 = __dict_Show_0.show(x);
          } else {
            _t17 = ((acc + "; ") + __dict_Show_0.show(x));
          }
          return _t17;
        }
        _t14 = (("[" + __dict_Iter_g0_list__g0.fold(_t16, "", xs)) + "]");
        break _t15;
      }
      _match_fail("line 32");
    }
    return _t14;
  }
  return ({show: _t12});
}
function __dict_Show_g0_array(__dict_Show_0) {
  function _t18(arr) {
    let _t19;
    if ((array_length(arr) === 0)) {
      _t19 = "#[]";
    } else {
      function _t20(acc, x) {
        let _t21;
        if ((acc === "")) {
          _t21 = __dict_Show_0.show(x);
        } else {
          _t21 = ((acc + "; ") + __dict_Show_0.show(x));
        }
        return _t21;
      }
      _t19 = (("#[" + __dict_Iter_g0_array__g0.fold(_t20, "", arr)) + "]");
    }
    return _t19;
  }
  return ({show: _t18});
}
function __dict_Show_g0_option(__dict_Show_0) {
  function _t22(opt) {
    let _t24;
    const _t23 = opt;
    _t25: {
      if (_t23._tag === 0) {
        _t24 = "None";
        break _t25;
      }
      if (_t23._tag === 1) {
        const x = _t23._val;
        _t24 = ("Some " + __dict_Show_0.show(x));
        break _t25;
      }
      _match_fail("line 32");
    }
    return _t24;
  }
  return ({show: _t22});
}
function __dict_Show_g0_g1_tup(__dict_Show_0, __dict_Show_1) {
  function _t26(p) {
    let _t28;
    const _t27 = p;
    _t29: {
      if (true) {
        const a = _t27[0];
        const b = _t27[1];
        _t28 = (((("(" + __dict_Show_0.show(a)) + ", ") + __dict_Show_1.show(b)) + ")");
        break _t29;
      }
      _match_fail("line 32");
    }
    return _t28;
  }
  return ({show: _t26});
}
function __dict_Show_g0_g1_g2_tup(__dict_Show_0, __dict_Show_1, __dict_Show_2) {
  function _t30(p) {
    let _t32;
    const _t31 = p;
    _t33: {
      if (true) {
        const a = _t31[0];
        const b = _t31[1];
        const c = _t31[2];
        _t32 = (((((("(" + __dict_Show_0.show(a)) + ", ") + __dict_Show_1.show(b)) + ", ") + __dict_Show_2.show(c)) + ")");
        break _t33;
      }
      _match_fail("line 32");
    }
    return _t32;
  }
  return ({show: _t30});
}
function _t34(f, acc, m) {
  function go(a, l) {
    while (true) {
      let _t36;
      const _t35 = l;
      _t37: {
        if (_t35 === null) {
          _t36 = a;
          break _t37;
        }
        if (_t35 !== null) {
          const x = _t35._hd;
          const rest = _t35._tl;
          const _t38 = f(a, x);
          const _t39 = rest;
          a = _t38;
          l = _t39;
          continue;
          _t36 = undefined;
          break _t37;
        }
        _match_fail("line 6");
      }
      return _t36;
    }
  }
  const _t40 = go(acc, __dict_Map_g0_g1_map__g0__g1.to_list(m));
  return _t40;
}
const __dict_Iter_g1_g0_map__g1_g0_tup = ({fold: _t34});
if (typeof String$length === "undefined") { if (globalThis._mmlExterns && globalThis._mmlExterns["String.length"]) var String$length = globalThis._mmlExterns["String.length"]; else throw new Error("extern " + "String.length" + " not provided"); }
if (typeof String$sub === "undefined") { if (globalThis._mmlExterns && globalThis._mmlExterns["String.sub"]) var String$sub = globalThis._mmlExterns["String.sub"]; else throw new Error("extern " + "String.sub" + " not provided"); }
if (typeof String$split === "undefined") { if (globalThis._mmlExterns && globalThis._mmlExterns["String.split"]) var String$split = globalThis._mmlExterns["String.split"]; else throw new Error("extern " + "String.split" + " not provided"); }
if (typeof String$trim === "undefined") { if (globalThis._mmlExterns && globalThis._mmlExterns["String.trim"]) var String$trim = globalThis._mmlExterns["String.trim"]; else throw new Error("extern " + "String.trim" + " not provided"); }
if (typeof String$starts_with === "undefined") { if (globalThis._mmlExterns && globalThis._mmlExterns["String.starts_with"]) var String$starts_with = globalThis._mmlExterns["String.starts_with"]; else throw new Error("extern " + "String.starts_with" + " not provided"); }
if (typeof String$contains === "undefined") { if (globalThis._mmlExterns && globalThis._mmlExterns["String.contains"]) var String$contains = globalThis._mmlExterns["String.contains"]; else throw new Error("extern " + "String.contains" + " not provided"); }
if (typeof String$replace === "undefined") { if (globalThis._mmlExterns && globalThis._mmlExterns["String.replace"]) var String$replace = globalThis._mmlExterns["String.replace"]; else throw new Error("extern " + "String.replace" + " not provided"); }
if (typeof String$to_int === "undefined") { if (globalThis._mmlExterns && globalThis._mmlExterns["String.to_int"]) var String$to_int = globalThis._mmlExterns["String.to_int"]; else throw new Error("extern " + "String.to_int" + " not provided"); }
if (typeof String$to_float === "undefined") { if (globalThis._mmlExterns && globalThis._mmlExterns["String.to_float"]) var String$to_float = globalThis._mmlExterns["String.to_float"]; else throw new Error("extern " + "String.to_float" + " not provided"); }
if (typeof String$uppercase === "undefined") { if (globalThis._mmlExterns && globalThis._mmlExterns["String.uppercase"]) var String$uppercase = globalThis._mmlExterns["String.uppercase"]; else throw new Error("extern " + "String.uppercase" + " not provided"); }
if (typeof String$lowercase === "undefined") { if (globalThis._mmlExterns && globalThis._mmlExterns["String.lowercase"]) var String$lowercase = globalThis._mmlExterns["String.lowercase"]; else throw new Error("extern " + "String.lowercase" + " not provided"); }
if (typeof String$get === "undefined") { if (globalThis._mmlExterns && globalThis._mmlExterns["String.get"]) var String$get = globalThis._mmlExterns["String.get"]; else throw new Error("extern " + "String.get" + " not provided"); }
if (typeof String$to_bytes === "undefined") { if (globalThis._mmlExterns && globalThis._mmlExterns["String.to_bytes"]) var String$to_bytes = globalThis._mmlExterns["String.to_bytes"]; else throw new Error("extern " + "String.to_bytes" + " not provided"); }
if (typeof String$of_bytes === "undefined") { if (globalThis._mmlExterns && globalThis._mmlExterns["String.of_bytes"]) var String$of_bytes = globalThis._mmlExterns["String.of_bytes"]; else throw new Error("extern " + "String.of_bytes" + " not provided"); }
if (typeof String$to_byte_array === "undefined") { if (globalThis._mmlExterns && globalThis._mmlExterns["String.to_byte_array"]) var String$to_byte_array = globalThis._mmlExterns["String.to_byte_array"]; else throw new Error("extern " + "String.to_byte_array" + " not provided"); }
if (typeof String$of_byte_array === "undefined") { if (globalThis._mmlExterns && globalThis._mmlExterns["String.of_byte_array"]) var String$of_byte_array = globalThis._mmlExterns["String.of_byte_array"]; else throw new Error("extern " + "String.of_byte_array" + " not provided"); }
if (typeof String$to_runes === "undefined") { if (globalThis._mmlExterns && globalThis._mmlExterns["String.to_runes"]) var String$to_runes = globalThis._mmlExterns["String.to_runes"]; else throw new Error("extern " + "String.to_runes" + " not provided"); }
if (typeof String$of_runes === "undefined") { if (globalThis._mmlExterns && globalThis._mmlExterns["String.of_runes"]) var String$of_runes = globalThis._mmlExterns["String.of_runes"]; else throw new Error("extern " + "String.of_runes" + " not provided"); }
if (typeof String$get_rune === "undefined") { if (globalThis._mmlExterns && globalThis._mmlExterns["String.get_rune"]) var String$get_rune = globalThis._mmlExterns["String.get_rune"]; else throw new Error("extern " + "String.get_rune" + " not provided"); }
if (typeof String$of_byte === "undefined") { if (globalThis._mmlExterns && globalThis._mmlExterns["String.of_byte"]) var String$of_byte = globalThis._mmlExterns["String.of_byte"]; else throw new Error("extern " + "String.of_byte" + " not provided"); }
if (typeof String$rune_length === "undefined") { if (globalThis._mmlExterns && globalThis._mmlExterns["String.rune_length"]) var String$rune_length = globalThis._mmlExterns["String.rune_length"]; else throw new Error("extern " + "String.rune_length" + " not provided"); }
if (typeof String$make === "undefined") { if (globalThis._mmlExterns && globalThis._mmlExterns["String.make"]) var String$make = globalThis._mmlExterns["String.make"]; else throw new Error("extern " + "String.make" + " not provided"); }
if (typeof String$index_opt === "undefined") { if (globalThis._mmlExterns && globalThis._mmlExterns["String.index_opt"]) var String$index_opt = globalThis._mmlExterns["String.index_opt"]; else throw new Error("extern " + "String.index_opt" + " not provided"); }
if (typeof String$rindex_opt === "undefined") { if (globalThis._mmlExterns && globalThis._mmlExterns["String.rindex_opt"]) var String$rindex_opt = globalThis._mmlExterns["String.rindex_opt"]; else throw new Error("extern " + "String.rindex_opt" + " not provided"); }
if (typeof String$concat === "undefined") { if (globalThis._mmlExterns && globalThis._mmlExterns["String.concat"]) var String$concat = globalThis._mmlExterns["String.concat"]; else throw new Error("extern " + "String.concat" + " not provided"); }
if (typeof String$compare === "undefined") { if (globalThis._mmlExterns && globalThis._mmlExterns["String.compare"]) var String$compare = globalThis._mmlExterns["String.compare"]; else throw new Error("extern " + "String.compare" + " not provided"); }
function String$iter(f, s) {
  const n_41 = String$length(s);
  function go(i) {
    while (true) {
      let _t43;
      if ((i >= n_41)) {
        _t43 = undefined;
      } else {
        f(String$get(s, i));
        const _t44 = (i + 1);
        i = _t44;
        continue;
        _t43 = undefined;
      }
      return _t43;
    }
  }
  const _t45 = go(0);
  const _t42 = _t45;
  return _t42;
}
function List$fold(f, acc, xs) {
  function go(a, l) {
    while (true) {
      let _t47;
      const _t46 = l;
      _t48: {
        if (_t46 === null) {
          _t47 = a;
          break _t48;
        }
        if (_t46 !== null) {
          const x = _t46._hd;
          const rest = _t46._tl;
          const _t49 = f(a, x);
          const _t50 = rest;
          a = _t49;
          l = _t50;
          continue;
          _t47 = undefined;
          break _t48;
        }
        _match_fail("line 259");
      }
      return _t47;
    }
  }
  const _t51 = go(acc, xs);
  return _t51;
}
function List$length(xs) {
  function _t52(acc, _) {
    return (acc + 1);
  }
  return List$fold(_t52, 0, xs);
}
function List$rev(xs) {
  function _t53(acc, x) {
    return ({_hd: x, _tl: acc});
  }
  return List$fold(_t53, null, xs);
}
function List$hd(xs) {
  let _t55;
  const _t54 = xs;
  _t56: {
    if (_t54 !== null) {
      const x = _t54._hd;
      _t55 = x;
      break _t56;
    }
    _match_fail("line 259");
  }
  return _t55;
}
function List$tl(xs) {
  let _t58;
  const _t57 = xs;
  _t59: {
    if (_t57 !== null) {
      const rest = _t57._tl;
      _t58 = rest;
      break _t59;
    }
    _match_fail("line 259");
  }
  return _t58;
}
function List$nth(xs, n) {
  function go(l, i) {
    while (true) {
      let _t61;
      const _t60 = l;
      _t62: {
        if (_t60 !== null) {
          const x = _t60._hd;
          const rest = _t60._tl;
          let _t63;
          if ((i === 0)) {
            _t63 = x;
          } else {
            const _t64 = rest;
            const _t65 = (i - 1);
            l = _t64;
            i = _t65;
            continue;
            _t63 = undefined;
          }
          _t61 = _t63;
          break _t62;
        }
        _match_fail("line 259");
      }
      return _t61;
    }
  }
  const _t66 = go(xs, n);
  return _t66;
}
function List$concat(a, b) {
  function _t67(acc, x) {
    return ({_hd: x, _tl: acc});
  }
  return List$fold(_t67, b, List$rev(a));
}
function List$is_empty(xs) {
  let _t69;
  const _t68 = xs;
  _t70: {
    if (_t68 === null) {
      _t69 = true;
      break _t70;
    }
    if (true) {
      _t69 = false;
      break _t70;
    }
    _match_fail("line 259");
  }
  return _t69;
}
function List$flatten(xss) {
  function _t71(acc, xs) {
    return List$concat(acc, xs);
  }
  return List$fold(_t71, null, xss);
}
function List$map(f, xs) {
  function go(acc, l) {
    while (true) {
      let _t73;
      const _t72 = l;
      _t74: {
        if (_t72 === null) {
          _t73 = List$rev(acc);
          break _t74;
        }
        if (_t72 !== null) {
          const x = _t72._hd;
          const rest = _t72._tl;
          const _t75 = ({_hd: f(x), _tl: acc});
          const _t76 = rest;
          acc = _t75;
          l = _t76;
          continue;
          _t73 = undefined;
          break _t74;
        }
        _match_fail("line 259");
      }
      return _t73;
    }
  }
  const _t77 = go(null, xs);
  return _t77;
}
function List$filter(f, xs) {
  function go(acc, l) {
    while (true) {
      let _t79;
      const _t78 = l;
      _t80: {
        if (_t78 === null) {
          _t79 = List$rev(acc);
          break _t80;
        }
        if (_t78 !== null) {
          const x = _t78._hd;
          const rest = _t78._tl;
          let _t81;
          if (f(x)) {
            const _t82 = ({_hd: x, _tl: acc});
            const _t83 = rest;
            acc = _t82;
            l = _t83;
            continue;
            _t81 = undefined;
          } else {
            const _t84 = acc;
            const _t85 = rest;
            acc = _t84;
            l = _t85;
            continue;
            _t81 = undefined;
          }
          _t79 = _t81;
          break _t80;
        }
        _match_fail("line 259");
      }
      return _t79;
    }
  }
  const _t86 = go(null, xs);
  return _t86;
}
function List$find(f, xs) {
  function go(l) {
    while (true) {
      let _t88;
      const _t87 = l;
      _t89: {
        if (_t87 === null) {
          _t88 = ({_tag: 0, _name: "None"});
          break _t89;
        }
        if (_t87 !== null) {
          const x = _t87._hd;
          const rest = _t87._tl;
          let _t90;
          if (f(x)) {
            _t90 = ({_tag: 1, _name: "Some", _val: x});
          } else {
            const _t91 = rest;
            l = _t91;
            continue;
            _t90 = undefined;
          }
          _t88 = _t90;
          break _t89;
        }
        _match_fail("line 259");
      }
      return _t88;
    }
  }
  const _t92 = go(xs);
  return _t92;
}
function List$exists(f, xs) {
  function go(l) {
    while (true) {
      let _t94;
      const _t93 = l;
      _t95: {
        if (_t93 === null) {
          _t94 = false;
          break _t95;
        }
        if (_t93 !== null) {
          const x = _t93._hd;
          const rest = _t93._tl;
          let _t96;
          if (f(x)) {
            _t96 = true;
          } else {
            const _t97 = rest;
            l = _t97;
            continue;
            _t96 = undefined;
          }
          _t94 = _t96;
          break _t95;
        }
        _match_fail("line 259");
      }
      return _t94;
    }
  }
  const _t98 = go(xs);
  return _t98;
}
function List$forall(f, xs) {
  function go(l) {
    while (true) {
      let _t100;
      const _t99 = l;
      _t101: {
        if (_t99 === null) {
          _t100 = true;
          break _t101;
        }
        if (_t99 !== null) {
          const x = _t99._hd;
          const rest = _t99._tl;
          let _t102;
          if (f(x)) {
            const _t103 = rest;
            l = _t103;
            continue;
            _t102 = undefined;
          } else {
            _t102 = false;
          }
          _t100 = _t102;
          break _t101;
        }
        _match_fail("line 259");
      }
      return _t100;
    }
  }
  const _t104 = go(xs);
  return _t104;
}
function List$zip(xs, ys) {
  function go(acc, a, b) {
    while (true) {
      let _t106;
      const _t105 = a;
      _t107: {
        if (_t105 === null) {
          _t106 = List$rev(acc);
          break _t107;
        }
        if (_t105 !== null) {
          const x = _t105._hd;
          const ra = _t105._tl;
          let _t109;
          const _t108 = b;
          _t110: {
            if (_t108 !== null) {
              const y = _t108._hd;
              const rb = _t108._tl;
              const _t111 = ({_hd: [x, y], _tl: acc});
              const _t112 = ra;
              const _t113 = rb;
              acc = _t111;
              a = _t112;
              b = _t113;
              continue;
              _t109 = undefined;
              break _t110;
            }
            _match_fail("line 259");
          }
          _t106 = _t109;
          break _t107;
        }
        _match_fail("line 259");
      }
      return _t106;
    }
  }
  const _t114 = go(null, xs, ys);
  return _t114;
}
function List$mapi(f, xs) {
  function go(i, acc, l) {
    while (true) {
      let _t116;
      const _t115 = l;
      _t117: {
        if (_t115 === null) {
          _t116 = List$rev(acc);
          break _t117;
        }
        if (_t115 !== null) {
          const x = _t115._hd;
          const rest = _t115._tl;
          const _t118 = (i + 1);
          const _t119 = ({_hd: f(i, x), _tl: acc});
          const _t120 = rest;
          i = _t118;
          acc = _t119;
          l = _t120;
          continue;
          _t116 = undefined;
          break _t117;
        }
        _match_fail("line 259");
      }
      return _t116;
    }
  }
  const _t121 = go(0, null, xs);
  return _t121;
}
function List$sort(cmp, xs) {
  function insert(x, sorted) {
    let _t123;
    const _t122 = sorted;
    _t124: {
      if (_t122 === null) {
        _t123 = ({_hd: x, _tl: null});
        break _t124;
      }
      if (_t122 !== null) {
        const y = _t122._hd;
        const rest = _t122._tl;
        let _t125;
        if ((cmp(x, y) < 1)) {
          _t125 = ({_hd: x, _tl: sorted});
        } else {
          _t125 = ({_hd: y, _tl: insert(x, rest)});
        }
        _t123 = _t125;
        break _t124;
      }
      _match_fail("line 259");
    }
    return _t123;
  }
  function _t127(acc, x) {
    return insert(x, acc);
  }
  const _t126 = List$fold(_t127, null, xs);
  return _t126;
}
function List$fold_right(f, xs, acc) {
  function go(l) {
    let _t129;
    const _t128 = l;
    _t130: {
      if (_t128 === null) {
        _t129 = acc;
        break _t130;
      }
      if (_t128 !== null) {
        const x = _t128._hd;
        const rest = _t128._tl;
        _t129 = f(x, go(rest));
        break _t130;
      }
      _match_fail("line 259");
    }
    return _t129;
  }
  const _t131 = go(xs);
  return _t131;
}
function List$find_map(f, xs) {
  function go(l) {
    while (true) {
      let _t133;
      const _t132 = l;
      _t134: {
        if (_t132 === null) {
          _t133 = ({_tag: 0, _name: "None"});
          break _t134;
        }
        if (_t132 !== null) {
          const x = _t132._hd;
          const rest = _t132._tl;
          let _t136;
          const _t135 = f(x);
          _t137: {
            if (_t135._tag === 1) {
              const result = _t135;
              _t136 = result;
              break _t137;
            }
            if (_t135._tag === 0) {
              const _t138 = rest;
              l = _t138;
              continue;
              _t136 = undefined;
              break _t137;
            }
            _match_fail("line 259");
          }
          _t133 = _t136;
          break _t134;
        }
        _match_fail("line 259");
      }
      return _t133;
    }
  }
  const _t139 = go(xs);
  return _t139;
}
function List$assoc_opt(key, xs) {
  function go(l) {
    while (true) {
      let _t141;
      const _t140 = l;
      _t142: {
        if (_t140 === null) {
          _t141 = ({_tag: 0, _name: "None"});
          break _t142;
        }
        if (_t140 !== null) {
          const k = _t140._hd[0];
          const v = _t140._hd[1];
          const rest = _t140._tl;
          let _t143;
          if (_eq(k, key)) {
            _t143 = ({_tag: 1, _name: "Some", _val: v});
          } else {
            const _t144 = rest;
            l = _t144;
            continue;
            _t143 = undefined;
          }
          _t141 = _t143;
          break _t142;
        }
        _match_fail("line 259");
      }
      return _t141;
    }
  }
  const _t145 = go(xs);
  return _t145;
}
function List$init(n, f) {
  function go(i, acc) {
    while (true) {
      let _t146;
      if ((i < 0)) {
        _t146 = acc;
      } else {
        const _t147 = (i - 1);
        const _t148 = ({_hd: f(i), _tl: acc});
        i = _t147;
        acc = _t148;
        continue;
        _t146 = undefined;
      }
      return _t146;
    }
  }
  const _t149 = go((n - 1), null);
  return _t149;
}
function List$concat_map(f, xs) {
  return List$flatten(List$map(f, xs));
}
function List$iter2(f, xs, ys) {
  function go(a, b) {
    while (true) {
      let _t151;
      const _t150 = a;
      _t152: {
        if (_t150 === null) {
          _t151 = undefined;
          break _t152;
        }
        if (_t150 !== null) {
          const x = _t150._hd;
          const ra = _t150._tl;
          let _t154;
          const _t153 = b;
          _t155: {
            if (_t153 !== null) {
              const y = _t153._hd;
              const rb = _t153._tl;
              f(x, y);
              const _t156 = ra;
              const _t157 = rb;
              a = _t156;
              b = _t157;
              continue;
              _t154 = undefined;
              break _t155;
            }
            _match_fail("line 259");
          }
          _t151 = _t154;
          break _t152;
        }
        _match_fail("line 259");
      }
      return _t151;
    }
  }
  const _t158 = go(xs, ys);
  return _t158;
}
function List$map2(f, xs, ys) {
  function go(acc, a, b) {
    while (true) {
      let _t160;
      const _t159 = a;
      _t161: {
        if (_t159 === null) {
          _t160 = List$rev(acc);
          break _t161;
        }
        if (_t159 !== null) {
          const x = _t159._hd;
          const ra = _t159._tl;
          let _t163;
          const _t162 = b;
          _t164: {
            if (_t162 !== null) {
              const y = _t162._hd;
              const rb = _t162._tl;
              const _t165 = ({_hd: f(x, y), _tl: acc});
              const _t166 = ra;
              const _t167 = rb;
              acc = _t165;
              a = _t166;
              b = _t167;
              continue;
              _t163 = undefined;
              break _t164;
            }
            _match_fail("line 259");
          }
          _t160 = _t163;
          break _t161;
        }
        _match_fail("line 259");
      }
      return _t160;
    }
  }
  const _t168 = go(null, xs, ys);
  return _t168;
}
function List$fold2(f, acc, xs, ys) {
  function go(a, l1, l2) {
    while (true) {
      let _t170;
      const _t169 = l1;
      _t171: {
        if (_t169 === null) {
          _t170 = a;
          break _t171;
        }
        if (_t169 !== null) {
          const x = _t169._hd;
          const r1 = _t169._tl;
          let _t173;
          const _t172 = l2;
          _t174: {
            if (_t172 !== null) {
              const y = _t172._hd;
              const r2 = _t172._tl;
              const _t175 = f(a, x, y);
              const _t176 = r1;
              const _t177 = r2;
              a = _t175;
              l1 = _t176;
              l2 = _t177;
              continue;
              _t173 = undefined;
              break _t174;
            }
            _match_fail("line 259");
          }
          _t170 = _t173;
          break _t171;
        }
        _match_fail("line 259");
      }
      return _t170;
    }
  }
  const _t178 = go(acc, xs, ys);
  return _t178;
}
function List$forall2(f, xs, ys) {
  function go(a, b) {
    while (true) {
      let _t180;
      const _t179 = a;
      _t181: {
        if (_t179 === null) {
          _t180 = true;
          break _t181;
        }
        if (_t179 !== null) {
          const x = _t179._hd;
          const ra = _t179._tl;
          let _t183;
          const _t182 = b;
          _t184: {
            if (_t182 !== null) {
              const y = _t182._hd;
              const rb = _t182._tl;
              let _t185;
              if (f(x, y)) {
                const _t186 = ra;
                const _t187 = rb;
                a = _t186;
                b = _t187;
                continue;
                _t185 = undefined;
              } else {
                _t185 = false;
              }
              _t183 = _t185;
              break _t184;
            }
            _match_fail("line 259");
          }
          _t180 = _t183;
          break _t181;
        }
        _match_fail("line 259");
      }
      return _t180;
    }
  }
  const _t188 = go(xs, ys);
  return _t188;
}
function List$iteri(f, xs) {
  function go(i, l) {
    while (true) {
      let _t190;
      const _t189 = l;
      _t191: {
        if (_t189 === null) {
          _t190 = undefined;
          break _t191;
        }
        if (_t189 !== null) {
          const x = _t189._hd;
          const rest = _t189._tl;
          f(i, x);
          const _t192 = (i + 1);
          const _t193 = rest;
          i = _t192;
          l = _t193;
          continue;
          _t190 = undefined;
          break _t191;
        }
        _match_fail("line 259");
      }
      return _t190;
    }
  }
  const _t194 = go(0, xs);
  return _t194;
}
function List$mem_assoc(key, xs) {
  function go(l) {
    while (true) {
      let _t196;
      const _t195 = l;
      _t197: {
        if (_t195 === null) {
          _t196 = false;
          break _t197;
        }
        if (_t195 !== null) {
          const k = _t195._hd[0];
          const rest = _t195._tl;
          let _t198;
          if (_eq(k, key)) {
            _t198 = true;
          } else {
            const _t199 = rest;
            l = _t199;
            continue;
            _t198 = undefined;
          }
          _t196 = _t198;
          break _t197;
        }
        _match_fail("line 259");
      }
      return _t196;
    }
  }
  const _t200 = go(xs);
  return _t200;
}
function List$assoc(key, xs) {
  let _t202;
  const _t201 = List$assoc_opt(key, xs);
  _t203: {
    if (_t201._tag === 1) {
      const v = _t201._val;
      _t202 = v;
      break _t203;
    }
    if (_t201._tag === 0) {
      _t202 = failwith("List.assoc: not found");
      break _t203;
    }
    _match_fail("line 259");
  }
  return _t202;
}
function List$iter(f, xs) {
  function go(xs) {
    while (true) {
      let _t205;
      const _t204 = xs;
      _t206: {
        if (_t204 === null) {
          _t205 = undefined;
          break _t206;
        }
        if (_t204 !== null) {
          const x = _t204._hd;
          const rest = _t204._tl;
          f(x);
          const _t207 = rest;
          xs = _t207;
          continue;
          _t205 = undefined;
          break _t206;
        }
        _match_fail("line 259");
      }
      return _t205;
    }
  }
  const _t208 = go(xs);
  return _t208;
}
function List$mem(x, xs) {
  function go(xs) {
    while (true) {
      let _t210;
      const _t209 = xs;
      _t211: {
        if (_t209 === null) {
          _t210 = false;
          break _t211;
        }
        if (_t209 !== null) {
          const y = _t209._hd;
          const rest = _t209._tl;
          let _t212;
          if (_eq(x, y)) {
            _t212 = true;
          } else {
            const _t213 = rest;
            xs = _t213;
            continue;
            _t212 = undefined;
          }
          _t210 = _t212;
          break _t211;
        }
        _match_fail("line 259");
      }
      return _t210;
    }
  }
  const _t214 = go(xs);
  return _t214;
}
function List$rev_append(xs, ys) {
  function go(xs, acc) {
    while (true) {
      let _t216;
      const _t215 = xs;
      _t217: {
        if (_t215 === null) {
          _t216 = acc;
          break _t217;
        }
        if (_t215 !== null) {
          const x = _t215._hd;
          const rest = _t215._tl;
          const _t218 = rest;
          const _t219 = ({_hd: x, _tl: acc});
          xs = _t218;
          acc = _t219;
          continue;
          _t216 = undefined;
          break _t217;
        }
        _match_fail("line 259");
      }
      return _t216;
    }
  }
  const _t220 = go(xs, ys);
  return _t220;
}
function List$nth_opt(xs, n) {
  function go(xs, i) {
    while (true) {
      let _t222;
      const _t221 = xs;
      _t223: {
        if (_t221 === null) {
          _t222 = ({_tag: 0, _name: "None"});
          break _t223;
        }
        if (_t221 !== null) {
          const x = _t221._hd;
          const rest = _t221._tl;
          let _t224;
          if ((i === 0)) {
            _t224 = ({_tag: 1, _name: "Some", _val: x});
          } else {
            const _t225 = rest;
            const _t226 = (i - 1);
            xs = _t225;
            i = _t226;
            continue;
            _t224 = undefined;
          }
          _t222 = _t224;
          break _t223;
        }
        _match_fail("line 259");
      }
      return _t222;
    }
  }
  const _t227 = go(xs, n);
  return _t227;
}
function List$find_index(f, xs) {
  function go(xs, i) {
    while (true) {
      let _t229;
      const _t228 = xs;
      _t230: {
        if (_t228 === null) {
          _t229 = ({_tag: 0, _name: "None"});
          break _t230;
        }
        if (_t228 !== null) {
          const x = _t228._hd;
          const rest = _t228._tl;
          let _t231;
          if (f(x)) {
            _t231 = ({_tag: 1, _name: "Some", _val: i});
          } else {
            const _t232 = rest;
            const _t233 = (i + 1);
            xs = _t232;
            i = _t233;
            continue;
            _t231 = undefined;
          }
          _t229 = _t231;
          break _t230;
        }
        _match_fail("line 259");
      }
      return _t229;
    }
  }
  const _t234 = go(xs, 0);
  return _t234;
}
function List$filteri(f, xs) {
  function go(xs, i, acc) {
    while (true) {
      let _t236;
      const _t235 = xs;
      _t237: {
        if (_t235 === null) {
          _t236 = List$rev(acc);
          break _t237;
        }
        if (_t235 !== null) {
          const x = _t235._hd;
          const rest = _t235._tl;
          let _t238;
          if (f(i, x)) {
            const _t239 = rest;
            const _t240 = (i + 1);
            const _t241 = ({_hd: x, _tl: acc});
            xs = _t239;
            i = _t240;
            acc = _t241;
            continue;
            _t238 = undefined;
          } else {
            const _t242 = rest;
            const _t243 = (i + 1);
            const _t244 = acc;
            xs = _t242;
            i = _t243;
            acc = _t244;
            continue;
            _t238 = undefined;
          }
          _t236 = _t238;
          break _t237;
        }
        _match_fail("line 259");
      }
      return _t236;
    }
  }
  const _t245 = go(xs, 0, null);
  return _t245;
}
function List$filter_map(f, xs) {
  function go(xs, acc) {
    while (true) {
      let _t247;
      const _t246 = xs;
      _t248: {
        if (_t246 === null) {
          _t247 = List$rev(acc);
          break _t248;
        }
        if (_t246 !== null) {
          const x = _t246._hd;
          const rest = _t246._tl;
          let _t250;
          const _t249 = f(x);
          _t251: {
            if (_t249._tag === 1) {
              const y = _t249._val;
              const _t252 = rest;
              const _t253 = ({_hd: y, _tl: acc});
              xs = _t252;
              acc = _t253;
              continue;
              _t250 = undefined;
              break _t251;
            }
            if (_t249._tag === 0) {
              const _t254 = rest;
              const _t255 = acc;
              xs = _t254;
              acc = _t255;
              continue;
              _t250 = undefined;
              break _t251;
            }
            _match_fail("line 259");
          }
          _t247 = _t250;
          break _t248;
        }
        _match_fail("line 259");
      }
      return _t247;
    }
  }
  const _t256 = go(xs, null);
  return _t256;
}
function List$sort_uniq(cmp, xs) {
  const sorted_257 = List$sort(cmp, xs);
  function dedup(xs) {
    while (true) {
      let _t260;
      const _t259 = xs;
      _t261: {
        if (_t259 === null) {
          _t260 = null;
          break _t261;
        }
        if (_t259 !== null && _t259._tl === null) {
          const x = _t259._hd;
          _t260 = ({_hd: x, _tl: null});
          break _t261;
        }
        if (_t259 !== null && _t259._tl !== null) {
          const x = _t259._hd;
          const y = _t259._tl._hd;
          const rest = _t259._tl._tl;
          let _t262;
          if ((cmp(x, y) === 0)) {
            const _t263 = ({_hd: y, _tl: rest});
            xs = _t263;
            continue;
            _t262 = undefined;
          } else {
            _t262 = ({_hd: x, _tl: dedup(({_hd: y, _tl: rest}))});
          }
          _t260 = _t262;
          break _t261;
        }
        _match_fail("line 259");
      }
      return _t260;
    }
  }
  const _t264 = dedup(sorted_257);
  const _t258 = _t264;
  return _t258;
}
if (typeof Array$make === "undefined") { if (globalThis._mmlExterns && globalThis._mmlExterns["Array.make"]) var Array$make = globalThis._mmlExterns["Array.make"]; else throw new Error("extern " + "Array.make" + " not provided"); }
if (typeof Array$get === "undefined") { if (globalThis._mmlExterns && globalThis._mmlExterns["Array.get"]) var Array$get = globalThis._mmlExterns["Array.get"]; else throw new Error("extern " + "Array.get" + " not provided"); }
if (typeof Array$set === "undefined") { if (globalThis._mmlExterns && globalThis._mmlExterns["Array.set"]) var Array$set = globalThis._mmlExterns["Array.set"]; else throw new Error("extern " + "Array.set" + " not provided"); }
if (typeof Array$length === "undefined") { if (globalThis._mmlExterns && globalThis._mmlExterns["Array.length"]) var Array$length = globalThis._mmlExterns["Array.length"]; else throw new Error("extern " + "Array.length" + " not provided"); }
if (typeof Array$to_list === "undefined") { if (globalThis._mmlExterns && globalThis._mmlExterns["Array.to_list"]) var Array$to_list = globalThis._mmlExterns["Array.to_list"]; else throw new Error("extern " + "Array.to_list" + " not provided"); }
if (typeof Array$of_list === "undefined") { if (globalThis._mmlExterns && globalThis._mmlExterns["Array.of_list"]) var Array$of_list = globalThis._mmlExterns["Array.of_list"]; else throw new Error("extern " + "Array.of_list" + " not provided"); }
if (typeof Array$copy === "undefined") { if (globalThis._mmlExterns && globalThis._mmlExterns["Array.copy"]) var Array$copy = globalThis._mmlExterns["Array.copy"]; else throw new Error("extern " + "Array.copy" + " not provided"); }
if (typeof Array$sub === "undefined") { if (globalThis._mmlExterns && globalThis._mmlExterns["Array.sub"]) var Array$sub = globalThis._mmlExterns["Array.sub"]; else throw new Error("extern " + "Array.sub" + " not provided"); }
function Array$init(n, f) {
  let _t265;
  if ((n <= 0)) {
    _t265 = {_arr: []};
  } else {
    const arr_266 = Array$make(n, f(0));
    function go(i) {
      while (true) {
        let _t268;
        if ((i >= n)) {
          _t268 = arr_266;
        } else {
          Array$set(arr_266, i, f(i));
          const _t269 = (i + 1);
          i = _t269;
          continue;
          _t268 = undefined;
        }
        return _t268;
      }
    }
    const _t270 = go(1);
    const _t267 = _t270;
    _t265 = _t267;
  }
  return _t265;
}
function Array$map(f, arr) {
  const n_271 = Array$length(arr);
  let _t273;
  if ((n_271 === 0)) {
    _t273 = {_arr: []};
  } else {
    const result_274 = Array$make(n_271, f(Array$get(arr, 0)));
    function go(i) {
      while (true) {
        let _t276;
        if ((i >= n_271)) {
          _t276 = result_274;
        } else {
          Array$set(result_274, i, f(Array$get(arr, i)));
          const _t277 = (i + 1);
          i = _t277;
          continue;
          _t276 = undefined;
        }
        return _t276;
      }
    }
    const _t278 = go(1);
    const _t275 = _t278;
    _t273 = _t275;
  }
  const _t272 = _t273;
  return _t272;
}
function Array$iter(f, arr) {
  const n_279 = Array$length(arr);
  function go(i) {
    while (true) {
      let _t281;
      if ((i >= n_279)) {
        _t281 = undefined;
      } else {
        f(Array$get(arr, i));
        const _t282 = (i + 1);
        i = _t282;
        continue;
        _t281 = undefined;
      }
      return _t281;
    }
  }
  const _t283 = go(0);
  const _t280 = _t283;
  return _t280;
}
function Array$iteri(f, arr) {
  const n_284 = Array$length(arr);
  function go(i) {
    while (true) {
      let _t286;
      if ((i >= n_284)) {
        _t286 = undefined;
      } else {
        f(i, Array$get(arr, i));
        const _t287 = (i + 1);
        i = _t287;
        continue;
        _t286 = undefined;
      }
      return _t286;
    }
  }
  const _t288 = go(0);
  const _t285 = _t288;
  return _t285;
}
function Array$forall(f, arr) {
  const n_289 = Array$length(arr);
  function go(i) {
    while (true) {
      let _t291;
      if ((i >= n_289)) {
        _t291 = true;
      } else {
        let _t292;
        if (f(Array$get(arr, i))) {
          const _t293 = (i + 1);
          i = _t293;
          continue;
          _t292 = undefined;
        } else {
          _t292 = false;
        }
        _t291 = _t292;
      }
      return _t291;
    }
  }
  const _t294 = go(0);
  const _t290 = _t294;
  return _t290;
}
function Array$fold(f, acc, arr) {
  const n_295 = Array$length(arr);
  function go(i, a) {
    while (true) {
      let _t297;
      if ((i >= n_295)) {
        _t297 = a;
      } else {
        const _t298 = (i + 1);
        const _t299 = f(a, Array$get(arr, i));
        i = _t298;
        a = _t299;
        continue;
        _t297 = undefined;
      }
      return _t297;
    }
  }
  const _t300 = go(0, acc);
  const _t296 = _t300;
  return _t296;
}
if (typeof IO$read_file === "undefined") { if (globalThis._mmlExterns && globalThis._mmlExterns["IO.read_file"]) var IO$read_file = globalThis._mmlExterns["IO.read_file"]; else throw new Error("extern " + "IO.read_file" + " not provided"); }
if (typeof IO$write_file === "undefined") { if (globalThis._mmlExterns && globalThis._mmlExterns["IO.write_file"]) var IO$write_file = globalThis._mmlExterns["IO.write_file"]; else throw new Error("extern " + "IO.write_file" + " not provided"); }
if (typeof IO$append_file === "undefined") { if (globalThis._mmlExterns && globalThis._mmlExterns["IO.append_file"]) var IO$append_file = globalThis._mmlExterns["IO.append_file"]; else throw new Error("extern " + "IO.append_file" + " not provided"); }
if (typeof IO$read_line === "undefined") { if (globalThis._mmlExterns && globalThis._mmlExterns["IO.read_line"]) var IO$read_line = globalThis._mmlExterns["IO.read_line"]; else throw new Error("extern " + "IO.read_line" + " not provided"); }
if (typeof IO$file_exists === "undefined") { if (globalThis._mmlExterns && globalThis._mmlExterns["IO.file_exists"]) var IO$file_exists = globalThis._mmlExterns["IO.file_exists"]; else throw new Error("extern " + "IO.file_exists" + " not provided"); }
if (typeof Sys$args === "undefined") { if (globalThis._mmlExterns && globalThis._mmlExterns["Sys.args"]) var Sys$args = globalThis._mmlExterns["Sys.args"]; else throw new Error("extern " + "Sys.args" + " not provided"); }
if (typeof Sys$getenv === "undefined") { if (globalThis._mmlExterns && globalThis._mmlExterns["Sys.getenv"]) var Sys$getenv = globalThis._mmlExterns["Sys.getenv"]; else throw new Error("extern " + "Sys.getenv" + " not provided"); }
if (typeof Sys$exit === "undefined") { if (globalThis._mmlExterns && globalThis._mmlExterns["Sys.exit"]) var Sys$exit = globalThis._mmlExterns["Sys.exit"]; else throw new Error("extern " + "Sys.exit" + " not provided"); }
if (typeof Sys$time === "undefined") { if (globalThis._mmlExterns && globalThis._mmlExterns["Sys.time"]) var Sys$time = globalThis._mmlExterns["Sys.time"]; else throw new Error("extern " + "Sys.time" + " not provided"); }
function Math$abs(x) {
  let _t301;
  if ((x < 0)) {
    _t301 = (0 - x);
  } else {
    _t301 = x;
  }
  return _t301;
}
function Math$min(a, b) {
  let _t302;
  if ((a < b)) {
    _t302 = a;
  } else {
    _t302 = b;
  }
  return _t302;
}
function Math$max(a, b) {
  let _t303;
  if ((a > b)) {
    _t303 = a;
  } else {
    _t303 = b;
  }
  return _t303;
}
function Math$pow(a, b) {
  return __math_pow(a, b);
}
function Math$sqrt(x) {
  return __math_sqrt(x);
}
function Math$floor(x) {
  return __math_floor(x);
}
function Math$ceil(x) {
  return __math_ceil(x);
}
function Math$round(x) {
  return __math_round(x);
}
function Result$map(f, r) {
  let _t305;
  const _t304 = r;
  _t306: {
    if (_t304._tag === 0) {
      const v = _t304._val;
      _t305 = ({_tag: 0, _name: "Ok", _val: f(v)});
      break _t306;
    }
    if (_t304._tag === 1) {
      const e = _t304._val;
      _t305 = ({_tag: 1, _name: "Err", _val: e});
      break _t306;
    }
    _match_fail("line 14");
  }
  return _t305;
}
function Result$bind(f, r) {
  let _t308;
  const _t307 = r;
  _t309: {
    if (_t307._tag === 0) {
      const v = _t307._val;
      _t308 = f(v);
      break _t309;
    }
    if (_t307._tag === 1) {
      const e = _t307._val;
      _t308 = ({_tag: 1, _name: "Err", _val: e});
      break _t309;
    }
    _match_fail("line 14");
  }
  return _t308;
}
function Result$unwrap(r) {
  let _t311;
  const _t310 = r;
  _t312: {
    if (_t310._tag === 0) {
      const v = _t310._val;
      _t311 = v;
      break _t312;
    }
    _match_fail("line 14");
  }
  return _t311;
}
function Byte$to_int(b) {
  return __byte_to_int(b);
}
function Byte$of_int(n) {
  return __byte_of_int(n);
}
function Byte$to_string(b) {
  return __byte_to_string(b);
}
function Byte$is_alpha(b) {
  const n_313 = Byte$to_int(b);
  const _t314 = (((n_313 >= 65) && (n_313 <= 90)) || ((n_313 >= 97) && (n_313 <= 122)));
  return _t314;
}
function Byte$is_digit(b) {
  const n_315 = Byte$to_int(b);
  const _t316 = ((n_315 >= 48) && (n_315 <= 57));
  return _t316;
}
function Byte$is_space(b) {
  const n_317 = Byte$to_int(b);
  const _t318 = ((((n_317 === 32) || (n_317 === 9)) || (n_317 === 10)) || (n_317 === 13));
  return _t318;
}
function Byte$is_upper(b) {
  const n_319 = Byte$to_int(b);
  const _t320 = ((n_319 >= 65) && (n_319 <= 90));
  return _t320;
}
function Byte$is_lower(b) {
  const n_321 = Byte$to_int(b);
  const _t322 = ((n_321 >= 97) && (n_321 <= 122));
  return _t322;
}
function Byte$to_upper(b) {
  const n_323 = Byte$to_int(b);
  let _t325;
  if (((n_323 >= 97) && (n_323 <= 122))) {
    _t325 = Byte$of_int((n_323 - 32));
  } else {
    _t325 = b;
  }
  const _t324 = _t325;
  return _t324;
}
function Byte$to_lower(b) {
  const n_326 = Byte$to_int(b);
  let _t328;
  if (((n_326 >= 65) && (n_326 <= 90))) {
    _t328 = Byte$of_int((n_326 + 32));
  } else {
    _t328 = b;
  }
  const _t327 = _t328;
  return _t327;
}
function Rune$to_int(r) {
  return __rune_to_int(r);
}
function Rune$of_int(n) {
  return __rune_of_int(n);
}
function Rune$to_string(r) {
  return __rune_to_string(r);
}
function Rune$is_alpha(r) {
  const n_329 = Rune$to_int(r);
  const _t330 = (((n_329 >= 65) && (n_329 <= 90)) || ((n_329 >= 97) && (n_329 <= 122)));
  return _t330;
}
function Rune$is_digit(r) {
  const n_331 = Rune$to_int(r);
  const _t332 = ((n_331 >= 48) && (n_331 <= 57));
  return _t332;
}
function Rune$is_space(r) {
  const n_333 = Rune$to_int(r);
  const _t334 = ((((n_333 === 32) || (n_333 === 9)) || (n_333 === 10)) || (n_333 === 13));
  return _t334;
}
function Rune$is_upper(r) {
  const n_335 = Rune$to_int(r);
  const _t336 = ((n_335 >= 65) && (n_335 <= 90));
  return _t336;
}
function Rune$is_lower(r) {
  const n_337 = Rune$to_int(r);
  const _t338 = ((n_337 >= 97) && (n_337 <= 122));
  return _t338;
}
function Set$empty(_) {
  return new Map([]);
}
function Set$singleton(__dict_Map_0, x) {
  return __dict_Map_0.set(x, undefined, new Map([]));
}
function Set$of_list(__dict_Map_0, xs) {
  function _t339(acc, x) {
    return __dict_Map_0.set(x, undefined, acc);
  }
  return List$fold(_t339, new Map([]), xs);
}
function Set$add(__dict_Map_0, elem, s) {
  return __dict_Map_0.set(elem, undefined, s);
}
function Set$remove(elem, s) {
  return __dict_Map_g0_g1_map__g0__g1.remove(elem, s);
}
function Set$mem(elem, s) {
  return __dict_Map_g0_g1_map__g0__g1.has(elem, s);
}
function Set$size(s) {
  return __dict_Map_g0_g1_map__g0__g1.size(s);
}
function Set$to_list(s) {
  return __dict_Map_g0_g1_map__g0__g1.keys(s);
}
function Set$union(__dict_Map_0, s1, s2) {
  function _t340(acc, x) {
    return __dict_Map_0.set(x, undefined, acc);
  }
  return List$fold(_t340, s2, __dict_Map_0.keys(s1));
}
function Set$inter(__dict_Map_0, s1, s2) {
  function _t341(acc, x) {
    let _t342;
    if (__dict_Map_0.has(x, s2)) {
      _t342 = __dict_Map_0.set(x, undefined, acc);
    } else {
      _t342 = acc;
    }
    return _t342;
  }
  return List$fold(_t341, Set$empty(undefined), __dict_Map_0.keys(s1));
}
function Set$diff(__dict_Map_0, s1, s2) {
  function _t343(acc, x) {
    let _t344;
    if ((!__dict_Map_0.has(x, s2))) {
      _t344 = __dict_Map_0.set(x, undefined, acc);
    } else {
      _t344 = acc;
    }
    return _t344;
  }
  return List$fold(_t343, Set$empty(undefined), __dict_Map_0.keys(s1));
}
function Set$is_empty(s) {
  return (Set$size(s) === 0);
}
function Set$is_subset(s1, s2) {
  function _t345(x) {
    return __dict_Map_g0_g1_map__g0__g1.has(x, s2);
  }
  return List$forall(_t345, __dict_Map_g0_g1_map__g0__g1.keys(s1));
}
function _t346(f, acc, s) {
  function go(a, l) {
    while (true) {
      let _t348;
      const _t347 = l;
      _t349: {
        if (_t347 === null) {
          _t348 = a;
          break _t349;
        }
        if (_t347 !== null) {
          const x = _t347._hd;
          const rest = _t347._tl;
          const _t350 = f(a, x);
          const _t351 = rest;
          a = _t350;
          l = _t351;
          continue;
          _t348 = undefined;
          break _t349;
        }
        _match_fail("line 45");
      }
      return _t348;
    }
  }
  const _t352 = go(acc, Set$to_list(s));
  return _t352;
}
const __dict_Iter_g0_unit_map__g0 = ({fold: _t346});
function Enum$reduce(f, xs) {
  let _t354;
  const _t353 = xs;
  _t355: {
    if (_t353 !== null) {
      const x = _t353._hd;
      const rest = _t353._tl;
      _t354 = List$fold(f, x, rest);
      break _t355;
    }
    _match_fail("line 118");
  }
  return _t354;
}
function Enum$sum(xs) {
  function _t356(a, b) {
    return (a + b);
  }
  return List$fold(_t356, 0, xs);
}
function Enum$count(f, xs) {
  function _t357(acc, x) {
    let _t358;
    if (f(x)) {
      _t358 = (acc + 1);
    } else {
      _t358 = acc;
    }
    return _t358;
  }
  return List$fold(_t357, 0, xs);
}
function Enum$take(n, xs) {
  function go(i, acc, l) {
    while (true) {
      let _t359;
      if ((i >= n)) {
        _t359 = List$rev(acc);
      } else {
        let _t361;
        const _t360 = l;
        _t362: {
          if (_t360 === null) {
            _t361 = List$rev(acc);
            break _t362;
          }
          if (_t360 !== null) {
            const x = _t360._hd;
            const rest = _t360._tl;
            const _t363 = (i + 1);
            const _t364 = ({_hd: x, _tl: acc});
            const _t365 = rest;
            i = _t363;
            acc = _t364;
            l = _t365;
            continue;
            _t361 = undefined;
            break _t362;
          }
          _match_fail("line 118");
        }
        _t359 = _t361;
      }
      return _t359;
    }
  }
  const _t366 = go(0, null, xs);
  return _t366;
}
function Enum$drop(n, xs) {
  function go(i, l) {
    while (true) {
      let _t367;
      if ((i >= n)) {
        _t367 = l;
      } else {
        let _t369;
        const _t368 = l;
        _t370: {
          if (_t368 === null) {
            _t369 = null;
            break _t370;
          }
          if (_t368 !== null) {
            const rest = _t368._tl;
            const _t371 = (i + 1);
            const _t372 = rest;
            i = _t371;
            l = _t372;
            continue;
            _t369 = undefined;
            break _t370;
          }
          _match_fail("line 118");
        }
        _t367 = _t369;
      }
      return _t367;
    }
  }
  const _t373 = go(0, xs);
  return _t373;
}
function Enum$take_while(f, xs) {
  function go(acc, l) {
    while (true) {
      let _t375;
      const _t374 = l;
      _t376: {
        if (_t374 === null) {
          _t375 = List$rev(acc);
          break _t376;
        }
        if (_t374 !== null) {
          const x = _t374._hd;
          const rest = _t374._tl;
          let _t377;
          if (f(x)) {
            const _t378 = ({_hd: x, _tl: acc});
            const _t379 = rest;
            acc = _t378;
            l = _t379;
            continue;
            _t377 = undefined;
          } else {
            _t377 = List$rev(acc);
          }
          _t375 = _t377;
          break _t376;
        }
        _match_fail("line 118");
      }
      return _t375;
    }
  }
  const _t380 = go(null, xs);
  return _t380;
}
function Enum$drop_while(f, xs) {
  function go(l) {
    while (true) {
      let _t382;
      const _t381 = l;
      _t383: {
        if (_t381 === null) {
          _t382 = null;
          break _t383;
        }
        if (_t381 !== null) {
          const x = _t381._hd;
          const rest = _t381._tl;
          let _t384;
          if (f(x)) {
            const _t385 = rest;
            l = _t385;
            continue;
            _t384 = undefined;
          } else {
            _t384 = l;
          }
          _t382 = _t384;
          break _t383;
        }
        _match_fail("line 118");
      }
      return _t382;
    }
  }
  const _t386 = go(xs);
  return _t386;
}
function Enum$flat_map(f, xs) {
  return List$flatten(List$map(f, xs));
}
function Enum$each(f, xs) {
  function _t387(_, x) {
    return f(x);
  }
  return List$fold(_t387, undefined, xs);
}
function Enum$reject(f, xs) {
  function _t388(x) {
    return (!f(x));
  }
  return List$filter(_t388, xs);
}
function Enum$enumerate(xs) {
  function _t389(i, x) {
    return [i, x];
  }
  return List$mapi(_t389, xs);
}
function Enum$join(sep, xs) {
  let _t391;
  const _t390 = xs;
  _t392: {
    if (_t390 === null) {
      _t391 = "";
      break _t392;
    }
    if (_t390 !== null) {
      const first = _t390._hd;
      const rest = _t390._tl;
      function _t393(acc, x) {
        return ((acc + sep) + x);
      }
      _t391 = List$fold(_t393, first, rest);
      break _t392;
    }
    _match_fail("line 118");
  }
  return _t391;
}
function Enum$chunk(n, xs) {
  function go(acc, l) {
    while (true) {
      let _t395;
      const _t394 = l;
      _t396: {
        if (_t394 === null) {
          _t395 = List$rev(acc);
          break _t396;
        }
        if (true) {
          const _t397 = ({_hd: Enum$take(n, l), _tl: acc});
          const _t398 = Enum$drop(n, l);
          acc = _t397;
          l = _t398;
          continue;
          _t395 = undefined;
          break _t396;
        }
        _match_fail("line 118");
      }
      return _t395;
    }
  }
  const _t399 = go(null, xs);
  return _t399;
}
function Enum$dedup(xs) {
  function go(prev, acc, l) {
    while (true) {
      let _t401;
      const _t400 = l;
      _t402: {
        if (_t400 === null) {
          _t401 = List$rev(acc);
          break _t402;
        }
        if (_t400 !== null) {
          const x = _t400._hd;
          const rest = _t400._tl;
          let _t403;
          if (_eq(x, prev)) {
            const _t404 = prev;
            const _t405 = acc;
            const _t406 = rest;
            prev = _t404;
            acc = _t405;
            l = _t406;
            continue;
            _t403 = undefined;
          } else {
            const _t407 = x;
            const _t408 = ({_hd: x, _tl: acc});
            const _t409 = rest;
            prev = _t407;
            acc = _t408;
            l = _t409;
            continue;
            _t403 = undefined;
          }
          _t401 = _t403;
          break _t402;
        }
        _match_fail("line 118");
      }
      return _t401;
    }
  }
  let _t412;
  const _t411 = xs;
  _t413: {
    if (_t411 === null) {
      _t412 = null;
      break _t413;
    }
    if (_t411 !== null) {
      const x = _t411._hd;
      const rest = _t411._tl;
      _t412 = go(x, ({_hd: x, _tl: null}), rest);
      break _t413;
    }
    _match_fail("line 118");
  }
  const _t410 = _t412;
  return _t410;
}
function Enum$uniq(xs) {
  function _t414(acc, x) {
    function _t415(y) {
      return _eq(y, x);
    }
    let _t416;
    if (List$exists(_t415, acc)) {
      _t416 = acc;
    } else {
      _t416 = ({_hd: x, _tl: acc});
    }
    return _t416;
  }
  return List$rev(List$fold(_t414, null, xs));
}
function Enum$scan(f, init, xs) {
  function _t417(acc, x) {
    let _t419;
    const _t418 = acc;
    _t420: {
      if (_t418 === null) {
        _t419 = ({_hd: f(init, x), _tl: null});
        break _t420;
      }
      if (_t418 !== null) {
        const prev = _t418._hd;
        _t419 = ({_hd: f(prev, x), _tl: acc});
        break _t420;
      }
      _match_fail("line 118");
    }
    return _t419;
  }
  return List$rev(List$fold(_t417, ({_hd: init, _tl: null}), xs));
}
function Enum$intersperse(sep, xs) {
  let _t422;
  const _t421 = xs;
  _t423: {
    if (_t421 === null) {
      _t422 = null;
      break _t423;
    }
    if (_t421 !== null) {
      const first = _t421._hd;
      const rest = _t421._tl;
      function _t424(acc, x) {
        return List$concat(acc, ({_hd: sep, _tl: ({_hd: x, _tl: null})}));
      }
      _t422 = List$fold(_t424, ({_hd: first, _tl: null}), rest);
      break _t423;
    }
    _match_fail("line 118");
  }
  return _t422;
}
function Enum$zip_with(f, xs, ys) {
  function _t425(p) {
    let _t427;
    const _t426 = p;
    _t428: {
      if (true) {
        const a = _t426[0];
        const b = _t426[1];
        _t427 = f(a, b);
        break _t428;
      }
      _match_fail("line 118");
    }
    return _t427;
  }
  return List$map(_t425, List$zip(xs, ys));
}
function Enum$min_by(f, xs) {
  let _t430;
  const _t429 = xs;
  _t431: {
    if (_t429 !== null) {
      const x = _t429._hd;
      const rest = _t429._tl;
      function _t432(best, y) {
        let _t433;
        if ((f(y) < f(best))) {
          _t433 = y;
        } else {
          _t433 = best;
        }
        return _t433;
      }
      _t430 = List$fold(_t432, x, rest);
      break _t431;
    }
    _match_fail("line 118");
  }
  return _t430;
}
function Enum$max_by(f, xs) {
  let _t435;
  const _t434 = xs;
  _t436: {
    if (_t434 !== null) {
      const x = _t434._hd;
      const rest = _t434._tl;
      function _t437(best, y) {
        let _t438;
        if ((f(y) > f(best))) {
          _t438 = y;
        } else {
          _t438 = best;
        }
        return _t438;
      }
      _t435 = List$fold(_t437, x, rest);
      break _t436;
    }
    _match_fail("line 118");
  }
  return _t435;
}
function Enum$group_by(__dict_Map_1, __dict_Map_1_2, f, xs) {
  function _t439(m, x) {
    const k_440 = f(x);
    let _t443;
    const _t442 = __dict_Map_1_2.get(k_440, m);
    _t444: {
      if (_t442._tag === 0) {
        _t443 = __dict_Map_1_2.set(k_440, ({_hd: x, _tl: null}), m);
        break _t444;
      }
      if (_t442._tag === 1) {
        const vs = _t442._val;
        _t443 = __dict_Map_1_2.set(k_440, List$concat(vs, ({_hd: x, _tl: null})), m);
        break _t444;
      }
      _match_fail("line 118");
    }
    const _t441 = _t443;
    return _t441;
  }
  return List$fold(_t439, new Map([]), xs);
}
function Seq$range(start, stop, _mml$yield) {
  function go(i) {
    while (true) {
      let _t445;
      if ((i >= stop)) {
        _t445 = undefined;
      } else {
        _mml$yield(i);
        const _t446 = (i + 1);
        i = _t446;
        continue;
        _t445 = undefined;
      }
      return _t445;
    }
  }
  const _t447 = go(start);
  return _t447;
}
function Seq$of_list(xs, _mml$yield) {
  function go(l) {
    while (true) {
      let _t449;
      const _t448 = l;
      _t450: {
        if (_t448 === null) {
          _t449 = undefined;
          break _t450;
        }
        if (_t448 !== null) {
          const x = _t448._hd;
          const rest = _t448._tl;
          _mml$yield(x);
          const _t451 = rest;
          l = _t451;
          continue;
          _t449 = undefined;
          break _t450;
        }
        _match_fail("line 134");
      }
      return _t449;
    }
  }
  const _t452 = go(xs);
  return _t452;
}
function Seq$repeat(x, _mml$yield) {
  function go(u) {
    while (true) {
      _mml$yield(x);
      const _t453 = u;
      u = _t453;
      continue;
      return undefined;
    }
  }
  const _t454 = go(0);
  return _t454;
}
function Seq$iterate(seed, step, _mml$yield) {
  function go(x) {
    while (true) {
      _mml$yield(x);
      const _t455 = step(x);
      x = _t455;
      continue;
      return undefined;
    }
  }
  const _t456 = go(seed);
  return _t456;
}
function Seq$map(f, s, _mml$yield) {
  function _t457(x) {
    return _mml$yield(f(x));
  }
  return s(_t457);
}
function Seq$filter(f, s, _mml$yield) {
  function _t458(x) {
    let _t459;
    if (f(x)) {
      _t459 = _mml$yield(x);
    } else {
      _t459 = undefined;
    }
    return _t459;
  }
  return s(_t458);
}
function Seq$take(n, s, _mml$yield) {
  return _trampoline(function() {
    let i_460 = 0;
    const _t461 = (function() {
      const _t462 = _h;
      _h = Object.assign({}, _t462, {
        "__seq_stop": function(_, __k) { throw {_e: "__seq_stop", _v: _}; },
      });
      try {
        function _t463(x) {
          return _trampoline(function() {
            if ((i_460 >= n)) {
              return _h["__seq_stop"](undefined, function(_t464) {
                return _bounce(function() {
                  return _t464;
                });
              });
            } else {
              _mml$yield(x);
              return (i_460 = (i_460 + 1), undefined);
            }
          });
        }
        const __x_465 = s(_t463);
        return __x_465;
      } catch (_exc) {
        if (_exc && _exc._e === "__seq_stop") {
          const _ = _exc._v;
          return undefined;
        } else { throw _exc; }
      } finally { _h = _t462; }
    })();
    return _t461;
  }, Seq$take);
}
function Seq$take_while(f, s, _mml$yield) {
  return _trampoline(function() {
    const _t466 = (function() {
      const _t467 = _h;
      _h = Object.assign({}, _t467, {
        "__seq_stop": function(_, __k) { throw {_e: "__seq_stop", _v: _}; },
      });
      try {
        function _t468(x) {
          return _trampoline(function() {
            if (f(x)) {
              return _mml$yield(x);
            } else {
              return _h["__seq_stop"](undefined, function(_t469) {
                return _bounce(function() {
                  return _t469;
                });
              });
            }
          });
        }
        const __x_470 = s(_t468);
        return __x_470;
      } catch (_exc) {
        if (_exc && _exc._e === "__seq_stop") {
          const _ = _exc._v;
          return undefined;
        } else { throw _exc; }
      } finally { _h = _t467; }
    })();
    return _t466;
  }, Seq$take_while);
}
function Seq$drop(n, s, _mml$yield) {
  let i_471 = 0;
  function _t473(x) {
    let _t474;
    if ((i_471 >= n)) {
      _t474 = _mml$yield(x);
    } else {
      _t474 = (i_471 = (i_471 + 1), undefined);
    }
    return _t474;
  }
  const _t472 = s(_t473);
  return _t472;
}
function Seq$drop_while(f, s, _mml$yield) {
  let dropping_475 = true;
  function _t477(x) {
    let _t478;
    if (dropping_475) {
      let _t479;
      if (f(x)) {
        _t479 = undefined;
      } else {
        (dropping_475 = false, undefined);
        _t479 = _mml$yield(x);
      }
      _t478 = _t479;
    } else {
      _t478 = _mml$yield(x);
    }
    return _t478;
  }
  const _t476 = s(_t477);
  return _t476;
}
function Seq$flat_map(f, s, _mml$yield) {
  function _t480(x) {
    return f(x, _mml$yield);
  }
  return s(_t480);
}
function Seq$enumerate(s, _mml$yield) {
  let i_481 = 0;
  function _t483(x) {
    _mml$yield([i_481, x]);
    return (i_481 = (i_481 + 1), undefined);
  }
  const _t482 = s(_t483);
  return _t482;
}
function Seq$chunk(n, s, _mml$yield) {
  let buf_484 = null;
  let count_486 = 0;
  function _t488(x) {
    (buf_484 = List$concat(buf_484, ({_hd: x, _tl: null})), undefined);
    (count_486 = (count_486 + 1), undefined);
    let _t489;
    if ((count_486 >= n)) {
      _mml$yield(buf_484);
      (buf_484 = null, undefined);
      _t489 = (count_486 = 0, undefined);
    } else {
      _t489 = undefined;
    }
    return _t489;
  }
  s(_t488);
  let _t490;
  if ((count_486 > 0)) {
    _t490 = _mml$yield(buf_484);
  } else {
    _t490 = undefined;
  }
  const _t487 = _t490;
  const _t485 = _t487;
  return _t485;
}
function Seq$to_list(s) {
  let acc_491 = null;
  function _t493(x) {
    return (acc_491 = ({_hd: x, _tl: acc_491}), undefined);
  }
  s(_t493);
  const _t492 = List$rev(acc_491);
  return _t492;
}
function Seq$fold(f, init, s) {
  let acc_494 = init;
  function _t496(x) {
    return (acc_494 = f(acc_494, x), undefined);
  }
  s(_t496);
  const _t495 = acc_494;
  return _t495;
}
function Seq$each(f, s) {
  return s(f);
}
function Seq$count(s) {
  let n_497 = 0;
  function _t499(_) {
    return (n_497 = (n_497 + 1), undefined);
  }
  s(_t499);
  const _t498 = n_497;
  return _t498;
}
function Seq$sum(s) {
  let total_500 = 0;
  function _t502(x) {
    return (total_500 = (total_500 + x), undefined);
  }
  s(_t502);
  const _t501 = total_500;
  return _t501;
}
function Seq$find(f, s) {
  return _trampoline(function() {
    let result_503 = ({_tag: 0, _name: "None"});
    const _t504 = (function() {
      const _t505 = _h;
      _h = Object.assign({}, _t505, {
        "__seq_stop": function(_, __k) { throw {_e: "__seq_stop", _v: _}; },
      });
      try {
        function _t506(x) {
          return _trampoline(function() {
            if (f(x)) {
              (result_503 = ({_tag: 1, _name: "Some", _val: x}), undefined);
              return _h["__seq_stop"](undefined, function(_t507) {
                return _bounce(function() {
                  return _t507;
                });
              });
            } else {
              return undefined;
            }
          });
        }
        const __x_508 = s(_t506);
        return __x_508;
      } catch (_exc) {
        if (_exc && _exc._e === "__seq_stop") {
          const _ = _exc._v;
          return undefined;
        } else { throw _exc; }
      } finally { _h = _t505; }
    })();
    const _t509 = _t504;
    return result_503;
  }, Seq$find);
}
function Seq$any(f, s) {
  return _trampoline(function() {
    let result_510 = false;
    const _t511 = (function() {
      const _t512 = _h;
      _h = Object.assign({}, _t512, {
        "__seq_stop": function(_, __k) { throw {_e: "__seq_stop", _v: _}; },
      });
      try {
        function _t513(x) {
          return _trampoline(function() {
            if (f(x)) {
              (result_510 = true, undefined);
              return _h["__seq_stop"](undefined, function(_t514) {
                return _bounce(function() {
                  return _t514;
                });
              });
            } else {
              return undefined;
            }
          });
        }
        const __x_515 = s(_t513);
        return __x_515;
      } catch (_exc) {
        if (_exc && _exc._e === "__seq_stop") {
          const _ = _exc._v;
          return undefined;
        } else { throw _exc; }
      } finally { _h = _t512; }
    })();
    const _t516 = _t511;
    return result_510;
  }, Seq$any);
}
function Seq$all(f, s) {
  return _trampoline(function() {
    let result_517 = true;
    const _t518 = (function() {
      const _t519 = _h;
      _h = Object.assign({}, _t519, {
        "__seq_stop": function(_, __k) { throw {_e: "__seq_stop", _v: _}; },
      });
      try {
        function _t520(x) {
          return _trampoline(function() {
            if (f(x)) {
              return undefined;
            } else {
              (result_517 = false, undefined);
              return _h["__seq_stop"](undefined, function(_t521) {
                return _bounce(function() {
                  return _t521;
                });
              });
            }
          });
        }
        const __x_522 = s(_t520);
        return __x_522;
      } catch (_exc) {
        if (_exc && _exc._e === "__seq_stop") {
          const _ = _exc._v;
          return undefined;
        } else { throw _exc; }
      } finally { _h = _t519; }
    })();
    const _t523 = _t518;
    return result_517;
  }, Seq$all);
}
function Option$map(f, opt) {
  let _t525;
  const _t524 = opt;
  _t526: {
    if (_t524._tag === 1) {
      const x = _t524._val;
      _t525 = ({_tag: 1, _name: "Some", _val: f(x)});
      break _t526;
    }
    if (_t524._tag === 0) {
      _t525 = ({_tag: 0, _name: "None"});
      break _t526;
    }
    _match_fail("line 37");
  }
  return _t525;
}
function Option$bind(f, opt) {
  let _t528;
  const _t527 = opt;
  _t529: {
    if (_t527._tag === 1) {
      const x = _t527._val;
      _t528 = f(x);
      break _t529;
    }
    if (_t527._tag === 0) {
      _t528 = ({_tag: 0, _name: "None"});
      break _t529;
    }
    _match_fail("line 37");
  }
  return _t528;
}
function Option$unwrap(opt) {
  let _t531;
  const _t530 = opt;
  _t532: {
    if (_t530._tag === 1) {
      const x = _t530._val;
      _t531 = x;
      break _t532;
    }
    _match_fail("line 37");
  }
  return _t531;
}
function Option$unwrap_or(_mml$default, opt) {
  let _t534;
  const _t533 = opt;
  _t535: {
    if (_t533._tag === 1) {
      const x = _t533._val;
      _t534 = x;
      break _t535;
    }
    if (_t533._tag === 0) {
      _t534 = _mml$default;
      break _t535;
    }
    _match_fail("line 37");
  }
  return _t534;
}
function Option$is_some(opt) {
  let _t537;
  const _t536 = opt;
  _t538: {
    if (_t536._tag === 1) {
      _t537 = true;
      break _t538;
    }
    if (_t536._tag === 0) {
      _t537 = false;
      break _t538;
    }
    _match_fail("line 37");
  }
  return _t537;
}
function Option$is_none(opt) {
  let _t540;
  const _t539 = opt;
  _t541: {
    if (_t539._tag === 1) {
      _t540 = false;
      break _t541;
    }
    if (_t539._tag === 0) {
      _t540 = true;
      break _t541;
    }
    _match_fail("line 37");
  }
  return _t540;
}
function Option$to_list(opt) {
  let _t543;
  const _t542 = opt;
  _t544: {
    if (_t542._tag === 1) {
      const x = _t542._val;
      _t543 = ({_hd: x, _tl: null});
      break _t544;
    }
    if (_t542._tag === 0) {
      _t543 = null;
      break _t544;
    }
    _match_fail("line 37");
  }
  return _t543;
}
function Option$iter(f, opt) {
  let _t546;
  const _t545 = opt;
  _t547: {
    if (_t545._tag === 1) {
      const x = _t545._val;
      _t546 = f(x);
      break _t547;
    }
    if (_t545._tag === 0) {
      _t546 = undefined;
      break _t547;
    }
    _match_fail("line 37");
  }
  return _t546;
}
function Option$flat_map(f, opt) {
  let _t549;
  const _t548 = opt;
  _t550: {
    if (_t548._tag === 1) {
      const x = _t548._val;
      _t549 = f(x);
      break _t550;
    }
    if (_t548._tag === 0) {
      _t549 = ({_tag: 0, _name: "None"});
      break _t550;
    }
    _match_fail("line 37");
  }
  return _t549;
}
function Buffer$create(n) {
  let _t551;
  if ((n < 16)) {
    _t551 = 16;
  } else {
    _t551 = n;
  }
  return ({data: Array$make(_t551, 0), len: 0});
}
function Buffer$length(buf) {
  return buf.len;
}
function Buffer$clear(buf) {
  return (buf.len = 0, undefined);
}
function Buffer$grow(buf, needed) {
  const cap_552 = Array$length(buf.data);
  let _t554;
  if (((buf.len + needed) > cap_552)) {
    const new_cap_555 = Math$max((cap_552 * 2), (buf.len + needed));
    const new_data_557 = Array$make(new_cap_555, 0);
    function copy(i) {
      while (true) {
        let _t559;
        if ((i < buf.len)) {
          Array$set(new_data_557, i, Array$get(buf.data, i));
          const _t560 = (i + 1);
          i = _t560;
          continue;
          _t559 = undefined;
        } else {
          _t559 = undefined;
        }
        return _t559;
      }
    }
    copy(0);
    const _t561 = (buf.data = new_data_557, undefined);
    const _t558 = _t561;
    const _t556 = _t558;
    _t554 = _t556;
  } else {
    _t554 = undefined;
  }
  const _t553 = _t554;
  return _t553;
}
function Buffer$add_byte(buf, b) {
  Buffer$grow(buf, 1);
  Array$set(buf.data, buf.len, b);
  return (buf.len = (buf.len + 1), undefined);
}
function Buffer$add_string(buf, s) {
  const bytes_562 = String$to_byte_array(s);
  const n_564 = Array$length(bytes_562);
  Buffer$grow(buf, n_564);
  function copy(i) {
    while (true) {
      let _t566;
      if ((i < n_564)) {
        Array$set(buf.data, (buf.len + i), Array$get(bytes_562, i));
        const _t567 = (i + 1);
        i = _t567;
        continue;
        _t566 = undefined;
      } else {
        _t566 = undefined;
      }
      return _t566;
    }
  }
  copy(0);
  const _t568 = (buf.len = (buf.len + n_564), undefined);
  const _t565 = _t568;
  const _t563 = _t565;
  return _t563;
}
function Buffer$sub(buf, pos, len) {
  return String$of_byte_array(Array$sub(buf.data, pos, len));
}
function Buffer$truncate(buf, n) {
  return (buf.len = n, undefined);
}
function Buffer$contents(buf) {
  return String$of_byte_array(Array$sub(buf.data, 0, buf.len));
}
function Buffer$add_buffer(dst, src) {
  const n_569 = src.len;
  Buffer$grow(dst, n_569);
  function copy(i) {
    while (true) {
      let _t571;
      if ((i < n_569)) {
        Array$set(dst.data, (dst.len + i), Array$get(src.data, i));
        const _t572 = (i + 1);
        i = _t572;
        continue;
        _t571 = undefined;
      } else {
        _t571 = undefined;
      }
      return _t571;
    }
  }
  copy(0);
  const _t573 = (dst.len = (dst.len + n_569), undefined);
  const _t570 = _t573;
  return _t570;
}
function Fmt$pad_left(n, c, s) {
  const len_574 = String$length(s);
  let _t576;
  if ((len_574 >= n)) {
    _t576 = s;
  } else {
    function pad(acc, remaining) {
      while (true) {
        let _t577;
        if ((remaining <= 0)) {
          _t577 = (acc + s);
        } else {
          const _t578 = (acc + c);
          const _t579 = (remaining - 1);
          acc = _t578;
          remaining = _t579;
          continue;
          _t577 = undefined;
        }
        return _t577;
      }
    }
    const _t580 = pad("", (n - len_574));
    _t576 = _t580;
  }
  const _t575 = _t576;
  return _t575;
}
function Fmt$pad_right(n, c, s) {
  const len_581 = String$length(s);
  let _t583;
  if ((len_581 >= n)) {
    _t583 = s;
  } else {
    function pad(acc, remaining) {
      while (true) {
        let _t584;
        if ((remaining <= 0)) {
          _t584 = (s + acc);
        } else {
          const _t585 = (acc + c);
          const _t586 = (remaining - 1);
          acc = _t585;
          remaining = _t586;
          continue;
          _t584 = undefined;
        }
        return _t584;
      }
    }
    const _t587 = pad("", (n - len_581));
    _t583 = _t587;
  }
  const _t582 = _t583;
  return _t582;
}
function Fmt$int_to_hex(n) {
  const digits_588 = "0123456789abcdef";
  let _t590;
  if ((n === 0)) {
    _t590 = "0";
  } else {
    function go(num, acc) {
      while (true) {
        let _t591;
        if ((num === 0)) {
          _t591 = acc;
        } else {
          const d_592 = (num % 16);
          let _t594;
          if ((d_592 < 0)) {
            _t594 = (d_592 + 16);
          } else {
            _t594 = d_592;
          }
          const d_595 = _t594;
          const ch_597 = String$sub(digits_588, d_595, 1);
          const _t599 = ((num / 16) | 0);
          const _t600 = (ch_597 + acc);
          num = _t599;
          acc = _t600;
          continue;
          const _t598 = undefined;
          const _t596 = _t598;
          const _t593 = _t596;
          _t591 = _t593;
        }
        return _t591;
      }
    }
    let _t602;
    if ((n < 0)) {
      _t602 = (0 - n);
    } else {
      _t602 = n;
    }
    const abs_n_603 = _t602;
    const hex_605 = go(abs_n_603, "");
    let _t607;
    if ((n < 0)) {
      _t607 = ("-" + hex_605);
    } else {
      _t607 = hex_605;
    }
    const _t606 = _t607;
    const _t604 = _t606;
    const _t601 = _t604;
    _t590 = _t601;
  }
  const _t589 = _t590;
  return _t589;
}
function Fmt$int_to_bin(n) {
  let _t608;
  if ((n === 0)) {
    _t608 = "0";
  } else {
    function go(num, acc) {
      while (true) {
        let _t609;
        if ((num === 0)) {
          _t609 = acc;
        } else {
          let _t610;
          if (((num % 2) === 0)) {
            _t610 = "0";
          } else {
            _t610 = "1";
          }
          const bit_611 = _t610;
          const _t613 = ((num / 2) | 0);
          const _t614 = (bit_611 + acc);
          num = _t613;
          acc = _t614;
          continue;
          const _t612 = undefined;
          _t609 = _t612;
        }
        return _t609;
      }
    }
    let _t616;
    if ((n < 0)) {
      _t616 = (0 - n);
    } else {
      _t616 = n;
    }
    const abs_n_617 = _t616;
    const bin_619 = go(abs_n_617, "");
    let _t621;
    if ((n < 0)) {
      _t621 = ("-" + bin_619);
    } else {
      _t621 = bin_619;
    }
    const _t620 = _t621;
    const _t618 = _t620;
    const _t615 = _t618;
    _t608 = _t615;
  }
  return _t608;
}
function Fmt$int_to_oct(n) {
  let _t622;
  if ((n === 0)) {
    _t622 = "0";
  } else {
    function go(num, acc) {
      while (true) {
        let _t623;
        if ((num === 0)) {
          _t623 = acc;
        } else {
          const d_624 = (num % 8);
          let _t626;
          if ((d_624 < 0)) {
            _t626 = (d_624 + 8);
          } else {
            _t626 = d_624;
          }
          const d_627 = _t626;
          const _t629 = ((num / 8) | 0);
          const _t630 = (__dict_Show_int.show(d_627) + acc);
          num = _t629;
          acc = _t630;
          continue;
          const _t628 = undefined;
          const _t625 = _t628;
          _t623 = _t625;
        }
        return _t623;
      }
    }
    let _t632;
    if ((n < 0)) {
      _t632 = (0 - n);
    } else {
      _t632 = n;
    }
    const abs_n_633 = _t632;
    const oct_635 = go(abs_n_633, "");
    let _t637;
    if ((n < 0)) {
      _t637 = ("-" + oct_635);
    } else {
      _t637 = oct_635;
    }
    const _t636 = _t637;
    const _t634 = _t636;
    const _t631 = _t634;
    _t622 = _t631;
  }
  return _t622;
}
function Fmt$zero_pad(width, s) {
  return Fmt$pad_left(width, "0", s);
}
function _t638(n) {
  return n;
}
const __dict_Hash_int = ({hash: _t638});
function _t639(s) {
  const bytes_640 = String$to_byte_array(s);
  function _t642(h, b) {
    return ((h * 31) + Byte$to_int(b));
  }
  const _t641 = __dict_Iter_g0_array__g0.fold(_t642, 5381, bytes_640);
  return _t641;
}
const __dict_Hash_string = ({hash: _t639});
function _t643(b) {
  let _t644;
  if (b) {
    _t644 = 1;
  } else {
    _t644 = 0;
  }
  return _t644;
}
const __dict_Hash_bool = ({hash: _t643});
function _t645(b) {
  return Byte$to_int(b);
}
const __dict_Hash_byte = ({hash: _t645});
function _t646(r) {
  return Rune$to_int(r);
}
const __dict_Hash_rune = ({hash: _t646});
function Hashtbl$create(n) {
  let _t647;
  if ((n < 16)) {
    _t647 = 16;
  } else {
    _t647 = n;
  }
  const cap_648 = _t647;
  const _t649 = ({buckets: Array$make(cap_648, null), size: 0});
  return _t649;
}
function Hashtbl$clear(tbl) {
  const cap_650 = Array$length(tbl.buckets);
  (tbl.buckets = Array$make(cap_650, null), undefined);
  const _t651 = (tbl.size = 0, undefined);
  return _t651;
}
function Hashtbl$length(tbl) {
  return tbl.size;
}
function Hashtbl$bucket_index(__dict_Hash_0, tbl, key) {
  const h_652 = __dict_Hash_0.hash(key);
  let _t654;
  if ((h_652 < 0)) {
    _t654 = (0 - h_652);
  } else {
    _t654 = h_652;
  }
  const h_655 = _t654;
  const _t656 = (h_655 % Array$length(tbl.buckets));
  const _t653 = _t656;
  return _t653;
}
function Hashtbl$to_list(tbl) {
  const cap_657 = Array$length(tbl.buckets);
  function collect(i, acc) {
    while (true) {
      let _t659;
      if ((i >= cap_657)) {
        _t659 = acc;
      } else {
        const bucket_660 = Array$get(tbl.buckets, i);
        const _t662 = (i + 1);
        const _t663 = List$concat(bucket_660, acc);
        i = _t662;
        acc = _t663;
        continue;
        const _t661 = undefined;
        _t659 = _t661;
      }
      return _t659;
    }
  }
  const _t664 = collect(0, null);
  const _t658 = _t664;
  return _t658;
}
function Hashtbl$rehash(tbl, hash_fn) {
  const entries_665 = Hashtbl$to_list(tbl);
  const new_cap_667 = (Array$length(tbl.buckets) * 2);
  (tbl.buckets = Array$make(new_cap_667, null), undefined);
  (tbl.size = 0, undefined);
  function _t669(_, __p1) {
    let _t671;
    const _t670 = __p1;
    _t672: {
      if (true) {
        const k = _t670[0];
        const v = _t670[1];
        const h_673 = hash_fn(k);
        let _t675;
        if ((h_673 < 0)) {
          _t675 = (0 - h_673);
        } else {
          _t675 = h_673;
        }
        const h_676 = _t675;
        const idx_678 = (h_676 % new_cap_667);
        const bucket_680 = Array$get(tbl.buckets, idx_678);
        Array$set(tbl.buckets, idx_678, ({_hd: [k, v], _tl: bucket_680}));
        const _t681 = (tbl.size = (tbl.size + 1), undefined);
        const _t679 = _t681;
        const _t677 = _t679;
        const _t674 = _t677;
        _t671 = _t674;
        break _t672;
      }
      _match_fail("line 106");
    }
    return _t671;
  }
  const _t668 = List$fold(_t669, undefined, entries_665);
  const _t666 = _t668;
  return _t666;
}
function Hashtbl$set(__dict_Hash_1, __dict_Eq_1, tbl, key, value) {
  const idx_682 = _call(Hashtbl$bucket_index, [__dict_Hash_1, tbl, key]);
  const bucket_684 = Array$get(tbl.buckets, idx_682);
  function replace(__x) {
    let _t687;
    const _t686 = __x;
    _t688: {
      if (_t686 === null) {
        _t687 = ({_hd: [key, value], _tl: null});
        break _t688;
      }
      if (_t686 !== null) {
        const k = _t686._hd[0];
        const v = _t686._hd[1];
        const rest = _t686._tl;
        let _t689;
        if (_call(__dict_Eq_1.$eq, [k, key])) {
          _t689 = ({_hd: [key, value], _tl: rest});
        } else {
          _t689 = ({_hd: [k, v], _tl: replace(rest)});
        }
        _t687 = _t689;
        break _t688;
      }
      _match_fail("line 106");
    }
    return _t687;
  }
  const new_bucket_691 = replace(bucket_684);
  const grew_693 = (List$length(new_bucket_691) > List$length(bucket_684));
  Array$set(tbl.buckets, idx_682, new_bucket_691);
  let _t695;
  if (grew_693) {
    (tbl.size = (tbl.size + 1), undefined);
    let _t696;
    if ((tbl.size > (Array$length(tbl.buckets) * 2))) {
      _t696 = Hashtbl$rehash(tbl, __dict_Hash_1.hash);
    } else {
      _t696 = undefined;
    }
    _t695 = _t696;
  } else {
    _t695 = undefined;
  }
  const _t694 = _t695;
  const _t692 = _t694;
  const _t690 = _t692;
  const _t685 = _t690;
  const _t683 = _t685;
  return _t683;
}
function Hashtbl$get(__dict_Hash_1, __dict_Eq_1, tbl, key) {
  const idx_697 = _call(Hashtbl$bucket_index, [__dict_Hash_1, tbl, key]);
  const bucket_699 = Array$get(tbl.buckets, idx_697);
  function find(__x) {
    while (true) {
      let _t702;
      const _t701 = __x;
      _t703: {
        if (_t701 === null) {
          _t702 = ({_tag: 0, _name: "None"});
          break _t703;
        }
        if (_t701 !== null) {
          const k = _t701._hd[0];
          const v = _t701._hd[1];
          const rest = _t701._tl;
          let _t704;
          if (_call(__dict_Eq_1.$eq, [k, key])) {
            _t704 = ({_tag: 1, _name: "Some", _val: v});
          } else {
            const _t705 = rest;
            __x = _t705;
            continue;
            _t704 = undefined;
          }
          _t702 = _t704;
          break _t703;
        }
        _match_fail("line 106");
      }
      return _t702;
    }
  }
  const _t706 = find(bucket_699);
  const _t700 = _t706;
  const _t698 = _t700;
  return _t698;
}
function Hashtbl$has(__dict_Hash_0, __dict_Eq_0, tbl, key) {
  let _t708;
  const _t707 = _call(Hashtbl$get, [__dict_Hash_0, __dict_Eq_0, tbl, key]);
  _t709: {
    if (_t707._tag === 1) {
      _t708 = true;
      break _t709;
    }
    if (_t707._tag === 0) {
      _t708 = false;
      break _t709;
    }
    _match_fail("line 106");
  }
  return _t708;
}
function Hashtbl$remove(__dict_Hash_0, __dict_Eq_0, tbl, key) {
  const idx_710 = _call(Hashtbl$bucket_index, [__dict_Hash_0, tbl, key]);
  const bucket_712 = Array$get(tbl.buckets, idx_710);
  function _t714(__p2) {
    let _t716;
    const _t715 = __p2;
    _t717: {
      if (true) {
        const k = _t715[0];
        _t716 = _call(__dict_Eq_0.$lt$gt, [k, key]);
        break _t717;
      }
      _match_fail("line 106");
    }
    return _t716;
  }
  const new_bucket_718 = List$filter(_t714, bucket_712);
  let _t720;
  if ((List$length(new_bucket_718) < List$length(bucket_712))) {
    _t720 = (tbl.size = (tbl.size - 1), undefined);
  } else {
    _t720 = undefined;
  }
  _t720;
  const _t719 = Array$set(tbl.buckets, idx_710, new_bucket_718);
  const _t713 = _t719;
  const _t711 = _t713;
  return _t711;
}
function Hashtbl$find(__dict_Hash_1, __dict_Eq_1, tbl, key) {
  let _t722;
  const _t721 = _call(Hashtbl$get, [__dict_Hash_1, __dict_Eq_1, tbl, key]);
  _t723: {
    if (_t721._tag === 1) {
      const v = _t721._val;
      _t722 = v;
      break _t723;
    }
    if (_t721._tag === 0) {
      _t722 = failwith("Hashtbl.find: key not found");
      break _t723;
    }
    _match_fail("line 106");
  }
  return _t722;
}
function Hashtbl$fold(f, tbl, acc) {
  const entries_724 = Hashtbl$to_list(tbl);
  function _t726(a, __p3) {
    let _t728;
    const _t727 = __p3;
    _t729: {
      if (true) {
        const k = _t727[0];
        const v = _t727[1];
        _t728 = f(k, v, a);
        break _t729;
      }
      _match_fail("line 106");
    }
    return _t728;
  }
  const _t725 = List$fold(_t726, acc, entries_724);
  return _t725;
}
function Hashtbl$iter(f, tbl) {
  const entries_730 = Hashtbl$to_list(tbl);
  function _t732(__p4) {
    let _t734;
    const _t733 = __p4;
    _t735: {
      if (true) {
        const k = _t733[0];
        const v = _t733[1];
        _t734 = f(k, v);
        break _t735;
      }
      _match_fail("line 106");
    }
    return _t734;
  }
  const _t731 = List$iter(_t732, entries_730);
  return _t731;
}
function Hashtbl$keys(tbl) {
  function _t736(__p5) {
    let _t738;
    const _t737 = __p5;
    _t739: {
      if (true) {
        const k = _t737[0];
        _t738 = k;
        break _t739;
      }
      _match_fail("line 106");
    }
    return _t738;
  }
  return List$map(_t736, Hashtbl$to_list(tbl));
}
function Hashtbl$values(tbl) {
  function _t740(__p6) {
    let _t742;
    const _t741 = __p6;
    _t743: {
      if (true) {
        const v = _t741[1];
        _t742 = v;
        break _t743;
      }
      _match_fail("line 106");
    }
    return _t742;
  }
  return List$map(_t740, Hashtbl$to_list(tbl));
}
function Ref$create(v) {
  return ({contents: v});
}
function Ref$get(r) {
  return r.contents;
}
function Ref$set(r, v) {
  return (r.contents = v, undefined);
}
function Dynarray$create(n, _mml$default) {
  let _t744;
  if ((n < 16)) {
    _t744 = 16;
  } else {
    _t744 = n;
  }
  return ({arr: Array$make(_t744, _mml$default), count: 0});
}
function Dynarray$length(d) {
  return d.count;
}
function Dynarray$get(d, i) {
  let _t745;
  if (((i < 0) || (i >= d.count))) {
    _t745 = failwith("Dynarray.get: index out of bounds");
  } else {
    _t745 = Array$get(d.arr, i);
  }
  return _t745;
}
function Dynarray$set(d, i, v) {
  let _t746;
  if (((i < 0) || (i >= d.count))) {
    _t746 = failwith("Dynarray.set: index out of bounds");
  } else {
    _t746 = Array$set(d.arr, i, v);
  }
  return _t746;
}
function Dynarray$grow(d, needed, _mml$default) {
  const cap_747 = Array$length(d.arr);
  let _t749;
  if (((d.count + needed) > cap_747)) {
    const new_cap_750 = Math$max((cap_747 * 2), (d.count + needed));
    const new_arr_752 = Array$make(new_cap_750, _mml$default);
    function copy(i) {
      while (true) {
        let _t754;
        if ((i < d.count)) {
          Array$set(new_arr_752, i, Array$get(d.arr, i));
          const _t755 = (i + 1);
          i = _t755;
          continue;
          _t754 = undefined;
        } else {
          _t754 = undefined;
        }
        return _t754;
      }
    }
    copy(0);
    const _t756 = (d.arr = new_arr_752, undefined);
    const _t753 = _t756;
    const _t751 = _t753;
    _t749 = _t751;
  } else {
    _t749 = undefined;
  }
  const _t748 = _t749;
  return _t748;
}
function Dynarray$empty(_) {
  return ({arr: {_arr: []}, count: 0});
}
function Dynarray$push(d, v) {
  Dynarray$grow(d, 1, v);
  Array$set(d.arr, d.count, v);
  return (d.count = (d.count + 1), undefined);
}
function Dynarray$pop(d) {
  let _t757;
  if ((d.count === 0)) {
    _t757 = failwith("Dynarray.pop: empty");
  } else {
    _t757 = (d.count = (d.count - 1), undefined);
  }
  _t757;
  return Array$get(d.arr, d.count);
}
function Dynarray$clear(d) {
  return (d.count = 0, undefined);
}
function Dynarray$to_list(d) {
  function collect(i, acc) {
    while (true) {
      let _t758;
      if ((i < 0)) {
        _t758 = acc;
      } else {
        const _t759 = (i - 1);
        const _t760 = ({_hd: Dynarray$get(d, i), _tl: acc});
        i = _t759;
        acc = _t760;
        continue;
        _t758 = undefined;
      }
      return _t758;
    }
  }
  const _t761 = collect((d.count - 1), null);
  return _t761;
}
function Dynarray$to_array(d) {
  return Array$sub(d.arr, 0, d.count);
}
function compare(a, b) {
  let _t762;
  if ((a < b)) {
    _t762 = (-1);
  } else {
    let _t763;
    if ((a > b)) {
      _t763 = 1;
    } else {
      _t763 = 0;
    }
    _t762 = _t763;
  }
  return _t762;
}
function int_of_string(s) {
  let _t765;
  const _t764 = String$to_int(s);
  _t766: {
    if (_t764._tag === 1) {
      const n = _t764._val;
      _t765 = n;
      break _t766;
    }
    if (_t764._tag === 0) {
      _t765 = failwith((("int_of_string: invalid argument \"" + __dict_Show_string.show(s)) + "\""));
      break _t766;
    }
    _match_fail("line 27");
  }
  return _t765;
}
function float_of_string(s) {
  let _t768;
  const _t767 = String$to_float(s);
  _t769: {
    if (_t767._tag === 1) {
      const f = _t767._val;
      _t768 = f;
      break _t769;
    }
    if (_t767._tag === 0) {
      _t768 = failwith((("float_of_string: invalid argument \"" + __dict_Show_string.show(s)) + "\""));
      break _t769;
    }
    _match_fail("line 27");
  }
  return _t768;
}
function max(a, b) {
  let _t770;
  if ((a > b)) {
    _t770 = a;
  } else {
    _t770 = b;
  }
  return _t770;
}
function min(a, b) {
  let _t771;
  if ((a < b)) {
    _t771 = a;
  } else {
    _t771 = b;
  }
  return _t771;
}
function fst(__p7) {
  let _t773;
  const _t772 = __p7;
  _t774: {
    if (true) {
      const a = _t772[0];
      _t773 = a;
      break _t774;
    }
    _match_fail("line 27");
  }
  return _t773;
}
function snd(__p8) {
  let _t776;
  const _t775 = __p8;
  _t777: {
    if (true) {
      const b = _t775[1];
      _t776 = b;
      break _t777;
    }
    _match_fail("line 27");
  }
  return _t776;
}
function list_find(f, xs) {
  let _t779;
  const _t778 = List$find(f, xs);
  _t780: {
    if (_t778._tag === 1) {
      const x = _t778._val;
      _t779 = x;
      break _t780;
    }
    if (_t778._tag === 0) {
      _t779 = failwith("list_find: not found");
      break _t780;
    }
    _match_fail("line 27");
  }
  return _t779;
}
if (typeof Runtime$eval === "undefined") { if (globalThis._mmlExterns && globalThis._mmlExterns["Runtime.eval"]) var Runtime$eval = globalThis._mmlExterns["Runtime.eval"]; else throw new Error("extern " + "Runtime.eval" + " not provided"); }
if (typeof Runtime$eval_file === "undefined") { if (globalThis._mmlExterns && globalThis._mmlExterns["Runtime.eval_file"]) var Runtime$eval_file = globalThis._mmlExterns["Runtime.eval_file"]; else throw new Error("extern " + "Runtime.eval_file" + " not provided"); }
// --- Compiled MiniML ---
let _last_val;
const Token$dummy_loc = ({col: 0, line: 0, offset: 0});
function Token$pp_token_kind(__x) {
  let _t782;
  const _t781 = __x;
  _t783: {
    if (_t781._tag === 0) {
      const n = _t781._val;
      _t782 = (("INT(" + __dict_Show_int.show(n)) + ")");
      break _t783;
    }
    if (_t781._tag === 1) {
      const f = _t781._val;
      _t782 = (("FLOAT(" + __dict_Show_float.show(f)) + ")");
      break _t783;
    }
    if (_t781._tag === 2) {
      const s = _t781._val;
      _t782 = (("STRING(" + __dict_Show_string.show(s)) + ")");
      break _t783;
    }
    if (_t781._tag === 3) {
      _t782 = "INTERP_STRING";
      break _t783;
    }
    if (_t781._tag === 4) {
      const n = _t781._val;
      _t782 = (("BYTE(#" + __fmt_zero_pad(2, __fmt_hex(n))) + ")");
      break _t783;
    }
    if (_t781._tag === 5) {
      const n = _t781._val;
      _t782 = (("RUNE(" + __dict_Show_int.show(n)) + ")");
      break _t783;
    }
    if (_t781._tag === 6) {
      _t782 = "TRUE";
      break _t783;
    }
    if (_t781._tag === 7) {
      _t782 = "FALSE";
      break _t783;
    }
    if (_t781._tag === 8) {
      const s = _t781._val;
      _t782 = (("IDENT(" + __dict_Show_string.show(s)) + ")");
      break _t783;
    }
    if (_t781._tag === 9) {
      const s = _t781._val;
      _t782 = (("UIDENT(" + __dict_Show_string.show(s)) + ")");
      break _t783;
    }
    if (_t781._tag === 10) {
      const s = _t781._val;
      _t782 = (("TYVAR('" + __dict_Show_string.show(s)) + ")");
      break _t783;
    }
    if (_t781._tag === 11) {
      _t782 = "LET";
      break _t783;
    }
    if (_t781._tag === 12) {
      _t782 = "REC";
      break _t783;
    }
    if (_t781._tag === 13) {
      _t782 = "IN";
      break _t783;
    }
    if (_t781._tag === 14) {
      _t782 = "IF";
      break _t783;
    }
    if (_t781._tag === 15) {
      _t782 = "ELSE";
      break _t783;
    }
    if (_t781._tag === 16) {
      _t782 = "FN";
      break _t783;
    }
    if (_t781._tag === 17) {
      _t782 = "MATCH";
      break _t783;
    }
    if (_t781._tag === 18) {
      _t782 = "WITH";
      break _t783;
    }
    if (_t781._tag === 19) {
      _t782 = "TYPE";
      break _t783;
    }
    if (_t781._tag === 20) {
      _t782 = "OF";
      break _t783;
    }
    if (_t781._tag === 21) {
      _t782 = "CLASS";
      break _t783;
    }
    if (_t781._tag === 22) {
      _t782 = "INSTANCE";
      break _t783;
    }
    if (_t781._tag === 23) {
      _t782 = "EFFECT";
      break _t783;
    }
    if (_t781._tag === 24) {
      _t782 = "EXTERN";
      break _t783;
    }
    if (_t781._tag === 65) {
      _t782 = "PERFORM";
      break _t783;
    }
    if (_t781._tag === 66) {
      _t782 = "HANDLE";
      break _t783;
    }
    if (_t781._tag === 27) {
      _t782 = "TRY";
      break _t783;
    }
    if (_t781._tag === 28) {
      _t782 = "CONTINUE";
      break _t783;
    }
    if (_t781._tag === 67) {
      _t782 = "RESUME";
      break _t783;
    }
    if (_t781._tag === 44) {
      _t782 = "RETURN";
      break _t783;
    }
    if (_t781._tag === 31) {
      _t782 = "MUT";
      break _t783;
    }
    if (_t781._tag === 32) {
      _t782 = "FOR";
      break _t783;
    }
    if (_t781._tag === 33) {
      _t782 = "DO";
      break _t783;
    }
    if (_t781._tag === 34) {
      _t782 = "BREAK";
      break _t783;
    }
    if (_t781._tag === 35) {
      _t782 = "WHEN";
      break _t783;
    }
    if (_t781._tag === 36) {
      _t782 = "WHERE";
      break _t783;
    }
    if (_t781._tag === 37) {
      _t782 = "PARTIAL";
      break _t783;
    }
    if (_t781._tag === 30) {
      _t782 = "NOT";
      break _t783;
    }
    if (_t781._tag === 39) {
      _t782 = "HASH";
      break _t783;
    }
    if (_t781._tag === 40) {
      _t782 = "FATARROW";
      break _t783;
    }
    if (_t781._tag === 17) {
      _t782 = "MOD";
      break _t783;
    }
    if (_t781._tag === 42) {
      _t782 = "MODULE";
      break _t783;
    }
    if (_t781._tag === 43) {
      _t782 = "PUB";
      break _t783;
    }
    if (_t781._tag === 44) {
      _t782 = "OPEN";
      break _t783;
    }
    if (_t781._tag === 45) {
      _t782 = "END";
      break _t783;
    }
    if (_t781._tag === 46) {
      _t782 = "OPAQUE";
      break _t783;
    }
    if (_t781._tag === 47) {
      _t782 = "WHILE";
      break _t783;
    }
    if (_t781._tag === 48) {
      _t782 = "AND";
      break _t783;
    }
    if (_t781._tag === 49) {
      _t782 = "DERIVING";
      break _t783;
    }
    if (_t781._tag === 50) {
      _t782 = "LPAREN";
      break _t783;
    }
    if (_t781._tag === 51) {
      _t782 = "RPAREN";
      break _t783;
    }
    if (_t781._tag === 52) {
      _t782 = "LBRACE";
      break _t783;
    }
    if (_t781._tag === 53) {
      _t782 = "RBRACE";
      break _t783;
    }
    if (_t781._tag === 54) {
      _t782 = "LBRACKET";
      break _t783;
    }
    if (_t781._tag === 55) {
      _t782 = "RBRACKET";
      break _t783;
    }
    if (_t781._tag === 56) {
      _t782 = "ARROW";
      break _t783;
    }
    if (_t781._tag === 57) {
      _t782 = "COMMA";
      break _t783;
    }
    if (_t781._tag === 58) {
      _t782 = "SEMICOLON";
      break _t783;
    }
    if (_t781._tag === 59) {
      _t782 = "DOUBLE_SEMICOLON";
      break _t783;
    }
    if (_t781._tag === 60) {
      _t782 = "COLON";
      break _t783;
    }
    if (_t781._tag === 61) {
      _t782 = "DOT";
      break _t783;
    }
    if (_t781._tag === 62) {
      _t782 = "DOTDOT";
      break _t783;
    }
    if (_t781._tag === 63) {
      _t782 = "PIPE";
      break _t783;
    }
    if (_t781._tag === 64) {
      _t782 = "PIPEARROW";
      break _t783;
    }
    if (_t781._tag === 65) {
      _t782 = "UNDERSCORE";
      break _t783;
    }
    if (_t781._tag === 66) {
      _t782 = "PLUS";
      break _t783;
    }
    if (_t781._tag === 67) {
      _t782 = "MINUS";
      break _t783;
    }
    if (_t781._tag === 68) {
      _t782 = "STAR";
      break _t783;
    }
    if (_t781._tag === 69) {
      _t782 = "SLASH";
      break _t783;
    }
    if (_t781._tag === 70) {
      _t782 = "CARET";
      break _t783;
    }
    if (_t781._tag === 71) {
      _t782 = "COLONCOLON";
      break _t783;
    }
    if (_t781._tag === 72) {
      _t782 = "COLONEQUAL";
      break _t783;
    }
    if (_t781._tag === 24) {
      _t782 = "EQ";
      break _t783;
    }
    if (_t781._tag === 25) {
      _t782 = "NEQ";
      break _t783;
    }
    if (_t781._tag === 26) {
      _t782 = "LT";
      break _t783;
    }
    if (_t781._tag === 27) {
      _t782 = "GT";
      break _t783;
    }
    if (_t781._tag === 28) {
      _t782 = "LE";
      break _t783;
    }
    if (_t781._tag === 29) {
      _t782 = "GE";
      break _t783;
    }
    if (_t781._tag === 79) {
      _t782 = "AMPAMP";
      break _t783;
    }
    if (_t781._tag === 80) {
      _t782 = "PIPEPIPE";
      break _t783;
    }
    if (_t781._tag === 81) {
      _t782 = "LAND";
      break _t783;
    }
    if (_t781._tag === 82) {
      _t782 = "LOR";
      break _t783;
    }
    if (_t781._tag === 83) {
      _t782 = "LXOR";
      break _t783;
    }
    if (_t781._tag === 84) {
      _t782 = "LNOT";
      break _t783;
    }
    if (_t781._tag === 85) {
      _t782 = "LSL";
      break _t783;
    }
    if (_t781._tag === 86) {
      _t782 = "LSR";
      break _t783;
    }
    if (_t781._tag === 87) {
      const s = _t781._val;
      _t782 = (("POLYTAG(`" + __dict_Show_string.show(s)) + ")");
      break _t783;
    }
    if (_t781._tag === 88) {
      _t782 = "COLONGT";
      break _t783;
    }
    if (_t781._tag === 89) {
      _t782 = "EOF";
      break _t783;
    }
    _match_fail("line 15950");
  }
  return _t782;
}
function Token$pp_token(t) {
  return ((((__dict_Show_string.show(Token$pp_token_kind(t.kind)) + "@") + __dict_Show_int.show(t.loc.line)) + ":") + __dict_Show_int.show(t.loc.col));
}
function Bytecode$make_record_shape(field_names) {
  const fields_784 = Array$of_list(field_names);
  const index_786 = Hashtbl$create(Array$length(fields_784));
  function _t788(i, name) {
    return _call(Hashtbl$set, [__dict_Hash_string, __dict_Eq_string, index_786, name, i]);
  }
  Array$iteri(_t788, fields_784);
  const _t787 = ({rs_fields: fields_784, rs_index: index_786});
  const _t785 = _t787;
  return _t785;
}
function Bytecode$make_record(field_names, values) {
  const shape_789 = Bytecode$make_record_shape(field_names);
  const _t790 = ({_tag: 9, _name: "VRecord", _val: [shape_789, values]});
  return _t790;
}
function Bytecode$pp_value(__x) {
  let _t792;
  const _t791 = __x;
  _t793: {
    if (_t791._tag === 0) {
      const n = _t791._val;
      _t792 = string_of_int(n);
      break _t793;
    }
    if (_t791._tag === 1) {
      const f = _t791._val;
      const s_794 = __dict_Show_float.show(f);
      let _t796;
      if ((String$contains(".", s_794) || String$contains("e", s_794))) {
        _t796 = s_794;
      } else {
        _t796 = (s_794 + ".");
      }
      const _t795 = _t796;
      _t792 = _t795;
      break _t793;
    }
    if (_t791._tag === 2 && _t791._val) {
      _t792 = "true";
      break _t793;
    }
    if (_t791._tag === 2 && !_t791._val) {
      _t792 = "false";
      break _t793;
    }
    if (_t791._tag === 3) {
      const s = _t791._val;
      _t792 = s;
      break _t793;
    }
    if (_t791._tag === 4) {
      const n = _t791._val;
      _t792 = ("#" + __fmt_zero_pad(2, __fmt_hex(n)));
      break _t793;
    }
    if (_t791._tag === 5) {
      const cp = _t791._val;
      let _t797;
      if ((cp < 128)) {
        _t797 = (("'" + __dict_Show_byte.show(Byte$of_int(cp))) + "'");
      } else {
        const buf_798 = Buffer$create(6);
        Buffer$add_byte(buf_798, 39);
        let _t800;
        if ((cp < 2048)) {
          Buffer$add_byte(buf_798, Byte$of_int((192 | (cp >> 6))));
          _t800 = Buffer$add_byte(buf_798, Byte$of_int((128 | (cp & 63))));
        } else {
          let _t801;
          if ((cp < 65536)) {
            Buffer$add_byte(buf_798, Byte$of_int((224 | (cp >> 12))));
            Buffer$add_byte(buf_798, Byte$of_int((128 | ((cp >> 6) & 63))));
            _t801 = Buffer$add_byte(buf_798, Byte$of_int((128 | (cp & 63))));
          } else {
            Buffer$add_byte(buf_798, Byte$of_int((240 | (cp >> 18))));
            Buffer$add_byte(buf_798, Byte$of_int((128 | ((cp >> 12) & 63))));
            Buffer$add_byte(buf_798, Byte$of_int((128 | ((cp >> 6) & 63))));
            _t801 = Buffer$add_byte(buf_798, Byte$of_int((128 | (cp & 63))));
          }
          _t800 = _t801;
        }
        _t800;
        Buffer$add_byte(buf_798, 39);
        const _t799 = Buffer$contents(buf_798);
        _t797 = _t799;
      }
      _t792 = _t797;
      break _t793;
    }
    if (_t791._tag === 6) {
      _t792 = "()";
      break _t793;
    }
    if (_t791._tag === 7) {
      const vs = _t791._val;
      _t792 = ("(" + (String$concat(", ", Array$to_list(Array$map(Bytecode$pp_value, vs))) + ")"));
      break _t793;
    }
    if (_t791._tag === 8) {
      const vs = _t791._val;
      _t792 = ("[" + (String$concat("; ", List$map(Bytecode$pp_value, vs)) + "]"));
      break _t793;
    }
    if (_t791._tag === 9) {
      const shape = _t791._val[0];
      const values = _t791._val[1];
      function _t802(i) {
        return (Array$get(shape.rs_fields, i) + (" = " + Bytecode$pp_value(Array$get(values, i))));
      }
      _t792 = ("{ " + (String$concat("; ", List$init(Array$length(shape.rs_fields), _t802)) + " }"));
      break _t793;
    }
    if (_t791._tag === 10 && _t791._val[2]._tag === 0) {
      const name = _t791._val[1];
      _t792 = name;
      break _t793;
    }
    if (_t791._tag === 10 && _t791._val[2]._tag === 1) {
      const name = _t791._val[1];
      const v = _t791._val[2]._val;
      let _t804;
      const _t803 = v;
      _t805: {
        if ((_t803._tag === 7 || _t803._tag === 10 && _t803._val[2]._tag === 1)) {
          _t804 = ("(" + (Bytecode$pp_value(v) + ")"));
          break _t805;
        }
        if (true) {
          _t804 = Bytecode$pp_value(v);
          break _t805;
        }
        _match_fail("line 15950");
      }
      _t792 = (name + (" " + _t804));
      break _t793;
    }
    if (_t791._tag === 11) {
      _t792 = "<fun>";
      break _t793;
    }
    if (_t791._tag === 12) {
      _t792 = "<fun>";
      break _t793;
    }
    if (_t791._tag === 14) {
      const ext = _t791._val;
      let _t806;
      if (_eq(ext.ext_args, null)) {
        _t806 = (("<external:" + __dict_Show_string.show(ext.ext_name)) + ">");
      } else {
        _t806 = "<fun>";
      }
      _t792 = _t806;
      break _t793;
    }
    if (_t791._tag === 13) {
      const p = _t791._val;
      _t792 = (("<proto:" + __dict_Show_string.show(p.name)) + ">");
      break _t793;
    }
    if (_t791._tag === 15) {
      _t792 = "<continuation>";
      break _t793;
    }
    if (_t791._tag === 16) {
      const r = _t791._val;
      _t792 = (("ref(" + __dict_Show_string.show(Bytecode$pp_value(Ref$get(r)))) + ")");
      break _t793;
    }
    if (_t791._tag === 17) {
      const pairs = _t791._val;
      function _t807(__p9) {
        let _t809;
        const _t808 = __p9;
        _t810: {
          if (true) {
            const v = _t808[1];
            _t809 = _eq(v, ({_tag: 6, _name: "VUnit"}));
            break _t810;
          }
          _match_fail("line 15950");
        }
        return _t809;
      }
      const is_set_811 = List$forall(_t807, pairs);
      let _t813;
      if (is_set_811) {
        function _t814(__p10) {
          let _t816;
          const _t815 = __p10;
          _t817: {
            if (true) {
              const k = _t815[0];
              _t816 = Bytecode$pp_value(k);
              break _t817;
            }
            _match_fail("line 15950");
          }
          return _t816;
        }
        _t813 = ("#{" + (String$concat("; ", List$map(_t814, pairs)) + "}"));
      } else {
        function _t818(__p11) {
          let _t820;
          const _t819 = __p11;
          _t821: {
            if (true) {
              const k = _t819[0];
              const v = _t819[1];
              _t820 = (Bytecode$pp_value(k) + (": " + Bytecode$pp_value(v)));
              break _t821;
            }
            _match_fail("line 15950");
          }
          return _t820;
        }
        _t813 = ("#{" + (String$concat("; ", List$map(_t818, pairs)) + "}"));
      }
      const _t812 = _t813;
      _t792 = _t812;
      break _t793;
    }
    if (_t791._tag === 18) {
      const arr = _t791._val;
      _t792 = ("#[" + (String$concat("; ", Array$to_list(Array$map(Bytecode$pp_value, arr))) + "]"));
      break _t793;
    }
    _match_fail("line 15950");
  }
  return _t792;
}
function Bytecode$pp_capture(__x) {
  let _t823;
  const _t822 = __x;
  _t824: {
    if (_t822._tag === 0) {
      const i = _t822._val;
      _t823 = (("local(" + __dict_Show_int.show(i)) + ")");
      break _t824;
    }
    if (_t822._tag === 1) {
      const i = _t822._val;
      _t823 = (("upvalue(" + __dict_Show_int.show(i)) + ")");
      break _t824;
    }
    _match_fail("line 15950");
  }
  return _t823;
}
function Bytecode$pp_opcode(__x) {
  let _t826;
  const _t825 = __x;
  _t827: {
    if (_t825._tag === 0) {
      const i = _t825._val;
      _t826 = ("CONST " + __dict_Show_int.show(i));
      break _t827;
    }
    if (_t825._tag === 1) {
      _t826 = "POP";
      break _t827;
    }
    if (_t825._tag === 2) {
      _t826 = "DUP";
      break _t827;
    }
    if (_t825._tag === 3) {
      const i = _t825._val;
      _t826 = ("GET_LOCAL " + __dict_Show_int.show(i));
      break _t827;
    }
    if (_t825._tag === 4) {
      const i = _t825._val;
      _t826 = ("SET_LOCAL " + __dict_Show_int.show(i));
      break _t827;
    }
    if (_t825._tag === 5) {
      const i = _t825._val;
      _t826 = ("GET_UPVALUE " + __dict_Show_int.show(i));
      break _t827;
    }
    if (_t825._tag === 6) {
      const i = _t825._val;
      _t826 = ("SET_UPVALUE " + __dict_Show_int.show(i));
      break _t827;
    }
    if (_t825._tag === 7) {
      _t826 = "MAKE_REF";
      break _t827;
    }
    if (_t825._tag === 8) {
      _t826 = "DEREF";
      break _t827;
    }
    if (_t825._tag === 9) {
      _t826 = "SET_REF";
      break _t827;
    }
    if (_t825._tag === 10) {
      const i = _t825._val;
      _t826 = ("GET_GLOBAL " + __dict_Show_int.show(i));
      break _t827;
    }
    if (_t825._tag === 11) {
      const i = _t825._val;
      _t826 = ("SET_GLOBAL " + __dict_Show_int.show(i));
      break _t827;
    }
    if (_t825._tag === 12) {
      const i = _t825._val;
      _t826 = ("DEF_GLOBAL " + __dict_Show_int.show(i));
      break _t827;
    }
    if (_t825._tag === 13) {
      _t826 = "ADD";
      break _t827;
    }
    if (_t825._tag === 14) {
      _t826 = "SUB";
      break _t827;
    }
    if (_t825._tag === 15) {
      _t826 = "MUL";
      break _t827;
    }
    if (_t825._tag === 16) {
      _t826 = "DIV";
      break _t827;
    }
    if (_t825._tag === 17) {
      _t826 = "MOD";
      break _t827;
    }
    if (_t825._tag === 18) {
      _t826 = "NEG";
      break _t827;
    }
    if (_t825._tag === 19) {
      _t826 = "FADD";
      break _t827;
    }
    if (_t825._tag === 20) {
      _t826 = "FSUB";
      break _t827;
    }
    if (_t825._tag === 21) {
      _t826 = "FMUL";
      break _t827;
    }
    if (_t825._tag === 22) {
      _t826 = "FDIV";
      break _t827;
    }
    if (_t825._tag === 23) {
      _t826 = "FNEG";
      break _t827;
    }
    if (_t825._tag === 24) {
      _t826 = "EQ";
      break _t827;
    }
    if (_t825._tag === 25) {
      _t826 = "NEQ";
      break _t827;
    }
    if (_t825._tag === 26) {
      _t826 = "LT";
      break _t827;
    }
    if (_t825._tag === 27) {
      _t826 = "GT";
      break _t827;
    }
    if (_t825._tag === 28) {
      _t826 = "LE";
      break _t827;
    }
    if (_t825._tag === 29) {
      _t826 = "GE";
      break _t827;
    }
    if (_t825._tag === 30) {
      _t826 = "NOT";
      break _t827;
    }
    if (_t825._tag === 31) {
      _t826 = "BAND";
      break _t827;
    }
    if (_t825._tag === 32) {
      _t826 = "BOR";
      break _t827;
    }
    if (_t825._tag === 33) {
      _t826 = "BXOR";
      break _t827;
    }
    if (_t825._tag === 34) {
      _t826 = "BNOT";
      break _t827;
    }
    if (_t825._tag === 35) {
      _t826 = "BSHL";
      break _t827;
    }
    if (_t825._tag === 36) {
      _t826 = "BSHR";
      break _t827;
    }
    if (_t825._tag === 37) {
      const off = _t825._val;
      _t826 = ("JUMP " + __dict_Show_int.show(off));
      break _t827;
    }
    if (_t825._tag === 38) {
      const off = _t825._val;
      _t826 = ("JUMP_IF_FALSE " + __dict_Show_int.show(off));
      break _t827;
    }
    if (_t825._tag === 39) {
      const off = _t825._val;
      _t826 = ("JUMP_IF_TRUE " + __dict_Show_int.show(off));
      break _t827;
    }
    if (_t825._tag === 40) {
      const i = _t825._val[0];
      const caps = _t825._val[1];
      _t826 = (((("CLOSURE " + __dict_Show_int.show(i)) + " [") + __dict_Show_string.show(String$concat(", ", List$map(Bytecode$pp_capture, caps)))) + "]");
      break _t827;
    }
    if (_t825._tag === 41) {
      const i = _t825._val[0];
      const caps = _t825._val[1];
      const self = _t825._val[2];
      _t826 = ((((("CLOSURE_REC " + __dict_Show_int.show(i)) + " [") + __dict_Show_string.show(String$concat(", ", List$map(Bytecode$pp_capture, caps)))) + "] self=") + __dict_Show_int.show(self));
      break _t827;
    }
    if (_t825._tag === 42) {
      const n = _t825._val;
      _t826 = ("CALL " + __dict_Show_int.show(n));
      break _t827;
    }
    if (_t825._tag === 43) {
      const n = _t825._val;
      _t826 = ("TAIL_CALL " + __dict_Show_int.show(n));
      break _t827;
    }
    if (_t825._tag === 44) {
      _t826 = "RETURN";
      break _t827;
    }
    if (_t825._tag === 45) {
      _t826 = "FUNC_RETURN";
      break _t827;
    }
    if (_t825._tag === 46) {
      _t826 = "ENTER_FUNC";
      break _t827;
    }
    if (_t825._tag === 47) {
      _t826 = "EXIT_FUNC";
      break _t827;
    }
    if (_t825._tag === 48) {
      const n = _t825._val;
      _t826 = ("MAKE_TUPLE " + __dict_Show_int.show(n));
      break _t827;
    }
    if (_t825._tag === 49) {
      const i = _t825._val;
      _t826 = ("TUPLE_GET " + __dict_Show_int.show(i));
      break _t827;
    }
    if (_t825._tag === 50) {
      const fields = _t825._val;
      _t826 = (("MAKE_RECORD [" + __dict_Show_string.show(String$concat(", ", fields))) + "]");
      break _t827;
    }
    if (_t825._tag === 51) {
      const name = _t825._val;
      _t826 = ("FIELD " + __dict_Show_string.show(name));
      break _t827;
    }
    if (_t825._tag === 52) {
      const name = _t825._val;
      _t826 = ("SET_FIELD " + __dict_Show_string.show(name));
      break _t827;
    }
    if (_t825._tag === 53) {
      const fields = _t825._val;
      _t826 = (("RECORD_UPDATE [" + __dict_Show_string.show(String$concat(", ", fields))) + "]");
      break _t827;
    }
    if (_t825._tag === 54) {
      const n = _t825._val;
      _t826 = ("RECORD_UPDATE_DYN " + __dict_Show_int.show(n));
      break _t827;
    }
    if (_t825._tag === 55) {
      const tag = _t825._val[0];
      const name = _t825._val[1];
      const has_payload = _t825._val[2];
      _t826 = ((((("MAKE_VARIANT " + __dict_Show_int.show(tag)) + " ") + __dict_Show_string.show(name)) + " ") + __dict_Show_bool.show(has_payload));
      break _t827;
    }
    if (_t825._tag === 56) {
      _t826 = "CONS";
      break _t827;
    }
    if (_t825._tag === 57) {
      _t826 = "NIL";
      break _t827;
    }
    if (_t825._tag === 58) {
      const tag = _t825._val;
      _t826 = ("TAG_EQ " + __dict_Show_int.show(tag));
      break _t827;
    }
    if (_t825._tag === 59) {
      _t826 = "IS_NIL";
      break _t827;
    }
    if (_t825._tag === 60) {
      _t826 = "IS_CONS";
      break _t827;
    }
    if (_t825._tag === 61) {
      _t826 = "HEAD";
      break _t827;
    }
    if (_t825._tag === 62) {
      _t826 = "TAIL";
      break _t827;
    }
    if (_t825._tag === 63) {
      _t826 = "VARIANT_PAYLOAD";
      break _t827;
    }
    if (_t825._tag === 64) {
      const loc = _t825._val;
      _t826 = ("MATCH_FAIL " + __dict_Show_string.show(loc));
      break _t827;
    }
    if (_t825._tag === 65) {
      const op = _t825._val;
      _t826 = ("PERFORM " + __dict_Show_string.show(op));
      break _t827;
    }
    if (_t825._tag === 66) {
      const n = _t825._val;
      _t826 = ("HANDLE " + __dict_Show_int.show(n));
      break _t827;
    }
    if (_t825._tag === 67) {
      _t826 = "RESUME";
      break _t827;
    }
    if (_t825._tag === 68) {
      const n = _t825._val;
      _t826 = ("ENTER_LOOP " + __dict_Show_int.show(n));
      break _t827;
    }
    if (_t825._tag === 69) {
      _t826 = "EXIT_LOOP";
      break _t827;
    }
    if (_t825._tag === 70) {
      _t826 = "LOOP_BREAK";
      break _t827;
    }
    if (_t825._tag === 71) {
      const n = _t825._val;
      _t826 = ("LOOP_CONTINUE " + __dict_Show_int.show(n));
      break _t827;
    }
    if (_t825._tag === 72) {
      const n = _t825._val;
      _t826 = ("FOLD_CONTINUE " + __dict_Show_int.show(n));
      break _t827;
    }
    if (_t825._tag === 73) {
      const n = _t825._val;
      _t826 = ("MAKE_MAP " + __dict_Show_int.show(n));
      break _t827;
    }
    if (_t825._tag === 74) {
      const n = _t825._val;
      _t826 = ("MAKE_ARRAY " + __dict_Show_int.show(n));
      break _t827;
    }
    if (_t825._tag === 75) {
      _t826 = "INDEX";
      break _t827;
    }
    if (_t825._tag === 76) {
      _t826 = "HALT";
      break _t827;
    }
    if (_t825._tag === 77) {
      const slot = _t825._val[0];
      const arity = _t825._val[1];
      _t826 = ((("GET_LOCAL_CALL " + __dict_Show_int.show(slot)) + " ") + __dict_Show_int.show(arity));
      break _t827;
    }
    if (_t825._tag === 78) {
      const slot = _t825._val[0];
      const idx = _t825._val[1];
      _t826 = ((("GET_LOCAL_TUPLE_GET " + __dict_Show_int.show(slot)) + " ") + __dict_Show_int.show(idx));
      break _t827;
    }
    if (_t825._tag === 79) {
      const slot = _t825._val[0];
      const name = _t825._val[1];
      _t826 = ((("GET_LOCAL_FIELD " + __dict_Show_int.show(slot)) + " ") + __dict_Show_string.show(name));
      break _t827;
    }
    if (_t825._tag === 80) {
      const idx = _t825._val[0];
      const arity = _t825._val[1];
      _t826 = ((("GET_GLOBAL_CALL " + __dict_Show_int.show(idx)) + " ") + __dict_Show_int.show(arity));
      break _t827;
    }
    if (_t825._tag === 81) {
      const idx = _t825._val[0];
      const name = _t825._val[1];
      _t826 = ((("GET_GLOBAL_FIELD " + __dict_Show_int.show(idx)) + " ") + __dict_Show_string.show(name));
      break _t827;
    }
    if (_t825._tag === 82) {
      const min_tag = _t825._val[0];
      const targets = _t825._val[1];
      const _mml$default = _t825._val[2];
      _t826 = ((((("JUMP_TABLE min=" + __dict_Show_int.show(min_tag)) + " [") + __dict_Show_string.show(String$concat(",", Array$to_list(Array$map(string_of_int, targets))))) + "] default=") + __dict_Show_int.show(_mml$default));
      break _t827;
    }
    if (_t825._tag === 83) {
      const n = _t825._val;
      _t826 = ("CALL_N " + __dict_Show_int.show(n));
      break _t827;
    }
    if (_t825._tag === 84) {
      const n = _t825._val;
      _t826 = ("TAIL_CALL_N " + __dict_Show_int.show(n));
      break _t827;
    }
    _match_fail("line 15950");
  }
  return _t826;
}
function Bytecode$disassemble(__dict_Show_2, __dict_Show_1, __dict_Show_0, proto) {
  const buf_828 = Buffer$create(256);
  Buffer$add_string(buf_828, (((((("=== " + __dict_Show_2.show(proto.name)) + " (arity=") + __dict_Show_1.show(proto.arity)) + ", locals=") + __dict_Show_0.show(proto.num_locals)) + ") ===\n"));
  const prev_line_830 = Ref$create(0);
  function _t832(i, op) {
    let _t833;
    if ((i < Array$length(proto.line_table))) {
      _t833 = Array$get(proto.line_table, i);
    } else {
      _t833 = 0;
    }
    const line_834 = _t833;
    let _t836;
    if (((line_834 > 0) && (line_834 !== Ref$get(prev_line_830)))) {
      Ref$set(prev_line_830, line_834);
      _t836 = __dict_Show_int.show(line_834);
    } else {
      _t836 = "   |";
    }
    const line_str_837 = _t836;
    const _t838 = Buffer$add_string(buf_828, (((((__dict_Show_string.show(line_str_837) + " ") + __fmt_zero_pad(4, __dict_Show_int.show(i))) + "  ") + __dict_Show_string.show(Bytecode$pp_opcode(op))) + "\n"));
    const _t835 = _t838;
    return _t835;
  }
  Array$iteri(_t832, proto.code);
  const _t831 = Buffer$contents(buf_828);
  const _t829 = _t831;
  return _t829;
}
function Types$mono(ty) {
  return ({body: ty, constraints: null, equant: 0, pvquant: 0, quant: 0, record_evidences: null, rquant: 0});
}
const Types$next_id = Ref$create(0);
function Types$fresh_id(_) {
  const id_839 = Ref$get(Types$next_id);
  Ref$set(Types$next_id, (id_839 + 1));
  const _t840 = id_839;
  return _t840;
}
function Types$new_tvar(level) {
  return ({_tag: 16, _name: "TVar", _val: Ref$create(({_tag: 0, _name: "Unbound", _val: [Types$fresh_id(undefined), level]}))});
}
function Types$new_effvar(level) {
  return ({_tag: 0, _name: "EffVar", _val: Ref$create(({_tag: 0, _name: "EffUnbound", _val: [Types$fresh_id(undefined), level]}))});
}
function Types$new_pvvar(level) {
  return ({_tag: 1, _name: "PVVar", _val: Ref$create(({_tag: 0, _name: "PVUnbound", _val: [Types$fresh_id(undefined), level]}))});
}
function Types$new_rvar(level) {
  return ({_tag: 1, _name: "RVar", _val: Ref$create(({_tag: 0, _name: "RUnbound", _val: [Types$fresh_id(undefined), level]}))});
}
function Types$repr(__x) {
  let _t842;
  const _t841 = __x;
  _t843: {
    if (_t841._tag === 16 && _t841._val.contents._tag === 1) {
      const ty = _t841._val.contents._val;
      const r = _t841._val;
      const ty_844 = Types$repr(ty);
      Ref$set(r, ({_tag: 1, _name: "Link", _val: ty_844}));
      const _t845 = ty_844;
      _t842 = _t845;
      break _t843;
    }
    if (true) {
      const ty = _t841;
      _t842 = ty;
      break _t843;
    }
    _match_fail("line 15950");
  }
  return _t842;
}
function Types$is_concrete(ty) {
  while (true) {
    let _t847;
    const _t846 = Types$repr(ty);
    _t848: {
      if (_t846._tag === 16 && _t846._val.contents._tag === 0) {
        _t847 = false;
        break _t848;
      }
      if (_t846._tag === 16 && _t846._val.contents._tag === 1) {
        _t847 = failwith("assert false");
        break _t848;
      }
      if ((_t846._tag === 7 || _t846._tag === 8)) {
        const a = _t846._val[0];
        const eff = _t846._val[1];
        const r = _t846._val[2];
        _t847 = (Types$is_concrete(a) && (Types$is_concrete_eff(eff) && Types$is_concrete(r)));
        break _t848;
      }
      if (_t846._tag === 9) {
        const ts = _t846._val;
        _t847 = List$forall(Types$is_concrete, ts);
        break _t848;
      }
      if ((_t846._tag === 10 || _t846._tag === 14)) {
        const t = _t846._val;
        const _t849 = t;
        ty = _t849;
        continue;
        _t847 = undefined;
        break _t848;
      }
      if (_t846._tag === 13) {
        const k = _t846._val[0];
        const v = _t846._val[1];
        _t847 = (Types$is_concrete(k) && Types$is_concrete(v));
        break _t848;
      }
      if (_t846._tag === 12) {
        const args = _t846._val[1];
        _t847 = List$forall(Types$is_concrete, args);
        break _t848;
      }
      if ((((((((_t846._tag === 0 || _t846._tag === 1) || _t846._tag === 2) || _t846._tag === 3) || _t846._tag === 4) || _t846._tag === 5) || _t846._tag === 6) || _t846._tag === 17)) {
        _t847 = true;
        break _t848;
      }
      if (_t846._tag === 11) {
        const row = _t846._val;
        _t847 = Types$is_concrete_rrow(row);
        break _t848;
      }
      if (_t846._tag === 15) {
        const row = _t846._val;
        _t847 = Types$is_concrete_pv(row);
        break _t848;
      }
      _match_fail("line 15950");
    }
    return _t847;
  }
}
function Types$is_concrete_eff(__x) {
  while (true) {
    let _t851;
    const _t850 = __x;
    _t852: {
      if (_t850._tag === 0 && _t850._val.contents._tag === 1) {
        const eff = _t850._val.contents._val;
        const _t853 = eff;
        __x = _t853;
        continue;
        _t851 = undefined;
        break _t852;
      }
      if (_t850._tag === 0 && _t850._val.contents._tag === 0) {
        _t851 = false;
        break _t852;
      }
      if (_t850._tag === 2) {
        const tys = _t850._val[1];
        const tail = _t850._val[2];
        _t851 = (List$forall(Types$is_concrete, tys) && Types$is_concrete_eff(tail));
        break _t852;
      }
      if (_t850._tag === 1) {
        _t851 = true;
        break _t852;
      }
      if (_t850._tag === 3) {
        _t851 = true;
        break _t852;
      }
      _match_fail("line 15950");
    }
    return _t851;
  }
}
function Types$is_concrete_rrow(__x) {
  while (true) {
    let _t855;
    const _t854 = __x;
    _t856: {
      if (_t854._tag === 0) {
        const ty = _t854._val[1];
        const tail = _t854._val[2];
        _t855 = (Types$is_concrete(ty) && Types$is_concrete_rrow(tail));
        break _t856;
      }
      if (_t854._tag === 1 && _t854._val.contents._tag === 1) {
        const row = _t854._val.contents._val;
        const _t857 = row;
        __x = _t857;
        continue;
        _t855 = undefined;
        break _t856;
      }
      if (_t854._tag === 1 && _t854._val.contents._tag === 0) {
        _t855 = false;
        break _t856;
      }
      if (_t854._tag === 2) {
        _t855 = true;
        break _t856;
      }
      if ((_t854._tag === 3 || _t854._tag === 4)) {
        _t855 = true;
        break _t856;
      }
      _match_fail("line 15950");
    }
    return _t855;
  }
}
function Types$is_concrete_pv(__x) {
  while (true) {
    let _t859;
    const _t858 = __x;
    _t860: {
      if (_t858._tag === 0 && _t858._val[1]._tag === 1) {
        const ty = _t858._val[1]._val;
        const tail = _t858._val[2];
        _t859 = (Types$is_concrete(ty) && Types$is_concrete_pv(tail));
        break _t860;
      }
      if (_t858._tag === 0 && _t858._val[1]._tag === 0) {
        const tail = _t858._val[2];
        const _t861 = tail;
        __x = _t861;
        continue;
        _t859 = undefined;
        break _t860;
      }
      if (_t858._tag === 1 && _t858._val.contents._tag === 1) {
        const row = _t858._val.contents._val;
        const _t862 = row;
        __x = _t862;
        continue;
        _t859 = undefined;
        break _t860;
      }
      if (_t858._tag === 1 && _t858._val.contents._tag === 0) {
        _t859 = false;
        break _t860;
      }
      if (_t858._tag === 2) {
        _t859 = true;
        break _t860;
      }
      if (_t858._tag === 3) {
        _t859 = true;
        break _t860;
      }
      _match_fail("line 15950");
    }
    return _t859;
  }
}
function Types$eff_repr(__x) {
  let _t864;
  const _t863 = __x;
  _t865: {
    if (_t863._tag === 0 && _t863._val.contents._tag === 1) {
      const eff = _t863._val.contents._val;
      const r = _t863._val;
      const eff_866 = Types$eff_repr(eff);
      Ref$set(r, ({_tag: 1, _name: "EffLink", _val: eff_866}));
      const _t867 = eff_866;
      _t864 = _t867;
      break _t865;
    }
    if (true) {
      const eff = _t863;
      _t864 = eff;
      break _t865;
    }
    _match_fail("line 15950");
  }
  return _t864;
}
function Types$pv_repr(__x) {
  let _t869;
  const _t868 = __x;
  _t870: {
    if (_t868._tag === 1 && _t868._val.contents._tag === 1) {
      const row = _t868._val.contents._val;
      const r = _t868._val;
      const row_871 = Types$pv_repr(row);
      Ref$set(r, ({_tag: 1, _name: "PVLink", _val: row_871}));
      const _t872 = row_871;
      _t869 = _t872;
      break _t870;
    }
    if (true) {
      const row = _t868;
      _t869 = row;
      break _t870;
    }
    _match_fail("line 15950");
  }
  return _t869;
}
function Types$rrow_repr(__x) {
  let _t874;
  const _t873 = __x;
  _t875: {
    if (_t873._tag === 1 && _t873._val.contents._tag === 1) {
      const row = _t873._val.contents._val;
      const r = _t873._val;
      const row_876 = Types$rrow_repr(row);
      Ref$set(r, ({_tag: 1, _name: "RLink", _val: row_876}));
      const _t877 = row_876;
      _t874 = _t877;
      break _t875;
    }
    if (true) {
      const row = _t873;
      _t874 = row;
      break _t875;
    }
    _match_fail("line 15950");
  }
  return _t874;
}
function Types$fields_to_closed_row(fields) {
  function _t878(__p12, acc) {
    let _t880;
    const _t879 = __p12;
    _t881: {
      if (true) {
        const n = _t879[0];
        const t = _t879[1];
        _t880 = ({_tag: 0, _name: "RRow", _val: [n, t, acc]});
        break _t881;
      }
      _match_fail("line 15950");
    }
    return _t880;
  }
  return List$fold_right(_t878, fields, ({_tag: 2, _name: "REmpty"}));
}
function Types$record_row_to_fields(row) {
  function collect(r) {
    let _t883;
    const _t882 = Types$rrow_repr(r);
    _t884: {
      if (_t882._tag === 0) {
        const n = _t882._val[0];
        const t = _t882._val[1];
        const tail = _t882._val[2];
        _t883 = ({_hd: [n, t], _tl: collect(tail)});
        break _t884;
      }
      if (true) {
        _t883 = null;
        break _t884;
      }
      _match_fail("line 15950");
    }
    return _t883;
  }
  const _t885 = collect(row);
  return _t885;
}
const Types$empty_type_env = ({classes: null, constructors: null, effects: null, instances: null, modules: null, mutable_fields: null, records: null, type_aliases: null, type_synonyms: null, variants: null});
function Types$find_effect_op(type_env, op_name) {
  function _t886(edef) {
    function _t887(__p13) {
      let _t889;
      const _t888 = __p13;
      _t890: {
        if (true) {
          const name = _t888[0];
          const ty = _t888[1];
          let _t891;
          if ((name === op_name)) {
            _t891 = ({_tag: 1, _name: "Some", _val: [edef.effect_name, ty]});
          } else {
            _t891 = ({_tag: 0, _name: "None"});
          }
          _t889 = _t891;
          break _t890;
        }
        _match_fail("line 15950");
      }
      return _t889;
    }
    return List$find_map(_t887, edef.effect_ops);
  }
  return List$find_map(_t886, type_env.effects);
}
function Types$ty_to_str(__x) {
  let _t893;
  const _t892 = __x;
  _t894: {
    if (_t892._tag === 0) {
      _t893 = "int";
      break _t894;
    }
    if (_t892._tag === 1) {
      _t893 = "float";
      break _t894;
    }
    if (_t892._tag === 2) {
      _t893 = "bool";
      break _t894;
    }
    if (_t892._tag === 3) {
      _t893 = "string";
      break _t894;
    }
    if (_t892._tag === 4) {
      _t893 = "byte";
      break _t894;
    }
    if (_t892._tag === 5) {
      _t893 = "rune";
      break _t894;
    }
    if (_t892._tag === 6) {
      _t893 = "unit";
      break _t894;
    }
    if (_t892._tag === 12 && _t892._val[1] === null) {
      const name = _t892._val[0];
      _t893 = name;
      break _t894;
    }
    if (_t892._tag === 12) {
      const name = _t892._val[0];
      const args = _t892._val[1];
      _t893 = (String$concat("_", List$map(Types$ty_to_str, args)) + ("_" + name));
      break _t894;
    }
    if (_t892._tag === 10) {
      const t = _t892._val;
      _t893 = (Types$ty_to_str(t) + "_list");
      break _t894;
    }
    if (_t892._tag === 13) {
      const k = _t892._val[0];
      const v = _t892._val[1];
      _t893 = (Types$ty_to_str(k) + ("_" + (Types$ty_to_str(v) + "_map")));
      break _t894;
    }
    if (_t892._tag === 14) {
      const t = _t892._val;
      _t893 = (Types$ty_to_str(t) + "_array");
      break _t894;
    }
    if (_t892._tag === 9) {
      const ts = _t892._val;
      _t893 = (String$concat("_", List$map(Types$ty_to_str, ts)) + "_tup");
      break _t894;
    }
    if (_t892._tag === 15) {
      _t893 = "polyvar";
      break _t894;
    }
    if (_t892._tag === 17) {
      const i = _t892._val;
      _t893 = ("g" + __dict_Show_int.show(i));
      break _t894;
    }
    if ((_t892._tag === 7 || _t892._tag === 8)) {
      _t893 = "arrow";
      break _t894;
    }
    if (_t892._tag === 16) {
      _t893 = "tvar";
      break _t894;
    }
    if (true) {
      _t893 = "ty_other";
      break _t894;
    }
    _match_fail("line 15950");
  }
  return _t893;
}
function Types$dict_name(__dict_Show_0, class_name, tys) {
  const ty_strs_895 = List$map(Types$ty_to_str, tys);
  const _t896 = ((("__dict_" + __dict_Show_0.show(class_name)) + "_") + __dict_Show_string.show(String$concat("__", ty_strs_895)));
  return _t896;
}
function Types$find_method_class(classes, method_name) {
  function _t897(cls) {
    function _t898(__p14) {
      let _t900;
      const _t899 = __p14;
      _t901: {
        if (true) {
          const m = _t899[0];
          _t900 = (m === method_name);
          break _t901;
        }
        _match_fail("line 15950");
      }
      return _t900;
    }
    return List$exists(_t898, cls.class_methods);
  }
  return List$find(_t897, classes);
}
function Types$occurs_check(id, level, ty) {
  return _trampoline(function() {
    const _t902 = Types$repr(ty);
    let _t903 = false;
    if (!_t903 && _t902._tag === 16 && _t902._val.contents._tag === 0) {
      const id2 = _t902._val.contents._val[0];
      if ((id === id2)) {
        _t903 = true;
        return _h["unify_error"]("occurs check: infinite type", function(_t904) {
          return _bounce(function() {
            return _t904;
          });
        });
      }
    }
    if (!_t903 && _t902._tag === 16 && _t902._val.contents._tag === 0) {
      const id2 = _t902._val.contents._val[0];
      const level2 = _t902._val.contents._val[1];
      const r = _t902._val;
      _t903 = true;
      let _t905;
      if ((level2 > level)) {
        _t905 = Ref$set(r, ({_tag: 0, _name: "Unbound", _val: [id2, level]}));
      } else {
        _t905 = undefined;
      }
      return _t905;
    }
    if (!_t903 && _t902._tag === 16 && _t902._val.contents._tag === 1) {
      _t903 = true;
      return failwith("assert false");
    }
    if (!_t903 && (_t902._tag === 7 || _t902._tag === 8)) {
      const a = _t902._val[0];
      const eff = _t902._val[1];
      const b = _t902._val[2];
      _t903 = true;
      Types$occurs_check(id, level, a);
      Types$occurs_check_eff_for_ty(id, level, eff);
      return Types$occurs_check(id, level, b);
    }
    if (!_t903 && _t902._tag === 9) {
      const ts = _t902._val;
      _t903 = true;
      return List$iter(_call(Types$occurs_check, [id, level]), ts);
    }
    if (!_t903 && _t902._tag === 10) {
      const t = _t902._val;
      _t903 = true;
      return Types$occurs_check(id, level, t);
    }
    if (!_t903 && _t902._tag === 14) {
      const t = _t902._val;
      _t903 = true;
      return Types$occurs_check(id, level, t);
    }
    if (!_t903 && _t902._tag === 13) {
      const k = _t902._val[0];
      const v = _t902._val[1];
      _t903 = true;
      Types$occurs_check(id, level, k);
      return Types$occurs_check(id, level, v);
    }
    if (!_t903 && _t902._tag === 11) {
      const row = _t902._val;
      _t903 = true;
      return Types$occurs_check_rrow_for_ty(id, level, row);
    }
    if (!_t903 && _t902._tag === 12) {
      const args = _t902._val[1];
      _t903 = true;
      return List$iter(_call(Types$occurs_check, [id, level]), args);
    }
    if (!_t903 && _t902._tag === 15) {
      const row = _t902._val;
      _t903 = true;
      return Types$occurs_check_pv_for_ty(id, level, row);
    }
    if (!_t903 && (((((((_t902._tag === 0 || _t902._tag === 1) || _t902._tag === 2) || _t902._tag === 3) || _t902._tag === 4) || _t902._tag === 5) || _t902._tag === 6) || _t902._tag === 17)) {
      _t903 = true;
      return undefined;
    }
    if (!_t903) _match_fail("line 15950");
  }, Types$occurs_check);
}
function Types$occurs_check_pv_for_ty(id, level, row) {
  while (true) {
    let _t907;
    const _t906 = Types$pv_repr(row);
    _t908: {
      if (_t906._tag === 0) {
        const ty_opt = _t906._val[1];
        const tail = _t906._val[2];
        let _t910;
        const _t909 = ty_opt;
        _t911: {
          if (_t909._tag === 1) {
            const t = _t909._val;
            _t910 = Types$occurs_check(id, level, t);
            break _t911;
          }
          if (_t909._tag === 0) {
            _t910 = undefined;
            break _t911;
          }
          _match_fail("line 15950");
        }
        _t910;
        const _t912 = id;
        const _t913 = level;
        const _t914 = tail;
        id = _t912;
        level = _t913;
        row = _t914;
        continue;
        _t907 = undefined;
        break _t908;
      }
      if (true) {
        _t907 = undefined;
        break _t908;
      }
      _match_fail("line 15950");
    }
    return _t907;
  }
}
function Types$occurs_check_rrow_for_ty(id, level, row) {
  while (true) {
    let _t916;
    const _t915 = Types$rrow_repr(row);
    _t917: {
      if (_t915._tag === 0) {
        const ty = _t915._val[1];
        const tail = _t915._val[2];
        Types$occurs_check(id, level, ty);
        const _t918 = id;
        const _t919 = level;
        const _t920 = tail;
        id = _t918;
        level = _t919;
        row = _t920;
        continue;
        _t916 = undefined;
        break _t917;
      }
      if (true) {
        _t916 = undefined;
        break _t917;
      }
      _match_fail("line 15950");
    }
    return _t916;
  }
}
function Types$occurs_check_eff_for_ty(id, level, eff) {
  while (true) {
    let _t922;
    const _t921 = Types$eff_repr(eff);
    _t923: {
      if (_t921._tag === 2) {
        const params = _t921._val[1];
        const tail = _t921._val[2];
        List$iter(_call(Types$occurs_check, [id, level]), params);
        const _t924 = id;
        const _t925 = level;
        const _t926 = tail;
        id = _t924;
        level = _t925;
        eff = _t926;
        continue;
        _t922 = undefined;
        break _t923;
      }
      if (true) {
        _t922 = undefined;
        break _t923;
      }
      _match_fail("line 15950");
    }
    return _t922;
  }
}
function Types$occurs_check_eff(id, level, eff) {
  return _trampoline(function() {
    const _t927 = Types$eff_repr(eff);
    let _t928 = false;
    if (!_t928 && _t927._tag === 0 && _t927._val.contents._tag === 0) {
      const id2 = _t927._val.contents._val[0];
      if ((id === id2)) {
        _t928 = true;
        return _h["unify_error"]("occurs check: infinite effect row", function(_t929) {
          return _bounce(function() {
            return _t929;
          });
        });
      }
    }
    if (!_t928 && _t927._tag === 0 && _t927._val.contents._tag === 0) {
      const id2 = _t927._val.contents._val[0];
      const level2 = _t927._val.contents._val[1];
      const r = _t927._val;
      _t928 = true;
      let _t930;
      if ((level2 > level)) {
        _t930 = Ref$set(r, ({_tag: 0, _name: "EffUnbound", _val: [id2, level]}));
      } else {
        _t930 = undefined;
      }
      return _t930;
    }
    if (!_t928 && _t927._tag === 0 && _t927._val.contents._tag === 1) {
      _t928 = true;
      return failwith("assert false");
    }
    if (!_t928 && _t927._tag === 2) {
      const _params = _t927._val[1];
      const tail = _t927._val[2];
      _t928 = true;
      return Types$occurs_check_eff(id, level, tail);
    }
    if (!_t928 && (_t927._tag === 1 || _t927._tag === 3)) {
      _t928 = true;
      return undefined;
    }
    if (!_t928) _match_fail("line 15950");
  }, Types$occurs_check_eff);
}
function Types$occurs_check_pv(id, level, row) {
  return _trampoline(function() {
    const _t931 = Types$pv_repr(row);
    let _t932 = false;
    if (!_t932 && _t931._tag === 1 && _t931._val.contents._tag === 0) {
      const id2 = _t931._val.contents._val[0];
      if ((id === id2)) {
        _t932 = true;
        return _h["unify_error"]("occurs check: infinite polymorphic variant row", function(_t933) {
          return _bounce(function() {
            return _t933;
          });
        });
      }
    }
    if (!_t932 && _t931._tag === 1 && _t931._val.contents._tag === 0) {
      const id2 = _t931._val.contents._val[0];
      const level2 = _t931._val.contents._val[1];
      const r = _t931._val;
      _t932 = true;
      let _t934;
      if ((level2 > level)) {
        _t934 = Ref$set(r, ({_tag: 0, _name: "PVUnbound", _val: [id2, level]}));
      } else {
        _t934 = undefined;
      }
      return _t934;
    }
    if (!_t932 && _t931._tag === 1 && _t931._val.contents._tag === 1) {
      _t932 = true;
      return failwith("assert false");
    }
    if (!_t932 && _t931._tag === 0) {
      const ty_opt = _t931._val[1];
      const tail = _t931._val[2];
      _t932 = true;
      let _t936;
      const _t935 = ty_opt;
      _t937: {
        if (_t935._tag === 1) {
          const t = _t935._val;
          _t936 = Types$occurs_check(id, level, t);
          break _t937;
        }
        if (_t935._tag === 0) {
          _t936 = undefined;
          break _t937;
        }
        _match_fail("line 15950");
      }
      _t936;
      return Types$occurs_check_pv(id, level, tail);
    }
    if (!_t932 && (_t931._tag === 2 || _t931._tag === 3)) {
      _t932 = true;
      return undefined;
    }
    if (!_t932) _match_fail("line 15950");
  }, Types$occurs_check_pv);
}
function Types$occurs_check_rrow(id, level, row) {
  return _trampoline(function() {
    const _t938 = Types$rrow_repr(row);
    let _t939 = false;
    if (!_t939 && _t938._tag === 1 && _t938._val.contents._tag === 0) {
      const id2 = _t938._val.contents._val[0];
      if ((id === id2)) {
        _t939 = true;
        return _h["unify_error"]("occurs check: infinite record row", function(_t940) {
          return _bounce(function() {
            return _t940;
          });
        });
      }
    }
    if (!_t939 && _t938._tag === 1 && _t938._val.contents._tag === 0) {
      const id2 = _t938._val.contents._val[0];
      const level2 = _t938._val.contents._val[1];
      const r = _t938._val;
      _t939 = true;
      let _t941;
      if ((level2 > level)) {
        _t941 = Ref$set(r, ({_tag: 0, _name: "RUnbound", _val: [id2, level]}));
      } else {
        _t941 = undefined;
      }
      return _t941;
    }
    if (!_t939 && _t938._tag === 1 && _t938._val.contents._tag === 1) {
      _t939 = true;
      return failwith("assert false");
    }
    if (!_t939 && _t938._tag === 0) {
      const ty = _t938._val[1];
      const tail = _t938._val[2];
      _t939 = true;
      Types$occurs_check(id, level, ty);
      return Types$occurs_check_rrow(id, level, tail);
    }
    if (!_t939 && ((_t938._tag === 2 || _t938._tag === 3) || _t938._tag === 4)) {
      _t939 = true;
      return undefined;
    }
    if (!_t939) _match_fail("line 15950");
  }, Types$occurs_check_rrow);
}
const Types$pp_synonyms = Ref$create(null);
function _t942(_) {
  return "?";
}
const Types$pp_ty_arg_ref = Ref$create(_t942);
function Types$try_match_synonym(ty) {
  const synonyms_943 = Ref$get(Types$pp_synonyms);
  let _t945;
  if (_eq(synonyms_943, null)) {
    _t945 = ({_tag: 0, _name: "None"});
  } else {
    function _t946(__p15) {
      let _t948;
      const _t947 = __p15;
      _t949: {
        if (true) {
          const name = _t947[0];
          const num_params = _t947[1];
          const pattern = _t947[2];
          const bindings_950 = Array$make(num_params, ({_tag: 0, _name: "None"}));
          function go(pat, actual) {
            while (true) {
              const actual_952 = Types$repr(actual);
              let _t955;
              const _t954 = [pat, actual_952];
              _t956: {
                if (_t954[0]._tag === 17) {
                  const i = _t954[0]._val;
                  if ((i < num_params)) {
                    let _t958;
                    const _t957 = Array$get(bindings_950, i);
                    _t959: {
                      if (_t957._tag === 0) {
                        Array$set(bindings_950, i, ({_tag: 1, _name: "Some", _val: actual_952}));
                        _t958 = true;
                        break _t959;
                      }
                      if (_t957._tag === 1) {
                        const prev = _t957._val;
                        _t958 = _eq(prev, actual_952);
                        break _t959;
                      }
                      _match_fail("line 15950");
                    }
                    _t955 = _t958;
                    break _t956;
                  }
                }
                if (((((((_t954[0]._tag === 0 && _t954[1]._tag === 0 || _t954[0]._tag === 1 && _t954[1]._tag === 1) || _t954[0]._tag === 2 && _t954[1]._tag === 2) || _t954[0]._tag === 3 && _t954[1]._tag === 3) || _t954[0]._tag === 6 && _t954[1]._tag === 6) || _t954[0]._tag === 4 && _t954[1]._tag === 4) || _t954[0]._tag === 5 && _t954[1]._tag === 5)) {
                  _t955 = true;
                  break _t956;
                }
                if ((_t954[0]._tag === 7 && _t954[1]._tag === 7 || _t954[0]._tag === 8 && _t954[1]._tag === 8)) {
                  const p1 = _t954[0]._val[0];
                  const _pe = _t954[0]._val[1];
                  const p2 = _t954[0]._val[2];
                  const a1 = _t954[1]._val[0];
                  const _ae = _t954[1]._val[1];
                  const a2 = _t954[1]._val[2];
                  _t955 = (go(p1, a1) && go(p2, a2));
                  break _t956;
                }
                if (_t954[0]._tag === 10 && _t954[1]._tag === 10) {
                  const p1 = _t954[0]._val;
                  const a1 = _t954[1]._val;
                  const _t960 = p1;
                  const _t961 = a1;
                  pat = _t960;
                  actual = _t961;
                  continue;
                  _t955 = undefined;
                  break _t956;
                }
                if (_t954[0]._tag === 14 && _t954[1]._tag === 14) {
                  const p1 = _t954[0]._val;
                  const a1 = _t954[1]._val;
                  const _t962 = p1;
                  const _t963 = a1;
                  pat = _t962;
                  actual = _t963;
                  continue;
                  _t955 = undefined;
                  break _t956;
                }
                if (_t954[0]._tag === 13 && _t954[1]._tag === 13) {
                  const pk = _t954[0]._val[0];
                  const pv = _t954[0]._val[1];
                  const ak = _t954[1]._val[0];
                  const av = _t954[1]._val[1];
                  _t955 = (go(pk, ak) && go(pv, av));
                  break _t956;
                }
                if (_t954[0]._tag === 9 && _t954[1]._tag === 9) {
                  const ps = _t954[0]._val;
                  const acts = _t954[1]._val;
                  if ((List$length(ps) === List$length(acts))) {
                    _t955 = List$forall2(go, ps, acts);
                    break _t956;
                  }
                }
                if (_t954[0]._tag === 12 && _t954[1]._tag === 12) {
                  const pn = _t954[0]._val[0];
                  const ps = _t954[0]._val[1];
                  const an = _t954[1]._val[0];
                  const acts = _t954[1]._val[1];
                  if (((pn === an) && (List$length(ps) === List$length(acts)))) {
                    _t955 = List$forall2(go, ps, acts);
                    break _t956;
                  }
                }
                if (_t954[0]._tag === 16 && _t954[1]._tag === 16) {
                  const r1 = _t954[0]._val;
                  const r2 = _t954[1]._val;
                  if (_eq(r1, r2)) {
                    _t955 = true;
                    break _t956;
                  }
                }
                if (_t954[0]._tag === 17 && _t954[1]._tag === 17) {
                  const i = _t954[0]._val;
                  const j = _t954[1]._val;
                  if ((i === j)) {
                    _t955 = true;
                    break _t956;
                  }
                }
                if (true) {
                  _t955 = false;
                  break _t956;
                }
                _match_fail("line 15950");
              }
              const _t953 = _t955;
              return _t953;
            }
          }
          let _t966;
          if (go(pattern, ty)) {
          function _t965(x) {
            return !_eq(x, ({_tag: 0, _name: "None"}));
          }
            _t966 = Array$forall(_t965, bindings_950);
          } else {
            _t966 = false;
          }
          let _t967;
          if (_t966) {
            function _t968(x) {
              return Option$unwrap(x);
            }
            _t967 = ({_tag: 1, _name: "Some", _val: [name, Array$to_list(Array$map(_t968, bindings_950))]});
          } else {
            _t967 = ({_tag: 0, _name: "None"});
          }
          const _t964 = _t967;
          const _t951 = _t964;
          _t948 = _t951;
          break _t949;
        }
        _match_fail("line 15950");
      }
      return _t948;
    }
    _t945 = List$find_map(_t946, synonyms_943);
  }
  const _t944 = _t945;
  return _t944;
}
function Types$pp_eff(eff) {
  let _t970;
  const _t969 = Types$eff_repr(eff);
  _t971: {
    if (_t969._tag === 1) {
      _t970 = "";
      break _t971;
    }
    if (_t969._tag === 0 && _t969._val.contents._tag === 0) {
      const id = _t969._val.contents._val[0];
      _t970 = ("'" + String$make(1, Byte$of_int((Byte$to_int(101) + (id % 22)))));
      break _t971;
    }
    if (_t969._tag === 2) {
      const label = _t969._val[0];
      const params = _t969._val[1];
      const tail = _t969._val[2];
      let _t973;
      const _t972 = params;
      _t974: {
        if (_t972 === null) {
          _t973 = "";
          break _t974;
        }
        if (true) {
          const ps = _t972;
          _t973 = (" " + String$concat(" ", List$map(_call(Ref$get, [Types$pp_ty_arg_ref]), ps)));
          break _t974;
        }
        _match_fail("line 15950");
      }
      const param_str_975 = _t973;
      let _t978;
      const _t977 = Types$eff_repr(tail);
      _t979: {
        if (_t977._tag === 1) {
          _t978 = "";
          break _t979;
        }
        if (_t977._tag === 0 && _t977._val.contents._tag === 0) {
          _t978 = (", " + Types$pp_eff(tail));
          break _t979;
        }
        if (_t977._tag === 2) {
          _t978 = (", " + Types$pp_eff(tail));
          break _t979;
        }
        if (true) {
          _t978 = "";
          break _t979;
        }
        _match_fail("line 15950");
      }
      const tail_str_980 = _t978;
      const _t981 = (label + (param_str_975 + tail_str_980));
      const _t976 = _t981;
      _t970 = _t976;
      break _t971;
    }
    if (_t969._tag === 3) {
      const id = _t969._val;
      _t970 = ("'" + String$make(1, Byte$of_int((Byte$to_int(101) + (id % 22)))));
      break _t971;
    }
    if (_t969._tag === 0 && _t969._val.contents._tag === 1) {
      _t970 = failwith("assert false");
      break _t971;
    }
    _match_fail("line 15950");
  }
  return _t970;
}
function Types$eff_is_trivial(eff) {
  let _t983;
  const _t982 = Types$eff_repr(eff);
  _t984: {
    if (_t982._tag === 1) {
      _t983 = true;
      break _t984;
    }
    if (_t982._tag === 0 && _t982._val.contents._tag === 0) {
      _t983 = true;
      break _t984;
    }
    if (_t982._tag === 3) {
      _t983 = true;
      break _t984;
    }
    if (true) {
      _t983 = false;
      break _t984;
    }
    _match_fail("line 15950");
  }
  return _t983;
}
function Types$pp_ty(ty) {
  const ty_985 = Types$repr(ty);
  let _t988;
  const _t987 = Types$try_match_synonym(ty_985);
  _t989: {
    if (_t987._tag === 1) {
      const name = _t987._val[0];
      const args = _t987._val[1];
      let _t991;
      const _t990 = ty_985;
      _t992: {
        if ((_t990._tag === 7 || _t990._tag === 8)) {
          const a = _t990._val[0];
          if (!_eq(Types$try_match_synonym(Types$repr(a)), ({_tag: 0, _name: "None"}))) {
            _t991 = Types$pp_ty_raw(ty_985);
            break _t992;
          }
        }
        if (true) {
          _t991 = Types$pp_type_con(name, args);
          break _t992;
        }
        _match_fail("line 15950");
      }
      _t988 = _t991;
      break _t989;
    }
    if (_t987._tag === 0) {
      _t988 = Types$pp_ty_raw(ty_985);
      break _t989;
    }
    _match_fail("line 15950");
  }
  const _t986 = _t988;
  return _t986;
}
function Types$pp_type_con(name, __x) {
  let _t994;
  const _t993 = __x;
  _t995: {
    if (_t993 === null) {
      _t994 = name;
      break _t995;
    }
    if (_t993 !== null && _t993._tl === null) {
      const arg = _t993._hd;
      let _t997;
      const _t996 = Types$repr(arg);
      _t998: {
        if (((_t996._tag === 7 || _t996._tag === 8) || _t996._tag === 9)) {
          _t997 = ("(" + (Types$pp_ty(arg) + ")"));
          break _t998;
        }
        if (true) {
          _t997 = Types$pp_ty(arg);
          break _t998;
        }
        _match_fail("line 15950");
      }
      _t994 = (_t997 + (" " + name));
      break _t995;
    }
    if (true) {
      const args = _t993;
      _t994 = ("(" + (String$concat(", ", List$map(Types$pp_ty, args)) + (") " + name)));
      break _t995;
    }
    _match_fail("line 15950");
  }
  return _t994;
}
function Types$needs_parens(ty) {
  const ty_999 = Types$repr(ty);
  let _t1002;
  const _t1001 = Types$try_match_synonym(ty_999);
  _t1003: {
    if (_t1001._tag === 1) {
      _t1002 = false;
      break _t1003;
    }
    if (_t1001._tag === 0) {
      let _t1005;
      const _t1004 = ty_999;
      _t1006: {
        if (((_t1004._tag === 7 || _t1004._tag === 8) || _t1004._tag === 9)) {
          _t1005 = true;
          break _t1006;
        }
        if (true) {
          _t1005 = false;
          break _t1006;
        }
        _match_fail("line 15950");
      }
      _t1002 = _t1005;
      break _t1003;
    }
    _match_fail("line 15950");
  }
  const _t1000 = _t1002;
  return _t1000;
}
function Types$pp_ty_arg(ty) {
  let _t1007;
  if (Types$needs_parens(ty)) {
    _t1007 = ("(" + (Types$pp_ty(ty) + ")"));
  } else {
    _t1007 = Types$pp_ty(ty);
  }
  return _t1007;
}
function Types$pp_ty_raw(ty) {
  let _t1009;
  const _t1008 = ty;
  _t1010: {
    if (_t1008._tag === 0) {
      _t1009 = "int";
      break _t1010;
    }
    if (_t1008._tag === 1) {
      _t1009 = "float";
      break _t1010;
    }
    if (_t1008._tag === 2) {
      _t1009 = "bool";
      break _t1010;
    }
    if (_t1008._tag === 3) {
      _t1009 = "string";
      break _t1010;
    }
    if (_t1008._tag === 4) {
      _t1009 = "byte";
      break _t1010;
    }
    if (_t1008._tag === 5) {
      _t1009 = "rune";
      break _t1010;
    }
    if (_t1008._tag === 6) {
      _t1009 = "unit";
      break _t1010;
    }
    if (_t1008._tag === 7) {
      const a = _t1008._val[0];
      const eff = _t1008._val[1];
      const r = _t1008._val[2];
      let _t1012;
      const _t1011 = Types$repr(a);
      _t1013: {
        if (_t1011._tag === 7) {
          if (_eq(Types$try_match_synonym(Types$repr(a)), ({_tag: 0, _name: "None"}))) {
            _t1012 = ("(" + (Types$pp_ty(a) + ")"));
            break _t1013;
          }
        }
        if (true) {
          _t1012 = Types$pp_ty(a);
          break _t1013;
        }
        _match_fail("line 15950");
      }
      const a_str_1014 = _t1012;
      let _t1016;
      if (Types$eff_is_trivial(eff)) {
        _t1016 = (a_str_1014 + (" -> " + Types$pp_ty(r)));
      } else {
        _t1016 = (a_str_1014 + (" -> " + (Types$pp_ty(r) + (" / " + Types$pp_eff(eff)))));
      }
      const _t1015 = _t1016;
      _t1009 = _t1015;
      break _t1010;
    }
    if (_t1008._tag === 8) {
      const a = _t1008._val[0];
      const eff = _t1008._val[1];
      const r = _t1008._val[2];
      let _t1018;
      const _t1017 = Types$repr(a);
      _t1019: {
        if ((_t1017._tag === 7 || _t1017._tag === 8)) {
          if (_eq(Types$try_match_synonym(Types$repr(a)), ({_tag: 0, _name: "None"}))) {
            _t1018 = ("(" + (Types$pp_ty(a) + ")"));
            break _t1019;
          }
        }
        if (true) {
          _t1018 = Types$pp_ty(a);
          break _t1019;
        }
        _match_fail("line 15950");
      }
      const a_str_1020 = _t1018;
      let _t1022;
      if (Types$eff_is_trivial(eff)) {
        _t1022 = (a_str_1020 + (" -> " + Types$pp_ty(r)));
      } else {
        _t1022 = (a_str_1020 + (" -> " + (Types$pp_ty(r) + (" / " + Types$pp_eff(eff)))));
      }
      const _t1021 = _t1022;
      const inner_1023 = _t1021;
      const _t1024 = ("continuation(" + (inner_1023 + ")"));
      _t1009 = _t1024;
      break _t1010;
    }
    if (_t1008._tag === 9) {
      const ts = _t1008._val;
      function _t1025(t) {
        let _t1027;
        const _t1026 = Types$repr(t);
        _t1028: {
          if ((_t1026._tag === 7 || _t1026._tag === 8)) {
            if (_eq(Types$try_match_synonym(Types$repr(t)), ({_tag: 0, _name: "None"}))) {
              _t1027 = ("(" + (Types$pp_ty(t) + ")"));
              break _t1028;
            }
          }
          if (true) {
            _t1027 = Types$pp_ty(t);
            break _t1028;
          }
          _match_fail("line 15950");
        }
        return _t1027;
      }
      _t1009 = String$concat(" * ", List$map(_t1025, ts));
      break _t1010;
    }
    if (_t1008._tag === 10) {
      const t = _t1008._val;
      _t1009 = (Types$pp_ty_arg(t) + " list");
      break _t1010;
    }
    if (_t1008._tag === 13) {
      const k = _t1008._val[0];
      const v = _t1008._val[1];
      _t1009 = ("(" + (Types$pp_ty(k) + (", " + (Types$pp_ty(v) + ") map"))));
      break _t1010;
    }
    if (_t1008._tag === 14) {
      const t = _t1008._val;
      _t1009 = (Types$pp_ty_arg(t) + " array");
      break _t1010;
    }
    if (_t1008._tag === 11) {
      const row = _t1008._val;
      function collect(r) {
        let _t1030;
        const _t1029 = Types$rrow_repr(r);
        _t1031: {
          if (_t1029._tag === 0) {
            const name = _t1029._val[0];
            const ty = _t1029._val[1];
            const tail = _t1029._val[2];
            _t1030 = ({_hd: [name, ty], _tl: collect(tail)});
            break _t1031;
          }
          if (true) {
            _t1030 = null;
            break _t1031;
          }
          _match_fail("line 15950");
        }
        return _t1030;
      }
      function is_open(r) {
        while (true) {
          let _t1034;
          const _t1033 = Types$rrow_repr(r);
          _t1035: {
            if (_t1033._tag === 0) {
              const tail = _t1033._val[2];
              const _t1036 = tail;
              r = _t1036;
              continue;
              _t1034 = undefined;
              break _t1035;
            }
            if (((_t1033._tag === 1 && _t1033._val.contents._tag === 0 || _t1033._tag === 3) || _t1033._tag === 4)) {
              _t1034 = true;
              break _t1035;
            }
            if (true) {
              _t1034 = false;
              break _t1035;
            }
            _match_fail("line 15950");
          }
          return _t1034;
        }
      }
      function _t1038(__p16) {
        let _t1040;
        const _t1039 = __p16;
        _t1041: {
          if (true) {
            const n = _t1039[0];
            const t = _t1039[1];
            _t1040 = (n + (": " + Types$pp_ty(t)));
            break _t1041;
          }
          _match_fail("line 15950");
        }
        return _t1040;
      }
      const fields_str_1042 = String$concat("; ", List$map(_t1038, collect(row)));
      let _t1044;
      if (is_open(row)) {
        let _t1045;
        if ((fields_str_1042 === "")) {
          _t1045 = "..";
        } else {
          _t1045 = "; ..";
        }
        _t1044 = ("{ " + (fields_str_1042 + (_t1045 + " }")));
      } else {
        _t1044 = ("{ " + (fields_str_1042 + " }"));
      }
      const _t1043 = _t1044;
      const _t1037 = _t1043;
      const _t1032 = _t1037;
      _t1009 = _t1032;
      break _t1010;
    }
    if (_t1008._tag === 12 && _t1008._val[1] === null) {
      const name = _t1008._val[0];
      _t1009 = name;
      break _t1010;
    }
    if (_t1008._tag === 12 && _t1008._val[1] !== null && _t1008._val[1]._tl === null) {
      const name = _t1008._val[0];
      const arg = _t1008._val[1]._hd;
      _t1009 = (Types$pp_ty_arg(arg) + (" " + name));
      break _t1010;
    }
    if (_t1008._tag === 12) {
      const name = _t1008._val[0];
      const args = _t1008._val[1];
      _t1009 = ("(" + (String$concat(", ", List$map(Types$pp_ty, args)) + (") " + name)));
      break _t1010;
    }
    if (_t1008._tag === 15) {
      const row = _t1008._val;
      function collect_tags(r) {
        let _t1047;
        const _t1046 = Types$pv_repr(r);
        _t1048: {
          if (_t1046._tag === 0) {
            const tag = _t1046._val[0];
            const ty_opt = _t1046._val[1];
            const tail = _t1046._val[2];
            _t1047 = ({_hd: [tag, ty_opt], _tl: collect_tags(tail)});
            break _t1048;
          }
          if (true) {
            _t1047 = null;
            break _t1048;
          }
          _match_fail("line 15950");
        }
        return _t1047;
      }
      let _t1051;
      const _t1050 = Types$pv_repr(row);
      _t1052: {
        if (_t1050._tag === 1) {
          _t1051 = true;
          break _t1052;
        }
        if (_t1050._tag === 0) {
          function check(r) {
            while (true) {
              let _t1054;
              const _t1053 = Types$pv_repr(r);
              _t1055: {
                if (_t1053._tag === 0) {
                  const tail = _t1053._val[2];
                  const _t1056 = tail;
                  r = _t1056;
                  continue;
                  _t1054 = undefined;
                  break _t1055;
                }
                if (_t1053._tag === 1) {
                  _t1054 = true;
                  break _t1055;
                }
                if (true) {
                  _t1054 = false;
                  break _t1055;
                }
                _match_fail("line 15950");
              }
              return _t1054;
            }
          }
          const _t1057 = check(row);
          _t1051 = _t1057;
          break _t1052;
        }
        if (true) {
          _t1051 = false;
          break _t1052;
        }
        _match_fail("line 15950");
      }
      const is_open_1058 = _t1051;
      const tags_1060 = collect_tags(row);
      function _t1062(__p17) {
        let _t1064;
        const _t1063 = __p17;
        _t1065: {
          if (true) {
            const tag = _t1063[0];
            const ty_opt = _t1063[1];
            let _t1067;
            const _t1066 = ty_opt;
            _t1068: {
              if (_t1066._tag === 0) {
                _t1067 = ("`" + tag);
                break _t1068;
              }
              if (_t1066._tag === 1) {
                const t = _t1066._val;
                _t1067 = ("`" + (tag + (" of " + Types$pp_ty(t))));
                break _t1068;
              }
              _match_fail("line 15950");
            }
            _t1064 = _t1067;
            break _t1065;
          }
          _match_fail("line 15950");
        }
        return _t1064;
      }
      const tag_strs_1069 = List$map(_t1062, tags_1060);
      let _t1071;
      if (is_open_1058) {
        _t1071 = "> ";
      } else {
        _t1071 = "";
      }
      const marker_1072 = _t1071;
      const _t1073 = ("[" + (marker_1072 + (String$concat(" | ", tag_strs_1069) + "]")));
      const _t1070 = _t1073;
      const _t1061 = _t1070;
      const _t1059 = _t1061;
      const _t1049 = _t1059;
      _t1009 = _t1049;
      break _t1010;
    }
    if (_t1008._tag === 16 && _t1008._val.contents._tag === 0) {
      const id = _t1008._val.contents._val[0];
      _t1009 = ("'" + String$make(1, Byte$of_int((Byte$to_int(97) + (id % 26)))));
      break _t1010;
    }
    if (_t1008._tag === 16 && _t1008._val.contents._tag === 1) {
      _t1009 = failwith("assert false");
      break _t1010;
    }
    if (_t1008._tag === 17) {
      const id = _t1008._val;
      _t1009 = ("'" + String$make(1, Byte$of_int((Byte$to_int(97) + (id % 26)))));
      break _t1010;
    }
    _match_fail("line 15950");
  }
  return _t1009;
}
const Types$__destruct = Ref$set(Types$pp_ty_arg_ref, Types$pp_ty_arg);
function Types$unify_error(t1, t2) {
  return _trampoline(function() {
    return _h["unify_error"](((("cannot unify " + __dict_Show_string.show(Types$pp_ty(t1))) + " with ") + __dict_Show_string.show(Types$pp_ty(t2))), function(_t1074) {
      return _bounce(function() {
        return _t1074;
      });
    });
  }, Types$unify_error);
}
function Types$unify_eff(e1, e2) {
  return _trampoline(function() {
    const e1_1075 = Types$eff_repr(e1);
    const e2_1076 = Types$eff_repr(e2);
    if (_eq(e1_1075, e2_1076)) {
      return undefined;
    } else {
      const _t1077 = [e1_1075, e2_1076];
      let _t1078 = false;
      if (!_t1078 && (_t1077[0]._tag === 0 && _t1077[0]._val.contents._tag === 0 || _t1077[1]._tag === 0 && _t1077[1]._val.contents._tag === 0)) {
        const id = (_t1077[0]._tag === 0 && _t1077[0]._val.contents._tag === 0 ? _t1077[0]._val.contents._val[0] : _t1077[1]._val.contents._val[0]);
        const level = (_t1077[0]._tag === 0 && _t1077[0]._val.contents._tag === 0 ? _t1077[0]._val.contents._val[1] : _t1077[1]._val.contents._val[1]);
        const r = (_t1077[0]._tag === 0 && _t1077[0]._val.contents._tag === 0 ? _t1077[0]._val : _t1077[1]._val);
        const eff = (_t1077[0]._tag === 0 && _t1077[0]._val.contents._tag === 0 ? _t1077[1] : _t1077[0]);
        _t1078 = true;
        Types$occurs_check_eff(id, level, eff);
        return Ref$set(r, ({_tag: 1, _name: "EffLink", _val: eff}));
      }
      if (!_t1078 && _t1077[0]._tag === 1 && _t1077[1]._tag === 1) {
        _t1078 = true;
        return undefined;
      }
      if (!_t1078 && _t1077[0]._tag === 2 && _t1077[1]._tag === 2) {
        const label1 = _t1077[0]._val[0];
        const params1 = _t1077[0]._val[1];
        const tail1 = _t1077[0]._val[2];
        const label2 = _t1077[1]._val[0];
        const params2 = _t1077[1]._val[1];
        const tail2 = _t1077[1]._val[2];
        if (((label1 === label2) && (List$length(params1) === List$length(params2)))) {
          _t1078 = true;
          List$iter2(Types$unify, params1, params2);
          return Types$unify_eff(tail1, tail2);
        }
      }
      if (!_t1078 && _t1077[0]._tag === 2) {
        const label1 = _t1077[0]._val[0];
        const params1 = _t1077[0]._val[1];
        const tail1 = _t1077[0]._val[2];
        _t1078 = true;
        const tail2_1079 = Types$rewrite_row(label1, params1, e2_1076);
        const _t1080 = Types$unify_eff(tail1, tail2_1079);
        return _t1080;
      }
      if (!_t1078 && _t1077[1]._tag === 2) {
        _t1078 = true;
        return Types$unify_eff(e2_1076, e1_1075);
      }
      if (!_t1078 && _t1077[0]._tag === 3 && _t1077[1]._tag === 3) {
        const i = _t1077[0]._val;
        const j = _t1077[1]._val;
        if ((i === j)) {
          _t1078 = true;
          return undefined;
        }
      }
      if (!_t1078 && true) {
        _t1078 = true;
        return _h["unify_error"](((("cannot unify effects " + __dict_Show_string.show(Types$pp_eff(e1_1075))) + " and ") + __dict_Show_string.show(Types$pp_eff(e2_1076))), function(_t1081) {
          return _bounce(function() {
            return _t1081;
          });
        });
      }
      if (!_t1078) _match_fail("line 15950");
    }
  }, Types$unify_eff);
}
function Types$rewrite_row(label, params_to_unify, eff) {
  return _trampoline(function() {
    const _t1082 = Types$eff_repr(eff);
    let _t1083 = false;
    if (!_t1083 && _t1082._tag === 2) {
      const l = _t1082._val[0];
      const found_params = _t1082._val[1];
      const tail = _t1082._val[2];
      if ((l === label)) {
        _t1083 = true;
        let _t1084;
        if ((List$length(params_to_unify) === List$length(found_params))) {
          _t1084 = List$iter2(Types$unify, params_to_unify, found_params);
        } else {
          _t1084 = undefined;
        }
        _t1084;
        return tail;
      }
    }
    if (!_t1083 && _t1082._tag === 2) {
      const l = _t1082._val[0];
      const params = _t1082._val[1];
      const tail = _t1082._val[2];
      _t1083 = true;
      return ({_tag: 2, _name: "EffRow", _val: [l, params, Types$rewrite_row(label, params_to_unify, tail)]});
    }
    if (!_t1083 && _t1082._tag === 0 && _t1082._val.contents._tag === 0) {
      const id = _t1082._val.contents._val[0];
      const level = _t1082._val.contents._val[1];
      const r = _t1082._val;
      _t1083 = true;
      const new_tail_1085 = Types$new_effvar(level);
      const new_row_1087 = ({_tag: 2, _name: "EffRow", _val: [label, params_to_unify, new_tail_1085]});
      Types$occurs_check_eff(id, level, new_row_1087);
      Ref$set(r, ({_tag: 1, _name: "EffLink", _val: new_row_1087}));
      const _t1088 = new_tail_1085;
      const _t1086 = _t1088;
      return _t1086;
    }
    if (!_t1083 && _t1082._tag === 1) {
      _t1083 = true;
      return _h["unify_error"]((("effect " + __dict_Show_string.show(label)) + " not handled"), function(_t1089) {
        return _bounce(function() {
          return _t1089;
        });
      });
    }
    if (!_t1083 && true) {
      _t1083 = true;
      return _h["unify_error"](("cannot rewrite effect row for " + __dict_Show_string.show(label)), function(_t1090) {
        return _bounce(function() {
          return _t1090;
        });
      });
    }
    if (!_t1083) _match_fail("line 15950");
  }, Types$rewrite_row);
}
function Types$subeffect(source, target) {
  while (true) {
    const source_1091 = Types$eff_repr(source);
    const target_1093 = Types$eff_repr(target);
    let _t1095;
    if (_eq(source_1091, target_1093)) {
      _t1095 = undefined;
    } else {
      let _t1097;
      const _t1096 = source_1091;
      _t1098: {
        if (_t1096._tag === 1) {
          _t1097 = undefined;
          break _t1098;
        }
        if (_t1096._tag === 0 && _t1096._val.contents._tag === 0) {
          _t1097 = Types$unify_eff(source_1091, target_1093);
          break _t1098;
        }
        if (_t1096._tag === 2) {
          const label = _t1096._val[0];
          const params = _t1096._val[1];
          const tail = _t1096._val[2];
          const target_tail_1099 = Types$rewrite_row(label, params, target_1093);
          const _t1101 = Types$eff_repr(tail);
          const _t1102 = target_tail_1099;
          source = _t1101;
          target = _t1102;
          continue;
          const _t1100 = undefined;
          _t1097 = _t1100;
          break _t1098;
        }
        if (_t1096._tag === 3) {
          _t1097 = undefined;
          break _t1098;
        }
        if (true) {
          _t1097 = Types$unify_eff(source_1091, target_1093);
          break _t1098;
        }
        _match_fail("line 15950");
      }
      _t1095 = _t1097;
    }
    const _t1094 = _t1095;
    const _t1092 = _t1094;
    return _t1092;
  }
}
function Types$unify_pv_row(r1, r2) {
  return _trampoline(function() {
    const r1_1103 = Types$pv_repr(r1);
    const r2_1104 = Types$pv_repr(r2);
    if (_eq(r1_1103, r2_1104)) {
      return undefined;
    } else {
      const _t1105 = [r1_1103, r2_1104];
      let _t1106 = false;
      if (!_t1106 && (_t1105[0]._tag === 1 && _t1105[0]._val.contents._tag === 0 || _t1105[1]._tag === 1 && _t1105[1]._val.contents._tag === 0)) {
        const id = (_t1105[0]._tag === 1 && _t1105[0]._val.contents._tag === 0 ? _t1105[0]._val.contents._val[0] : _t1105[1]._val.contents._val[0]);
        const level = (_t1105[0]._tag === 1 && _t1105[0]._val.contents._tag === 0 ? _t1105[0]._val.contents._val[1] : _t1105[1]._val.contents._val[1]);
        const r = (_t1105[0]._tag === 1 && _t1105[0]._val.contents._tag === 0 ? _t1105[0]._val : _t1105[1]._val);
        const row = (_t1105[0]._tag === 1 && _t1105[0]._val.contents._tag === 0 ? _t1105[1] : _t1105[0]);
        _t1106 = true;
        Types$occurs_check_pv(id, level, row);
        return Ref$set(r, ({_tag: 1, _name: "PVLink", _val: row}));
      }
      if (!_t1106 && _t1105[0]._tag === 2 && _t1105[1]._tag === 2) {
        _t1106 = true;
        return undefined;
      }
      if (!_t1106 && _t1105[0]._tag === 0 && _t1105[1]._tag === 0) {
        const tag1 = _t1105[0]._val[0];
        const ty1 = _t1105[0]._val[1];
        const tail1 = _t1105[0]._val[2];
        const tag2 = _t1105[1]._val[0];
        const ty2 = _t1105[1]._val[1];
        const tail2 = _t1105[1]._val[2];
        if ((tag1 === tag2)) {
          _t1106 = true;
          Types$unify_pv_payload(ty1, ty2);
          return Types$unify_pv_row(tail1, tail2);
        }
      }
      if (!_t1106 && _t1105[0]._tag === 0) {
        const tag1 = _t1105[0]._val[0];
        const ty1 = _t1105[0]._val[1];
        const tail1 = _t1105[0]._val[2];
        _t1106 = true;
        let _t1108;
        const _t1107 = Types$rewrite_pv_row(tag1, ty1, r2_1104);
        _t1109: {
          if (true) {
            const ty2 = _t1107[0];
            const tail2 = _t1107[1];
            Types$unify_pv_payload(ty1, ty2);
            _t1108 = Types$unify_pv_row(tail1, tail2);
            break _t1109;
          }
          _match_fail("line 15950");
        }
        return _t1108;
      }
      if (!_t1106 && _t1105[1]._tag === 0) {
        _t1106 = true;
        return Types$unify_pv_row(r2_1104, r1_1103);
      }
      if (!_t1106 && _t1105[0]._tag === 3 && _t1105[1]._tag === 3) {
        const i = _t1105[0]._val;
        const j = _t1105[1]._val;
        if ((i === j)) {
          _t1106 = true;
          return undefined;
        }
      }
      if (!_t1106 && true) {
        _t1106 = true;
        return _h["unify_error"]("cannot unify polymorphic variant types", function(_t1110) {
          return _bounce(function() {
            return _t1110;
          });
        });
      }
      if (!_t1106) _match_fail("line 15950");
    }
  }, Types$unify_pv_row);
}
function Types$unify_pv_payload(ty1, ty2) {
  return _trampoline(function() {
    const _t1111 = [ty1, ty2];
    let _t1112 = false;
    if (!_t1112 && _t1111[0]._tag === 0 && _t1111[1]._tag === 0) {
      _t1112 = true;
      return undefined;
    }
    if (!_t1112 && _t1111[0]._tag === 1 && _t1111[1]._tag === 1) {
      const t1 = _t1111[0]._val;
      const t2 = _t1111[1]._val;
      _t1112 = true;
      return Types$unify(t1, t2);
    }
    if (!_t1112 && true) {
      _t1112 = true;
      return _h["unify_error"]("polymorphic variant payload mismatch", function(_t1113) {
        return _bounce(function() {
          return _t1113;
        });
      });
    }
    if (!_t1112) _match_fail("line 15950");
  }, Types$unify_pv_payload);
}
function Types$rewrite_pv_row(tag, default_payload, row) {
  return _trampoline(function() {
    const _t1114 = Types$pv_repr(row);
    let _t1115 = false;
    if (!_t1115 && _t1114._tag === 0) {
      const t = _t1114._val[0];
      const ty_opt = _t1114._val[1];
      const tail = _t1114._val[2];
      if ((t === tag)) {
        _t1115 = true;
        return [ty_opt, tail];
      }
    }
    if (!_t1115 && _t1114._tag === 0) {
      const t = _t1114._val[0];
      const ty_opt = _t1114._val[1];
      const tail = _t1114._val[2];
      _t1115 = true;
      let _t1117;
      const _t1116 = Types$rewrite_pv_row(tag, default_payload, tail);
      _t1118: {
        if (true) {
          const found = _t1116[0];
          const rest = _t1116[1];
          _t1117 = [found, ({_tag: 0, _name: "PVRow", _val: [t, ty_opt, rest]})];
          break _t1118;
        }
        _match_fail("line 15950");
      }
      return _t1117;
    }
    if (!_t1115 && _t1114._tag === 1 && _t1114._val.contents._tag === 0) {
      const id = _t1114._val.contents._val[0];
      const level = _t1114._val.contents._val[1];
      const r = _t1114._val;
      _t1115 = true;
      const new_tail_1119 = Types$new_pvvar(level);
      const new_row_1121 = ({_tag: 0, _name: "PVRow", _val: [tag, default_payload, new_tail_1119]});
      Types$occurs_check_pv(id, level, new_row_1121);
      Ref$set(r, ({_tag: 1, _name: "PVLink", _val: new_row_1121}));
      const _t1122 = [default_payload, new_tail_1119];
      const _t1120 = _t1122;
      return _t1120;
    }
    if (!_t1115 && _t1114._tag === 2) {
      _t1115 = true;
      return _h["unify_error"]((("tag `" + __dict_Show_string.show(tag)) + " not in closed polymorphic variant type"), function(_t1123) {
        return _bounce(function() {
          return _t1123;
        });
      });
    }
    if (!_t1115 && true) {
      _t1115 = true;
      return _h["unify_error"](("cannot rewrite polymorphic variant row for `" + __dict_Show_string.show(tag)), function(_t1124) {
        return _bounce(function() {
          return _t1124;
        });
      });
    }
    if (!_t1115) _match_fail("line 15950");
  }, Types$rewrite_pv_row);
}
function Types$unify_record_row(r1, r2) {
  return _trampoline(function() {
    const r1_1125 = Types$rrow_repr(r1);
    const r2_1126 = Types$rrow_repr(r2);
    if (_eq(r1_1125, r2_1126)) {
      return undefined;
    } else {
      const _t1127 = [r1_1125, r2_1126];
      let _t1128 = false;
      if (!_t1128 && (_t1127[0]._tag === 1 && _t1127[0]._val.contents._tag === 0 || _t1127[1]._tag === 1 && _t1127[1]._val.contents._tag === 0)) {
        const id = (_t1127[0]._tag === 1 && _t1127[0]._val.contents._tag === 0 ? _t1127[0]._val.contents._val[0] : _t1127[1]._val.contents._val[0]);
        const level = (_t1127[0]._tag === 1 && _t1127[0]._val.contents._tag === 0 ? _t1127[0]._val.contents._val[1] : _t1127[1]._val.contents._val[1]);
        const r = (_t1127[0]._tag === 1 && _t1127[0]._val.contents._tag === 0 ? _t1127[0]._val : _t1127[1]._val);
        const row = (_t1127[0]._tag === 1 && _t1127[0]._val.contents._tag === 0 ? _t1127[1] : _t1127[0]);
        _t1128 = true;
        Types$occurs_check_rrow(id, level, row);
        return Ref$set(r, ({_tag: 1, _name: "RLink", _val: row}));
      }
      if (!_t1128 && (_t1127[0]._tag === 4 || _t1127[1]._tag === 4)) {
        _t1128 = true;
        return undefined;
      }
      if (!_t1128 && _t1127[0]._tag === 2 && _t1127[1]._tag === 2) {
        _t1128 = true;
        return undefined;
      }
      if (!_t1128 && _t1127[0]._tag === 0 && _t1127[1]._tag === 0) {
        const f1 = _t1127[0]._val[0];
        const ty1 = _t1127[0]._val[1];
        const tail1 = _t1127[0]._val[2];
        const f2 = _t1127[1]._val[0];
        const ty2 = _t1127[1]._val[1];
        const tail2 = _t1127[1]._val[2];
        if ((f1 === f2)) {
          _t1128 = true;
          Types$unify(ty1, ty2);
          return Types$unify_record_row(tail1, tail2);
        }
      }
      if (!_t1128 && _t1127[0]._tag === 0) {
        const f1 = _t1127[0]._val[0];
        const ty1 = _t1127[0]._val[1];
        const tail1 = _t1127[0]._val[2];
        _t1128 = true;
        let _t1130;
        const _t1129 = Types$rewrite_record_row(f1, r2_1126);
        _t1131: {
          if (true) {
            const ty2 = _t1129[0];
            const tail2 = _t1129[1];
            Types$unify(ty1, ty2);
            _t1130 = Types$unify_record_row(tail1, tail2);
            break _t1131;
          }
          _match_fail("line 15950");
        }
        return _t1130;
      }
      if (!_t1128 && _t1127[1]._tag === 0) {
        _t1128 = true;
        return Types$unify_record_row(r2_1126, r1_1125);
      }
      if (!_t1128 && _t1127[0]._tag === 3 && _t1127[1]._tag === 3) {
        const i = _t1127[0]._val;
        const j = _t1127[1]._val;
        if ((i === j)) {
          _t1128 = true;
          return undefined;
        }
      }
      if (!_t1128 && true) {
        _t1128 = true;
        return _h["unify_error"]("cannot unify record types", function(_t1132) {
          return _bounce(function() {
            return _t1132;
          });
        });
      }
      if (!_t1128) _match_fail("line 15950");
    }
  }, Types$unify_record_row);
}
function Types$rewrite_record_row(field, row) {
  return _trampoline(function() {
    const _t1133 = Types$rrow_repr(row);
    let _t1134 = false;
    if (!_t1134 && _t1133._tag === 0) {
      const f = _t1133._val[0];
      const ty = _t1133._val[1];
      const tail = _t1133._val[2];
      if ((f === field)) {
        _t1134 = true;
        return [ty, tail];
      }
    }
    if (!_t1134 && _t1133._tag === 0) {
      const f = _t1133._val[0];
      const ty = _t1133._val[1];
      const tail = _t1133._val[2];
      _t1134 = true;
      let _t1136;
      const _t1135 = Types$rewrite_record_row(field, tail);
      _t1137: {
        if (true) {
          const found = _t1135[0];
          const rest = _t1135[1];
          _t1136 = [found, ({_tag: 0, _name: "RRow", _val: [f, ty, rest]})];
          break _t1137;
        }
        _match_fail("line 15950");
      }
      return _t1136;
    }
    if (!_t1134 && _t1133._tag === 1 && _t1133._val.contents._tag === 0) {
      const id = _t1133._val.contents._val[0];
      const level = _t1133._val.contents._val[1];
      const r = _t1133._val;
      _t1134 = true;
      const new_tail_1138 = Types$new_rvar(level);
      const field_ty_1140 = Types$new_tvar(level);
      const new_row_1142 = ({_tag: 0, _name: "RRow", _val: [field, field_ty_1140, new_tail_1138]});
      Types$occurs_check_rrow(id, level, new_row_1142);
      Ref$set(r, ({_tag: 1, _name: "RLink", _val: new_row_1142}));
      const _t1143 = [field_ty_1140, new_tail_1138];
      const _t1141 = _t1143;
      const _t1139 = _t1141;
      return _t1139;
    }
    if (!_t1134 && _t1133._tag === 4) {
      _t1134 = true;
      const field_ty_1144 = Types$new_tvar(0);
      const _t1145 = [field_ty_1144, ({_tag: 4, _name: "RWild"})];
      return _t1145;
    }
    if (!_t1134 && _t1133._tag === 2) {
      _t1134 = true;
      return _h["unify_error"](("record has no field " + __dict_Show_string.show(field)), function(_t1146) {
        return _bounce(function() {
          return _t1146;
        });
      });
    }
    if (!_t1134 && true) {
      _t1134 = true;
      return _h["unify_error"](("cannot rewrite record row for " + __dict_Show_string.show(field)), function(_t1147) {
        return _bounce(function() {
          return _t1147;
        });
      });
    }
    if (!_t1134) _match_fail("line 15950");
  }, Types$rewrite_record_row);
}
function Types$unify(t1, t2) {
  while (true) {
    const t1_1148 = Types$repr(t1);
    const t2_1150 = Types$repr(t2);
    let _t1152;
    if (_eq(t1_1148, t2_1150)) {
      _t1152 = undefined;
    } else {
      let _t1154;
      const _t1153 = [t1_1148, t2_1150];
      _t1155: {
        if ((_t1153[0]._tag === 16 && _t1153[0]._val.contents._tag === 0 || _t1153[1]._tag === 16 && _t1153[1]._val.contents._tag === 0)) {
          const id = (_t1153[0]._tag === 16 && _t1153[0]._val.contents._tag === 0 ? _t1153[0]._val.contents._val[0] : _t1153[1]._val.contents._val[0]);
          const level = (_t1153[0]._tag === 16 && _t1153[0]._val.contents._tag === 0 ? _t1153[0]._val.contents._val[1] : _t1153[1]._val.contents._val[1]);
          const r = (_t1153[0]._tag === 16 && _t1153[0]._val.contents._tag === 0 ? _t1153[0]._val : _t1153[1]._val);
          const ty = (_t1153[0]._tag === 16 && _t1153[0]._val.contents._tag === 0 ? _t1153[1] : _t1153[0]);
          Types$occurs_check(id, level, ty);
          _t1154 = Ref$set(r, ({_tag: 1, _name: "Link", _val: ty}));
          break _t1155;
        }
        if ((_t1153[0]._tag === 7 && _t1153[1]._tag === 7 || _t1153[0]._tag === 8 && _t1153[1]._tag === 8)) {
          const a1 = _t1153[0]._val[0];
          const e1 = _t1153[0]._val[1];
          const r1 = _t1153[0]._val[2];
          const a2 = _t1153[1]._val[0];
          const e2 = _t1153[1]._val[1];
          const r2 = _t1153[1]._val[2];
          Types$unify(a1, a2);
          Types$unify_eff(e1, e2);
          const _t1156 = r1;
          const _t1157 = r2;
          t1 = _t1156;
          t2 = _t1157;
          continue;
          _t1154 = undefined;
          break _t1155;
        }
        if (_t1153[0]._tag === 9 && _t1153[1]._tag === 9) {
          const ts1 = _t1153[0]._val;
          const ts2 = _t1153[1]._val;
          let _t1158;
          if ((List$length(ts1) !== List$length(ts2))) {
            _t1158 = Types$unify_error(t1_1148, t2_1150);
          } else {
            _t1158 = undefined;
          }
          _t1158;
          _t1154 = List$iter2(Types$unify, ts1, ts2);
          break _t1155;
        }
        if (_t1153[0]._tag === 10 && _t1153[1]._tag === 10) {
          const t1$p = _t1153[0]._val;
          const t2$p = _t1153[1]._val;
          const _t1159 = t1$p;
          const _t1160 = t2$p;
          t1 = _t1159;
          t2 = _t1160;
          continue;
          _t1154 = undefined;
          break _t1155;
        }
        if (_t1153[0]._tag === 14 && _t1153[1]._tag === 14) {
          const t1$p = _t1153[0]._val;
          const t2$p = _t1153[1]._val;
          const _t1161 = t1$p;
          const _t1162 = t2$p;
          t1 = _t1161;
          t2 = _t1162;
          continue;
          _t1154 = undefined;
          break _t1155;
        }
        if (_t1153[0]._tag === 13 && _t1153[1]._tag === 13) {
          const k1 = _t1153[0]._val[0];
          const v1 = _t1153[0]._val[1];
          const k2 = _t1153[1]._val[0];
          const v2 = _t1153[1]._val[1];
          Types$unify(k1, k2);
          const _t1163 = v1;
          const _t1164 = v2;
          t1 = _t1163;
          t2 = _t1164;
          continue;
          _t1154 = undefined;
          break _t1155;
        }
        if (_t1153[0]._tag === 11 && _t1153[1]._tag === 11) {
          const r1 = _t1153[0]._val;
          const r2 = _t1153[1]._val;
          _t1154 = Types$unify_record_row(r1, r2);
          break _t1155;
        }
        if (((((((_t1153[0]._tag === 0 && _t1153[1]._tag === 0 || _t1153[0]._tag === 1 && _t1153[1]._tag === 1) || _t1153[0]._tag === 2 && _t1153[1]._tag === 2) || _t1153[0]._tag === 3 && _t1153[1]._tag === 3) || _t1153[0]._tag === 4 && _t1153[1]._tag === 4) || _t1153[0]._tag === 5 && _t1153[1]._tag === 5) || _t1153[0]._tag === 6 && _t1153[1]._tag === 6)) {
          _t1154 = undefined;
          break _t1155;
        }
        if (_t1153[0]._tag === 12 && _t1153[1]._tag === 12) {
          const a = _t1153[0]._val[0];
          const args_a = _t1153[0]._val[1];
          const b = _t1153[1]._val[0];
          const args_b = _t1153[1]._val[1];
          if ((a === b)) {
            let _t1165;
            if ((List$length(args_a) !== List$length(args_b))) {
              _t1165 = Types$unify_error(t1_1148, t2_1150);
            } else {
              _t1165 = undefined;
            }
            _t1165;
            _t1154 = List$iter2(Types$unify, args_a, args_b);
            break _t1155;
          }
        }
        if (_t1153[0]._tag === 15 && _t1153[1]._tag === 15) {
          const r1 = _t1153[0]._val;
          const r2 = _t1153[1]._val;
          _t1154 = Types$unify_pv_row(r1, r2);
          break _t1155;
        }
        if (true) {
          _t1154 = Types$unify_error(t1_1148, t2_1150);
          break _t1155;
        }
        _match_fail("line 15950");
      }
      _t1152 = _t1154;
    }
    const _t1151 = _t1152;
    const _t1149 = _t1151;
    return _t1149;
  }
}
function Types$generalize(level, ty) {
  let _t1167;
  const _t1166 = Hashtbl$create(8);
  _t1168: {
    if (true) {
      const id_map = _t1166;
      const counter_1169 = Ref$create(0);
      let _t1172;
      const _t1171 = Hashtbl$create(4);
      _t1173: {
        if (true) {
          const eff_id_map = _t1171;
          const ecounter_1174 = Ref$create(0);
          let _t1177;
          const _t1176 = Hashtbl$create(4);
          _t1178: {
            if (true) {
              const pv_id_map = _t1176;
              const pvcounter_1179 = Ref$create(0);
              let _t1182;
              const _t1181 = Hashtbl$create(4);
              _t1183: {
                if (true) {
                  const r_id_map = _t1181;
                  const rcounter_1184 = Ref$create(0);
                  function go(ty) {
                    let _t1187;
                    const _t1186 = Types$repr(ty);
                    _t1188: {
                      if (_t1186._tag === 16 && _t1186._val.contents._tag === 0) {
                        const id = _t1186._val.contents._val[0];
                        const level$p = _t1186._val.contents._val[1];
                        if ((level$p > level)) {
                          let _t1190;
                          const _t1189 = _call(Hashtbl$get, [__dict_Hash_int, __dict_Eq_int, id_map, id]);
                          _t1191: {
                            if (_t1189._tag === 1) {
                              const gen_id = _t1189._val;
                              _t1190 = ({_tag: 17, _name: "TGen", _val: gen_id});
                              break _t1191;
                            }
                            if (_t1189._tag === 0) {
                              const gen_id_1192 = Ref$get(counter_1169);
                              Ref$set(counter_1169, (gen_id_1192 + 1));
                              _call(Hashtbl$set, [__dict_Hash_int, __dict_Eq_int, id_map, id, gen_id_1192]);
                              const _t1193 = ({_tag: 17, _name: "TGen", _val: gen_id_1192});
                              _t1190 = _t1193;
                              break _t1191;
                            }
                            _match_fail("line 15950");
                          }
                          _t1187 = _t1190;
                          break _t1188;
                        }
                      }
                      if (_t1186._tag === 16 && _t1186._val.contents._tag === 0) {
                        const t = _t1186;
                        _t1187 = t;
                        break _t1188;
                      }
                      if (_t1186._tag === 16 && _t1186._val.contents._tag === 1) {
                        _t1187 = failwith("assert false");
                        break _t1188;
                      }
                      if (_t1186._tag === 7) {
                        const a = _t1186._val[0];
                        const eff = _t1186._val[1];
                        const r = _t1186._val[2];
                        _t1187 = ({_tag: 7, _name: "TArrow", _val: [go(a), go_eff(eff), go(r)]});
                        break _t1188;
                      }
                      if (_t1186._tag === 8) {
                        const a = _t1186._val[0];
                        const eff = _t1186._val[1];
                        const r = _t1186._val[2];
                        _t1187 = ({_tag: 8, _name: "TCont", _val: [go(a), go_eff(eff), go(r)]});
                        break _t1188;
                      }
                      if (_t1186._tag === 9) {
                        const ts = _t1186._val;
                        _t1187 = ({_tag: 9, _name: "TTuple", _val: List$map(go, ts)});
                        break _t1188;
                      }
                      if (_t1186._tag === 10) {
                        const t = _t1186._val;
                        _t1187 = ({_tag: 10, _name: "TList", _val: go(t)});
                        break _t1188;
                      }
                      if (_t1186._tag === 14) {
                        const t = _t1186._val;
                        _t1187 = ({_tag: 14, _name: "TArray", _val: go(t)});
                        break _t1188;
                      }
                      if (_t1186._tag === 13) {
                        const k = _t1186._val[0];
                        const v = _t1186._val[1];
                        _t1187 = ({_tag: 13, _name: "TMap", _val: [go(k), go(v)]});
                        break _t1188;
                      }
                      if (_t1186._tag === 11) {
                        const row = _t1186._val;
                        _t1187 = ({_tag: 11, _name: "TRecord", _val: go_rrow(row)});
                        break _t1188;
                      }
                      if (_t1186._tag === 12) {
                        const name = _t1186._val[0];
                        const args = _t1186._val[1];
                        _t1187 = ({_tag: 12, _name: "TVariant", _val: [name, List$map(go, args)]});
                        break _t1188;
                      }
                      if (_t1186._tag === 15) {
                        const row = _t1186._val;
                        _t1187 = ({_tag: 15, _name: "TPolyVariant", _val: go_pv(row)});
                        break _t1188;
                      }
                      if (true) {
                        const t = _t1186;
                        _t1187 = t;
                        break _t1188;
                      }
                      _match_fail("line 15950");
                    }
                    return _t1187;
                  }
                  function go_eff(eff) {
                    let _t1195;
                    const _t1194 = Types$eff_repr(eff);
                    _t1196: {
                      if (_t1194._tag === 0 && _t1194._val.contents._tag === 0) {
                        const id = _t1194._val.contents._val[0];
                        const level$p = _t1194._val.contents._val[1];
                        if ((level$p > level)) {
                          let _t1198;
                          const _t1197 = _call(Hashtbl$get, [__dict_Hash_int, __dict_Eq_int, eff_id_map, id]);
                          _t1199: {
                            if (_t1197._tag === 1) {
                              const gen_id = _t1197._val;
                              _t1198 = ({_tag: 3, _name: "EffGen", _val: gen_id});
                              break _t1199;
                            }
                            if (_t1197._tag === 0) {
                              const gen_id_1200 = Ref$get(ecounter_1174);
                              Ref$set(ecounter_1174, (gen_id_1200 + 1));
                              _call(Hashtbl$set, [__dict_Hash_int, __dict_Eq_int, eff_id_map, id, gen_id_1200]);
                              const _t1201 = ({_tag: 3, _name: "EffGen", _val: gen_id_1200});
                              _t1198 = _t1201;
                              break _t1199;
                            }
                            _match_fail("line 15950");
                          }
                          _t1195 = _t1198;
                          break _t1196;
                        }
                      }
                      if (_t1194._tag === 0 && _t1194._val.contents._tag === 0) {
                        const e = _t1194;
                        _t1195 = e;
                        break _t1196;
                      }
                      if (_t1194._tag === 0 && _t1194._val.contents._tag === 1) {
                        _t1195 = failwith("assert false");
                        break _t1196;
                      }
                      if (_t1194._tag === 2) {
                        const label = _t1194._val[0];
                        const params = _t1194._val[1];
                        const tail = _t1194._val[2];
                        _t1195 = ({_tag: 2, _name: "EffRow", _val: [label, List$map(go, params), go_eff(tail)]});
                        break _t1196;
                      }
                      if (_t1194._tag === 1) {
                        _t1195 = ({_tag: 1, _name: "EffEmpty"});
                        break _t1196;
                      }
                      if (_t1194._tag === 3) {
                        const e = _t1194;
                        _t1195 = e;
                        break _t1196;
                      }
                      _match_fail("line 15950");
                    }
                    return _t1195;
                  }
                  function go_pv(row) {
                    let _t1203;
                    const _t1202 = Types$pv_repr(row);
                    _t1204: {
                      if (_t1202._tag === 1 && _t1202._val.contents._tag === 0) {
                        const id = _t1202._val.contents._val[0];
                        const level$p = _t1202._val.contents._val[1];
                        if ((level$p > level)) {
                          let _t1206;
                          const _t1205 = _call(Hashtbl$get, [__dict_Hash_int, __dict_Eq_int, pv_id_map, id]);
                          _t1207: {
                            if (_t1205._tag === 1) {
                              const gen_id = _t1205._val;
                              _t1206 = ({_tag: 3, _name: "PVGen", _val: gen_id});
                              break _t1207;
                            }
                            if (_t1205._tag === 0) {
                              const gen_id_1208 = Ref$get(pvcounter_1179);
                              Ref$set(pvcounter_1179, (gen_id_1208 + 1));
                              _call(Hashtbl$set, [__dict_Hash_int, __dict_Eq_int, pv_id_map, id, gen_id_1208]);
                              const _t1209 = ({_tag: 3, _name: "PVGen", _val: gen_id_1208});
                              _t1206 = _t1209;
                              break _t1207;
                            }
                            _match_fail("line 15950");
                          }
                          _t1203 = _t1206;
                          break _t1204;
                        }
                      }
                      if (_t1202._tag === 1 && _t1202._val.contents._tag === 0) {
                        const r = _t1202;
                        _t1203 = r;
                        break _t1204;
                      }
                      if (_t1202._tag === 1 && _t1202._val.contents._tag === 1) {
                        _t1203 = failwith("assert false");
                        break _t1204;
                      }
                      if (_t1202._tag === 0) {
                        const tag = _t1202._val[0];
                        const ty_opt = _t1202._val[1];
                        const tail = _t1202._val[2];
                        _t1203 = ({_tag: 0, _name: "PVRow", _val: [tag, Option$map(go, ty_opt), go_pv(tail)]});
                        break _t1204;
                      }
                      if (_t1202._tag === 2) {
                        _t1203 = ({_tag: 2, _name: "PVEmpty"});
                        break _t1204;
                      }
                      if (_t1202._tag === 3) {
                        const r = _t1202;
                        _t1203 = r;
                        break _t1204;
                      }
                      _match_fail("line 15950");
                    }
                    return _t1203;
                  }
                  function go_rrow(row) {
                    let _t1211;
                    const _t1210 = Types$rrow_repr(row);
                    _t1212: {
                      if (_t1210._tag === 1 && _t1210._val.contents._tag === 0) {
                        const id = _t1210._val.contents._val[0];
                        const level$p = _t1210._val.contents._val[1];
                        if ((level$p > level)) {
                          let _t1214;
                          const _t1213 = _call(Hashtbl$get, [__dict_Hash_int, __dict_Eq_int, r_id_map, id]);
                          _t1215: {
                            if (_t1213._tag === 1) {
                              const gen_id = _t1213._val;
                              _t1214 = ({_tag: 3, _name: "RGen", _val: gen_id});
                              break _t1215;
                            }
                            if (_t1213._tag === 0) {
                              const gen_id_1216 = Ref$get(rcounter_1184);
                              Ref$set(rcounter_1184, (gen_id_1216 + 1));
                              _call(Hashtbl$set, [__dict_Hash_int, __dict_Eq_int, r_id_map, id, gen_id_1216]);
                              const _t1217 = ({_tag: 3, _name: "RGen", _val: gen_id_1216});
                              _t1214 = _t1217;
                              break _t1215;
                            }
                            _match_fail("line 15950");
                          }
                          _t1211 = _t1214;
                          break _t1212;
                        }
                      }
                      if (_t1210._tag === 1 && _t1210._val.contents._tag === 0) {
                        const r = _t1210;
                        _t1211 = r;
                        break _t1212;
                      }
                      if (_t1210._tag === 1 && _t1210._val.contents._tag === 1) {
                        _t1211 = failwith("assert false");
                        break _t1212;
                      }
                      if (_t1210._tag === 0) {
                        const name = _t1210._val[0];
                        const ty = _t1210._val[1];
                        const tail = _t1210._val[2];
                        _t1211 = ({_tag: 0, _name: "RRow", _val: [name, go(ty), go_rrow(tail)]});
                        break _t1212;
                      }
                      if (_t1210._tag === 2) {
                        _t1211 = ({_tag: 2, _name: "REmpty"});
                        break _t1212;
                      }
                      if (_t1210._tag === 3) {
                        const r = _t1210;
                        _t1211 = r;
                        break _t1212;
                      }
                      if (_t1210._tag === 4) {
                        _t1211 = ({_tag: 4, _name: "RWild"});
                        break _t1212;
                      }
                      _match_fail("line 15950");
                    }
                    return _t1211;
                  }
                  const body_1219 = go(ty);
                  const _t1220 = ({body: body_1219, constraints: null, equant: Ref$get(ecounter_1174), pvquant: Ref$get(pvcounter_1179), quant: Ref$get(counter_1169), record_evidences: null, rquant: Ref$get(rcounter_1184)});
                  const _t1218 = _t1220;
                  const _t1185 = _t1218;
                  _t1182 = _t1185;
                  break _t1183;
                }
                _match_fail("line 15950");
              }
              const _t1180 = _t1182;
              _t1177 = _t1180;
              break _t1178;
            }
            _match_fail("line 15950");
          }
          const _t1175 = _t1177;
          _t1172 = _t1175;
          break _t1173;
        }
        _match_fail("line 15950");
      }
      const _t1170 = _t1172;
      _t1167 = _t1170;
      break _t1168;
    }
    _match_fail("line 15950");
  }
  return _t1167;
}
function Types$generalize_with_map(level, ty) {
  const counter_1221 = Ref$create(0);
  let _t1224;
  const _t1223 = Hashtbl$create(8);
  _t1225: {
    if (true) {
      const id_map = _t1223;
      const ecounter_1226 = Ref$create(0);
      let _t1229;
      const _t1228 = Hashtbl$create(4);
      _t1230: {
        if (true) {
          const eff_id_map = _t1228;
          const pvcounter_1231 = Ref$create(0);
          let _t1234;
          const _t1233 = Hashtbl$create(4);
          _t1235: {
            if (true) {
              const pv_id_map = _t1233;
              const rcounter_1236 = Ref$create(0);
              let _t1239;
              const _t1238 = Hashtbl$create(4);
              _t1240: {
                if (true) {
                  const r_id_map = _t1238;
                  function go(ty) {
                    let _t1242;
                    const _t1241 = Types$repr(ty);
                    _t1243: {
                      if (_t1241._tag === 16 && _t1241._val.contents._tag === 0) {
                        const id = _t1241._val.contents._val[0];
                        const l = _t1241._val.contents._val[1];
                        if ((l > level)) {
                          let _t1245;
                          const _t1244 = _call(Hashtbl$get, [__dict_Hash_int, __dict_Eq_int, id_map, id]);
                          _t1246: {
                            if (_t1244._tag === 1) {
                              const gen = _t1244._val;
                              _t1245 = gen;
                              break _t1246;
                            }
                            if (_t1244._tag === 0) {
                              const gen_1247 = ({_tag: 17, _name: "TGen", _val: Ref$get(counter_1221)});
                              Ref$set(counter_1221, (Ref$get(counter_1221) + 1));
                              _call(Hashtbl$set, [__dict_Hash_int, __dict_Eq_int, id_map, id, gen_1247]);
                              const _t1248 = gen_1247;
                              _t1245 = _t1248;
                              break _t1246;
                            }
                            _match_fail("line 15950");
                          }
                          _t1242 = _t1245;
                          break _t1243;
                        }
                      }
                      if ((_t1241._tag === 16 && _t1241._val.contents._tag === 0 || _t1241._tag === 16 && _t1241._val.contents._tag === 1)) {
                        _t1242 = ty;
                        break _t1243;
                      }
                      if (_t1241._tag === 7) {
                        const a = _t1241._val[0];
                        const eff = _t1241._val[1];
                        const r = _t1241._val[2];
                        _t1242 = ({_tag: 7, _name: "TArrow", _val: [go(a), go_eff(eff), go(r)]});
                        break _t1243;
                      }
                      if (_t1241._tag === 8) {
                        const a = _t1241._val[0];
                        const eff = _t1241._val[1];
                        const r = _t1241._val[2];
                        _t1242 = ({_tag: 8, _name: "TCont", _val: [go(a), go_eff(eff), go(r)]});
                        break _t1243;
                      }
                      if (_t1241._tag === 9) {
                        const ts = _t1241._val;
                        _t1242 = ({_tag: 9, _name: "TTuple", _val: List$map(go, ts)});
                        break _t1243;
                      }
                      if (_t1241._tag === 10) {
                        const t = _t1241._val;
                        _t1242 = ({_tag: 10, _name: "TList", _val: go(t)});
                        break _t1243;
                      }
                      if (_t1241._tag === 14) {
                        const t = _t1241._val;
                        _t1242 = ({_tag: 14, _name: "TArray", _val: go(t)});
                        break _t1243;
                      }
                      if (_t1241._tag === 13) {
                        const k = _t1241._val[0];
                        const v = _t1241._val[1];
                        _t1242 = ({_tag: 13, _name: "TMap", _val: [go(k), go(v)]});
                        break _t1243;
                      }
                      if (_t1241._tag === 11) {
                        const row = _t1241._val;
                        _t1242 = ({_tag: 11, _name: "TRecord", _val: go_rrow(row)});
                        break _t1243;
                      }
                      if (_t1241._tag === 12) {
                        const name = _t1241._val[0];
                        const args = _t1241._val[1];
                        _t1242 = ({_tag: 12, _name: "TVariant", _val: [name, List$map(go, args)]});
                        break _t1243;
                      }
                      if (_t1241._tag === 15) {
                        const row = _t1241._val;
                        _t1242 = ({_tag: 15, _name: "TPolyVariant", _val: go_pv(row)});
                        break _t1243;
                      }
                      if (true) {
                        const t = _t1241;
                        _t1242 = t;
                        break _t1243;
                      }
                      _match_fail("line 15950");
                    }
                    return _t1242;
                  }
                  function go_eff(eff) {
                    let _t1250;
                    const _t1249 = Types$eff_repr(eff);
                    _t1251: {
                      if (_t1249._tag === 0 && _t1249._val.contents._tag === 0) {
                        const id = _t1249._val.contents._val[0];
                        const l = _t1249._val.contents._val[1];
                        if ((l > level)) {
                          let _t1253;
                          const _t1252 = _call(Hashtbl$get, [__dict_Hash_int, __dict_Eq_int, eff_id_map, id]);
                          _t1254: {
                            if (_t1252._tag === 1) {
                              const gen = _t1252._val;
                              _t1253 = gen;
                              break _t1254;
                            }
                            if (_t1252._tag === 0) {
                              const gen_1255 = ({_tag: 3, _name: "EffGen", _val: Ref$get(ecounter_1226)});
                              Ref$set(ecounter_1226, (Ref$get(ecounter_1226) + 1));
                              _call(Hashtbl$set, [__dict_Hash_int, __dict_Eq_int, eff_id_map, id, gen_1255]);
                              const _t1256 = gen_1255;
                              _t1253 = _t1256;
                              break _t1254;
                            }
                            _match_fail("line 15950");
                          }
                          _t1250 = _t1253;
                          break _t1251;
                        }
                      }
                      if ((_t1249._tag === 0 && _t1249._val.contents._tag === 0 || _t1249._tag === 0 && _t1249._val.contents._tag === 1)) {
                        _t1250 = eff;
                        break _t1251;
                      }
                      if (_t1249._tag === 2) {
                        const label = _t1249._val[0];
                        const params = _t1249._val[1];
                        const tail = _t1249._val[2];
                        _t1250 = ({_tag: 2, _name: "EffRow", _val: [label, List$map(go, params), go_eff(tail)]});
                        break _t1251;
                      }
                      if (_t1249._tag === 1) {
                        _t1250 = ({_tag: 1, _name: "EffEmpty"});
                        break _t1251;
                      }
                      if (_t1249._tag === 3) {
                        const e = _t1249;
                        _t1250 = e;
                        break _t1251;
                      }
                      _match_fail("line 15950");
                    }
                    return _t1250;
                  }
                  function go_pv(row) {
                    let _t1258;
                    const _t1257 = Types$pv_repr(row);
                    _t1259: {
                      if (_t1257._tag === 1 && _t1257._val.contents._tag === 0) {
                        const id = _t1257._val.contents._val[0];
                        const l = _t1257._val.contents._val[1];
                        if ((l > level)) {
                          let _t1261;
                          const _t1260 = _call(Hashtbl$get, [__dict_Hash_int, __dict_Eq_int, pv_id_map, id]);
                          _t1262: {
                            if (_t1260._tag === 1) {
                              const gen = _t1260._val;
                              _t1261 = gen;
                              break _t1262;
                            }
                            if (_t1260._tag === 0) {
                              const gen_1263 = ({_tag: 3, _name: "PVGen", _val: Ref$get(pvcounter_1231)});
                              Ref$set(pvcounter_1231, (Ref$get(pvcounter_1231) + 1));
                              _call(Hashtbl$set, [__dict_Hash_int, __dict_Eq_int, pv_id_map, id, gen_1263]);
                              const _t1264 = gen_1263;
                              _t1261 = _t1264;
                              break _t1262;
                            }
                            _match_fail("line 15950");
                          }
                          _t1258 = _t1261;
                          break _t1259;
                        }
                      }
                      if ((_t1257._tag === 1 && _t1257._val.contents._tag === 0 || _t1257._tag === 1 && _t1257._val.contents._tag === 1)) {
                        _t1258 = row;
                        break _t1259;
                      }
                      if (_t1257._tag === 0) {
                        const tag = _t1257._val[0];
                        const ty_opt = _t1257._val[1];
                        const tail = _t1257._val[2];
                        _t1258 = ({_tag: 0, _name: "PVRow", _val: [tag, Option$map(go, ty_opt), go_pv(tail)]});
                        break _t1259;
                      }
                      if (_t1257._tag === 2) {
                        _t1258 = ({_tag: 2, _name: "PVEmpty"});
                        break _t1259;
                      }
                      if (_t1257._tag === 3) {
                        const r = _t1257;
                        _t1258 = r;
                        break _t1259;
                      }
                      _match_fail("line 15950");
                    }
                    return _t1258;
                  }
                  function go_rrow(row) {
                    let _t1266;
                    const _t1265 = Types$rrow_repr(row);
                    _t1267: {
                      if (_t1265._tag === 1 && _t1265._val.contents._tag === 0) {
                        const id = _t1265._val.contents._val[0];
                        const l = _t1265._val.contents._val[1];
                        if ((l > level)) {
                          let _t1269;
                          const _t1268 = _call(Hashtbl$get, [__dict_Hash_int, __dict_Eq_int, r_id_map, id]);
                          _t1270: {
                            if (_t1268._tag === 1) {
                              const gen = _t1268._val;
                              _t1269 = gen;
                              break _t1270;
                            }
                            if (_t1268._tag === 0) {
                              const gen_1271 = ({_tag: 3, _name: "RGen", _val: Ref$get(rcounter_1236)});
                              Ref$set(rcounter_1236, (Ref$get(rcounter_1236) + 1));
                              _call(Hashtbl$set, [__dict_Hash_int, __dict_Eq_int, r_id_map, id, gen_1271]);
                              const _t1272 = gen_1271;
                              _t1269 = _t1272;
                              break _t1270;
                            }
                            _match_fail("line 15950");
                          }
                          _t1266 = _t1269;
                          break _t1267;
                        }
                      }
                      if ((_t1265._tag === 1 && _t1265._val.contents._tag === 0 || _t1265._tag === 1 && _t1265._val.contents._tag === 1)) {
                        _t1266 = row;
                        break _t1267;
                      }
                      if (_t1265._tag === 0) {
                        const name = _t1265._val[0];
                        const ty = _t1265._val[1];
                        const tail = _t1265._val[2];
                        _t1266 = ({_tag: 0, _name: "RRow", _val: [name, go(ty), go_rrow(tail)]});
                        break _t1267;
                      }
                      if (_t1265._tag === 2) {
                        _t1266 = ({_tag: 2, _name: "REmpty"});
                        break _t1267;
                      }
                      if (_t1265._tag === 3) {
                        const r = _t1265;
                        _t1266 = r;
                        break _t1267;
                      }
                      if (_t1265._tag === 4) {
                        _t1266 = ({_tag: 4, _name: "RWild"});
                        break _t1267;
                      }
                      _match_fail("line 15950");
                    }
                    return _t1266;
                  }
                  const body_1274 = go(ty);
                  const _t1275 = [({body: body_1274, constraints: null, equant: Ref$get(ecounter_1226), pvquant: Ref$get(pvcounter_1231), quant: Ref$get(counter_1221), record_evidences: null, rquant: Ref$get(rcounter_1236)}), id_map];
                  const _t1273 = _t1275;
                  _t1239 = _t1273;
                  break _t1240;
                }
                _match_fail("line 15950");
              }
              const _t1237 = _t1239;
              _t1234 = _t1237;
              break _t1235;
            }
            _match_fail("line 15950");
          }
          const _t1232 = _t1234;
          _t1229 = _t1232;
          break _t1230;
        }
        _match_fail("line 15950");
      }
      const _t1227 = _t1229;
      _t1224 = _t1227;
      break _t1225;
    }
    _match_fail("line 15950");
  }
  const _t1222 = _t1224;
  return _t1222;
}
function Types$instantiate_with_mapping(level, s) {
  let _t1276;
  if (((s.quant === 0) && ((s.equant === 0) && ((s.pvquant === 0) && (s.rquant === 0))))) {
    _t1276 = [s.body, null];
  } else {
    function _t1277(_) {
      return Types$new_tvar(level);
    }
    const vars_1278 = Array$init(s.quant, _t1277);
    function _t1280(_) {
      return Types$new_effvar(level);
    }
    const evars_1281 = Array$init(s.equant, _t1280);
    function _t1283(_) {
      return Types$new_pvvar(level);
    }
    const pvvars_1284 = Array$init(s.pvquant, _t1283);
    function _t1286(_) {
      return Types$new_rvar(level);
    }
    const rvars_1287 = Array$init(s.rquant, _t1286);
    function _t1289(_) {
      return Types$new_effvar(level);
    }
    const shared_eff_1290 = _t1289;
    function _t1292(i) {
      return [i, Array$get(vars_1278, i)];
    }
    const mapping_1293 = List$init(s.quant, _t1292);
    function go(__x) {
      let _t1296;
      const _t1295 = __x;
      _t1297: {
        if (_t1295._tag === 17) {
          const id = _t1295._val;
          if ((id < s.quant)) {
            _t1296 = Array$get(vars_1278, id);
            break _t1297;
          }
        }
        if (_t1295._tag === 7) {
          const a = _t1295._val[0];
          const eff = _t1295._val[1];
          const r = _t1295._val[2];
          _t1296 = ({_tag: 7, _name: "TArrow", _val: [go(a), go_eff(eff), go(r)]});
          break _t1297;
        }
        if (_t1295._tag === 8) {
          const a = _t1295._val[0];
          const eff = _t1295._val[1];
          const r = _t1295._val[2];
          _t1296 = ({_tag: 8, _name: "TCont", _val: [go(a), go_eff(eff), go(r)]});
          break _t1297;
        }
        if (_t1295._tag === 9) {
          const ts = _t1295._val;
          _t1296 = ({_tag: 9, _name: "TTuple", _val: List$map(go, ts)});
          break _t1297;
        }
        if (_t1295._tag === 10) {
          const t = _t1295._val;
          _t1296 = ({_tag: 10, _name: "TList", _val: go(t)});
          break _t1297;
        }
        if (_t1295._tag === 14) {
          const t = _t1295._val;
          _t1296 = ({_tag: 14, _name: "TArray", _val: go(t)});
          break _t1297;
        }
        if (_t1295._tag === 13) {
          const k = _t1295._val[0];
          const v = _t1295._val[1];
          _t1296 = ({_tag: 13, _name: "TMap", _val: [go(k), go(v)]});
          break _t1297;
        }
        if (_t1295._tag === 11) {
          const row = _t1295._val;
          _t1296 = ({_tag: 11, _name: "TRecord", _val: go_rrow(row)});
          break _t1297;
        }
        if (_t1295._tag === 12) {
          const name = _t1295._val[0];
          const args = _t1295._val[1];
          _t1296 = ({_tag: 12, _name: "TVariant", _val: [name, List$map(go, args)]});
          break _t1297;
        }
        if (_t1295._tag === 15) {
          const row = _t1295._val;
          _t1296 = ({_tag: 15, _name: "TPolyVariant", _val: go_pv(row)});
          break _t1297;
        }
        if (true) {
          const t = _t1295;
          _t1296 = t;
          break _t1297;
        }
        _match_fail("line 15950");
      }
      return _t1296;
    }
    function go_eff(__x) {
      let _t1299;
      const _t1298 = __x;
      _t1300: {
        if (_t1298._tag === 3) {
          const id = _t1298._val;
          if ((id < s.equant)) {
            _t1299 = Array$get(evars_1281, id);
            break _t1300;
          }
        }
        if (_t1298._tag === 2) {
          const label = _t1298._val[0];
          const params = _t1298._val[1];
          const tail = _t1298._val[2];
          _t1299 = ({_tag: 2, _name: "EffRow", _val: [label, List$map(go, params), go_eff(tail)]});
          break _t1300;
        }
        if (_t1298._tag === 1) {
          _t1299 = shared_eff_1290(undefined);
          break _t1300;
        }
        if (true) {
          const e = _t1298;
          _t1299 = e;
          break _t1300;
        }
        _match_fail("line 15950");
      }
      return _t1299;
    }
    function go_pv(__x) {
      let _t1302;
      const _t1301 = __x;
      _t1303: {
        if (_t1301._tag === 3) {
          const id = _t1301._val;
          if ((id < s.pvquant)) {
            _t1302 = Array$get(pvvars_1284, id);
            break _t1303;
          }
        }
        if (_t1301._tag === 0) {
          const tag = _t1301._val[0];
          const ty_opt = _t1301._val[1];
          const tail = _t1301._val[2];
          _t1302 = ({_tag: 0, _name: "PVRow", _val: [tag, Option$map(go, ty_opt), go_pv(tail)]});
          break _t1303;
        }
        if (true) {
          const r = _t1301;
          _t1302 = r;
          break _t1303;
        }
        _match_fail("line 15950");
      }
      return _t1302;
    }
    function go_rrow(__x) {
      let _t1305;
      const _t1304 = __x;
      _t1306: {
        if (_t1304._tag === 3) {
          const id = _t1304._val;
          if ((id < s.rquant)) {
            _t1305 = Array$get(rvars_1287, id);
            break _t1306;
          }
        }
        if (_t1304._tag === 0) {
          const name = _t1304._val[0];
          const ty = _t1304._val[1];
          const tail = _t1304._val[2];
          _t1305 = ({_tag: 0, _name: "RRow", _val: [name, go(ty), go_rrow(tail)]});
          break _t1306;
        }
        if (true) {
          const r = _t1304;
          _t1305 = r;
          break _t1306;
        }
        _match_fail("line 15950");
      }
      return _t1305;
    }
    const _t1307 = [go(s.body), mapping_1293];
    const _t1294 = _t1307;
    const _t1291 = _t1294;
    const _t1288 = _t1291;
    const _t1285 = _t1288;
    const _t1282 = _t1285;
    const _t1279 = _t1282;
    _t1276 = _t1279;
  }
  return _t1276;
}
function Types$instantiate(level, s) {
  let _t1308;
  if (((s.quant === 0) && ((s.equant === 0) && ((s.pvquant === 0) && (s.rquant === 0))))) {
    _t1308 = s.body;
  } else {
    function _t1309(_) {
      return Types$new_tvar(level);
    }
    const vars_1310 = Array$init(s.quant, _t1309);
    function _t1312(_) {
      return Types$new_effvar(level);
    }
    const evars_1313 = Array$init(s.equant, _t1312);
    function _t1315(_) {
      return Types$new_pvvar(level);
    }
    const pvvars_1316 = Array$init(s.pvquant, _t1315);
    function _t1318(_) {
      return Types$new_rvar(level);
    }
    const rvars_1319 = Array$init(s.rquant, _t1318);
    function _t1321(_) {
      return Types$new_effvar(level);
    }
    const shared_eff_1322 = _t1321;
    function go(__x) {
      while (true) {
        let _t1325;
        const _t1324 = __x;
        _t1326: {
          if (_t1324._tag === 17) {
            const id = _t1324._val;
            if ((id < s.quant)) {
              _t1325 = Array$get(vars_1310, id);
              break _t1326;
            }
          }
          if (_t1324._tag === 7) {
            const a = _t1324._val[0];
            const eff = _t1324._val[1];
            const r = _t1324._val[2];
            _t1325 = ({_tag: 7, _name: "TArrow", _val: [go(a), go_eff(eff), go(r)]});
            break _t1326;
          }
          if (_t1324._tag === 8) {
            const a = _t1324._val[0];
            const eff = _t1324._val[1];
            const r = _t1324._val[2];
            _t1325 = ({_tag: 8, _name: "TCont", _val: [go(a), go_eff(eff), go(r)]});
            break _t1326;
          }
          if (_t1324._tag === 9) {
            const ts = _t1324._val;
            _t1325 = ({_tag: 9, _name: "TTuple", _val: List$map(go, ts)});
            break _t1326;
          }
          if (_t1324._tag === 10) {
            const t = _t1324._val;
            _t1325 = ({_tag: 10, _name: "TList", _val: go(t)});
            break _t1326;
          }
          if (_t1324._tag === 14) {
            const t = _t1324._val;
            _t1325 = ({_tag: 14, _name: "TArray", _val: go(t)});
            break _t1326;
          }
          if (_t1324._tag === 13) {
            const k = _t1324._val[0];
            const v = _t1324._val[1];
            _t1325 = ({_tag: 13, _name: "TMap", _val: [go(k), go(v)]});
            break _t1326;
          }
          if (_t1324._tag === 11) {
            const row = _t1324._val;
            _t1325 = ({_tag: 11, _name: "TRecord", _val: go_rrow(row)});
            break _t1326;
          }
          if (_t1324._tag === 12) {
            const name = _t1324._val[0];
            const args = _t1324._val[1];
            _t1325 = ({_tag: 12, _name: "TVariant", _val: [name, List$map(go, args)]});
            break _t1326;
          }
          if (_t1324._tag === 15) {
            const row = _t1324._val;
            _t1325 = ({_tag: 15, _name: "TPolyVariant", _val: go_pv(row)});
            break _t1326;
          }
          if (_t1324._tag === 16 && _t1324._val.contents._tag === 1) {
            const ty = _t1324._val.contents._val;
            const _t1327 = ty;
            __x = _t1327;
            continue;
            _t1325 = undefined;
            break _t1326;
          }
          if (true) {
            const t = _t1324;
            _t1325 = t;
            break _t1326;
          }
          _match_fail("line 15950");
        }
        return _t1325;
      }
    }
    function go_eff(__x) {
      let _t1329;
      const _t1328 = __x;
      _t1330: {
        if (_t1328._tag === 3) {
          const id = _t1328._val;
          if ((id < s.equant)) {
            _t1329 = Array$get(evars_1313, id);
            break _t1330;
          }
        }
        if (_t1328._tag === 2) {
          const label = _t1328._val[0];
          const params = _t1328._val[1];
          const tail = _t1328._val[2];
          _t1329 = ({_tag: 2, _name: "EffRow", _val: [label, List$map(go, params), go_eff(tail)]});
          break _t1330;
        }
        if (_t1328._tag === 1) {
          _t1329 = shared_eff_1322(undefined);
          break _t1330;
        }
        if (true) {
          const e = _t1328;
          _t1329 = e;
          break _t1330;
        }
        _match_fail("line 15950");
      }
      return _t1329;
    }
    function go_pv(__x) {
      let _t1332;
      const _t1331 = __x;
      _t1333: {
        if (_t1331._tag === 3) {
          const id = _t1331._val;
          if ((id < s.pvquant)) {
            _t1332 = Array$get(pvvars_1316, id);
            break _t1333;
          }
        }
        if (_t1331._tag === 0) {
          const tag = _t1331._val[0];
          const ty_opt = _t1331._val[1];
          const tail = _t1331._val[2];
          _t1332 = ({_tag: 0, _name: "PVRow", _val: [tag, Option$map(go, ty_opt), go_pv(tail)]});
          break _t1333;
        }
        if (true) {
          const r = _t1331;
          _t1332 = r;
          break _t1333;
        }
        _match_fail("line 15950");
      }
      return _t1332;
    }
    function go_rrow(__x) {
      let _t1335;
      const _t1334 = __x;
      _t1336: {
        if (_t1334._tag === 3) {
          const id = _t1334._val;
          if ((id < s.rquant)) {
            _t1335 = Array$get(rvars_1319, id);
            break _t1336;
          }
        }
        if (_t1334._tag === 0) {
          const name = _t1334._val[0];
          const ty = _t1334._val[1];
          const tail = _t1334._val[2];
          _t1335 = ({_tag: 0, _name: "RRow", _val: [name, go(ty), go_rrow(tail)]});
          break _t1336;
        }
        if (true) {
          const r = _t1334;
          _t1335 = r;
          break _t1336;
        }
        _match_fail("line 15950");
      }
      return _t1335;
    }
    const _t1337 = go(s.body);
    const _t1323 = _t1337;
    const _t1320 = _t1323;
    const _t1317 = _t1320;
    const _t1314 = _t1317;
    const _t1311 = _t1314;
    _t1308 = _t1311;
  }
  return _t1308;
}
function Types$deep_repr(ty) {
  let _t1339;
  const _t1338 = Types$repr(ty);
  _t1340: {
    if (_t1338._tag === 7) {
      const a = _t1338._val[0];
      const eff = _t1338._val[1];
      const b = _t1338._val[2];
      _t1339 = ({_tag: 7, _name: "TArrow", _val: [Types$deep_repr(a), Types$deep_repr_eff(eff), Types$deep_repr(b)]});
      break _t1340;
    }
    if (_t1338._tag === 8) {
      const a = _t1338._val[0];
      const eff = _t1338._val[1];
      const b = _t1338._val[2];
      _t1339 = ({_tag: 8, _name: "TCont", _val: [Types$deep_repr(a), Types$deep_repr_eff(eff), Types$deep_repr(b)]});
      break _t1340;
    }
    if (_t1338._tag === 9) {
      const ts = _t1338._val;
      _t1339 = ({_tag: 9, _name: "TTuple", _val: List$map(Types$deep_repr, ts)});
      break _t1340;
    }
    if (_t1338._tag === 10) {
      const t = _t1338._val;
      _t1339 = ({_tag: 10, _name: "TList", _val: Types$deep_repr(t)});
      break _t1340;
    }
    if (_t1338._tag === 14) {
      const t = _t1338._val;
      _t1339 = ({_tag: 14, _name: "TArray", _val: Types$deep_repr(t)});
      break _t1340;
    }
    if (_t1338._tag === 13) {
      const k = _t1338._val[0];
      const v = _t1338._val[1];
      _t1339 = ({_tag: 13, _name: "TMap", _val: [Types$deep_repr(k), Types$deep_repr(v)]});
      break _t1340;
    }
    if (_t1338._tag === 11) {
      const row = _t1338._val;
      _t1339 = ({_tag: 11, _name: "TRecord", _val: Types$deep_repr_rrow(row)});
      break _t1340;
    }
    if (_t1338._tag === 12) {
      const name = _t1338._val[0];
      const args = _t1338._val[1];
      _t1339 = ({_tag: 12, _name: "TVariant", _val: [name, List$map(Types$deep_repr, args)]});
      break _t1340;
    }
    if (_t1338._tag === 15) {
      const row = _t1338._val;
      _t1339 = ({_tag: 15, _name: "TPolyVariant", _val: Types$deep_repr_pv(row)});
      break _t1340;
    }
    if (true) {
      const t = _t1338;
      _t1339 = t;
      break _t1340;
    }
    _match_fail("line 15950");
  }
  return _t1339;
}
function Types$deep_repr_eff(eff) {
  let _t1342;
  const _t1341 = Types$eff_repr(eff);
  _t1343: {
    if (_t1341._tag === 2) {
      const label = _t1341._val[0];
      const params = _t1341._val[1];
      const tail = _t1341._val[2];
      _t1342 = ({_tag: 2, _name: "EffRow", _val: [label, List$map(Types$deep_repr, params), Types$deep_repr_eff(tail)]});
      break _t1343;
    }
    if (true) {
      const e = _t1341;
      _t1342 = e;
      break _t1343;
    }
    _match_fail("line 15950");
  }
  return _t1342;
}
function Types$deep_repr_pv(row) {
  let _t1345;
  const _t1344 = Types$pv_repr(row);
  _t1346: {
    if (_t1344._tag === 0) {
      const tag = _t1344._val[0];
      const ty_opt = _t1344._val[1];
      const tail = _t1344._val[2];
      _t1345 = ({_tag: 0, _name: "PVRow", _val: [tag, Option$map(Types$deep_repr, ty_opt), Types$deep_repr_pv(tail)]});
      break _t1346;
    }
    if (true) {
      const r = _t1344;
      _t1345 = r;
      break _t1346;
    }
    _match_fail("line 15950");
  }
  return _t1345;
}
function Types$deep_repr_rrow(row) {
  let _t1348;
  const _t1347 = Types$rrow_repr(row);
  _t1349: {
    if (_t1347._tag === 0) {
      const name = _t1347._val[0];
      const ty = _t1347._val[1];
      const tail = _t1347._val[2];
      _t1348 = ({_tag: 0, _name: "RRow", _val: [name, Types$deep_repr(ty), Types$deep_repr_rrow(tail)]});
      break _t1349;
    }
    if (true) {
      const r = _t1347;
      _t1348 = r;
      break _t1349;
    }
    _match_fail("line 15950");
  }
  return _t1348;
}
function Types$types_compatible(t1, t2) {
  while (true) {
    const t1_1350 = Types$repr(t1);
    const t2_1352 = Types$repr(t2);
    let _t1355;
    const _t1354 = [t1_1350, t2_1352];
    _t1356: {
      if ((_t1354[0]._tag === 16 || _t1354[1]._tag === 16)) {
        _t1355 = true;
        break _t1356;
      }
      if (((((((_t1354[0]._tag === 0 && _t1354[1]._tag === 0 || _t1354[0]._tag === 1 && _t1354[1]._tag === 1) || _t1354[0]._tag === 2 && _t1354[1]._tag === 2) || _t1354[0]._tag === 3 && _t1354[1]._tag === 3) || _t1354[0]._tag === 4 && _t1354[1]._tag === 4) || _t1354[0]._tag === 5 && _t1354[1]._tag === 5) || _t1354[0]._tag === 6 && _t1354[1]._tag === 6)) {
        _t1355 = true;
        break _t1356;
      }
      if ((_t1354[0]._tag === 7 && _t1354[1]._tag === 7 || _t1354[0]._tag === 8 && _t1354[1]._tag === 8)) {
        const a1 = _t1354[0]._val[0];
        const r1 = _t1354[0]._val[2];
        const a2 = _t1354[1]._val[0];
        const r2 = _t1354[1]._val[2];
        _t1355 = (Types$types_compatible(a1, a2) && Types$types_compatible(r1, r2));
        break _t1356;
      }
      if (_t1354[0]._tag === 9 && _t1354[1]._tag === 9) {
        const ts1 = _t1354[0]._val;
        const ts2 = _t1354[1]._val;
        _t1355 = ((List$length(ts1) === List$length(ts2)) && List$forall2(Types$types_compatible, ts1, ts2));
        break _t1356;
      }
      if (_t1354[0]._tag === 10 && _t1354[1]._tag === 10) {
        const t1 = _t1354[0]._val;
        const t2 = _t1354[1]._val;
        const _t1357 = t1;
        const _t1358 = t2;
        t1 = _t1357;
        t2 = _t1358;
        continue;
        _t1355 = undefined;
        break _t1356;
      }
      if (_t1354[0]._tag === 14 && _t1354[1]._tag === 14) {
        const t1 = _t1354[0]._val;
        const t2 = _t1354[1]._val;
        const _t1359 = t1;
        const _t1360 = t2;
        t1 = _t1359;
        t2 = _t1360;
        continue;
        _t1355 = undefined;
        break _t1356;
      }
      if (_t1354[0]._tag === 13 && _t1354[1]._tag === 13) {
        const k1 = _t1354[0]._val[0];
        const v1 = _t1354[0]._val[1];
        const k2 = _t1354[1]._val[0];
        const v2 = _t1354[1]._val[1];
        _t1355 = (Types$types_compatible(k1, k2) && Types$types_compatible(v1, v2));
        break _t1356;
      }
      if (_t1354[0]._tag === 11 && _t1354[1]._tag === 11) {
        const r1 = _t1354[0]._val;
        const r2 = _t1354[1]._val;
        const f1_1361 = Types$record_row_to_fields(r1);
        const f2_1363 = Types$record_row_to_fields(r2);
        let _t1372;
        if ((List$length(f1_1361) === List$length(f2_1363))) {
        function _t1365(__p18, __p19) {
          let _t1367;
          const _t1366 = __p18;
          _t1368: {
            if (true) {
              const n1 = _t1366[0];
              const t1 = _t1366[1];
              let _t1370;
              const _t1369 = __p19;
              _t1371: {
                if (true) {
                  const n2 = _t1369[0];
                  const t2 = _t1369[1];
                  _t1370 = ((n1 === n2) && Types$types_compatible(t1, t2));
                  break _t1371;
                }
                _match_fail("line 15950");
              }
              _t1367 = _t1370;
              break _t1368;
            }
            _match_fail("line 15950");
          }
          return _t1367;
        }
          _t1372 = List$forall2(_t1365, f1_1361, f2_1363);
        } else {
          _t1372 = false;
        }
        const _t1364 = _t1372;
        const _t1362 = _t1364;
        _t1355 = _t1362;
        break _t1356;
      }
      if (_t1354[0]._tag === 12 && _t1354[1]._tag === 12) {
        const a = _t1354[0]._val[0];
        const args_a = _t1354[0]._val[1];
        const b = _t1354[1]._val[0];
        const args_b = _t1354[1]._val[1];
        _t1355 = ((a === b) && ((List$length(args_a) === List$length(args_b)) && List$forall2(Types$types_compatible, args_a, args_b)));
        break _t1356;
      }
      if (_t1354[0]._tag === 15 && _t1354[1]._tag === 15) {
        const r1 = _t1354[0]._val;
        const r2 = _t1354[1]._val;
        _t1355 = Types$pvrows_compatible(r1, r2);
        break _t1356;
      }
      if (true) {
        _t1355 = false;
        break _t1356;
      }
      _match_fail("line 15950");
    }
    const _t1353 = _t1355;
    const _t1351 = _t1353;
    return _t1351;
  }
}
function Types$pvrows_compatible(r1, r2) {
  function collect(r) {
    let _t1374;
    const _t1373 = Types$pv_repr(r);
    _t1375: {
      if (_t1373._tag === 0) {
        const tag = _t1373._val[0];
        const ty_opt = _t1373._val[1];
        const tail = _t1373._val[2];
        _t1374 = ({_hd: [tag, ty_opt], _tl: collect(tail)});
        break _t1375;
      }
      if (true) {
        _t1374 = null;
        break _t1375;
      }
      _match_fail("line 15950");
    }
    return _t1374;
  }
  const tags1_1377 = collect(r1);
  const tags2_1379 = collect(r2);
  let _t1392;
  if ((List$length(tags1_1377) === List$length(tags2_1379))) {
  function _t1381(__p20, __p21) {
    let _t1383;
    const _t1382 = __p20;
    _t1384: {
      if (true) {
        const t1 = _t1382[0];
        const ty1 = _t1382[1];
        let _t1386;
        const _t1385 = __p21;
        _t1387: {
          if (true) {
            const t2 = _t1385[0];
            const ty2 = _t1385[1];
            let _t1391;
            if ((t1 === t2)) {
            let _t1389;
            const _t1388 = [ty1, ty2];
            _t1390: {
              if (_t1388[0]._tag === 0 && _t1388[1]._tag === 0) {
                _t1389 = true;
                break _t1390;
              }
              if (_t1388[0]._tag === 1 && _t1388[1]._tag === 1) {
                const a = _t1388[0]._val;
                const b = _t1388[1]._val;
                _t1389 = Types$types_compatible(a, b);
                break _t1390;
              }
              if (true) {
                _t1389 = false;
                break _t1390;
              }
              _match_fail("line 15950");
            }
              _t1391 = _t1389;
            } else {
              _t1391 = false;
            }
            _t1386 = _t1391;
            break _t1387;
          }
          _match_fail("line 15950");
        }
        _t1383 = _t1386;
        break _t1384;
      }
      _match_fail("line 15950");
    }
    return _t1383;
  }
    _t1392 = List$forall2(_t1381, tags1_1377, tags2_1379);
  } else {
    _t1392 = false;
  }
  const _t1380 = _t1392;
  const _t1378 = _t1380;
  const _t1376 = _t1378;
  return _t1376;
}
function Types$subtype(t1, t2) {
  while (true) {
    const t1_1393 = Types$repr(t1);
    const t2_1395 = Types$repr(t2);
    let _t1398;
    const _t1397 = [t1_1393, t2_1395];
    _t1399: {
      if (((((((_t1397[0]._tag === 0 && _t1397[1]._tag === 0 || _t1397[0]._tag === 1 && _t1397[1]._tag === 1) || _t1397[0]._tag === 2 && _t1397[1]._tag === 2) || _t1397[0]._tag === 3 && _t1397[1]._tag === 3) || _t1397[0]._tag === 4 && _t1397[1]._tag === 4) || _t1397[0]._tag === 5 && _t1397[1]._tag === 5) || _t1397[0]._tag === 6 && _t1397[1]._tag === 6)) {
        _t1398 = true;
        break _t1399;
      }
      if (_t1397[0]._tag === 12 && _t1397[1]._tag === 12) {
        const a = _t1397[0]._val[0];
        const args_a = _t1397[0]._val[1];
        const b = _t1397[1]._val[0];
        const args_b = _t1397[1]._val[1];
        _t1398 = ((a === b) && ((List$length(args_a) === List$length(args_b)) && List$forall2(Types$subtype, args_a, args_b)));
        break _t1399;
      }
      if ((_t1397[0]._tag === 7 && _t1397[1]._tag === 7 || _t1397[0]._tag === 8 && _t1397[1]._tag === 8)) {
        const a1 = _t1397[0]._val[0];
        const _e1 = _t1397[0]._val[1];
        const r1 = _t1397[0]._val[2];
        const a2 = _t1397[1]._val[0];
        const _e2 = _t1397[1]._val[1];
        const r2 = _t1397[1]._val[2];
        _t1398 = (Types$subtype(a2, a1) && Types$subtype(r1, r2));
        break _t1399;
      }
      if (_t1397[0]._tag === 11 && _t1397[1]._tag === 11) {
        const r1 = _t1397[0]._val;
        const r2 = _t1397[1]._val;
        const f1_1400 = Types$record_row_to_fields(r1);
        const f2_1402 = Types$record_row_to_fields(r2);
        function _t1404(__p22) {
          let _t1406;
          const _t1405 = __p22;
          _t1407: {
            if (true) {
              const f = _t1405[0];
              const t2$p = _t1405[1];
              let _t1409;
              const _t1408 = List$assoc_opt(f, f1_1400);
              _t1410: {
                if (_t1408._tag === 1) {
                  const t1$p = _t1408._val;
                  _t1409 = Types$subtype(t1$p, t2$p);
                  break _t1410;
                }
                if (_t1408._tag === 0) {
                  _t1409 = false;
                  break _t1410;
                }
                _match_fail("line 15950");
              }
              _t1406 = _t1409;
              break _t1407;
            }
            _match_fail("line 15950");
          }
          return _t1406;
        }
        const _t1403 = List$forall(_t1404, f2_1402);
        const _t1401 = _t1403;
        _t1398 = _t1401;
        break _t1399;
      }
      if (_t1397[0]._tag === 10 && _t1397[1]._tag === 10) {
        const t1$p = _t1397[0]._val;
        const t2$p = _t1397[1]._val;
        const _t1411 = t1$p;
        const _t1412 = t2$p;
        t1 = _t1411;
        t2 = _t1412;
        continue;
        _t1398 = undefined;
        break _t1399;
      }
      if (_t1397[0]._tag === 14 && _t1397[1]._tag === 14) {
        const t1$p = _t1397[0]._val;
        const t2$p = _t1397[1]._val;
        const _t1413 = t1$p;
        const _t1414 = t2$p;
        t1 = _t1413;
        t2 = _t1414;
        continue;
        _t1398 = undefined;
        break _t1399;
      }
      if (_t1397[0]._tag === 13 && _t1397[1]._tag === 13) {
        const k1 = _t1397[0]._val[0];
        const v1 = _t1397[0]._val[1];
        const k2 = _t1397[1]._val[0];
        const v2 = _t1397[1]._val[1];
        _t1398 = (Types$subtype(k1, k2) && Types$subtype(v1, v2));
        break _t1399;
      }
      if (_t1397[0]._tag === 9 && _t1397[1]._tag === 9) {
        const ts1 = _t1397[0]._val;
        const ts2 = _t1397[1]._val;
        _t1398 = ((List$length(ts1) === List$length(ts2)) && List$forall2(Types$subtype, ts1, ts2));
        break _t1399;
      }
      if (_t1397[0]._tag === 16 && _t1397[1]._tag === 16) {
        const r1 = _t1397[0]._val;
        const r2 = _t1397[1]._val;
        if (_eq(r1, r2)) {
          _t1398 = true;
          break _t1399;
        }
      }
      if (true) {
        _t1398 = false;
        break _t1399;
      }
      _match_fail("line 15950");
    }
    const _t1396 = _t1398;
    const _t1394 = _t1396;
    return _t1394;
  }
}
function Types$equal_ty(t1, t2) {
  while (true) {
    const t1_1415 = Types$repr(t1);
    const t2_1417 = Types$repr(t2);
    let _t1420;
    const _t1419 = [t1_1415, t2_1417];
    _t1421: {
      if (((((((_t1419[0]._tag === 0 && _t1419[1]._tag === 0 || _t1419[0]._tag === 1 && _t1419[1]._tag === 1) || _t1419[0]._tag === 2 && _t1419[1]._tag === 2) || _t1419[0]._tag === 3 && _t1419[1]._tag === 3) || _t1419[0]._tag === 4 && _t1419[1]._tag === 4) || _t1419[0]._tag === 5 && _t1419[1]._tag === 5) || _t1419[0]._tag === 6 && _t1419[1]._tag === 6)) {
        _t1420 = true;
        break _t1421;
      }
      if (_t1419[0]._tag === 12 && _t1419[1]._tag === 12) {
        const a = _t1419[0]._val[0];
        const args_a = _t1419[0]._val[1];
        const b = _t1419[1]._val[0];
        const args_b = _t1419[1]._val[1];
        _t1420 = ((a === b) && ((List$length(args_a) === List$length(args_b)) && List$forall2(Types$equal_ty, args_a, args_b)));
        break _t1421;
      }
      if ((_t1419[0]._tag === 7 && _t1419[1]._tag === 7 || _t1419[0]._tag === 8 && _t1419[1]._tag === 8)) {
        const a1 = _t1419[0]._val[0];
        const _e1 = _t1419[0]._val[1];
        const r1 = _t1419[0]._val[2];
        const a2 = _t1419[1]._val[0];
        const _e2 = _t1419[1]._val[1];
        const r2 = _t1419[1]._val[2];
        _t1420 = (Types$equal_ty(a1, a2) && Types$equal_ty(r1, r2));
        break _t1421;
      }
      if (_t1419[0]._tag === 11 && _t1419[1]._tag === 11) {
        const r1 = _t1419[0]._val;
        const r2 = _t1419[1]._val;
        const f1_1422 = Types$record_row_to_fields(r1);
        const f2_1424 = Types$record_row_to_fields(r2);
        let _t1433;
        if ((List$length(f1_1422) === List$length(f2_1424))) {
        function _t1426(__p23, __p24) {
          let _t1428;
          const _t1427 = __p23;
          _t1429: {
            if (true) {
              const n1 = _t1427[0];
              const t1 = _t1427[1];
              let _t1431;
              const _t1430 = __p24;
              _t1432: {
                if (true) {
                  const n2 = _t1430[0];
                  const t2 = _t1430[1];
                  _t1431 = ((n1 === n2) && Types$equal_ty(t1, t2));
                  break _t1432;
                }
                _match_fail("line 15950");
              }
              _t1428 = _t1431;
              break _t1429;
            }
            _match_fail("line 15950");
          }
          return _t1428;
        }
          _t1433 = List$forall2(_t1426, f1_1422, f2_1424);
        } else {
          _t1433 = false;
        }
        const _t1425 = _t1433;
        const _t1423 = _t1425;
        _t1420 = _t1423;
        break _t1421;
      }
      if (_t1419[0]._tag === 10 && _t1419[1]._tag === 10) {
        const t1$p = _t1419[0]._val;
        const t2$p = _t1419[1]._val;
        const _t1434 = t1$p;
        const _t1435 = t2$p;
        t1 = _t1434;
        t2 = _t1435;
        continue;
        _t1420 = undefined;
        break _t1421;
      }
      if (_t1419[0]._tag === 14 && _t1419[1]._tag === 14) {
        const t1$p = _t1419[0]._val;
        const t2$p = _t1419[1]._val;
        const _t1436 = t1$p;
        const _t1437 = t2$p;
        t1 = _t1436;
        t2 = _t1437;
        continue;
        _t1420 = undefined;
        break _t1421;
      }
      if (_t1419[0]._tag === 13 && _t1419[1]._tag === 13) {
        const k1 = _t1419[0]._val[0];
        const v1 = _t1419[0]._val[1];
        const k2 = _t1419[1]._val[0];
        const v2 = _t1419[1]._val[1];
        _t1420 = (Types$equal_ty(k1, k2) && Types$equal_ty(v1, v2));
        break _t1421;
      }
      if (_t1419[0]._tag === 9 && _t1419[1]._tag === 9) {
        const ts1 = _t1419[0]._val;
        const ts2 = _t1419[1]._val;
        _t1420 = ((List$length(ts1) === List$length(ts2)) && List$forall2(Types$equal_ty, ts1, ts2));
        break _t1421;
      }
      if (_t1419[0]._tag === 16 && _t1419[1]._tag === 16) {
        const r1 = _t1419[0]._val;
        const r2 = _t1419[1]._val;
        _t1420 = _eq(r1, r2);
        break _t1421;
      }
      if (true) {
        _t1420 = false;
        break _t1421;
      }
      _match_fail("line 15950");
    }
    const _t1418 = _t1420;
    const _t1416 = _t1418;
    return _t1416;
  }
}
function Types$freshen_unbound(ty) {
  const tbl_1438 = Hashtbl$create(4);
  function go(ty) {
    let _t1441;
    const _t1440 = Types$repr(ty);
    _t1442: {
      if (_t1440._tag === 16 && _t1440._val.contents._tag === 0) {
        const id = _t1440._val.contents._val[0];
        const level = _t1440._val.contents._val[1];
        let _t1444;
        const _t1443 = _call(Hashtbl$get, [__dict_Hash_int, __dict_Eq_int, tbl_1438, id]);
        _t1445: {
          if (_t1443._tag === 1) {
            const tv = _t1443._val;
            _t1444 = tv;
            break _t1445;
          }
          if (_t1443._tag === 0) {
            const tv_1446 = Types$new_tvar(level);
            _call(Hashtbl$set, [__dict_Hash_int, __dict_Eq_int, tbl_1438, id, tv_1446]);
            const _t1447 = tv_1446;
            _t1444 = _t1447;
            break _t1445;
          }
          _match_fail("line 15950");
        }
        _t1441 = _t1444;
        break _t1442;
      }
      if (_t1440._tag === 7) {
        const a = _t1440._val[0];
        const eff = _t1440._val[1];
        const r = _t1440._val[2];
        _t1441 = ({_tag: 7, _name: "TArrow", _val: [go(a), go_eff(eff), go(r)]});
        break _t1442;
      }
      if (_t1440._tag === 8) {
        const a = _t1440._val[0];
        const eff = _t1440._val[1];
        const r = _t1440._val[2];
        _t1441 = ({_tag: 8, _name: "TCont", _val: [go(a), go_eff(eff), go(r)]});
        break _t1442;
      }
      if (_t1440._tag === 9) {
        const ts = _t1440._val;
        _t1441 = ({_tag: 9, _name: "TTuple", _val: List$map(go, ts)});
        break _t1442;
      }
      if (_t1440._tag === 10) {
        const t = _t1440._val;
        _t1441 = ({_tag: 10, _name: "TList", _val: go(t)});
        break _t1442;
      }
      if (_t1440._tag === 14) {
        const t = _t1440._val;
        _t1441 = ({_tag: 14, _name: "TArray", _val: go(t)});
        break _t1442;
      }
      if (_t1440._tag === 13) {
        const k = _t1440._val[0];
        const v = _t1440._val[1];
        _t1441 = ({_tag: 13, _name: "TMap", _val: [go(k), go(v)]});
        break _t1442;
      }
      if (_t1440._tag === 11) {
        const row = _t1440._val;
        _t1441 = ({_tag: 11, _name: "TRecord", _val: go_rrow(row)});
        break _t1442;
      }
      if (_t1440._tag === 15) {
        const row = _t1440._val;
        _t1441 = ({_tag: 15, _name: "TPolyVariant", _val: go_pv(row)});
        break _t1442;
      }
      if (_t1440._tag === 12) {
        const name = _t1440._val[0];
        const args = _t1440._val[1];
        _t1441 = ({_tag: 12, _name: "TVariant", _val: [name, List$map(go, args)]});
        break _t1442;
      }
      if (true) {
        const t = _t1440;
        _t1441 = t;
        break _t1442;
      }
      _match_fail("line 15950");
    }
    return _t1441;
  }
  function go_eff(eff) {
    let _t1449;
    const _t1448 = Types$eff_repr(eff);
    _t1450: {
      if (_t1448._tag === 2) {
        const label = _t1448._val[0];
        const tys = _t1448._val[1];
        const tail = _t1448._val[2];
        _t1449 = ({_tag: 2, _name: "EffRow", _val: [label, List$map(go, tys), go_eff(tail)]});
        break _t1450;
      }
      if (true) {
        const e = _t1448;
        _t1449 = e;
        break _t1450;
      }
      _match_fail("line 15950");
    }
    return _t1449;
  }
  function go_rrow(__x) {
    let _t1452;
    const _t1451 = __x;
    _t1453: {
      if (_t1451._tag === 0) {
        const name = _t1451._val[0];
        const ty = _t1451._val[1];
        const tail = _t1451._val[2];
        _t1452 = ({_tag: 0, _name: "RRow", _val: [name, go(ty), go_rrow(tail)]});
        break _t1453;
      }
      if (true) {
        const r = _t1451;
        _t1452 = r;
        break _t1453;
      }
      _match_fail("line 15950");
    }
    return _t1452;
  }
  function go_pv(__x) {
    let _t1455;
    const _t1454 = __x;
    _t1456: {
      if (_t1454._tag === 0) {
        const tag = _t1454._val[0];
        const payload = _t1454._val[1];
        const tail = _t1454._val[2];
        _t1455 = ({_tag: 0, _name: "PVRow", _val: [tag, Option$map(go, payload), go_pv(tail)]});
        break _t1456;
      }
      if (true) {
        const p = _t1454;
        _t1455 = p;
        break _t1456;
      }
      _match_fail("line 15950");
    }
    return _t1455;
  }
  const _t1457 = go(ty);
  const _t1439 = _t1457;
  return _t1439;
}
function Types$match_partial_inst(inst_tys, partial) {
  let _t1459;
  const _t1458 = Hashtbl$create(4);
  _t1460: {
    if (true) {
      const bindings = _t1458;
      function match_one(inst, conc) {
        while (true) {
          let _t1462;
          const _t1461 = inst;
          _t1463: {
            if (_t1461._tag === 17) {
              const i = _t1461._val;
              let _t1465;
              const _t1464 = _call(Hashtbl$get, [__dict_Hash_int, __dict_Eq_int, bindings, i]);
              _t1466: {
                if (_t1464._tag === 1) {
                  const prev = _t1464._val;
                  let _t1467;
                  if (Types$equal_ty(prev, conc)) {
                    _t1467 = true;
                  } else {
                    const _t1468 = (function() {
                      const _t1469 = _h;
                      _h = Object.assign({}, _t1469, {
                        "unify_error": function(_, __k) { throw {_e: "unify_error", _v: _}; },
                      });
                      try {
                        Types$unify(prev, conc);
                        const __x_1470 = true;
                        return __x_1470;
                      } catch (_exc) {
                        if (_exc && _exc._e === "unify_error") {
                          const _ = _exc._v;
                          return false;
                        } else { throw _exc; }
                      } finally { _h = _t1469; }
                    })();
                    _t1467 = _t1468;
                  }
                  _t1465 = _t1467;
                  break _t1466;
                }
                if (_t1464._tag === 0) {
                  _call(Hashtbl$set, [__dict_Hash_int, __dict_Eq_int, bindings, i, conc]);
                  _t1465 = true;
                  break _t1466;
                }
                _match_fail("line 15950");
              }
              _t1462 = _t1465;
              break _t1463;
            }
            if (_t1461._tag === 0) {
              let _t1472;
              const _t1471 = Types$repr(conc);
              _t1473: {
                if (_t1471._tag === 0) {
                  _t1472 = true;
                  break _t1473;
                }
                if (true) {
                  _t1472 = false;
                  break _t1473;
                }
                _match_fail("line 15950");
              }
              _t1462 = _t1472;
              break _t1463;
            }
            if (_t1461._tag === 1) {
              let _t1475;
              const _t1474 = Types$repr(conc);
              _t1476: {
                if (_t1474._tag === 1) {
                  _t1475 = true;
                  break _t1476;
                }
                if (true) {
                  _t1475 = false;
                  break _t1476;
                }
                _match_fail("line 15950");
              }
              _t1462 = _t1475;
              break _t1463;
            }
            if (_t1461._tag === 2) {
              let _t1478;
              const _t1477 = Types$repr(conc);
              _t1479: {
                if (_t1477._tag === 2) {
                  _t1478 = true;
                  break _t1479;
                }
                if (true) {
                  _t1478 = false;
                  break _t1479;
                }
                _match_fail("line 15950");
              }
              _t1462 = _t1478;
              break _t1463;
            }
            if (_t1461._tag === 3) {
              let _t1481;
              const _t1480 = Types$repr(conc);
              _t1482: {
                if (_t1480._tag === 3) {
                  _t1481 = true;
                  break _t1482;
                }
                if (true) {
                  _t1481 = false;
                  break _t1482;
                }
                _match_fail("line 15950");
              }
              _t1462 = _t1481;
              break _t1463;
            }
            if (_t1461._tag === 6) {
              let _t1484;
              const _t1483 = Types$repr(conc);
              _t1485: {
                if (_t1483._tag === 6) {
                  _t1484 = true;
                  break _t1485;
                }
                if (true) {
                  _t1484 = false;
                  break _t1485;
                }
                _match_fail("line 15950");
              }
              _t1462 = _t1484;
              break _t1463;
            }
            if (_t1461._tag === 10) {
              const a = _t1461._val;
              let _t1487;
              const _t1486 = Types$repr(conc);
              _t1488: {
                if (_t1486._tag === 10) {
                  const b = _t1486._val;
                  const _t1489 = a;
                  const _t1490 = b;
                  inst = _t1489;
                  conc = _t1490;
                  continue;
                  _t1487 = undefined;
                  break _t1488;
                }
                if (true) {
                  _t1487 = false;
                  break _t1488;
                }
                _match_fail("line 15950");
              }
              _t1462 = _t1487;
              break _t1463;
            }
            if (_t1461._tag === 14) {
              const a = _t1461._val;
              let _t1492;
              const _t1491 = Types$repr(conc);
              _t1493: {
                if (_t1491._tag === 14) {
                  const b = _t1491._val;
                  const _t1494 = a;
                  const _t1495 = b;
                  inst = _t1494;
                  conc = _t1495;
                  continue;
                  _t1492 = undefined;
                  break _t1493;
                }
                if (true) {
                  _t1492 = false;
                  break _t1493;
                }
                _match_fail("line 15950");
              }
              _t1462 = _t1492;
              break _t1463;
            }
            if (_t1461._tag === 13) {
              const k1 = _t1461._val[0];
              const v1 = _t1461._val[1];
              let _t1497;
              const _t1496 = Types$repr(conc);
              _t1498: {
                if (_t1496._tag === 13) {
                  const k2 = _t1496._val[0];
                  const v2 = _t1496._val[1];
                  _t1497 = (match_one(k1, k2) && match_one(v1, v2));
                  break _t1498;
                }
                if (true) {
                  _t1497 = false;
                  break _t1498;
                }
                _match_fail("line 15950");
              }
              _t1462 = _t1497;
              break _t1463;
            }
            if (_t1461._tag === 9) {
              const ts1 = _t1461._val;
              let _t1500;
              const _t1499 = Types$repr(conc);
              _t1501: {
                if (_t1499._tag === 9) {
                  const ts2 = _t1499._val;
                  if ((List$length(ts1) === List$length(ts2))) {
                    _t1500 = List$forall2(match_one, ts1, ts2);
                    break _t1501;
                  }
                }
                if (true) {
                  _t1500 = false;
                  break _t1501;
                }
                _match_fail("line 15950");
              }
              _t1462 = _t1500;
              break _t1463;
            }
            if (_t1461._tag === 7) {
              const a1 = _t1461._val[0];
              const _e1 = _t1461._val[1];
              const a2 = _t1461._val[2];
              let _t1503;
              const _t1502 = Types$repr(conc);
              _t1504: {
                if (_t1502._tag === 7) {
                  const b1 = _t1502._val[0];
                  const _e2 = _t1502._val[1];
                  const b2 = _t1502._val[2];
                  _t1503 = (match_one(a1, b1) && match_one(a2, b2));
                  break _t1504;
                }
                if (true) {
                  _t1503 = false;
                  break _t1504;
                }
                _match_fail("line 15950");
              }
              _t1462 = _t1503;
              break _t1463;
            }
            if (_t1461._tag === 8) {
              const a1 = _t1461._val[0];
              const _e1 = _t1461._val[1];
              const a2 = _t1461._val[2];
              let _t1506;
              const _t1505 = Types$repr(conc);
              _t1507: {
                if (_t1505._tag === 8) {
                  const b1 = _t1505._val[0];
                  const _e2 = _t1505._val[1];
                  const b2 = _t1505._val[2];
                  _t1506 = (match_one(a1, b1) && match_one(a2, b2));
                  break _t1507;
                }
                if (true) {
                  _t1506 = false;
                  break _t1507;
                }
                _match_fail("line 15950");
              }
              _t1462 = _t1506;
              break _t1463;
            }
            if (_t1461._tag === 11) {
              const r1 = _t1461._val;
              let _t1509;
              const _t1508 = Types$repr(conc);
              _t1510: {
                if (_t1508._tag === 11) {
                  const r2 = _t1508._val;
                  const f1_1511 = Types$record_row_to_fields(r1);
                  const f2_1513 = Types$record_row_to_fields(r2);
                  let _t1522;
                  if ((List$length(f1_1511) === List$length(f2_1513))) {
                  function _t1515(__p25, __p26) {
                    let _t1517;
                    const _t1516 = __p25;
                    _t1518: {
                      if (true) {
                        const n1 = _t1516[0];
                        const t1 = _t1516[1];
                        let _t1520;
                        const _t1519 = __p26;
                        _t1521: {
                          if (true) {
                            const n2 = _t1519[0];
                            const t2 = _t1519[1];
                            _t1520 = ((n1 === n2) && match_one(t1, t2));
                            break _t1521;
                          }
                          _match_fail("line 15950");
                        }
                        _t1517 = _t1520;
                        break _t1518;
                      }
                      _match_fail("line 15950");
                    }
                    return _t1517;
                  }
                    _t1522 = List$forall2(_t1515, f1_1511, f2_1513);
                  } else {
                    _t1522 = false;
                  }
                  const _t1514 = _t1522;
                  const _t1512 = _t1514;
                  _t1509 = _t1512;
                  break _t1510;
                }
                if (true) {
                  _t1509 = false;
                  break _t1510;
                }
                _match_fail("line 15950");
              }
              _t1462 = _t1509;
              break _t1463;
            }
            if (_t1461._tag === 12) {
              const a = _t1461._val[0];
              const args_inst = _t1461._val[1];
              let _t1524;
              const _t1523 = Types$repr(conc);
              _t1525: {
                if (_t1523._tag === 12) {
                  const b = _t1523._val[0];
                  const args_conc = _t1523._val[1];
                  if (((a === b) && (List$length(args_inst) === List$length(args_conc)))) {
                    _t1524 = List$forall2(match_one, args_inst, args_conc);
                    break _t1525;
                  }
                }
                if (true) {
                  _t1524 = false;
                  break _t1525;
                }
                _match_fail("line 15950");
              }
              _t1462 = _t1524;
              break _t1463;
            }
            if (true) {
              _t1462 = Types$equal_ty(inst, conc);
              break _t1463;
            }
            _match_fail("line 15950");
          }
          return _t1462;
        }
      }
      let _t1531;
      if ((List$length(inst_tys) === List$length(partial))) {
      function _t1527(inst_ty, found_opt) {
        let _t1529;
        const _t1528 = found_opt;
        _t1530: {
          if (_t1528._tag === 0) {
            _t1529 = true;
            break _t1530;
          }
          if (_t1528._tag === 1) {
            const conc_ty = _t1528._val;
            _t1529 = match_one(inst_ty, conc_ty);
            break _t1530;
          }
          _match_fail("line 15950");
        }
        return _t1529;
      }
        _t1531 = List$forall2(_t1527, inst_tys, partial);
      } else {
        _t1531 = false;
      }
      const _t1526 = _t1531;
      _t1459 = _t1526;
      break _t1460;
    }
    _match_fail("line 15950");
  }
  return _t1459;
}
function Types$inst_specificity(inst) {
  function count(__x) {
    while (true) {
      let _t1533;
      const _t1532 = __x;
      _t1534: {
        if (_t1532._tag === 17) {
          _t1533 = 0;
          break _t1534;
        }
        if (((((((_t1532._tag === 0 || _t1532._tag === 1) || _t1532._tag === 2) || _t1532._tag === 3) || _t1532._tag === 4) || _t1532._tag === 5) || _t1532._tag === 6)) {
          _t1533 = 1;
          break _t1534;
        }
        if ((_t1532._tag === 7 || _t1532._tag === 8)) {
          const a = _t1532._val[0];
          const b = _t1532._val[2];
          _t1533 = (count(a) + count(b));
          break _t1534;
        }
        if (_t1532._tag === 9) {
          const ts = _t1532._val;
          function _t1535(acc, t) {
            return (acc + count(t));
          }
          _t1533 = List$fold(_t1535, 0, ts);
          break _t1534;
        }
        if ((_t1532._tag === 10 || _t1532._tag === 14)) {
          const a = _t1532._val;
          const _t1536 = a;
          __x = _t1536;
          continue;
          _t1533 = undefined;
          break _t1534;
        }
        if (_t1532._tag === 13) {
          const k = _t1532._val[0];
          const v = _t1532._val[1];
          _t1533 = (count(k) + count(v));
          break _t1534;
        }
        if (_t1532._tag === 11) {
          const row = _t1532._val;
          function _t1537(acc, __p27) {
            let _t1539;
            const _t1538 = __p27;
            _t1540: {
              if (true) {
                const t = _t1538[1];
                _t1539 = (acc + count(t));
                break _t1540;
              }
              _match_fail("line 15950");
            }
            return _t1539;
          }
          _t1533 = List$fold(_t1537, 0, Types$record_row_to_fields(row));
          break _t1534;
        }
        if (_t1532._tag === 12) {
          const ts = _t1532._val[1];
          function _t1541(acc, t) {
            return (acc + count(t));
          }
          _t1533 = List$fold(_t1541, 0, ts);
          break _t1534;
        }
        if (_t1532._tag === 15) {
          _t1533 = 0;
          break _t1534;
        }
        if (_t1532._tag === 16 && _t1532._val.contents._tag === 1) {
          const t = _t1532._val.contents._val;
          const _t1542 = t;
          __x = _t1542;
          continue;
          _t1533 = undefined;
          break _t1534;
        }
        if (_t1532._tag === 16 && _t1532._val.contents._tag === 0) {
          _t1533 = 0;
          break _t1534;
        }
        _match_fail("line 15950");
      }
      return _t1533;
    }
  }
  function _t1544(acc, ty) {
    return (acc + count(ty));
  }
  const _t1543 = List$fold(_t1544, 0, inst.inst_tys);
  return _t1543;
}
function Types$most_specific_inst(insts) {
  let _t1546;
  const _t1545 = insts;
  _t1547: {
    if (_t1545 === null) {
      _t1546 = ({_tag: 0, _name: "None"});
      break _t1547;
    }
    if (_t1545 !== null && _t1545._tl === null) {
      const x = _t1545._hd;
      _t1546 = ({_tag: 1, _name: "Some", _val: x});
      break _t1547;
    }
    if (true) {
      function _t1548(i) {
        return [Types$inst_specificity(i), i];
      }
      const scored_1549 = List$map(_t1548, insts);
      function _t1551(__p28, __p29) {
        let _t1553;
        const _t1552 = __p28;
        _t1554: {
          if (true) {
            const a = _t1552[0];
            let _t1556;
            const _t1555 = __p29;
            _t1557: {
              if (true) {
                const b = _t1555[0];
                _t1556 = compare(b, a);
                break _t1557;
              }
              _match_fail("line 15950");
            }
            _t1553 = _t1556;
            break _t1554;
          }
          _match_fail("line 15950");
        }
        return _t1553;
      }
      const sorted_1558 = List$sort(_t1551, scored_1549);
      let _t1561;
      const _t1560 = sorted_1558;
      _t1562: {
        if (_t1560 !== null && _t1560._tl !== null) {
          const s1 = _t1560._hd[0];
          const i1 = _t1560._hd[1];
          const s2 = _t1560._tl._hd[0];
          if ((s1 > s2)) {
            _t1561 = ({_tag: 1, _name: "Some", _val: i1});
            break _t1562;
          }
        }
        if (true) {
          _t1561 = ({_tag: 0, _name: "None"});
          break _t1562;
        }
        _match_fail("line 15950");
      }
      const _t1559 = _t1561;
      const _t1550 = _t1559;
      _t1546 = _t1550;
      break _t1547;
    }
    _match_fail("line 15950");
  }
  return _t1546;
}
function Types$find_instance(instances, class_name, tys) {
  function _t1563(inst) {
    let _t1565;
    if ((inst.inst_class === class_name)) {
    function _t1564(t) {
      return ({_tag: 1, _name: "Some", _val: t});
    }
      _t1565 = Types$match_partial_inst(inst.inst_tys, List$map(_t1564, tys));
    } else {
      _t1565 = false;
    }
    return _t1565;
  }
  return List$find(_t1563, instances);
}
function Types$check_fundep_consistency(class_def, new_inst, existing_instances) {
  return _trampoline(function() {
    function _t1566(fd) {
      return _trampoline(function() {
        function _t1567(existing) {
          return _trampoline(function() {
            if ((!(existing.inst_class === new_inst.inst_class))) {
              return undefined;
            } else {
              if ((List$length(existing.inst_tys) !== List$length(new_inst.inst_tys))) {
                return undefined;
              } else {
                function _t1568(i) {
                  const ex_ty_1569 = List$nth(existing.inst_tys, i);
                  const new_ty_1571 = List$nth(new_inst.inst_tys, i);
                  const _t1572 = Types$equal_ty(ex_ty_1569, new_ty_1571);
                  const _t1570 = _t1572;
                  return _t1570;
                }
                const from_match_1573 = List$forall(_t1568, fd.fd_from);
                if (from_match_1573) {
                  function _t1574(i) {
                    const ex_ty_1575 = List$nth(existing.inst_tys, i);
                    const new_ty_1577 = List$nth(new_inst.inst_tys, i);
                    const _t1578 = Types$equal_ty(ex_ty_1575, new_ty_1577);
                    const _t1576 = _t1578;
                    return _t1576;
                  }
                  const to_match_1579 = List$forall(_t1574, fd.fd_to);
                  if ((!to_match_1579)) {
                    function _t1580(i) {
                      return Types$pp_ty(List$nth(new_inst.inst_tys, i));
                    }
                    const from_strs_1581 = List$map(_t1580, fd.fd_from);
                    function _t1582(i) {
                      return Types$pp_ty(List$nth(new_inst.inst_tys, i));
                    }
                    const to_strs_new_1583 = List$map(_t1582, fd.fd_to);
                    function _t1584(i) {
                      return Types$pp_ty(List$nth(existing.inst_tys, i));
                    }
                    const to_strs_ex_1585 = List$map(_t1584, fd.fd_to);
                    return _h["unify_error"](((((((("functional dependency violation in class " + __dict_Show_string.show(class_def.class_name)) + ": type(s) ") + __dict_Show_string.show(String$concat(", ", from_strs_1581))) + " determine ") + __dict_Show_string.show(String$concat(", ", to_strs_new_1583))) + ", but existing instance has ") + __dict_Show_string.show(String$concat(", ", to_strs_ex_1585))), function(_t1586) {
                      return _bounce(function() {
                        return _t1586;
                      });
                    });
                  } else {
                    return undefined;
                  }
                } else {
                  return undefined;
                }
              }
            }
          });
        }
        const _t1587 = List$iter(_t1567, existing_instances);
        return _t1587;
      });
    }
    const _t1588 = List$iter(_t1566, class_def.class_fundeps);
    return _t1588;
  }, Types$check_fundep_consistency);
}
function Types$improve_with_fundeps(instances, class_def, partial) {
  function _t1589(partial, fd) {
    function _t1590(i) {
      return ((i < List$length(partial)) && !_eq(List$nth(partial, i), ({_tag: 0, _name: "None"})));
    }
    const from_known_1591 = List$forall(_t1590, fd.fd_from);
    let _t1593;
    if ((!from_known_1591)) {
      _t1593 = partial;
    } else {
      function _t1594(i, opt) {
        let _t1595;
        if (List$mem(i, fd.fd_from)) {
          _t1595 = opt;
        } else {
          _t1595 = ({_tag: 0, _name: "None"});
        }
        return _t1595;
      }
      const from_partial_1596 = List$mapi(_t1594, partial);
      function _t1598(inst) {
        return ((inst.inst_class === class_def.class_name) && ((List$length(inst.inst_tys) === List$length(partial)) && Types$match_partial_inst(inst.inst_tys, from_partial_1596)));
      }
      const matching_1599 = List$filter(_t1598, instances);
      let _t1602;
      const _t1601 = matching_1599;
      _t1603: {
        if (_t1601 !== null && _t1601._tl === null) {
          const inst = _t1601._hd;
          let _t1605;
          const _t1604 = Hashtbl$create(4);
          _t1606: {
            if (true) {
              const subst = _t1604;
              function _t1607(i) {
                const inst_ty_1608 = List$nth(inst.inst_tys, i);
                const conc_ty_1610 = Option$unwrap(List$nth(partial, i));
                function extract_bindings(pat, conc) {
                  while (true) {
                    let _t1613;
                    const _t1612 = [pat, Types$repr(conc)];
                    _t1614: {
                      if (_t1612[0]._tag === 17) {
                        const g = _t1612[0]._val;
                        const ty = _t1612[1];
                        _t1613 = _call(Hashtbl$set, [__dict_Hash_int, __dict_Eq_int, subst, g, ty]);
                        break _t1614;
                      }
                      if (_t1612[0]._tag === 10 && _t1612[1]._tag === 10) {
                        const a = _t1612[0]._val;
                        const b = _t1612[1]._val;
                        const _t1615 = a;
                        const _t1616 = b;
                        pat = _t1615;
                        conc = _t1616;
                        continue;
                        _t1613 = undefined;
                        break _t1614;
                      }
                      if (_t1612[0]._tag === 14 && _t1612[1]._tag === 14) {
                        const a = _t1612[0]._val;
                        const b = _t1612[1]._val;
                        const _t1617 = a;
                        const _t1618 = b;
                        pat = _t1617;
                        conc = _t1618;
                        continue;
                        _t1613 = undefined;
                        break _t1614;
                      }
                      if (_t1612[0]._tag === 13 && _t1612[1]._tag === 13) {
                        const k1 = _t1612[0]._val[0];
                        const v1 = _t1612[0]._val[1];
                        const k2 = _t1612[1]._val[0];
                        const v2 = _t1612[1]._val[1];
                        extract_bindings(k1, k2);
                        const _t1619 = v1;
                        const _t1620 = v2;
                        pat = _t1619;
                        conc = _t1620;
                        continue;
                        _t1613 = undefined;
                        break _t1614;
                      }
                      if (_t1612[0]._tag === 9 && _t1612[1]._tag === 9) {
                        const ts1 = _t1612[0]._val;
                        const ts2 = _t1612[1]._val;
                        if ((List$length(ts1) === List$length(ts2))) {
                          _t1613 = List$iter2(extract_bindings, ts1, ts2);
                          break _t1614;
                        }
                      }
                      if (_t1612[0]._tag === 12 && _t1612[1]._tag === 12) {
                        const args1 = _t1612[0]._val[1];
                        const args2 = _t1612[1]._val[1];
                        if ((List$length(args1) === List$length(args2))) {
                          _t1613 = List$iter2(extract_bindings, args1, args2);
                          break _t1614;
                        }
                      }
                      if ((_t1612[0]._tag === 7 && _t1612[1]._tag === 7 || _t1612[0]._tag === 8 && _t1612[1]._tag === 8)) {
                        const a1 = _t1612[0]._val[0];
                        const r1 = _t1612[0]._val[2];
                        const a2 = _t1612[1]._val[0];
                        const r2 = _t1612[1]._val[2];
                        extract_bindings(a1, a2);
                        const _t1621 = r1;
                        const _t1622 = r2;
                        pat = _t1621;
                        conc = _t1622;
                        continue;
                        _t1613 = undefined;
                        break _t1614;
                      }
                      if (true) {
                        _t1613 = undefined;
                        break _t1614;
                      }
                      _match_fail("line 15950");
                    }
                    return _t1613;
                  }
                }
                const _t1623 = extract_bindings(inst_ty_1608, conc_ty_1610);
                const _t1611 = _t1623;
                const _t1609 = _t1611;
                return _t1609;
              }
              List$iter(_t1607, fd.fd_from);
              function apply_subst(ty) {
                let _t1625;
                const _t1624 = ty;
                _t1626: {
                  if (_t1624._tag === 17) {
                    const g = _t1624._val;
                    let _t1628;
                    const _t1627 = _call(Hashtbl$get, [__dict_Hash_int, __dict_Eq_int, subst, g]);
                    _t1629: {
                      if (_t1627._tag === 1) {
                        const t = _t1627._val;
                        _t1628 = t;
                        break _t1629;
                      }
                      if (_t1627._tag === 0) {
                        _t1628 = ty;
                        break _t1629;
                      }
                      _match_fail("line 15950");
                    }
                    _t1625 = _t1628;
                    break _t1626;
                  }
                  if (_t1624._tag === 10) {
                    const a = _t1624._val;
                    _t1625 = ({_tag: 10, _name: "TList", _val: apply_subst(a)});
                    break _t1626;
                  }
                  if (_t1624._tag === 14) {
                    const a = _t1624._val;
                    _t1625 = ({_tag: 14, _name: "TArray", _val: apply_subst(a)});
                    break _t1626;
                  }
                  if (_t1624._tag === 13) {
                    const k = _t1624._val[0];
                    const v = _t1624._val[1];
                    _t1625 = ({_tag: 13, _name: "TMap", _val: [apply_subst(k), apply_subst(v)]});
                    break _t1626;
                  }
                  if (_t1624._tag === 9) {
                    const ts = _t1624._val;
                    _t1625 = ({_tag: 9, _name: "TTuple", _val: List$map(apply_subst, ts)});
                    break _t1626;
                  }
                  if (_t1624._tag === 12) {
                    const n = _t1624._val[0];
                    const args = _t1624._val[1];
                    _t1625 = ({_tag: 12, _name: "TVariant", _val: [n, List$map(apply_subst, args)]});
                    break _t1626;
                  }
                  if (_t1624._tag === 7) {
                    const a = _t1624._val[0];
                    const e = _t1624._val[1];
                    const r = _t1624._val[2];
                    _t1625 = ({_tag: 7, _name: "TArrow", _val: [apply_subst(a), e, apply_subst(r)]});
                    break _t1626;
                  }
                  if (_t1624._tag === 8) {
                    const a = _t1624._val[0];
                    const e = _t1624._val[1];
                    const r = _t1624._val[2];
                    _t1625 = ({_tag: 8, _name: "TCont", _val: [apply_subst(a), e, apply_subst(r)]});
                    break _t1626;
                  }
                  if (true) {
                    _t1625 = ty;
                    break _t1626;
                  }
                  _match_fail("line 15950");
                }
                return _t1625;
              }
              function _t1631(i, opt) {
                let _t1632;
                if (!_eq(opt, ({_tag: 0, _name: "None"}))) {
                  _t1632 = opt;
                } else {
                  let _t1633;
                  if (List$mem(i, fd.fd_to)) {
                    _t1633 = ({_tag: 1, _name: "Some", _val: apply_subst(List$nth(inst.inst_tys, i))});
                  } else {
                    _t1633 = opt;
                  }
                  _t1632 = _t1633;
                }
                return _t1632;
              }
              const _t1630 = List$mapi(_t1631, partial);
              _t1605 = _t1630;
              break _t1606;
            }
            _match_fail("line 15950");
          }
          _t1602 = _t1605;
          break _t1603;
        }
        if (true) {
          _t1602 = partial;
          break _t1603;
        }
        _match_fail("line 15950");
      }
      const _t1600 = _t1602;
      const _t1597 = _t1600;
      _t1593 = _t1597;
    }
    const _t1592 = _t1593;
    return _t1592;
  }
  return List$fold(_t1589, partial, class_def.class_fundeps);
}
function Lexer$create(source) {
  return ({col: 1, cursor: 0, len: String$length(source), line: 1, source: source});
}
function Lexer$current_loc(l) {
  return ({col: l.col, line: l.line, offset: l.cursor});
}
function Lexer$make_token(l, kind, loc) {
  return ({end_offset: l.cursor, kind: kind, loc: loc});
}
function Lexer$at_end(l) {
  return (l.cursor >= l.len);
}
function Lexer$peek(l) {
  let _t1634;
  if (Lexer$at_end(l)) {
    _t1634 = 0;
  } else {
    _t1634 = String$get(l.source, l.cursor);
  }
  return _t1634;
}
function Lexer$peek2(l) {
  let _t1635;
  if (((l.cursor + 1) >= l.len)) {
    _t1635 = 0;
  } else {
    _t1635 = String$get(l.source, (l.cursor + 1));
  }
  return _t1635;
}
function Lexer$peek3(l) {
  let _t1636;
  if (((l.cursor + 2) >= l.len)) {
    _t1636 = 0;
  } else {
    _t1636 = String$get(l.source, (l.cursor + 2));
  }
  return _t1636;
}
function Lexer$advance(l) {
  const c_1637 = String$get(l.source, l.cursor);
  (l.cursor = (l.cursor + 1), undefined);
  let _t1639;
  if ((c_1637 === 10)) {
    (l.line = (l.line + 1), undefined);
    _t1639 = (l.col = 1, undefined);
  } else {
    _t1639 = (l.col = (l.col + 1), undefined);
  }
  _t1639;
  const _t1638 = c_1637;
  return _t1638;
}
function Lexer$error(l, msg) {
  return _trampoline(function() {
    return _h["lex_error"]([msg, Lexer$current_loc(l)], function(_t1640) {
      return _bounce(function() {
        return _t1640;
      });
    });
  }, Lexer$error);
}
function Lexer$skip_whitespace(l) {
  let _t1641 = undefined;
  let _t1642 = false, _t1643;
  while (true) {
    if (!(((!Lexer$at_end(l)) && ((Lexer$peek(l) === 32) || ((Lexer$peek(l) === 9) || ((Lexer$peek(l) === 10) || (Lexer$peek(l) === 13))))))) break;
    Lexer$advance(l);
    undefined;
    if (_t1642) break;
  }
  _t1641 = _t1642 ? _t1643 : undefined;
  return _t1641;
}
function Lexer$skip_comment(l) {
  const depth_1644 = Ref$create(1);
  let _t1646 = undefined;
  let _t1647 = false, _t1648;
  while (true) {
    if (!((Ref$get(depth_1644) > 0))) break;
    let _t1649;
    if (Lexer$at_end(l)) {
      _t1649 = Lexer$error(l, "unterminated comment");
    } else {
      _t1649 = undefined;
    }
    _t1649;
    let _t1650;
    if (((Lexer$peek(l) === 40) && (Lexer$peek2(l) === 42))) {
      Lexer$advance(l);
      undefined;
      Lexer$advance(l);
      undefined;
      _t1650 = Ref$set(depth_1644, (Ref$get(depth_1644) + 1));
    } else {
      let _t1651;
      if (((Lexer$peek(l) === 42) && (Lexer$peek2(l) === 41))) {
        Lexer$advance(l);
        undefined;
        Lexer$advance(l);
        undefined;
        _t1651 = Ref$set(depth_1644, (Ref$get(depth_1644) - 1));
      } else {
        Lexer$advance(l);
        _t1651 = undefined;
      }
      _t1650 = _t1651;
    }
    _t1650;
    if (_t1647) break;
  }
  _t1646 = _t1647 ? _t1648 : undefined;
  const _t1645 = _t1646;
  return _t1645;
}
function Lexer$skip_whitespace_and_comments(l) {
  const changed_1652 = Ref$create(true);
  let _t1654 = undefined;
  let _t1655 = false, _t1656;
  while (true) {
    if (!(Ref$get(changed_1652))) break;
    Ref$set(changed_1652, false);
    const p_1657 = l.cursor;
    Lexer$skip_whitespace(l);
    let _t1659;
    if (((!Lexer$at_end(l)) && ((Lexer$peek(l) === 40) && ((Lexer$peek2(l) === 42) && (Lexer$peek3(l) !== 41))))) {
      Lexer$advance(l);
      undefined;
      Lexer$advance(l);
      undefined;
      Lexer$skip_comment(l);
      _t1659 = Ref$set(changed_1652, true);
    } else {
      _t1659 = undefined;
    }
    _t1659;
    let _t1660;
    if ((l.cursor !== p_1657)) {
      _t1660 = Ref$set(changed_1652, true);
    } else {
      _t1660 = undefined;
    }
    const _t1658 = _t1660;
    _t1658;
    if (_t1655) break;
  }
  _t1654 = _t1655 ? _t1656 : undefined;
  const _t1653 = _t1654;
  return _t1653;
}
function Lexer$is_digit(c) {
  return ((c >= 48) && (c <= 57));
}
function Lexer$is_hex_digit(c) {
  return (Lexer$is_digit(c) || (((c >= 97) && (c <= 102)) || ((c >= 65) && (c <= 70))));
}
function Lexer$hex_val(c) {
  let _t1661;
  if (((c >= 48) && (c <= 57))) {
    _t1661 = (Byte$to_int(c) - Byte$to_int(48));
  } else {
    let _t1662;
    if (((c >= 97) && (c <= 102))) {
      _t1662 = ((Byte$to_int(c) - Byte$to_int(97)) + 10);
    } else {
      _t1662 = ((Byte$to_int(c) - Byte$to_int(65)) + 10);
    }
    _t1661 = _t1662;
  }
  return _t1661;
}
function Lexer$is_alpha(c) {
  return (((c >= 97) && (c <= 122)) || ((c >= 65) && (c <= 90)));
}
function Lexer$is_ident_start(c) {
  return (Lexer$is_alpha(c) || (c === 95));
}
function Lexer$is_ident_char(c) {
  return (Lexer$is_alpha(c) || (Lexer$is_digit(c) || ((c === 95) || (c === 39))));
}
const Lexer$keywords = ({_hd: ["let", ({_tag: 11, _name: "LET"})], _tl: ({_hd: ["rec", ({_tag: 12, _name: "REC"})], _tl: ({_hd: ["in", ({_tag: 13, _name: "IN"})], _tl: ({_hd: ["if", ({_tag: 14, _name: "IF"})], _tl: ({_hd: ["else", ({_tag: 15, _name: "ELSE"})], _tl: ({_hd: ["fn", ({_tag: 16, _name: "FN"})], _tl: ({_hd: ["match", ({_tag: 17, _name: "MATCH"})], _tl: ({_hd: ["with", ({_tag: 18, _name: "WITH"})], _tl: ({_hd: ["type", ({_tag: 19, _name: "TYPE"})], _tl: ({_hd: ["of", ({_tag: 20, _name: "OF"})], _tl: ({_hd: ["not", ({_tag: 38, _name: "NOT"})], _tl: ({_hd: ["mod", ({_tag: 41, _name: "MOD"})], _tl: ({_hd: ["true", ({_tag: 6, _name: "TRUE"})], _tl: ({_hd: ["false", ({_tag: 7, _name: "FALSE"})], _tl: ({_hd: ["class", ({_tag: 21, _name: "CLASS"})], _tl: ({_hd: ["instance", ({_tag: 22, _name: "INSTANCE"})], _tl: ({_hd: ["effect", ({_tag: 23, _name: "EFFECT"})], _tl: ({_hd: ["extern", ({_tag: 24, _name: "EXTERN"})], _tl: ({_hd: ["perform", ({_tag: 25, _name: "PERFORM"})], _tl: ({_hd: ["handle", ({_tag: 26, _name: "HANDLE"})], _tl: ({_hd: ["try", ({_tag: 27, _name: "TRY"})], _tl: ({_hd: ["resume", ({_tag: 29, _name: "RESUME"})], _tl: ({_hd: ["return", ({_tag: 30, _name: "RETURN"})], _tl: ({_hd: ["continue", ({_tag: 28, _name: "CONTINUE"})], _tl: ({_hd: ["mut", ({_tag: 31, _name: "MUT"})], _tl: ({_hd: ["for", ({_tag: 32, _name: "FOR"})], _tl: ({_hd: ["do", ({_tag: 33, _name: "DO"})], _tl: ({_hd: ["break", ({_tag: 34, _name: "BREAK"})], _tl: ({_hd: ["when", ({_tag: 35, _name: "WHEN"})], _tl: ({_hd: ["where", ({_tag: 36, _name: "WHERE"})], _tl: ({_hd: ["module", ({_tag: 42, _name: "MODULE"})], _tl: ({_hd: ["pub", ({_tag: 43, _name: "PUB"})], _tl: ({_hd: ["open", ({_tag: 44, _name: "OPEN"})], _tl: ({_hd: ["end", ({_tag: 45, _name: "END"})], _tl: ({_hd: ["opaque", ({_tag: 46, _name: "OPAQUE"})], _tl: ({_hd: ["and", ({_tag: 48, _name: "AND"})], _tl: ({_hd: ["deriving", ({_tag: 49, _name: "DERIVING"})], _tl: ({_hd: ["land", ({_tag: 81, _name: "LAND"})], _tl: ({_hd: ["lor", ({_tag: 82, _name: "LOR"})], _tl: ({_hd: ["lxor", ({_tag: 83, _name: "LXOR"})], _tl: ({_hd: ["lnot", ({_tag: 84, _name: "LNOT"})], _tl: ({_hd: ["lsl", ({_tag: 85, _name: "LSL"})], _tl: ({_hd: ["lsr", ({_tag: 86, _name: "LSR"})], _tl: null})})})})})})})})})})})})})})})})})})})})})})})})})})})})})})})})})})})})})})})})})})});
function Lexer$read_number(l) {
  const loc_1663 = Lexer$current_loc(l);
  const buf_1665 = Buffer$create(16);
  const c_1667 = Lexer$advance(l);
  Buffer$add_byte(buf_1665, c_1667);
  let _t1669;
  if (((c_1667 === 48) && ((!Lexer$at_end(l)) && ((Lexer$peek(l) === 120) || (Lexer$peek(l) === 88))))) {
    Buffer$add_byte(buf_1665, Lexer$advance(l));
    let _t1670 = undefined;
    let _t1671 = false, _t1672;
    while (true) {
      if (!(((!Lexer$at_end(l)) && Lexer$is_hex_digit(Lexer$peek(l))))) break;
      Buffer$add_byte(buf_1665, Lexer$advance(l));
      if (_t1671) break;
    }
    _t1670 = _t1671 ? _t1672 : undefined;
    _t1670;
    const n_1673 = int_of_string(Buffer$contents(buf_1665));
    const _t1674 = Lexer$make_token(l, ({_tag: 0, _name: "INT", _val: n_1673}), loc_1663);
    _t1669 = _t1674;
  } else {
    let _t1675;
    if (((c_1667 === 48) && ((!Lexer$at_end(l)) && ((Lexer$peek(l) === 98) || (Lexer$peek(l) === 66))))) {
      Buffer$add_byte(buf_1665, Lexer$advance(l));
      let _t1676 = undefined;
      let _t1677 = false, _t1678;
      while (true) {
        if (!(((!Lexer$at_end(l)) && ((Lexer$peek(l) === 48) || (Lexer$peek(l) === 49))))) break;
        Buffer$add_byte(buf_1665, Lexer$advance(l));
        if (_t1677) break;
      }
      _t1676 = _t1677 ? _t1678 : undefined;
      _t1676;
      const n_1679 = int_of_string(Buffer$contents(buf_1665));
      const _t1680 = Lexer$make_token(l, ({_tag: 0, _name: "INT", _val: n_1679}), loc_1663);
      _t1675 = _t1680;
    } else {
      let _t1681 = undefined;
      let _t1682 = false, _t1683;
      while (true) {
        if (!(((!Lexer$at_end(l)) && Lexer$is_digit(Lexer$peek(l))))) break;
        Buffer$add_byte(buf_1665, Lexer$advance(l));
        if (_t1682) break;
      }
      _t1681 = _t1682 ? _t1683 : undefined;
      _t1681;
      let _t1684;
      if (((!Lexer$at_end(l)) && (Lexer$peek(l) === 46))) {
        Buffer$add_byte(buf_1665, Lexer$advance(l));
        let _t1685 = undefined;
        let _t1686 = false, _t1687;
        while (true) {
          if (!(((!Lexer$at_end(l)) && Lexer$is_digit(Lexer$peek(l))))) break;
          Buffer$add_byte(buf_1665, Lexer$advance(l));
          if (_t1686) break;
        }
        _t1685 = _t1686 ? _t1687 : undefined;
        _t1685;
        const f_1688 = float_of_string(Buffer$contents(buf_1665));
        const _t1689 = Lexer$make_token(l, ({_tag: 1, _name: "FLOAT", _val: f_1688}), loc_1663);
        _t1684 = _t1689;
      } else {
        const n_1690 = int_of_string(Buffer$contents(buf_1665));
        const _t1691 = Lexer$make_token(l, ({_tag: 0, _name: "INT", _val: n_1690}), loc_1663);
        _t1684 = _t1691;
      }
      _t1675 = _t1684;
    }
    _t1669 = _t1675;
  }
  const _t1668 = _t1669;
  const _t1666 = _t1668;
  const _t1664 = _t1666;
  return _t1664;
}
function Lexer$read_string(l) {
  const loc_1692 = Lexer$current_loc(l);
  Lexer$advance(l);
  undefined;
  const buf_1694 = Buffer$create(64);
  let _t1696 = undefined;
  let _t1697 = false, _t1698;
  while (true) {
    if (!(((!Lexer$at_end(l)) && (Lexer$peek(l) !== 34)))) break;
    let _t1699;
    if ((Lexer$peek(l) === 92)) {
      Lexer$advance(l);
      undefined;
      let _t1700;
      if (Lexer$at_end(l)) {
        _t1700 = Lexer$error(l, "unterminated string");
      } else {
        _t1700 = undefined;
      }
      _t1700;
      const c_1701 = Lexer$advance(l);
      let _t1704;
      const _t1703 = c_1701;
      _t1705: {
        if (true) {
          const _c = _t1703;
          if ((_c === 110)) {
            _t1704 = Buffer$add_byte(buf_1694, 10);
            break _t1705;
          }
        }
        if (true) {
          const _c = _t1703;
          if ((_c === 116)) {
            _t1704 = Buffer$add_byte(buf_1694, 9);
            break _t1705;
          }
        }
        if (true) {
          const _c = _t1703;
          if ((_c === 92)) {
            _t1704 = Buffer$add_byte(buf_1694, 92);
            break _t1705;
          }
        }
        if (true) {
          const _c = _t1703;
          if ((_c === 34)) {
            _t1704 = Buffer$add_byte(buf_1694, 34);
            break _t1705;
          }
        }
        if (true) {
          _t1704 = Lexer$error(l, ("unknown escape: \\" + __dict_Show_byte.show(c_1701)));
          break _t1705;
        }
        _match_fail("line 15950");
      }
      const _t1702 = _t1704;
      _t1699 = _t1702;
    } else {
      _t1699 = Buffer$add_byte(buf_1694, Lexer$advance(l));
    }
    _t1699;
    if (_t1697) break;
  }
  _t1696 = _t1697 ? _t1698 : undefined;
  _t1696;
  let _t1706;
  if (Lexer$at_end(l)) {
    _t1706 = Lexer$error(l, "unterminated string");
  } else {
    _t1706 = undefined;
  }
  _t1706;
  Lexer$advance(l);
  undefined;
  const _t1695 = Lexer$make_token(l, ({_tag: 2, _name: "STRING", _val: Buffer$contents(buf_1694)}), loc_1692);
  const _t1693 = _t1695;
  return _t1693;
}
function Lexer$dedent_raw(s) {
  const lines_1707 = String$split("\n", s);
  let _t1710;
  const _t1709 = lines_1707;
  _t1711: {
    if (_t1709 !== null) {
      const first = _t1709._hd;
      const rest = _t1709._tl;
      if ((String$trim(first) === "")) {
        _t1710 = rest;
        break _t1711;
      }
    }
    if (true) {
      _t1710 = lines_1707;
      break _t1711;
    }
    _match_fail("line 15950");
  }
  const lines_1712 = _t1710;
  let _t1715;
  const _t1714 = List$rev(lines_1712);
  _t1716: {
    if (_t1714 !== null) {
      const last = _t1714._hd;
      const rest = _t1714._tl;
      if ((String$trim(last) === "")) {
        _t1715 = List$rev(rest);
        break _t1716;
      }
    }
    if (true) {
      _t1715 = lines_1712;
      break _t1716;
    }
    _match_fail("line 15950");
  }
  const lines_1717 = _t1715;
  function _t1719(acc, line) {
    let _t1720;
    if ((String$trim(line) === "")) {
      _t1720 = acc;
    } else {
      const len_1721 = String$length(line);
      const i_1723 = Ref$create(0);
      let _t1725 = undefined;
      let _t1726 = false, _t1727;
      while (true) {
        if (!(((Ref$get(i_1723) < len_1721) && ((String$get(line, Ref$get(i_1723)) === 32) || (String$get(line, Ref$get(i_1723)) === 9))))) break;
        Ref$set(i_1723, (Ref$get(i_1723) + 1));
        if (_t1726) break;
      }
      _t1725 = _t1726 ? _t1727 : undefined;
      _t1725;
      let _t1729;
      const _t1728 = acc;
      _t1730: {
        if (_t1728._tag === 0) {
          _t1729 = ({_tag: 1, _name: "Some", _val: Ref$get(i_1723)});
          break _t1730;
        }
        if (_t1728._tag === 1) {
          const prev = _t1728._val;
          _t1729 = ({_tag: 1, _name: "Some", _val: min(prev, Ref$get(i_1723))});
          break _t1730;
        }
        _match_fail("line 15950");
      }
      const _t1724 = _t1729;
      const _t1722 = _t1724;
      _t1720 = _t1722;
    }
    return _t1720;
  }
  const indent_1731 = List$fold(_t1719, ({_tag: 0, _name: "None"}), lines_1717);
  let _t1734;
  const _t1733 = indent_1731;
  _t1735: {
    if (_t1733._tag === 1) {
      const n = _t1733._val;
      _t1734 = n;
      break _t1735;
    }
    if (_t1733._tag === 0) {
      _t1734 = 0;
      break _t1735;
    }
    _match_fail("line 15950");
  }
  const indent_1736 = _t1734;
  function _t1738(line) {
    const len_1739 = String$length(line);
    let _t1741;
    if ((len_1739 >= indent_1736)) {
      _t1741 = String$sub(line, indent_1736, (len_1739 - indent_1736));
    } else {
      _t1741 = line;
    }
    const _t1740 = _t1741;
    return _t1740;
  }
  const lines_1742 = List$map(_t1738, lines_1717);
  const _t1743 = String$concat("\n", lines_1742);
  const _t1737 = _t1743;
  const _t1732 = _t1737;
  const _t1718 = _t1732;
  const _t1713 = _t1718;
  const _t1708 = _t1713;
  return _t1708;
}
function Lexer$read_raw_string(l) {
  const loc_1744 = Lexer$current_loc(l);
  Lexer$advance(l);
  undefined;
  Lexer$advance(l);
  undefined;
  const buf_1746 = Buffer$create(256);
  let _t1748 = undefined;
  let _t1749 = false, _t1750;
  while (true) {
    if (!(((!Lexer$at_end(l)) && (!((Lexer$peek(l) === 124) && (Lexer$peek2(l) === 125)))))) break;
    Buffer$add_byte(buf_1746, Lexer$advance(l));
    if (_t1749) break;
  }
  _t1748 = _t1749 ? _t1750 : undefined;
  _t1748;
  let _t1751;
  if (Lexer$at_end(l)) {
    _t1751 = Lexer$error(l, "unterminated raw string");
  } else {
    _t1751 = undefined;
  }
  _t1751;
  Lexer$advance(l);
  undefined;
  Lexer$advance(l);
  undefined;
  const raw_1752 = Buffer$contents(buf_1746);
  const _t1753 = Lexer$make_token(l, ({_tag: 2, _name: "STRING", _val: Lexer$dedent_raw(raw_1752)}), loc_1744);
  const _t1747 = _t1753;
  const _t1745 = _t1747;
  return _t1745;
}
function Lexer$read_interp_string(l) {
  const loc_1754 = Lexer$current_loc(l);
  Lexer$advance(l);
  undefined;
  Lexer$advance(l);
  undefined;
  const parts_1756 = Ref$create(null);
  const buf_1758 = Buffer$create(64);
  function _t1760(_) {
    let _t1761;
    if ((Buffer$length(buf_1758) > 0)) {
      Ref$set(parts_1756, ({_hd: ({_tag: 0, _name: "IPLit", _val: Buffer$contents(buf_1758)}), _tl: Ref$get(parts_1756)}));
      _t1761 = Buffer$clear(buf_1758);
    } else {
      _t1761 = undefined;
    }
    return _t1761;
  }
  const flush_lit_1762 = _t1760;
  let _t1764 = undefined;
  let _t1765 = false, _t1766;
  while (true) {
    if (!(((!Lexer$at_end(l)) && (Lexer$peek(l) !== 34)))) break;
    let _t1767;
    if ((Lexer$peek(l) === 92)) {
      Lexer$advance(l);
      undefined;
      let _t1768;
      if (Lexer$at_end(l)) {
        _t1768 = Lexer$error(l, "unterminated interpolated string");
      } else {
        _t1768 = undefined;
      }
      _t1768;
      const c_1769 = Lexer$advance(l);
      let _t1772;
      const _t1771 = c_1769;
      _t1773: {
        if (true) {
          const _c = _t1771;
          if ((_c === 110)) {
            _t1772 = Buffer$add_byte(buf_1758, 10);
            break _t1773;
          }
        }
        if (true) {
          const _c = _t1771;
          if ((_c === 116)) {
            _t1772 = Buffer$add_byte(buf_1758, 9);
            break _t1773;
          }
        }
        if (true) {
          const _c = _t1771;
          if ((_c === 92)) {
            _t1772 = Buffer$add_byte(buf_1758, 92);
            break _t1773;
          }
        }
        if (true) {
          const _c = _t1771;
          if ((_c === 34)) {
            _t1772 = Buffer$add_byte(buf_1758, 34);
            break _t1773;
          }
        }
        if (true) {
          const _c = _t1771;
          if ((_c === 123)) {
            _t1772 = Buffer$add_byte(buf_1758, 123);
            break _t1773;
          }
        }
        if (true) {
          const _c = _t1771;
          if ((_c === 125)) {
            _t1772 = Buffer$add_byte(buf_1758, 125);
            break _t1773;
          }
        }
        if (true) {
          _t1772 = Lexer$error(l, ("unknown escape: \\" + __dict_Show_byte.show(c_1769)));
          break _t1773;
        }
        _match_fail("line 15950");
      }
      const _t1770 = _t1772;
      _t1767 = _t1770;
    } else {
      let _t1774;
      if ((Lexer$peek(l) === 123)) {
        flush_lit_1762(undefined);
        Lexer$advance(l);
        undefined;
        const expr_buf_1775 = Buffer$create(64);
        const fmt_buf_1777 = Buffer$create(16);
        const depth_1779 = Ref$create(1);
        const paren_depth_1781 = Ref$create(0);
        const in_fmt_1783 = Ref$create(false);
        let _t1785 = undefined;
        let _t1786 = false, _t1787;
        while (true) {
          if (!((Ref$get(depth_1779) > 0))) break;
          let _t1788;
          if (Lexer$at_end(l)) {
            _t1788 = Lexer$error(l, "unterminated interpolation expression");
          } else {
            _t1788 = undefined;
          }
          _t1788;
          const c_1789 = Lexer$peek(l);
          let _t1791;
          if ((c_1789 === 123)) {
            Ref$set(depth_1779, (Ref$get(depth_1779) + 1));
            let _t1792;
            if (Ref$get(in_fmt_1783)) {
              _t1792 = fmt_buf_1777;
            } else {
              _t1792 = expr_buf_1775;
            }
            _t1791 = Buffer$add_byte(_t1792, Lexer$advance(l));
          } else {
            let _t1793;
            if ((c_1789 === 125)) {
              Ref$set(depth_1779, (Ref$get(depth_1779) - 1));
              let _t1794;
              if ((Ref$get(depth_1779) > 0)) {
                let _t1795;
                if (Ref$get(in_fmt_1783)) {
                  _t1795 = fmt_buf_1777;
                } else {
                  _t1795 = expr_buf_1775;
                }
                _t1794 = Buffer$add_byte(_t1795, Lexer$advance(l));
              } else {
                Lexer$advance(l);
                _t1794 = undefined;
              }
              _t1793 = _t1794;
            } else {
              let _t1796;
              if ((c_1789 === 40)) {
                Ref$set(paren_depth_1781, (Ref$get(paren_depth_1781) + 1));
                let _t1797;
                if (Ref$get(in_fmt_1783)) {
                  _t1797 = fmt_buf_1777;
                } else {
                  _t1797 = expr_buf_1775;
                }
                _t1796 = Buffer$add_byte(_t1797, Lexer$advance(l));
              } else {
                let _t1798;
                if ((c_1789 === 41)) {
                  let _t1799;
                  if ((Ref$get(paren_depth_1781) > 0)) {
                    _t1799 = Ref$set(paren_depth_1781, (Ref$get(paren_depth_1781) - 1));
                  } else {
                    _t1799 = undefined;
                  }
                  _t1799;
                  let _t1800;
                  if (Ref$get(in_fmt_1783)) {
                    _t1800 = fmt_buf_1777;
                  } else {
                    _t1800 = expr_buf_1775;
                  }
                  _t1798 = Buffer$add_byte(_t1800, Lexer$advance(l));
                } else {
                  let _t1801;
                  if (((c_1789 === 58) && ((Ref$get(depth_1779) === 1) && ((Ref$get(paren_depth_1781) === 0) && (!Ref$get(in_fmt_1783)))))) {
                    Lexer$advance(l);
                    undefined;
                    _t1801 = Ref$set(in_fmt_1783, true);
                  } else {
                    let _t1802;
                    if ((c_1789 === 34)) {
                      let _t1803;
                      if (Ref$get(in_fmt_1783)) {
                        _t1803 = fmt_buf_1777;
                      } else {
                        _t1803 = expr_buf_1775;
                      }
                      const buf_1804 = _t1803;
                      Buffer$add_byte(buf_1804, Lexer$advance(l));
                      let _t1806 = undefined;
                      let _t1807 = false, _t1808;
                      while (true) {
                        if (!(((!Lexer$at_end(l)) && (Lexer$peek(l) !== 34)))) break;
                        let _t1809;
                        if ((Lexer$peek(l) === 92)) {
                          Buffer$add_byte(buf_1804, Lexer$advance(l));
                          let _t1810;
                          if ((!Lexer$at_end(l))) {
                            _t1810 = Buffer$add_byte(buf_1804, Lexer$advance(l));
                          } else {
                            _t1810 = undefined;
                          }
                          _t1809 = _t1810;
                        } else {
                          _t1809 = Buffer$add_byte(buf_1804, Lexer$advance(l));
                        }
                        _t1809;
                        if (_t1807) break;
                      }
                      _t1806 = _t1807 ? _t1808 : undefined;
                      _t1806;
                      let _t1811;
                      if ((!Lexer$at_end(l))) {
                        _t1811 = Buffer$add_byte(buf_1804, Lexer$advance(l));
                      } else {
                        _t1811 = undefined;
                      }
                      const _t1805 = _t1811;
                      _t1802 = _t1805;
                    } else {
                      let _t1812;
                      if (Ref$get(in_fmt_1783)) {
                        _t1812 = fmt_buf_1777;
                      } else {
                        _t1812 = expr_buf_1775;
                      }
                      _t1802 = Buffer$add_byte(_t1812, Lexer$advance(l));
                    }
                    _t1801 = _t1802;
                  }
                  _t1798 = _t1801;
                }
                _t1796 = _t1798;
              }
              _t1793 = _t1796;
            }
            _t1791 = _t1793;
          }
          const _t1790 = _t1791;
          _t1790;
          if (_t1786) break;
        }
        _t1785 = _t1786 ? _t1787 : undefined;
        _t1785;
        let _t1813;
        if (Ref$get(in_fmt_1783)) {
          _t1813 = ({_tag: 1, _name: "Some", _val: Buffer$contents(fmt_buf_1777)});
        } else {
          _t1813 = ({_tag: 0, _name: "None"});
        }
        const fmt_1814 = _t1813;
        const _t1815 = Ref$set(parts_1756, ({_hd: ({_tag: 1, _name: "IPExpr", _val: [Buffer$contents(expr_buf_1775), fmt_1814]}), _tl: Ref$get(parts_1756)}));
        const _t1784 = _t1815;
        const _t1782 = _t1784;
        const _t1780 = _t1782;
        const _t1778 = _t1780;
        const _t1776 = _t1778;
        _t1774 = _t1776;
      } else {
        _t1774 = Buffer$add_byte(buf_1758, Lexer$advance(l));
      }
      _t1767 = _t1774;
    }
    _t1767;
    if (_t1765) break;
  }
  _t1764 = _t1765 ? _t1766 : undefined;
  _t1764;
  let _t1816;
  if (Lexer$at_end(l)) {
    _t1816 = Lexer$error(l, "unterminated interpolated string");
  } else {
    _t1816 = undefined;
  }
  _t1816;
  Lexer$advance(l);
  undefined;
  flush_lit_1762(undefined);
  const _t1763 = Lexer$make_token(l, ({_tag: 3, _name: "INTERP_STRING", _val: List$rev(Ref$get(parts_1756))}), loc_1754);
  const _t1759 = _t1763;
  const _t1757 = _t1759;
  const _t1755 = _t1757;
  return _t1755;
}
function Lexer$read_ident_or_keyword(l) {
  const loc_1817 = Lexer$current_loc(l);
  const buf_1819 = Buffer$create(32);
  let _t1821 = undefined;
  let _t1822 = false, _t1823;
  while (true) {
    if (!(((!Lexer$at_end(l)) && Lexer$is_ident_char(Lexer$peek(l))))) break;
    Buffer$add_byte(buf_1819, Lexer$advance(l));
    if (_t1822) break;
  }
  _t1821 = _t1822 ? _t1823 : undefined;
  _t1821;
  const s_1824 = Buffer$contents(buf_1819);
  let _t1827;
  const _t1826 = List$assoc_opt(s_1824, Lexer$keywords);
  _t1828: {
    if (_t1826._tag === 1) {
      const kw = _t1826._val;
      _t1827 = kw;
      break _t1828;
    }
    if (_t1826._tag === 0) {
      let _t1829;
      if ((s_1824 === "_")) {
        _t1829 = ({_tag: 65, _name: "UNDERSCORE"});
      } else {
        let _t1830;
        if (((Byte$to_upper(String$get(s_1824, 0)) === String$get(s_1824, 0)) && (String$get(s_1824, 0) !== 95))) {
          _t1830 = ({_tag: 9, _name: "UIDENT", _val: s_1824});
        } else {
          _t1830 = ({_tag: 8, _name: "IDENT", _val: s_1824});
        }
        _t1829 = _t1830;
      }
      _t1827 = _t1829;
      break _t1828;
    }
    _match_fail("line 15950");
  }
  const kind_1831 = _t1827;
  const _t1832 = Lexer$make_token(l, kind_1831, loc_1817);
  const _t1825 = _t1832;
  const _t1820 = _t1825;
  const _t1818 = _t1820;
  return _t1818;
}
function Lexer$next_token(l) {
  while (true) {
    Lexer$skip_whitespace_and_comments(l);
    let _t1833;
    if (Lexer$at_end(l)) {
      _t1833 = Lexer$make_token(l, ({_tag: 89, _name: "EOF"}), Lexer$current_loc(l));
    } else {
      const loc_1834 = Lexer$current_loc(l);
      const c_1836 = Lexer$peek(l);
      let _t1839;
      const _t1838 = c_1836;
      _t1840: {
        if (true) {
          const _c = _t1838;
          if (((_c >= 48) && (_c <= 57))) {
            _t1839 = Lexer$read_number(l);
            break _t1840;
          }
        }
        if (true) {
          const _c = _t1838;
          if ((((_c === 36) && (!Lexer$at_end(l))) && (Lexer$peek2(l) === 34))) {
            _t1839 = Lexer$read_interp_string(l);
            break _t1840;
          }
        }
        if (true) {
          const _c = _t1838;
          if ((_c === 34)) {
            _t1839 = Lexer$read_string(l);
            break _t1840;
          }
        }
        if (true) {
          const _c = _t1838;
          if ((((_c === 39) && (Lexer$peek2(l) >= 97)) && ((Lexer$peek2(l) <= 122) && (Lexer$peek3(l) !== 39)))) {
            const loc_1841 = Lexer$current_loc(l);
            Lexer$advance(l);
            undefined;
            const buf_1843 = Buffer$create(8);
            let _t1845 = undefined;
            let _t1846 = false, _t1847;
            while (true) {
              if (!(((!Lexer$at_end(l)) && Lexer$is_ident_char(Lexer$peek(l))))) break;
              Buffer$add_byte(buf_1843, Lexer$advance(l));
              if (_t1846) break;
            }
            _t1845 = _t1846 ? _t1847 : undefined;
            _t1845;
            const _t1844 = Lexer$make_token(l, ({_tag: 10, _name: "TYVAR", _val: Buffer$contents(buf_1843)}), loc_1841);
            const _t1842 = _t1844;
            _t1839 = _t1842;
            break _t1840;
          }
        }
        if (true) {
          if (Lexer$is_ident_start(c_1836)) {
            _t1839 = Lexer$read_ident_or_keyword(l);
            break _t1840;
          }
        }
        if (true) {
          const _c = _t1838;
          if ((_c === 39)) {
            const loc_1848 = Lexer$current_loc(l);
            Lexer$advance(l);
            undefined;
            let _t1850;
            if (Lexer$at_end(l)) {
              _t1850 = Lexer$error(l, "unterminated rune literal");
            } else {
              _t1850 = undefined;
            }
            _t1850;
            let _t1851;
            if ((Lexer$peek(l) === 92)) {
              Lexer$advance(l);
              undefined;
              let _t1852;
              if (Lexer$at_end(l)) {
                _t1852 = Lexer$error(l, "unterminated rune escape");
              } else {
                _t1852 = undefined;
              }
              _t1852;
              const c_1853 = Lexer$advance(l);
              let _t1856;
              const _t1855 = c_1853;
              _t1857: {
                if (true) {
                  const _c = _t1855;
                  if ((_c === 110)) {
                    _t1856 = 10;
                    break _t1857;
                  }
                }
                if (true) {
                  const _c = _t1855;
                  if ((_c === 116)) {
                    _t1856 = 9;
                    break _t1857;
                  }
                }
                if (true) {
                  const _c = _t1855;
                  if ((_c === 92)) {
                    _t1856 = 92;
                    break _t1857;
                  }
                }
                if (true) {
                  const _c = _t1855;
                  if ((_c === 39)) {
                    _t1856 = 39;
                    break _t1857;
                  }
                }
                if (true) {
                  const _c = _t1855;
                  if ((_c === 48)) {
                    _t1856 = 0;
                    break _t1857;
                  }
                }
                if (true) {
                  _t1856 = Lexer$error(l, ("unknown rune escape: \\" + __dict_Show_byte.show(c_1853)));
                  break _t1857;
                }
                _match_fail("line 15950");
              }
              const _t1854 = _t1856;
              _t1851 = _t1854;
            } else {
              const b_1858 = Byte$to_int(Lexer$advance(l));
              let _t1860;
              if ((b_1858 < 128)) {
                _t1860 = b_1858;
              } else {
                let _t1861;
                if (((b_1858 & 224) === 192)) {
                  _t1861 = 2;
                } else {
                  let _t1862;
                  if (((b_1858 & 240) === 224)) {
                    _t1862 = 3;
                  } else {
                    let _t1863;
                    if (((b_1858 & 248) === 240)) {
                      _t1863 = 4;
                    } else {
                      _t1863 = Lexer$error(l, "invalid UTF-8 leading byte in rune literal");
                    }
                    _t1862 = _t1863;
                  }
                  _t1861 = _t1862;
                }
                const nbytes_1864 = _t1861;
                const cp_1866 = Ref$create((b_1858 & (255 >> (nbytes_1864 + 1))));
                let _loop_var_1868 = 2;
                let _t1870 = undefined;
                let _t1871 = false, _t1872;
                while (true) {
                  if (!((_loop_var_1868 <= nbytes_1864))) break;
                  let _t1873;
                  if (Lexer$at_end(l)) {
                    _t1873 = Lexer$error(l, "unterminated UTF-8 rune literal");
                  } else {
                    _t1873 = undefined;
                  }
                  _t1873;
                  const cont_1874 = Byte$to_int(Lexer$advance(l));
                  let _t1876;
                  if (((cont_1874 & 192) !== 128)) {
                    _t1876 = Lexer$error(l, "invalid UTF-8 continuation byte");
                  } else {
                    _t1876 = undefined;
                  }
                  _t1876;
                  Ref$set(cp_1866, ((Ref$get(cp_1866) << 6) | (cont_1874 & 63)));
                  const _t1875 = (_loop_var_1868 = (_loop_var_1868 + 1), undefined);
                  _t1875;
                  if (_t1871) break;
                }
                _t1870 = _t1871 ? _t1872 : undefined;
                _t1870;
                const _t1869 = Ref$get(cp_1866);
                const _t1867 = _t1869;
                const _t1865 = _t1867;
                _t1860 = _t1865;
              }
              const _t1859 = _t1860;
              _t1851 = _t1859;
            }
            const cp_1877 = _t1851;
            let _t1879;
            if ((Lexer$at_end(l) || (Lexer$peek(l) !== 39))) {
              _t1879 = Lexer$error(l, "unterminated rune literal");
            } else {
              _t1879 = undefined;
            }
            _t1879;
            Lexer$advance(l);
            undefined;
            const _t1878 = Lexer$make_token(l, ({_tag: 5, _name: "RUNE", _val: cp_1877}), loc_1848);
            const _t1849 = _t1878;
            _t1839 = _t1849;
            break _t1840;
          }
        }
        if (true) {
          const _c = _t1838;
          if ((_c === 40)) {
            Lexer$advance(l);
            undefined;
            _t1839 = Lexer$make_token(l, ({_tag: 50, _name: "LPAREN"}), loc_1834);
            break _t1840;
          }
        }
        if (true) {
          const _c = _t1838;
          if ((_c === 41)) {
            Lexer$advance(l);
            undefined;
            _t1839 = Lexer$make_token(l, ({_tag: 51, _name: "RPAREN"}), loc_1834);
            break _t1840;
          }
        }
        if (true) {
          const _c = _t1838;
          if ((_c === 35)) {
            Lexer$advance(l);
            undefined;
            let _t1880;
            if (((!Lexer$at_end(l)) && (Lexer$is_hex_digit(Lexer$peek(l)) && (((l.cursor + 1) < l.len) && Lexer$is_hex_digit(Lexer$peek2(l)))))) {
              const c1_1881 = Lexer$peek(l);
              Lexer$advance(l);
              undefined;
              const c2_1883 = Lexer$advance(l);
              const v_1885 = ((Lexer$hex_val(c1_1881) * 16) + Lexer$hex_val(c2_1883));
              const _t1886 = Lexer$make_token(l, ({_tag: 4, _name: "BYTE", _val: v_1885}), loc_1834);
              const _t1884 = _t1886;
              const _t1882 = _t1884;
              _t1880 = _t1882;
            } else {
              _t1880 = Lexer$make_token(l, ({_tag: 39, _name: "HASH"}), loc_1834);
            }
            _t1839 = _t1880;
            break _t1840;
          }
        }
        if (true) {
          const _c = _t1838;
          if ((_c === 123)) {
            let _t1887;
            if ((Lexer$peek2(l) === 124)) {
              _t1887 = Lexer$read_raw_string(l);
            } else {
              Lexer$advance(l);
              undefined;
              _t1887 = Lexer$make_token(l, ({_tag: 52, _name: "LBRACE"}), loc_1834);
            }
            _t1839 = _t1887;
            break _t1840;
          }
        }
        if (true) {
          const _c = _t1838;
          if ((_c === 125)) {
            Lexer$advance(l);
            undefined;
            _t1839 = Lexer$make_token(l, ({_tag: 53, _name: "RBRACE"}), loc_1834);
            break _t1840;
          }
        }
        if (true) {
          const _c = _t1838;
          if ((_c === 91)) {
            Lexer$advance(l);
            undefined;
            _t1839 = Lexer$make_token(l, ({_tag: 54, _name: "LBRACKET"}), loc_1834);
            break _t1840;
          }
        }
        if (true) {
          const _c = _t1838;
          if ((_c === 93)) {
            Lexer$advance(l);
            undefined;
            _t1839 = Lexer$make_token(l, ({_tag: 55, _name: "RBRACKET"}), loc_1834);
            break _t1840;
          }
        }
        if (true) {
          const _c = _t1838;
          if ((_c === 44)) {
            Lexer$advance(l);
            undefined;
            _t1839 = Lexer$make_token(l, ({_tag: 57, _name: "COMMA"}), loc_1834);
            break _t1840;
          }
        }
        if (true) {
          const _c = _t1838;
          if ((_c === 46)) {
            Lexer$advance(l);
            undefined;
            let _t1888;
            if (((!Lexer$at_end(l)) && (Lexer$peek(l) === 46))) {
              Lexer$advance(l);
              undefined;
              _t1888 = Lexer$make_token(l, ({_tag: 62, _name: "DOTDOT"}), loc_1834);
            } else {
              _t1888 = Lexer$make_token(l, ({_tag: 61, _name: "DOT"}), loc_1834);
            }
            _t1839 = _t1888;
            break _t1840;
          }
        }
        if (true) {
          const _c = _t1838;
          if ((_c === 94)) {
            Lexer$advance(l);
            undefined;
            _t1839 = Lexer$make_token(l, ({_tag: 70, _name: "CARET"}), loc_1834);
            break _t1840;
          }
        }
        if (true) {
          const _c = _t1838;
          if ((_c === 64)) {
            Lexer$advance(l);
            undefined;
            const buf_1889 = Buffer$create(16);
            let _t1891 = undefined;
            let _t1892 = false, _t1893;
            while (true) {
              let _t1896;
              if ((!Lexer$at_end(l))) {
              const c_1894 = Lexer$peek(l);
              const _t1895 = (((c_1894 >= 97) && (c_1894 <= 122)) || (c_1894 === 95));
                _t1896 = _t1895;
              } else {
                _t1896 = false;
              }
              if (!(_t1896)) break;
              Buffer$add_byte(buf_1889, Lexer$advance(l));
              if (_t1892) break;
            }
            _t1891 = _t1892 ? _t1893 : undefined;
            _t1891;
            const name_1897 = Buffer$contents(buf_1889);
            let _t1899;
            if ((name_1897 === "partial")) {
              _t1899 = Lexer$make_token(l, ({_tag: 37, _name: "PARTIAL"}), loc_1834);
            } else {
              _t1899 = Lexer$error(l, ("unknown annotation @" + __dict_Show_string.show(name_1897)));
            }
            const _t1898 = _t1899;
            const _t1890 = _t1898;
            _t1839 = _t1890;
            break _t1840;
          }
        }
        if (true) {
          const _c = _t1838;
          if ((_c === 43)) {
            Lexer$advance(l);
            undefined;
            _t1839 = Lexer$make_token(l, ({_tag: 66, _name: "PLUS"}), loc_1834);
            break _t1840;
          }
        }
        if (true) {
          const _c = _t1838;
          if ((_c === 42)) {
            Lexer$advance(l);
            undefined;
            _t1839 = Lexer$make_token(l, ({_tag: 68, _name: "STAR"}), loc_1834);
            break _t1840;
          }
        }
        if (true) {
          const _c = _t1838;
          if ((_c === 47)) {
            Lexer$advance(l);
            undefined;
            _t1839 = Lexer$make_token(l, ({_tag: 69, _name: "SLASH"}), loc_1834);
            break _t1840;
          }
        }
        if (true) {
          const _c = _t1838;
          if ((_c === 45)) {
            Lexer$advance(l);
            undefined;
            let _t1900;
            if (((!Lexer$at_end(l)) && (Lexer$peek(l) === 45))) {
              Lexer$advance(l);
              undefined;
              const buf_1901 = Buffer$create(32);
              let _t1903 = undefined;
              let _t1904 = false, _t1905;
              while (true) {
                if (!(((!Lexer$at_end(l)) && (Lexer$peek(l) !== 10)))) break;
                Buffer$add_byte(buf_1901, Lexer$advance(l));
                if (_t1904) break;
              }
              _t1903 = _t1904 ? _t1905 : undefined;
              _t1903;
              const content_1906 = String$trim(Buffer$contents(buf_1901));
              let _t1908;
              if ((content_1906 === "@partial")) {
                _t1908 = Lexer$make_token(l, ({_tag: 37, _name: "PARTIAL"}), loc_1834);
              } else {
                const _t1909 = l;
                l = _t1909;
                continue;
                _t1908 = undefined;
              }
              const _t1907 = _t1908;
              const _t1902 = _t1907;
              _t1900 = _t1902;
            } else {
              let _t1910;
              if (((!Lexer$at_end(l)) && (Lexer$peek(l) === 62))) {
                Lexer$advance(l);
                undefined;
                _t1910 = Lexer$make_token(l, ({_tag: 56, _name: "ARROW"}), loc_1834);
              } else {
                _t1910 = Lexer$make_token(l, ({_tag: 67, _name: "MINUS"}), loc_1834);
              }
              _t1900 = _t1910;
            }
            _t1839 = _t1900;
            break _t1840;
          }
        }
        if (true) {
          const _c = _t1838;
          if ((_c === 59)) {
            Lexer$advance(l);
            undefined;
            let _t1911;
            if (((!Lexer$at_end(l)) && (Lexer$peek(l) === 59))) {
              Lexer$advance(l);
              undefined;
              _t1911 = Lexer$make_token(l, ({_tag: 59, _name: "DOUBLE_SEMICOLON"}), loc_1834);
            } else {
              _t1911 = Lexer$make_token(l, ({_tag: 58, _name: "SEMICOLON"}), loc_1834);
            }
            _t1839 = _t1911;
            break _t1840;
          }
        }
        if (true) {
          const _c = _t1838;
          if ((_c === 58)) {
            Lexer$advance(l);
            undefined;
            let _t1912;
            if (((!Lexer$at_end(l)) && (Lexer$peek(l) === 61))) {
              Lexer$advance(l);
              undefined;
              _t1912 = Lexer$make_token(l, ({_tag: 72, _name: "COLONEQUAL"}), loc_1834);
            } else {
              let _t1913;
              if (((!Lexer$at_end(l)) && (Lexer$peek(l) === 58))) {
                Lexer$advance(l);
                undefined;
                _t1913 = Lexer$make_token(l, ({_tag: 71, _name: "COLONCOLON"}), loc_1834);
              } else {
                let _t1914;
                if (((!Lexer$at_end(l)) && (Lexer$peek(l) === 62))) {
                  Lexer$advance(l);
                  undefined;
                  _t1914 = Lexer$make_token(l, ({_tag: 88, _name: "COLONGT"}), loc_1834);
                } else {
                  _t1914 = Lexer$make_token(l, ({_tag: 60, _name: "COLON"}), loc_1834);
                }
                _t1913 = _t1914;
              }
              _t1912 = _t1913;
            }
            _t1839 = _t1912;
            break _t1840;
          }
        }
        if (true) {
          const _c = _t1838;
          if ((_c === 61)) {
            Lexer$advance(l);
            undefined;
            let _t1915;
            if (((!Lexer$at_end(l)) && (Lexer$peek(l) === 62))) {
              Lexer$advance(l);
              undefined;
              _t1915 = Lexer$make_token(l, ({_tag: 40, _name: "FATARROW"}), loc_1834);
            } else {
              _t1915 = Lexer$make_token(l, ({_tag: 73, _name: "EQ"}), loc_1834);
            }
            _t1839 = _t1915;
            break _t1840;
          }
        }
        if (true) {
          const _c = _t1838;
          if ((_c === 60)) {
            Lexer$advance(l);
            undefined;
            let _t1916;
            if (((!Lexer$at_end(l)) && (Lexer$peek(l) === 61))) {
              Lexer$advance(l);
              undefined;
              _t1916 = Lexer$make_token(l, ({_tag: 77, _name: "LE"}), loc_1834);
            } else {
              let _t1917;
              if (((!Lexer$at_end(l)) && (Lexer$peek(l) === 62))) {
                Lexer$advance(l);
                undefined;
                _t1917 = Lexer$make_token(l, ({_tag: 74, _name: "NEQ"}), loc_1834);
              } else {
                _t1917 = Lexer$make_token(l, ({_tag: 75, _name: "LT"}), loc_1834);
              }
              _t1916 = _t1917;
            }
            _t1839 = _t1916;
            break _t1840;
          }
        }
        if (true) {
          const _c = _t1838;
          if ((_c === 62)) {
            Lexer$advance(l);
            undefined;
            let _t1918;
            if (((!Lexer$at_end(l)) && (Lexer$peek(l) === 61))) {
              Lexer$advance(l);
              undefined;
              _t1918 = Lexer$make_token(l, ({_tag: 78, _name: "GE"}), loc_1834);
            } else {
              _t1918 = Lexer$make_token(l, ({_tag: 76, _name: "GT"}), loc_1834);
            }
            _t1839 = _t1918;
            break _t1840;
          }
        }
        if (true) {
          const _c = _t1838;
          if ((_c === 38)) {
            Lexer$advance(l);
            undefined;
            let _t1919;
            if (((!Lexer$at_end(l)) && (Lexer$peek(l) === 38))) {
              Lexer$advance(l);
              undefined;
              _t1919 = Lexer$make_token(l, ({_tag: 79, _name: "AMPAMP"}), loc_1834);
            } else {
              _t1919 = Lexer$error(l, "unexpected '&', did you mean '&&'?");
            }
            _t1839 = _t1919;
            break _t1840;
          }
        }
        if (true) {
          const _c = _t1838;
          if ((_c === 124)) {
            Lexer$advance(l);
            undefined;
            let _t1920;
            if (((!Lexer$at_end(l)) && (Lexer$peek(l) === 124))) {
              Lexer$advance(l);
              undefined;
              _t1920 = Lexer$make_token(l, ({_tag: 80, _name: "PIPEPIPE"}), loc_1834);
            } else {
              let _t1921;
              if (((!Lexer$at_end(l)) && (Lexer$peek(l) === 62))) {
                Lexer$advance(l);
                undefined;
                _t1921 = Lexer$make_token(l, ({_tag: 64, _name: "PIPEARROW"}), loc_1834);
              } else {
                _t1921 = Lexer$make_token(l, ({_tag: 63, _name: "PIPE"}), loc_1834);
              }
              _t1920 = _t1921;
            }
            _t1839 = _t1920;
            break _t1840;
          }
        }
        if (true) {
          const _c = _t1838;
          if ((_c === 96)) {
            Lexer$advance(l);
            undefined;
            let _t1922;
            if (((!Lexer$at_end(l)) && ((Lexer$peek(l) >= 65) && (Lexer$peek(l) <= 90)))) {
              const buf_1923 = Buffer$create(16);
              let _t1925 = undefined;
              let _t1926 = false, _t1927;
              while (true) {
                if (!(((!Lexer$at_end(l)) && Lexer$is_ident_char(Lexer$peek(l))))) break;
                Buffer$add_byte(buf_1923, Lexer$advance(l));
                if (_t1926) break;
              }
              _t1925 = _t1926 ? _t1927 : undefined;
              _t1925;
              const _t1924 = Lexer$make_token(l, ({_tag: 87, _name: "POLYTAG", _val: Buffer$contents(buf_1923)}), loc_1834);
              _t1922 = _t1924;
            } else {
              _t1922 = Lexer$error(l, "expected uppercase identifier after backtick");
            }
            _t1839 = _t1922;
            break _t1840;
          }
        }
        if (true) {
          _t1839 = Lexer$error(l, ("unexpected character: " + __dict_Show_byte.show(c_1836)));
          break _t1840;
        }
        _match_fail("line 15950");
      }
      const _t1837 = _t1839;
      const _t1835 = _t1837;
      _t1833 = _t1835;
    }
    return _t1833;
  }
}
function Lexer$tokenize(source) {
  const l_1928 = Lexer$create(source);
  const tokens_1930 = Ref$create(null);
  const stop_1932 = Ref$create(false);
  let _t1934 = undefined;
  let _t1935 = false, _t1936;
  while (true) {
    if (!((!Ref$get(stop_1932)))) break;
    const tok_1937 = Lexer$next_token(l_1928);
    Ref$set(tokens_1930, ({_hd: tok_1937, _tl: Ref$get(tokens_1930)}));
    let _t1939;
    if (_eq(tok_1937.kind, ({_tag: 89, _name: "EOF"}))) {
      _t1939 = Ref$set(stop_1932, true);
    } else {
      _t1939 = undefined;
    }
    const _t1938 = _t1939;
    _t1938;
    if (_t1935) break;
  }
  _t1934 = _t1935 ? _t1936 : undefined;
  _t1934;
  const _t1933 = List$rev(Ref$get(tokens_1930));
  const _t1931 = _t1933;
  const _t1929 = _t1931;
  return _t1929;
}
function Parser$create(tokens) {
  return ({pos: 0, tokens: Array$of_list(tokens)});
}
function Parser$peek(p) {
  return Array$get(p.tokens, p.pos);
}
function Parser$peek_kind(p) {
  return Parser$peek(p).kind;
}
function Parser$peek_kind_at(p, offset) {
  const idx_1940 = (p.pos + offset);
  let _t1942;
  if ((idx_1940 < Array$length(p.tokens))) {
    _t1942 = Array$get(p.tokens, idx_1940).kind;
  } else {
    _t1942 = ({_tag: 89, _name: "EOF"});
  }
  const _t1941 = _t1942;
  return _t1941;
}
function Parser$advance(p) {
  const tok_1943 = Array$get(p.tokens, p.pos);
  let _t1945;
  if (!_eq(tok_1943.kind, ({_tag: 89, _name: "EOF"}))) {
    _t1945 = (p.pos = (p.pos + 1), undefined);
  } else {
    _t1945 = undefined;
  }
  _t1945;
  const _t1944 = tok_1943;
  return _t1944;
}
function Parser$error(p, msg) {
  return _trampoline(function() {
    const tok_1946 = Parser$peek(p);
    return _h["parse_error"]([msg, tok_1946.loc], function(_t1947) {
      return _bounce(function() {
        return _t1947;
      });
    });
  }, Parser$error);
}
function Parser$expect(p, kind) {
  const tok_1948 = Parser$peek(p);
  let _t1950;
  if (_eq(tok_1948.kind, kind)) {
    Parser$advance(p);
    _t1950 = undefined;
  } else {
    _t1950 = Parser$error(p, ((("expected " + __dict_Show_string.show(Token$pp_token_kind(kind))) + ", got ") + __dict_Show_string.show(Token$pp_token_kind(tok_1948.kind))));
  }
  const _t1949 = _t1950;
  return _t1949;
}
function Parser$expect_ident(p) {
  let _t1952;
  const _t1951 = Parser$peek(p).kind;
  _t1953: {
    if (_t1951._tag === 8) {
      const s = _t1951._val;
      Parser$advance(p);
      undefined;
      _t1952 = s;
      break _t1953;
    }
    if (_t1951._tag === 65) {
      Parser$advance(p);
      undefined;
      _t1952 = "_";
      break _t1953;
    }
    if (true) {
      _t1952 = Parser$error(p, "expected identifier");
      break _t1953;
    }
    _match_fail("line 15950");
  }
  return _t1952;
}
function Parser$expect_uident(p) {
  let _t1955;
  const _t1954 = Parser$peek(p).kind;
  _t1956: {
    if (_t1954._tag === 9) {
      const s = _t1954._val;
      Parser$advance(p);
      undefined;
      _t1955 = s;
      break _t1956;
    }
    if (true) {
      _t1955 = Parser$error(p, "expected constructor name");
      break _t1956;
    }
    _match_fail("line 15950");
  }
  return _t1955;
}
function Parser$keyword_as_ident(__x) {
  let _t1958;
  const _t1957 = __x;
  _t1959: {
    if (_t1957._tag === 41) {
      _t1958 = ({_tag: 1, _name: "Some", _val: "mod"});
      break _t1959;
    }
    if (_t1957._tag === 38) {
      _t1958 = ({_tag: 1, _name: "Some", _val: "not"});
      break _t1959;
    }
    if (_t1957._tag === 81) {
      _t1958 = ({_tag: 1, _name: "Some", _val: "land"});
      break _t1959;
    }
    if (_t1957._tag === 82) {
      _t1958 = ({_tag: 1, _name: "Some", _val: "lor"});
      break _t1959;
    }
    if (_t1957._tag === 83) {
      _t1958 = ({_tag: 1, _name: "Some", _val: "lxor"});
      break _t1959;
    }
    if (_t1957._tag === 84) {
      _t1958 = ({_tag: 1, _name: "Some", _val: "lnot"});
      break _t1959;
    }
    if (_t1957._tag === 85) {
      _t1958 = ({_tag: 1, _name: "Some", _val: "lsl"});
      break _t1959;
    }
    if (_t1957._tag === 86) {
      _t1958 = ({_tag: 1, _name: "Some", _val: "lsr"});
      break _t1959;
    }
    if (true) {
      _t1958 = ({_tag: 0, _name: "None"});
      break _t1959;
    }
    _match_fail("line 15950");
  }
  return _t1958;
}
function Parser$token_to_op_name(__x) {
  let _t1961;
  const _t1960 = __x;
  _t1962: {
    if (_t1960._tag === 66) {
      _t1961 = ({_tag: 1, _name: "Some", _val: "+"});
      break _t1962;
    }
    if (_t1960._tag === 67) {
      _t1961 = ({_tag: 1, _name: "Some", _val: "-"});
      break _t1962;
    }
    if (_t1960._tag === 68) {
      _t1961 = ({_tag: 1, _name: "Some", _val: "*"});
      break _t1962;
    }
    if (_t1960._tag === 69) {
      _t1961 = ({_tag: 1, _name: "Some", _val: "/"});
      break _t1962;
    }
    if (_t1960._tag === 41) {
      _t1961 = ({_tag: 1, _name: "Some", _val: "mod"});
      break _t1962;
    }
    if (_t1960._tag === 70) {
      _t1961 = ({_tag: 1, _name: "Some", _val: "^"});
      break _t1962;
    }
    if (_t1960._tag === 79) {
      _t1961 = ({_tag: 1, _name: "Some", _val: "&&"});
      break _t1962;
    }
    if (_t1960._tag === 80) {
      _t1961 = ({_tag: 1, _name: "Some", _val: "||"});
      break _t1962;
    }
    if (_t1960._tag === 38) {
      _t1961 = ({_tag: 1, _name: "Some", _val: "not"});
      break _t1962;
    }
    if (_t1960._tag === 75) {
      _t1961 = ({_tag: 1, _name: "Some", _val: "<"});
      break _t1962;
    }
    if (_t1960._tag === 76) {
      _t1961 = ({_tag: 1, _name: "Some", _val: ">"});
      break _t1962;
    }
    if (_t1960._tag === 77) {
      _t1961 = ({_tag: 1, _name: "Some", _val: "<="});
      break _t1962;
    }
    if (_t1960._tag === 78) {
      _t1961 = ({_tag: 1, _name: "Some", _val: ">="});
      break _t1962;
    }
    if (_t1960._tag === 73) {
      _t1961 = ({_tag: 1, _name: "Some", _val: "="});
      break _t1962;
    }
    if (_t1960._tag === 74) {
      _t1961 = ({_tag: 1, _name: "Some", _val: "<>"});
      break _t1962;
    }
    if (_t1960._tag === 81) {
      _t1961 = ({_tag: 1, _name: "Some", _val: "land"});
      break _t1962;
    }
    if (_t1960._tag === 82) {
      _t1961 = ({_tag: 1, _name: "Some", _val: "lor"});
      break _t1962;
    }
    if (_t1960._tag === 83) {
      _t1961 = ({_tag: 1, _name: "Some", _val: "lxor"});
      break _t1962;
    }
    if (_t1960._tag === 84) {
      _t1961 = ({_tag: 1, _name: "Some", _val: "lnot"});
      break _t1962;
    }
    if (_t1960._tag === 85) {
      _t1961 = ({_tag: 1, _name: "Some", _val: "lsl"});
      break _t1962;
    }
    if (_t1960._tag === 86) {
      _t1961 = ({_tag: 1, _name: "Some", _val: "lsr"});
      break _t1962;
    }
    if (true) {
      _t1961 = ({_tag: 0, _name: "None"});
      break _t1962;
    }
    _match_fail("line 15950");
  }
  return _t1961;
}
function Parser$read_qualified_path(p, first_uident) {
  const path_1963 = Ref$create(({_hd: first_uident, _tl: null}));
  const result_1965 = Ref$create(({_tag: 0, _name: "None"}));
  const continue__1967 = Ref$create(true);
  let _t1969 = undefined;
  let _t1970 = false, _t1971;
  while (true) {
    if (!(Ref$get(continue__1967))) break;
    let _t1972;
    if (_eq(Parser$peek_kind(p), ({_tag: 61, _name: "DOT"}))) {
      const next_1973 = Parser$peek_kind_at(p, 1);
      let _t1976;
      const _t1975 = next_1973;
      _t1977: {
        if (_t1975._tag === 8) {
          const s = _t1975._val;
          Parser$advance(p);
          undefined;
          Parser$advance(p);
          undefined;
          const qualified_1978 = (String$concat(".", List$rev(Ref$get(path_1963))) + ("." + s));
          Ref$set(result_1965, ({_tag: 1, _name: "Some", _val: ({_tag: 958595272, _name: "`Var", _val: qualified_1978})}));
          const _t1979 = Ref$set(continue__1967, false);
          _t1976 = _t1979;
          break _t1977;
        }
        if (_t1975._tag === 9) {
          const s = _t1975._val;
          Parser$advance(p);
          undefined;
          Parser$advance(p);
          undefined;
          _t1976 = Ref$set(path_1963, ({_hd: s, _tl: Ref$get(path_1963)}));
          break _t1977;
        }
        if (_t1975._tag === 50) {
          let _t1981;
          const _t1980 = Parser$token_to_op_name(Parser$peek_kind_at(p, 2));
          _t1982: {
            if (_t1980._tag === 1) {
              const op = _t1980._val;
              if (_eq(Parser$peek_kind_at(p, 3), ({_tag: 51, _name: "RPAREN"}))) {
                Parser$advance(p);
                undefined;
                Parser$advance(p);
                undefined;
                Parser$advance(p);
                undefined;
                Parser$advance(p);
                undefined;
                const qualified_1983 = (String$concat(".", List$rev(Ref$get(path_1963))) + ("." + op));
                Ref$set(result_1965, ({_tag: 1, _name: "Some", _val: ({_tag: 958595272, _name: "`Var", _val: qualified_1983})}));
                const _t1984 = Ref$set(continue__1967, false);
                _t1981 = _t1984;
                break _t1982;
              }
            }
            if (true) {
              Parser$advance(p);
              undefined;
              const mod_path_1985 = String$concat(".", List$rev(Ref$get(path_1963)));
              Ref$set(result_1965, ({_tag: 1, _name: "Some", _val: ({_tag: 982234060, _name: "`LocalOpen", _val: mod_path_1985})}));
              const _t1986 = Ref$set(continue__1967, false);
              _t1981 = _t1986;
              break _t1982;
            }
            _match_fail("line 15950");
          }
          _t1976 = _t1981;
          break _t1977;
        }
        if (true) {
          const kw = _t1975;
          let _t1988;
          const _t1987 = Parser$keyword_as_ident(kw);
          _t1989: {
            if (_t1987._tag === 1) {
              const s = _t1987._val;
              Parser$advance(p);
              undefined;
              Parser$advance(p);
              undefined;
              const qualified_1990 = (String$concat(".", List$rev(Ref$get(path_1963))) + ("." + s));
              Ref$set(result_1965, ({_tag: 1, _name: "Some", _val: ({_tag: 958595272, _name: "`Var", _val: qualified_1990})}));
              const _t1991 = Ref$set(continue__1967, false);
              _t1988 = _t1991;
              break _t1989;
            }
            if (_t1987._tag === 0) {
              _t1988 = Ref$set(continue__1967, false);
              break _t1989;
            }
            _match_fail("line 15950");
          }
          _t1976 = _t1988;
          break _t1977;
        }
        _match_fail("line 15950");
      }
      const _t1974 = _t1976;
      _t1972 = _t1974;
    } else {
      _t1972 = Ref$set(continue__1967, false);
    }
    _t1972;
    if (_t1970) break;
  }
  _t1969 = _t1970 ? _t1971 : undefined;
  _t1969;
  let _t1993;
  const _t1992 = Ref$get(result_1965);
  _t1994: {
    if (_t1992._tag === 1) {
      const r = _t1992._val;
      _t1993 = r;
      break _t1994;
    }
    if (_t1992._tag === 0) {
      let _t1996;
      const _t1995 = Ref$get(path_1963);
      _t1997: {
        if (_t1995 !== null && _t1995._tl === null) {
          const single = _t1995._hd;
          _t1996 = ({_tag: 1067578635, _name: "`Constructor", _val: single});
          break _t1997;
        }
        if (true) {
          const rev_1998 = List$rev(Ref$get(path_1963));
          const last_2000 = List$hd(List$rev(rev_1998));
          const prefix_2002 = List$rev(List$tl(List$rev(rev_1998)));
          const qualified_2004 = (String$concat(".", prefix_2002) + ("." + last_2000));
          const _t2005 = ({_tag: 1067578635, _name: "`Constructor", _val: qualified_2004});
          const _t2003 = _t2005;
          const _t2001 = _t2003;
          const _t1999 = _t2001;
          _t1996 = _t1999;
          break _t1997;
        }
        _match_fail("line 15950");
      }
      _t1993 = _t1996;
      break _t1994;
    }
    _match_fail("line 15950");
  }
  const _t1968 = _t1993;
  const _t1966 = _t1968;
  const _t1964 = _t1966;
  return _t1964;
}
function Parser$at_expr_start(p) {
  let _t2007;
  const _t2006 = Parser$peek_kind(p);
  _t2008: {
    if (((((((((((((((((((((((((((((((_t2006._tag === 0 || _t2006._tag === 1) || _t2006._tag === 2) || _t2006._tag === 3) || _t2006._tag === 4) || _t2006._tag === 5) || _t2006._tag === 6) || _t2006._tag === 7) || _t2006._tag === 8) || _t2006._tag === 9) || _t2006._tag === 50) || _t2006._tag === 52) || _t2006._tag === 54) || _t2006._tag === 16) || _t2006._tag === 14) || _t2006._tag === 11) || _t2006._tag === 17) || _t2006._tag === 67) || _t2006._tag === 38) || _t2006._tag === 84) || _t2006._tag === 25) || _t2006._tag === 26) || _t2006._tag === 27) || _t2006._tag === 29) || _t2006._tag === 32) || _t2006._tag === 34) || _t2006._tag === 28) || _t2006._tag === 30) || _t2006._tag === 39) || _t2006._tag === 33) || _t2006._tag === 87)) {
      _t2007 = true;
      break _t2008;
    }
    if (true) {
      _t2007 = false;
      break _t2008;
    }
    _match_fail("line 15950");
  }
  return _t2007;
}
function Parser$parse_ty_atom(p) {
  let _t2010;
  const _t2009 = Parser$peek_kind(p);
  _t2011: {
    if (_t2009._tag === 8 && _t2009._val === "int") {
      Parser$advance(p);
      undefined;
      _t2010 = ({_tag: 0, _name: "TyName", _val: "int"});
      break _t2011;
    }
    if (_t2009._tag === 8 && _t2009._val === "bool") {
      Parser$advance(p);
      undefined;
      _t2010 = ({_tag: 0, _name: "TyName", _val: "bool"});
      break _t2011;
    }
    if (_t2009._tag === 8 && _t2009._val === "string") {
      Parser$advance(p);
      undefined;
      _t2010 = ({_tag: 0, _name: "TyName", _val: "string"});
      break _t2011;
    }
    if (_t2009._tag === 8 && _t2009._val === "unit") {
      Parser$advance(p);
      undefined;
      _t2010 = ({_tag: 0, _name: "TyName", _val: "unit"});
      break _t2011;
    }
    if (_t2009._tag === 8) {
      const s = _t2009._val;
      Parser$advance(p);
      undefined;
      _t2010 = ({_tag: 0, _name: "TyName", _val: s});
      break _t2011;
    }
    if (_t2009._tag === 9) {
      const s = _t2009._val;
      Parser$advance(p);
      undefined;
      const mod_parts_2012 = Ref$create(({_hd: s, _tl: null}));
      const final_name_2014 = Ref$create(({_tag: 0, _name: "None"}));
      const continue_reading_2016 = Ref$create(true);
      let _t2018 = undefined;
      let _t2019 = false, _t2020;
      while (true) {
        if (!(Ref$get(continue_reading_2016))) break;
        let _t2021;
        if (_eq(Parser$peek_kind(p), ({_tag: 61, _name: "DOT"}))) {
          let _t2023;
          const _t2022 = Parser$peek_kind_at(p, 1);
          _t2024: {
            if (_t2022._tag === 9) {
              const s2 = _t2022._val;
              Parser$advance(p);
              undefined;
              Parser$advance(p);
              undefined;
              _t2023 = Ref$set(mod_parts_2012, ({_hd: s2, _tl: Ref$get(mod_parts_2012)}));
              break _t2024;
            }
            if (_t2022._tag === 8) {
              const s2 = _t2022._val;
              Parser$advance(p);
              undefined;
              Parser$advance(p);
              undefined;
              Ref$set(final_name_2014, ({_tag: 1, _name: "Some", _val: s2}));
              _t2023 = Ref$set(continue_reading_2016, false);
              break _t2024;
            }
            if (true) {
              _t2023 = Ref$set(continue_reading_2016, false);
              break _t2024;
            }
            _match_fail("line 15950");
          }
          _t2021 = _t2023;
        } else {
          _t2021 = Ref$set(continue_reading_2016, false);
        }
        _t2021;
        if (_t2019) break;
      }
      _t2018 = _t2019 ? _t2020 : undefined;
      _t2018;
      let _t2026;
      const _t2025 = Ref$get(final_name_2014);
      _t2027: {
        if (_t2025._tag === 1) {
          const name = _t2025._val;
          _t2026 = ({_tag: 9, _name: "TyQualified", _val: [List$rev(Ref$get(mod_parts_2012)), name]});
          break _t2027;
        }
        if (_t2025._tag === 0) {
          _t2026 = ({_tag: 0, _name: "TyName", _val: s});
          break _t2027;
        }
        _match_fail("line 15950");
      }
      const _t2017 = _t2026;
      const _t2015 = _t2017;
      const _t2013 = _t2015;
      _t2010 = _t2013;
      break _t2011;
    }
    if (_t2009._tag === 10) {
      const s = _t2009._val;
      Parser$advance(p);
      undefined;
      _t2010 = ({_tag: 1, _name: "TyVar", _val: s});
      break _t2011;
    }
    if (_t2009._tag === 50) {
      Parser$advance(p);
      undefined;
      const ty_2028 = Parser$parse_ty(p);
      let _t2030;
      if (_eq(Parser$peek_kind(p), ({_tag: 57, _name: "COMMA"}))) {
        const parts_2031 = Ref$create(({_hd: ty_2028, _tl: null}));
        let _t2033 = undefined;
        let _t2034 = false, _t2035;
        while (true) {
          if (!(_eq(Parser$peek_kind(p), ({_tag: 57, _name: "COMMA"})))) break;
          Parser$advance(p);
          undefined;
          Ref$set(parts_2031, ({_hd: Parser$parse_ty(p), _tl: Ref$get(parts_2031)}));
          if (_t2034) break;
        }
        _t2033 = _t2034 ? _t2035 : undefined;
        _t2033;
        Parser$expect(p, ({_tag: 51, _name: "RPAREN"}));
        const _t2032 = ({_tag: 6, _name: "TyTuple", _val: List$rev(Ref$get(parts_2031))});
        _t2030 = _t2032;
      } else {
        Parser$expect(p, ({_tag: 51, _name: "RPAREN"}));
        _t2030 = ty_2028;
      }
      const _t2029 = _t2030;
      _t2010 = _t2029;
      break _t2011;
    }
    if (_t2009._tag === 52) {
      Parser$advance(p);
      undefined;
      let _t2037;
      const _t2036 = Parser$parse_ty_record_fields(p);
      _t2038: {
        if (true) {
          const fields = _t2036[0];
          const is_open = _t2036[1];
          Parser$expect(p, ({_tag: 53, _name: "RBRACE"}));
          function _t2039(__p30) {
            let _t2041;
            const _t2040 = __p30;
            _t2042: {
              if (true) {
                const n = _t2040[1];
                const t = _t2040[2];
                _t2041 = [n, t];
                break _t2042;
              }
              _match_fail("line 15950");
            }
            return _t2041;
          }
          _t2037 = ({_tag: 3, _name: "TyRecord", _val: [List$map(_t2039, fields), is_open]});
          break _t2038;
        }
        _match_fail("line 15950");
      }
      _t2010 = _t2037;
      break _t2011;
    }
    if (_t2009._tag === 54) {
      Parser$advance(p);
      undefined;
      let _t2044;
      const _t2043 = Parser$peek_kind(p);
      _t2045: {
        if (_t2043._tag === 76) {
          Parser$advance(p);
          undefined;
          _t2044 = ({_tag: 1, _name: "PVLower"});
          break _t2045;
        }
        if (_t2043._tag === 75) {
          Parser$advance(p);
          undefined;
          _t2044 = ({_tag: 2, _name: "PVUpper"});
          break _t2045;
        }
        if (true) {
          _t2044 = ({_tag: 0, _name: "PVExact"});
          break _t2045;
        }
        _match_fail("line 15950");
      }
      const kind_2046 = _t2044;
      let _t2048;
      if (_eq(Parser$peek_kind(p), ({_tag: 63, _name: "PIPE"}))) {
        Parser$advance(p);
        _t2048 = undefined;
      } else {
        _t2048 = undefined;
      }
      _t2048;
      const tags_2049 = Ref$create(null);
      let _t2051 = undefined;
      let _t2052 = false, _t2053;
      while (true) {
        let _t2055;
        const _t2054 = Parser$peek_kind(p);
        _t2056: {
          if (_t2054._tag === 87) {
            _t2055 = true;
            break _t2056;
          }
          if (true) {
            _t2055 = false;
            break _t2056;
          }
          _match_fail("line 15950");
        }
        if (!(_t2055)) break;
        let _t2058;
        const _t2057 = Parser$advance(p).kind;
        _t2059: {
          if (_t2057._tag === 87) {
            const s = _t2057._val;
            _t2058 = s;
            break _t2059;
          }
          if (true) {
            _t2058 = failwith("assert false");
            break _t2059;
          }
          _match_fail("line 15950");
        }
        const tag_2060 = _t2058;
        let _t2062;
        if (_eq(Parser$peek_kind(p), ({_tag: 20, _name: "OF"}))) {
          Parser$advance(p);
          undefined;
          _t2062 = ({_tag: 1, _name: "Some", _val: Parser$parse_ty(p)});
        } else {
          _t2062 = ({_tag: 0, _name: "None"});
        }
        const payload_2063 = _t2062;
        Ref$set(tags_2049, ({_hd: [tag_2060, payload_2063], _tl: Ref$get(tags_2049)}));
        let _t2065;
        if (_eq(Parser$peek_kind(p), ({_tag: 63, _name: "PIPE"}))) {
          Parser$advance(p);
          _t2065 = undefined;
        } else {
          _t2065 = undefined;
        }
        const _t2064 = _t2065;
        const _t2061 = _t2064;
        _t2061;
        if (_t2052) break;
      }
      _t2051 = _t2052 ? _t2053 : undefined;
      _t2051;
      Parser$expect(p, ({_tag: 55, _name: "RBRACKET"}));
      const _t2050 = ({_tag: 10, _name: "TyPolyVariant", _val: [kind_2046, List$rev(Ref$get(tags_2049))]});
      const _t2047 = _t2050;
      _t2010 = _t2047;
      break _t2011;
    }
    if (true) {
      _t2010 = Parser$error(p, "expected type");
      break _t2011;
    }
    _match_fail("line 15950");
  }
  return _t2010;
}
function Parser$parse_ty_postfix(p) {
  const ty_2066 = Parser$parse_ty_atom(p);
  function loop(ty) {
    while (true) {
      let _t2069;
      const _t2068 = Parser$peek_kind(p);
      _t2070: {
        if (_t2068._tag === 8 && _t2068._val === "list") {
          Parser$advance(p);
          undefined;
          const _t2071 = ({_tag: 4, _name: "TyList", _val: ty});
          ty = _t2071;
          continue;
          _t2069 = undefined;
          break _t2070;
        }
        if (_t2068._tag === 8 && _t2068._val === "array") {
          Parser$advance(p);
          undefined;
          const _t2072 = ({_tag: 5, _name: "TyArray", _val: ty});
          ty = _t2072;
          continue;
          _t2069 = undefined;
          break _t2070;
        }
        if (_t2068._tag === 8 && _t2068._val === "map") {
          Parser$advance(p);
          undefined;
          let _t2074;
          const _t2073 = ty;
          _t2075: {
            if (_t2073._tag === 6 && _t2073._val !== null && _t2073._val._tl !== null && _t2073._val._tl._tl === null) {
              const k = _t2073._val._hd;
              const v = _t2073._val._tl._hd;
              const _t2076 = ({_tag: 8, _name: "TyMap", _val: [k, v]});
              ty = _t2076;
              continue;
              _t2074 = undefined;
              break _t2075;
            }
            if (true) {
              _t2074 = Parser$error(p, "map type requires two type arguments: (k, v) map");
              break _t2075;
            }
            _match_fail("line 15950");
          }
          _t2069 = _t2074;
          break _t2070;
        }
        if (_t2068._tag === 8) {
          const name = _t2068._val;
          if (!_eq(Parser$peek_kind_at(p, 1), ({_tag: 60, _name: "COLON"}))) {
            Parser$advance(p);
            undefined;
            let _t2078;
            const _t2077 = ty;
            _t2079: {
              if (_t2077._tag === 6) {
                const parts = _t2077._val;
                _t2078 = parts;
                break _t2079;
              }
              if (true) {
                _t2078 = ({_hd: ty, _tl: null});
                break _t2079;
              }
              _match_fail("line 15950");
            }
            const args_2080 = _t2078;
            const _t2082 = ({_tag: 7, _name: "TyApp", _val: [args_2080, name]});
            ty = _t2082;
            continue;
            const _t2081 = undefined;
            _t2069 = _t2081;
            break _t2070;
          }
        }
        if (_t2068._tag === 9) {
          if (_eq(Parser$peek_kind_at(p, 1), ({_tag: 61, _name: "DOT"}))) {
            const mod_parts_2083 = Ref$create(null);
            let _t2086;
            const _t2085 = Parser$advance(p).kind;
            _t2087: {
              if (_t2085._tag === 9) {
                const s = _t2085._val;
                _t2086 = s;
                break _t2087;
              }
              if (true) {
                _t2086 = failwith("assert false");
                break _t2087;
              }
              _match_fail("line 15950");
            }
            const first_mod_2088 = _t2086;
            Ref$set(mod_parts_2083, ({_hd: first_mod_2088, _tl: null}));
            const final_name_2090 = Ref$create("");
            const continue_reading_2092 = Ref$create(true);
            let _t2094 = undefined;
            let _t2095 = false, _t2096;
            while (true) {
              if (!(Ref$get(continue_reading_2092))) break;
              let _t2097;
              if (_eq(Parser$peek_kind(p), ({_tag: 61, _name: "DOT"}))) {
                let _t2099;
                const _t2098 = Parser$peek_kind_at(p, 1);
                _t2100: {
                  if (_t2098._tag === 9) {
                    const s2 = _t2098._val;
                    Parser$advance(p);
                    undefined;
                    Parser$advance(p);
                    undefined;
                    _t2099 = Ref$set(mod_parts_2083, ({_hd: s2, _tl: Ref$get(mod_parts_2083)}));
                    break _t2100;
                  }
                  if (_t2098._tag === 8) {
                    const s2 = _t2098._val;
                    Parser$advance(p);
                    undefined;
                    Parser$advance(p);
                    undefined;
                    Ref$set(final_name_2090, s2);
                    _t2099 = Ref$set(continue_reading_2092, false);
                    break _t2100;
                  }
                  if (true) {
                    _t2099 = Ref$set(continue_reading_2092, false);
                    break _t2100;
                  }
                  _match_fail("line 15950");
                }
                _t2097 = _t2099;
              } else {
                _t2097 = Ref$set(continue_reading_2092, false);
              }
              _t2097;
              if (_t2095) break;
            }
            _t2094 = _t2095 ? _t2096 : undefined;
            _t2094;
            let _t2101;
            if ((Ref$get(final_name_2090) === "")) {
              _t2101 = Parser$error(p, "expected Module.typename in type annotation");
            } else {
              const qualified_2102 = (String$concat(".", List$rev(Ref$get(mod_parts_2083))) + ("." + Ref$get(final_name_2090)));
              let _t2105;
              const _t2104 = ty;
              _t2106: {
                if (_t2104._tag === 6) {
                  const parts = _t2104._val;
                  _t2105 = parts;
                  break _t2106;
                }
                if (true) {
                  _t2105 = ({_hd: ty, _tl: null});
                  break _t2106;
                }
                _match_fail("line 15950");
              }
              const args_2107 = _t2105;
              const _t2109 = ({_tag: 7, _name: "TyApp", _val: [args_2107, qualified_2102]});
              ty = _t2109;
              continue;
              const _t2108 = undefined;
              const _t2103 = _t2108;
              _t2101 = _t2103;
            }
            const _t2093 = _t2101;
            const _t2091 = _t2093;
            const _t2089 = _t2091;
            const _t2084 = _t2089;
            _t2069 = _t2084;
            break _t2070;
          }
        }
        if (true) {
          _t2069 = ty;
          break _t2070;
        }
        _match_fail("line 15950");
      }
      return _t2069;
    }
  }
  const _t2110 = loop(ty_2066);
  const _t2067 = _t2110;
  return _t2067;
}
function Parser$parse_ty_tuple(p) {
  const first_2111 = Parser$parse_ty_postfix(p);
  let _t2114;
  const _t2113 = Parser$peek_kind(p);
  _t2115: {
    if (_t2113._tag === 68) {
      const parts_2116 = Ref$create(({_hd: first_2111, _tl: null}));
      let _t2118 = undefined;
      let _t2119 = false, _t2120;
      while (true) {
        if (!(_eq(Parser$peek_kind(p), ({_tag: 68, _name: "STAR"})))) break;
        Parser$advance(p);
        undefined;
        Ref$set(parts_2116, ({_hd: Parser$parse_ty_postfix(p), _tl: Ref$get(parts_2116)}));
        if (_t2119) break;
      }
      _t2118 = _t2119 ? _t2120 : undefined;
      _t2118;
      const _t2117 = ({_tag: 6, _name: "TyTuple", _val: List$rev(Ref$get(parts_2116))});
      _t2114 = _t2117;
      break _t2115;
    }
    if (true) {
      _t2114 = first_2111;
      break _t2115;
    }
    _match_fail("line 15950");
  }
  const _t2112 = _t2114;
  return _t2112;
}
function Parser$parse_ty(p) {
  const left_2121 = Parser$parse_ty_tuple(p);
  let _t2124;
  const _t2123 = Parser$peek_kind(p);
  _t2125: {
    if (_t2123._tag === 56) {
      Parser$advance(p);
      undefined;
      const right_2126 = Parser$parse_ty(p);
      let _t2128;
      if (_eq(Parser$peek_kind(p), ({_tag: 69, _name: "SLASH"}))) {
        Parser$advance(p);
        undefined;
        let _t2129;
        if (_eq(Parser$peek_kind(p), ({_tag: 8, _name: "IDENT", _val: "pure"}))) {
          Parser$advance(p);
          undefined;
          _t2129 = ({_tag: 1, _name: "Some", _val: ({_tag: 0, _name: "EffAnnotPure"})});
        } else {
          _t2129 = ({_tag: 1, _name: "Some", _val: ({_tag: 1, _name: "EffAnnotRow", _val: Parser$parse_eff_items(p)})});
        }
        _t2128 = _t2129;
      } else {
        _t2128 = ({_tag: 0, _name: "None"});
      }
      const eff_2130 = _t2128;
      const _t2131 = ({_tag: 2, _name: "TyArrow", _val: [left_2121, right_2126, eff_2130]});
      const _t2127 = _t2131;
      _t2124 = _t2127;
      break _t2125;
    }
    if (true) {
      _t2124 = left_2121;
      break _t2125;
    }
    _match_fail("line 15950");
  }
  const _t2122 = _t2124;
  return _t2122;
}
function Parser$is_eff_param_start(__x) {
  let _t2133;
  const _t2132 = __x;
  _t2134: {
    if ((((_t2132._tag === 8 || _t2132._tag === 10) || _t2132._tag === 50) || _t2132._tag === 52)) {
      _t2133 = true;
      break _t2134;
    }
    if (true) {
      _t2133 = false;
      break _t2134;
    }
    _match_fail("line 15950");
  }
  return _t2133;
}
function Parser$parse_eff_type_params(p) {
  const params_2135 = Ref$create(null);
  let _t2137 = undefined;
  let _t2138 = false, _t2139;
  while (true) {
    if (!(Parser$is_eff_param_start(Parser$peek_kind(p)))) break;
    Ref$set(params_2135, ({_hd: Parser$parse_ty_atom(p), _tl: Ref$get(params_2135)}));
    if (_t2138) break;
  }
  _t2137 = _t2138 ? _t2139 : undefined;
  _t2137;
  const _t2136 = List$rev(Ref$get(params_2135));
  return _t2136;
}
function Parser$parse_eff_items(p) {
  const items_2140 = Ref$create(null);
  const continue_parsing_2142 = Ref$create(true);
  let _t2144 = undefined;
  let _t2145 = false, _t2146;
  while (true) {
    if (!(Ref$get(continue_parsing_2142))) break;
    let _t2148;
    const _t2147 = Parser$peek_kind(p);
    _t2149: {
      if (_t2147._tag === 9) {
        const name_2150 = Parser$expect_uident(p);
        const params_2152 = Parser$parse_eff_type_params(p);
        Ref$set(items_2140, ({_hd: ({_tag: 0, _name: "EffLabel", _val: [name_2150, params_2152]}), _tl: Ref$get(items_2140)}));
        let _t2154;
        if (_eq(Parser$peek_kind(p), ({_tag: 57, _name: "COMMA"}))) {
          Parser$advance(p);
          _t2154 = undefined;
        } else {
          _t2154 = Ref$set(continue_parsing_2142, false);
        }
        const _t2153 = _t2154;
        const _t2151 = _t2153;
        _t2148 = _t2151;
        break _t2149;
      }
      if (_t2147._tag === 10) {
        const s = _t2147._val;
        Parser$advance(p);
        undefined;
        Ref$set(items_2140, ({_hd: ({_tag: 1, _name: "EffVar", _val: s}), _tl: Ref$get(items_2140)}));
        let _t2155;
        if (_eq(Parser$peek_kind(p), ({_tag: 57, _name: "COMMA"}))) {
          Parser$advance(p);
          _t2155 = undefined;
        } else {
          _t2155 = Ref$set(continue_parsing_2142, false);
        }
        _t2148 = _t2155;
        break _t2149;
      }
      if (true) {
        _t2148 = Ref$set(continue_parsing_2142, false);
        break _t2149;
      }
      _match_fail("line 15950");
    }
    _t2148;
    if (_t2145) break;
  }
  _t2144 = _t2145 ? _t2146 : undefined;
  _t2144;
  const _t2143 = List$rev(Ref$get(items_2140));
  const _t2141 = _t2143;
  return _t2141;
}
function Parser$parse_ty_record_fields(p) {
  const fields_2156 = Ref$create(null);
  const is_open_2158 = Ref$create(false);
  const first_2160 = Ref$create(true);
  let _t2162 = undefined;
  let _t2163 = false, _t2164;
  while (true) {
    if (!(!_eq(Parser$peek_kind(p), ({_tag: 53, _name: "RBRACE"})))) break;
    let _t2165;
    if ((!Ref$get(first_2160))) {
      _t2165 = Parser$expect(p, ({_tag: 58, _name: "SEMICOLON"}));
    } else {
      _t2165 = undefined;
    }
    _t2165;
    let _t2166;
    if (_eq(Parser$peek_kind(p), ({_tag: 53, _name: "RBRACE"}))) {
      _t2166 = undefined;
    } else {
      let _t2167;
      if (_eq(Parser$peek_kind(p), ({_tag: 62, _name: "DOTDOT"}))) {
        Parser$advance(p);
        undefined;
        _t2167 = Ref$set(is_open_2158, true);
      } else {
        Ref$set(first_2160, false);
        const is_mut_2168 = _eq(Parser$peek_kind(p), ({_tag: 31, _name: "MUT"}));
        let _t2170;
        if (is_mut_2168) {
          Parser$advance(p);
          _t2170 = undefined;
        } else {
          _t2170 = undefined;
        }
        _t2170;
        const name_2171 = Parser$expect_ident(p);
        Parser$expect(p, ({_tag: 60, _name: "COLON"}));
        const ty_2173 = Parser$parse_ty(p);
        const _t2174 = Ref$set(fields_2156, ({_hd: [is_mut_2168, name_2171, ty_2173], _tl: Ref$get(fields_2156)}));
        const _t2172 = _t2174;
        const _t2169 = _t2172;
        _t2167 = _t2169;
      }
      _t2166 = _t2167;
    }
    _t2166;
    if (_t2163) break;
  }
  _t2162 = _t2163 ? _t2164 : undefined;
  _t2162;
  const _t2161 = [List$rev(Ref$get(fields_2156)), Ref$get(is_open_2158)];
  const _t2159 = _t2161;
  const _t2157 = _t2159;
  return _t2157;
}
function Parser$parse_pattern_atom(p) {
  let _t2176;
  const _t2175 = Parser$peek_kind(p);
  _t2177: {
    if (_t2175._tag === 65) {
      Parser$advance(p);
      undefined;
      _t2176 = ({_tag: 0, _name: "PatWild"});
      break _t2177;
    }
    if (_t2175._tag === 0) {
      const n = _t2175._val;
      Parser$advance(p);
      undefined;
      _t2176 = ({_tag: 2, _name: "PatInt", _val: n});
      break _t2177;
    }
    if (_t2175._tag === 1) {
      const f = _t2175._val;
      Parser$advance(p);
      undefined;
      _t2176 = ({_tag: 3, _name: "PatFloat", _val: f});
      break _t2177;
    }
    if (_t2175._tag === 6) {
      Parser$advance(p);
      undefined;
      _t2176 = ({_tag: 4, _name: "PatBool", _val: true});
      break _t2177;
    }
    if (_t2175._tag === 7) {
      Parser$advance(p);
      undefined;
      _t2176 = ({_tag: 4, _name: "PatBool", _val: false});
      break _t2177;
    }
    if (_t2175._tag === 2) {
      const s = _t2175._val;
      Parser$advance(p);
      undefined;
      _t2176 = ({_tag: 5, _name: "PatString", _val: s});
      break _t2177;
    }
    if (_t2175._tag === 8) {
      const s = _t2175._val;
      Parser$advance(p);
      undefined;
      _t2176 = ({_tag: 1, _name: "PatVar", _val: s});
      break _t2177;
    }
    if (_t2175._tag === 9) {
      const s = _t2175._val;
      Parser$advance(p);
      undefined;
      const path_2178 = Ref$create(({_hd: s, _tl: null}));
      const continue_reading_2180 = Ref$create(true);
      let _t2182 = undefined;
      let _t2183 = false, _t2184;
      while (true) {
        if (!(Ref$get(continue_reading_2180))) break;
        let _t2185;
        if (_eq(Parser$peek_kind(p), ({_tag: 61, _name: "DOT"}))) {
          let _t2187;
          const _t2186 = Parser$peek_kind_at(p, 1);
          _t2188: {
            if (_t2186._tag === 9) {
              const s2 = _t2186._val;
              Parser$advance(p);
              undefined;
              Parser$advance(p);
              undefined;
              _t2187 = Ref$set(path_2178, ({_hd: s2, _tl: Ref$get(path_2178)}));
              break _t2188;
            }
            if (true) {
              _t2187 = Ref$set(continue_reading_2180, false);
              break _t2188;
            }
            _match_fail("line 15950");
          }
          _t2185 = _t2187;
        } else {
          _t2185 = Ref$set(continue_reading_2180, false);
        }
        _t2185;
        if (_t2183) break;
      }
      _t2182 = _t2183 ? _t2184 : undefined;
      _t2182;
      let _t2190;
      const _t2189 = Ref$get(path_2178);
      _t2191: {
        if (_t2189 !== null && _t2189._tl === null) {
          const single = _t2189._hd;
          _t2190 = single;
          break _t2191;
        }
        if (true) {
          const rev_path = _t2189;
          const parts_2192 = List$rev(rev_path);
          const _t2193 = String$concat(".", parts_2192);
          _t2190 = _t2193;
          break _t2191;
        }
        _match_fail("line 15950");
      }
      const _t2181 = _t2190;
      const _t2179 = _t2181;
      const ctor_name_2194 = _t2179;
      let _t2196;
      if (Parser$at_pattern_arg_start(p)) {
        _t2196 = ({_tag: 1, _name: "Some", _val: Parser$parse_pattern_atom(p)});
      } else {
        _t2196 = ({_tag: 0, _name: "None"});
      }
      const arg_2197 = _t2196;
      const _t2198 = ({_tag: 10, _name: "PatConstruct", _val: [ctor_name_2194, arg_2197]});
      const _t2195 = _t2198;
      _t2176 = _t2195;
      break _t2177;
    }
    if (_t2175._tag === 54) {
      Parser$advance(p);
      undefined;
      let _t2199;
      if (_eq(Parser$peek_kind(p), ({_tag: 55, _name: "RBRACKET"}))) {
        Parser$advance(p);
        undefined;
        _t2199 = ({_tag: 9, _name: "PatNil"});
      } else {
        const pats_2200 = Parser$parse_pattern_list_elems(p);
        Parser$expect(p, ({_tag: 55, _name: "RBRACKET"}));
        function _t2202(pat, acc) {
          return ({_tag: 8, _name: "PatCons", _val: [pat, acc]});
        }
        const _t2201 = List$fold_right(_t2202, pats_2200, ({_tag: 9, _name: "PatNil"}));
        _t2199 = _t2201;
      }
      _t2176 = _t2199;
      break _t2177;
    }
    if (_t2175._tag === 50) {
      Parser$advance(p);
      undefined;
      let _t2203;
      if (_eq(Parser$peek_kind(p), ({_tag: 51, _name: "RPAREN"}))) {
        Parser$advance(p);
        undefined;
        _t2203 = ({_tag: 6, _name: "PatUnit"});
      } else {
        const pat_2204 = Parser$parse_pattern(p);
        let _t2207;
        const _t2206 = Parser$peek_kind(p);
        _t2208: {
          if (_t2206._tag === 57) {
            const pats_2209 = Ref$create(({_hd: pat_2204, _tl: null}));
            let _t2211 = undefined;
            let _t2212 = false, _t2213;
            while (true) {
              if (!(_eq(Parser$peek_kind(p), ({_tag: 57, _name: "COMMA"})))) break;
              Parser$advance(p);
              undefined;
              Ref$set(pats_2209, ({_hd: Parser$parse_pattern(p), _tl: Ref$get(pats_2209)}));
              if (_t2212) break;
            }
            _t2211 = _t2212 ? _t2213 : undefined;
            _t2211;
            Parser$expect(p, ({_tag: 51, _name: "RPAREN"}));
            const _t2210 = ({_tag: 7, _name: "PatTuple", _val: List$rev(Ref$get(pats_2209))});
            _t2207 = _t2210;
            break _t2208;
          }
          if (_t2206._tag === 60) {
            Parser$advance(p);
            undefined;
            const ty_2214 = Parser$parse_ty(p);
            Parser$expect(p, ({_tag: 51, _name: "RPAREN"}));
            const _t2215 = ({_tag: 18, _name: "PatAnnot", _val: [pat_2204, ty_2214]});
            _t2207 = _t2215;
            break _t2208;
          }
          if (true) {
            Parser$expect(p, ({_tag: 51, _name: "RPAREN"}));
            _t2207 = pat_2204;
            break _t2208;
          }
          _match_fail("line 15950");
        }
        const _t2205 = _t2207;
        _t2203 = _t2205;
      }
      _t2176 = _t2203;
      break _t2177;
    }
    if (_t2175._tag === 52) {
      Parser$advance(p);
      undefined;
      const fields_2216 = Parser$parse_pattern_record_fields(p);
      Parser$expect(p, ({_tag: 53, _name: "RBRACE"}));
      const _t2217 = ({_tag: 11, _name: "PatRecord", _val: fields_2216});
      _t2176 = _t2217;
      break _t2177;
    }
    if (_t2175._tag === 87) {
      const tag = _t2175._val;
      Parser$advance(p);
      undefined;
      let _t2218;
      if (Parser$at_pattern_arg_start(p)) {
        _t2218 = ({_tag: 16, _name: "PatPolyVariant", _val: [tag, ({_tag: 1, _name: "Some", _val: Parser$parse_pattern_atom(p)})]});
      } else {
        _t2218 = ({_tag: 16, _name: "PatPolyVariant", _val: [tag, ({_tag: 0, _name: "None"})]});
      }
      _t2176 = _t2218;
      break _t2177;
    }
    if (_t2175._tag === 70) {
      Parser$advance(p);
      undefined;
      const name_2219 = Parser$expect_ident(p);
      const _t2220 = ({_tag: 17, _name: "PatPin", _val: name_2219});
      _t2176 = _t2220;
      break _t2177;
    }
    if (_t2175._tag === 39) {
      Parser$advance(p);
      undefined;
      let _t2222;
      const _t2221 = Parser$peek_kind(p);
      _t2223: {
        if (_t2221._tag === 54) {
          Parser$advance(p);
          undefined;
          let _t2224;
          if (_eq(Parser$peek_kind(p), ({_tag: 55, _name: "RBRACKET"}))) {
            Parser$advance(p);
            undefined;
            _t2224 = ({_tag: 14, _name: "PatArray", _val: null});
          } else {
            const pats_2225 = Parser$parse_pattern_list_elems(p);
            Parser$expect(p, ({_tag: 55, _name: "RBRACKET"}));
            const _t2226 = ({_tag: 14, _name: "PatArray", _val: pats_2225});
            _t2224 = _t2226;
          }
          _t2222 = _t2224;
          break _t2223;
        }
        if (_t2221._tag === 52) {
          Parser$advance(p);
          undefined;
          let _t2227;
          if (_eq(Parser$peek_kind(p), ({_tag: 53, _name: "RBRACE"}))) {
            Parser$advance(p);
            undefined;
            _t2227 = ({_tag: 15, _name: "PatMap", _val: null});
          } else {
            const entries_2228 = Parser$parse_pattern_map_entries(p);
            Parser$expect(p, ({_tag: 53, _name: "RBRACE"}));
            const _t2229 = ({_tag: 15, _name: "PatMap", _val: entries_2228});
            _t2227 = _t2229;
          }
          _t2222 = _t2227;
          break _t2223;
        }
        if (true) {
          _t2222 = Parser$error(p, "expected '[' or '{' after '#' in pattern");
          break _t2223;
        }
        _match_fail("line 15950");
      }
      _t2176 = _t2222;
      break _t2177;
    }
    if (true) {
      _t2176 = Parser$error(p, "expected pattern");
      break _t2177;
    }
    _match_fail("line 15950");
  }
  return _t2176;
}
function Parser$parse_pattern_cons(p) {
  const pat_2230 = Parser$parse_pattern_atom(p);
  let _t2233;
  const _t2232 = Parser$peek_kind(p);
  _t2234: {
    if (_t2232._tag === 71) {
      Parser$advance(p);
      undefined;
      const rest_2235 = Parser$parse_pattern_cons(p);
      const _t2236 = ({_tag: 8, _name: "PatCons", _val: [pat_2230, rest_2235]});
      _t2233 = _t2236;
      break _t2234;
    }
    if (true) {
      _t2233 = pat_2230;
      break _t2234;
    }
    _match_fail("line 15950");
  }
  const _t2231 = _t2233;
  return _t2231;
}
function Parser$parse_pattern_as(p) {
  const pat_2237 = Parser$parse_pattern_cons(p);
  let _t2240;
  const _t2239 = Parser$peek_kind(p);
  _t2241: {
    if (_t2239._tag === 8 && _t2239._val === "as") {
      Parser$advance(p);
      undefined;
      const name_2242 = Parser$expect_ident(p);
      const _t2243 = ({_tag: 12, _name: "PatAs", _val: [pat_2237, name_2242]});
      _t2240 = _t2243;
      break _t2241;
    }
    if (true) {
      _t2240 = pat_2237;
      break _t2241;
    }
    _match_fail("line 15950");
  }
  const _t2238 = _t2240;
  return _t2238;
}
function Parser$parse_pattern(p) {
  const pat_2244 = Ref$create(Parser$parse_pattern_as(p));
  let _t2246 = undefined;
  let _t2247 = false, _t2248;
  while (true) {
    if (!(_eq(Parser$peek_kind(p), ({_tag: 63, _name: "PIPE"})))) break;
    Parser$advance(p);
    undefined;
    const next_pat_2249 = Parser$parse_pattern_as(p);
    const _t2250 = Ref$set(pat_2244, ({_tag: 13, _name: "PatOr", _val: [Ref$get(pat_2244), next_pat_2249]}));
    _t2250;
    if (_t2247) break;
  }
  _t2246 = _t2247 ? _t2248 : undefined;
  _t2246;
  const _t2245 = Ref$get(pat_2244);
  return _t2245;
}
function Parser$at_pattern_arg_start(p) {
  let _t2252;
  const _t2251 = Parser$peek_kind(p);
  _t2253: {
    if (_t2251._tag === 8 && _t2251._val === "as") {
      _t2252 = false;
      break _t2253;
    }
    if (((((((((((((_t2251._tag === 0 || _t2251._tag === 6) || _t2251._tag === 7) || _t2251._tag === 2) || _t2251._tag === 8) || _t2251._tag === 9) || _t2251._tag === 50) || _t2251._tag === 54) || _t2251._tag === 52) || _t2251._tag === 65) || _t2251._tag === 39) || _t2251._tag === 87) || _t2251._tag === 70)) {
      _t2252 = true;
      break _t2253;
    }
    if (true) {
      _t2252 = false;
      break _t2253;
    }
    _match_fail("line 15950");
  }
  return _t2252;
}
function Parser$parse_pattern_list_elems(p) {
  const first_2254 = Parser$parse_pattern(p);
  const pats_2256 = Ref$create(({_hd: first_2254, _tl: null}));
  let _t2258 = undefined;
  let _t2259 = false, _t2260;
  while (true) {
    if (!(_eq(Parser$peek_kind(p), ({_tag: 58, _name: "SEMICOLON"})))) break;
    Parser$advance(p);
    undefined;
    let _t2261;
    if (!_eq(Parser$peek_kind(p), ({_tag: 55, _name: "RBRACKET"}))) {
      _t2261 = Ref$set(pats_2256, ({_hd: Parser$parse_pattern(p), _tl: Ref$get(pats_2256)}));
    } else {
      _t2261 = undefined;
    }
    _t2261;
    if (_t2259) break;
  }
  _t2258 = _t2259 ? _t2260 : undefined;
  _t2258;
  const _t2257 = List$rev(Ref$get(pats_2256));
  const _t2255 = _t2257;
  return _t2255;
}
function Parser$parse_pattern_record_fields(p) {
  const fields_2262 = Ref$create(null);
  const first_2264 = Ref$create(true);
  let _t2266 = undefined;
  let _t2267 = false, _t2268;
  while (true) {
    if (!(!_eq(Parser$peek_kind(p), ({_tag: 53, _name: "RBRACE"})))) break;
    let _t2269;
    if ((!Ref$get(first_2264))) {
      _t2269 = Parser$expect(p, ({_tag: 58, _name: "SEMICOLON"}));
    } else {
      _t2269 = undefined;
    }
    _t2269;
    let _t2270;
    if (_eq(Parser$peek_kind(p), ({_tag: 53, _name: "RBRACE"}))) {
      _t2270 = undefined;
    } else {
      Ref$set(first_2264, false);
      let _t2271;
      if (_eq(Parser$peek_kind(p), ({_tag: 65, _name: "UNDERSCORE"}))) {
        Parser$advance(p);
        _t2271 = undefined;
      } else {
        const name_2272 = Parser$expect_ident(p);
        let _t2274;
        if (_eq(Parser$peek_kind(p), ({_tag: 73, _name: "EQ"}))) {
          Parser$advance(p);
          undefined;
          _t2274 = Parser$parse_pattern(p);
        } else {
          _t2274 = ({_tag: 1, _name: "PatVar", _val: name_2272});
        }
        const pat_2275 = _t2274;
        const _t2276 = Ref$set(fields_2262, ({_hd: [name_2272, pat_2275], _tl: Ref$get(fields_2262)}));
        const _t2273 = _t2276;
        _t2271 = _t2273;
      }
      _t2270 = _t2271;
    }
    _t2270;
    if (_t2267) break;
  }
  _t2266 = _t2267 ? _t2268 : undefined;
  _t2266;
  const _t2265 = List$rev(Ref$get(fields_2262));
  const _t2263 = _t2265;
  return _t2263;
}
function Parser$parse_pattern_map_entries(p) {
  const entries_2277 = Ref$create(null);
  const first_2279 = Ref$create(true);
  let _t2281 = undefined;
  let _t2282 = false, _t2283;
  while (true) {
    if (!(!_eq(Parser$peek_kind(p), ({_tag: 53, _name: "RBRACE"})))) break;
    let _t2284;
    if ((!Ref$get(first_2279))) {
      _t2284 = Parser$expect(p, ({_tag: 58, _name: "SEMICOLON"}));
    } else {
      _t2284 = undefined;
    }
    _t2284;
    let _t2285;
    if (_eq(Parser$peek_kind(p), ({_tag: 53, _name: "RBRACE"}))) {
      _t2285 = undefined;
    } else {
      Ref$set(first_2279, false);
      const key_2286 = Parser$parse_pattern_atom(p);
      Parser$expect(p, ({_tag: 60, _name: "COLON"}));
      const value_2288 = Parser$parse_pattern(p);
      const _t2289 = Ref$set(entries_2277, ({_hd: [key_2286, value_2288], _tl: Ref$get(entries_2277)}));
      const _t2287 = _t2289;
      _t2285 = _t2287;
    }
    _t2285;
    if (_t2282) break;
  }
  _t2281 = _t2282 ? _t2283 : undefined;
  _t2281;
  const _t2280 = List$rev(Ref$get(entries_2277));
  const _t2278 = _t2280;
  return _t2278;
}
function Parser$bp_of_binop(__x) {
  let _t2291;
  const _t2290 = __x;
  _t2292: {
    if (_t2290._tag === 64) {
      _t2291 = [1, 2];
      break _t2292;
    }
    if (_t2290._tag === 80) {
      _t2291 = [2, 3];
      break _t2292;
    }
    if (_t2290._tag === 79) {
      _t2291 = [4, 5];
      break _t2292;
    }
    if ((((((_t2290._tag === 73 || _t2290._tag === 74) || _t2290._tag === 75) || _t2290._tag === 76) || _t2290._tag === 77) || _t2290._tag === 78)) {
      _t2291 = [6, 7];
      break _t2292;
    }
    if (_t2290._tag === 71) {
      _t2291 = [9, 8];
      break _t2292;
    }
    if ((_t2290._tag === 66 || _t2290._tag === 67)) {
      _t2291 = [10, 11];
      break _t2292;
    }
    if (_t2290._tag === 70) {
      _t2291 = [10, 11];
      break _t2292;
    }
    if (((_t2290._tag === 68 || _t2290._tag === 69) || _t2290._tag === 41)) {
      _t2291 = [12, 13];
      break _t2292;
    }
    if ((_t2290._tag === 82 || _t2290._tag === 83)) {
      _t2291 = [10, 11];
      break _t2292;
    }
    if (((_t2290._tag === 81 || _t2290._tag === 85) || _t2290._tag === 86)) {
      _t2291 = [12, 13];
      break _t2292;
    }
    if (true) {
      _t2291 = [(-1), (-1)];
      break _t2292;
    }
    _match_fail("line 15950");
  }
  return _t2291;
}
function Parser$is_binop(__x) {
  let _t2294;
  const _t2293 = __x;
  _t2295: {
    if (((((((((((((((((((((_t2293._tag === 66 || _t2293._tag === 67) || _t2293._tag === 68) || _t2293._tag === 69) || _t2293._tag === 41) || _t2293._tag === 73) || _t2293._tag === 74) || _t2293._tag === 75) || _t2293._tag === 76) || _t2293._tag === 77) || _t2293._tag === 78) || _t2293._tag === 79) || _t2293._tag === 80) || _t2293._tag === 70) || _t2293._tag === 71) || _t2293._tag === 81) || _t2293._tag === 82) || _t2293._tag === 83) || _t2293._tag === 85) || _t2293._tag === 86) || _t2293._tag === 64)) {
      _t2294 = true;
      break _t2295;
    }
    if (true) {
      _t2294 = false;
      break _t2295;
    }
    _match_fail("line 15950");
  }
  return _t2294;
}
function Parser$binop_of_token(__x) {
  let _t2297;
  const _t2296 = __x;
  _t2298: {
    if (_t2296._tag === 66) {
      _t2297 = ({_tag: 0, _name: "Add"});
      break _t2298;
    }
    if (_t2296._tag === 67) {
      _t2297 = ({_tag: 1, _name: "Sub"});
      break _t2298;
    }
    if (_t2296._tag === 68) {
      _t2297 = ({_tag: 2, _name: "Mul"});
      break _t2298;
    }
    if (_t2296._tag === 69) {
      _t2297 = ({_tag: 3, _name: "Div"});
      break _t2298;
    }
    if (_t2296._tag === 41) {
      _t2297 = ({_tag: 4, _name: "Mod"});
      break _t2298;
    }
    if (_t2296._tag === 73) {
      _t2297 = ({_tag: 5, _name: "Eq"});
      break _t2298;
    }
    if (_t2296._tag === 74) {
      _t2297 = ({_tag: 6, _name: "Neq"});
      break _t2298;
    }
    if (_t2296._tag === 75) {
      _t2297 = ({_tag: 7, _name: "Lt"});
      break _t2298;
    }
    if (_t2296._tag === 76) {
      _t2297 = ({_tag: 8, _name: "Gt"});
      break _t2298;
    }
    if (_t2296._tag === 77) {
      _t2297 = ({_tag: 9, _name: "Le"});
      break _t2298;
    }
    if (_t2296._tag === 78) {
      _t2297 = ({_tag: 10, _name: "Ge"});
      break _t2298;
    }
    if (_t2296._tag === 79) {
      _t2297 = ({_tag: 11, _name: "And"});
      break _t2298;
    }
    if (_t2296._tag === 80) {
      _t2297 = ({_tag: 12, _name: "Or"});
      break _t2298;
    }
    if (_t2296._tag === 70) {
      _t2297 = ({_tag: 13, _name: "Concat"});
      break _t2298;
    }
    if (_t2296._tag === 81) {
      _t2297 = ({_tag: 14, _name: "Land"});
      break _t2298;
    }
    if (_t2296._tag === 82) {
      _t2297 = ({_tag: 15, _name: "Lor"});
      break _t2298;
    }
    if (_t2296._tag === 83) {
      _t2297 = ({_tag: 16, _name: "Lxor"});
      break _t2298;
    }
    if (_t2296._tag === 85) {
      _t2297 = ({_tag: 17, _name: "Lsl"});
      break _t2298;
    }
    if (_t2296._tag === 86) {
      _t2297 = ({_tag: 18, _name: "Lsr"});
      break _t2298;
    }
    if (_t2296._tag === 64) {
      _t2297 = ({_tag: 19, _name: "Pipe"});
      break _t2298;
    }
    if (true) {
      _t2297 = failwith("assert false");
      break _t2298;
    }
    _match_fail("line 15950");
  }
  return _t2297;
}
function Parser$resolve_fun_params(fun_params, body) {
  function _t2299(body, fp) {
    let _t2301;
    const _t2300 = fp;
    _t2302: {
      if (_t2300._tag === 0) {
        _t2301 = body;
        break _t2302;
      }
      if (_t2300._tag === 1) {
        const name = _t2300._val[0];
        const pat = _t2300._val[1];
        _t2301 = ({_tag: 25, _name: "EMatch", _val: [({_tag: 7, _name: "EVar", _val: name}), ({_hd: [pat, ({_tag: 0, _name: "None"}), body], _tl: null}), true]});
        break _t2302;
      }
      _match_fail("line 15950");
    }
    return _t2301;
  }
  const body_2303 = List$fold(_t2299, body, fun_params);
  function _t2305(fp) {
    let _t2307;
    const _t2306 = fp;
    _t2308: {
      if (_t2306._tag === 0) {
        const param = _t2306._val;
        _t2307 = param;
        break _t2308;
      }
      if (_t2306._tag === 1) {
        const name = _t2306._val[0];
        const annot = _t2306._val[2];
        _t2307 = ({annot: annot, is_generated: true, name: name});
        break _t2308;
      }
      _match_fail("line 15950");
    }
    return _t2307;
  }
  const params_2309 = List$map(_t2305, fun_params);
  const _t2310 = [params_2309, body_2303];
  const _t2304 = _t2310;
  return _t2304;
}
const Parser$fresh_param_counter = Ref$create(0);
function Parser$fresh_param_name(_) {
  Ref$set(Parser$fresh_param_counter, (Ref$get(Parser$fresh_param_counter) + 1));
  return ("__p" + __dict_Show_int.show(Ref$get(Parser$fresh_param_counter)));
}
function Parser$parse_format_spec(spec, expr) {
  const len_2311 = String$length(spec);
  const i_2313 = Ref$create(0);
  let _t2315;
  if (((Ref$get(i_2313) < len_2311) && ((String$get(spec, Ref$get(i_2313)) === 60) || (String$get(spec, Ref$get(i_2313)) === 62)))) {
    const a_2316 = String$get(spec, Ref$get(i_2313));
    Ref$set(i_2313, (Ref$get(i_2313) + 1));
    const _t2317 = ({_tag: 1, _name: "Some", _val: a_2316});
    _t2315 = _t2317;
  } else {
    _t2315 = ({_tag: 0, _name: "None"});
  }
  const align_2318 = _t2315;
  let _t2320;
  if (((Ref$get(i_2313) < len_2311) && ((String$get(spec, Ref$get(i_2313)) === 48) && (((Ref$get(i_2313) + 1) < len_2311) && ((String$get(spec, (Ref$get(i_2313) + 1)) >= 49) && (String$get(spec, (Ref$get(i_2313) + 1)) <= 57)))))) {
    Ref$set(i_2313, (Ref$get(i_2313) + 1));
    _t2320 = true;
  } else {
    _t2320 = false;
  }
  const zero_pad_2321 = _t2320;
  const width_start_2323 = Ref$get(i_2313);
  let _t2325 = undefined;
  let _t2326 = false, _t2327;
  while (true) {
    if (!(((Ref$get(i_2313) < len_2311) && ((String$get(spec, Ref$get(i_2313)) >= 48) && (String$get(spec, Ref$get(i_2313)) <= 57))))) break;
    Ref$set(i_2313, (Ref$get(i_2313) + 1));
    if (_t2326) break;
  }
  _t2325 = _t2326 ? _t2327 : undefined;
  _t2325;
  let _t2328;
  if ((Ref$get(i_2313) > width_start_2323)) {
    _t2328 = ({_tag: 1, _name: "Some", _val: int_of_string(String$sub(spec, width_start_2323, (Ref$get(i_2313) - width_start_2323)))});
  } else {
    _t2328 = ({_tag: 0, _name: "None"});
  }
  const width_2329 = _t2328;
  let _t2331;
  if (((Ref$get(i_2313) < len_2311) && (String$get(spec, Ref$get(i_2313)) === 46))) {
    Ref$set(i_2313, (Ref$get(i_2313) + 1));
    const ps_2332 = Ref$get(i_2313);
    let _t2334 = undefined;
    let _t2335 = false, _t2336;
    while (true) {
      if (!(((Ref$get(i_2313) < len_2311) && ((String$get(spec, Ref$get(i_2313)) >= 48) && (String$get(spec, Ref$get(i_2313)) <= 57))))) break;
      Ref$set(i_2313, (Ref$get(i_2313) + 1));
      if (_t2335) break;
    }
    _t2334 = _t2335 ? _t2336 : undefined;
    _t2334;
    let _t2337;
    if ((Ref$get(i_2313) > ps_2332)) {
      _t2337 = int_of_string(String$sub(spec, ps_2332, (Ref$get(i_2313) - ps_2332)));
    } else {
      _t2337 = 0;
    }
    const n_2338 = _t2337;
    let _t2340;
    if (((Ref$get(i_2313) < len_2311) && (String$get(spec, Ref$get(i_2313)) === 102))) {
      Ref$set(i_2313, (Ref$get(i_2313) + 1));
      _t2340 = ({_tag: 1, _name: "Some", _val: n_2338});
    } else {
      _t2340 = ({_tag: 0, _name: "None"});
    }
    const _t2339 = _t2340;
    const _t2333 = _t2339;
    _t2331 = _t2333;
  } else {
    _t2331 = ({_tag: 0, _name: "None"});
  }
  const float_prec_2341 = _t2331;
  let _t2343;
  if ((Ref$get(i_2313) < len_2311)) {
    let _t2345;
    const _t2344 = String$get(spec, Ref$get(i_2313));
    _t2346: {
      if (true) {
        const _c = _t2344;
        if ((_c === 120)) {
          Ref$set(i_2313, (Ref$get(i_2313) + 1));
          _t2345 = ({_tag: 1, _name: "Some", _val: 120});
          break _t2346;
        }
      }
      if (true) {
        const _c = _t2344;
        if ((_c === 88)) {
          Ref$set(i_2313, (Ref$get(i_2313) + 1));
          _t2345 = ({_tag: 1, _name: "Some", _val: 88});
          break _t2346;
        }
      }
      if (true) {
        const _c = _t2344;
        if ((_c === 111)) {
          Ref$set(i_2313, (Ref$get(i_2313) + 1));
          _t2345 = ({_tag: 1, _name: "Some", _val: 111});
          break _t2346;
        }
      }
      if (true) {
        const _c = _t2344;
        if ((_c === 98)) {
          Ref$set(i_2313, (Ref$get(i_2313) + 1));
          _t2345 = ({_tag: 1, _name: "Some", _val: 98});
          break _t2346;
        }
      }
      if (true) {
        _t2345 = ({_tag: 0, _name: "None"});
        break _t2346;
      }
      _match_fail("line 15950");
    }
    _t2343 = _t2345;
  } else {
    _t2343 = ({_tag: 0, _name: "None"});
  }
  const type_spec_2347 = _t2343;
  let _t2350;
  const _t2349 = float_prec_2341;
  _t2351: {
    if (_t2349._tag === 1) {
      const n = _t2349._val;
      _t2350 = ({_tag: 11, _name: "EApp", _val: [({_tag: 11, _name: "EApp", _val: [({_tag: 7, _name: "EVar", _val: "__fmt_float"}), ({_tag: 0, _name: "EInt", _val: n})]}), expr]});
      break _t2351;
    }
    if (_t2349._tag === 0) {
      let _t2353;
      const _t2352 = type_spec_2347;
      _t2354: {
        if (_t2352._tag === 1) {
          const _c = _t2352._val;
          if ((_c === 120)) {
            _t2353 = ({_tag: 11, _name: "EApp", _val: [({_tag: 7, _name: "EVar", _val: "__fmt_hex"}), expr]});
            break _t2354;
          }
        }
        if (_t2352._tag === 1) {
          const _c = _t2352._val;
          if ((_c === 88)) {
            _t2353 = ({_tag: 11, _name: "EApp", _val: [({_tag: 7, _name: "EVar", _val: "__fmt_hex_upper"}), expr]});
            break _t2354;
          }
        }
        if (_t2352._tag === 1) {
          const _c = _t2352._val;
          if ((_c === 111)) {
            _t2353 = ({_tag: 11, _name: "EApp", _val: [({_tag: 7, _name: "EVar", _val: "__fmt_oct"}), expr]});
            break _t2354;
          }
        }
        if (_t2352._tag === 1) {
          const _c = _t2352._val;
          if ((_c === 98)) {
            _t2353 = ({_tag: 11, _name: "EApp", _val: [({_tag: 7, _name: "EVar", _val: "__fmt_bin"}), expr]});
            break _t2354;
          }
        }
        if (true) {
          _t2353 = ({_tag: 11, _name: "EApp", _val: [({_tag: 7, _name: "EVar", _val: "show"}), expr]});
          break _t2354;
        }
        _match_fail("line 15950");
      }
      _t2350 = _t2353;
      break _t2351;
    }
    _match_fail("line 15950");
  }
  const inner_2355 = _t2350;
  let _t2357;
  if (zero_pad_2321) {
    let _t2359;
    const _t2358 = width_2329;
    _t2360: {
      if (_t2358._tag === 1) {
        const w = _t2358._val;
        _t2359 = ({_tag: 11, _name: "EApp", _val: [({_tag: 11, _name: "EApp", _val: [({_tag: 7, _name: "EVar", _val: "__fmt_zero_pad"}), ({_tag: 0, _name: "EInt", _val: w})]}), inner_2355]});
        break _t2360;
      }
      if (_t2358._tag === 0) {
        _t2359 = inner_2355;
        break _t2360;
      }
      _match_fail("line 15950");
    }
    _t2357 = _t2359;
  } else {
    _t2357 = inner_2355;
  }
  const inner_2361 = _t2357;
  let _t2363;
  if ((!zero_pad_2321)) {
    let _t2365;
    const _t2364 = [align_2318, width_2329];
    _t2366: {
      if (_t2364[0]._tag === 1 && _t2364[1]._tag === 1) {
        const _c = _t2364[0]._val;
        const w = _t2364[1]._val;
        if ((_c === 62)) {
          _t2365 = ({_tag: 11, _name: "EApp", _val: [({_tag: 11, _name: "EApp", _val: [({_tag: 7, _name: "EVar", _val: "__fmt_pad_left"}), ({_tag: 0, _name: "EInt", _val: w})]}), inner_2361]});
          break _t2366;
        }
      }
      if (_t2364[0]._tag === 1 && _t2364[1]._tag === 1) {
        const _c = _t2364[0]._val;
        const w = _t2364[1]._val;
        if ((_c === 60)) {
          _t2365 = ({_tag: 11, _name: "EApp", _val: [({_tag: 11, _name: "EApp", _val: [({_tag: 7, _name: "EVar", _val: "__fmt_pad_right"}), ({_tag: 0, _name: "EInt", _val: w})]}), inner_2361]});
          break _t2366;
        }
      }
      if (true) {
        _t2365 = inner_2361;
        break _t2366;
      }
      _match_fail("line 15950");
    }
    _t2363 = _t2365;
  } else {
    _t2363 = inner_2361;
  }
  const inner_2367 = _t2363;
  const _t2368 = inner_2367;
  const _t2362 = _t2368;
  const _t2356 = _t2362;
  const _t2348 = _t2356;
  const _t2342 = _t2348;
  const _t2330 = _t2342;
  const _t2324 = _t2330;
  const _t2322 = _t2324;
  const _t2319 = _t2322;
  const _t2314 = _t2319;
  const _t2312 = _t2314;
  return _t2312;
}
function Parser$parse_atom(p) {
  const loc_2369 = Parser$peek(p).loc;
  const expr_2371 = Parser$parse_atom_inner(p);
  const _t2372 = ({_tag: 49, _name: "ELoc", _val: [loc_2369, expr_2371]});
  const _t2370 = _t2372;
  return _t2370;
}
function Parser$parse_atom_inner(p) {
  let _t2374;
  const _t2373 = Parser$peek_kind(p);
  _t2375: {
    if (_t2373._tag === 0) {
      const n = _t2373._val;
      Parser$advance(p);
      undefined;
      _t2374 = ({_tag: 0, _name: "EInt", _val: n});
      break _t2375;
    }
    if (_t2373._tag === 1) {
      const f = _t2373._val;
      Parser$advance(p);
      undefined;
      _t2374 = ({_tag: 1, _name: "EFloat", _val: f});
      break _t2375;
    }
    if (_t2373._tag === 2) {
      const s = _t2373._val;
      Parser$advance(p);
      undefined;
      _t2374 = ({_tag: 3, _name: "EString", _val: s});
      break _t2375;
    }
    if (_t2373._tag === 3) {
      const parts = _t2373._val;
      Parser$advance(p);
      undefined;
      function _t2376(part) {
        let _t2378;
        const _t2377 = part;
        _t2379: {
          if (_t2377._tag === 0) {
            const s = _t2377._val;
            _t2378 = ({_tag: 3, _name: "EString", _val: s});
            break _t2379;
          }
          if (_t2377._tag === 1) {
            const src = _t2377._val[0];
            const fmt = _t2377._val[1];
            const tokens_2380 = Lexer$tokenize(src);
            const inner_p_2382 = Parser$create(tokens_2380);
            const inner_expr_2384 = Parser$parse_expr(inner_p_2382);
            let _t2387;
            const _t2386 = fmt;
            _t2388: {
              if (_t2386._tag === 0) {
                _t2387 = ({_tag: 11, _name: "EApp", _val: [({_tag: 7, _name: "EVar", _val: "show"}), inner_expr_2384]});
                break _t2388;
              }
              if (_t2386._tag === 1) {
                const spec = _t2386._val;
                _t2387 = Parser$parse_format_spec(spec, inner_expr_2384);
                break _t2388;
              }
              _match_fail("line 15950");
            }
            const _t2385 = _t2387;
            const _t2383 = _t2385;
            const _t2381 = _t2383;
            _t2378 = _t2381;
            break _t2379;
          }
          _match_fail("line 15950");
        }
        return _t2378;
      }
      const exprs_2389 = List$map(_t2376, parts);
      let _t2392;
      const _t2391 = exprs_2389;
      _t2393: {
        if (_t2391 === null) {
          _t2392 = ({_tag: 3, _name: "EString", _val: ""});
          break _t2393;
        }
        if (_t2391 !== null && _t2391._tl === null) {
          const e = _t2391._hd;
          _t2392 = e;
          break _t2393;
        }
        if (_t2391 !== null) {
          const first = _t2391._hd;
          const rest = _t2391._tl;
          function _t2394(acc, e) {
            return ({_tag: 13, _name: "EBinop", _val: [({_tag: 13, _name: "Concat"}), acc, e]});
          }
          _t2392 = List$fold(_t2394, first, rest);
          break _t2393;
        }
        _match_fail("line 15950");
      }
      const _t2390 = _t2392;
      _t2374 = _t2390;
      break _t2375;
    }
    if (_t2373._tag === 6) {
      Parser$advance(p);
      undefined;
      _t2374 = ({_tag: 2, _name: "EBool", _val: true});
      break _t2375;
    }
    if (_t2373._tag === 7) {
      Parser$advance(p);
      undefined;
      _t2374 = ({_tag: 2, _name: "EBool", _val: false});
      break _t2375;
    }
    if (_t2373._tag === 4) {
      const n = _t2373._val;
      Parser$advance(p);
      undefined;
      _t2374 = ({_tag: 4, _name: "EByte", _val: n});
      break _t2375;
    }
    if (_t2373._tag === 5) {
      const n = _t2373._val;
      Parser$advance(p);
      undefined;
      _t2374 = ({_tag: 5, _name: "ERune", _val: n});
      break _t2375;
    }
    if (_t2373._tag === 8) {
      const s = _t2373._val;
      Parser$advance(p);
      undefined;
      _t2374 = ({_tag: 7, _name: "EVar", _val: s});
      break _t2375;
    }
    if (_t2373._tag === 9) {
      const s = _t2373._val;
      Parser$advance(p);
      undefined;
      let _t2396;
      const _t2395 = Parser$read_qualified_path(p, s);
      _t2397: {
        if (_t2395._tag === 958595272) {
          const qualified = _t2395._val;
          _t2396 = ({_tag: 7, _name: "EVar", _val: qualified});
          break _t2397;
        }
        if (_t2395._tag === 1067578635) {
          const qualified = _t2395._val;
          _t2396 = ({_tag: 24, _name: "EConstruct", _val: [qualified, ({_tag: 0, _name: "None"})]});
          break _t2397;
        }
        if (_t2395._tag === 982234060) {
          const mod_path = _t2395._val;
          Parser$advance(p);
          undefined;
          const inner_2398 = Parser$parse_expr(p);
          Parser$expect(p, ({_tag: 51, _name: "RPAREN"}));
          const _t2399 = ({_tag: 48, _name: "ELocalOpen", _val: [mod_path, inner_2398]});
          _t2396 = _t2399;
          break _t2397;
        }
        _match_fail("line 15950");
      }
      _t2374 = _t2396;
      break _t2375;
    }
    if (_t2373._tag === 50) {
      Parser$advance(p);
      undefined;
      const op_name_2400 = Parser$token_to_op_name(Parser$peek_kind(p));
      let _t2403;
      const _t2402 = op_name_2400;
      _t2404: {
        if (_t2402._tag === 1) {
          const name = _t2402._val;
          if (_eq(Parser$peek_kind_at(p, 1), ({_tag: 51, _name: "RPAREN"}))) {
            Parser$advance(p);
            undefined;
            Parser$advance(p);
            undefined;
            _t2403 = ({_tag: 7, _name: "EVar", _val: name});
            break _t2404;
          }
        }
        if (true) {
          let _t2405;
          if (_eq(Parser$peek_kind(p), ({_tag: 51, _name: "RPAREN"}))) {
            Parser$advance(p);
            undefined;
            _t2405 = ({_tag: 6, _name: "EUnit"});
          } else {
            const expr_2406 = Parser$parse_expr(p);
            let _t2409;
            const _t2408 = Parser$peek_kind(p);
            _t2410: {
              if (_t2408._tag === 57) {
                const exprs_2411 = Ref$create(({_hd: expr_2406, _tl: null}));
                let _t2413 = undefined;
                let _t2414 = false, _t2415;
                while (true) {
                  if (!(_eq(Parser$peek_kind(p), ({_tag: 57, _name: "COMMA"})))) break;
                  Parser$advance(p);
                  undefined;
                  Ref$set(exprs_2411, ({_hd: Parser$parse_expr(p), _tl: Ref$get(exprs_2411)}));
                  if (_t2414) break;
                }
                _t2413 = _t2414 ? _t2415 : undefined;
                _t2413;
                Parser$expect(p, ({_tag: 51, _name: "RPAREN"}));
                const _t2412 = ({_tag: 15, _name: "ETuple", _val: List$rev(Ref$get(exprs_2411))});
                _t2409 = _t2412;
                break _t2410;
              }
              if (_t2408._tag === 60) {
                Parser$advance(p);
                undefined;
                const ty_2416 = Parser$parse_ty(p);
                Parser$expect(p, ({_tag: 51, _name: "RPAREN"}));
                const _t2417 = ({_tag: 30, _name: "EAnnot", _val: [expr_2406, ty_2416]});
                _t2409 = _t2417;
                break _t2410;
              }
              if (_t2408._tag === 88) {
                Parser$advance(p);
                undefined;
                const ty_2418 = Parser$parse_ty(p);
                Parser$expect(p, ({_tag: 51, _name: "RPAREN"}));
                const _t2419 = ({_tag: 47, _name: "ECoerce", _val: [expr_2406, ty_2418]});
                _t2409 = _t2419;
                break _t2410;
              }
              if (true) {
                Parser$expect(p, ({_tag: 51, _name: "RPAREN"}));
                _t2409 = expr_2406;
                break _t2410;
              }
              _match_fail("line 15950");
            }
            const _t2407 = _t2409;
            _t2405 = _t2407;
          }
          _t2403 = _t2405;
          break _t2404;
        }
        _match_fail("line 15950");
      }
      const _t2401 = _t2403;
      _t2374 = _t2401;
      break _t2375;
    }
    if (_t2373._tag === 52) {
      Parser$advance(p);
      undefined;
      let _t2420;
      if (_eq(Parser$peek_kind(p), ({_tag: 53, _name: "RBRACE"}))) {
        Parser$advance(p);
        undefined;
        _t2420 = ({_tag: 16, _name: "ERecord", _val: null});
      } else {
        let _t2422;
        const _t2421 = Parser$peek_kind(p);
        _t2423: {
          if (_t2421._tag === 8) {
            const next_2424 = Parser$peek_kind_at(p, 1);
            const _t2425 = (_eq(next_2424, ({_tag: 73, _name: "EQ"})) || (_eq(next_2424, ({_tag: 58, _name: "SEMICOLON"})) || _eq(next_2424, ({_tag: 53, _name: "RBRACE"}))));
            _t2422 = _t2425;
            break _t2423;
          }
          if (true) {
            _t2422 = false;
            break _t2423;
          }
          _match_fail("line 15950");
        }
        let _t2426;
        if (_t2422) {
          const fields_2427 = Parser$parse_record_fields(p);
          Parser$expect(p, ({_tag: 53, _name: "RBRACE"}));
          const _t2428 = ({_tag: 16, _name: "ERecord", _val: fields_2427});
          _t2426 = _t2428;
        } else {
          const base_2429 = Parser$parse_expr(p);
          Parser$expect(p, ({_tag: 18, _name: "WITH"}));
          const fields_2431 = Parser$parse_record_fields(p);
          Parser$expect(p, ({_tag: 53, _name: "RBRACE"}));
          const _t2432 = ({_tag: 17, _name: "ERecordUpdate", _val: [base_2429, fields_2431]});
          const _t2430 = _t2432;
          _t2426 = _t2430;
        }
        _t2420 = _t2426;
      }
      _t2374 = _t2420;
      break _t2375;
    }
    if (_t2373._tag === 54) {
      Parser$advance(p);
      undefined;
      let _t2433;
      if (_eq(Parser$peek_kind(p), ({_tag: 55, _name: "RBRACKET"}))) {
        Parser$advance(p);
        undefined;
        _t2433 = ({_tag: 21, _name: "ENil"});
      } else {
        const elems_2434 = Parser$parse_list_elems(p);
        Parser$expect(p, ({_tag: 55, _name: "RBRACKET"}));
        const _t2435 = ({_tag: 22, _name: "EList", _val: elems_2434});
        _t2433 = _t2435;
      }
      _t2374 = _t2433;
      break _t2375;
    }
    if (_t2373._tag === 39) {
      Parser$advance(p);
      undefined;
      let _t2437;
      const _t2436 = Parser$peek_kind(p);
      _t2438: {
        if (_t2436._tag === 52) {
          Parser$advance(p);
          undefined;
          let _t2440;
          const _t2439 = Parser$parse_set_or_map(p);
          _t2441: {
            if (_t2439._tag === 887353506) {
              const pairs = _t2439._val;
              Parser$expect(p, ({_tag: 53, _name: "RBRACE"}));
              _t2440 = ({_tag: 42, _name: "EMap", _val: pairs});
              break _t2441;
            }
            if (_t2439._tag === 98602162) {
              const elems = _t2439._val;
              Parser$expect(p, ({_tag: 53, _name: "RBRACE"}));
              _t2440 = ({_tag: 44, _name: "ESet", _val: elems});
              break _t2441;
            }
            if (_t2439._tag === 533146490) {
              const expr = _t2439._val;
              Parser$expect(p, ({_tag: 53, _name: "RBRACE"}));
              _t2440 = expr;
              break _t2441;
            }
            _match_fail("line 15950");
          }
          _t2437 = _t2440;
          break _t2438;
        }
        if (_t2436._tag === 54) {
          Parser$advance(p);
          undefined;
          let _t2442;
          if (_eq(Parser$peek_kind(p), ({_tag: 55, _name: "RBRACKET"}))) {
            Parser$advance(p);
            undefined;
            _t2442 = ({_tag: 23, _name: "EArray", _val: null});
          } else {
            const elems_2443 = Parser$parse_list_elems(p);
            Parser$expect(p, ({_tag: 55, _name: "RBRACKET"}));
            const _t2444 = ({_tag: 23, _name: "EArray", _val: elems_2443});
            _t2442 = _t2444;
          }
          _t2437 = _t2442;
          break _t2438;
        }
        if ((_t2436._tag === 9 || _t2436._tag === 8)) {
          const name = _t2436._val;
          Parser$advance(p);
          undefined;
          let _t2446;
          const _t2445 = Parser$peek_kind(p);
          _t2447: {
            if (_t2445._tag === 52) {
              Parser$advance(p);
              undefined;
              let _t2449;
              const _t2448 = Parser$parse_set_or_map(p);
              _t2450: {
                if (_t2448._tag === 887353506) {
                  const pairs = _t2448._val;
                  Parser$expect(p, ({_tag: 53, _name: "RBRACE"}));
                  _t2449 = ({_tag: 43, _name: "EMapTyped", _val: [name, pairs]});
                  break _t2450;
                }
                if (_t2448._tag === 98602162) {
                  const elems = _t2448._val;
                  Parser$expect(p, ({_tag: 53, _name: "RBRACE"}));
                  _t2449 = ({_tag: 45, _name: "ECollTyped", _val: [name, elems]});
                  break _t2450;
                }
                if (_t2448._tag === 533146490) {
                  const expr = _t2448._val;
                  Parser$expect(p, ({_tag: 53, _name: "RBRACE"}));
                  _t2449 = expr;
                  break _t2450;
                }
                _match_fail("line 15950");
              }
              _t2446 = _t2449;
              break _t2447;
            }
            if (_t2445._tag === 54) {
              Parser$advance(p);
              undefined;
              let _t2451;
              if (_eq(Parser$peek_kind(p), ({_tag: 55, _name: "RBRACKET"}))) {
                Parser$advance(p);
                undefined;
                _t2451 = ({_tag: 45, _name: "ECollTyped", _val: [name, null]});
              } else {
                const elems_2452 = Parser$parse_list_elems(p);
                Parser$expect(p, ({_tag: 55, _name: "RBRACKET"}));
                const _t2453 = ({_tag: 45, _name: "ECollTyped", _val: [name, elems_2452]});
                _t2451 = _t2453;
              }
              _t2446 = _t2451;
              break _t2447;
            }
            if (true) {
              _t2446 = Parser$error(p, "expected '{' or '[' after type name");
              break _t2447;
            }
            _match_fail("line 15950");
          }
          _t2437 = _t2446;
          break _t2438;
        }
        if (true) {
          _t2437 = Parser$error(p, "expected '{', '[', or type name after '#'");
          break _t2438;
        }
        _match_fail("line 15950");
      }
      _t2374 = _t2437;
      break _t2375;
    }
    if (_t2373._tag === 87) {
      const tag = _t2373._val;
      Parser$advance(p);
      undefined;
      let _t2454;
      if ((Parser$at_atom_start(p) && (!Parser$is_keyword_expr_start(p)))) {
        _t2454 = ({_tag: 46, _name: "EPolyVariant", _val: [tag, ({_tag: 1, _name: "Some", _val: Parser$parse_postfix(p)})]});
      } else {
        _t2454 = ({_tag: 46, _name: "EPolyVariant", _val: [tag, ({_tag: 0, _name: "None"})]});
      }
      _t2374 = _t2454;
      break _t2375;
    }
    if (_t2373._tag === 33) {
      Parser$advance(p);
      undefined;
      const e_2455 = Parser$parse_expr(p);
      Parser$expect(p, ({_tag: 45, _name: "END"}));
      const _t2456 = e_2455;
      _t2374 = _t2456;
      break _t2375;
    }
    if (_t2373._tag === 16) {
      _t2374 = Parser$parse_fun(p);
      break _t2375;
    }
    if (_t2373._tag === 14) {
      _t2374 = Parser$parse_if(p);
      break _t2375;
    }
    if (_t2373._tag === 11) {
      _t2374 = Parser$parse_let_expr(p);
      break _t2375;
    }
    if (_t2373._tag === 17) {
      _t2374 = Parser$parse_match(p, false);
      break _t2375;
    }
    if (_t2373._tag === 37) {
      Parser$advance(p);
      undefined;
      _t2374 = Parser$parse_match(p, true);
      break _t2375;
    }
    if (_t2373._tag === 67) {
      Parser$advance(p);
      undefined;
      const expr_2457 = Parser$parse_postfix(p);
      const _t2458 = ({_tag: 14, _name: "EUnop", _val: [({_tag: 0, _name: "Neg"}), expr_2457]});
      _t2374 = _t2458;
      break _t2375;
    }
    if (_t2373._tag === 38) {
      Parser$advance(p);
      undefined;
      const expr_2459 = Parser$parse_postfix(p);
      const _t2460 = ({_tag: 14, _name: "EUnop", _val: [({_tag: 1, _name: "Not"}), expr_2459]});
      _t2374 = _t2460;
      break _t2375;
    }
    if (_t2373._tag === 84) {
      Parser$advance(p);
      undefined;
      const expr_2461 = Parser$parse_postfix(p);
      const _t2462 = ({_tag: 14, _name: "EUnop", _val: [({_tag: 2, _name: "Lnot"}), expr_2461]});
      _t2374 = _t2462;
      break _t2375;
    }
    if (_t2373._tag === 25) {
      Parser$advance(p);
      undefined;
      const op_name_2463 = Parser$expect_ident(p);
      const arg_2465 = Parser$parse_postfix(p);
      const _t2466 = ({_tag: 39, _name: "EPerform", _val: [op_name_2463, arg_2465]});
      const _t2464 = _t2466;
      _t2374 = _t2464;
      break _t2375;
    }
    if (_t2373._tag === 26) {
      _t2374 = Parser$parse_handle_expr(p);
      break _t2375;
    }
    if (_t2373._tag === 27) {
      _t2374 = Parser$parse_try_expr(p);
      break _t2375;
    }
    if (_t2373._tag === 29) {
      Parser$advance(p);
      undefined;
      const k_2467 = Parser$parse_atom(p);
      const v_2469 = Parser$parse_atom(p);
      const _t2470 = ({_tag: 41, _name: "EResume", _val: [k_2467, v_2469]});
      const _t2468 = _t2470;
      _t2374 = _t2468;
      break _t2375;
    }
    if (_t2373._tag === 32) {
      _t2374 = Parser$parse_for_expr(p);
      break _t2375;
    }
    if (_t2373._tag === 34) {
      Parser$advance(p);
      undefined;
      let _t2471;
      if (Parser$at_atom_start(p)) {
        _t2471 = ({_tag: 35, _name: "EBreak", _val: ({_tag: 1, _name: "Some", _val: Parser$parse_atom(p)})});
      } else {
        _t2471 = ({_tag: 35, _name: "EBreak", _val: ({_tag: 0, _name: "None"})});
      }
      _t2374 = _t2471;
      break _t2375;
    }
    if (_t2373._tag === 28) {
      Parser$advance(p);
      undefined;
      _t2374 = ({_tag: 36, _name: "EContinueLoop"});
      break _t2375;
    }
    if (_t2373._tag === 30) {
      Parser$advance(p);
      undefined;
      _t2374 = ({_tag: 37, _name: "EReturn", _val: Parser$parse_expr_bp(p, 0)});
      break _t2375;
    }
    if (_t2373._tag === 61) {
      Parser$advance(p);
      undefined;
      const field_2472 = Parser$expect_ident(p);
      const r_2474 = ({annot: ({_tag: 0, _name: "None"}), is_generated: false, name: "__r"});
      const _t2475 = ({_tag: 10, _name: "EFun", _val: [r_2474, ({_tag: 18, _name: "EField", _val: [({_tag: 7, _name: "EVar", _val: "__r"}), field_2472]})]});
      const _t2473 = _t2475;
      _t2374 = _t2473;
      break _t2375;
    }
    if (true) {
      _t2374 = Parser$error(p, "expected expression");
      break _t2375;
    }
    _match_fail("line 15950");
  }
  return _t2374;
}
function Parser$at_atom_start(p) {
  let _t2477;
  const _t2476 = Parser$peek_kind(p);
  _t2478: {
    if ((((((((((((((((_t2476._tag === 0 || _t2476._tag === 1) || _t2476._tag === 2) || _t2476._tag === 3) || _t2476._tag === 4) || _t2476._tag === 5) || _t2476._tag === 6) || _t2476._tag === 7) || _t2476._tag === 8) || _t2476._tag === 9) || _t2476._tag === 50) || _t2476._tag === 52) || _t2476._tag === 54) || _t2476._tag === 39) || _t2476._tag === 61) || _t2476._tag === 87)) {
      _t2477 = true;
      break _t2478;
    }
    if (true) {
      _t2477 = false;
      break _t2478;
    }
    _match_fail("line 15950");
  }
  return _t2477;
}
function Parser$is_adjacent(p) {
  let _t2483;
  if ((p.pos > 0)) {
  const prev_2479 = Array$get(p.tokens, (p.pos - 1));
  const cur_2481 = Parser$peek(p);
  const _t2482 = (prev_2479.end_offset === cur_2481.loc.offset);
  const _t2480 = _t2482;
    _t2483 = _t2480;
  } else {
    _t2483 = false;
  }
  return _t2483;
}
function Parser$parse_postfix(p) {
  const expr_2484 = Parser$parse_atom(p);
  function loop(expr) {
    while (true) {
      let _t2487;
      const _t2486 = Parser$peek_kind(p);
      _t2488: {
        if (_t2486._tag === 61) {
          if (Parser$is_adjacent(p)) {
            Parser$advance(p);
            undefined;
            let _t2489;
            if (_eq(Parser$peek_kind(p), ({_tag: 54, _name: "LBRACKET"}))) {
              Parser$advance(p);
              undefined;
              const idx_2490 = Parser$parse_expr(p);
              Parser$expect(p, ({_tag: 55, _name: "RBRACKET"}));
              const _t2492 = ({_tag: 19, _name: "EIndex", _val: [expr, idx_2490]});
              expr = _t2492;
              continue;
              const _t2491 = undefined;
              _t2489 = _t2491;
            } else {
              const field_2493 = Parser$expect_ident(p);
              const _t2495 = ({_tag: 18, _name: "EField", _val: [expr, field_2493]});
              expr = _t2495;
              continue;
              const _t2494 = undefined;
              _t2489 = _t2494;
            }
            _t2487 = _t2489;
            break _t2488;
          }
        }
        if (true) {
          _t2487 = expr;
          break _t2488;
        }
        _match_fail("line 15950");
      }
      return _t2487;
    }
  }
  const _t2496 = loop(expr_2484);
  const _t2485 = _t2496;
  return _t2485;
}
function Parser$parse_app(p) {
  const fn__2497 = Parser$parse_postfix(p);
  function loop(expr) {
    while (true) {
      let _t2500;
      const _t2499 = Parser$peek_kind(p);
      _t2501: {
        if (true) {
          if ((Parser$at_atom_start(p) && (!Parser$is_keyword_expr_start(p)))) {
            const arg_2502 = Parser$parse_postfix(p);
            let _t2505;
            const _t2504 = expr;
            _t2506: {
              if ((_t2504._tag === 24 && _t2504._val[1]._tag === 0 || _t2504._tag === 49 && _t2504._val[1]._tag === 24 && _t2504._val[1]._val[1]._tag === 0)) {
                const name = (_t2504._tag === 24 && _t2504._val[1]._tag === 0 ? _t2504._val[0] : _t2504._val[1]._val[0]);
                const _t2507 = ({_tag: 24, _name: "EConstruct", _val: [name, ({_tag: 1, _name: "Some", _val: arg_2502})]});
                expr = _t2507;
                continue;
                _t2505 = undefined;
                break _t2506;
              }
              if (true) {
                const _t2508 = ({_tag: 11, _name: "EApp", _val: [expr, arg_2502]});
                expr = _t2508;
                continue;
                _t2505 = undefined;
                break _t2506;
              }
              _match_fail("line 15950");
            }
            const _t2503 = _t2505;
            _t2500 = _t2503;
            break _t2501;
          }
        }
        if (true) {
          _t2500 = expr;
          break _t2501;
        }
        _match_fail("line 15950");
      }
      return _t2500;
    }
  }
  const _t2509 = loop(fn__2497);
  const _t2498 = _t2509;
  return _t2498;
}
function Parser$is_keyword_expr_start(p) {
  let _t2511;
  const _t2510 = Parser$peek_kind(p);
  _t2512: {
    if ((((((((((((_t2510._tag === 16 || _t2510._tag === 14) || _t2510._tag === 11) || _t2510._tag === 17) || _t2510._tag === 25) || _t2510._tag === 26) || _t2510._tag === 27) || _t2510._tag === 29) || _t2510._tag === 32) || _t2510._tag === 34) || _t2510._tag === 28) || _t2510._tag === 30)) {
      _t2511 = true;
      break _t2512;
    }
    if (true) {
      _t2511 = false;
      break _t2512;
    }
    _match_fail("line 15950");
  }
  return _t2511;
}
function Parser$parse_expr_bp(p, min_bp) {
  const lhs_2513 = Parser$parse_app(p);
  function loop(lhs) {
    while (true) {
      const kind_2515 = Parser$peek_kind(p);
      let _t2517;
      if (Parser$is_binop(kind_2515)) {
        let _t2519;
        const _t2518 = Parser$bp_of_binop(kind_2515);
        _t2520: {
          if (true) {
            const l_bp = _t2518[0];
            const r_bp = _t2518[1];
            let _t2521;
            if ((l_bp < min_bp)) {
              _t2521 = lhs;
            } else {
              Parser$advance(p);
              undefined;
              let _t2522;
              if (_eq(kind_2515, ({_tag: 71, _name: "COLONCOLON"}))) {
                const rhs_2523 = Parser$parse_expr_bp(p, r_bp);
                const _t2525 = ({_tag: 20, _name: "ECons", _val: [lhs, rhs_2523]});
                lhs = _t2525;
                continue;
                const _t2524 = undefined;
                _t2522 = _t2524;
              } else {
                const rhs_2526 = Parser$parse_expr_bp(p, r_bp);
                const _t2528 = ({_tag: 13, _name: "EBinop", _val: [Parser$binop_of_token(kind_2515), lhs, rhs_2526]});
                lhs = _t2528;
                continue;
                const _t2527 = undefined;
                _t2522 = _t2527;
              }
              _t2521 = _t2522;
            }
            _t2519 = _t2521;
            break _t2520;
          }
          _match_fail("line 15950");
        }
        _t2517 = _t2519;
      } else {
        _t2517 = lhs;
      }
      const _t2516 = _t2517;
      return _t2516;
    }
  }
  const _t2529 = loop(lhs_2513);
  const _t2514 = _t2529;
  return _t2514;
}
function Parser$parse_expr_no_seq(p) {
  const e_2530 = Parser$parse_expr_bp(p, 0);
  let _t2533;
  const _t2532 = Parser$peek_kind(p);
  _t2534: {
    if (_t2532._tag === 72) {
      Parser$advance(p);
      undefined;
      const rhs_2535 = Parser$parse_expr_bp(p, 0);
      let _t2538;
      const _t2537 = e_2530;
      _t2539: {
        if (_t2537._tag === 49) {
          const inner = _t2537._val[1];
          _t2538 = inner;
          break _t2539;
        }
        if (true) {
          const e = _t2537;
          _t2538 = e;
          break _t2539;
        }
        _match_fail("line 15950");
      }
      const e_inner_2540 = _t2538;
      let _t2543;
      const _t2542 = e_inner_2540;
      _t2544: {
        if (_t2542._tag === 7) {
          const name = _t2542._val;
          _t2543 = ({_tag: 27, _name: "EAssign", _val: [name, rhs_2535]});
          break _t2544;
        }
        if (_t2542._tag === 18) {
          const obj = _t2542._val[0];
          const field = _t2542._val[1];
          _t2543 = ({_tag: 28, _name: "EFieldAssign", _val: [obj, field, rhs_2535]});
          break _t2544;
        }
        if (true) {
          _t2543 = Parser$error(p, "left side of := must be a variable or field access");
          break _t2544;
        }
        _match_fail("line 15950");
      }
      const _t2541 = _t2543;
      const _t2536 = _t2541;
      _t2533 = _t2536;
      break _t2534;
    }
    if (true) {
      _t2533 = e_2530;
      break _t2534;
    }
    _match_fail("line 15950");
  }
  const _t2531 = _t2533;
  return _t2531;
}
function Parser$parse_expr(p) {
  const e_2545 = Parser$parse_expr_bp(p, 0);
  let _t2548;
  const _t2547 = Parser$peek_kind(p);
  _t2549: {
    if (_t2547._tag === 72) {
      Parser$advance(p);
      undefined;
      const rhs_2550 = Parser$parse_expr_bp(p, 0);
      let _t2553;
      const _t2552 = e_2545;
      _t2554: {
        if (_t2552._tag === 49) {
          const inner = _t2552._val[1];
          _t2553 = inner;
          break _t2554;
        }
        if (true) {
          const e = _t2552;
          _t2553 = e;
          break _t2554;
        }
        _match_fail("line 15950");
      }
      const e_inner_2555 = _t2553;
      let _t2558;
      const _t2557 = e_inner_2555;
      _t2559: {
        if (_t2557._tag === 7) {
          const name = _t2557._val;
          _t2558 = ({_tag: 27, _name: "EAssign", _val: [name, rhs_2550]});
          break _t2559;
        }
        if (_t2557._tag === 18) {
          const obj = _t2557._val[0];
          const field = _t2557._val[1];
          _t2558 = ({_tag: 28, _name: "EFieldAssign", _val: [obj, field, rhs_2550]});
          break _t2559;
        }
        if (true) {
          _t2558 = Parser$error(p, "left side of := must be a variable or field access");
          break _t2559;
        }
        _match_fail("line 15950");
      }
      const assign_2560 = _t2558;
      let _t2563;
      const _t2562 = Parser$peek_kind(p);
      _t2564: {
        if (_t2562._tag === 58) {
          if (!_eq(Parser$peek_next_kind(p), ({_tag: 1, _name: "Some", _val: ({_tag: 58, _name: "SEMICOLON"})}))) {
            Parser$advance(p);
            undefined;
            let _t2565;
            if (Parser$at_expr_start(p)) {
              _t2565 = ({_tag: 29, _name: "ESeq", _val: [assign_2560, Parser$parse_expr(p)]});
            } else {
              _t2565 = assign_2560;
            }
            _t2563 = _t2565;
            break _t2564;
          }
        }
        if (true) {
          _t2563 = assign_2560;
          break _t2564;
        }
        _match_fail("line 15950");
      }
      const _t2561 = _t2563;
      const _t2556 = _t2561;
      const _t2551 = _t2556;
      _t2548 = _t2551;
      break _t2549;
    }
    if (_t2547._tag === 58) {
      if (!_eq(Parser$peek_next_kind(p), ({_tag: 1, _name: "Some", _val: ({_tag: 58, _name: "SEMICOLON"})}))) {
        Parser$advance(p);
        undefined;
        let _t2566;
        if (Parser$at_expr_start(p)) {
          const e2_2567 = Parser$parse_expr(p);
          const _t2568 = ({_tag: 29, _name: "ESeq", _val: [e_2545, e2_2567]});
          _t2566 = _t2568;
        } else {
          _t2566 = e_2545;
        }
        _t2548 = _t2566;
        break _t2549;
      }
    }
    if (true) {
      _t2548 = e_2545;
      break _t2549;
    }
    _match_fail("line 15950");
  }
  const _t2546 = _t2548;
  return _t2546;
}
function Parser$peek_next_kind(p) {
  let _t2569;
  if (((p.pos + 1) < Array$length(p.tokens))) {
    _t2569 = ({_tag: 1, _name: "Some", _val: Array$get(p.tokens, (p.pos + 1)).kind});
  } else {
    _t2569 = ({_tag: 0, _name: "None"});
  }
  return _t2569;
}
function Parser$parse_fun_param(p) {
  let _t2571;
  const _t2570 = Parser$peek_kind(p);
  _t2572: {
    if (_t2570._tag === 50) {
      Parser$advance(p);
      undefined;
      let _t2573;
      if (_eq(Parser$peek_kind(p), ({_tag: 51, _name: "RPAREN"}))) {
        Parser$advance(p);
        undefined;
        _t2573 = ({_tag: 0, _name: "FPParam", _val: ({annot: ({_tag: 1, _name: "Some", _val: ({_tag: 0, _name: "TyName", _val: "unit"})}), is_generated: false, name: "_"})});
      } else {
        const pat_2574 = Parser$parse_pattern(p);
        let _t2576;
        if (_eq(Parser$peek_kind(p), ({_tag: 57, _name: "COMMA"}))) {
          const pats_2577 = Ref$create(({_hd: pat_2574, _tl: null}));
          let _t2579 = undefined;
          let _t2580 = false, _t2581;
          while (true) {
            if (!(_eq(Parser$peek_kind(p), ({_tag: 57, _name: "COMMA"})))) break;
            Parser$advance(p);
            undefined;
            Ref$set(pats_2577, ({_hd: Parser$parse_pattern(p), _tl: Ref$get(pats_2577)}));
            if (_t2580) break;
          }
          _t2579 = _t2580 ? _t2581 : undefined;
          _t2579;
          const _t2578 = ({_tag: 7, _name: "PatTuple", _val: List$rev(Ref$get(pats_2577))});
          _t2576 = _t2578;
        } else {
          _t2576 = pat_2574;
        }
        const pat_2582 = _t2576;
        let _t2584;
        if (_eq(Parser$peek_kind(p), ({_tag: 60, _name: "COLON"}))) {
          Parser$advance(p);
          undefined;
          _t2584 = ({_tag: 1, _name: "Some", _val: Parser$parse_ty(p)});
        } else {
          _t2584 = ({_tag: 0, _name: "None"});
        }
        const annot_2585 = _t2584;
        Parser$expect(p, ({_tag: 51, _name: "RPAREN"}));
        let _t2588;
        const _t2587 = [pat_2582, annot_2585];
        _t2589: {
          if (_t2587[0]._tag === 1) {
            const name = _t2587[0]._val;
            _t2588 = ({_tag: 0, _name: "FPParam", _val: ({annot: annot_2585, is_generated: false, name: name})});
            break _t2589;
          }
          if (true) {
            const pname_2590 = Parser$fresh_param_name(undefined);
            const _t2591 = ({_tag: 1, _name: "FPPat", _val: [pname_2590, pat_2582, annot_2585]});
            _t2588 = _t2591;
            break _t2589;
          }
          _match_fail("line 15950");
        }
        const _t2586 = _t2588;
        const _t2583 = _t2586;
        const _t2575 = _t2583;
        _t2573 = _t2575;
      }
      _t2571 = _t2573;
      break _t2572;
    }
    if (_t2570._tag === 52) {
      const pat_2592 = Parser$parse_pattern_atom(p);
      const pname_2594 = Parser$fresh_param_name(undefined);
      const _t2595 = ({_tag: 1, _name: "FPPat", _val: [pname_2594, pat_2592, ({_tag: 0, _name: "None"})]});
      const _t2593 = _t2595;
      _t2571 = _t2593;
      break _t2572;
    }
    if (_t2570._tag === 8) {
      const s = _t2570._val;
      Parser$advance(p);
      undefined;
      _t2571 = ({_tag: 0, _name: "FPParam", _val: ({annot: ({_tag: 0, _name: "None"}), is_generated: false, name: s})});
      break _t2572;
    }
    if (_t2570._tag === 65) {
      Parser$advance(p);
      undefined;
      _t2571 = ({_tag: 0, _name: "FPParam", _val: ({annot: ({_tag: 0, _name: "None"}), is_generated: false, name: "_"})});
      break _t2572;
    }
    if (true) {
      _t2571 = Parser$error(p, "expected parameter");
      break _t2572;
    }
    _match_fail("line 15950");
  }
  return _t2571;
}
function Parser$parse_fun(p) {
  Parser$expect(p, ({_tag: 16, _name: "FN"}));
  let _t2596;
  if (_eq(Parser$peek_kind(p), ({_tag: 63, _name: "PIPE"}))) {
    Parser$advance(p);
    undefined;
    const arms_2597 = Ref$create(null);
    const continue__2599 = Ref$create(true);
    let _t2601 = undefined;
    let _t2602 = false, _t2603;
    while (true) {
      if (!(Ref$get(continue__2599))) break;
      const pat_2604 = Parser$parse_pattern(p);
      let _t2606;
      if (_eq(Parser$peek_kind(p), ({_tag: 35, _name: "WHEN"}))) {
        Parser$advance(p);
        undefined;
        _t2606 = ({_tag: 1, _name: "Some", _val: Parser$parse_expr(p)});
      } else {
        _t2606 = ({_tag: 0, _name: "None"});
      }
      const guard_2607 = _t2606;
      Parser$expect(p, ({_tag: 56, _name: "ARROW"}));
      const body_2609 = Parser$parse_expr(p);
      Ref$set(arms_2597, ({_hd: [pat_2604, guard_2607, body_2609], _tl: Ref$get(arms_2597)}));
      let _t2611;
      if (_eq(Parser$peek_kind(p), ({_tag: 63, _name: "PIPE"}))) {
        Parser$advance(p);
        _t2611 = undefined;
      } else {
        _t2611 = Ref$set(continue__2599, false);
      }
      const _t2610 = _t2611;
      const _t2608 = _t2610;
      const _t2605 = _t2608;
      _t2605;
      if (_t2602) break;
    }
    _t2601 = _t2602 ? _t2603 : undefined;
    _t2601;
    const param_2612 = ({annot: ({_tag: 0, _name: "None"}), is_generated: false, name: "__x"});
    const _t2613 = ({_tag: 10, _name: "EFun", _val: [param_2612, ({_tag: 25, _name: "EMatch", _val: [({_tag: 7, _name: "EVar", _val: "__x"}), List$rev(Ref$get(arms_2597)), false]})]});
    const _t2600 = _t2613;
    const _t2598 = _t2600;
    _t2596 = _t2598;
  } else {
    const fun_params_2614 = Ref$create(null);
    let _t2616 = undefined;
    let _t2617 = false, _t2618;
    while (true) {
      if (!(!_eq(Parser$peek_kind(p), ({_tag: 56, _name: "ARROW"})))) break;
      Ref$set(fun_params_2614, ({_hd: Parser$parse_fun_param(p), _tl: Ref$get(fun_params_2614)}));
      if (_t2617) break;
    }
    _t2616 = _t2617 ? _t2618 : undefined;
    _t2616;
    let _t2619;
    if (_eq(Ref$get(fun_params_2614), null)) {
      _t2619 = Ref$set(fun_params_2614, ({_hd: ({_tag: 0, _name: "FPParam", _val: ({annot: ({_tag: 1, _name: "Some", _val: ({_tag: 0, _name: "TyName", _val: "unit"})}), is_generated: false, name: "_"})}), _tl: null}));
    } else {
      _t2619 = undefined;
    }
    _t2619;
    Parser$expect(p, ({_tag: 56, _name: "ARROW"}));
    const body_2620 = Parser$parse_expr(p);
    function _t2622(body, fp) {
      let _t2624;
      const _t2623 = fp;
      _t2625: {
        if (_t2623._tag === 0) {
          _t2624 = body;
          break _t2625;
        }
        if (_t2623._tag === 1) {
          const name = _t2623._val[0];
          const pat = _t2623._val[1];
          _t2624 = ({_tag: 25, _name: "EMatch", _val: [({_tag: 7, _name: "EVar", _val: name}), ({_hd: [pat, ({_tag: 0, _name: "None"}), body], _tl: null}), true]});
          break _t2625;
        }
        _match_fail("line 15950");
      }
      return _t2624;
    }
    const body_2626 = List$fold(_t2622, body_2620, Ref$get(fun_params_2614));
    function _t2628(fp) {
      let _t2630;
      const _t2629 = fp;
      _t2631: {
        if (_t2629._tag === 0) {
          const param = _t2629._val;
          _t2630 = param;
          break _t2631;
        }
        if (_t2629._tag === 1) {
          const name = _t2629._val[0];
          const annot = _t2629._val[2];
          _t2630 = ({annot: annot, is_generated: false, name: name});
          break _t2631;
        }
        _match_fail("line 15950");
      }
      return _t2630;
    }
    const params_2632 = List$map(_t2628, Ref$get(fun_params_2614));
    function _t2634(body, param) {
      return ({_tag: 10, _name: "EFun", _val: [param, body]});
    }
    const _t2633 = List$fold(_t2634, body_2626, params_2632);
    const _t2627 = _t2633;
    const _t2621 = _t2627;
    const _t2615 = _t2621;
    _t2596 = _t2615;
  }
  return _t2596;
}
function Parser$parse_param(p) {
  return Parser$parse_fun_param(p);
}
function Parser$parse_if(p) {
  Parser$expect(p, ({_tag: 14, _name: "IF"}));
  const cond_2635 = Parser$parse_expr(p);
  Parser$expect(p, ({_tag: 33, _name: "DO"}));
  const then_e_2637 = Parser$parse_expr(p);
  let _t2640;
  const _t2639 = Parser$peek_kind(p);
  _t2641: {
    if (_t2639._tag === 15) {
      Parser$advance(p);
      undefined;
      const else_e_2642 = Parser$parse_expr_no_seq(p);
      const _t2643 = ({_tag: 12, _name: "EIf", _val: [cond_2635, then_e_2637, else_e_2642]});
      _t2640 = _t2643;
      break _t2641;
    }
    if (_t2639._tag === 45) {
      Parser$advance(p);
      undefined;
      _t2640 = ({_tag: 12, _name: "EIf", _val: [cond_2635, then_e_2637, ({_tag: 6, _name: "EUnit"})]});
      break _t2641;
    }
    if (true) {
      _t2640 = Parser$error(p, "expected 'else' or 'end' after if body");
      break _t2641;
    }
    _match_fail("line 15950");
  }
  const _t2638 = _t2640;
  const _t2636 = _t2638;
  return _t2636;
}
function Parser$parse_type_params(p) {
  let _t2644;
  if ((_eq(Parser$peek_kind(p), ({_tag: 50, _name: "LPAREN"})) && _eq(Parser$peek_kind_at(p, 1), ({_tag: 19, _name: "TYPE"})))) {
    Parser$advance(p);
    undefined;
    Parser$advance(p);
    undefined;
    const tyvars_2645 = Ref$create(null);
    let _t2647 = undefined;
    let _t2648 = false, _t2649;
    while (true) {
      let _t2651;
      const _t2650 = Parser$peek_kind(p);
      _t2652: {
        if (_t2650._tag === 10) {
          _t2651 = true;
          break _t2652;
        }
        if (true) {
          _t2651 = false;
          break _t2652;
        }
        _match_fail("line 15950");
      }
      if (!(_t2651)) break;
      let _t2654;
      const _t2653 = Parser$advance(p);
      _t2655: {
        if (_t2653.kind._tag === 10) {
          const s = _t2653.kind._val;
          _t2654 = Ref$set(tyvars_2645, ({_hd: s, _tl: Ref$get(tyvars_2645)}));
          break _t2655;
        }
        if (true) {
          _t2654 = undefined;
          break _t2655;
        }
        _match_fail("line 15950");
      }
      _t2654;
      if (_t2648) break;
    }
    _t2647 = _t2648 ? _t2649 : undefined;
    _t2647;
    let _t2656;
    if (_eq(Ref$get(tyvars_2645), null)) {
      _t2656 = Parser$error(p, "expected type variable after 'type'");
    } else {
      _t2656 = undefined;
    }
    _t2656;
    Parser$expect(p, ({_tag: 51, _name: "RPAREN"}));
    const _t2646 = List$rev(Ref$get(tyvars_2645));
    _t2644 = _t2646;
  } else {
    _t2644 = null;
  }
  return _t2644;
}
function Parser$parse_let_expr(p) {
  Parser$expect(p, ({_tag: 11, _name: "LET"}));
  const is_rec_2657 = _eq(Parser$peek_kind(p), ({_tag: 12, _name: "REC"}));
  let _t2659;
  if (is_rec_2657) {
    Parser$advance(p);
    _t2659 = undefined;
  } else {
    _t2659 = undefined;
  }
  _t2659;
  const is_mut_2660 = _eq(Parser$peek_kind(p), ({_tag: 31, _name: "MUT"}));
  let _t2662;
  if (is_mut_2660) {
    Parser$advance(p);
    _t2662 = undefined;
  } else {
    _t2662 = undefined;
  }
  _t2662;
  let _t2663;
  if ((is_rec_2657 && is_mut_2660)) {
    _t2663 = Parser$error(p, "let rec mut is not supported");
  } else {
    _t2663 = undefined;
  }
  _t2663;
  let _t2664;
  if (((!is_rec_2657) && ((!is_mut_2660) && Parser$is_destruct_start(p)))) {
    const pat_2665 = Parser$parse_pattern(p);
    Parser$expect(p, ({_tag: 73, _name: "EQ"}));
    const e1_2667 = Parser$parse_expr(p);
    Parser$expect(p, ({_tag: 13, _name: "IN"}));
    const e2_2669 = Parser$parse_expr(p);
    const _t2670 = ({_tag: 25, _name: "EMatch", _val: [e1_2667, ({_hd: [pat_2665, ({_tag: 0, _name: "None"}), e2_2669], _tl: null}), true]});
    const _t2668 = _t2670;
    const _t2666 = _t2668;
    _t2664 = _t2666;
  } else {
    let _t2671;
    if (is_rec_2657) {
      _t2671 = Parser$parse_type_params(p);
    } else {
      _t2671 = null;
    }
    const type_params_2672 = _t2671;
    const name_2674 = Parser$expect_ident(p);
    let _t2676;
    if (is_mut_2660) {
      let _t2677;
      if (_eq(Parser$peek_kind(p), ({_tag: 60, _name: "COLON"}))) {
        Parser$advance(p);
        undefined;
        _t2677 = ({_tag: 1, _name: "Some", _val: Parser$parse_ty(p)});
      } else {
        _t2677 = ({_tag: 0, _name: "None"});
      }
      const annot_2678 = _t2677;
      Parser$expect(p, ({_tag: 73, _name: "EQ"}));
      const body_2680 = Parser$parse_expr(p);
      let _t2683;
      const _t2682 = annot_2678;
      _t2684: {
        if (_t2682._tag === 1) {
          const ty = _t2682._val;
          _t2683 = ({_tag: 30, _name: "EAnnot", _val: [body_2680, ty]});
          break _t2684;
        }
        if (_t2682._tag === 0) {
          _t2683 = body_2680;
          break _t2684;
        }
        _match_fail("line 15950");
      }
      const body_2685 = _t2683;
      Parser$expect(p, ({_tag: 13, _name: "IN"}));
      const rest_2687 = Parser$parse_expr(p);
      const _t2688 = ({_tag: 26, _name: "ELetMut", _val: [name_2674, body_2685, rest_2687]});
      const _t2686 = _t2688;
      const _t2681 = _t2686;
      const _t2679 = _t2681;
      _t2676 = _t2679;
    } else {
      const params_2689 = Ref$create(null);
      let _t2691 = undefined;
      let _t2692 = false, _t2693;
      while (true) {
        if (!((!_eq(Parser$peek_kind(p), ({_tag: 73, _name: "EQ"})) && !_eq(Parser$peek_kind(p), ({_tag: 60, _name: "COLON"}))))) break;
        Ref$set(params_2689, ({_hd: Parser$parse_param(p), _tl: Ref$get(params_2689)}));
        if (_t2692) break;
      }
      _t2691 = _t2692 ? _t2693 : undefined;
      _t2691;
      let _t2694;
      if (_eq(Parser$peek_kind(p), ({_tag: 60, _name: "COLON"}))) {
        Parser$advance(p);
        undefined;
        const ty_2695 = Parser$parse_ty(p);
        let _t2697;
        if (_eq(Parser$peek_kind(p), ({_tag: 69, _name: "SLASH"}))) {
          Parser$advance(p);
          undefined;
          let _t2698;
          if (_eq(Parser$peek_kind(p), ({_tag: 8, _name: "IDENT", _val: "pure"}))) {
            Parser$advance(p);
            undefined;
            _t2698 = ({_tag: 0, _name: "EffAnnotPure"});
          } else {
            _t2698 = ({_tag: 1, _name: "EffAnnotRow", _val: Parser$parse_eff_items(p)});
          }
          const eff_2699 = _t2698;
          const _t2700 = ({_tag: 1, _name: "Some", _val: ({_tag: 11, _name: "TyWithEffect", _val: [ty_2695, eff_2699]})});
          _t2697 = _t2700;
        } else {
          _t2697 = ({_tag: 1, _name: "Some", _val: ty_2695});
        }
        const _t2696 = _t2697;
        _t2694 = _t2696;
      } else {
        _t2694 = ({_tag: 0, _name: "None"});
      }
      const ret_annot_2701 = _t2694;
      Parser$expect(p, ({_tag: 73, _name: "EQ"}));
      const body_2703 = Parser$parse_expr(p);
      const full_body_2705 = Parser$wrap_params_expr(List$rev(Ref$get(params_2689)), ret_annot_2701, body_2703);
      let _t2707;
      if ((is_rec_2657 && _eq(Parser$peek_kind(p), ({_tag: 48, _name: "AND"})))) {
        const bindings_2708 = Ref$create(({_hd: [name_2674, type_params_2672, full_body_2705], _tl: null}));
        let _t2710 = undefined;
        let _t2711 = false, _t2712;
        while (true) {
          if (!(_eq(Parser$peek_kind(p), ({_tag: 48, _name: "AND"})))) break;
          Parser$advance(p);
          undefined;
          const and_name_2713 = Parser$expect_ident(p);
          const and_type_params_2715 = Parser$parse_type_params(p);
          const and_params_2717 = Ref$create(null);
          let _t2719 = undefined;
          let _t2720 = false, _t2721;
          while (true) {
            if (!((!_eq(Parser$peek_kind(p), ({_tag: 73, _name: "EQ"})) && !_eq(Parser$peek_kind(p), ({_tag: 60, _name: "COLON"}))))) break;
            Ref$set(and_params_2717, ({_hd: Parser$parse_param(p), _tl: Ref$get(and_params_2717)}));
            if (_t2720) break;
          }
          _t2719 = _t2720 ? _t2721 : undefined;
          _t2719;
          let _t2722;
          if (_eq(Parser$peek_kind(p), ({_tag: 60, _name: "COLON"}))) {
            Parser$advance(p);
            undefined;
            const ty_2723 = Parser$parse_ty(p);
            let _t2725;
            if (_eq(Parser$peek_kind(p), ({_tag: 69, _name: "SLASH"}))) {
              Parser$advance(p);
              undefined;
              let _t2726;
              if (_eq(Parser$peek_kind(p), ({_tag: 8, _name: "IDENT", _val: "pure"}))) {
                Parser$advance(p);
                undefined;
                _t2726 = ({_tag: 0, _name: "EffAnnotPure"});
              } else {
                _t2726 = ({_tag: 1, _name: "EffAnnotRow", _val: Parser$parse_eff_items(p)});
              }
              const eff_2727 = _t2726;
              const _t2728 = ({_tag: 1, _name: "Some", _val: ({_tag: 11, _name: "TyWithEffect", _val: [ty_2723, eff_2727]})});
              _t2725 = _t2728;
            } else {
              _t2725 = ({_tag: 1, _name: "Some", _val: ty_2723});
            }
            const _t2724 = _t2725;
            _t2722 = _t2724;
          } else {
            _t2722 = ({_tag: 0, _name: "None"});
          }
          const and_ret_annot_2729 = _t2722;
          Parser$expect(p, ({_tag: 73, _name: "EQ"}));
          const and_body_2731 = Parser$parse_expr(p);
          const and_full_body_2733 = Parser$wrap_params_expr(List$rev(Ref$get(and_params_2717)), and_ret_annot_2729, and_body_2731);
          const _t2734 = Ref$set(bindings_2708, ({_hd: [and_name_2713, and_type_params_2715, and_full_body_2733], _tl: Ref$get(bindings_2708)}));
          const _t2732 = _t2734;
          const _t2730 = _t2732;
          const _t2718 = _t2730;
          const _t2716 = _t2718;
          const _t2714 = _t2716;
          _t2714;
          if (_t2711) break;
        }
        _t2710 = _t2711 ? _t2712 : undefined;
        _t2710;
        Parser$expect(p, ({_tag: 13, _name: "IN"}));
        const rest_2735 = Parser$parse_expr(p);
        const _t2736 = ({_tag: 38, _name: "ELetRecAnd", _val: [List$rev(Ref$get(bindings_2708)), rest_2735]});
        const _t2709 = _t2736;
        _t2707 = _t2709;
      } else {
        Parser$expect(p, ({_tag: 13, _name: "IN"}));
        const rest_2737 = Parser$parse_expr(p);
        let _t2739;
        if (is_rec_2657) {
          _t2739 = ({_tag: 9, _name: "ELetRec", _val: [name_2674, type_params_2672, full_body_2705, rest_2737]});
        } else {
          _t2739 = ({_tag: 8, _name: "ELet", _val: [name_2674, full_body_2705, rest_2737]});
        }
        const _t2738 = _t2739;
        _t2707 = _t2738;
      }
      const _t2706 = _t2707;
      const _t2704 = _t2706;
      const _t2702 = _t2704;
      const _t2690 = _t2702;
      _t2676 = _t2690;
    }
    const _t2675 = _t2676;
    const _t2673 = _t2675;
    _t2664 = _t2673;
  }
  const _t2661 = _t2664;
  const _t2658 = _t2661;
  return _t2658;
}
function Parser$is_destruct_start(p) {
  let _t2741;
  const _t2740 = Parser$peek_kind(p);
  _t2742: {
    if ((((_t2740._tag === 50 || _t2740._tag === 52) || _t2740._tag === 54) || _t2740._tag === 9)) {
      _t2741 = true;
      break _t2742;
    }
    if (_t2740._tag === 8) {
      if (_eq(Parser$peek_kind_at(p, 1), ({_tag: 71, _name: "COLONCOLON"}))) {
        _t2741 = true;
        break _t2742;
      }
    }
    if (true) {
      _t2741 = false;
      break _t2742;
    }
    _match_fail("line 15950");
  }
  return _t2741;
}
function Parser$wrap_params_expr(fun_params, ret_annot, body) {
  function _t2743(body, fp) {
    let _t2745;
    const _t2744 = fp;
    _t2746: {
      if (_t2744._tag === 0) {
        _t2745 = body;
        break _t2746;
      }
      if (_t2744._tag === 1) {
        const name = _t2744._val[0];
        const pat = _t2744._val[1];
        _t2745 = ({_tag: 25, _name: "EMatch", _val: [({_tag: 7, _name: "EVar", _val: name}), ({_hd: [pat, ({_tag: 0, _name: "None"}), body], _tl: null}), true]});
        break _t2746;
      }
      _match_fail("line 15950");
    }
    return _t2745;
  }
  const body_2747 = List$fold(_t2743, body, fun_params);
  function _t2749(fp) {
    let _t2751;
    const _t2750 = fp;
    _t2752: {
      if (_t2750._tag === 0) {
        const param = _t2750._val;
        _t2751 = param;
        break _t2752;
      }
      if (_t2750._tag === 1) {
        const name = _t2750._val[0];
        const annot = _t2750._val[2];
        _t2751 = ({annot: annot, is_generated: true, name: name});
        break _t2752;
      }
      _match_fail("line 15950");
    }
    return _t2751;
  }
  const params_2753 = List$map(_t2749, fun_params);
  let _t2756;
  const _t2755 = ret_annot;
  _t2757: {
    if (_t2755._tag === 1 && _t2755._val._tag === 11) {
      const ret_ty = _t2755._val._val[0];
      const eff_annot = _t2755._val._val[1];
      if (!_eq(params_2753, null)) {
        const body_2758 = ({_tag: 30, _name: "EAnnot", _val: [body_2747, ret_ty]});
        function _t2760(param, body) {
          return ({_tag: 10, _name: "EFun", _val: [param, body]});
        }
        const full_fun_2761 = List$fold_right(_t2760, params_2753, body_2758);
        function build_arrow(__x) {
          let _t2764;
          const _t2763 = __x;
          _t2765: {
            if (_t2763 === null) {
              _t2764 = ret_ty;
              break _t2765;
            }
            if (_t2763 !== null && _t2763._tl === null) {
              const p = _t2763._hd;
              let _t2767;
              const _t2766 = p.annot;
              _t2768: {
                if (_t2766._tag === 1) {
                  const t = _t2766._val;
                  _t2767 = t;
                  break _t2768;
                }
                if (_t2766._tag === 0) {
                  _t2767 = ({_tag: 1, _name: "TyVar", _val: ("'_eff_p_" + p.name)});
                  break _t2768;
                }
                _match_fail("line 15950");
              }
              const pty_2769 = _t2767;
              const _t2770 = ({_tag: 2, _name: "TyArrow", _val: [pty_2769, ret_ty, ({_tag: 1, _name: "Some", _val: eff_annot})]});
              _t2764 = _t2770;
              break _t2765;
            }
            if (_t2763 !== null) {
              const p = _t2763._hd;
              const rest = _t2763._tl;
              let _t2772;
              const _t2771 = p.annot;
              _t2773: {
                if (_t2771._tag === 1) {
                  const t = _t2771._val;
                  _t2772 = t;
                  break _t2773;
                }
                if (_t2771._tag === 0) {
                  _t2772 = ({_tag: 1, _name: "TyVar", _val: ("'_eff_p_" + p.name)});
                  break _t2773;
                }
                _match_fail("line 15950");
              }
              const pty_2774 = _t2772;
              const _t2775 = ({_tag: 2, _name: "TyArrow", _val: [pty_2774, build_arrow(rest), ({_tag: 0, _name: "None"})]});
              _t2764 = _t2775;
              break _t2765;
            }
            _match_fail("line 15950");
          }
          return _t2764;
        }
        const _t2776 = ({_tag: 30, _name: "EAnnot", _val: [full_fun_2761, build_arrow(params_2753)]});
        const _t2762 = _t2776;
        const _t2759 = _t2762;
        _t2756 = _t2759;
        break _t2757;
      }
    }
    if (true) {
      let _t2778;
      const _t2777 = ret_annot;
      _t2779: {
        if (_t2777._tag === 1) {
          const ty = _t2777._val;
          _t2778 = ({_tag: 30, _name: "EAnnot", _val: [body_2747, ty]});
          break _t2779;
        }
        if (_t2777._tag === 0) {
          _t2778 = body_2747;
          break _t2779;
        }
        _match_fail("line 15950");
      }
      const body_2780 = _t2778;
      function _t2782(param, body) {
        return ({_tag: 10, _name: "EFun", _val: [param, body]});
      }
      const _t2781 = List$fold_right(_t2782, params_2753, body_2780);
      _t2756 = _t2781;
      break _t2757;
    }
    _match_fail("line 15950");
  }
  const _t2754 = _t2756;
  const _t2748 = _t2754;
  return _t2748;
}
function Parser$parse_match(p, partial) {
  Parser$expect(p, ({_tag: 17, _name: "MATCH"}));
  const scrut_2783 = Parser$parse_expr(p);
  Parser$expect(p, ({_tag: 18, _name: "WITH"}));
  let _t2785;
  if (_eq(Parser$peek_kind(p), ({_tag: 63, _name: "PIPE"}))) {
    Parser$advance(p);
    _t2785 = undefined;
  } else {
    _t2785 = undefined;
  }
  _t2785;
  const arms_2786 = Ref$create(null);
  const continue__2788 = Ref$create(true);
  let _t2790 = undefined;
  let _t2791 = false, _t2792;
  while (true) {
    if (!(Ref$get(continue__2788))) break;
    const pat_2793 = Parser$parse_pattern(p);
    let _t2795;
    if (_eq(Parser$peek_kind(p), ({_tag: 35, _name: "WHEN"}))) {
      Parser$advance(p);
      undefined;
      _t2795 = ({_tag: 1, _name: "Some", _val: Parser$parse_expr(p)});
    } else {
      _t2795 = ({_tag: 0, _name: "None"});
    }
    const guard_2796 = _t2795;
    Parser$expect(p, ({_tag: 56, _name: "ARROW"}));
    const body_2798 = Parser$parse_expr(p);
    Ref$set(arms_2786, ({_hd: [pat_2793, guard_2796, body_2798], _tl: Ref$get(arms_2786)}));
    let _t2800;
    if (_eq(Parser$peek_kind(p), ({_tag: 63, _name: "PIPE"}))) {
      Parser$advance(p);
      _t2800 = undefined;
    } else {
      _t2800 = Ref$set(continue__2788, false);
    }
    const _t2799 = _t2800;
    const _t2797 = _t2799;
    const _t2794 = _t2797;
    _t2794;
    if (_t2791) break;
  }
  _t2790 = _t2791 ? _t2792 : undefined;
  _t2790;
  const _t2789 = ({_tag: 25, _name: "EMatch", _val: [scrut_2783, List$rev(Ref$get(arms_2786)), partial]});
  const _t2787 = _t2789;
  const _t2784 = _t2787;
  return _t2784;
}
function Parser$parse_handle_expr(p) {
  Parser$expect(p, ({_tag: 26, _name: "HANDLE"}));
  const body_2801 = Parser$parse_expr(p);
  Parser$expect(p, ({_tag: 18, _name: "WITH"}));
  let _t2803;
  if (_eq(Parser$peek_kind(p), ({_tag: 63, _name: "PIPE"}))) {
    Parser$advance(p);
    _t2803 = undefined;
  } else {
    _t2803 = undefined;
  }
  _t2803;
  const arms_2804 = Ref$create(null);
  const continue_parsing_2806 = Ref$create(true);
  let _t2808 = undefined;
  let _t2809 = false, _t2810;
  while (true) {
    if (!(Ref$get(continue_parsing_2806))) break;
    let _t2812;
    const _t2811 = Parser$peek_kind(p);
    _t2813: {
      if (_t2811._tag === 30) {
        Parser$advance(p);
        undefined;
        const name_2814 = Parser$expect_ident(p);
        Parser$expect(p, ({_tag: 56, _name: "ARROW"}));
        const handler_body_2816 = Parser$parse_expr(p);
        Ref$set(arms_2804, ({_hd: ({_tag: 0, _name: "HReturn", _val: [name_2814, handler_body_2816]}), _tl: Ref$get(arms_2804)}));
        let _t2818;
        if (_eq(Parser$peek_kind(p), ({_tag: 63, _name: "PIPE"}))) {
          Parser$advance(p);
          _t2818 = undefined;
        } else {
          _t2818 = Ref$set(continue_parsing_2806, false);
        }
        const _t2817 = _t2818;
        const _t2815 = _t2817;
        _t2812 = _t2815;
        break _t2813;
      }
      if (_t2811._tag === 8) {
        const s = _t2811._val;
        Parser$advance(p);
        undefined;
        let _t2820;
        const _t2819 = Parser$peek_kind(p);
        _t2821: {
          if (_t2819._tag === 50) {
            if (_eq(Parser$peek_kind_at(p, 1), ({_tag: 51, _name: "RPAREN"}))) {
              Parser$advance(p);
              undefined;
              Parser$advance(p);
              undefined;
              _t2820 = "_";
              break _t2821;
            }
          }
          if (true) {
            _t2820 = Parser$expect_ident(p);
            break _t2821;
          }
          _match_fail("line 15950");
        }
        const arg_name_2822 = _t2820;
        const k_name_2824 = Parser$expect_ident(p);
        Parser$expect(p, ({_tag: 56, _name: "ARROW"}));
        const handler_body_2826 = Parser$parse_expr(p);
        Ref$set(arms_2804, ({_hd: ({_tag: 1, _name: "HOp", _val: [s, arg_name_2822, k_name_2824, handler_body_2826]}), _tl: Ref$get(arms_2804)}));
        let _t2828;
        if (_eq(Parser$peek_kind(p), ({_tag: 63, _name: "PIPE"}))) {
          Parser$advance(p);
          _t2828 = undefined;
        } else {
          _t2828 = Ref$set(continue_parsing_2806, false);
        }
        const _t2827 = _t2828;
        const _t2825 = _t2827;
        const _t2823 = _t2825;
        _t2812 = _t2823;
        break _t2813;
      }
      if (true) {
        _t2812 = Ref$set(continue_parsing_2806, false);
        break _t2813;
      }
      _match_fail("line 15950");
    }
    _t2812;
    if (_t2809) break;
  }
  _t2808 = _t2809 ? _t2810 : undefined;
  _t2808;
  const _t2807 = ({_tag: 40, _name: "EHandle", _val: [body_2801, List$rev(Ref$get(arms_2804))]});
  const _t2805 = _t2807;
  const _t2802 = _t2805;
  return _t2802;
}
function Parser$parse_try_expr(p) {
  Parser$expect(p, ({_tag: 27, _name: "TRY"}));
  const body_2829 = Parser$parse_expr(p);
  Parser$expect(p, ({_tag: 18, _name: "WITH"}));
  let _t2831;
  if (_eq(Parser$peek_kind(p), ({_tag: 63, _name: "PIPE"}))) {
    Parser$advance(p);
    _t2831 = undefined;
  } else {
    _t2831 = undefined;
  }
  _t2831;
  const arms_2832 = Ref$create(({_hd: ({_tag: 0, _name: "HReturn", _val: ["__x", ({_tag: 7, _name: "EVar", _val: "__x"})]}), _tl: null}));
  const continue_parsing_2834 = Ref$create(true);
  let _t2836 = undefined;
  let _t2837 = false, _t2838;
  while (true) {
    if (!(Ref$get(continue_parsing_2834))) break;
    let _t2840;
    const _t2839 = Parser$peek_kind(p);
    _t2841: {
      if (_t2839._tag === 8) {
        const s = _t2839._val;
        Parser$advance(p);
        undefined;
        let _t2843;
        const _t2842 = Parser$peek_kind(p);
        _t2844: {
          if (_t2842._tag === 50) {
            if (_eq(Parser$peek_kind_at(p, 1), ({_tag: 51, _name: "RPAREN"}))) {
              Parser$advance(p);
              undefined;
              Parser$advance(p);
              undefined;
              _t2843 = "_";
              break _t2844;
            }
          }
          if (true) {
            _t2843 = Parser$expect_ident(p);
            break _t2844;
          }
          _match_fail("line 15950");
        }
        const arg_name_2845 = _t2843;
        Parser$expect(p, ({_tag: 56, _name: "ARROW"}));
        const handler_body_2847 = Parser$parse_expr(p);
        Ref$set(arms_2832, ({_hd: ({_tag: 1, _name: "HOp", _val: [s, arg_name_2845, "__k", handler_body_2847]}), _tl: Ref$get(arms_2832)}));
        let _t2849;
        if (_eq(Parser$peek_kind(p), ({_tag: 63, _name: "PIPE"}))) {
          Parser$advance(p);
          _t2849 = undefined;
        } else {
          _t2849 = Ref$set(continue_parsing_2834, false);
        }
        const _t2848 = _t2849;
        const _t2846 = _t2848;
        _t2840 = _t2846;
        break _t2841;
      }
      if (true) {
        _t2840 = Ref$set(continue_parsing_2834, false);
        break _t2841;
      }
      _match_fail("line 15950");
    }
    _t2840;
    if (_t2837) break;
  }
  _t2836 = _t2837 ? _t2838 : undefined;
  _t2836;
  const _t2835 = ({_tag: 40, _name: "EHandle", _val: [body_2829, List$rev(Ref$get(arms_2832))]});
  const _t2833 = _t2835;
  const _t2830 = _t2833;
  return _t2830;
}
function Parser$lookahead_in_after_balanced(p) {
  const depth_2850 = Ref$create(1);
  const i_2852 = Ref$create(1);
  const hit_eof_2854 = Ref$create(false);
  let _t2856 = undefined;
  let _t2857 = false, _t2858;
  while (true) {
    if (!(((Ref$get(depth_2850) > 0) && (!Ref$get(hit_eof_2854))))) break;
    let _t2860;
    const _t2859 = Parser$peek_kind_at(p, Ref$get(i_2852));
    _t2861: {
      if (((_t2859._tag === 50 || _t2859._tag === 52) || _t2859._tag === 54)) {
        _t2860 = Ref$set(depth_2850, (Ref$get(depth_2850) + 1));
        break _t2861;
      }
      if (((_t2859._tag === 51 || _t2859._tag === 53) || _t2859._tag === 55)) {
        _t2860 = Ref$set(depth_2850, (Ref$get(depth_2850) - 1));
        break _t2861;
      }
      if (_t2859._tag === 89) {
        _t2860 = Ref$set(hit_eof_2854, true);
        break _t2861;
      }
      if (true) {
        _t2860 = undefined;
        break _t2861;
      }
      _match_fail("line 15950");
    }
    _t2860;
    Ref$set(i_2852, (Ref$get(i_2852) + 1));
    if (_t2857) break;
  }
  _t2856 = _t2857 ? _t2858 : undefined;
  _t2856;
  const _t2855 = ((!Ref$get(hit_eof_2854)) && ((Ref$get(depth_2850) === 0) && _eq(Parser$peek_kind_at(p, Ref$get(i_2852)), ({_tag: 13, _name: "IN"}))));
  const _t2853 = _t2855;
  const _t2851 = _t2853;
  return _t2851;
}
function Parser$pat_to_name_and_wrap(pat) {
  let _t2863;
  const _t2862 = pat;
  _t2864: {
    if (_t2862._tag === 1) {
      const name = _t2862._val;
      function _t2865(body) {
        return body;
      }
      _t2863 = [name, _t2865];
      break _t2864;
    }
    if (_t2862._tag === 0) {
      function _t2866(body) {
        return body;
      }
      _t2863 = ["_", _t2866];
      break _t2864;
    }
    if (true) {
      const pname_2867 = Parser$fresh_param_name(undefined);
      function _t2869(body) {
        return ({_tag: 25, _name: "EMatch", _val: [({_tag: 7, _name: "EVar", _val: pname_2867}), ({_hd: [pat, ({_tag: 0, _name: "None"}), body], _tl: null}), true]});
      }
      const _t2868 = [pname_2867, _t2869];
      _t2863 = _t2868;
      break _t2864;
    }
    _match_fail("line 15950");
  }
  return _t2863;
}
function Parser$parse_for_in_rest(p, elem_name, elem_wrap, coll) {
  let _t2871;
  const _t2870 = Parser$peek_kind(p);
  _t2872: {
    if (_t2870._tag === 18) {
      Parser$advance(p);
      undefined;
      let _t2874;
      const _t2873 = Parser$peek_kind(p);
      _t2875: {
        if (((_t2873._tag === 50 || _t2873._tag === 52) || _t2873._tag === 54)) {
          _t2874 = Parser$parse_pattern_atom(p);
          break _t2875;
        }
        if (true) {
          const name_2876 = Parser$expect_ident(p);
          const _t2877 = ({_tag: 1, _name: "PatVar", _val: name_2876});
          _t2874 = _t2877;
          break _t2875;
        }
        _match_fail("line 15950");
      }
      const acc_pat_2878 = _t2874;
      let _t2881;
      const _t2880 = Parser$pat_to_name_and_wrap(acc_pat_2878);
      _t2882: {
        if (true) {
          const acc_name = _t2880[0];
          const acc_wrap = _t2880[1];
          Parser$expect(p, ({_tag: 73, _name: "EQ"}));
          const init_2883 = Parser$parse_expr_bp(p, 0);
          Parser$expect(p, ({_tag: 33, _name: "DO"}));
          const body_2885 = Parser$parse_expr(p);
          Parser$expect(p, ({_tag: 45, _name: "END"}));
          const _t2886 = ({_tag: 33, _name: "EForFold", _val: [elem_name, coll, acc_name, init_2883, elem_wrap(acc_wrap(body_2885))]});
          const _t2884 = _t2886;
          _t2881 = _t2884;
          break _t2882;
        }
        _match_fail("line 15950");
      }
      const _t2879 = _t2881;
      _t2871 = _t2879;
      break _t2872;
    }
    if (_t2870._tag === 33) {
      Parser$advance(p);
      undefined;
      const body_2887 = Parser$parse_expr(p);
      Parser$expect(p, ({_tag: 45, _name: "END"}));
      const _t2888 = ({_tag: 32, _name: "EFor", _val: [elem_name, coll, elem_wrap(body_2887)]});
      _t2871 = _t2888;
      break _t2872;
    }
    if (true) {
      _t2871 = Parser$error(p, "expected 'do' or 'with' after for collection");
      break _t2872;
    }
    _match_fail("line 15950");
  }
  return _t2871;
}
function Parser$parse_for_expr(p) {
  Parser$expect(p, ({_tag: 32, _name: "FOR"}));
  let _t2890;
  const _t2889 = Parser$peek_kind(p);
  _t2891: {
    if (_t2889._tag === 33) {
      Parser$advance(p);
      undefined;
      const body_2892 = Parser$parse_expr(p);
      Parser$expect(p, ({_tag: 45, _name: "END"}));
      const _t2893 = ({_tag: 31, _name: "EWhile", _val: [({_tag: 2, _name: "EBool", _val: true}), body_2892]});
      _t2890 = _t2893;
      break _t2891;
    }
    if (_t2889._tag === 11) {
      Parser$advance(p);
      undefined;
      const pat_2894 = Parser$parse_pattern(p);
      Parser$expect(p, ({_tag: 73, _name: "EQ"}));
      const scrutinee_2896 = Parser$parse_expr_bp(p, 0);
      Parser$expect(p, ({_tag: 33, _name: "DO"}));
      const body_2898 = Parser$parse_expr(p);
      Parser$expect(p, ({_tag: 45, _name: "END"}));
      const _t2899 = ({_tag: 34, _name: "EWhileLet", _val: [pat_2894, scrutinee_2896, body_2898]});
      const _t2897 = _t2899;
      const _t2895 = _t2897;
      _t2890 = _t2895;
      break _t2891;
    }
    if ((_t2889._tag === 8 || _t2889._tag === 65)) {
      if (_eq(Parser$peek_kind_at(p, 1), ({_tag: 13, _name: "IN"}))) {
        let _t2900;
        if (_eq(Parser$peek_kind(p), ({_tag: 65, _name: "UNDERSCORE"}))) {
          Parser$advance(p);
          undefined;
          _t2900 = "_";
        } else {
          _t2900 = Parser$expect_ident(p);
        }
        const var_name_2901 = _t2900;
        Parser$expect(p, ({_tag: 13, _name: "IN"}));
        const coll_2903 = Parser$parse_expr_bp(p, 0);
        function _t2905(body) {
          return body;
        }
        const _t2904 = Parser$parse_for_in_rest(p, var_name_2901, _t2905, coll_2903);
        const _t2902 = _t2904;
        _t2890 = _t2902;
        break _t2891;
      }
    }
    if (((_t2889._tag === 50 || _t2889._tag === 52) || _t2889._tag === 54)) {
      if (Parser$lookahead_in_after_balanced(p)) {
        const pat_2906 = Parser$parse_pattern_atom(p);
        Parser$expect(p, ({_tag: 13, _name: "IN"}));
        const coll_2908 = Parser$parse_expr_bp(p, 0);
        let _t2911;
        const _t2910 = Parser$pat_to_name_and_wrap(pat_2906);
        _t2912: {
          if (true) {
            const elem_name = _t2910[0];
            const elem_wrap = _t2910[1];
            _t2911 = Parser$parse_for_in_rest(p, elem_name, elem_wrap, coll_2908);
            break _t2912;
          }
          _match_fail("line 15950");
        }
        const _t2909 = _t2911;
        const _t2907 = _t2909;
        _t2890 = _t2907;
        break _t2891;
      }
    }
    if (true) {
      const cond_2913 = Parser$parse_expr_bp(p, 0);
      Parser$expect(p, ({_tag: 33, _name: "DO"}));
      const body_2915 = Parser$parse_expr(p);
      Parser$expect(p, ({_tag: 45, _name: "END"}));
      const _t2916 = ({_tag: 31, _name: "EWhile", _val: [cond_2913, body_2915]});
      const _t2914 = _t2916;
      _t2890 = _t2914;
      break _t2891;
    }
    _match_fail("line 15950");
  }
  return _t2890;
}
function Parser$parse_record_fields(p) {
  const fields_2917 = Ref$create(null);
  const first_2919 = Ref$create(true);
  let _t2921 = undefined;
  let _t2922 = false, _t2923;
  while (true) {
    if (!(!_eq(Parser$peek_kind(p), ({_tag: 53, _name: "RBRACE"})))) break;
    let _t2924;
    if ((!Ref$get(first_2919))) {
      _t2924 = Parser$expect(p, ({_tag: 58, _name: "SEMICOLON"}));
    } else {
      _t2924 = undefined;
    }
    _t2924;
    let _t2925;
    if (_eq(Parser$peek_kind(p), ({_tag: 53, _name: "RBRACE"}))) {
      _t2925 = undefined;
    } else {
      Ref$set(first_2919, false);
      const name_2926 = Parser$expect_ident(p);
      let _t2928;
      if (_eq(Parser$peek_kind(p), ({_tag: 73, _name: "EQ"}))) {
        Parser$advance(p);
        undefined;
        _t2928 = Parser$parse_expr_bp(p, 0);
      } else {
        _t2928 = ({_tag: 7, _name: "EVar", _val: name_2926});
      }
      const expr_2929 = _t2928;
      const _t2930 = Ref$set(fields_2917, ({_hd: [name_2926, expr_2929], _tl: Ref$get(fields_2917)}));
      const _t2927 = _t2930;
      _t2925 = _t2927;
    }
    _t2925;
    if (_t2922) break;
  }
  _t2921 = _t2922 ? _t2923 : undefined;
  _t2921;
  const _t2920 = List$rev(Ref$get(fields_2917));
  const _t2918 = _t2920;
  return _t2918;
}
function Parser$parse_map_pairs(p) {
  let _t2931;
  if (_eq(Parser$peek_kind(p), ({_tag: 53, _name: "RBRACE"}))) {
    _t2931 = null;
  } else {
    const pairs_2932 = Ref$create(null);
    const first_2934 = Ref$create(true);
    let _t2936 = undefined;
    let _t2937 = false, _t2938;
    while (true) {
      if (!(!_eq(Parser$peek_kind(p), ({_tag: 53, _name: "RBRACE"})))) break;
      let _t2939;
      if ((!Ref$get(first_2934))) {
        _t2939 = Parser$expect(p, ({_tag: 58, _name: "SEMICOLON"}));
      } else {
        _t2939 = undefined;
      }
      _t2939;
      Ref$set(first_2934, false);
      const key_2940 = Parser$parse_expr_bp(p, 0);
      Parser$expect(p, ({_tag: 60, _name: "COLON"}));
      const value_2942 = Parser$parse_expr_bp(p, 0);
      const _t2943 = Ref$set(pairs_2932, ({_hd: [key_2940, value_2942], _tl: Ref$get(pairs_2932)}));
      const _t2941 = _t2943;
      _t2941;
      if (_t2937) break;
    }
    _t2936 = _t2937 ? _t2938 : undefined;
    _t2936;
    const _t2935 = List$rev(Ref$get(pairs_2932));
    const _t2933 = _t2935;
    _t2931 = _t2933;
  }
  return _t2931;
}
function Parser$parse_set_or_map(p) {
  let _t2944;
  if (_eq(Parser$peek_kind(p), ({_tag: 53, _name: "RBRACE"}))) {
    _t2944 = ({_tag: 887353506, _name: "`Map", _val: null});
  } else {
    const first_expr_2945 = Parser$parse_expr_bp(p, 0);
    let _t2947;
    if (_eq(Parser$peek_kind(p), ({_tag: 60, _name: "COLON"}))) {
      Parser$advance(p);
      undefined;
      const first_val_2948 = Parser$parse_expr_bp(p, 0);
      const pairs_2950 = Ref$create(({_hd: [first_expr_2945, first_val_2948], _tl: null}));
      let _t2952 = undefined;
      let _t2953 = false, _t2954;
      while (true) {
        if (!(_eq(Parser$peek_kind(p), ({_tag: 58, _name: "SEMICOLON"})))) break;
        Parser$advance(p);
        undefined;
        let _t2955;
        if (!_eq(Parser$peek_kind(p), ({_tag: 53, _name: "RBRACE"}))) {
          const key_2956 = Parser$parse_expr_bp(p, 0);
          Parser$expect(p, ({_tag: 60, _name: "COLON"}));
          const value_2958 = Parser$parse_expr_bp(p, 0);
          const _t2959 = Ref$set(pairs_2950, ({_hd: [key_2956, value_2958], _tl: Ref$get(pairs_2950)}));
          const _t2957 = _t2959;
          _t2955 = _t2957;
        } else {
          _t2955 = undefined;
        }
        _t2955;
        if (_t2953) break;
      }
      _t2952 = _t2953 ? _t2954 : undefined;
      _t2952;
      const _t2951 = ({_tag: 887353506, _name: "`Map", _val: List$rev(Ref$get(pairs_2950))});
      const _t2949 = _t2951;
      _t2947 = _t2949;
    } else {
      let _t2960;
      if (_eq(Parser$peek_kind(p), ({_tag: 18, _name: "WITH"}))) {
        Parser$advance(p);
        undefined;
        const pairs_2961 = Ref$create(null);
        const continue__2963 = Ref$create(true);
        let _t2965 = undefined;
        let _t2966 = false, _t2967;
        while (true) {
          if (!(Ref$get(continue__2963))) break;
          const key_2968 = Parser$parse_expr_bp(p, 0);
          Parser$expect(p, ({_tag: 60, _name: "COLON"}));
          const value_2970 = Parser$parse_expr_bp(p, 0);
          Ref$set(pairs_2961, ({_hd: [key_2968, value_2970], _tl: Ref$get(pairs_2961)}));
          let _t2972;
          if (_eq(Parser$peek_kind(p), ({_tag: 58, _name: "SEMICOLON"}))) {
            Parser$advance(p);
            undefined;
            let _t2973;
            if (_eq(Parser$peek_kind(p), ({_tag: 53, _name: "RBRACE"}))) {
              _t2973 = Ref$set(continue__2963, false);
            } else {
              _t2973 = undefined;
            }
            _t2972 = _t2973;
          } else {
            _t2972 = Ref$set(continue__2963, false);
          }
          const _t2971 = _t2972;
          const _t2969 = _t2971;
          _t2969;
          if (_t2966) break;
        }
        _t2965 = _t2966 ? _t2967 : undefined;
        _t2965;
        function _t2974(acc, __p31) {
          let _t2976;
          const _t2975 = __p31;
          _t2977: {
            if (true) {
              const k = _t2975[0];
              const v = _t2975[1];
              _t2976 = ({_tag: 11, _name: "EApp", _val: [({_tag: 11, _name: "EApp", _val: [({_tag: 11, _name: "EApp", _val: [({_tag: 7, _name: "EVar", _val: "set"}), k]}), v]}), acc]});
              break _t2977;
            }
            _match_fail("line 15950");
          }
          return _t2976;
        }
        const result_2978 = List$fold(_t2974, first_expr_2945, List$rev(Ref$get(pairs_2961)));
        const _t2979 = ({_tag: 533146490, _name: "`Update", _val: result_2978});
        const _t2964 = _t2979;
        const _t2962 = _t2964;
        _t2960 = _t2962;
      } else {
        const elems_2980 = Ref$create(({_hd: first_expr_2945, _tl: null}));
        let _t2982 = undefined;
        let _t2983 = false, _t2984;
        while (true) {
          if (!(_eq(Parser$peek_kind(p), ({_tag: 58, _name: "SEMICOLON"})))) break;
          Parser$advance(p);
          undefined;
          let _t2985;
          if (!_eq(Parser$peek_kind(p), ({_tag: 53, _name: "RBRACE"}))) {
            _t2985 = Ref$set(elems_2980, ({_hd: Parser$parse_expr_bp(p, 0), _tl: Ref$get(elems_2980)}));
          } else {
            _t2985 = undefined;
          }
          _t2985;
          if (_t2983) break;
        }
        _t2982 = _t2983 ? _t2984 : undefined;
        _t2982;
        const _t2981 = ({_tag: 98602162, _name: "`Set", _val: List$rev(Ref$get(elems_2980))});
        _t2960 = _t2981;
      }
      _t2947 = _t2960;
    }
    const _t2946 = _t2947;
    _t2944 = _t2946;
  }
  return _t2944;
}
function Parser$parse_list_elems(p) {
  const first_2986 = Parser$parse_expr_bp(p, 0);
  const elems_2988 = Ref$create(({_hd: first_2986, _tl: null}));
  let _t2990 = undefined;
  let _t2991 = false, _t2992;
  while (true) {
    if (!(_eq(Parser$peek_kind(p), ({_tag: 58, _name: "SEMICOLON"})))) break;
    Parser$advance(p);
    undefined;
    let _t2993;
    if (!_eq(Parser$peek_kind(p), ({_tag: 55, _name: "RBRACKET"}))) {
      _t2993 = Ref$set(elems_2988, ({_hd: Parser$parse_expr_bp(p, 0), _tl: Ref$get(elems_2988)}));
    } else {
      _t2993 = undefined;
    }
    _t2993;
    if (_t2991) break;
  }
  _t2990 = _t2991 ? _t2992 : undefined;
  _t2990;
  const _t2989 = List$rev(Ref$get(elems_2988));
  const _t2987 = _t2989;
  return _t2987;
}
function Parser$is_tyvar_token(__x) {
  let _t2995;
  const _t2994 = __x;
  _t2996: {
    if (_t2994._tag === 10) {
      _t2995 = true;
      break _t2996;
    }
    if (true) {
      _t2995 = false;
      break _t2996;
    }
    _match_fail("line 15950");
  }
  return _t2995;
}
function Parser$decompose_gadt_sig(ty) {
  function collect_args(__x) {
    let _t2998;
    const _t2997 = __x;
    _t2999: {
      if (_t2997._tag === 2) {
        const arg = _t2997._val[0];
        const rest = _t2997._val[1];
        let _t3001;
        const _t3000 = collect_args(rest);
        _t3002: {
          if (true) {
            const more_args = _t3000[0];
            const ret = _t3000[1];
            _t3001 = [({_hd: arg, _tl: more_args}), ret];
            break _t3002;
          }
          _match_fail("line 15950");
        }
        _t2998 = _t3001;
        break _t2999;
      }
      if (true) {
        const other = _t2997;
        _t2998 = [null, other];
        break _t2999;
      }
      _match_fail("line 15950");
    }
    return _t2998;
  }
  let _t3005;
  const _t3004 = collect_args(ty);
  _t3006: {
    if (_t3004[0] === null) {
      const ret = _t3004[1];
      _t3005 = [({_tag: 0, _name: "None"}), ret];
      break _t3006;
    }
    if (_t3004[0] !== null && _t3004[0]._tl === null) {
      const arg = _t3004[0]._hd;
      const ret = _t3004[1];
      _t3005 = [({_tag: 1, _name: "Some", _val: arg}), ret];
      break _t3006;
    }
    if (true) {
      const args = _t3004[0];
      const ret = _t3004[1];
      _t3005 = [({_tag: 1, _name: "Some", _val: ({_tag: 6, _name: "TyTuple", _val: args})}), ret];
      break _t3006;
    }
    _match_fail("line 15950");
  }
  const _t3003 = _t3005;
  return _t3003;
}
function Parser$parse_type_decl(p) {
  Parser$expect(p, ({_tag: 19, _name: "TYPE"}));
  let _t3008;
  const _t3007 = Parser$peek_kind(p);
  _t3009: {
    if (_t3007._tag === 10) {
      const s = _t3007._val;
      Parser$advance(p);
      undefined;
      _t3008 = ({_hd: s, _tl: null});
      break _t3009;
    }
    if (_t3007._tag === 50) {
      if (Parser$is_tyvar_token(Parser$peek_kind_at(p, 1))) {
        Parser$advance(p);
        undefined;
        const params_3010 = Ref$create(null);
        const first_3012 = Ref$create(true);
        let _t3014 = undefined;
        let _t3015 = false, _t3016;
        while (true) {
          if (!(!_eq(Parser$peek_kind(p), ({_tag: 51, _name: "RPAREN"})))) break;
          let _t3017;
          if ((!Ref$get(first_3012))) {
            _t3017 = Parser$expect(p, ({_tag: 57, _name: "COMMA"}));
          } else {
            _t3017 = undefined;
          }
          _t3017;
          Ref$set(first_3012, false);
          let _t3019;
          const _t3018 = Parser$peek_kind(p);
          _t3020: {
            if (_t3018._tag === 10) {
              const s = _t3018._val;
              Parser$advance(p);
              undefined;
              _t3019 = Ref$set(params_3010, ({_hd: s, _tl: Ref$get(params_3010)}));
              break _t3020;
            }
            if (true) {
              _t3019 = Parser$error(p, "expected type variable in type parameter list");
              break _t3020;
            }
            _match_fail("line 15950");
          }
          _t3019;
          if (_t3015) break;
        }
        _t3014 = _t3015 ? _t3016 : undefined;
        _t3014;
        Parser$expect(p, ({_tag: 51, _name: "RPAREN"}));
        const _t3013 = List$rev(Ref$get(params_3010));
        const _t3011 = _t3013;
        _t3008 = _t3011;
        break _t3009;
      }
    }
    if (true) {
      _t3008 = null;
      break _t3009;
    }
    _match_fail("line 15950");
  }
  const type_params_3021 = _t3008;
  const name_3023 = Parser$expect_ident(p);
  Parser$expect(p, ({_tag: 73, _name: "EQ"}));
  let _t3026;
  const _t3025 = Parser$peek_kind(p);
  _t3027: {
    if (_t3025._tag === 52) {
      Parser$advance(p);
      undefined;
      let _t3029;
      const _t3028 = Parser$parse_ty_record_fields(p);
      _t3030: {
        if (true) {
          const fields = _t3028[0];
          const _is_open = _t3028[1];
          Parser$expect(p, ({_tag: 53, _name: "RBRACE"}));
          _t3029 = ({_tag: 1, _name: "TDRecord", _val: fields});
          break _t3030;
        }
        _match_fail("line 15950");
      }
      _t3026 = _t3029;
      break _t3027;
    }
    if ((_t3025._tag === 63 || _t3025._tag === 9)) {
      let _t3031;
      if (_eq(Parser$peek_kind(p), ({_tag: 63, _name: "PIPE"}))) {
        Parser$advance(p);
        _t3031 = undefined;
      } else {
        _t3031 = undefined;
      }
      _t3031;
      const ctors_3032 = Ref$create(null);
      const continue__3034 = Ref$create(true);
      let _t3036 = undefined;
      let _t3037 = false, _t3038;
      while (true) {
        if (!(Ref$get(continue__3034))) break;
        const ctor_name_3039 = Parser$expect_uident(p);
        let _t3041;
        if (_eq(Parser$peek_kind(p), ({_tag: 60, _name: "COLON"}))) {
          Parser$advance(p);
          undefined;
          const full_sig_3042 = Parser$parse_ty(p);
          let _t3045;
          const _t3044 = Parser$decompose_gadt_sig(full_sig_3042);
          _t3046: {
            if (true) {
              const arg_ty = _t3044[0];
              const ret_ty = _t3044[1];
              _t3045 = Ref$set(ctors_3032, ({_hd: [ctor_name_3039, arg_ty, ({_tag: 1, _name: "Some", _val: ret_ty})], _tl: Ref$get(ctors_3032)}));
              break _t3046;
            }
            _match_fail("line 15950");
          }
          const _t3043 = _t3045;
          _t3041 = _t3043;
        } else {
          let _t3047;
          if (_eq(Parser$peek_kind(p), ({_tag: 20, _name: "OF"}))) {
            Parser$advance(p);
            undefined;
            _t3047 = ({_tag: 1, _name: "Some", _val: Parser$parse_ty(p)});
          } else {
            _t3047 = ({_tag: 0, _name: "None"});
          }
          const arg_3048 = _t3047;
          const _t3049 = Ref$set(ctors_3032, ({_hd: [ctor_name_3039, arg_3048, ({_tag: 0, _name: "None"})], _tl: Ref$get(ctors_3032)}));
          _t3041 = _t3049;
        }
        _t3041;
        let _t3050;
        if (_eq(Parser$peek_kind(p), ({_tag: 63, _name: "PIPE"}))) {
          Parser$advance(p);
          _t3050 = undefined;
        } else {
          _t3050 = Ref$set(continue__3034, false);
        }
        const _t3040 = _t3050;
        _t3040;
        if (_t3037) break;
      }
      _t3036 = _t3037 ? _t3038 : undefined;
      _t3036;
      const _t3035 = ({_tag: 0, _name: "TDVariant", _val: List$rev(Ref$get(ctors_3032))});
      const _t3033 = _t3035;
      _t3026 = _t3033;
      break _t3027;
    }
    if (true) {
      const rhs_3051 = Parser$parse_ty(p);
      const _t3052 = ({_tag: 2, _name: "TDAlias", _val: rhs_3051});
      _t3026 = _t3052;
      break _t3027;
    }
    _match_fail("line 15950");
  }
  const def_3053 = _t3026;
  let _t3055;
  if (_eq(Parser$peek_kind(p), ({_tag: 49, _name: "DERIVING"}))) {
    Parser$advance(p);
    undefined;
    const classes_3056 = Ref$create(null);
    const continue__3058 = Ref$create(true);
    let _t3060 = undefined;
    let _t3061 = false, _t3062;
    while (true) {
      let _t3066;
      if (Ref$get(continue__3058)) {
      let _t3064;
      const _t3063 = Parser$peek_kind(p);
      _t3065: {
        if (_t3063._tag === 9) {
          _t3064 = true;
          break _t3065;
        }
        if (true) {
          _t3064 = false;
          break _t3065;
        }
        _match_fail("line 15950");
      }
        _t3066 = _t3064;
      } else {
        _t3066 = false;
      }
      if (!(_t3066)) break;
      const cls_3067 = Parser$expect_uident(p);
      Ref$set(classes_3056, ({_hd: cls_3067, _tl: Ref$get(classes_3056)}));
      let _t3069;
      if (_eq(Parser$peek_kind(p), ({_tag: 57, _name: "COMMA"}))) {
        Parser$advance(p);
        _t3069 = undefined;
      } else {
        _t3069 = Ref$set(continue__3058, false);
      }
      const _t3068 = _t3069;
      _t3068;
      if (_t3061) break;
    }
    _t3060 = _t3061 ? _t3062 : undefined;
    _t3060;
    const _t3059 = List$rev(Ref$get(classes_3056));
    const _t3057 = _t3059;
    _t3055 = _t3057;
  } else {
    _t3055 = null;
  }
  const deriving__3070 = _t3055;
  let _t3072;
  if (!_eq(Parser$peek_kind(p), ({_tag: 48, _name: "AND"}))) {
    _t3072 = ({_tag: 4, _name: "DType", _val: [type_params_3021, name_3023, def_3053, deriving__3070]});
  } else {
    const defs_3073 = Ref$create(({_hd: [type_params_3021, name_3023, def_3053, deriving__3070], _tl: null}));
    let _t3075 = undefined;
    let _t3076 = false, _t3077;
    while (true) {
      if (!(_eq(Parser$peek_kind(p), ({_tag: 48, _name: "AND"})))) break;
      Parser$advance(p);
      undefined;
      let _t3079;
      const _t3078 = Parser$peek_kind(p);
      _t3080: {
        if (_t3078._tag === 10) {
          const s = _t3078._val;
          Parser$advance(p);
          undefined;
          _t3079 = ({_hd: s, _tl: null});
          break _t3080;
        }
        if (_t3078._tag === 50) {
          if (Parser$is_tyvar_token(Parser$peek_kind_at(p, 1))) {
            Parser$advance(p);
            undefined;
            const params_3081 = Ref$create(null);
            const first_3083 = Ref$create(true);
            let _t3085 = undefined;
            let _t3086 = false, _t3087;
            while (true) {
              if (!(!_eq(Parser$peek_kind(p), ({_tag: 51, _name: "RPAREN"})))) break;
              let _t3088;
              if ((!Ref$get(first_3083))) {
                _t3088 = Parser$expect(p, ({_tag: 57, _name: "COMMA"}));
              } else {
                _t3088 = undefined;
              }
              _t3088;
              Ref$set(first_3083, false);
              let _t3090;
              const _t3089 = Parser$peek_kind(p);
              _t3091: {
                if (_t3089._tag === 10) {
                  const s = _t3089._val;
                  Parser$advance(p);
                  undefined;
                  _t3090 = Ref$set(params_3081, ({_hd: s, _tl: Ref$get(params_3081)}));
                  break _t3091;
                }
                if (true) {
                  _t3090 = Parser$error(p, "expected type variable in type parameter list");
                  break _t3091;
                }
                _match_fail("line 15950");
              }
              _t3090;
              if (_t3086) break;
            }
            _t3085 = _t3086 ? _t3087 : undefined;
            _t3085;
            Parser$expect(p, ({_tag: 51, _name: "RPAREN"}));
            const _t3084 = List$rev(Ref$get(params_3081));
            const _t3082 = _t3084;
            _t3079 = _t3082;
            break _t3080;
          }
        }
        if (true) {
          _t3079 = null;
          break _t3080;
        }
        _match_fail("line 15950");
      }
      const and_type_params_3092 = _t3079;
      const and_name_3094 = Parser$expect_ident(p);
      Parser$expect(p, ({_tag: 73, _name: "EQ"}));
      let _t3097;
      const _t3096 = Parser$peek_kind(p);
      _t3098: {
        if (_t3096._tag === 52) {
          Parser$advance(p);
          undefined;
          let _t3100;
          const _t3099 = Parser$parse_ty_record_fields(p);
          _t3101: {
            if (true) {
              const fields = _t3099[0];
              const _is_open = _t3099[1];
              Parser$expect(p, ({_tag: 53, _name: "RBRACE"}));
              _t3100 = ({_tag: 1, _name: "TDRecord", _val: fields});
              break _t3101;
            }
            _match_fail("line 15950");
          }
          _t3097 = _t3100;
          break _t3098;
        }
        if ((_t3096._tag === 63 || _t3096._tag === 9)) {
          let _t3102;
          if (_eq(Parser$peek_kind(p), ({_tag: 63, _name: "PIPE"}))) {
            Parser$advance(p);
            _t3102 = undefined;
          } else {
            _t3102 = undefined;
          }
          _t3102;
          const ctors_3103 = Ref$create(null);
          const cont_3105 = Ref$create(true);
          let _t3107 = undefined;
          let _t3108 = false, _t3109;
          while (true) {
            if (!(Ref$get(cont_3105))) break;
            const ctor_name_3110 = Parser$expect_uident(p);
            let _t3112;
            if (_eq(Parser$peek_kind(p), ({_tag: 60, _name: "COLON"}))) {
              Parser$advance(p);
              undefined;
              const full_sig_3113 = Parser$parse_ty(p);
              let _t3116;
              const _t3115 = Parser$decompose_gadt_sig(full_sig_3113);
              _t3117: {
                if (true) {
                  const arg_ty = _t3115[0];
                  const ret_ty = _t3115[1];
                  _t3116 = Ref$set(ctors_3103, ({_hd: [ctor_name_3110, arg_ty, ({_tag: 1, _name: "Some", _val: ret_ty})], _tl: Ref$get(ctors_3103)}));
                  break _t3117;
                }
                _match_fail("line 15950");
              }
              const _t3114 = _t3116;
              _t3112 = _t3114;
            } else {
              let _t3118;
              if (_eq(Parser$peek_kind(p), ({_tag: 20, _name: "OF"}))) {
                Parser$advance(p);
                undefined;
                _t3118 = ({_tag: 1, _name: "Some", _val: Parser$parse_ty(p)});
              } else {
                _t3118 = ({_tag: 0, _name: "None"});
              }
              const arg_3119 = _t3118;
              const _t3120 = Ref$set(ctors_3103, ({_hd: [ctor_name_3110, arg_3119, ({_tag: 0, _name: "None"})], _tl: Ref$get(ctors_3103)}));
              _t3112 = _t3120;
            }
            _t3112;
            let _t3121;
            if (_eq(Parser$peek_kind(p), ({_tag: 63, _name: "PIPE"}))) {
              Parser$advance(p);
              _t3121 = undefined;
            } else {
              _t3121 = Ref$set(cont_3105, false);
            }
            const _t3111 = _t3121;
            _t3111;
            if (_t3108) break;
          }
          _t3107 = _t3108 ? _t3109 : undefined;
          _t3107;
          const _t3106 = ({_tag: 0, _name: "TDVariant", _val: List$rev(Ref$get(ctors_3103))});
          const _t3104 = _t3106;
          _t3097 = _t3104;
          break _t3098;
        }
        if (true) {
          const rhs_3122 = Parser$parse_ty(p);
          const _t3123 = ({_tag: 2, _name: "TDAlias", _val: rhs_3122});
          _t3097 = _t3123;
          break _t3098;
        }
        _match_fail("line 15950");
      }
      const and_def_3124 = _t3097;
      let _t3126;
      if (_eq(Parser$peek_kind(p), ({_tag: 49, _name: "DERIVING"}))) {
        Parser$advance(p);
        undefined;
        const classes_3127 = Ref$create(null);
        const cont_3129 = Ref$create(true);
        let _t3131 = undefined;
        let _t3132 = false, _t3133;
        while (true) {
          let _t3137;
          if (Ref$get(cont_3129)) {
          let _t3135;
          const _t3134 = Parser$peek_kind(p);
          _t3136: {
            if (_t3134._tag === 9) {
              _t3135 = true;
              break _t3136;
            }
            if (true) {
              _t3135 = false;
              break _t3136;
            }
            _match_fail("line 15950");
          }
            _t3137 = _t3135;
          } else {
            _t3137 = false;
          }
          if (!(_t3137)) break;
          const cls_3138 = Parser$expect_uident(p);
          Ref$set(classes_3127, ({_hd: cls_3138, _tl: Ref$get(classes_3127)}));
          let _t3140;
          if (_eq(Parser$peek_kind(p), ({_tag: 57, _name: "COMMA"}))) {
            Parser$advance(p);
            _t3140 = undefined;
          } else {
            _t3140 = Ref$set(cont_3129, false);
          }
          const _t3139 = _t3140;
          _t3139;
          if (_t3132) break;
        }
        _t3131 = _t3132 ? _t3133 : undefined;
        _t3131;
        const _t3130 = List$rev(Ref$get(classes_3127));
        const _t3128 = _t3130;
        _t3126 = _t3128;
      } else {
        _t3126 = null;
      }
      const and_deriving_3141 = _t3126;
      const _t3142 = Ref$set(defs_3073, ({_hd: [and_type_params_3092, and_name_3094, and_def_3124, and_deriving_3141], _tl: Ref$get(defs_3073)}));
      const _t3125 = _t3142;
      const _t3095 = _t3125;
      const _t3093 = _t3095;
      _t3093;
      if (_t3076) break;
    }
    _t3075 = _t3076 ? _t3077 : undefined;
    _t3075;
    const _t3074 = ({_tag: 5, _name: "DTypeAnd", _val: List$rev(Ref$get(defs_3073))});
    _t3072 = _t3074;
  }
  const _t3071 = _t3072;
  const _t3054 = _t3071;
  const _t3024 = _t3054;
  const _t3022 = _t3024;
  return _t3022;
}
function Parser$extract_pat_vars(__x) {
  while (true) {
    let _t3144;
    const _t3143 = __x;
    _t3145: {
      if (_t3143._tag === 1) {
        const name = _t3143._val;
        _t3144 = ({_hd: name, _tl: null});
        break _t3145;
      }
      if (((((((_t3143._tag === 0 || _t3143._tag === 2) || _t3143._tag === 3) || _t3143._tag === 4) || _t3143._tag === 5) || _t3143._tag === 6) || _t3143._tag === 9)) {
        _t3144 = null;
        break _t3145;
      }
      if (_t3143._tag === 7) {
        const pats = _t3143._val;
        _t3144 = List$concat_map(Parser$extract_pat_vars, pats);
        break _t3145;
      }
      if (_t3143._tag === 8) {
        const hd = _t3143._val[0];
        const tl = _t3143._val[1];
        _t3144 = List$concat(Parser$extract_pat_vars(hd), Parser$extract_pat_vars(tl));
        break _t3145;
      }
      if (_t3143._tag === 10 && _t3143._val[1]._tag === 0) {
        _t3144 = null;
        break _t3145;
      }
      if (_t3143._tag === 10 && _t3143._val[1]._tag === 1) {
        const p = _t3143._val[1]._val;
        const _t3146 = p;
        __x = _t3146;
        continue;
        _t3144 = undefined;
        break _t3145;
      }
      if (_t3143._tag === 11) {
        const fields = _t3143._val;
        function _t3147(__p32) {
          let _t3149;
          const _t3148 = __p32;
          _t3150: {
            if (true) {
              const p = _t3148[1];
              _t3149 = Parser$extract_pat_vars(p);
              break _t3150;
            }
            _match_fail("line 15950");
          }
          return _t3149;
        }
        _t3144 = List$concat_map(_t3147, fields);
        break _t3145;
      }
      if (_t3143._tag === 12) {
        const inner = _t3143._val[0];
        const name = _t3143._val[1];
        _t3144 = ({_hd: name, _tl: Parser$extract_pat_vars(inner)});
        break _t3145;
      }
      if (_t3143._tag === 13) {
        const p1 = _t3143._val[0];
        const _t3151 = p1;
        __x = _t3151;
        continue;
        _t3144 = undefined;
        break _t3145;
      }
      if (_t3143._tag === 14) {
        const pats = _t3143._val;
        _t3144 = List$concat_map(Parser$extract_pat_vars, pats);
        break _t3145;
      }
      if (_t3143._tag === 15) {
        const entries = _t3143._val;
        function _t3152(__p33) {
          let _t3154;
          const _t3153 = __p33;
          _t3155: {
            if (true) {
              const k = _t3153[0];
              const v = _t3153[1];
              _t3154 = List$concat(Parser$extract_pat_vars(k), Parser$extract_pat_vars(v));
              break _t3155;
            }
            _match_fail("line 15950");
          }
          return _t3154;
        }
        _t3144 = List$concat_map(_t3152, entries);
        break _t3145;
      }
      if (_t3143._tag === 16 && _t3143._val[1]._tag === 0) {
        _t3144 = null;
        break _t3145;
      }
      if (_t3143._tag === 16 && _t3143._val[1]._tag === 1) {
        const p = _t3143._val[1]._val;
        const _t3156 = p;
        __x = _t3156;
        continue;
        _t3144 = undefined;
        break _t3145;
      }
      if (_t3143._tag === 17) {
        _t3144 = null;
        break _t3145;
      }
      if (_t3143._tag === 18) {
        const p = _t3143._val[0];
        const _t3157 = p;
        __x = _t3157;
        continue;
        _t3144 = undefined;
        break _t3145;
      }
      _match_fail("line 15950");
    }
    return _t3144;
  }
}
function Parser$parse_constraints(p) {
  let _t3158;
  if (!_eq(Parser$peek_kind(p), ({_tag: 36, _name: "WHERE"}))) {
    _t3158 = null;
  } else {
    Parser$advance(p);
    undefined;
    const constraints_3159 = Ref$create(null);
    const continue__3161 = Ref$create(true);
    let _t3163 = undefined;
    let _t3164 = false, _t3165;
    while (true) {
      if (!(Ref$get(continue__3161))) break;
      let _t3167;
      const _t3166 = Parser$peek_kind(p);
      _t3168: {
        if (_t3166._tag === 9) {
          const class_name_start = _t3166._val;
          Parser$advance(p);
          undefined;
          let _t3169;
          if (_eq(Parser$peek_kind(p), ({_tag: 61, _name: "DOT"}))) {
            Parser$advance(p);
            undefined;
            let _t3171;
            const _t3170 = Parser$peek_kind(p);
            _t3172: {
              if (_t3170._tag === 9) {
                const s2 = _t3170._val;
                Parser$advance(p);
                undefined;
                _t3171 = (class_name_start + ("." + s2));
                break _t3172;
              }
              if (true) {
                _t3171 = Parser$error(p, "expected class name after dot");
                break _t3172;
              }
              _match_fail("line 15950");
            }
            _t3169 = _t3171;
          } else {
            _t3169 = class_name_start;
          }
          const class_name_3173 = _t3169;
          const tyvars_3175 = Ref$create(null);
          let _t3177 = undefined;
          let _t3178 = false, _t3179;
          while (true) {
            let _t3181;
            const _t3180 = Parser$peek_kind(p);
            _t3182: {
              if (_t3180._tag === 10) {
                _t3181 = true;
                break _t3182;
              }
              if (true) {
                _t3181 = false;
                break _t3182;
              }
              _match_fail("line 15950");
            }
            if (!(_t3181)) break;
            let _t3184;
            const _t3183 = Parser$advance(p).kind;
            _t3185: {
              if (_t3183._tag === 10) {
                const s = _t3183._val;
                _t3184 = Ref$set(tyvars_3175, ({_hd: s, _tl: Ref$get(tyvars_3175)}));
                break _t3185;
              }
              if (true) {
                _t3184 = undefined;
                break _t3185;
              }
              _match_fail("line 15950");
            }
            _t3184;
            if (_t3178) break;
          }
          _t3177 = _t3178 ? _t3179 : undefined;
          _t3177;
          let _t3186;
          if (_eq(Ref$get(tyvars_3175), null)) {
            _t3186 = Parser$error(p, "constraint requires at least one type variable");
          } else {
            _t3186 = undefined;
          }
          _t3186;
          Ref$set(constraints_3159, ({_hd: [class_name_3173, List$rev(Ref$get(tyvars_3175))], _tl: Ref$get(constraints_3159)}));
          let _t3187;
          if (_eq(Parser$peek_kind(p), ({_tag: 57, _name: "COMMA"}))) {
            Parser$advance(p);
            _t3187 = undefined;
          } else {
            _t3187 = Ref$set(continue__3161, false);
          }
          const _t3176 = _t3187;
          const _t3174 = _t3176;
          _t3167 = _t3174;
          break _t3168;
        }
        if (true) {
          _t3167 = Ref$set(continue__3161, false);
          break _t3168;
        }
        _match_fail("line 15950");
      }
      _t3167;
      if (_t3164) break;
    }
    _t3163 = _t3164 ? _t3165 : undefined;
    _t3163;
    const _t3162 = List$rev(Ref$get(constraints_3159));
    const _t3160 = _t3162;
    _t3158 = _t3160;
  }
  return _t3158;
}
function Parser$parse_let_decl(p) {
  Parser$expect(p, ({_tag: 11, _name: "LET"}));
  const is_rec_3188 = _eq(Parser$peek_kind(p), ({_tag: 12, _name: "REC"}));
  let _t3190;
  if (is_rec_3188) {
    Parser$advance(p);
    _t3190 = undefined;
  } else {
    _t3190 = undefined;
  }
  _t3190;
  const is_mut_3191 = _eq(Parser$peek_kind(p), ({_tag: 31, _name: "MUT"}));
  let _t3193;
  if (is_mut_3191) {
    Parser$advance(p);
    _t3193 = undefined;
  } else {
    _t3193 = undefined;
  }
  _t3193;
  let _t3194;
  if ((is_rec_3188 && is_mut_3191)) {
    _t3194 = Parser$error(p, "let rec mut is not supported");
  } else {
    _t3194 = undefined;
  }
  _t3194;
  let _t3195;
  if (((!is_rec_3188) && ((!is_mut_3191) && Parser$is_destruct_start(p)))) {
    const pat_3196 = Parser$parse_pattern(p);
    Parser$expect(p, ({_tag: 73, _name: "EQ"}));
    const body_3198 = Parser$parse_expr(p);
    let _t3200;
    if (_eq(Parser$peek_kind(p), ({_tag: 13, _name: "IN"}))) {
      Parser$advance(p);
      undefined;
      const rest_3201 = Parser$parse_expr(p);
      const _t3202 = ({_hd: ({_tag: 6, _name: "DExpr", _val: ({_tag: 25, _name: "EMatch", _val: [body_3198, ({_hd: [pat_3196, ({_tag: 0, _name: "None"}), rest_3201], _tl: null}), true]})}), _tl: null});
      _t3200 = _t3202;
    } else {
      const tmp_3203 = "__destruct";
      const vars_3205 = Parser$extract_pat_vars(pat_3196);
      const decls_3207 = ({_hd: ({_tag: 0, _name: "DLet", _val: [tmp_3203, null, ({_tag: 0, _name: "None"}), null, body_3198]}), _tl: null});
      function _t3209(v) {
        return ({_tag: 0, _name: "DLet", _val: [v, null, ({_tag: 0, _name: "None"}), null, ({_tag: 25, _name: "EMatch", _val: [({_tag: 7, _name: "EVar", _val: tmp_3203}), ({_hd: [pat_3196, ({_tag: 0, _name: "None"}), ({_tag: 7, _name: "EVar", _val: v})], _tl: null}), true]})]});
      }
      const _t3208 = List$concat(decls_3207, List$map(_t3209, vars_3205));
      const _t3206 = _t3208;
      const _t3204 = _t3206;
      _t3200 = _t3204;
    }
    const _t3199 = _t3200;
    const _t3197 = _t3199;
    _t3195 = _t3197;
  } else {
    let _t3210;
    if (is_mut_3191) {
      const name_3211 = Parser$expect_ident(p);
      let _t3213;
      if (_eq(Parser$peek_kind(p), ({_tag: 60, _name: "COLON"}))) {
        Parser$advance(p);
        undefined;
        _t3213 = ({_tag: 1, _name: "Some", _val: Parser$parse_ty(p)});
      } else {
        _t3213 = ({_tag: 0, _name: "None"});
      }
      const annot_3214 = _t3213;
      Parser$expect(p, ({_tag: 73, _name: "EQ"}));
      const body_3216 = Parser$parse_expr(p);
      let _t3219;
      const _t3218 = annot_3214;
      _t3220: {
        if (_t3218._tag === 1) {
          const ty = _t3218._val;
          _t3219 = ({_tag: 30, _name: "EAnnot", _val: [body_3216, ty]});
          break _t3220;
        }
        if (_t3218._tag === 0) {
          _t3219 = body_3216;
          break _t3220;
        }
        _match_fail("line 15950");
      }
      const body_3221 = _t3219;
      let _t3223;
      if (_eq(Parser$peek_kind(p), ({_tag: 13, _name: "IN"}))) {
        Parser$advance(p);
        undefined;
        const rest_3224 = Parser$parse_expr(p);
        const _t3225 = ({_hd: ({_tag: 6, _name: "DExpr", _val: ({_tag: 26, _name: "ELetMut", _val: [name_3211, body_3221, rest_3224]})}), _tl: null});
        _t3223 = _t3225;
      } else {
        _t3223 = ({_hd: ({_tag: 1, _name: "DLetMut", _val: [name_3211, body_3221]}), _tl: null});
      }
      const _t3222 = _t3223;
      const _t3217 = _t3222;
      const _t3215 = _t3217;
      const _t3212 = _t3215;
      _t3210 = _t3212;
    } else {
      let _t3226;
      if (is_rec_3188) {
        _t3226 = Parser$parse_type_params(p);
      } else {
        _t3226 = null;
      }
      const type_params_3227 = _t3226;
      const name_3229 = Parser$expect_ident(p);
      const fun_params_3231 = Ref$create(null);
      let _t3233 = undefined;
      let _t3234 = false, _t3235;
      while (true) {
        if (!((!_eq(Parser$peek_kind(p), ({_tag: 73, _name: "EQ"})) && (!_eq(Parser$peek_kind(p), ({_tag: 60, _name: "COLON"})) && !_eq(Parser$peek_kind(p), ({_tag: 36, _name: "WHERE"})))))) break;
        Ref$set(fun_params_3231, ({_hd: Parser$parse_param(p), _tl: Ref$get(fun_params_3231)}));
        if (_t3234) break;
      }
      _t3233 = _t3234 ? _t3235 : undefined;
      _t3233;
      let _t3236;
      if (_eq(Parser$peek_kind(p), ({_tag: 60, _name: "COLON"}))) {
        Parser$advance(p);
        undefined;
        const ty_3237 = Parser$parse_ty(p);
        let _t3239;
        if (_eq(Parser$peek_kind(p), ({_tag: 69, _name: "SLASH"}))) {
          Parser$advance(p);
          undefined;
          let _t3240;
          if (_eq(Parser$peek_kind(p), ({_tag: 8, _name: "IDENT", _val: "pure"}))) {
            Parser$advance(p);
            undefined;
            _t3240 = ({_tag: 0, _name: "EffAnnotPure"});
          } else {
            _t3240 = ({_tag: 1, _name: "EffAnnotRow", _val: Parser$parse_eff_items(p)});
          }
          const eff_3241 = _t3240;
          const _t3242 = ({_tag: 1, _name: "Some", _val: ({_tag: 11, _name: "TyWithEffect", _val: [ty_3237, eff_3241]})});
          _t3239 = _t3242;
        } else {
          _t3239 = ({_tag: 1, _name: "Some", _val: ty_3237});
        }
        const _t3238 = _t3239;
        _t3236 = _t3238;
      } else {
        _t3236 = ({_tag: 0, _name: "None"});
      }
      const ret_annot_3243 = _t3236;
      const constraints_3245 = Parser$parse_constraints(p);
      Parser$expect(p, ({_tag: 73, _name: "EQ"}));
      const body_3247 = Parser$parse_expr(p);
      const fun_params_3249 = List$rev(Ref$get(fun_params_3231));
      let _t3252;
      const _t3251 = Parser$resolve_fun_params(fun_params_3249, body_3247);
      _t3253: {
        if (true) {
          const params = _t3251[0];
          const body = _t3251[1];
          let _t3254;
          if (_eq(Parser$peek_kind(p), ({_tag: 13, _name: "IN"}))) {
            Parser$advance(p);
            undefined;
            const rest_3255 = Parser$parse_expr(p);
            const full_body_3257 = Parser$wrap_params_expr(fun_params_3249, ret_annot_3243, body);
            let _t3259;
            if (is_rec_3188) {
              _t3259 = ({_tag: 9, _name: "ELetRec", _val: [name_3229, type_params_3227, full_body_3257, rest_3255]});
            } else {
              _t3259 = ({_tag: 8, _name: "ELet", _val: [name_3229, full_body_3257, rest_3255]});
            }
            const expr_3260 = _t3259;
            const _t3261 = ({_hd: ({_tag: 6, _name: "DExpr", _val: expr_3260}), _tl: null});
            const _t3258 = _t3261;
            const _t3256 = _t3258;
            _t3254 = _t3256;
          } else {
            let _t3262;
            if ((is_rec_3188 && _eq(Parser$peek_kind(p), ({_tag: 48, _name: "AND"})))) {
              const bindings_3263 = Ref$create(({_hd: [name_3229, type_params_3227, params, ret_annot_3243, constraints_3245, body], _tl: null}));
              let _t3265 = undefined;
              let _t3266 = false, _t3267;
              while (true) {
                if (!(_eq(Parser$peek_kind(p), ({_tag: 48, _name: "AND"})))) break;
                Parser$advance(p);
                undefined;
                const and_name_3268 = Parser$expect_ident(p);
                const and_type_params_3270 = Parser$parse_type_params(p);
                const and_fun_params_3272 = Ref$create(null);
                let _t3274 = undefined;
                let _t3275 = false, _t3276;
                while (true) {
                  if (!((!_eq(Parser$peek_kind(p), ({_tag: 73, _name: "EQ"})) && (!_eq(Parser$peek_kind(p), ({_tag: 60, _name: "COLON"})) && !_eq(Parser$peek_kind(p), ({_tag: 36, _name: "WHERE"})))))) break;
                  Ref$set(and_fun_params_3272, ({_hd: Parser$parse_param(p), _tl: Ref$get(and_fun_params_3272)}));
                  if (_t3275) break;
                }
                _t3274 = _t3275 ? _t3276 : undefined;
                _t3274;
                let _t3277;
                if (_eq(Parser$peek_kind(p), ({_tag: 60, _name: "COLON"}))) {
                  Parser$advance(p);
                  undefined;
                  const ty_3278 = Parser$parse_ty(p);
                  let _t3280;
                  if (_eq(Parser$peek_kind(p), ({_tag: 69, _name: "SLASH"}))) {
                    Parser$advance(p);
                    undefined;
                    let _t3281;
                    if (_eq(Parser$peek_kind(p), ({_tag: 8, _name: "IDENT", _val: "pure"}))) {
                      Parser$advance(p);
                      undefined;
                      _t3281 = ({_tag: 0, _name: "EffAnnotPure"});
                    } else {
                      _t3281 = ({_tag: 1, _name: "EffAnnotRow", _val: Parser$parse_eff_items(p)});
                    }
                    const eff_3282 = _t3281;
                    const _t3283 = ({_tag: 1, _name: "Some", _val: ({_tag: 11, _name: "TyWithEffect", _val: [ty_3278, eff_3282]})});
                    _t3280 = _t3283;
                  } else {
                    _t3280 = ({_tag: 1, _name: "Some", _val: ty_3278});
                  }
                  const _t3279 = _t3280;
                  _t3277 = _t3279;
                } else {
                  _t3277 = ({_tag: 0, _name: "None"});
                }
                const and_ret_annot_3284 = _t3277;
                const and_constraints_3286 = Parser$parse_constraints(p);
                Parser$expect(p, ({_tag: 73, _name: "EQ"}));
                const and_body_3288 = Parser$parse_expr(p);
                const and_fun_params_3290 = List$rev(Ref$get(and_fun_params_3272));
                let _t3293;
                const _t3292 = Parser$resolve_fun_params(and_fun_params_3290, and_body_3288);
                _t3294: {
                  if (true) {
                    const and_params = _t3292[0];
                    const and_body = _t3292[1];
                    _t3293 = Ref$set(bindings_3263, ({_hd: [and_name_3268, and_type_params_3270, and_params, and_ret_annot_3284, and_constraints_3286, and_body], _tl: Ref$get(bindings_3263)}));
                    break _t3294;
                  }
                  _match_fail("line 15950");
                }
                const _t3291 = _t3293;
                const _t3289 = _t3291;
                const _t3287 = _t3289;
                const _t3285 = _t3287;
                const _t3273 = _t3285;
                const _t3271 = _t3273;
                const _t3269 = _t3271;
                _t3269;
                if (_t3266) break;
              }
              _t3265 = _t3266 ? _t3267 : undefined;
              _t3265;
              let _t3295;
              if (_eq(Parser$peek_kind(p), ({_tag: 13, _name: "IN"}))) {
                Parser$advance(p);
                undefined;
                const rest_3296 = Parser$parse_expr(p);
                function _t3298(__p34) {
                  let _t3300;
                  const _t3299 = __p34;
                  _t3301: {
                    if (true) {
                      const n = _t3299[0];
                      const tp = _t3299[1];
                      const ps = _t3299[2];
                      const ra = _t3299[3];
                      const _cs = _t3299[4];
                      const b = _t3299[5];
                      function _t3302(p) {
                        return ({_tag: 0, _name: "FPParam", _val: p});
                      }
                      const full_3303 = Parser$wrap_params_expr(List$map(_t3302, ps), ra, b);
                      const _t3304 = [n, tp, full_3303];
                      _t3300 = _t3304;
                      break _t3301;
                    }
                    _match_fail("line 15950");
                  }
                  return _t3300;
                }
                const expr_bindings_3305 = List$map(_t3298, List$rev(Ref$get(bindings_3263)));
                const _t3306 = ({_hd: ({_tag: 6, _name: "DExpr", _val: ({_tag: 38, _name: "ELetRecAnd", _val: [expr_bindings_3305, rest_3296]})}), _tl: null});
                const _t3297 = _t3306;
                _t3295 = _t3297;
              } else {
                _t3295 = ({_hd: ({_tag: 3, _name: "DLetRecAnd", _val: List$rev(Ref$get(bindings_3263))}), _tl: null});
              }
              const _t3264 = _t3295;
              _t3262 = _t3264;
            } else {
              let _t3307;
              if (is_rec_3188) {
                _t3307 = ({_hd: ({_tag: 2, _name: "DLetRec", _val: [name_3229, type_params_3227, params, ret_annot_3243, constraints_3245, body]}), _tl: null});
              } else {
                _t3307 = ({_hd: ({_tag: 0, _name: "DLet", _val: [name_3229, params, ret_annot_3243, constraints_3245, body]}), _tl: null});
              }
              _t3262 = _t3307;
            }
            _t3254 = _t3262;
          }
          _t3252 = _t3254;
          break _t3253;
        }
        _match_fail("line 15950");
      }
      const _t3250 = _t3252;
      const _t3248 = _t3250;
      const _t3246 = _t3248;
      const _t3244 = _t3246;
      const _t3232 = _t3244;
      const _t3230 = _t3232;
      const _t3228 = _t3230;
      _t3210 = _t3228;
    }
    _t3195 = _t3210;
  }
  const _t3192 = _t3195;
  const _t3189 = _t3192;
  return _t3189;
}
function Parser$parse_class_name(p) {
  let _t3309;
  const _t3308 = Parser$peek_kind(p);
  _t3310: {
    if (_t3308._tag === 9) {
      const s = _t3308._val;
      Parser$advance(p);
      undefined;
      let _t3311;
      if (_eq(Parser$peek_kind(p), ({_tag: 61, _name: "DOT"}))) {
        Parser$advance(p);
        undefined;
        let _t3313;
        const _t3312 = Parser$peek_kind(p);
        _t3314: {
          if (_t3312._tag === 9) {
            const s2 = _t3312._val;
            Parser$advance(p);
            undefined;
            _t3313 = (s + ("." + s2));
            break _t3314;
          }
          if (true) {
            _t3313 = Parser$error(p, "expected class name after dot");
            break _t3314;
          }
          _match_fail("line 15950");
        }
        _t3311 = _t3313;
      } else {
        _t3311 = s;
      }
      _t3309 = _t3311;
      break _t3310;
    }
    if (true) {
      _t3309 = Parser$error(p, "expected class name");
      break _t3310;
    }
    _match_fail("line 15950");
  }
  return _t3309;
}
function Parser$parse_class_decl(p) {
  Parser$expect(p, ({_tag: 21, _name: "CLASS"}));
  const class_name_3315 = Parser$expect_uident(p);
  let _t3317;
  if (_eq(Parser$peek_kind(p), ({_tag: 61, _name: "DOT"}))) {
    _t3317 = Parser$error(p, "class declarations cannot use qualified names; define the class inside a module instead");
  } else {
    _t3317 = undefined;
  }
  _t3317;
  const tyvars_3318 = Ref$create(null);
  const continue_tyvars_3320 = Ref$create(true);
  let _t3322 = undefined;
  let _t3323 = false, _t3324;
  while (true) {
    if (!(Ref$get(continue_tyvars_3320))) break;
    let _t3326;
    const _t3325 = Parser$peek_kind(p);
    _t3327: {
      if (_t3325._tag === 10) {
        const s = _t3325._val;
        Parser$advance(p);
        undefined;
        _t3326 = Ref$set(tyvars_3318, ({_hd: s, _tl: Ref$get(tyvars_3318)}));
        break _t3327;
      }
      if (true) {
        _t3326 = Ref$set(continue_tyvars_3320, false);
        break _t3327;
      }
      _match_fail("line 15950");
    }
    _t3326;
    if (_t3323) break;
  }
  _t3322 = _t3323 ? _t3324 : undefined;
  _t3322;
  const tyvars_3328 = List$rev(Ref$get(tyvars_3318));
  let _t3330;
  if (_eq(tyvars_3328, null)) {
    _t3330 = Parser$error(p, "expected at least one type variable");
  } else {
    _t3330 = undefined;
  }
  _t3330;
  let _t3331;
  if (_eq(Parser$peek_kind(p), ({_tag: 36, _name: "WHERE"}))) {
    Parser$advance(p);
    undefined;
    const deps_3332 = Ref$create(null);
    const continue__3334 = Ref$create(true);
    let _t3336 = undefined;
    let _t3337 = false, _t3338;
    while (true) {
      if (!(Ref$get(continue__3334))) break;
      const from_vars_3339 = Ref$create(null);
      let _t3341 = undefined;
      let _t3342 = false, _t3343;
      while (true) {
        let _t3345;
        const _t3344 = Parser$peek_kind(p);
        _t3346: {
          if (_t3344._tag === 10) {
            _t3345 = true;
            break _t3346;
          }
          if (true) {
            _t3345 = false;
            break _t3346;
          }
          _match_fail("line 15950");
        }
        if (!(_t3345)) break;
        let _t3348;
        const _t3347 = Parser$advance(p).kind;
        _t3349: {
          if (_t3347._tag === 10) {
            const s = _t3347._val;
            let _t3350;
            if ((!List$mem(s, tyvars_3328))) {
              _t3350 = Parser$error(p, (("functional dependency type variable '" + __dict_Show_string.show(s)) + " not in class parameters"));
            } else {
              _t3350 = undefined;
            }
            _t3350;
            _t3348 = Ref$set(from_vars_3339, ({_hd: s, _tl: Ref$get(from_vars_3339)}));
            break _t3349;
          }
          if (true) {
            _t3348 = undefined;
            break _t3349;
          }
          _match_fail("line 15950");
        }
        _t3348;
        if (_t3342) break;
      }
      _t3341 = _t3342 ? _t3343 : undefined;
      _t3341;
      let _t3351;
      if (_eq(Ref$get(from_vars_3339), null)) {
        _t3351 = Parser$error(p, "expected type variable(s) before '->'");
      } else {
        _t3351 = undefined;
      }
      _t3351;
      Parser$expect(p, ({_tag: 56, _name: "ARROW"}));
      const to_vars_3352 = Ref$create(null);
      let _t3354 = undefined;
      let _t3355 = false, _t3356;
      while (true) {
        let _t3358;
        const _t3357 = Parser$peek_kind(p);
        _t3359: {
          if (_t3357._tag === 10) {
            _t3358 = true;
            break _t3359;
          }
          if (true) {
            _t3358 = false;
            break _t3359;
          }
          _match_fail("line 15950");
        }
        if (!(_t3358)) break;
        let _t3361;
        const _t3360 = Parser$advance(p).kind;
        _t3362: {
          if (_t3360._tag === 10) {
            const s = _t3360._val;
            let _t3363;
            if ((!List$mem(s, tyvars_3328))) {
              _t3363 = Parser$error(p, (("functional dependency type variable '" + __dict_Show_string.show(s)) + " not in class parameters"));
            } else {
              _t3363 = undefined;
            }
            _t3363;
            _t3361 = Ref$set(to_vars_3352, ({_hd: s, _tl: Ref$get(to_vars_3352)}));
            break _t3362;
          }
          if (true) {
            _t3361 = undefined;
            break _t3362;
          }
          _match_fail("line 15950");
        }
        _t3361;
        if (_t3355) break;
      }
      _t3354 = _t3355 ? _t3356 : undefined;
      _t3354;
      let _t3364;
      if (_eq(Ref$get(to_vars_3352), null)) {
        _t3364 = Parser$error(p, "expected type variable(s) after '->'");
      } else {
        _t3364 = undefined;
      }
      _t3364;
      Ref$set(deps_3332, ({_hd: [List$rev(Ref$get(from_vars_3339)), List$rev(Ref$get(to_vars_3352))], _tl: Ref$get(deps_3332)}));
      let _t3365;
      if (_eq(Parser$peek_kind(p), ({_tag: 57, _name: "COMMA"}))) {
        Parser$advance(p);
        _t3365 = undefined;
      } else {
        _t3365 = Ref$set(continue__3334, false);
      }
      const _t3353 = _t3365;
      const _t3340 = _t3353;
      _t3340;
      if (_t3337) break;
    }
    _t3336 = _t3337 ? _t3338 : undefined;
    _t3336;
    const _t3335 = List$rev(Ref$get(deps_3332));
    const _t3333 = _t3335;
    _t3331 = _t3333;
  } else {
    _t3331 = null;
  }
  const fundeps_3366 = _t3331;
  Parser$expect(p, ({_tag: 73, _name: "EQ"}));
  const methods_3368 = Ref$create(null);
  let _t3370 = undefined;
  let _t3371 = false, _t3372;
  while (true) {
    if (!(!_eq(Parser$peek_kind(p), ({_tag: 45, _name: "END"})))) break;
    const s_3373 = Parser$expect_ident(p);
    Parser$expect(p, ({_tag: 60, _name: "COLON"}));
    const ty_3375 = Parser$parse_ty(p);
    Ref$set(methods_3368, ({_hd: [s_3373, ty_3375], _tl: Ref$get(methods_3368)}));
    let _t3377;
    if (_eq(Parser$peek_kind(p), ({_tag: 58, _name: "SEMICOLON"}))) {
      Parser$advance(p);
      _t3377 = undefined;
    } else {
      _t3377 = undefined;
    }
    const _t3376 = _t3377;
    const _t3374 = _t3376;
    _t3374;
    if (_t3371) break;
  }
  _t3370 = _t3371 ? _t3372 : undefined;
  _t3370;
  Parser$expect(p, ({_tag: 45, _name: "END"}));
  let _t3378;
  if (_eq(Ref$get(methods_3368), null)) {
    _t3378 = Parser$error(p, "class must have at least one method");
  } else {
    _t3378 = undefined;
  }
  _t3378;
  const _t3369 = ({_tag: 7, _name: "DClass", _val: [class_name_3315, tyvars_3328, fundeps_3366, List$rev(Ref$get(methods_3368))]});
  const _t3367 = _t3369;
  const _t3329 = _t3367;
  const _t3321 = _t3329;
  const _t3319 = _t3321;
  const _t3316 = _t3319;
  return _t3316;
}
function Parser$parse_instance_decl(p) {
  Parser$expect(p, ({_tag: 22, _name: "INSTANCE"}));
  const class_name_3379 = Parser$parse_class_name(p);
  const inst_tys_3381 = Ref$create(null);
  let _t3383 = undefined;
  let _t3384 = false, _t3385;
  while (true) {
    if (!((!_eq(Parser$peek_kind(p), ({_tag: 73, _name: "EQ"})) && !_eq(Parser$peek_kind(p), ({_tag: 36, _name: "WHERE"}))))) break;
    Ref$set(inst_tys_3381, ({_hd: Parser$parse_ty_atom(p), _tl: Ref$get(inst_tys_3381)}));
    if (_t3384) break;
  }
  _t3383 = _t3384 ? _t3385 : undefined;
  _t3383;
  const inst_tys_3386 = List$rev(Ref$get(inst_tys_3381));
  let _t3388;
  if (_eq(inst_tys_3386, null)) {
    _t3388 = Parser$error(p, "expected at least one instance type");
  } else {
    _t3388 = undefined;
  }
  _t3388;
  const constraints_3389 = Parser$parse_constraints(p);
  Parser$expect(p, ({_tag: 73, _name: "EQ"}));
  const methods_3391 = Ref$create(null);
  let _t3393 = undefined;
  let _t3394 = false, _t3395;
  while (true) {
    if (!(!_eq(Parser$peek_kind(p), ({_tag: 45, _name: "END"})))) break;
    Parser$expect(p, ({_tag: 11, _name: "LET"}));
    let _t3396;
    if (_eq(Parser$peek_kind(p), ({_tag: 50, _name: "LPAREN"}))) {
      Parser$advance(p);
      undefined;
      let _t3398;
      const _t3397 = Parser$peek_kind(p);
      _t3399: {
        if (_t3397._tag === 66) {
          _t3398 = "+";
          break _t3399;
        }
        if (_t3397._tag === 67) {
          _t3398 = "-";
          break _t3399;
        }
        if (_t3397._tag === 68) {
          _t3398 = "*";
          break _t3399;
        }
        if (_t3397._tag === 69) {
          _t3398 = "/";
          break _t3399;
        }
        if (_t3397._tag === 75) {
          _t3398 = "<";
          break _t3399;
        }
        if (_t3397._tag === 76) {
          _t3398 = ">";
          break _t3399;
        }
        if (_t3397._tag === 77) {
          _t3398 = "<=";
          break _t3399;
        }
        if (_t3397._tag === 78) {
          _t3398 = ">=";
          break _t3399;
        }
        if (_t3397._tag === 73) {
          _t3398 = "=";
          break _t3399;
        }
        if (_t3397._tag === 74) {
          _t3398 = "<>";
          break _t3399;
        }
        if (_t3397._tag === 81) {
          _t3398 = "land";
          break _t3399;
        }
        if (_t3397._tag === 82) {
          _t3398 = "lor";
          break _t3399;
        }
        if (_t3397._tag === 83) {
          _t3398 = "lxor";
          break _t3399;
        }
        if (_t3397._tag === 84) {
          _t3398 = "lnot";
          break _t3399;
        }
        if (_t3397._tag === 85) {
          _t3398 = "lsl";
          break _t3399;
        }
        if (_t3397._tag === 86) {
          _t3398 = "lsr";
          break _t3399;
        }
        if (true) {
          _t3398 = Parser$error(p, "expected operator");
          break _t3399;
        }
        _match_fail("line 15950");
      }
      const name_3400 = _t3398;
      Parser$advance(p);
      undefined;
      Parser$expect(p, ({_tag: 51, _name: "RPAREN"}));
      const _t3401 = name_3400;
      _t3396 = _t3401;
    } else {
      _t3396 = Parser$expect_ident(p);
    }
    const method_name_3402 = _t3396;
    const params_3404 = Ref$create(null);
    let _t3406 = undefined;
    let _t3407 = false, _t3408;
    while (true) {
      if (!((!_eq(Parser$peek_kind(p), ({_tag: 73, _name: "EQ"})) && (!_eq(Parser$peek_kind(p), ({_tag: 60, _name: "COLON"})) && !_eq(Parser$peek_kind(p), ({_tag: 36, _name: "WHERE"})))))) break;
      Ref$set(params_3404, ({_hd: Parser$parse_param(p), _tl: Ref$get(params_3404)}));
      if (_t3407) break;
    }
    _t3406 = _t3407 ? _t3408 : undefined;
    _t3406;
    let _t3409;
    if (_eq(Parser$peek_kind(p), ({_tag: 60, _name: "COLON"}))) {
      Parser$advance(p);
      undefined;
      _t3409 = ({_tag: 1, _name: "Some", _val: Parser$parse_ty(p)});
    } else {
      _t3409 = ({_tag: 0, _name: "None"});
    }
    const ret_annot_3410 = _t3409;
    const _constraints_3412 = Parser$parse_constraints(p);
    Parser$expect(p, ({_tag: 73, _name: "EQ"}));
    const body_3414 = Parser$parse_expr(p);
    const fun_params_3416 = List$rev(Ref$get(params_3404));
    function _t3418(body, fp) {
      let _t3420;
      const _t3419 = fp;
      _t3421: {
        if (_t3419._tag === 0) {
          _t3420 = body;
          break _t3421;
        }
        if (_t3419._tag === 1) {
          const name = _t3419._val[0];
          const pat = _t3419._val[1];
          _t3420 = ({_tag: 25, _name: "EMatch", _val: [({_tag: 7, _name: "EVar", _val: name}), ({_hd: [pat, ({_tag: 0, _name: "None"}), body], _tl: null}), true]});
          break _t3421;
        }
        _match_fail("line 15950");
      }
      return _t3420;
    }
    const body_3422 = List$fold(_t3418, body_3414, fun_params_3416);
    let _t3425;
    const _t3424 = ret_annot_3410;
    _t3426: {
      if (_t3424._tag === 1) {
        const ty = _t3424._val;
        _t3425 = ({_tag: 30, _name: "EAnnot", _val: [body_3422, ty]});
        break _t3426;
      }
      if (_t3424._tag === 0) {
        _t3425 = body_3422;
        break _t3426;
      }
      _match_fail("line 15950");
    }
    const body_3427 = _t3425;
    function _t3429(fp) {
      let _t3431;
      const _t3430 = fp;
      _t3432: {
        if (_t3430._tag === 0) {
          const param = _t3430._val;
          _t3431 = param;
          break _t3432;
        }
        if (_t3430._tag === 1) {
          const name = _t3430._val[0];
          const annot = _t3430._val[2];
          _t3431 = ({annot: annot, is_generated: true, name: name});
          break _t3432;
        }
        _match_fail("line 15950");
      }
      return _t3431;
    }
    const plain_params_3433 = List$map(_t3429, fun_params_3416);
    const _t3434 = Ref$set(methods_3391, ({_hd: [method_name_3402, plain_params_3433, body_3427], _tl: Ref$get(methods_3391)}));
    const _t3428 = _t3434;
    const _t3423 = _t3428;
    const _t3417 = _t3423;
    const _t3415 = _t3417;
    const _t3413 = _t3415;
    const _t3411 = _t3413;
    const _t3405 = _t3411;
    const _t3403 = _t3405;
    _t3403;
    if (_t3394) break;
  }
  _t3393 = _t3394 ? _t3395 : undefined;
  _t3393;
  Parser$expect(p, ({_tag: 45, _name: "END"}));
  let _t3435;
  if (_eq(Ref$get(methods_3391), null)) {
    _t3435 = Parser$error(p, "instance must implement at least one method");
  } else {
    _t3435 = undefined;
  }
  _t3435;
  const _t3392 = ({_tag: 8, _name: "DInstance", _val: [class_name_3379, inst_tys_3386, constraints_3389, List$rev(Ref$get(methods_3391))]});
  const _t3390 = _t3392;
  const _t3387 = _t3390;
  const _t3382 = _t3387;
  const _t3380 = _t3382;
  return _t3380;
}
function Parser$parse_effect_decl(p) {
  Parser$expect(p, ({_tag: 23, _name: "EFFECT"}));
  const name_3436 = Parser$parse_class_name(p);
  const type_params_3438 = Ref$create(null);
  let _t3440 = undefined;
  let _t3441 = false, _t3442;
  while (true) {
    let _t3444;
    const _t3443 = Parser$peek_kind(p);
    _t3445: {
      if (_t3443._tag === 10) {
        _t3444 = true;
        break _t3445;
      }
      if (true) {
        _t3444 = false;
        break _t3445;
      }
      _match_fail("line 15950");
    }
    if (!(_t3444)) break;
    let _t3447;
    const _t3446 = Parser$advance(p).kind;
    _t3448: {
      if (_t3446._tag === 10) {
        const s = _t3446._val;
        _t3447 = Ref$set(type_params_3438, ({_hd: s, _tl: Ref$get(type_params_3438)}));
        break _t3448;
      }
      if (true) {
        _t3447 = undefined;
        break _t3448;
      }
      _match_fail("line 15950");
    }
    _t3447;
    if (_t3441) break;
  }
  _t3440 = _t3441 ? _t3442 : undefined;
  _t3440;
  const type_params_3449 = List$rev(Ref$get(type_params_3438));
  Parser$expect(p, ({_tag: 73, _name: "EQ"}));
  const ops_3451 = Ref$create(null);
  let _t3453 = undefined;
  let _t3454 = false, _t3455;
  while (true) {
    if (!(!_eq(Parser$peek_kind(p), ({_tag: 45, _name: "END"})))) break;
    const s_3456 = Parser$expect_ident(p);
    Parser$expect(p, ({_tag: 60, _name: "COLON"}));
    const ty_3458 = Parser$parse_ty(p);
    Ref$set(ops_3451, ({_hd: [s_3456, ty_3458], _tl: Ref$get(ops_3451)}));
    let _t3460;
    if (_eq(Parser$peek_kind(p), ({_tag: 58, _name: "SEMICOLON"}))) {
      Parser$advance(p);
      _t3460 = undefined;
    } else {
      _t3460 = undefined;
    }
    const _t3459 = _t3460;
    const _t3457 = _t3459;
    _t3457;
    if (_t3454) break;
  }
  _t3453 = _t3454 ? _t3455 : undefined;
  _t3453;
  Parser$expect(p, ({_tag: 45, _name: "END"}));
  let _t3461;
  if (_eq(Ref$get(ops_3451), null)) {
    _t3461 = Parser$error(p, "effect must have at least one operation");
  } else {
    _t3461 = undefined;
  }
  _t3461;
  const _t3452 = ({_tag: 9, _name: "DEffect", _val: [name_3436, type_params_3449, List$rev(Ref$get(ops_3451))]});
  const _t3450 = _t3452;
  const _t3439 = _t3450;
  const _t3437 = _t3439;
  return _t3437;
}
function Parser$parse_extern_decl(p) {
  Parser$expect(p, ({_tag: 24, _name: "EXTERN"}));
  let _t3463;
  const _t3462 = Parser$peek_kind(p);
  _t3464: {
    if (_t3462._tag === 9) {
      const mod_name = _t3462._val;
      Parser$advance(p);
      undefined;
      Parser$expect(p, ({_tag: 61, _name: "DOT"}));
      const field_3465 = Parser$expect_ident(p);
      const _t3466 = (mod_name + ("." + field_3465));
      _t3463 = _t3466;
      break _t3464;
    }
    if (true) {
      _t3463 = Parser$expect_ident(p);
      break _t3464;
    }
    _match_fail("line 15950");
  }
  const name_3467 = _t3463;
  Parser$expect(p, ({_tag: 60, _name: "COLON"}));
  const ty_3469 = Parser$parse_ty(p);
  const _t3470 = ({_tag: 10, _name: "DExtern", _val: [name_3467, ty_3469]});
  const _t3468 = _t3470;
  return _t3468;
}
function Parser$parse_module_body_item(p) {
  let _t3472;
  const _t3471 = Parser$peek_kind(p);
  _t3473: {
    if (_t3471._tag === 43) {
      Parser$advance(p);
      undefined;
      const decls_3474 = Parser$parse_inner_decl(p);
      function _t3476(d) {
        return ({decl: d, vis: ({_tag: 0, _name: "Public"})});
      }
      const _t3475 = List$map(_t3476, decls_3474);
      _t3472 = _t3475;
      break _t3473;
    }
    if (_t3471._tag === 46) {
      Parser$advance(p);
      undefined;
      const decl_3477 = Parser$parse_type_decl(p);
      const _t3478 = ({_hd: ({decl: decl_3477, vis: ({_tag: 2, _name: "Opaque"})}), _tl: null});
      _t3472 = _t3478;
      break _t3473;
    }
    if (true) {
      const decls_3479 = Parser$parse_inner_decl(p);
      function _t3481(d) {
        return ({decl: d, vis: ({_tag: 1, _name: "Private"})});
      }
      const _t3480 = List$map(_t3481, decls_3479);
      _t3472 = _t3480;
      break _t3473;
    }
    _match_fail("line 15950");
  }
  return _t3472;
}
function Parser$parse_inner_decl(p) {
  let _t3483;
  const _t3482 = Parser$peek_kind(p);
  _t3484: {
    if (_t3482._tag === 19) {
      _t3483 = ({_hd: Parser$parse_type_decl(p), _tl: null});
      break _t3484;
    }
    if (_t3482._tag === 11) {
      _t3483 = Parser$parse_let_decl(p);
      break _t3484;
    }
    if (_t3482._tag === 21) {
      _t3483 = ({_hd: Parser$parse_class_decl(p), _tl: null});
      break _t3484;
    }
    if (_t3482._tag === 22) {
      _t3483 = ({_hd: Parser$parse_instance_decl(p), _tl: null});
      break _t3484;
    }
    if (_t3482._tag === 23) {
      _t3483 = ({_hd: Parser$parse_effect_decl(p), _tl: null});
      break _t3484;
    }
    if (_t3482._tag === 24) {
      _t3483 = ({_hd: Parser$parse_extern_decl(p), _tl: null});
      break _t3484;
    }
    if (_t3482._tag === 42) {
      _t3483 = ({_hd: Parser$parse_module_decl(p), _tl: null});
      break _t3484;
    }
    if (_t3482._tag === 44) {
      _t3483 = ({_hd: Parser$parse_open_decl(p), _tl: null});
      break _t3484;
    }
    if (true) {
      _t3483 = Parser$error(p, "expected declaration inside module");
      break _t3484;
    }
    _match_fail("line 15950");
  }
  return _t3483;
}
function Parser$parse_module_decl(p) {
  Parser$expect(p, ({_tag: 42, _name: "MODULE"}));
  const name_3485 = Parser$expect_uident(p);
  Parser$expect(p, ({_tag: 73, _name: "EQ"}));
  const items_3487 = Ref$create(null);
  let _t3489 = undefined;
  let _t3490 = false, _t3491;
  while (true) {
    if (!(!_eq(Parser$peek_kind(p), ({_tag: 45, _name: "END"})))) break;
    const module_items_3492 = Parser$parse_module_body_item(p);
    Ref$set(items_3487, List$rev_append(module_items_3492, Ref$get(items_3487)));
    let _t3494;
    if (_eq(Parser$peek_kind(p), ({_tag: 59, _name: "DOUBLE_SEMICOLON"}))) {
      Parser$advance(p);
      _t3494 = undefined;
    } else {
      _t3494 = undefined;
    }
    const _t3493 = _t3494;
    _t3493;
    if (_t3490) break;
  }
  _t3489 = _t3490 ? _t3491 : undefined;
  _t3489;
  Parser$expect(p, ({_tag: 45, _name: "END"}));
  const _t3488 = ({_tag: 11, _name: "DModule", _val: [name_3485, List$rev(Ref$get(items_3487))]});
  const _t3486 = _t3488;
  return _t3486;
}
function Parser$parse_open_decl(p) {
  Parser$expect(p, ({_tag: 44, _name: "OPEN"}));
  const name_3495 = Parser$expect_uident(p);
  let _t3497;
  if (_eq(Parser$peek_kind(p), ({_tag: 50, _name: "LPAREN"}))) {
    Parser$advance(p);
    undefined;
    const names_3498 = Ref$create(null);
    const first_3500 = Ref$create(true);
    let _t3502 = undefined;
    let _t3503 = false, _t3504;
    while (true) {
      if (!(!_eq(Parser$peek_kind(p), ({_tag: 51, _name: "RPAREN"})))) break;
      let _t3505;
      if ((!Ref$get(first_3500))) {
        _t3505 = Parser$expect(p, ({_tag: 57, _name: "COMMA"}));
      } else {
        _t3505 = undefined;
      }
      _t3505;
      Ref$set(first_3500, false);
      const n_3506 = Parser$expect_ident(p);
      const _t3507 = Ref$set(names_3498, ({_hd: n_3506, _tl: Ref$get(names_3498)}));
      _t3507;
      if (_t3503) break;
    }
    _t3502 = _t3503 ? _t3504 : undefined;
    _t3502;
    Parser$expect(p, ({_tag: 51, _name: "RPAREN"}));
    const _t3501 = ({_tag: 12, _name: "DOpen", _val: [name_3495, ({_tag: 1, _name: "Some", _val: List$rev(Ref$get(names_3498))})]});
    const _t3499 = _t3501;
    _t3497 = _t3499;
  } else {
    _t3497 = ({_tag: 12, _name: "DOpen", _val: [name_3495, ({_tag: 0, _name: "None"})]});
  }
  const _t3496 = _t3497;
  return _t3496;
}
function Parser$parse_decl(p) {
  let _t3509;
  const _t3508 = Parser$peek_kind(p);
  _t3510: {
    if (_t3508._tag === 19) {
      _t3509 = ({_hd: Parser$parse_type_decl(p), _tl: null});
      break _t3510;
    }
    if (_t3508._tag === 11) {
      _t3509 = Parser$parse_let_decl(p);
      break _t3510;
    }
    if (_t3508._tag === 21) {
      _t3509 = ({_hd: Parser$parse_class_decl(p), _tl: null});
      break _t3510;
    }
    if (_t3508._tag === 22) {
      _t3509 = ({_hd: Parser$parse_instance_decl(p), _tl: null});
      break _t3510;
    }
    if (_t3508._tag === 23) {
      _t3509 = ({_hd: Parser$parse_effect_decl(p), _tl: null});
      break _t3510;
    }
    if (_t3508._tag === 24) {
      _t3509 = ({_hd: Parser$parse_extern_decl(p), _tl: null});
      break _t3510;
    }
    if (_t3508._tag === 42) {
      _t3509 = ({_hd: Parser$parse_module_decl(p), _tl: null});
      break _t3510;
    }
    if (_t3508._tag === 44) {
      _t3509 = ({_hd: Parser$parse_open_decl(p), _tl: null});
      break _t3510;
    }
    if (true) {
      const expr_3511 = Parser$parse_expr(p);
      const _t3512 = ({_hd: ({_tag: 6, _name: "DExpr", _val: expr_3511}), _tl: null});
      _t3509 = _t3512;
      break _t3510;
    }
    _match_fail("line 15950");
  }
  return _t3509;
}
function Parser$parse_program(tokens) {
  const p_3513 = Parser$create(tokens);
  const decls_3515 = Ref$create(null);
  let _t3517 = undefined;
  let _t3518 = false, _t3519;
  while (true) {
    if (!(!_eq(Parser$peek_kind(p_3513), ({_tag: 89, _name: "EOF"})))) break;
    const ds_3520 = Parser$parse_decl(p_3513);
    Ref$set(decls_3515, List$rev_append(ds_3520, Ref$get(decls_3515)));
    let _t3522;
    if (_eq(Parser$peek_kind(p_3513), ({_tag: 59, _name: "DOUBLE_SEMICOLON"}))) {
      Parser$advance(p_3513);
      _t3522 = undefined;
    } else {
      _t3522 = undefined;
    }
    const _t3521 = _t3522;
    _t3521;
    if (_t3518) break;
  }
  _t3517 = _t3518 ? _t3519 : undefined;
  _t3517;
  const _t3516 = List$rev(Ref$get(decls_3515));
  const _t3514 = _t3516;
  return _t3514;
}
function Parser$parse_expr_string(tokens) {
  const p_3523 = Parser$create(tokens);
  const _t3524 = Parser$parse_expr(p_3523);
  return _t3524;
}
const Typechecker$current_loc = Ref$create(({col: 0, line: 0, offset: 0}));
function Typechecker$error(msg) {
  return _trampoline(function() {
    return _h["type_error"]([msg, Ref$get(Typechecker$current_loc)], function(_t3525) {
      return _bounce(function() {
        return _t3525;
      });
    });
  }, Typechecker$error);
}
function Typechecker$strip_loc(expr) {
  while (true) {
    let _t3527;
    const _t3526 = expr;
    _t3528: {
      if (_t3526._tag === 49) {
        const inner = _t3526._val[1];
        const _t3529 = inner;
        expr = _t3529;
        continue;
        _t3527 = undefined;
        break _t3528;
      }
      if (true) {
        const e = _t3526;
        _t3527 = e;
        break _t3528;
      }
      _match_fail("line 15950");
    }
    return _t3527;
  }
}
function Typechecker$try_unify(t1, t2) {
  const _t3530 = (function() {
    const _t3531 = _h;
    _h = Object.assign({}, _t3531, {
      "unify_error": function(msg, __k) { throw {_e: "unify_error", _v: msg}; },
    });
    try {
      const __x_3532 = Types$unify(t1, t2);
      return __x_3532;
    } catch (_exc) {
      if (_exc && _exc._e === "unify_error") {
        const msg = _exc._v;
        return Typechecker$error(msg);
      } else { throw _exc; }
    } finally { _h = _t3531; }
  })();
  return _t3530;
}
function Typechecker$try_unify_eff(e1, e2) {
  const _t3533 = (function() {
    const _t3534 = _h;
    _h = Object.assign({}, _t3534, {
      "unify_error": function(msg, __k) { throw {_e: "unify_error", _v: msg}; },
    });
    try {
      const __x_3535 = Types$unify_eff(e1, e2);
      return __x_3535;
    } catch (_exc) {
      if (_exc && _exc._e === "unify_error") {
        const msg = _exc._v;
        return Typechecker$error(msg);
      } else { throw _exc; }
    } finally { _h = _t3534; }
  })();
  return _t3533;
}
function Typechecker$try_subeffect(source, target) {
  const _t3536 = (function() {
    const _t3537 = _h;
    _h = Object.assign({}, _t3537, {
      "unify_error": function(msg, __k) { throw {_e: "unify_error", _v: msg}; },
    });
    try {
      const __x_3538 = Types$subeffect(source, target);
      return __x_3538;
    } catch (_exc) {
      if (_exc && _exc._e === "unify_error") {
        const msg = _exc._v;
        return Typechecker$error(msg);
      } else { throw _exc; }
    } finally { _h = _t3537; }
  })();
  return _t3536;
}
function Typechecker$max_tgen_in_ty(__x) {
  while (true) {
    let _t3540;
    const _t3539 = __x;
    _t3541: {
      if (_t3539._tag === 17) {
        const i = _t3539._val;
        _t3540 = i;
        break _t3541;
      }
      if ((_t3539._tag === 7 || _t3539._tag === 8)) {
        const a = _t3539._val[0];
        const b = _t3539._val[2];
        _t3540 = max(Typechecker$max_tgen_in_ty(a), Typechecker$max_tgen_in_ty(b));
        break _t3541;
      }
      if (_t3539._tag === 9) {
        const ts = _t3539._val;
        function _t3542(acc, t) {
          return max(acc, Typechecker$max_tgen_in_ty(t));
        }
        _t3540 = List$fold(_t3542, (-1), ts);
        break _t3541;
      }
      if (_t3539._tag === 10) {
        const t = _t3539._val;
        const _t3543 = t;
        __x = _t3543;
        continue;
        _t3540 = undefined;
        break _t3541;
      }
      if (_t3539._tag === 11) {
        const row = _t3539._val;
        _t3540 = Typechecker$max_tgen_in_rrow(row);
        break _t3541;
      }
      if (_t3539._tag === 12) {
        const args = _t3539._val[1];
        function _t3544(acc, t) {
          return max(acc, Typechecker$max_tgen_in_ty(t));
        }
        _t3540 = List$fold(_t3544, (-1), args);
        break _t3541;
      }
      if (_t3539._tag === 13) {
        const k = _t3539._val[0];
        const v = _t3539._val[1];
        _t3540 = max(Typechecker$max_tgen_in_ty(k), Typechecker$max_tgen_in_ty(v));
        break _t3541;
      }
      if (_t3539._tag === 14) {
        const t = _t3539._val;
        const _t3545 = t;
        __x = _t3545;
        continue;
        _t3540 = undefined;
        break _t3541;
      }
      if (true) {
        _t3540 = (-1);
        break _t3541;
      }
      _match_fail("line 15950");
    }
    return _t3540;
  }
}
function Typechecker$max_tgen_in_rrow(__x) {
  let _t3547;
  const _t3546 = __x;
  _t3548: {
    if (_t3546._tag === 0) {
      const ty = _t3546._val[1];
      const tail = _t3546._val[2];
      _t3547 = max(Typechecker$max_tgen_in_ty(ty), Typechecker$max_tgen_in_rrow(tail));
      break _t3548;
    }
    if (_t3546._tag === 3) {
      _t3547 = (-1);
      break _t3548;
    }
    if (true) {
      _t3547 = (-1);
      break _t3548;
    }
    _match_fail("line 15950");
  }
  return _t3547;
}
function Typechecker$max_effgen_in_eff(__x) {
  let _t3550;
  const _t3549 = __x;
  _t3551: {
    if (_t3549._tag === 3) {
      const i = _t3549._val;
      _t3550 = i;
      break _t3551;
    }
    if (_t3549._tag === 2) {
      const params = _t3549._val[1];
      const tail = _t3549._val[2];
      function _t3552(acc, t) {
        return max(acc, Typechecker$max_tgen_in_ty(t));
      }
      const ty_max_3553 = List$fold(_t3552, (-1), params);
      const _t3554 = max(ty_max_3553, Typechecker$max_effgen_in_eff(tail));
      _t3550 = _t3554;
      break _t3551;
    }
    if (true) {
      _t3550 = (-1);
      break _t3551;
    }
    _match_fail("line 15950");
  }
  return _t3550;
}
function Typechecker$max_effgen_in_ty(__x) {
  let _t3556;
  const _t3555 = __x;
  _t3557: {
    if ((_t3555._tag === 7 || _t3555._tag === 8)) {
      const a = _t3555._val[0];
      const eff = _t3555._val[1];
      const b = _t3555._val[2];
      _t3556 = max(max(Typechecker$max_tgen_in_ty(a), Typechecker$max_tgen_in_ty(b)), Typechecker$max_effgen_in_eff(eff));
      break _t3557;
    }
    if (true) {
      _t3556 = (-1);
      break _t3557;
    }
    _match_fail("line 15950");
  }
  return _t3556;
}
function Typechecker$lookup_var(ctx, level, name) {
  let _t3559;
  const _t3558 = List$assoc_opt(name, ctx.vars);
  _t3560: {
    if (_t3558._tag === 1) {
      const scheme = _t3558._val;
      _t3559 = Types$instantiate(level, scheme);
      break _t3560;
    }
    if (_t3558._tag === 0) {
      let _t3562;
      const _t3561 = String$rindex_opt(name, 46);
      _t3563: {
        if (_t3561._tag === 1) {
          const i = _t3561._val;
          const class_prefix_3564 = String$sub(name, 0, i);
          const method_name_3566 = String$sub(name, (i + 1), ((String$length(name) - i) - 1));
          function _t3568(cls) {
            let _t3573;
            if ((cls.class_name === class_prefix_3564)) {
            function _t3569(__p35) {
              let _t3571;
              const _t3570 = __p35;
              _t3572: {
                if (true) {
                  const m = _t3570[0];
                  _t3571 = (m === method_name_3566);
                  break _t3572;
                }
                _match_fail("line 15950");
              }
              return _t3571;
            }
              _t3573 = List$exists(_t3569, cls.class_methods);
            } else {
              _t3573 = false;
            }
            return _t3573;
          }
          let _t3575;
          const _t3574 = List$find(_t3568, ctx.type_env.classes);
          _t3576: {
            if (_t3574._tag === 1) {
              const class_def = _t3574._val;
              const method_ty_3577 = List$assoc(method_name_3566, class_def.class_methods);
              const num_class_params_3579 = List$length(class_def.class_params);
              const max_gen_3581 = Typechecker$max_tgen_in_ty(method_ty_3577);
              const quant_3583 = max((max_gen_3581 + 1), num_class_params_3579);
              const max_effgen_3585 = Typechecker$max_effgen_in_ty(method_ty_3577);
              let _t3587;
              if ((max_effgen_3585 >= 0)) {
                _t3587 = (max_effgen_3585 + 1);
              } else {
                _t3587 = 0;
              }
              const equant_3588 = _t3587;
              const scheme_3590 = ({body: method_ty_3577, constraints: null, equant: equant_3588, pvquant: 0, quant: quant_3583, record_evidences: null, rquant: 0});
              const _t3591 = Types$instantiate(level, scheme_3590);
              const _t3589 = _t3591;
              const _t3586 = _t3589;
              const _t3584 = _t3586;
              const _t3582 = _t3584;
              const _t3580 = _t3582;
              const _t3578 = _t3580;
              _t3575 = _t3578;
              break _t3576;
            }
            if (_t3574._tag === 0) {
              _t3575 = Typechecker$error(("unbound variable: " + __dict_Show_string.show(name)));
              break _t3576;
            }
            _match_fail("line 15950");
          }
          const _t3567 = _t3575;
          const _t3565 = _t3567;
          _t3562 = _t3565;
          break _t3563;
        }
        if (_t3561._tag === 0) {
          _t3562 = Typechecker$error(("unbound variable: " + __dict_Show_string.show(name)));
          break _t3563;
        }
        _match_fail("line 15950");
      }
      _t3559 = _t3562;
      break _t3560;
    }
    _match_fail("line 15950");
  }
  return _t3559;
}
function Typechecker$extend_var(ctx, name, scheme) {
  const __rec_upd_3592 = ctx;
  function _t3594(n) {
    return (n !== name);
  }
  const _t3593 = ({constraint_tvars: __rec_upd_3592.constraint_tvars, current_eff: __rec_upd_3592.current_eff, current_module: __rec_upd_3592.current_module, inside_handler: __rec_upd_3592.inside_handler, loop_info: __rec_upd_3592.loop_info, mutable_vars: List$filter(_t3594, ctx.mutable_vars), return_type: __rec_upd_3592.return_type, return_used: __rec_upd_3592.return_used, type_env: __rec_upd_3592.type_env, vars: ({_hd: [name, scheme], _tl: ctx.vars})});
  return _t3593;
}
function Typechecker$extend_var_mono(ctx, name, ty) {
  return Typechecker$extend_var(ctx, name, Types$mono(ty));
}
function Typechecker$extend_var_mutable(ctx, name, scheme) {
  const __rec_upd_3595 = ctx;
  function _t3597(n) {
    return (n !== name);
  }
  const _t3596 = ({constraint_tvars: __rec_upd_3595.constraint_tvars, current_eff: __rec_upd_3595.current_eff, current_module: __rec_upd_3595.current_module, inside_handler: __rec_upd_3595.inside_handler, loop_info: __rec_upd_3595.loop_info, mutable_vars: ({_hd: name, _tl: List$filter(_t3597, ctx.mutable_vars)}), return_type: __rec_upd_3595.return_type, return_used: __rec_upd_3595.return_used, type_env: __rec_upd_3595.type_env, vars: ({_hd: [name, scheme], _tl: ctx.vars})});
  return _t3596;
}
function Typechecker$resolve_type_alias(type_env, name) {
  let _t3599;
  const _t3598 = List$assoc_opt(name, type_env.type_aliases);
  _t3600: {
    if (_t3598._tag === 1) {
      const canonical = _t3598._val;
      _t3599 = canonical;
      break _t3600;
    }
    if (_t3598._tag === 0) {
      _t3599 = name;
      break _t3600;
    }
    _match_fail("line 15950");
  }
  return _t3599;
}
function Typechecker$find_variant_info(type_env, name) {
  const name_3601 = Typechecker$resolve_type_alias(type_env, name);
  function _t3603(__p36) {
    let _t3605;
    const _t3604 = __p36;
    _t3606: {
      if (true) {
        const n = _t3604[0];
        _t3605 = (n === name_3601);
        break _t3606;
      }
      _match_fail("line 15950");
    }
    return _t3605;
  }
  const _t3602 = List$find(_t3603, type_env.variants);
  return _t3602;
}
function Typechecker$subst_tgens(inst_tys, ty) {
  const arr_3607 = Array$of_list(inst_tys);
  function go(__x) {
    let _t3610;
    const _t3609 = __x;
    _t3611: {
      if (_t3609._tag === 17) {
        const i = _t3609._val;
        if ((i < Array$length(arr_3607))) {
          _t3610 = Array$get(arr_3607, i);
          break _t3611;
        }
      }
      if (_t3609._tag === 7) {
        const a = _t3609._val[0];
        const eff = _t3609._val[1];
        const b = _t3609._val[2];
        _t3610 = ({_tag: 7, _name: "TArrow", _val: [go(a), go_eff(eff), go(b)]});
        break _t3611;
      }
      if (_t3609._tag === 8) {
        const a = _t3609._val[0];
        const eff = _t3609._val[1];
        const b = _t3609._val[2];
        _t3610 = ({_tag: 8, _name: "TCont", _val: [go(a), go_eff(eff), go(b)]});
        break _t3611;
      }
      if (_t3609._tag === 9) {
        const ts = _t3609._val;
        _t3610 = ({_tag: 9, _name: "TTuple", _val: List$map(go, ts)});
        break _t3611;
      }
      if (_t3609._tag === 10) {
        const t = _t3609._val;
        _t3610 = ({_tag: 10, _name: "TList", _val: go(t)});
        break _t3611;
      }
      if (_t3609._tag === 14) {
        const t = _t3609._val;
        _t3610 = ({_tag: 14, _name: "TArray", _val: go(t)});
        break _t3611;
      }
      if (_t3609._tag === 11) {
        const row = _t3609._val;
        _t3610 = ({_tag: 11, _name: "TRecord", _val: go_rrow(row)});
        break _t3611;
      }
      if (_t3609._tag === 12) {
        const name = _t3609._val[0];
        const args = _t3609._val[1];
        _t3610 = ({_tag: 12, _name: "TVariant", _val: [name, List$map(go, args)]});
        break _t3611;
      }
      if (_t3609._tag === 15) {
        const row = _t3609._val;
        _t3610 = ({_tag: 15, _name: "TPolyVariant", _val: go_pv(row)});
        break _t3611;
      }
      if (_t3609._tag === 13) {
        const k = _t3609._val[0];
        const v = _t3609._val[1];
        _t3610 = ({_tag: 13, _name: "TMap", _val: [go(k), go(v)]});
        break _t3611;
      }
      if (true) {
        const t = _t3609;
        _t3610 = t;
        break _t3611;
      }
      _match_fail("line 15950");
    }
    return _t3610;
  }
  function go_eff(__x) {
    let _t3613;
    const _t3612 = __x;
    _t3614: {
      if (_t3612._tag === 2) {
        const label = _t3612._val[0];
        const params = _t3612._val[1];
        const tail = _t3612._val[2];
        _t3613 = ({_tag: 2, _name: "EffRow", _val: [label, List$map(go, params), go_eff(tail)]});
        break _t3614;
      }
      if (true) {
        const e = _t3612;
        _t3613 = e;
        break _t3614;
      }
      _match_fail("line 15950");
    }
    return _t3613;
  }
  function go_pv(__x) {
    let _t3616;
    const _t3615 = __x;
    _t3617: {
      if (_t3615._tag === 0) {
        const tag = _t3615._val[0];
        const ty_opt = _t3615._val[1];
        const tail = _t3615._val[2];
        _t3616 = ({_tag: 0, _name: "PVRow", _val: [tag, Option$map(go, ty_opt), go_pv(tail)]});
        break _t3617;
      }
      if (true) {
        const r = _t3615;
        _t3616 = r;
        break _t3617;
      }
      _match_fail("line 15950");
    }
    return _t3616;
  }
  function go_rrow(__x) {
    let _t3619;
    const _t3618 = __x;
    _t3620: {
      if (_t3618._tag === 0) {
        const name = _t3618._val[0];
        const ty = _t3618._val[1];
        const tail = _t3618._val[2];
        _t3619 = ({_tag: 0, _name: "RRow", _val: [name, go(ty), go_rrow(tail)]});
        break _t3620;
      }
      if (true) {
        const r = _t3618;
        _t3619 = r;
        break _t3620;
      }
      _match_fail("line 15950");
    }
    return _t3619;
  }
  const _t3621 = go(ty);
  const _t3608 = _t3621;
  return _t3608;
}
function Typechecker$freshen_arrow_effects(level, ty) {
  function go(__x) {
    let _t3623;
    const _t3622 = __x;
    _t3624: {
      if (_t3622._tag === 7) {
        const a = _t3622._val[0];
        const eff = _t3622._val[1];
        const b = _t3622._val[2];
        let _t3626;
        const _t3625 = eff;
        _t3627: {
          if (_t3625._tag === 1) {
            _t3626 = Types$new_effvar(level);
            break _t3627;
          }
          if (true) {
            const e = _t3625;
            _t3626 = e;
            break _t3627;
          }
          _match_fail("line 15950");
        }
        const eff$p_3628 = _t3626;
        const _t3629 = ({_tag: 7, _name: "TArrow", _val: [go(a), eff$p_3628, go(b)]});
        _t3623 = _t3629;
        break _t3624;
      }
      if (_t3622._tag === 8) {
        const a = _t3622._val[0];
        const eff = _t3622._val[1];
        const b = _t3622._val[2];
        let _t3631;
        const _t3630 = eff;
        _t3632: {
          if (_t3630._tag === 1) {
            _t3631 = Types$new_effvar(level);
            break _t3632;
          }
          if (true) {
            const e = _t3630;
            _t3631 = e;
            break _t3632;
          }
          _match_fail("line 15950");
        }
        const eff$p_3633 = _t3631;
        const _t3634 = ({_tag: 8, _name: "TCont", _val: [go(a), eff$p_3633, go(b)]});
        _t3623 = _t3634;
        break _t3624;
      }
      if (_t3622._tag === 9) {
        const ts = _t3622._val;
        _t3623 = ({_tag: 9, _name: "TTuple", _val: List$map(go, ts)});
        break _t3624;
      }
      if (_t3622._tag === 10) {
        const t = _t3622._val;
        _t3623 = ({_tag: 10, _name: "TList", _val: go(t)});
        break _t3624;
      }
      if (_t3622._tag === 14) {
        const t = _t3622._val;
        _t3623 = ({_tag: 14, _name: "TArray", _val: go(t)});
        break _t3624;
      }
      if (_t3622._tag === 11) {
        const row = _t3622._val;
        _t3623 = ({_tag: 11, _name: "TRecord", _val: go_rrow(row)});
        break _t3624;
      }
      if (_t3622._tag === 12) {
        const name = _t3622._val[0];
        const args = _t3622._val[1];
        _t3623 = ({_tag: 12, _name: "TVariant", _val: [name, List$map(go, args)]});
        break _t3624;
      }
      if (_t3622._tag === 15) {
        const row = _t3622._val;
        _t3623 = ({_tag: 15, _name: "TPolyVariant", _val: go_pv(row)});
        break _t3624;
      }
      if (_t3622._tag === 13) {
        const k = _t3622._val[0];
        const v = _t3622._val[1];
        _t3623 = ({_tag: 13, _name: "TMap", _val: [go(k), go(v)]});
        break _t3624;
      }
      if (true) {
        const t = _t3622;
        _t3623 = t;
        break _t3624;
      }
      _match_fail("line 15950");
    }
    return _t3623;
  }
  function go_pv(__x) {
    let _t3636;
    const _t3635 = __x;
    _t3637: {
      if (_t3635._tag === 0) {
        const tag = _t3635._val[0];
        const ty_opt = _t3635._val[1];
        const tail = _t3635._val[2];
        _t3636 = ({_tag: 0, _name: "PVRow", _val: [tag, Option$map(go, ty_opt), go_pv(tail)]});
        break _t3637;
      }
      if (true) {
        const r = _t3635;
        _t3636 = r;
        break _t3637;
      }
      _match_fail("line 15950");
    }
    return _t3636;
  }
  function go_rrow(__x) {
    let _t3639;
    const _t3638 = __x;
    _t3640: {
      if (_t3638._tag === 0) {
        const name = _t3638._val[0];
        const ty = _t3638._val[1];
        const tail = _t3638._val[2];
        _t3639 = ({_tag: 0, _name: "RRow", _val: [name, go(ty), go_rrow(tail)]});
        break _t3640;
      }
      if (true) {
        const r = _t3638;
        _t3639 = r;
        break _t3640;
      }
      _match_fail("line 15950");
    }
    return _t3639;
  }
  const _t3641 = go(ty);
  return _t3641;
}
function Typechecker$freshen_tvars(level, ty) {
  const mapping_3642 = Hashtbl$create(4);
  function go(__x) {
    while (true) {
      let _t3645;
      const _t3644 = __x;
      _t3646: {
        if (_t3644._tag === 16 && _t3644._val.contents._tag === 0) {
          const id = _t3644._val.contents._val[0];
          let _t3648;
          const _t3647 = _call(Hashtbl$get, [__dict_Hash_int, __dict_Eq_int, mapping_3642, id]);
          _t3649: {
            if (_t3647._tag === 1) {
              const fresh = _t3647._val;
              _t3648 = fresh;
              break _t3649;
            }
            if (_t3647._tag === 0) {
              const fresh_3650 = Types$new_tvar(level);
              _call(Hashtbl$set, [__dict_Hash_int, __dict_Eq_int, mapping_3642, id, fresh_3650]);
              const _t3651 = fresh_3650;
              _t3648 = _t3651;
              break _t3649;
            }
            _match_fail("line 15950");
          }
          _t3645 = _t3648;
          break _t3646;
        }
        if (_t3644._tag === 16 && _t3644._val.contents._tag === 1) {
          const t = _t3644._val.contents._val;
          const _t3652 = t;
          __x = _t3652;
          continue;
          _t3645 = undefined;
          break _t3646;
        }
        if (_t3644._tag === 7) {
          const a = _t3644._val[0];
          const eff = _t3644._val[1];
          const b = _t3644._val[2];
          _t3645 = ({_tag: 7, _name: "TArrow", _val: [go(a), go_eff(eff), go(b)]});
          break _t3646;
        }
        if (_t3644._tag === 8) {
          const a = _t3644._val[0];
          const eff = _t3644._val[1];
          const b = _t3644._val[2];
          _t3645 = ({_tag: 8, _name: "TCont", _val: [go(a), go_eff(eff), go(b)]});
          break _t3646;
        }
        if (_t3644._tag === 9) {
          const ts = _t3644._val;
          _t3645 = ({_tag: 9, _name: "TTuple", _val: List$map(go, ts)});
          break _t3646;
        }
        if (_t3644._tag === 10) {
          const t = _t3644._val;
          _t3645 = ({_tag: 10, _name: "TList", _val: go(t)});
          break _t3646;
        }
        if (_t3644._tag === 14) {
          const t = _t3644._val;
          _t3645 = ({_tag: 14, _name: "TArray", _val: go(t)});
          break _t3646;
        }
        if (_t3644._tag === 11) {
          const row = _t3644._val;
          _t3645 = ({_tag: 11, _name: "TRecord", _val: go_rrow(row)});
          break _t3646;
        }
        if (_t3644._tag === 12) {
          const name = _t3644._val[0];
          const args = _t3644._val[1];
          _t3645 = ({_tag: 12, _name: "TVariant", _val: [name, List$map(go, args)]});
          break _t3646;
        }
        if (_t3644._tag === 15) {
          const row = _t3644._val;
          _t3645 = ({_tag: 15, _name: "TPolyVariant", _val: go_pv(row)});
          break _t3646;
        }
        if (_t3644._tag === 13) {
          const k = _t3644._val[0];
          const v = _t3644._val[1];
          _t3645 = ({_tag: 13, _name: "TMap", _val: [go(k), go(v)]});
          break _t3646;
        }
        if (true) {
          const t = _t3644;
          _t3645 = t;
          break _t3646;
        }
        _match_fail("line 15950");
      }
      return _t3645;
    }
  }
  function go_eff(__x) {
    while (true) {
      let _t3654;
      const _t3653 = __x;
      _t3655: {
        if (_t3653._tag === 0 && _t3653._val.contents._tag === 0) {
          const e = _t3653;
          _t3654 = e;
          break _t3655;
        }
        if (_t3653._tag === 0 && _t3653._val.contents._tag === 1) {
          const e = _t3653._val.contents._val;
          const _t3656 = e;
          __x = _t3656;
          continue;
          _t3654 = undefined;
          break _t3655;
        }
        if (_t3653._tag === 2) {
          const label = _t3653._val[0];
          const params = _t3653._val[1];
          const tail = _t3653._val[2];
          _t3654 = ({_tag: 2, _name: "EffRow", _val: [label, List$map(go, params), go_eff(tail)]});
          break _t3655;
        }
        if (true) {
          const e = _t3653;
          _t3654 = e;
          break _t3655;
        }
        _match_fail("line 15950");
      }
      return _t3654;
    }
  }
  function go_pv(__x) {
    let _t3658;
    const _t3657 = __x;
    _t3659: {
      if (_t3657._tag === 0) {
        const tag = _t3657._val[0];
        const ty_opt = _t3657._val[1];
        const tail = _t3657._val[2];
        _t3658 = ({_tag: 0, _name: "PVRow", _val: [tag, Option$map(go, ty_opt), go_pv(tail)]});
        break _t3659;
      }
      if (true) {
        const r = _t3657;
        _t3658 = r;
        break _t3659;
      }
      _match_fail("line 15950");
    }
    return _t3658;
  }
  function go_rrow(__x) {
    while (true) {
      let _t3661;
      const _t3660 = __x;
      _t3662: {
        if (_t3660._tag === 0) {
          const name = _t3660._val[0];
          const ty = _t3660._val[1];
          const tail = _t3660._val[2];
          _t3661 = ({_tag: 0, _name: "RRow", _val: [name, go(ty), go_rrow(tail)]});
          break _t3662;
        }
        if (_t3660._tag === 1 && _t3660._val.contents._tag === 0) {
          _t3661 = Types$new_rvar(level);
          break _t3662;
        }
        if (_t3660._tag === 1 && _t3660._val.contents._tag === 1) {
          const r = _t3660._val.contents._val;
          const _t3663 = r;
          __x = _t3663;
          continue;
          _t3661 = undefined;
          break _t3662;
        }
        if (true) {
          const r = _t3660;
          _t3661 = r;
          break _t3662;
        }
        _match_fail("line 15950");
      }
      return _t3661;
    }
  }
  const _t3664 = go(ty);
  const _t3643 = _t3664;
  return _t3643;
}
function Typechecker$resolve_ty_annot_shared(ctx, level, tvars, annot) {
  function go(__x) {
    while (true) {
      let _t3666;
      const _t3665 = __x;
      _t3667: {
        if (_t3665._tag === 1) {
          const name = _t3665._val;
          let _t3669;
          const _t3668 = _call(Hashtbl$get, [__dict_Hash_string, __dict_Eq_string, tvars, name]);
          _t3670: {
            if (_t3668._tag === 1) {
              const tv = _t3668._val;
              _t3669 = tv;
              break _t3670;
            }
            if (_t3668._tag === 0) {
              const tv_3671 = Types$new_tvar(level);
              _call(Hashtbl$set, [__dict_Hash_string, __dict_Eq_string, tvars, name, tv_3671]);
              const _t3672 = tv_3671;
              _t3669 = _t3672;
              break _t3670;
            }
            _match_fail("line 15950");
          }
          _t3666 = _t3669;
          break _t3667;
        }
        if (_t3665._tag === 0 && _t3665._val === "int") {
          _t3666 = ({_tag: 0, _name: "TInt"});
          break _t3667;
        }
        if (_t3665._tag === 0 && _t3665._val === "float") {
          _t3666 = ({_tag: 1, _name: "TFloat"});
          break _t3667;
        }
        if (_t3665._tag === 0 && _t3665._val === "bool") {
          _t3666 = ({_tag: 2, _name: "TBool"});
          break _t3667;
        }
        if (_t3665._tag === 0 && _t3665._val === "string") {
          _t3666 = ({_tag: 3, _name: "TString"});
          break _t3667;
        }
        if (_t3665._tag === 0 && _t3665._val === "byte") {
          _t3666 = ({_tag: 4, _name: "TByte"});
          break _t3667;
        }
        if (_t3665._tag === 0 && _t3665._val === "rune") {
          _t3666 = ({_tag: 5, _name: "TRune"});
          break _t3667;
        }
        if (_t3665._tag === 0 && _t3665._val === "unit") {
          _t3666 = ({_tag: 6, _name: "TUnit"});
          break _t3667;
        }
        if (_t3665._tag === 0) {
          const name = _t3665._val;
          const canonical_3673 = Typechecker$resolve_type_alias(ctx.type_env, name);
          function _t3675(__p37) {
            let _t3677;
            const _t3676 = __p37;
            _t3678: {
              if (true) {
                const n = _t3676[0];
                _t3677 = (n === canonical_3673);
                break _t3678;
              }
              _match_fail("line 15950");
            }
            return _t3677;
          }
          let _t3680;
          const _t3679 = List$find(_t3675, ctx.type_env.type_synonyms);
          _t3681: {
            if (_t3679._tag === 1 && _t3679._val[1] === 0) {
              const ty = _t3679._val[2];
              _t3680 = Typechecker$freshen_tvars(level, Typechecker$freshen_arrow_effects(level, ty));
              break _t3681;
            }
            if (_t3679._tag === 1) {
              const n = _t3679._val[1];
              _t3680 = Typechecker$error((((("type " + __dict_Show_string.show(name)) + " expects ") + __dict_Show_int.show(n)) + " type argument(s)"));
              break _t3681;
            }
            if (_t3679._tag === 0) {
              let _t3683;
              const _t3682 = Typechecker$find_variant_info(ctx.type_env, name);
              _t3684: {
                if (_t3682._tag === 1 && _t3682._val[1] === 0) {
                  _t3683 = ({_tag: 12, _name: "TVariant", _val: [canonical_3673, null]});
                  break _t3684;
                }
                if (_t3682._tag === 1) {
                  const n = _t3682._val[1];
                  _t3683 = Typechecker$error((((("type " + __dict_Show_string.show(name)) + " expects ") + __dict_Show_int.show(n)) + " type argument(s)"));
                  break _t3684;
                }
                if (_t3682._tag === 0) {
                  let _t3685;
                  if (!_eq(List$assoc_opt(canonical_3673, ctx.type_env.records), ({_tag: 0, _name: "None"}))) {
                    const fields_3686 = List$assoc(canonical_3673, ctx.type_env.records);
                    let _t3688;
                    if (_eq(fields_3686, null)) {
                      _t3688 = ({_tag: 11, _name: "TRecord", _val: ({_tag: 4, _name: "RWild"})});
                    } else {
                      _t3688 = ({_tag: 11, _name: "TRecord", _val: Types$fields_to_closed_row(fields_3686)});
                    }
                    const _t3687 = _t3688;
                    _t3685 = _t3687;
                  } else {
                    _t3685 = Typechecker$error(("unknown type: " + __dict_Show_string.show(name)));
                  }
                  _t3683 = _t3685;
                  break _t3684;
                }
                _match_fail("line 15950");
              }
              _t3680 = _t3683;
              break _t3681;
            }
            _match_fail("line 15950");
          }
          const _t3674 = _t3680;
          _t3666 = _t3674;
          break _t3667;
        }
        if (_t3665._tag === 2) {
          const a = _t3665._val[0];
          const b = _t3665._val[1];
          const eff_opt = _t3665._val[2];
          let _t3690;
          const _t3689 = eff_opt;
          _t3691: {
            if (_t3689._tag === 0) {
              _t3690 = Types$new_effvar(level);
              break _t3691;
            }
            if (_t3689._tag === 1 && _t3689._val._tag === 0) {
              _t3690 = ({_tag: 1, _name: "EffEmpty"});
              break _t3691;
            }
            if (_t3689._tag === 1 && _t3689._val._tag === 1) {
              const items = _t3689._val._val;
              _t3690 = Typechecker$resolve_eff_items(ctx, level, tvars, items);
              break _t3691;
            }
            _match_fail("line 15950");
          }
          const eff_3692 = _t3690;
          const _t3693 = ({_tag: 7, _name: "TArrow", _val: [go(a), eff_3692, go(b)]});
          _t3666 = _t3693;
          break _t3667;
        }
        if (_t3665._tag === 6) {
          const ts = _t3665._val;
          _t3666 = ({_tag: 9, _name: "TTuple", _val: List$map(go, ts)});
          break _t3667;
        }
        if (_t3665._tag === 4) {
          const t = _t3665._val;
          _t3666 = ({_tag: 10, _name: "TList", _val: go(t)});
          break _t3667;
        }
        if (_t3665._tag === 5) {
          const t = _t3665._val;
          _t3666 = ({_tag: 14, _name: "TArray", _val: go(t)});
          break _t3667;
        }
        if (_t3665._tag === 8) {
          const k = _t3665._val[0];
          const v = _t3665._val[1];
          _t3666 = ({_tag: 13, _name: "TMap", _val: [go(k), go(v)]});
          break _t3667;
        }
        if (_t3665._tag === 7) {
          const args = _t3665._val[0];
          const name = _t3665._val[1];
          const canonical_3694 = Typechecker$resolve_type_alias(ctx.type_env, name);
          const arg_tys_3696 = List$map(go, args);
          function _t3698(__p38) {
            let _t3700;
            const _t3699 = __p38;
            _t3701: {
              if (true) {
                const n = _t3699[0];
                _t3700 = (n === canonical_3694);
                break _t3701;
              }
              _match_fail("line 15950");
            }
            return _t3700;
          }
          let _t3703;
          const _t3702 = List$find(_t3698, ctx.type_env.type_synonyms);
          _t3704: {
            if (_t3702._tag === 1) {
              const np = _t3702._val[1];
              const ty = _t3702._val[2];
              let _t3705;
              if ((List$length(arg_tys_3696) !== np)) {
                _t3705 = Typechecker$error(((((("type " + __dict_Show_string.show(name)) + " expects ") + __dict_Show_int.show(np)) + " type argument(s), got ") + __dict_Show_int.show(List$length(arg_tys_3696))));
              } else {
                _t3705 = undefined;
              }
              _t3705;
              _t3703 = Typechecker$freshen_tvars(level, Typechecker$freshen_arrow_effects(level, Typechecker$subst_tgens(arg_tys_3696, ty)));
              break _t3704;
            }
            if (_t3702._tag === 0) {
              let _t3707;
              const _t3706 = Typechecker$find_variant_info(ctx.type_env, name);
              _t3708: {
                if (_t3706._tag === 1) {
                  const np = _t3706._val[1];
                  let _t3709;
                  if ((List$length(arg_tys_3696) !== np)) {
                    _t3709 = Typechecker$error(((((("type " + __dict_Show_string.show(name)) + " expects ") + __dict_Show_int.show(np)) + " type argument(s), got ") + __dict_Show_int.show(List$length(arg_tys_3696))));
                  } else {
                    _t3709 = undefined;
                  }
                  _t3709;
                  _t3707 = ({_tag: 12, _name: "TVariant", _val: [canonical_3694, arg_tys_3696]});
                  break _t3708;
                }
                if (_t3706._tag === 0) {
                  _t3707 = Typechecker$error(("unknown type constructor: " + __dict_Show_string.show(name)));
                  break _t3708;
                }
                _match_fail("line 15950");
              }
              _t3703 = _t3707;
              break _t3704;
            }
            _match_fail("line 15950");
          }
          const _t3697 = _t3703;
          const _t3695 = _t3697;
          _t3666 = _t3695;
          break _t3667;
        }
        if (_t3665._tag === 3) {
          const fields = _t3665._val[0];
          const is_open = _t3665._val[1];
          function _t3710(__p39) {
            let _t3712;
            const _t3711 = __p39;
            _t3713: {
              if (true) {
                const n = _t3711[0];
                const t = _t3711[1];
                _t3712 = [n, go(t)];
                break _t3713;
              }
              _match_fail("line 15950");
            }
            return _t3712;
          }
          const fields_3714 = List$map(_t3710, fields);
          function _t3716(__p40, __p41) {
            let _t3718;
            const _t3717 = __p40;
            _t3719: {
              if (true) {
                const a = _t3717[0];
                let _t3721;
                const _t3720 = __p41;
                _t3722: {
                  if (true) {
                    const b = _t3720[0];
                    _t3721 = String$compare(a, b);
                    break _t3722;
                  }
                  _match_fail("line 15950");
                }
                _t3718 = _t3721;
                break _t3719;
              }
              _match_fail("line 15950");
            }
            return _t3718;
          }
          const fields_3723 = List$sort(_t3716, fields_3714);
          let _t3725;
          if (is_open) {
            _t3725 = Types$new_rvar(level);
          } else {
            _t3725 = ({_tag: 2, _name: "REmpty"});
          }
          const tail_3726 = _t3725;
          function _t3728(__p42, acc) {
            let _t3730;
            const _t3729 = __p42;
            _t3731: {
              if (true) {
                const n = _t3729[0];
                const t = _t3729[1];
                _t3730 = ({_tag: 0, _name: "RRow", _val: [n, t, acc]});
                break _t3731;
              }
              _match_fail("line 15950");
            }
            return _t3730;
          }
          const _t3727 = ({_tag: 11, _name: "TRecord", _val: List$fold_right(_t3728, fields_3723, tail_3726)});
          const _t3724 = _t3727;
          const _t3715 = _t3724;
          _t3666 = _t3715;
          break _t3667;
        }
        if (_t3665._tag === 9) {
          const path = _t3665._val[0];
          const name = _t3665._val[1];
          const qualified_3732 = (String$concat(".", path) + ("." + name));
          const _t3734 = ({_tag: 0, _name: "TyName", _val: qualified_3732});
          __x = _t3734;
          continue;
          const _t3733 = undefined;
          _t3666 = _t3733;
          break _t3667;
        }
        if (_t3665._tag === 10) {
          const kind = _t3665._val[0];
          const tags = _t3665._val[1];
          let _t3736;
          const _t3735 = kind;
          _t3737: {
            if ((_t3735._tag === 0 || _t3735._tag === 2)) {
              _t3736 = ({_tag: 2, _name: "PVEmpty"});
              break _t3737;
            }
            if (_t3735._tag === 1) {
              _t3736 = Types$new_pvvar(level);
              break _t3737;
            }
            _match_fail("line 15950");
          }
          const tail_3738 = _t3736;
          function _t3740(__p43, acc) {
            let _t3742;
            const _t3741 = __p43;
            _t3743: {
              if (true) {
                const tag = _t3741[0];
                const payload_annot = _t3741[1];
                _t3742 = ({_tag: 0, _name: "PVRow", _val: [tag, Option$map(go, payload_annot), acc]});
                break _t3743;
              }
              _match_fail("line 15950");
            }
            return _t3742;
          }
          const row_3744 = List$fold_right(_t3740, tags, tail_3738);
          const _t3745 = ({_tag: 15, _name: "TPolyVariant", _val: row_3744});
          const _t3739 = _t3745;
          _t3666 = _t3739;
          break _t3667;
        }
        if (_t3665._tag === 11) {
          const ty = _t3665._val[0];
          const _eff = _t3665._val[1];
          const _t3746 = ty;
          __x = _t3746;
          continue;
          _t3666 = undefined;
          break _t3667;
        }
        _match_fail("line 15950");
      }
      return _t3666;
    }
  }
  const _t3747 = go(annot);
  return _t3747;
}
function Typechecker$resolve_eff_items(ctx, level, tvars, items) {
  const labels_3748 = Ref$create(null);
  const row_var_3750 = Ref$create(({_tag: 0, _name: "None"}));
  function _t3752(item) {
    let _t3754;
    const _t3753 = item;
    _t3755: {
      if (_t3753._tag === 0) {
        const name = _t3753._val[0];
        const param_annots = _t3753._val[1];
        let _t3756;
        if (!_eq(Ref$get(row_var_3750), ({_tag: 0, _name: "None"}))) {
          _t3756 = Typechecker$error("effect labels must come before row variable");
        } else {
          _t3756 = undefined;
        }
        _t3756;
        function _t3757(e) {
          return (e.effect_name === name);
        }
        let _t3759;
        const _t3758 = List$find(_t3757, ctx.type_env.effects);
        _t3760: {
          if (_t3758._tag === 1) {
            const e = _t3758._val;
            _t3759 = e;
            break _t3760;
          }
          if (_t3758._tag === 0) {
            _t3759 = Typechecker$error(("unknown effect: " + __dict_Show_string.show(name)));
            break _t3760;
          }
          _match_fail("line 15950");
        }
        const edef_3761 = _t3759;
        const expected_params_3763 = List$length(edef_3761.effect_params);
        const actual_params_3765 = List$length(param_annots);
        let _t3767;
        if ((expected_params_3763 !== actual_params_3765)) {
          _t3767 = Typechecker$error(((((("effect " + __dict_Show_string.show(name)) + " expects ") + __dict_Show_int.show(expected_params_3763)) + " type parameter(s), got ") + __dict_Show_int.show(actual_params_3765)));
        } else {
          _t3767 = undefined;
        }
        _t3767;
        const _t3766 = Ref$set(labels_3748, ({_hd: [name, param_annots], _tl: Ref$get(labels_3748)}));
        const _t3764 = _t3766;
        const _t3762 = _t3764;
        _t3754 = _t3762;
        break _t3755;
      }
      if (_t3753._tag === 1) {
        const name = _t3753._val;
        let _t3768;
        if (!_eq(Ref$get(row_var_3750), ({_tag: 0, _name: "None"}))) {
          _t3768 = Typechecker$error("at most one effect row variable allowed");
        } else {
          _t3768 = undefined;
        }
        _t3768;
        _t3754 = Ref$set(row_var_3750, ({_tag: 1, _name: "Some", _val: name}));
        break _t3755;
      }
      _match_fail("line 15950");
    }
    return _t3754;
  }
  List$iter(_t3752, items);
  const labels_3769 = List$rev(Ref$get(labels_3748));
  let _t3772;
  const _t3771 = Ref$get(row_var_3750);
  _t3773: {
    if (_t3771._tag === 0) {
      _t3772 = Types$new_effvar(level);
      break _t3773;
    }
    if (_t3771._tag === 1) {
      const _name = _t3771._val;
      _t3772 = Types$new_effvar(level);
      break _t3773;
    }
    _match_fail("line 15950");
  }
  const tail_3774 = _t3772;
  function _t3776(__p44, acc) {
    let _t3778;
    const _t3777 = __p44;
    _t3779: {
      if (true) {
        const name = _t3777[0];
        const param_annots = _t3777[1];
        const resolved_params_3780 = List$map(_call(Typechecker$resolve_ty_annot_shared, [ctx, level, tvars]), param_annots);
        const _t3781 = ({_tag: 2, _name: "EffRow", _val: [name, resolved_params_3780, acc]});
        _t3778 = _t3781;
        break _t3779;
      }
      _match_fail("line 15950");
    }
    return _t3778;
  }
  const _t3775 = List$fold_right(_t3776, labels_3769, tail_3774);
  const _t3770 = _t3775;
  const _t3751 = _t3770;
  const _t3749 = _t3751;
  return _t3749;
}
function Typechecker$resolve_ty_annot(ctx, level, annot) {
  const tvars_3782 = Hashtbl$create(4);
  const _t3783 = Typechecker$resolve_ty_annot_shared(ctx, level, tvars_3782, annot);
  return _t3783;
}
function Typechecker$instantiate_record_fields(level, fields) {
  function _t3784(acc, __p45) {
    let _t3786;
    const _t3785 = __p45;
    _t3787: {
      if (true) {
        const ty = _t3785[1];
        _t3786 = max(acc, Typechecker$max_tgen_in_ty(ty));
        break _t3787;
      }
      _match_fail("line 15950");
    }
    return _t3786;
  }
  const max_gen_3788 = List$fold(_t3784, (-1), fields);
  let _t3790;
  if ((max_gen_3788 < 0)) {
    _t3790 = fields;
  } else {
    function _t3791(_) {
      return Types$new_tvar(level);
    }
    const fresh_3792 = List$init((max_gen_3788 + 1), _t3791);
    function _t3794(__p46) {
      let _t3796;
      const _t3795 = __p46;
      _t3797: {
        if (true) {
          const n = _t3795[0];
          const ty = _t3795[1];
          _t3796 = [n, Typechecker$freshen_arrow_effects(level, Typechecker$subst_tgens(fresh_3792, ty))];
          break _t3797;
        }
        _match_fail("line 15950");
      }
      return _t3796;
    }
    const _t3793 = List$map(_t3794, fields);
    _t3790 = _t3793;
  }
  const _t3789 = _t3790;
  return _t3789;
}
function Typechecker$instantiate_record_row(level, fields) {
  const fields_3798 = Typechecker$instantiate_record_fields(level, fields);
  const _t3799 = Types$fields_to_closed_row(fields_3798);
  return _t3799;
}
function _t3800(_, __2) {
  return failwith("find_module_in_env not yet initialized");
}
const Typechecker$find_module_in_env_ref = Ref$create(_t3800);
function _t3801(_, __2, __3) {
  return failwith("open_module_into_ctx not yet initialized");
}
const Typechecker$open_module_into_ctx_ref = Ref$create(_t3801);
function _t3802(_, __2, __3) {
  return undefined;
}
const Typechecker$exhaustiveness_check_ref = Ref$create(_t3802);
function Typechecker$mk(te, ty) {
  return ({expr: te, loc: Ref$get(Typechecker$current_loc), ty: ty});
}
function Typechecker$extract_fn_info(expr) {
  while (true) {
    let _t3804;
    const _t3803 = expr;
    _t3805: {
      if (_t3803._tag === 49) {
        const inner = _t3803._val[1];
        const _t3806 = inner;
        expr = _t3806;
        continue;
        _t3804 = undefined;
        break _t3805;
      }
      if (_t3803._tag === 30) {
        const inner = _t3803._val[0];
        let _t3808;
        const _t3807 = inner;
        _t3809: {
          if ((_t3807._tag === 10 || _t3807._tag === 49 && _t3807._val[1]._tag === 10)) {
            _t3808 = true;
            break _t3809;
          }
          if (true) {
            _t3808 = false;
            break _t3809;
          }
          _match_fail("line 15950");
        }
        if (_t3808) {
          const _t3810 = inner;
          expr = _t3810;
          continue;
          _t3804 = undefined;
          break _t3805;
        }
      }
      if (_t3803._tag === 10) {
        const param = _t3803._val[0];
        const body = _t3803._val[1];
        let _t3812;
        const _t3811 = Typechecker$extract_fn_info(body);
        _t3813: {
          if (true) {
            const params = _t3811[0];
            const ret = _t3811[1];
            const inner = _t3811[2];
            _t3812 = [({_hd: param, _tl: params}), ret, inner];
            break _t3813;
          }
          _match_fail("line 15950");
        }
        _t3804 = _t3812;
        break _t3805;
      }
      if (_t3803._tag === 30) {
        const inner = _t3803._val[0];
        const annot = _t3803._val[1];
        _t3804 = [null, ({_tag: 1, _name: "Some", _val: annot}), inner];
        break _t3805;
      }
      if (true) {
        _t3804 = [null, ({_tag: 0, _name: "None"}), expr];
        break _t3805;
      }
      _match_fail("line 15950");
    }
    return _t3804;
  }
}
function Typechecker$resolve_module_name(ctx, name) {
  let _t3815;
  const _t3814 = ctx.current_module;
  _t3816: {
    if (_t3814._tag === 1) {
      const prefix = _t3814._val;
      function try_prefix(p) {
        while (true) {
          const qualified_3817 = (p + name);
          function _t3819(__p47) {
            let _t3821;
            const _t3820 = __p47;
            _t3822: {
              if (true) {
                const n = _t3820[0];
                _t3821 = (n === qualified_3817);
                break _t3822;
              }
              _match_fail("line 15950");
            }
            return _t3821;
          }
          let _t3823;
          if (List$exists(_t3819, ctx.vars)) {
            _t3823 = qualified_3817;
          } else {
            const p$p_3824 = String$sub(p, 0, max(0, (String$length(p) - 1)));
            let _t3827;
            const _t3826 = String$rindex_opt(p$p_3824, 46);
            _t3828: {
              if (_t3826._tag === 1) {
                const idx = _t3826._val;
                const _t3829 = String$sub(p$p_3824, 0, (idx + 1));
                p = _t3829;
                continue;
                _t3827 = undefined;
                break _t3828;
              }
              if (_t3826._tag === 0) {
                _t3827 = name;
                break _t3828;
              }
              _match_fail("line 15950");
            }
            const _t3825 = _t3827;
            _t3823 = _t3825;
          }
          const _t3818 = _t3823;
          return _t3818;
        }
      }
      const _t3830 = try_prefix(prefix);
      _t3815 = _t3830;
      break _t3816;
    }
    if (_t3814._tag === 0) {
      _t3815 = name;
      break _t3816;
    }
    _match_fail("line 15950");
  }
  return _t3815;
}
function Typechecker$find_var_type_in(target_name, te) {
  const result_3831 = Ref$create(({_tag: 0, _name: "None"}));
  function go(te) {
    while (true) {
      let _t3833;
      if (Option$is_some(Ref$get(result_3831))) {
        _t3833 = undefined;
      } else {
        let _t3835;
        const _t3834 = te.expr;
        _t3836: {
          if (_t3834._tag === 7) {
            const n = _t3834._val;
            if ((n === target_name)) {
              _t3835 = Ref$set(result_3831, ({_tag: 1, _name: "Some", _val: te.ty}));
              break _t3836;
            }
          }
          if ((((((((((_t3834._tag === 7 || _t3834._tag === 0) || _t3834._tag === 1) || _t3834._tag === 2) || _t3834._tag === 3) || _t3834._tag === 4) || _t3834._tag === 5) || _t3834._tag === 6) || _t3834._tag === 22) || _t3834._tag === 34)) {
            _t3835 = undefined;
            break _t3836;
          }
          if (_t3834._tag === 11) {
            const fn_ = _t3834._val[0];
            const arg = _t3834._val[1];
            go(fn_);
            const _t3837 = arg;
            te = _t3837;
            continue;
            _t3835 = undefined;
            break _t3836;
          }
          if (((((((((_t3834._tag === 10 || _t3834._tag === 14) || _t3834._tag === 19) || _t3834._tag === 33) || _t3834._tag === 35) || _t3834._tag === 36) || _t3834._tag === 40) || _t3834._tag === 26) || _t3834._tag === 29)) {
            const body = ((((((((_t3834._tag === 10 || _t3834._tag === 14) || _t3834._tag === 19) || _t3834._tag === 33) || _t3834._tag === 35) || _t3834._tag === 36) || _t3834._tag === 40) || _t3834._tag === 26) ? (((((((_t3834._tag === 10 || _t3834._tag === 14) || _t3834._tag === 19) || _t3834._tag === 33) || _t3834._tag === 35) || _t3834._tag === 36) || _t3834._tag === 40) ? ((((((_t3834._tag === 10 || _t3834._tag === 14) || _t3834._tag === 19) || _t3834._tag === 33) || _t3834._tag === 35) || _t3834._tag === 36) ? (((((_t3834._tag === 10 || _t3834._tag === 14) || _t3834._tag === 19) || _t3834._tag === 33) || _t3834._tag === 35) ? ((((_t3834._tag === 10 || _t3834._tag === 14) || _t3834._tag === 19) || _t3834._tag === 33) ? (((_t3834._tag === 10 || _t3834._tag === 14) || _t3834._tag === 19) ? ((_t3834._tag === 10 || _t3834._tag === 14) ? _t3834._val[1] : _t3834._val[0]) : _t3834._val) : _t3834._val) : _t3834._val) : _t3834._val) : _t3834._val[1]) : _t3834._val[1]);
            const _t3838 = body;
            te = _t3838;
            continue;
            _t3835 = undefined;
            break _t3836;
          }
          if ((((((((((_t3834._tag === 8 || _t3834._tag === 9) || _t3834._tag === 25) || _t3834._tag === 13) || _t3834._tag === 21) || _t3834._tag === 28) || _t3834._tag === 32) || _t3834._tag === 31) || _t3834._tag === 27) || _t3834._tag === 20)) {
            const e1 = (((((((((_t3834._tag === 8 || _t3834._tag === 9) || _t3834._tag === 25) || _t3834._tag === 13) || _t3834._tag === 21) || _t3834._tag === 28) || _t3834._tag === 32) || _t3834._tag === 31) || _t3834._tag === 27) ? ((((((((_t3834._tag === 8 || _t3834._tag === 9) || _t3834._tag === 25) || _t3834._tag === 13) || _t3834._tag === 21) || _t3834._tag === 28) || _t3834._tag === 32) || _t3834._tag === 31) ? (((((((_t3834._tag === 8 || _t3834._tag === 9) || _t3834._tag === 25) || _t3834._tag === 13) || _t3834._tag === 21) || _t3834._tag === 28) || _t3834._tag === 32) ? ((((((_t3834._tag === 8 || _t3834._tag === 9) || _t3834._tag === 25) || _t3834._tag === 13) || _t3834._tag === 21) || _t3834._tag === 28) ? (((((_t3834._tag === 8 || _t3834._tag === 9) || _t3834._tag === 25) || _t3834._tag === 13) || _t3834._tag === 21) ? ((((_t3834._tag === 8 || _t3834._tag === 9) || _t3834._tag === 25) || _t3834._tag === 13) ? (((_t3834._tag === 8 || _t3834._tag === 9) || _t3834._tag === 25) ? ((_t3834._tag === 8 || _t3834._tag === 9) ? _t3834._val[2] : _t3834._val[1]) : _t3834._val[1]) : _t3834._val[0]) : _t3834._val[0]) : _t3834._val[0]) : _t3834._val[0]) : _t3834._val[0]) : _t3834._val[0]);
            const e2 = (((((((((_t3834._tag === 8 || _t3834._tag === 9) || _t3834._tag === 25) || _t3834._tag === 13) || _t3834._tag === 21) || _t3834._tag === 28) || _t3834._tag === 32) || _t3834._tag === 31) || _t3834._tag === 27) ? ((((((((_t3834._tag === 8 || _t3834._tag === 9) || _t3834._tag === 25) || _t3834._tag === 13) || _t3834._tag === 21) || _t3834._tag === 28) || _t3834._tag === 32) || _t3834._tag === 31) ? (((((((_t3834._tag === 8 || _t3834._tag === 9) || _t3834._tag === 25) || _t3834._tag === 13) || _t3834._tag === 21) || _t3834._tag === 28) || _t3834._tag === 32) ? ((((((_t3834._tag === 8 || _t3834._tag === 9) || _t3834._tag === 25) || _t3834._tag === 13) || _t3834._tag === 21) || _t3834._tag === 28) ? (((((_t3834._tag === 8 || _t3834._tag === 9) || _t3834._tag === 25) || _t3834._tag === 13) || _t3834._tag === 21) ? ((((_t3834._tag === 8 || _t3834._tag === 9) || _t3834._tag === 25) || _t3834._tag === 13) ? (((_t3834._tag === 8 || _t3834._tag === 9) || _t3834._tag === 25) ? ((_t3834._tag === 8 || _t3834._tag === 9) ? _t3834._val[3] : _t3834._val[2]) : _t3834._val[2]) : _t3834._val[1]) : _t3834._val[1]) : _t3834._val[1]) : _t3834._val[1]) : _t3834._val[2]) : _t3834._val[1]);
            go(e1);
            const _t3839 = e2;
            te = _t3839;
            continue;
            _t3835 = undefined;
            break _t3836;
          }
          if (_t3834._tag === 12) {
            const c = _t3834._val[0];
            const t = _t3834._val[1];
            const e = _t3834._val[2];
            go(c);
            go(t);
            const _t3840 = e;
            te = _t3840;
            continue;
            _t3835 = undefined;
            break _t3836;
          }
          if ((_t3834._tag === 15 || _t3834._tag === 39)) {
            const es = _t3834._val;
            _t3835 = List$iter(go, es);
            break _t3836;
          }
          if (_t3834._tag === 38) {
            const kvs = _t3834._val;
            function _t3841(__p48) {
              let _t3843;
              const _t3842 = __p48;
              _t3844: {
                if (true) {
                  const k = _t3842[0];
                  const v = _t3842[1];
                  go(k);
                  _t3843 = go(v);
                  break _t3844;
                }
                _match_fail("line 15950");
              }
              return _t3843;
            }
            _t3835 = List$iter(_t3841, kvs);
            break _t3836;
          }
          if (_t3834._tag === 16) {
            const fields = _t3834._val;
            function _t3845(__p49) {
              let _t3847;
              const _t3846 = __p49;
              _t3848: {
                if (true) {
                  const e = _t3846[1];
                  _t3847 = go(e);
                  break _t3848;
                }
                _match_fail("line 15950");
              }
              return _t3847;
            }
            _t3835 = List$iter(_t3845, fields);
            break _t3836;
          }
          if (_t3834._tag === 17) {
            const base = _t3834._val[0];
            const overrides = _t3834._val[1];
            go(base);
            function _t3849(__p50) {
              let _t3851;
              const _t3850 = __p50;
              _t3852: {
                if (true) {
                  const e = _t3850[1];
                  _t3851 = go(e);
                  break _t3852;
                }
                _match_fail("line 15950");
              }
              return _t3851;
            }
            _t3835 = List$iter(_t3849, overrides);
            break _t3836;
          }
          if (_t3834._tag === 18) {
            const base = _t3834._val[0];
            const pairs = _t3834._val[1];
            go(base);
            function _t3853(__p51) {
              let _t3855;
              const _t3854 = __p51;
              _t3856: {
                if (true) {
                  const i = _t3854[0];
                  const v = _t3854[1];
                  go(i);
                  _t3855 = go(v);
                  break _t3856;
                }
                _match_fail("line 15950");
              }
              return _t3855;
            }
            _t3835 = List$iter(_t3853, pairs);
            break _t3836;
          }
          if (_t3834._tag === 23) {
            const arg = _t3834._val[1];
            _t3835 = Option$iter(go, arg);
            break _t3836;
          }
          if (_t3834._tag === 24) {
            const scr = _t3834._val[0];
            const arms = _t3834._val[1];
            go(scr);
            function _t3857(__p52) {
              let _t3859;
              const _t3858 = __p52;
              _t3860: {
                if (true) {
                  const g = _t3858[1];
                  const body = _t3858[2];
                  Option$iter(go, g);
                  _t3859 = go(body);
                  break _t3860;
                }
                _match_fail("line 15950");
              }
              return _t3859;
            }
            _t3835 = List$iter(_t3857, arms);
            break _t3836;
          }
          if (_t3834._tag === 30) {
            const body = _t3834._val[0];
            const arms = _t3834._val[1];
            go(body);
            function _t3861(arm) {
              let _t3863;
              const _t3862 = arm;
              _t3864: {
                if (_t3862._tag === 0) {
                  const e = _t3862._val[1];
                  _t3863 = go(e);
                  break _t3864;
                }
                if (_t3862._tag === 1) {
                  const e = _t3862._val[3];
                  _t3863 = go(e);
                  break _t3864;
                }
                _match_fail("line 15950");
              }
              return _t3863;
            }
            _t3835 = List$iter(_t3861, arms);
            break _t3836;
          }
          if (_t3834._tag === 37) {
            const bindings = _t3834._val[0];
            const body = _t3834._val[1];
            function _t3865(__p53) {
              let _t3867;
              const _t3866 = __p53;
              _t3868: {
                if (true) {
                  const e = _t3866[1];
                  _t3867 = go(e);
                  break _t3868;
                }
                _match_fail("line 15950");
              }
              return _t3867;
            }
            List$iter(_t3865, bindings);
            const _t3869 = body;
            te = _t3869;
            continue;
            _t3835 = undefined;
            break _t3836;
          }
          _match_fail("line 15950");
        }
        _t3833 = _t3835;
      }
      return _t3833;
    }
  }
  go(te);
  const _t3870 = Ref$get(result_3831);
  const _t3832 = _t3870;
  return _t3832;
}
function Typechecker$infer_implicit_constraints(binding_name, type_env, vars, te, scheme) {
  let _t3871;
  if ((!_eq(scheme.constraints, null) || (scheme.quant === 0))) {
    _t3871 = scheme;
  } else {
    const id_map_3872 = Hashtbl$create(8);
    function build_map(s, a) {
      while (true) {
        const a_3874 = Types$repr(a);
        let _t3877;
        const _t3876 = s;
        _t3878: {
          if (_t3876._tag === 17) {
            const i = _t3876._val;
            let _t3880;
            const _t3879 = a_3874;
            _t3881: {
              if (_t3879._tag === 16 && _t3879._val.contents._tag === 0) {
                const id = _t3879._val.contents._val[0];
                _t3880 = _call(Hashtbl$set, [__dict_Hash_int, __dict_Eq_int, id_map_3872, id, ({_tag: 17, _name: "TGen", _val: i})]);
                break _t3881;
              }
              if (true) {
                _t3880 = undefined;
                break _t3881;
              }
              _match_fail("line 15950");
            }
            _t3877 = _t3880;
            break _t3878;
          }
          if (_t3876._tag === 7) {
            const s1 = _t3876._val[0];
            const s2 = _t3876._val[2];
            let _t3883;
            const _t3882 = a_3874;
            _t3884: {
              if (_t3882._tag === 7) {
                const a1 = _t3882._val[0];
                const a2 = _t3882._val[2];
                build_map(s1, a1);
                const _t3885 = s2;
                const _t3886 = a2;
                s = _t3885;
                a = _t3886;
                continue;
                _t3883 = undefined;
                break _t3884;
              }
              if (true) {
                _t3883 = undefined;
                break _t3884;
              }
              _match_fail("line 15950");
            }
            _t3877 = _t3883;
            break _t3878;
          }
          if (_t3876._tag === 8) {
            const s1 = _t3876._val[0];
            const s2 = _t3876._val[2];
            let _t3888;
            const _t3887 = a_3874;
            _t3889: {
              if (_t3887._tag === 8) {
                const a1 = _t3887._val[0];
                const a2 = _t3887._val[2];
                build_map(s1, a1);
                const _t3890 = s2;
                const _t3891 = a2;
                s = _t3890;
                a = _t3891;
                continue;
                _t3888 = undefined;
                break _t3889;
              }
              if (true) {
                _t3888 = undefined;
                break _t3889;
              }
              _match_fail("line 15950");
            }
            _t3877 = _t3888;
            break _t3878;
          }
          if (_t3876._tag === 9) {
            const ss = _t3876._val;
            let _t3893;
            const _t3892 = a_3874;
            _t3894: {
              if (_t3892._tag === 9) {
                const aa = _t3892._val;
                if ((List$length(ss) === List$length(aa))) {
                  _t3893 = List$iter2(build_map, ss, aa);
                  break _t3894;
                }
              }
              if (true) {
                _t3893 = undefined;
                break _t3894;
              }
              _match_fail("line 15950");
            }
            _t3877 = _t3893;
            break _t3878;
          }
          if (_t3876._tag === 10) {
            const s1 = _t3876._val;
            let _t3896;
            const _t3895 = a_3874;
            _t3897: {
              if (_t3895._tag === 10) {
                const a1 = _t3895._val;
                const _t3898 = s1;
                const _t3899 = a1;
                s = _t3898;
                a = _t3899;
                continue;
                _t3896 = undefined;
                break _t3897;
              }
              if (true) {
                _t3896 = undefined;
                break _t3897;
              }
              _match_fail("line 15950");
            }
            _t3877 = _t3896;
            break _t3878;
          }
          if (_t3876._tag === 14) {
            const s1 = _t3876._val;
            let _t3901;
            const _t3900 = a_3874;
            _t3902: {
              if (_t3900._tag === 14) {
                const a1 = _t3900._val;
                const _t3903 = s1;
                const _t3904 = a1;
                s = _t3903;
                a = _t3904;
                continue;
                _t3901 = undefined;
                break _t3902;
              }
              if (true) {
                _t3901 = undefined;
                break _t3902;
              }
              _match_fail("line 15950");
            }
            _t3877 = _t3901;
            break _t3878;
          }
          if (_t3876._tag === 13) {
            const sk = _t3876._val[0];
            const sv = _t3876._val[1];
            let _t3906;
            const _t3905 = a_3874;
            _t3907: {
              if (_t3905._tag === 13) {
                const ak = _t3905._val[0];
                const av = _t3905._val[1];
                build_map(sk, ak);
                const _t3908 = sv;
                const _t3909 = av;
                s = _t3908;
                a = _t3909;
                continue;
                _t3906 = undefined;
                break _t3907;
              }
              if (true) {
                _t3906 = undefined;
                break _t3907;
              }
              _match_fail("line 15950");
            }
            _t3877 = _t3906;
            break _t3878;
          }
          if (_t3876._tag === 12) {
            const ss = _t3876._val[1];
            let _t3911;
            const _t3910 = a_3874;
            _t3912: {
              if (_t3910._tag === 12) {
                const aa = _t3910._val[1];
                if ((List$length(ss) === List$length(aa))) {
                  _t3911 = List$iter2(build_map, ss, aa);
                  break _t3912;
                }
              }
              if (true) {
                _t3911 = undefined;
                break _t3912;
              }
              _match_fail("line 15950");
            }
            _t3877 = _t3911;
            break _t3878;
          }
          if (_t3876._tag === 15) {
            const srow = _t3876._val;
            let _t3914;
            const _t3913 = a_3874;
            _t3915: {
              if (_t3913._tag === 15) {
                const arow = _t3913._val;
                _t3914 = build_map_pvrows(srow, arow);
                break _t3915;
              }
              if (true) {
                _t3914 = undefined;
                break _t3915;
              }
              _match_fail("line 15950");
            }
            _t3877 = _t3914;
            break _t3878;
          }
          if (_t3876._tag === 11) {
            const srow = _t3876._val;
            let _t3917;
            const _t3916 = a_3874;
            _t3918: {
              if (_t3916._tag === 11) {
                const arow = _t3916._val;
                _t3917 = build_map_rrows(srow, arow);
                break _t3918;
              }
              if (true) {
                _t3917 = undefined;
                break _t3918;
              }
              _match_fail("line 15950");
            }
            _t3877 = _t3917;
            break _t3878;
          }
          if (true) {
            _t3877 = undefined;
            break _t3878;
          }
          _match_fail("line 15950");
        }
        const _t3875 = _t3877;
        return _t3875;
      }
    }
    function build_map_rrows(srow, arow) {
      const sf_3919 = Types$record_row_to_fields(srow);
      const af_3921 = Types$record_row_to_fields(arow);
      let _t3923;
      if ((List$length(sf_3919) === List$length(af_3921))) {
        function _t3924(__p54, __p55) {
          let _t3926;
          const _t3925 = __p54;
          _t3927: {
            if (true) {
              const st = _t3925[1];
              let _t3929;
              const _t3928 = __p55;
              _t3930: {
                if (true) {
                  const at_ = _t3928[1];
                  _t3929 = build_map(st, at_);
                  break _t3930;
                }
                _match_fail("line 15950");
              }
              _t3926 = _t3929;
              break _t3927;
            }
            _match_fail("line 15950");
          }
          return _t3926;
        }
        _t3923 = List$iter2(_t3924, sf_3919, af_3921);
      } else {
        _t3923 = undefined;
      }
      const _t3922 = _t3923;
      const _t3920 = _t3922;
      return _t3920;
    }
    function build_map_pvrows(srow, arow) {
      function collect_tags(row) {
        while (true) {
          let _t3932;
          const _t3931 = row;
          _t3933: {
            if (_t3931._tag === 0) {
              const tag = _t3931._val[0];
              const ty_opt = _t3931._val[1];
              const tail = _t3931._val[2];
              _t3932 = ({_hd: [tag, ty_opt], _tl: collect_tags(tail)});
              break _t3933;
            }
            if (_t3931._tag === 1 && _t3931._val.contents._tag === 1) {
              const r = _t3931._val.contents._val;
              const _t3934 = r;
              row = _t3934;
              continue;
              _t3932 = undefined;
              break _t3933;
            }
            if (true) {
              _t3932 = null;
              break _t3933;
            }
            _match_fail("line 15950");
          }
          return _t3932;
        }
      }
      const atags_3936 = collect_tags(arow);
      function go(row) {
        while (true) {
          let _t3939;
          const _t3938 = row;
          _t3940: {
            if (_t3938._tag === 0) {
              const stag = _t3938._val[0];
              const sty_opt = _t3938._val[1];
              const stail = _t3938._val[2];
              let _t3942;
              const _t3941 = List$assoc_opt(stag, atags_3936);
              _t3943: {
                if (_t3941._tag === 1) {
                  const aty_opt = _t3941._val;
                  let _t3945;
                  const _t3944 = [sty_opt, aty_opt];
                  _t3946: {
                    if (_t3944[0]._tag === 1 && _t3944[1]._tag === 1) {
                      const sty = _t3944[0]._val;
                      const aty = _t3944[1]._val;
                      _t3945 = build_map(sty, aty);
                      break _t3946;
                    }
                    if (true) {
                      _t3945 = undefined;
                      break _t3946;
                    }
                    _match_fail("line 15950");
                  }
                  _t3942 = _t3945;
                  break _t3943;
                }
                if (_t3941._tag === 0) {
                  _t3942 = undefined;
                  break _t3943;
                }
                _match_fail("line 15950");
              }
              _t3942;
              const _t3947 = stail;
              row = _t3947;
              continue;
              _t3939 = undefined;
              break _t3940;
            }
            if (_t3938._tag === 1 && _t3938._val.contents._tag === 1) {
              const r = _t3938._val.contents._val;
              const _t3948 = r;
              row = _t3948;
              continue;
              _t3939 = undefined;
              break _t3940;
            }
            if (true) {
              _t3939 = undefined;
              break _t3940;
            }
            _match_fail("line 15950");
          }
          return _t3939;
        }
      }
      const _t3949 = go(srow);
      const _t3937 = _t3949;
      const _t3935 = _t3937;
      return _t3935;
    }
    build_map(scheme.body, te.ty);
    const found_multi_3951 = Ref$create(null);
    const pending_caty_3953 = Ref$create(null);
    const phantom_counter_3955 = Ref$create(scheme.quant);
    const tvar_to_phantom_3957 = Hashtbl$create(4);
    function _t3959(tbl, key) {
      function _t3960(k) {
        return _eq(k, key);
      }
      let _t3961;
      if ((!List$exists(_t3960, Ref$get(tbl)))) {
        _t3961 = Ref$set(tbl, ({_hd: key, _tl: Ref$get(tbl)}));
      } else {
        _t3961 = undefined;
      }
      return _t3961;
    }
    const set_add_3962 = _t3959;
    function _t3964(local_sch, actual_ty) {
      const call_map_3965 = Hashtbl$create(4);
      const phantom_remap_3967 = Hashtbl$create(4);
      function map_tgens(s, a) {
        while (true) {
          const a_3969 = Types$repr(a);
          let _t3972;
          const _t3971 = s;
          _t3973: {
            if (_t3971._tag === 17) {
              const i = _t3971._val;
              let _t3974;
              if ((!_call(Hashtbl$has, [__dict_Hash_int, __dict_Eq_int, call_map_3965, i]))) {
                _t3974 = _call(Hashtbl$set, [__dict_Hash_int, __dict_Eq_int, call_map_3965, i, a_3969]);
              } else {
                _t3974 = undefined;
              }
              _t3972 = _t3974;
              break _t3973;
            }
            if (_t3971._tag === 7) {
              const s1 = _t3971._val[0];
              const s2 = _t3971._val[2];
              let _t3976;
              const _t3975 = a_3969;
              _t3977: {
                if (_t3975._tag === 7) {
                  const a1 = _t3975._val[0];
                  const a2 = _t3975._val[2];
                  map_tgens(s1, a1);
                  const _t3978 = s2;
                  const _t3979 = a2;
                  s = _t3978;
                  a = _t3979;
                  continue;
                  _t3976 = undefined;
                  break _t3977;
                }
                if (true) {
                  _t3976 = undefined;
                  break _t3977;
                }
                _match_fail("line 15950");
              }
              _t3972 = _t3976;
              break _t3973;
            }
            if (_t3971._tag === 8) {
              const s1 = _t3971._val[0];
              const s2 = _t3971._val[2];
              let _t3981;
              const _t3980 = a_3969;
              _t3982: {
                if (_t3980._tag === 8) {
                  const a1 = _t3980._val[0];
                  const a2 = _t3980._val[2];
                  map_tgens(s1, a1);
                  const _t3983 = s2;
                  const _t3984 = a2;
                  s = _t3983;
                  a = _t3984;
                  continue;
                  _t3981 = undefined;
                  break _t3982;
                }
                if (true) {
                  _t3981 = undefined;
                  break _t3982;
                }
                _match_fail("line 15950");
              }
              _t3972 = _t3981;
              break _t3973;
            }
            if (_t3971._tag === 9) {
              const ss = _t3971._val;
              let _t3986;
              const _t3985 = a_3969;
              _t3987: {
                if (_t3985._tag === 9) {
                  const aa = _t3985._val;
                  if ((List$length(ss) === List$length(aa))) {
                    _t3986 = List$iter2(map_tgens, ss, aa);
                    break _t3987;
                  }
                }
                if (true) {
                  _t3986 = undefined;
                  break _t3987;
                }
                _match_fail("line 15950");
              }
              _t3972 = _t3986;
              break _t3973;
            }
            if (_t3971._tag === 10) {
              const s1 = _t3971._val;
              let _t3989;
              const _t3988 = a_3969;
              _t3990: {
                if (_t3988._tag === 10) {
                  const a1 = _t3988._val;
                  const _t3991 = s1;
                  const _t3992 = a1;
                  s = _t3991;
                  a = _t3992;
                  continue;
                  _t3989 = undefined;
                  break _t3990;
                }
                if (true) {
                  _t3989 = undefined;
                  break _t3990;
                }
                _match_fail("line 15950");
              }
              _t3972 = _t3989;
              break _t3973;
            }
            if (_t3971._tag === 14) {
              const s1 = _t3971._val;
              let _t3994;
              const _t3993 = a_3969;
              _t3995: {
                if (_t3993._tag === 14) {
                  const a1 = _t3993._val;
                  const _t3996 = s1;
                  const _t3997 = a1;
                  s = _t3996;
                  a = _t3997;
                  continue;
                  _t3994 = undefined;
                  break _t3995;
                }
                if (true) {
                  _t3994 = undefined;
                  break _t3995;
                }
                _match_fail("line 15950");
              }
              _t3972 = _t3994;
              break _t3973;
            }
            if (_t3971._tag === 13) {
              const sk = _t3971._val[0];
              const sv = _t3971._val[1];
              let _t3999;
              const _t3998 = a_3969;
              _t4000: {
                if (_t3998._tag === 13) {
                  const ak = _t3998._val[0];
                  const av = _t3998._val[1];
                  map_tgens(sk, ak);
                  const _t4001 = sv;
                  const _t4002 = av;
                  s = _t4001;
                  a = _t4002;
                  continue;
                  _t3999 = undefined;
                  break _t4000;
                }
                if (true) {
                  _t3999 = undefined;
                  break _t4000;
                }
                _match_fail("line 15950");
              }
              _t3972 = _t3999;
              break _t3973;
            }
            if (_t3971._tag === 12) {
              const ss = _t3971._val[1];
              let _t4004;
              const _t4003 = a_3969;
              _t4005: {
                if (_t4003._tag === 12) {
                  const aa = _t4003._val[1];
                  if ((List$length(ss) === List$length(aa))) {
                    _t4004 = List$iter2(map_tgens, ss, aa);
                    break _t4005;
                  }
                }
                if (true) {
                  _t4004 = undefined;
                  break _t4005;
                }
                _match_fail("line 15950");
              }
              _t3972 = _t4004;
              break _t3973;
            }
            if (true) {
              _t3972 = undefined;
              break _t3973;
            }
            _match_fail("line 15950");
          }
          const _t3970 = _t3972;
          return _t3970;
        }
      }
      map_tgens(local_sch.body, actual_ty);
      function _t4007(cc) {
        function _t4008(ca) {
          let _t4010;
          const _t4009 = ca;
          _t4011: {
            if (_t4009._tag === 0) {
              const tgen_idx = _t4009._val;
              let _t4013;
              const _t4012 = _call(Hashtbl$get, [__dict_Hash_int, __dict_Eq_int, call_map_3965, tgen_idx]);
              _t4014: {
                if (_t4012._tag === 1 && _t4012._val._tag === 16 && _t4012._val._val.contents._tag === 0) {
                  const id = _t4012._val._val.contents._val[0];
                  const tv = _t4012._val;
                  let _t4016;
                  const _t4015 = _call(Hashtbl$get, [__dict_Hash_int, __dict_Eq_int, id_map_3872, id]);
                  _t4017: {
                    if (_t4015._tag === 1 && _t4015._val._tag === 17) {
                      const outer_tgen = _t4015._val._val;
                      _t4016 = ({_tag: 1, _name: "Some", _val: ({_tag: 0, _name: "CATGen", _val: outer_tgen})});
                      break _t4017;
                    }
                    if (true) {
                      _t4016 = ({_tag: 1, _name: "Some", _val: ({_tag: 1, _name: "CATy", _val: tv})});
                      break _t4017;
                    }
                    _match_fail("line 15950");
                  }
                  _t4013 = _t4016;
                  break _t4014;
                }
                if (_t4012._tag === 1) {
                  _t4013 = ({_tag: 0, _name: "None"});
                  break _t4014;
                }
                if (_t4012._tag === 0) {
                  _t4013 = ({_tag: 0, _name: "None"});
                  break _t4014;
                }
                _match_fail("line 15950");
              }
              _t4010 = _t4013;
              break _t4011;
            }
            if (_t4009._tag === 1) {
              const ty = _t4009._val;
              let _t4019;
              const _t4018 = Types$repr(ty);
              _t4020: {
                if (_t4018._tag === 16 && _t4018._val.contents._tag === 0) {
                  const id = _t4018._val.contents._val[0];
                  let _t4022;
                  const _t4021 = _call(Hashtbl$get, [__dict_Hash_int, __dict_Eq_int, id_map_3872, id]);
                  _t4023: {
                    if (_t4021._tag === 1 && _t4021._val._tag === 17) {
                      const outer_tgen = _t4021._val._val;
                      _t4022 = ({_tag: 1, _name: "Some", _val: ({_tag: 0, _name: "CATGen", _val: outer_tgen})});
                      break _t4023;
                    }
                    if (true) {
                      _t4022 = ({_tag: 1, _name: "Some", _val: ca});
                      break _t4023;
                    }
                    _match_fail("line 15950");
                  }
                  _t4019 = _t4022;
                  break _t4020;
                }
                if (true) {
                  _t4019 = ({_tag: 1, _name: "Some", _val: ca});
                  break _t4020;
                }
                _match_fail("line 15950");
              }
              _t4010 = _t4019;
              break _t4011;
            }
            if (_t4009._tag === 2) {
              _t4010 = ({_tag: 1, _name: "Some", _val: ({_tag: 2, _name: "CAWild"})});
              break _t4011;
            }
            if (_t4009._tag === 3) {
              const inner_idx = _t4009._val[0];
              let _t4025;
              const _t4024 = _call(Hashtbl$get, [__dict_Hash_int, __dict_Eq_int, phantom_remap_3967, inner_idx]);
              _t4026: {
                if (_t4024._tag === 1) {
                  const pair = _t4024._val;
                  _t4025 = pair;
                  break _t4026;
                }
                if (_t4024._tag === 0) {
                  const idx_4027 = Ref$get(phantom_counter_3955);
                  Ref$set(phantom_counter_3955, (Ref$get(phantom_counter_3955) + 1));
                  const tv_4029 = Types$new_tvar(1);
                  _call(Hashtbl$set, [__dict_Hash_int, __dict_Eq_int, phantom_remap_3967, inner_idx, [idx_4027, tv_4029]]);
                  const _t4030 = [idx_4027, tv_4029];
                  const _t4028 = _t4030;
                  _t4025 = _t4028;
                  break _t4026;
                }
                _match_fail("line 15950");
              }
              let _t4032;
              const _t4031 = _t4025;
              _t4033: {
                if (true) {
                  const outer_idx = _t4031[0];
                  const outer_tv = _t4031[1];
                  _t4032 = ({_tag: 1, _name: "Some", _val: ({_tag: 3, _name: "CAPhantom", _val: [outer_idx, outer_tv]})});
                  break _t4033;
                }
                _match_fail("line 15950");
              }
              _t4010 = _t4032;
              break _t4011;
            }
            _match_fail("line 15950");
          }
          return _t4010;
        }
        const outer_tgens_4034 = List$filter_map(_t4008, cc.cc_args);
        let _t4036;
        if ((List$length(outer_tgens_4034) === List$length(cc.cc_args))) {
          _t4036 = set_add_3962(found_multi_3951, [cc.cc_class, outer_tgens_4034]);
        } else {
          _t4036 = undefined;
        }
        const _t4035 = _t4036;
        return _t4035;
      }
      const _t4006 = List$iter(_t4007, local_sch.constraints);
      const _t3968 = _t4006;
      const _t3966 = _t3968;
      return _t3966;
    }
    const propagate_constrained_ref_4037 = _t3964;
    function walk(locals, te) {
      let _t4040;
      const _t4039 = te.expr;
      _t4041: {
        if (_t4039._tag === 7) {
          const name = _t4039._val;
          let _t4043;
          const _t4042 = List$assoc_opt(name, locals);
          _t4044: {
            if (_t4042._tag === 1) {
              const local_sch = _t4042._val;
              if (!_eq(local_sch.constraints, null)) {
                _t4043 = propagate_constrained_ref_4037(local_sch, te.ty);
                break _t4044;
              }
            }
            if (true) {
              _t4043 = undefined;
              break _t4044;
            }
            _match_fail("line 15950");
          }
          _t4043;
          let _t4046;
          const _t4045 = List$assoc_opt(name, vars);
          _t4047: {
            if (_t4045._tag === 1) {
              const var_sch = _t4045._val;
              if (!_eq(var_sch.constraints, null)) {
                _t4046 = propagate_constrained_ref_4037(var_sch, te.ty);
                break _t4047;
              }
            }
            if (true) {
              _t4046 = undefined;
              break _t4047;
            }
            _match_fail("line 15950");
          }
          _t4046;
          let _t4049;
          const _t4048 = Types$find_method_class(type_env.classes, name);
          _t4050: {
            if (_t4048._tag === 1) {
              const class_def = _t4048._val;
              if ((!(name === binding_name))) {
                const method_ty_4051 = List$assoc(name, class_def.class_methods);
                let _t4054;
                const _t4053 = List$assoc_opt(name, vars);
                _t4055: {
                  if (_t4053._tag === 1) {
                    const s = _t4053._val;
                    let _t4056;
                    if (_eq(s.body, method_ty_4051)) {
                      _t4056 = [({_tag: 1, _name: "Some", _val: class_def}), name];
                    } else {
                      _t4056 = [({_tag: 0, _name: "None"}), name];
                    }
                    _t4054 = _t4056;
                    break _t4055;
                  }
                  if (_t4053._tag === 0) {
                    _t4054 = [({_tag: 0, _name: "None"}), name];
                    break _t4055;
                  }
                  _match_fail("line 15950");
                }
                const _t4052 = _t4054;
                _t4049 = _t4052;
                break _t4050;
              }
            }
            if (true) {
              let _t4058;
              const _t4057 = String$rindex_opt(name, 46);
              _t4059: {
                if (_t4057._tag === 0) {
                  _t4058 = [({_tag: 0, _name: "None"}), name];
                  break _t4059;
                }
                if (_t4057._tag === 1) {
                  const i = _t4057._val;
                  const _mml$short_4060 = String$sub(name, (i + 1), ((String$length(name) - i) - 1));
                  const class_prefix_4062 = String$sub(name, 0, i);
                  const mod_prefix_4064 = String$sub(name, 0, (i + 1));
                  let _t4067;
                  const _t4066 = Types$find_method_class(type_env.classes, _mml$short_4060);
                  _t4068: {
                    if (_t4066._tag === 1) {
                      const class_def = _t4066._val;
                      if (((!(_mml$short_4060 === binding_name)) && ((class_def.class_name === class_prefix_4062) || ((String$length(class_def.class_name) > String$length(mod_prefix_4064)) && (String$sub(class_def.class_name, 0, String$length(mod_prefix_4064)) === mod_prefix_4064))))) {
                        const method_ty_4069 = List$assoc(_mml$short_4060, class_def.class_methods);
                        let _t4072;
                        const _t4071 = List$assoc_opt(name, vars);
                        _t4073: {
                          if (_t4071._tag === 1) {
                            const r = _t4071;
                            _t4072 = r;
                            break _t4073;
                          }
                          if (_t4071._tag === 0) {
                            _t4072 = List$assoc_opt(_mml$short_4060, vars);
                            break _t4073;
                          }
                          _match_fail("line 15950");
                        }
                        const var_sch_4074 = _t4072;
                        let _t4077;
                        const _t4076 = var_sch_4074;
                        _t4078: {
                          if (_t4076._tag === 1) {
                            const s = _t4076._val;
                            let _t4079;
                            if (_eq(s.body, method_ty_4069)) {
                              _t4079 = [({_tag: 1, _name: "Some", _val: class_def}), _mml$short_4060];
                            } else {
                              _t4079 = [({_tag: 0, _name: "None"}), name];
                            }
                            _t4077 = _t4079;
                            break _t4078;
                          }
                          if (_t4076._tag === 0) {
                            _t4077 = [({_tag: 0, _name: "None"}), name];
                            break _t4078;
                          }
                          _match_fail("line 15950");
                        }
                        const _t4075 = _t4077;
                        const _t4070 = _t4075;
                        _t4067 = _t4070;
                        break _t4068;
                      }
                    }
                    if (true) {
                      _t4067 = [({_tag: 0, _name: "None"}), name];
                      break _t4068;
                    }
                    _match_fail("line 15950");
                  }
                  const _t4065 = _t4067;
                  const _t4063 = _t4065;
                  const _t4061 = _t4063;
                  _t4058 = _t4061;
                  break _t4059;
                }
                _match_fail("line 15950");
              }
              _t4049 = _t4058;
              break _t4050;
            }
            _match_fail("line 15950");
          }
          let _t4081;
          const _t4080 = _t4049;
          _t4082: {
            if (true) {
              const class_match = _t4080[0];
              const method_name = _t4080[1];
              let _t4084;
              const _t4083 = class_match;
              _t4085: {
                if (_t4083._tag === 1) {
                  const class_def = _t4083._val;
                  const method_schema_ty_4086 = List$assoc(method_name, class_def.class_methods);
                  const num_params_4088 = List$length(class_def.class_params);
                  const param_map_4090 = Hashtbl$create(num_params_4088);
                  function go(s, r) {
                    while (true) {
                      const r_4092 = Types$repr(r);
                      let _t4095;
                      const _t4094 = [s, r_4092];
                      _t4096: {
                        if (_t4094[0]._tag === 17) {
                          const i = _t4094[0]._val;
                          if ((i < num_params_4088)) {
                            let _t4097;
                            if ((!_call(Hashtbl$has, [__dict_Hash_int, __dict_Eq_int, param_map_4090, i]))) {
                              _t4097 = _call(Hashtbl$set, [__dict_Hash_int, __dict_Eq_int, param_map_4090, i, r_4092]);
                            } else {
                              _t4097 = undefined;
                            }
                            _t4095 = _t4097;
                            break _t4096;
                          }
                        }
                        if ((_t4094[0]._tag === 7 && _t4094[1]._tag === 7 || _t4094[0]._tag === 8 && _t4094[1]._tag === 8)) {
                          const s1 = _t4094[0]._val[0];
                          const s2 = _t4094[0]._val[2];
                          const r1 = _t4094[1]._val[0];
                          const r2 = _t4094[1]._val[2];
                          go(s1, r1);
                          const _t4098 = s2;
                          const _t4099 = r2;
                          s = _t4098;
                          r = _t4099;
                          continue;
                          _t4095 = undefined;
                          break _t4096;
                        }
                        if (_t4094[0]._tag === 9 && _t4094[1]._tag === 9) {
                          const ss = _t4094[0]._val;
                          const rs = _t4094[1]._val;
                          if ((List$length(ss) === List$length(rs))) {
                            _t4095 = List$iter2(go, ss, rs);
                            break _t4096;
                          }
                        }
                        if (_t4094[0]._tag === 10 && _t4094[1]._tag === 10) {
                          const s1 = _t4094[0]._val;
                          const r1 = _t4094[1]._val;
                          const _t4100 = s1;
                          const _t4101 = r1;
                          s = _t4100;
                          r = _t4101;
                          continue;
                          _t4095 = undefined;
                          break _t4096;
                        }
                        if (_t4094[0]._tag === 14 && _t4094[1]._tag === 14) {
                          const s1 = _t4094[0]._val;
                          const r1 = _t4094[1]._val;
                          const _t4102 = s1;
                          const _t4103 = r1;
                          s = _t4102;
                          r = _t4103;
                          continue;
                          _t4095 = undefined;
                          break _t4096;
                        }
                        if (_t4094[0]._tag === 13 && _t4094[1]._tag === 13) {
                          const sk = _t4094[0]._val[0];
                          const sv = _t4094[0]._val[1];
                          const rk = _t4094[1]._val[0];
                          const rv = _t4094[1]._val[1];
                          go(sk, rk);
                          const _t4104 = sv;
                          const _t4105 = rv;
                          s = _t4104;
                          r = _t4105;
                          continue;
                          _t4095 = undefined;
                          break _t4096;
                        }
                        if (_t4094[0]._tag === 12 && _t4094[1]._tag === 12) {
                          const ss = _t4094[0]._val[1];
                          const rs = _t4094[1]._val[1];
                          if ((List$length(ss) === List$length(rs))) {
                            _t4095 = List$iter2(go, ss, rs);
                            break _t4096;
                          }
                        }
                        if (true) {
                          _t4095 = undefined;
                          break _t4096;
                        }
                        _match_fail("line 15950");
                      }
                      const _t4093 = _t4095;
                      return _t4093;
                    }
                  }
                  go(method_schema_ty_4086, te.ty);
                  function _t4107(i) {
                    let _t4109;
                    const _t4108 = _call(Hashtbl$get, [__dict_Hash_int, __dict_Eq_int, param_map_4090, i]);
                    _t4110: {
                      if (_t4108._tag === 1 && _t4108._val._tag === 16 && _t4108._val._val.contents._tag === 0) {
                        const id = _t4108._val._val.contents._val[0];
                        const tv = _t4108._val;
                        let _t4112;
                        const _t4111 = _call(Hashtbl$get, [__dict_Hash_int, __dict_Eq_int, id_map_3872, id]);
                        _t4113: {
                          if (_t4111._tag === 1 && _t4111._val._tag === 17) {
                            const tgen_idx = _t4111._val._val;
                            _t4112 = ({_tag: 1, _name: "Some", _val: ({_tag: 0, _name: "CATGen", _val: tgen_idx})});
                            break _t4113;
                          }
                          if (true) {
                            function _t4114(fd) {
                              return List$mem(i, fd.fd_to);
                            }
                            const is_fundep_target_4115 = List$exists(_t4114, class_def.class_fundeps);
                            let _t4117;
                            if (is_fundep_target_4115) {
                              let _t4119;
                              const _t4118 = _call(Hashtbl$get, [__dict_Hash_int, __dict_Eq_int, tvar_to_phantom_3957, id]);
                              _t4120: {
                                if (_t4118._tag === 1) {
                                  const idx = _t4118._val;
                                  _t4119 = idx;
                                  break _t4120;
                                }
                                if (_t4118._tag === 0) {
                                  const idx_4121 = Ref$get(phantom_counter_3955);
                                  Ref$set(phantom_counter_3955, (Ref$get(phantom_counter_3955) + 1));
                                  _call(Hashtbl$set, [__dict_Hash_int, __dict_Eq_int, tvar_to_phantom_3957, id, idx_4121]);
                                  const _t4122 = idx_4121;
                                  _t4119 = _t4122;
                                  break _t4120;
                                }
                                _match_fail("line 15950");
                              }
                              const phantom_idx_4123 = _t4119;
                              const _t4124 = ({_tag: 1, _name: "Some", _val: ({_tag: 3, _name: "CAPhantom", _val: [phantom_idx_4123, tv]})});
                              _t4117 = _t4124;
                            } else {
                              _t4117 = ({_tag: 1, _name: "Some", _val: ({_tag: 1, _name: "CATy", _val: tv})});
                            }
                            const _t4116 = _t4117;
                            _t4112 = _t4116;
                            break _t4113;
                          }
                          _match_fail("line 15950");
                        }
                        _t4109 = _t4112;
                        break _t4110;
                      }
                      if (_t4108._tag === 1) {
                        const ty = _t4108._val;
                        _t4109 = ({_tag: 1, _name: "Some", _val: ({_tag: 1, _name: "CATy", _val: ty})});
                        break _t4110;
                      }
                      if (_t4108._tag === 0) {
                        function _t4125(fd) {
                          return List$mem(i, fd.fd_to);
                        }
                        const is_fundep_target_4126 = List$exists(_t4125, class_def.class_fundeps);
                        let _t4128;
                        if (is_fundep_target_4126) {
                          _t4128 = ({_tag: 1, _name: "Some", _val: ({_tag: 2, _name: "CAWild"})});
                        } else {
                          _t4128 = ({_tag: 0, _name: "None"});
                        }
                        const _t4127 = _t4128;
                        _t4109 = _t4127;
                        break _t4110;
                      }
                      _match_fail("line 15950");
                    }
                    return _t4109;
                  }
                  const cc_args_4129 = List$init(num_params_4088, _t4107);
                  function _t4131(opt) {
                    let _t4133;
                    const _t4132 = opt;
                    _t4134: {
                      if (_t4132._tag === 1 && _t4132._val._tag === 1) {
                        const ty = _t4132._val._val;
                        _t4133 = (!Types$is_concrete(ty));
                        break _t4134;
                      }
                      if (true) {
                        _t4133 = false;
                        break _t4134;
                      }
                      _match_fail("line 15950");
                    }
                    return _t4133;
                  }
                  const has_nonconc_caty_4135 = List$exists(_t4131, cc_args_4129);
                  function _t4137(opt) {
                    let _t4139;
                    const _t4138 = opt;
                    _t4140: {
                      if (_t4138._tag === 1 && _t4138._val._tag === 1) {
                        _t4139 = true;
                        break _t4140;
                      }
                      if (true) {
                        _t4139 = false;
                        break _t4140;
                      }
                      _match_fail("line 15950");
                    }
                    return _t4139;
                  }
                  const has_any_caty_4141 = List$exists(_t4137, cc_args_4129);
                  let _t4143;
                  if (has_nonconc_caty_4135) {
                    function _t4144(opt) {
                      let _t4146;
                      const _t4145 = opt;
                      _t4147: {
                        if (_t4145._tag === 1 && _t4145._val._tag === 2) {
                          _t4146 = ({_tag: 0, _name: "None"});
                          break _t4147;
                        }
                        if (_t4145._tag === 1 && _t4145._val._tag === 3) {
                          _t4146 = ({_tag: 0, _name: "None"});
                          break _t4147;
                        }
                        if (true) {
                          _t4146 = opt;
                          break _t4147;
                        }
                        _match_fail("line 15950");
                      }
                      return _t4146;
                    }
                    _t4143 = List$map(_t4144, cc_args_4129);
                  } else {
                    _t4143 = cc_args_4129;
                  }
                  const cc_args_4148 = _t4143;
                  function _t4150(opt) {
                    let _t4152;
                    const _t4151 = opt;
                    _t4153: {
                      if (_t4151._tag === 1 && _t4151._val._tag === 0) {
                        _t4152 = true;
                        break _t4153;
                      }
                      if (true) {
                        _t4152 = false;
                        break _t4153;
                      }
                      _match_fail("line 15950");
                    }
                    return _t4152;
                  }
                  const has_tgen_4154 = List$exists(_t4150, cc_args_4148);
                  const has_caty_4156 = has_any_caty_4141;
                  function _t4158(opt) {
                    return !_eq(opt, ({_tag: 0, _name: "None"}));
                  }
                  const all_resolved_4159 = List$forall(_t4158, cc_args_4148);
                  let _t4166;
                  if (has_tgen_4154) {
                  let _t4165;
                  if (all_resolved_4159) {
                  let _t4164;
                  if ((!has_caty_4156)) {
                    _t4164 = true;
                  } else {
                  let _t4162;
                  const _t4161 = scheme.body;
                  _t4163: {
                    if ((_t4161._tag === 7 || _t4161._tag === 8)) {
                      _t4162 = true;
                      break _t4163;
                    }
                    if (true) {
                      _t4162 = false;
                      break _t4163;
                    }
                    _match_fail("line 15950");
                  }
                    _t4164 = _t4162;
                  }
                    _t4165 = _t4164;
                  } else {
                    _t4165 = false;
                  }
                    _t4166 = _t4165;
                  } else {
                    _t4166 = false;
                  }
                  const allow_4167 = _t4166;
                  let _t4169;
                  if (allow_4167) {
                    function _t4170(x) {
                      return x;
                    }
                    const cc_args_4171 = List$filter_map(_t4170, cc_args_4148);
                    const _t4172 = set_add_3962(found_multi_3951, [class_def.class_name, cc_args_4171]);
                    _t4169 = _t4172;
                  } else {
                    let _t4173;
                    if (((!has_tgen_4154) && all_resolved_4159)) {
                      function _t4174(opt) {
                        let _t4176;
                        const _t4175 = opt;
                        _t4177: {
                          if (_t4175._tag === 1 && _t4175._val._tag === 1 && _t4175._val._val._tag === 16 && _t4175._val._val._val.contents._tag === 0) {
                            _t4176 = true;
                            break _t4177;
                          }
                          if (true) {
                            _t4176 = false;
                            break _t4177;
                          }
                          _match_fail("line 15950");
                        }
                        return _t4176;
                      }
                      const has_unbound_caty_4178 = List$exists(_t4174, cc_args_4148);
                      let _t4181;
                      const _t4180 = scheme.body;
                      _t4182: {
                        if ((_t4180._tag === 7 || _t4180._tag === 8)) {
                          _t4181 = true;
                          break _t4182;
                        }
                        if (true) {
                          _t4181 = false;
                          break _t4182;
                        }
                        _match_fail("line 15950");
                      }
                      const is_arrow_4183 = _t4181;
                      let _t4185;
                      if ((has_unbound_caty_4178 && is_arrow_4183)) {
                        function _t4186(x) {
                          return x;
                        }
                        const cc_args_4187 = List$filter_map(_t4186, cc_args_4148);
                        const _t4188 = set_add_3962(pending_caty_3953, [class_def.class_name, cc_args_4187]);
                        _t4185 = _t4188;
                      } else {
                        _t4185 = undefined;
                      }
                      const _t4184 = _t4185;
                      const _t4179 = _t4184;
                      _t4173 = _t4179;
                    } else {
                      _t4173 = undefined;
                    }
                    _t4169 = _t4173;
                  }
                  const _t4168 = _t4169;
                  const _t4160 = _t4168;
                  const _t4157 = _t4160;
                  const _t4155 = _t4157;
                  const _t4149 = _t4155;
                  const _t4142 = _t4149;
                  const _t4136 = _t4142;
                  const _t4130 = _t4136;
                  const _t4106 = _t4130;
                  const _t4091 = _t4106;
                  const _t4089 = _t4091;
                  const _t4087 = _t4089;
                  _t4084 = _t4087;
                  break _t4085;
                }
                if (_t4083._tag === 0) {
                  _t4084 = undefined;
                  break _t4085;
                }
                _match_fail("line 15950");
              }
              _t4081 = _t4084;
              break _t4082;
            }
            _match_fail("line 15950");
          }
          _t4040 = _t4081;
          break _t4041;
        }
        if (true) {
          _t4040 = undefined;
          break _t4041;
        }
        _match_fail("line 15950");
      }
      _t4040;
      return walk_children(locals, te);
    }
    function walk_children(locals, te) {
      let _t4190;
      const _t4189 = te.expr;
      _t4191: {
        if ((((((((((_t4189._tag === 0 || _t4189._tag === 1) || _t4189._tag === 2) || _t4189._tag === 3) || _t4189._tag === 4) || _t4189._tag === 5) || _t4189._tag === 6) || _t4189._tag === 7) || _t4189._tag === 22) || _t4189._tag === 34)) {
          _t4190 = undefined;
          break _t4191;
        }
        if ((_t4189._tag === 8 && _t4189._val[1]._tag === 1 || _t4189._tag === 9 && _t4189._val[1]._tag === 1)) {
          const name = _t4189._val[0];
          const sch = _t4189._val[1]._val;
          const _e1 = _t4189._val[2];
          const e2 = _t4189._val[3];
          _t4190 = walk(({_hd: [name, sch], _tl: locals}), e2);
          break _t4191;
        }
        if ((_t4189._tag === 8 && _t4189._val[1]._tag === 0 || _t4189._tag === 9 && _t4189._val[1]._tag === 0)) {
          const name = _t4189._val[0];
          const e1 = _t4189._val[2];
          const e2 = _t4189._val[3];
          let _t4193;
          const _t4192 = Types$repr(e1.ty);
          _t4194: {
            if (_t4192._tag === 16 && _t4192._val.contents._tag === 0) {
              let _t4196;
              const _t4195 = Typechecker$find_var_type_in(name, e2);
              _t4197: {
                if (_t4195._tag === 1) {
                  const inst_ty = _t4195._val;
                  let _t4199;
                  const _t4198 = Types$repr(inst_ty);
                  _t4200: {
                    if (_t4198._tag === 16 && _t4198._val.contents._tag === 0) {
                      _t4199 = Types$unify(e1.ty, inst_ty);
                      break _t4200;
                    }
                    if (true) {
                      _t4199 = undefined;
                      break _t4200;
                    }
                    _match_fail("line 15950");
                  }
                  _t4196 = _t4199;
                  break _t4197;
                }
                if (_t4195._tag === 0) {
                  _t4196 = undefined;
                  break _t4197;
                }
                _match_fail("line 15950");
              }
              _t4193 = _t4196;
              break _t4194;
            }
            if (true) {
              _t4193 = undefined;
              break _t4194;
            }
            _match_fail("line 15950");
          }
          _t4193;
          walk(locals, e1);
          _t4190 = walk(locals, e2);
          break _t4191;
        }
        if ((((((((_t4189._tag === 25 || _t4189._tag === 13) || _t4189._tag === 21) || _t4189._tag === 28) || _t4189._tag === 32) || _t4189._tag === 31) || _t4189._tag === 27) || _t4189._tag === 20)) {
          const e1 = (((((((_t4189._tag === 25 || _t4189._tag === 13) || _t4189._tag === 21) || _t4189._tag === 28) || _t4189._tag === 32) || _t4189._tag === 31) || _t4189._tag === 27) ? ((((((_t4189._tag === 25 || _t4189._tag === 13) || _t4189._tag === 21) || _t4189._tag === 28) || _t4189._tag === 32) || _t4189._tag === 31) ? (((((_t4189._tag === 25 || _t4189._tag === 13) || _t4189._tag === 21) || _t4189._tag === 28) || _t4189._tag === 32) ? ((((_t4189._tag === 25 || _t4189._tag === 13) || _t4189._tag === 21) || _t4189._tag === 28) ? (((_t4189._tag === 25 || _t4189._tag === 13) || _t4189._tag === 21) ? ((_t4189._tag === 25 || _t4189._tag === 13) ? _t4189._val[1] : _t4189._val[0]) : _t4189._val[0]) : _t4189._val[0]) : _t4189._val[0]) : _t4189._val[0]) : _t4189._val[0]);
          const e2 = (((((((_t4189._tag === 25 || _t4189._tag === 13) || _t4189._tag === 21) || _t4189._tag === 28) || _t4189._tag === 32) || _t4189._tag === 31) || _t4189._tag === 27) ? ((((((_t4189._tag === 25 || _t4189._tag === 13) || _t4189._tag === 21) || _t4189._tag === 28) || _t4189._tag === 32) || _t4189._tag === 31) ? (((((_t4189._tag === 25 || _t4189._tag === 13) || _t4189._tag === 21) || _t4189._tag === 28) || _t4189._tag === 32) ? ((((_t4189._tag === 25 || _t4189._tag === 13) || _t4189._tag === 21) || _t4189._tag === 28) ? (((_t4189._tag === 25 || _t4189._tag === 13) || _t4189._tag === 21) ? ((_t4189._tag === 25 || _t4189._tag === 13) ? _t4189._val[2] : _t4189._val[1]) : _t4189._val[1]) : _t4189._val[1]) : _t4189._val[1]) : _t4189._val[2]) : _t4189._val[1]);
          walk(locals, e1);
          _t4190 = walk(locals, e2);
          break _t4191;
        }
        if (_t4189._tag === 11) {
          const fn_ = _t4189._val[0];
          const arg = _t4189._val[1];
          walk(locals, fn_);
          _t4190 = walk(locals, arg);
          break _t4191;
        }
        if (((((((((_t4189._tag === 29 || _t4189._tag === 14) || _t4189._tag === 10) || _t4189._tag === 19) || _t4189._tag === 33) || _t4189._tag === 35) || _t4189._tag === 36) || _t4189._tag === 40) || _t4189._tag === 26)) {
          const e = ((((((((_t4189._tag === 29 || _t4189._tag === 14) || _t4189._tag === 10) || _t4189._tag === 19) || _t4189._tag === 33) || _t4189._tag === 35) || _t4189._tag === 36) || _t4189._tag === 40) ? (((((((_t4189._tag === 29 || _t4189._tag === 14) || _t4189._tag === 10) || _t4189._tag === 19) || _t4189._tag === 33) || _t4189._tag === 35) || _t4189._tag === 36) ? ((((((_t4189._tag === 29 || _t4189._tag === 14) || _t4189._tag === 10) || _t4189._tag === 19) || _t4189._tag === 33) || _t4189._tag === 35) ? (((((_t4189._tag === 29 || _t4189._tag === 14) || _t4189._tag === 10) || _t4189._tag === 19) || _t4189._tag === 33) ? ((((_t4189._tag === 29 || _t4189._tag === 14) || _t4189._tag === 10) || _t4189._tag === 19) ? (((_t4189._tag === 29 || _t4189._tag === 14) || _t4189._tag === 10) ? _t4189._val[1] : _t4189._val[0]) : _t4189._val) : _t4189._val) : _t4189._val) : _t4189._val) : _t4189._val[1]);
          _t4190 = walk(locals, e);
          break _t4191;
        }
        if (_t4189._tag === 12) {
          const c = _t4189._val[0];
          const t = _t4189._val[1];
          const e = _t4189._val[2];
          walk(locals, c);
          walk(locals, t);
          _t4190 = walk(locals, e);
          break _t4191;
        }
        if ((_t4189._tag === 15 || _t4189._tag === 39)) {
          const es = _t4189._val;
          _t4190 = List$iter(_call(walk, [locals]), es);
          break _t4191;
        }
        if (_t4189._tag === 38) {
          const kvs = _t4189._val;
          function _t4201(__p56) {
            let _t4203;
            const _t4202 = __p56;
            _t4204: {
              if (true) {
                const k = _t4202[0];
                const v = _t4202[1];
                walk(locals, k);
                _t4203 = walk(locals, v);
                break _t4204;
              }
              _match_fail("line 15950");
            }
            return _t4203;
          }
          _t4190 = List$iter(_t4201, kvs);
          break _t4191;
        }
        if (_t4189._tag === 16) {
          const fields = _t4189._val;
          function _t4205(__p57) {
            let _t4207;
            const _t4206 = __p57;
            _t4208: {
              if (true) {
                const e = _t4206[1];
                _t4207 = walk(locals, e);
                break _t4208;
              }
              _match_fail("line 15950");
            }
            return _t4207;
          }
          _t4190 = List$iter(_t4205, fields);
          break _t4191;
        }
        if (_t4189._tag === 17) {
          const base = _t4189._val[0];
          const overrides = _t4189._val[1];
          walk(locals, base);
          function _t4209(__p58) {
            let _t4211;
            const _t4210 = __p58;
            _t4212: {
              if (true) {
                const e = _t4210[1];
                _t4211 = walk(locals, e);
                break _t4212;
              }
              _match_fail("line 15950");
            }
            return _t4211;
          }
          _t4190 = List$iter(_t4209, overrides);
          break _t4191;
        }
        if (_t4189._tag === 18) {
          const base = _t4189._val[0];
          const pairs = _t4189._val[1];
          walk(locals, base);
          function _t4213(__p59) {
            let _t4215;
            const _t4214 = __p59;
            _t4216: {
              if (true) {
                const i = _t4214[0];
                const v = _t4214[1];
                walk(locals, i);
                _t4215 = walk(locals, v);
                break _t4216;
              }
              _match_fail("line 15950");
            }
            return _t4215;
          }
          _t4190 = List$iter(_t4213, pairs);
          break _t4191;
        }
        if (_t4189._tag === 23) {
          const arg = _t4189._val[1];
          _t4190 = Option$iter(_call(walk, [locals]), arg);
          break _t4191;
        }
        if (_t4189._tag === 24) {
          const scrutinee = _t4189._val[0];
          const arms = _t4189._val[1];
          walk(locals, scrutinee);
          function _t4217(__p60) {
            let _t4219;
            const _t4218 = __p60;
            _t4220: {
              if (true) {
                const guard = _t4218[1];
                const body = _t4218[2];
                Option$iter(_call(walk, [locals]), guard);
                _t4219 = walk(locals, body);
                break _t4220;
              }
              _match_fail("line 15950");
            }
            return _t4219;
          }
          _t4190 = List$iter(_t4217, arms);
          break _t4191;
        }
        if (_t4189._tag === 30) {
          const body = _t4189._val[0];
          const arms = _t4189._val[1];
          walk(locals, body);
          function _t4221(arm) {
            let _t4223;
            const _t4222 = arm;
            _t4224: {
              if (_t4222._tag === 0) {
                const e = _t4222._val[1];
                _t4223 = walk(locals, e);
                break _t4224;
              }
              if (_t4222._tag === 1) {
                const e = _t4222._val[3];
                _t4223 = walk(locals, e);
                break _t4224;
              }
              _match_fail("line 15950");
            }
            return _t4223;
          }
          _t4190 = List$iter(_t4221, arms);
          break _t4191;
        }
        if (_t4189._tag === 37) {
          const bindings = _t4189._val[0];
          const body = _t4189._val[1];
          function _t4225(__p61) {
            let _t4227;
            const _t4226 = __p61;
            _t4228: {
              if (true) {
                const e = _t4226[1];
                _t4227 = walk(locals, e);
                break _t4228;
              }
              _match_fail("line 15950");
            }
            return _t4227;
          }
          List$iter(_t4225, bindings);
          _t4190 = walk(locals, body);
          break _t4191;
        }
        _match_fail("line 15950");
      }
      return _t4190;
    }
    walk(null, te);
    const changed_4230 = Ref$create(true);
    let _t4232 = undefined;
    let _t4233 = false, _t4234;
    while (true) {
      if (!(Ref$get(changed_4230))) break;
      Ref$set(changed_4230, false);
      function _t4235(acc, __p62) {
        let _t4237;
        const _t4236 = __p62;
        _t4238: {
          if (true) {
            const cls = _t4236[0];
            const args = _t4236[1];
            function _t4239(ca) {
              let _t4241;
              const _t4240 = ca;
              _t4242: {
                if (_t4240._tag === 1 && _t4240._val._tag === 16 && _t4240._val._val.contents._tag === 0) {
                  const id = _t4240._val._val.contents._val[0];
                  function _t4243(__p63) {
                    let _t4245;
                    const _t4244 = __p63;
                    _t4246: {
                      if (true) {
                        const _c = _t4244[0];
                        const fargs = _t4244[1];
                        function _t4247(fa) {
                          let _t4249;
                          const _t4248 = fa;
                          _t4250: {
                            if (_t4248._tag === 1 && _t4248._val._tag === 16 && _t4248._val._val.contents._tag === 0) {
                              const fid = _t4248._val._val.contents._val[0];
                              _t4249 = (fid === id);
                              break _t4250;
                            }
                            if (_t4248._tag === 3 && _t4248._val[1]._tag === 16 && _t4248._val[1]._val.contents._tag === 0) {
                              const fid = _t4248._val[1]._val.contents._val[0];
                              _t4249 = (fid === id);
                              break _t4250;
                            }
                            if (true) {
                              _t4249 = false;
                              break _t4250;
                            }
                            _match_fail("line 15950");
                          }
                          return _t4249;
                        }
                        _t4245 = List$exists(_t4247, fargs);
                        break _t4246;
                      }
                      _match_fail("line 15950");
                    }
                    return _t4245;
                  }
                  _t4241 = List$exists(_t4243, Ref$get(found_multi_3951));
                  break _t4242;
                }
                if (true) {
                  _t4241 = false;
                  break _t4242;
                }
                _match_fail("line 15950");
              }
              return _t4241;
            }
            const dominated_4251 = List$exists(_t4239, args);
            let _t4253;
            if (dominated_4251) {
              _t4253 = ({_hd: [cls, args], _tl: acc});
            } else {
              _t4253 = acc;
            }
            const _t4252 = _t4253;
            _t4237 = _t4252;
            break _t4238;
          }
          _match_fail("line 15950");
        }
        return _t4237;
      }
      const to_promote_4254 = List$fold(_t4235, null, Ref$get(pending_caty_3953));
      function _t4256(__p64) {
        let _t4258;
        const _t4257 = __p64;
        _t4259: {
          if (true) {
            const cls = _t4257[0];
            const args = _t4257[1];
            function _t4260(ca) {
              let _t4262;
              const _t4261 = ca;
              _t4263: {
                if (_t4261._tag === 1 && _t4261._val._tag === 16 && _t4261._val._val.contents._tag === 0) {
                  const id = _t4261._val._val.contents._val[0];
                  const tv = _t4261._val;
                  const phantom_idx_4264 = Ref$create(({_tag: 0, _name: "None"}));
                  function _t4266(__p65) {
                    let _t4268;
                    const _t4267 = __p65;
                    _t4269: {
                      if (true) {
                        const _c = _t4267[0];
                        const fargs = _t4267[1];
                        function _t4270(fa) {
                          let _t4272;
                          const _t4271 = fa;
                          _t4273: {
                            if (_t4271._tag === 3 && _t4271._val[1]._tag === 16 && _t4271._val[1]._val.contents._tag === 0) {
                              const idx = _t4271._val[0];
                              const fid = _t4271._val[1]._val.contents._val[0];
                              if ((fid === id)) {
                                _t4272 = Ref$set(phantom_idx_4264, ({_tag: 1, _name: "Some", _val: idx}));
                                break _t4273;
                              }
                            }
                            if (true) {
                              _t4272 = undefined;
                              break _t4273;
                            }
                            _match_fail("line 15950");
                          }
                          return _t4272;
                        }
                        _t4268 = List$iter(_t4270, fargs);
                        break _t4269;
                      }
                      _match_fail("line 15950");
                    }
                    return _t4268;
                  }
                  List$iter(_t4266, Ref$get(found_multi_3951));
                  let _t4275;
                  const _t4274 = Ref$get(phantom_idx_4264);
                  _t4276: {
                    if (_t4274._tag === 1) {
                      const idx = _t4274._val;
                      _t4275 = ({_tag: 3, _name: "CAPhantom", _val: [idx, tv]});
                      break _t4276;
                    }
                    if (_t4274._tag === 0) {
                      _t4275 = ca;
                      break _t4276;
                    }
                    _match_fail("line 15950");
                  }
                  const _t4265 = _t4275;
                  _t4262 = _t4265;
                  break _t4263;
                }
                if (true) {
                  _t4262 = ca;
                  break _t4263;
                }
                _match_fail("line 15950");
              }
              return _t4262;
            }
            const promoted_args_4277 = List$map(_t4260, args);
            function _t4279(k) {
              return !_eq(k, [cls, args]);
            }
            Ref$set(pending_caty_3953, List$filter(_t4279, Ref$get(pending_caty_3953)));
            set_add_3962(found_multi_3951, [cls, promoted_args_4277]);
            const _t4278 = Ref$set(changed_4230, true);
            _t4258 = _t4278;
            break _t4259;
          }
          _match_fail("line 15950");
        }
        return _t4258;
      }
      const _t4255 = List$iter(_t4256, to_promote_4254);
      _t4255;
      if (_t4233) break;
    }
    _t4232 = _t4233 ? _t4234 : undefined;
    _t4232;
    function _t4280(acc, __p66) {
      let _t4282;
      const _t4281 = __p66;
      _t4283: {
        if (true) {
          const class_name = _t4281[0];
          const cc_args = _t4281[1];
          function _t4284(cc) {
            return ((cc.cc_class === class_name) && _eq(cc.cc_args, cc_args));
          }
          const exists_4285 = List$exists(_t4284, acc);
          let _t4287;
          if (exists_4285) {
            _t4287 = acc;
          } else {
            _t4287 = ({_hd: ({cc_args: cc_args, cc_class: class_name}), _tl: acc});
          }
          const _t4286 = _t4287;
          _t4282 = _t4286;
          break _t4283;
        }
        _match_fail("line 15950");
      }
      return _t4282;
    }
    const cc_list_4288 = List$fold(_t4280, null, Ref$get(found_multi_3951));
    let _t4290;
    if (_eq(cc_list_4288, null)) {
      _t4290 = scheme;
    } else {
      function _t4291(a, b) {
        function _t4292(args) {
          function _t4293(ca) {
            let _t4295;
            const _t4294 = ca;
            _t4296: {
              if (_t4294._tag === 0) {
                _t4295 = true;
                break _t4296;
              }
              if (true) {
                _t4295 = false;
                break _t4296;
              }
              _match_fail("line 15950");
            }
            return _t4295;
          }
          return List$length(List$filter(_t4293, args));
        }
        const count_catgen_4297 = _t4292;
        const _t4298 = compare(count_catgen_4297(b.cc_args), count_catgen_4297(a.cc_args));
        return _t4298;
      }
      const cc_list_4299 = List$sort(_t4291, cc_list_4288);
      const __rec_upd_4301 = scheme;
      const _t4302 = ({body: __rec_upd_4301.body, constraints: cc_list_4299, equant: __rec_upd_4301.equant, pvquant: __rec_upd_4301.pvquant, quant: __rec_upd_4301.quant, record_evidences: __rec_upd_4301.record_evidences, rquant: __rec_upd_4301.rquant});
      const _t4300 = _t4302;
      _t4290 = _t4300;
    }
    const _t4289 = _t4290;
    const _t4231 = _t4289;
    const _t4229 = _t4231;
    const _t4038 = _t4229;
    const _t3963 = _t4038;
    const _t3958 = _t3963;
    const _t3956 = _t3958;
    const _t3954 = _t3956;
    const _t3952 = _t3954;
    const _t3950 = _t3952;
    const _t3873 = _t3950;
    _t3871 = _t3873;
  }
  return _t3871;
}
function Typechecker$build_rgen_map(schema_ty, actual_ty) {
  const map_4303 = Hashtbl$create(4);
  function walk(s, a) {
    while (true) {
      const a_4305 = Types$repr(a);
      let _t4308;
      const _t4307 = s;
      _t4309: {
        if (_t4307._tag === 7) {
          const s1 = _t4307._val[0];
          const s2 = _t4307._val[2];
          let _t4311;
          const _t4310 = a_4305;
          _t4312: {
            if (_t4310._tag === 7) {
              const a1 = _t4310._val[0];
              const a2 = _t4310._val[2];
              walk(s1, a1);
              const _t4313 = s2;
              const _t4314 = a2;
              s = _t4313;
              a = _t4314;
              continue;
              _t4311 = undefined;
              break _t4312;
            }
            if (true) {
              _t4311 = undefined;
              break _t4312;
            }
            _match_fail("line 15950");
          }
          _t4308 = _t4311;
          break _t4309;
        }
        if (_t4307._tag === 8) {
          const s1 = _t4307._val[0];
          const s2 = _t4307._val[2];
          let _t4316;
          const _t4315 = a_4305;
          _t4317: {
            if (_t4315._tag === 8) {
              const a1 = _t4315._val[0];
              const a2 = _t4315._val[2];
              walk(s1, a1);
              const _t4318 = s2;
              const _t4319 = a2;
              s = _t4318;
              a = _t4319;
              continue;
              _t4316 = undefined;
              break _t4317;
            }
            if (true) {
              _t4316 = undefined;
              break _t4317;
            }
            _match_fail("line 15950");
          }
          _t4308 = _t4316;
          break _t4309;
        }
        if (_t4307._tag === 9) {
          const ss = _t4307._val;
          let _t4321;
          const _t4320 = a_4305;
          _t4322: {
            if (_t4320._tag === 9) {
              const aa = _t4320._val;
              if ((List$length(ss) === List$length(aa))) {
                _t4321 = List$iter2(walk, ss, aa);
                break _t4322;
              }
            }
            if (true) {
              _t4321 = undefined;
              break _t4322;
            }
            _match_fail("line 15950");
          }
          _t4308 = _t4321;
          break _t4309;
        }
        if (_t4307._tag === 10) {
          const s1 = _t4307._val;
          let _t4324;
          const _t4323 = a_4305;
          _t4325: {
            if (_t4323._tag === 10) {
              const a1 = _t4323._val;
              const _t4326 = s1;
              const _t4327 = a1;
              s = _t4326;
              a = _t4327;
              continue;
              _t4324 = undefined;
              break _t4325;
            }
            if (true) {
              _t4324 = undefined;
              break _t4325;
            }
            _match_fail("line 15950");
          }
          _t4308 = _t4324;
          break _t4309;
        }
        if (_t4307._tag === 14) {
          const s1 = _t4307._val;
          let _t4329;
          const _t4328 = a_4305;
          _t4330: {
            if (_t4328._tag === 14) {
              const a1 = _t4328._val;
              const _t4331 = s1;
              const _t4332 = a1;
              s = _t4331;
              a = _t4332;
              continue;
              _t4329 = undefined;
              break _t4330;
            }
            if (true) {
              _t4329 = undefined;
              break _t4330;
            }
            _match_fail("line 15950");
          }
          _t4308 = _t4329;
          break _t4309;
        }
        if (_t4307._tag === 13) {
          const sk = _t4307._val[0];
          const sv = _t4307._val[1];
          let _t4334;
          const _t4333 = a_4305;
          _t4335: {
            if (_t4333._tag === 13) {
              const ak = _t4333._val[0];
              const av = _t4333._val[1];
              walk(sk, ak);
              const _t4336 = sv;
              const _t4337 = av;
              s = _t4336;
              a = _t4337;
              continue;
              _t4334 = undefined;
              break _t4335;
            }
            if (true) {
              _t4334 = undefined;
              break _t4335;
            }
            _match_fail("line 15950");
          }
          _t4308 = _t4334;
          break _t4309;
        }
        if (_t4307._tag === 12) {
          const ss = _t4307._val[1];
          let _t4339;
          const _t4338 = a_4305;
          _t4340: {
            if (_t4338._tag === 12) {
              const aa = _t4338._val[1];
              if ((List$length(ss) === List$length(aa))) {
                _t4339 = List$iter2(walk, ss, aa);
                break _t4340;
              }
            }
            if (true) {
              _t4339 = undefined;
              break _t4340;
            }
            _match_fail("line 15950");
          }
          _t4308 = _t4339;
          break _t4309;
        }
        if (_t4307._tag === 11) {
          const srow = _t4307._val;
          let _t4342;
          const _t4341 = a_4305;
          _t4343: {
            if (_t4341._tag === 11) {
              const arow = _t4341._val;
              walk_rrows(srow, arow);
              const sf_4344 = Types$record_row_to_fields(srow);
              const af_4346 = Types$record_row_to_fields(arow);
              function _t4348(__p67) {
                let _t4350;
                const _t4349 = __p67;
                _t4351: {
                  if (true) {
                    const name = _t4349[0];
                    const sty = _t4349[1];
                    let _t4353;
                    const _t4352 = List$assoc_opt(name, af_4346);
                    _t4354: {
                      if (_t4352._tag === 1) {
                        const aty = _t4352._val;
                        _t4353 = walk(sty, aty);
                        break _t4354;
                      }
                      if (_t4352._tag === 0) {
                        _t4353 = undefined;
                        break _t4354;
                      }
                      _match_fail("line 15950");
                    }
                    _t4350 = _t4353;
                    break _t4351;
                  }
                  _match_fail("line 15950");
                }
                return _t4350;
              }
              const _t4347 = List$iter(_t4348, sf_4344);
              const _t4345 = _t4347;
              _t4342 = _t4345;
              break _t4343;
            }
            if (true) {
              _t4342 = undefined;
              break _t4343;
            }
            _match_fail("line 15950");
          }
          _t4308 = _t4342;
          break _t4309;
        }
        if (true) {
          _t4308 = undefined;
          break _t4309;
        }
        _match_fail("line 15950");
      }
      const _t4306 = _t4308;
      return _t4306;
    }
  }
  function walk_rrows(srow, arow) {
    while (true) {
      let _t4356;
      const _t4355 = srow;
      _t4357: {
        if (_t4355._tag === 3) {
          const i = _t4355._val;
          let _t4358;
          if ((!_call(Hashtbl$has, [__dict_Hash_int, __dict_Eq_int, map_4303, i]))) {
            _t4358 = _call(Hashtbl$set, [__dict_Hash_int, __dict_Eq_int, map_4303, i, arow]);
          } else {
            _t4358 = undefined;
          }
          _t4356 = _t4358;
          break _t4357;
        }
        if (_t4355._tag === 0) {
          const stail = _t4355._val[2];
          const _t4359 = stail;
          const _t4360 = arow;
          srow = _t4359;
          arow = _t4360;
          continue;
          _t4356 = undefined;
          break _t4357;
        }
        if (true) {
          _t4356 = undefined;
          break _t4357;
        }
        _match_fail("line 15950");
      }
      return _t4356;
    }
  }
  walk(schema_ty, actual_ty);
  const _t4361 = map_4303;
  const _t4304 = _t4361;
  return _t4304;
}
function Typechecker$infer_record_evidence(vars, te, scheme) {
  let _t4362;
  if ((scheme.rquant === 0)) {
    _t4362 = scheme;
  } else {
    const rvar_to_rgen_4363 = Hashtbl$create(4);
    function walk_rmap(s, a) {
      while (true) {
        const a_4365 = Types$repr(a);
        let _t4368;
        const _t4367 = s;
        _t4369: {
          if (_t4367._tag === 7) {
            const s1 = _t4367._val[0];
            const s2 = _t4367._val[2];
            let _t4371;
            const _t4370 = a_4365;
            _t4372: {
              if (_t4370._tag === 7) {
                const a1 = _t4370._val[0];
                const a2 = _t4370._val[2];
                walk_rmap(s1, a1);
                const _t4373 = s2;
                const _t4374 = a2;
                s = _t4373;
                a = _t4374;
                continue;
                _t4371 = undefined;
                break _t4372;
              }
              if (true) {
                _t4371 = undefined;
                break _t4372;
              }
              _match_fail("line 15950");
            }
            _t4368 = _t4371;
            break _t4369;
          }
          if (_t4367._tag === 8) {
            const s1 = _t4367._val[0];
            const s2 = _t4367._val[2];
            let _t4376;
            const _t4375 = a_4365;
            _t4377: {
              if (_t4375._tag === 8) {
                const a1 = _t4375._val[0];
                const a2 = _t4375._val[2];
                walk_rmap(s1, a1);
                const _t4378 = s2;
                const _t4379 = a2;
                s = _t4378;
                a = _t4379;
                continue;
                _t4376 = undefined;
                break _t4377;
              }
              if (true) {
                _t4376 = undefined;
                break _t4377;
              }
              _match_fail("line 15950");
            }
            _t4368 = _t4376;
            break _t4369;
          }
          if (_t4367._tag === 9) {
            const ss = _t4367._val;
            let _t4381;
            const _t4380 = a_4365;
            _t4382: {
              if (_t4380._tag === 9) {
                const aa = _t4380._val;
                if ((List$length(ss) === List$length(aa))) {
                  _t4381 = List$iter2(walk_rmap, ss, aa);
                  break _t4382;
                }
              }
              if (true) {
                _t4381 = undefined;
                break _t4382;
              }
              _match_fail("line 15950");
            }
            _t4368 = _t4381;
            break _t4369;
          }
          if (_t4367._tag === 10) {
            const s1 = _t4367._val;
            let _t4384;
            const _t4383 = a_4365;
            _t4385: {
              if (_t4383._tag === 10) {
                const a1 = _t4383._val;
                const _t4386 = s1;
                const _t4387 = a1;
                s = _t4386;
                a = _t4387;
                continue;
                _t4384 = undefined;
                break _t4385;
              }
              if (true) {
                _t4384 = undefined;
                break _t4385;
              }
              _match_fail("line 15950");
            }
            _t4368 = _t4384;
            break _t4369;
          }
          if (_t4367._tag === 14) {
            const s1 = _t4367._val;
            let _t4389;
            const _t4388 = a_4365;
            _t4390: {
              if (_t4388._tag === 14) {
                const a1 = _t4388._val;
                const _t4391 = s1;
                const _t4392 = a1;
                s = _t4391;
                a = _t4392;
                continue;
                _t4389 = undefined;
                break _t4390;
              }
              if (true) {
                _t4389 = undefined;
                break _t4390;
              }
              _match_fail("line 15950");
            }
            _t4368 = _t4389;
            break _t4369;
          }
          if (_t4367._tag === 13) {
            const sk = _t4367._val[0];
            const sv = _t4367._val[1];
            let _t4394;
            const _t4393 = a_4365;
            _t4395: {
              if (_t4393._tag === 13) {
                const ak = _t4393._val[0];
                const av = _t4393._val[1];
                walk_rmap(sk, ak);
                const _t4396 = sv;
                const _t4397 = av;
                s = _t4396;
                a = _t4397;
                continue;
                _t4394 = undefined;
                break _t4395;
              }
              if (true) {
                _t4394 = undefined;
                break _t4395;
              }
              _match_fail("line 15950");
            }
            _t4368 = _t4394;
            break _t4369;
          }
          if (_t4367._tag === 12) {
            const ss = _t4367._val[1];
            let _t4399;
            const _t4398 = a_4365;
            _t4400: {
              if (_t4398._tag === 12) {
                const aa = _t4398._val[1];
                if ((List$length(ss) === List$length(aa))) {
                  _t4399 = List$iter2(walk_rmap, ss, aa);
                  break _t4400;
                }
              }
              if (true) {
                _t4399 = undefined;
                break _t4400;
              }
              _match_fail("line 15950");
            }
            _t4368 = _t4399;
            break _t4369;
          }
          if (_t4367._tag === 11) {
            const srow = _t4367._val;
            let _t4402;
            const _t4401 = a_4365;
            _t4403: {
              if (_t4401._tag === 11) {
                const arow = _t4401._val;
                _t4402 = walk_rmap_rrows(srow, arow);
                break _t4403;
              }
              if (true) {
                _t4402 = undefined;
                break _t4403;
              }
              _match_fail("line 15950");
            }
            _t4368 = _t4402;
            break _t4369;
          }
          if (true) {
            _t4368 = undefined;
            break _t4369;
          }
          _match_fail("line 15950");
        }
        const _t4366 = _t4368;
        return _t4366;
      }
    }
    function walk_rmap_rrows(srow, arow) {
      while (true) {
        let _t4405;
        const _t4404 = [srow, Types$rrow_repr(arow)];
        _t4406: {
          if (_t4404[0]._tag === 3 && _t4404[1]._tag === 1 && _t4404[1]._val.contents._tag === 0) {
            const i = _t4404[0]._val;
            const id = _t4404[1]._val.contents._val[0];
            _t4405 = _call(Hashtbl$set, [__dict_Hash_int, __dict_Eq_int, rvar_to_rgen_4363, id, i]);
            break _t4406;
          }
          if (_t4404[0]._tag === 0 && _t4404[1]._tag === 0) {
            const sty = _t4404[0]._val[1];
            const stail = _t4404[0]._val[2];
            const aty = _t4404[1]._val[1];
            const atail = _t4404[1]._val[2];
            walk_rmap(sty, aty);
            const _t4407 = stail;
            const _t4408 = atail;
            srow = _t4407;
            arow = _t4408;
            continue;
            _t4405 = undefined;
            break _t4406;
          }
          if (true) {
            _t4405 = undefined;
            break _t4406;
          }
          _match_fail("line 15950");
        }
        return _t4405;
      }
    }
    walk_rmap(scheme.body, te.ty);
    const found_evidences_4410 = Hashtbl$create(4);
    function _t4412(__dict_Hash_resolved_0, __dict_Eq_resolved_1, rgen_idx, fields) {
      let _t4414;
      const _t4413 = _call(Hashtbl$get, [__dict_Hash_int, __dict_Eq_int, found_evidences_4410, rgen_idx]);
      _t4415: {
        if (_t4413._tag === 1) {
          const fs = _t4413._val;
          _t4414 = fs;
          break _t4415;
        }
        if (_t4413._tag === 0) {
          _t4414 = null;
          break _t4415;
        }
        _match_fail("line 15950");
      }
      const existing_4416 = _t4414;
      function _t4418(fs, f) {
        let _t4419;
        if (List$mem(f, fs)) {
          _t4419 = fs;
        } else {
          _t4419 = ({_hd: f, _tl: fs});
        }
        return _t4419;
      }
      const merged_4420 = List$fold(_t4418, existing_4416, fields);
      const _t4421 = _call(Hashtbl$set, [__dict_Hash_int, __dict_Eq_int, found_evidences_4410, rgen_idx, merged_4420]);
      const _t4417 = _t4421;
      return _t4417;
    }
    const add_evidence_4422 = _t4412;
    function get_row_tail(row) {
      while (true) {
        let _t4425;
        const _t4424 = Types$rrow_repr(row);
        _t4426: {
          if (_t4424._tag === 0) {
            const tail = _t4424._val[2];
            const _t4427 = tail;
            row = _t4427;
            continue;
            _t4425 = undefined;
            break _t4426;
          }
          if (true) {
            const tail = _t4424;
            _t4425 = tail;
            break _t4426;
          }
          _match_fail("line 15950");
        }
        return _t4425;
      }
    }
    function walk(te) {
      let _t4430;
      const _t4429 = te.expr;
      _t4431: {
        if (_t4429._tag === 17) {
          const _base = _t4429._val[0];
          const overrides = _t4429._val[1];
          let _t4433;
          const _t4432 = Types$repr(te.ty);
          _t4434: {
            if (_t4432._tag === 11) {
              const row = _t4432._val;
              let _t4436;
              const _t4435 = get_row_tail(row);
              _t4437: {
                if (_t4435._tag === 1 && _t4435._val.contents._tag === 0) {
                  const id = _t4435._val.contents._val[0];
                  let _t4439;
                  const _t4438 = _call(Hashtbl$get, [__dict_Hash_int, __dict_Eq_int, rvar_to_rgen_4363, id]);
                  _t4440: {
                    if (_t4438._tag === 1) {
                      const rgen_idx = _t4438._val;
                      _t4439 = _call(add_evidence_4422, [__dict_Hash_int, __dict_Eq_int, rgen_idx, List$map(fst, overrides)]);
                      break _t4440;
                    }
                    if (_t4438._tag === 0) {
                      _t4439 = undefined;
                      break _t4440;
                    }
                    _match_fail("line 15950");
                  }
                  _t4436 = _t4439;
                  break _t4437;
                }
                if (true) {
                  _t4436 = undefined;
                  break _t4437;
                }
                _match_fail("line 15950");
              }
              _t4433 = _t4436;
              break _t4434;
            }
            if (true) {
              _t4433 = undefined;
              break _t4434;
            }
            _match_fail("line 15950");
          }
          _t4430 = _t4433;
          break _t4431;
        }
        if (_t4429._tag === 7) {
          const name = _t4429._val;
          let _t4442;
          const _t4441 = List$assoc_opt(name, vars);
          _t4443: {
            if (_t4441._tag === 1) {
              const callee_sch = _t4441._val;
              if (!_eq(callee_sch.record_evidences, null)) {
                const rgen_map_4444 = Typechecker$build_rgen_map(callee_sch.body, te.ty);
                function _t4446(re) {
                  let _t4448;
                  const _t4447 = _call(Hashtbl$get, [__dict_Hash_int, __dict_Eq_int, rgen_map_4444, re.re_rgen]);
                  _t4449: {
                    if (_t4447._tag === 1) {
                      const arow = _t4447._val;
                      function is_open(r) {
                        while (true) {
                          let _t4451;
                          const _t4450 = Types$rrow_repr(r);
                          _t4452: {
                            if (_t4450._tag === 0) {
                              const tail = _t4450._val[2];
                              const _t4453 = tail;
                              r = _t4453;
                              continue;
                              _t4451 = undefined;
                              break _t4452;
                            }
                            if (_t4450._tag === 1 && _t4450._val.contents._tag === 0) {
                              _t4451 = true;
                              break _t4452;
                            }
                            if (true) {
                              _t4451 = false;
                              break _t4452;
                            }
                            _match_fail("line 15950");
                          }
                          return _t4451;
                        }
                      }
                      let _t4455;
                      if (is_open(arow)) {
                        let _t4457;
                        const _t4456 = get_row_tail(arow);
                        _t4458: {
                          if (_t4456._tag === 1 && _t4456._val.contents._tag === 0) {
                            const id = _t4456._val.contents._val[0];
                            let _t4460;
                            const _t4459 = _call(Hashtbl$get, [__dict_Hash_int, __dict_Eq_int, rvar_to_rgen_4363, id]);
                            _t4461: {
                              if (_t4459._tag === 1) {
                                const caller_rgen = _t4459._val;
                                _t4460 = _call(add_evidence_4422, [__dict_Hash_int, __dict_Eq_int, caller_rgen, re.re_fields]);
                                break _t4461;
                              }
                              if (_t4459._tag === 0) {
                                _t4460 = undefined;
                                break _t4461;
                              }
                              _match_fail("line 15950");
                            }
                            _t4457 = _t4460;
                            break _t4458;
                          }
                          if (true) {
                            _t4457 = undefined;
                            break _t4458;
                          }
                          _match_fail("line 15950");
                        }
                        _t4455 = _t4457;
                      } else {
                        _t4455 = undefined;
                      }
                      const _t4454 = _t4455;
                      _t4448 = _t4454;
                      break _t4449;
                    }
                    if (_t4447._tag === 0) {
                      _t4448 = undefined;
                      break _t4449;
                    }
                    _match_fail("line 15950");
                  }
                  return _t4448;
                }
                const _t4445 = List$iter(_t4446, callee_sch.record_evidences);
                _t4442 = _t4445;
                break _t4443;
              }
            }
            if (true) {
              _t4442 = undefined;
              break _t4443;
            }
            _match_fail("line 15950");
          }
          _t4430 = _t4442;
          break _t4431;
        }
        if (true) {
          _t4430 = undefined;
          break _t4431;
        }
        _match_fail("line 15950");
      }
      _t4430;
      return walk_children(te);
    }
    function walk_children(te) {
      let _t4463;
      const _t4462 = te.expr;
      _t4464: {
        if ((((((((((_t4462._tag === 0 || _t4462._tag === 1) || _t4462._tag === 2) || _t4462._tag === 3) || _t4462._tag === 4) || _t4462._tag === 5) || _t4462._tag === 6) || _t4462._tag === 7) || _t4462._tag === 22) || _t4462._tag === 34)) {
          _t4463 = undefined;
          break _t4464;
        }
        if (((_t4462._tag === 8 || _t4462._tag === 9) || _t4462._tag === 25)) {
          const e1 = ((_t4462._tag === 8 || _t4462._tag === 9) ? _t4462._val[2] : _t4462._val[1]);
          const e2 = ((_t4462._tag === 8 || _t4462._tag === 9) ? _t4462._val[3] : _t4462._val[2]);
          walk(e1);
          _t4463 = walk(e2);
          break _t4464;
        }
        if (((((((_t4462._tag === 13 || _t4462._tag === 21) || _t4462._tag === 28) || _t4462._tag === 32) || _t4462._tag === 31) || _t4462._tag === 27) || _t4462._tag === 20)) {
          const e1 = ((((((_t4462._tag === 13 || _t4462._tag === 21) || _t4462._tag === 28) || _t4462._tag === 32) || _t4462._tag === 31) || _t4462._tag === 27) ? (((((_t4462._tag === 13 || _t4462._tag === 21) || _t4462._tag === 28) || _t4462._tag === 32) || _t4462._tag === 31) ? ((((_t4462._tag === 13 || _t4462._tag === 21) || _t4462._tag === 28) || _t4462._tag === 32) ? (((_t4462._tag === 13 || _t4462._tag === 21) || _t4462._tag === 28) ? ((_t4462._tag === 13 || _t4462._tag === 21) ? (_t4462._tag === 13 ? _t4462._val[1] : _t4462._val[0]) : _t4462._val[0]) : _t4462._val[0]) : _t4462._val[0]) : _t4462._val[0]) : _t4462._val[0]);
          const e2 = ((((((_t4462._tag === 13 || _t4462._tag === 21) || _t4462._tag === 28) || _t4462._tag === 32) || _t4462._tag === 31) || _t4462._tag === 27) ? (((((_t4462._tag === 13 || _t4462._tag === 21) || _t4462._tag === 28) || _t4462._tag === 32) || _t4462._tag === 31) ? ((((_t4462._tag === 13 || _t4462._tag === 21) || _t4462._tag === 28) || _t4462._tag === 32) ? (((_t4462._tag === 13 || _t4462._tag === 21) || _t4462._tag === 28) ? ((_t4462._tag === 13 || _t4462._tag === 21) ? (_t4462._tag === 13 ? _t4462._val[2] : _t4462._val[1]) : _t4462._val[1]) : _t4462._val[1]) : _t4462._val[1]) : _t4462._val[2]) : _t4462._val[1]);
          walk(e1);
          _t4463 = walk(e2);
          break _t4464;
        }
        if (_t4462._tag === 11) {
          const fn_ = _t4462._val[0];
          const arg = _t4462._val[1];
          walk(fn_);
          _t4463 = walk(arg);
          break _t4464;
        }
        if (((((((((_t4462._tag === 29 || _t4462._tag === 14) || _t4462._tag === 10) || _t4462._tag === 19) || _t4462._tag === 33) || _t4462._tag === 35) || _t4462._tag === 36) || _t4462._tag === 40) || _t4462._tag === 26)) {
          const e = ((((((((_t4462._tag === 29 || _t4462._tag === 14) || _t4462._tag === 10) || _t4462._tag === 19) || _t4462._tag === 33) || _t4462._tag === 35) || _t4462._tag === 36) || _t4462._tag === 40) ? (((((((_t4462._tag === 29 || _t4462._tag === 14) || _t4462._tag === 10) || _t4462._tag === 19) || _t4462._tag === 33) || _t4462._tag === 35) || _t4462._tag === 36) ? ((((((_t4462._tag === 29 || _t4462._tag === 14) || _t4462._tag === 10) || _t4462._tag === 19) || _t4462._tag === 33) || _t4462._tag === 35) ? (((((_t4462._tag === 29 || _t4462._tag === 14) || _t4462._tag === 10) || _t4462._tag === 19) || _t4462._tag === 33) ? ((((_t4462._tag === 29 || _t4462._tag === 14) || _t4462._tag === 10) || _t4462._tag === 19) ? (((_t4462._tag === 29 || _t4462._tag === 14) || _t4462._tag === 10) ? _t4462._val[1] : _t4462._val[0]) : _t4462._val) : _t4462._val) : _t4462._val) : _t4462._val) : _t4462._val[1]);
          _t4463 = walk(e);
          break _t4464;
        }
        if (_t4462._tag === 12) {
          const c = _t4462._val[0];
          const t = _t4462._val[1];
          const e = _t4462._val[2];
          walk(c);
          walk(t);
          _t4463 = walk(e);
          break _t4464;
        }
        if ((_t4462._tag === 15 || _t4462._tag === 39)) {
          const es = _t4462._val;
          _t4463 = List$iter(walk, es);
          break _t4464;
        }
        if (_t4462._tag === 38) {
          const kvs = _t4462._val;
          function _t4465(__p68) {
            let _t4467;
            const _t4466 = __p68;
            _t4468: {
              if (true) {
                const k = _t4466[0];
                const v = _t4466[1];
                walk(k);
                _t4467 = walk(v);
                break _t4468;
              }
              _match_fail("line 15950");
            }
            return _t4467;
          }
          _t4463 = List$iter(_t4465, kvs);
          break _t4464;
        }
        if (_t4462._tag === 16) {
          const fields = _t4462._val;
          function _t4469(__p69) {
            let _t4471;
            const _t4470 = __p69;
            _t4472: {
              if (true) {
                const e = _t4470[1];
                _t4471 = walk(e);
                break _t4472;
              }
              _match_fail("line 15950");
            }
            return _t4471;
          }
          _t4463 = List$iter(_t4469, fields);
          break _t4464;
        }
        if (_t4462._tag === 17) {
          const base = _t4462._val[0];
          const overrides = _t4462._val[1];
          walk(base);
          function _t4473(__p70) {
            let _t4475;
            const _t4474 = __p70;
            _t4476: {
              if (true) {
                const e = _t4474[1];
                _t4475 = walk(e);
                break _t4476;
              }
              _match_fail("line 15950");
            }
            return _t4475;
          }
          _t4463 = List$iter(_t4473, overrides);
          break _t4464;
        }
        if (_t4462._tag === 18) {
          const base = _t4462._val[0];
          const pairs = _t4462._val[1];
          walk(base);
          function _t4477(__p71) {
            let _t4479;
            const _t4478 = __p71;
            _t4480: {
              if (true) {
                const i = _t4478[0];
                const v = _t4478[1];
                walk(i);
                _t4479 = walk(v);
                break _t4480;
              }
              _match_fail("line 15950");
            }
            return _t4479;
          }
          _t4463 = List$iter(_t4477, pairs);
          break _t4464;
        }
        if (_t4462._tag === 23) {
          const arg = _t4462._val[1];
          _t4463 = Option$iter(walk, arg);
          break _t4464;
        }
        if (_t4462._tag === 24) {
          const scrutinee = _t4462._val[0];
          const arms = _t4462._val[1];
          walk(scrutinee);
          function _t4481(__p72) {
            let _t4483;
            const _t4482 = __p72;
            _t4484: {
              if (true) {
                const guard = _t4482[1];
                const body = _t4482[2];
                Option$iter(walk, guard);
                _t4483 = walk(body);
                break _t4484;
              }
              _match_fail("line 15950");
            }
            return _t4483;
          }
          _t4463 = List$iter(_t4481, arms);
          break _t4464;
        }
        if (_t4462._tag === 30) {
          const body = _t4462._val[0];
          const arms = _t4462._val[1];
          walk(body);
          function _t4485(arm) {
            let _t4487;
            const _t4486 = arm;
            _t4488: {
              if (_t4486._tag === 0) {
                const e = _t4486._val[1];
                _t4487 = walk(e);
                break _t4488;
              }
              if (_t4486._tag === 1) {
                const e = _t4486._val[3];
                _t4487 = walk(e);
                break _t4488;
              }
              _match_fail("line 15950");
            }
            return _t4487;
          }
          _t4463 = List$iter(_t4485, arms);
          break _t4464;
        }
        if (_t4462._tag === 37) {
          const bindings = _t4462._val[0];
          const body = _t4462._val[1];
          function _t4489(__p73) {
            let _t4491;
            const _t4490 = __p73;
            _t4492: {
              if (true) {
                const e = _t4490[1];
                _t4491 = walk(e);
                break _t4492;
              }
              _match_fail("line 15950");
            }
            return _t4491;
          }
          List$iter(_t4489, bindings);
          _t4463 = walk(body);
          break _t4464;
        }
        _match_fail("line 15950");
      }
      return _t4463;
    }
    walk(te);
    function _t4494(rgen_idx, fields, acc) {
      return ({_hd: ({re_fields: List$sort(String$compare, fields), re_rgen: rgen_idx}), _tl: acc});
    }
    const ev_list_4495 = Hashtbl$fold(_t4494, found_evidences_4410, null);
    let _t4497;
    if (_eq(ev_list_4495, null)) {
      _t4497 = scheme;
    } else {
      const __rec_upd_4498 = scheme;
      const _t4499 = ({body: __rec_upd_4498.body, constraints: __rec_upd_4498.constraints, equant: __rec_upd_4498.equant, pvquant: __rec_upd_4498.pvquant, quant: __rec_upd_4498.quant, record_evidences: ev_list_4495, rquant: __rec_upd_4498.rquant});
      _t4497 = _t4499;
    }
    const _t4496 = _t4497;
    const _t4493 = _t4496;
    const _t4428 = _t4493;
    const _t4423 = _t4428;
    const _t4411 = _t4423;
    const _t4409 = _t4411;
    const _t4364 = _t4409;
    _t4362 = _t4364;
  }
  return _t4362;
}
function Typechecker$scheme_needs_xform(scheme) {
  return (!_eq(scheme.constraints, null) || !_eq(scheme.record_evidences, null));
}
function Typechecker$improve_fundeps_in_expr(vars, type_env, te) {
  const classes_4500 = type_env.classes;
  const instances_4502 = type_env.instances;
  function _t4504(sch, ty) {
    const tgen_to_actual_4505 = Hashtbl$create(sch.quant);
    function map_tgens(s, a) {
      while (true) {
        const a_4507 = Types$repr(a);
        let _t4510;
        const _t4509 = s;
        _t4511: {
          if (_t4509._tag === 17) {
            const i = _t4509._val;
            let _t4512;
            if ((!_call(Hashtbl$has, [__dict_Hash_int, __dict_Eq_int, tgen_to_actual_4505, i]))) {
              _t4512 = _call(Hashtbl$set, [__dict_Hash_int, __dict_Eq_int, tgen_to_actual_4505, i, a_4507]);
            } else {
              _t4512 = undefined;
            }
            _t4510 = _t4512;
            break _t4511;
          }
          if (_t4509._tag === 7) {
            const s1 = _t4509._val[0];
            const s2 = _t4509._val[2];
            let _t4514;
            const _t4513 = a_4507;
            _t4515: {
              if (_t4513._tag === 7) {
                const a1 = _t4513._val[0];
                const a2 = _t4513._val[2];
                map_tgens(s1, a1);
                const _t4516 = s2;
                const _t4517 = a2;
                s = _t4516;
                a = _t4517;
                continue;
                _t4514 = undefined;
                break _t4515;
              }
              if (true) {
                _t4514 = undefined;
                break _t4515;
              }
              _match_fail("line 15950");
            }
            _t4510 = _t4514;
            break _t4511;
          }
          if (_t4509._tag === 8) {
            const s1 = _t4509._val[0];
            const s2 = _t4509._val[2];
            let _t4519;
            const _t4518 = a_4507;
            _t4520: {
              if (_t4518._tag === 8) {
                const a1 = _t4518._val[0];
                const a2 = _t4518._val[2];
                map_tgens(s1, a1);
                const _t4521 = s2;
                const _t4522 = a2;
                s = _t4521;
                a = _t4522;
                continue;
                _t4519 = undefined;
                break _t4520;
              }
              if (true) {
                _t4519 = undefined;
                break _t4520;
              }
              _match_fail("line 15950");
            }
            _t4510 = _t4519;
            break _t4511;
          }
          if (_t4509._tag === 9) {
            const ss = _t4509._val;
            let _t4524;
            const _t4523 = a_4507;
            _t4525: {
              if (_t4523._tag === 9) {
                const aa = _t4523._val;
                if ((List$length(ss) === List$length(aa))) {
                  _t4524 = List$iter2(map_tgens, ss, aa);
                  break _t4525;
                }
              }
              if (true) {
                _t4524 = undefined;
                break _t4525;
              }
              _match_fail("line 15950");
            }
            _t4510 = _t4524;
            break _t4511;
          }
          if (_t4509._tag === 10) {
            const s1 = _t4509._val;
            let _t4527;
            const _t4526 = a_4507;
            _t4528: {
              if (_t4526._tag === 10) {
                const a1 = _t4526._val;
                const _t4529 = s1;
                const _t4530 = a1;
                s = _t4529;
                a = _t4530;
                continue;
                _t4527 = undefined;
                break _t4528;
              }
              if (true) {
                _t4527 = undefined;
                break _t4528;
              }
              _match_fail("line 15950");
            }
            _t4510 = _t4527;
            break _t4511;
          }
          if (_t4509._tag === 14) {
            const s1 = _t4509._val;
            let _t4532;
            const _t4531 = a_4507;
            _t4533: {
              if (_t4531._tag === 14) {
                const a1 = _t4531._val;
                const _t4534 = s1;
                const _t4535 = a1;
                s = _t4534;
                a = _t4535;
                continue;
                _t4532 = undefined;
                break _t4533;
              }
              if (true) {
                _t4532 = undefined;
                break _t4533;
              }
              _match_fail("line 15950");
            }
            _t4510 = _t4532;
            break _t4511;
          }
          if (_t4509._tag === 13) {
            const sk = _t4509._val[0];
            const sv = _t4509._val[1];
            let _t4537;
            const _t4536 = a_4507;
            _t4538: {
              if (_t4536._tag === 13) {
                const ak = _t4536._val[0];
                const av = _t4536._val[1];
                map_tgens(sk, ak);
                const _t4539 = sv;
                const _t4540 = av;
                s = _t4539;
                a = _t4540;
                continue;
                _t4537 = undefined;
                break _t4538;
              }
              if (true) {
                _t4537 = undefined;
                break _t4538;
              }
              _match_fail("line 15950");
            }
            _t4510 = _t4537;
            break _t4511;
          }
          if (_t4509._tag === 12) {
            const ss = _t4509._val[1];
            let _t4542;
            const _t4541 = a_4507;
            _t4543: {
              if (_t4541._tag === 12) {
                const aa = _t4541._val[1];
                if ((List$length(ss) === List$length(aa))) {
                  _t4542 = List$iter2(map_tgens, ss, aa);
                  break _t4543;
                }
              }
              if (true) {
                _t4542 = undefined;
                break _t4543;
              }
              _match_fail("line 15950");
            }
            _t4510 = _t4542;
            break _t4511;
          }
          if (true) {
            _t4510 = undefined;
            break _t4511;
          }
          _match_fail("line 15950");
        }
        const _t4508 = _t4510;
        return _t4508;
      }
    }
    map_tgens(sch.body, ty);
    function _t4545(cc) {
      function _t4546(cls) {
        return (cls.class_name === cc.cc_class);
      }
      let _t4548;
      const _t4547 = List$find(_t4546, classes_4500);
      _t4549: {
        if (_t4547._tag === 0) {
          _t4548 = undefined;
          break _t4549;
        }
        if (_t4547._tag === 1) {
          const class_def = _t4547._val;
          if (_eq(class_def.class_fundeps, null)) {
            _t4548 = undefined;
            break _t4549;
          }
        }
        if (_t4547._tag === 1) {
          const class_def = _t4547._val;
          const num_params_4550 = List$length(class_def.class_params);
          function _t4552(ca) {
            let _t4554;
            const _t4553 = ca;
            _t4555: {
              if (_t4553._tag === 0) {
                const tgen_idx = _t4553._val;
                let _t4557;
                const _t4556 = _call(Hashtbl$get, [__dict_Hash_int, __dict_Eq_int, tgen_to_actual_4505, tgen_idx]);
                _t4558: {
                  if (_t4556._tag === 1 && _t4556._val._tag === 16 && _t4556._val._val.contents._tag === 0) {
                    _t4557 = ({_tag: 0, _name: "None"});
                    break _t4558;
                  }
                  if (_t4556._tag === 1) {
                    const t = _t4556._val;
                    _t4557 = ({_tag: 1, _name: "Some", _val: t});
                    break _t4558;
                  }
                  if (_t4556._tag === 0) {
                    _t4557 = ({_tag: 0, _name: "None"});
                    break _t4558;
                  }
                  _match_fail("line 15950");
                }
                _t4554 = _t4557;
                break _t4555;
              }
              if (_t4553._tag === 1) {
                const ty = _t4553._val;
                let _t4560;
                const _t4559 = Types$repr(ty);
                _t4561: {
                  if (_t4559._tag === 16 && _t4559._val.contents._tag === 0) {
                    _t4560 = ({_tag: 0, _name: "None"});
                    break _t4561;
                  }
                  if (true) {
                    const t = _t4559;
                    _t4560 = ({_tag: 1, _name: "Some", _val: t});
                    break _t4561;
                  }
                  _match_fail("line 15950");
                }
                _t4554 = _t4560;
                break _t4555;
              }
              if (_t4553._tag === 2) {
                _t4554 = ({_tag: 0, _name: "None"});
                break _t4555;
              }
              if (_t4553._tag === 3) {
                _t4554 = ({_tag: 0, _name: "None"});
                break _t4555;
              }
              _match_fail("line 15950");
            }
            return _t4554;
          }
          const partial_4562 = List$map(_t4552, cc.cc_args);
          const improved_4564 = Types$improve_with_fundeps(instances_4502, class_def, partial_4562);
          function _t4566(i, opt) {
            let _t4567;
            if ((i < num_params_4550)) {
              let _t4569;
              const _t4568 = [opt, List$nth(partial_4562, i)];
              _t4570: {
                if (_t4568[0]._tag === 1 && _t4568[1]._tag === 0) {
                  const resolved_ty = _t4568[0]._val;
                  const ca_4571 = List$nth(cc.cc_args, i);
                  let _t4574;
                  const _t4573 = ca_4571;
                  _t4575: {
                    if (_t4573._tag === 0) {
                      const tgen_idx = _t4573._val;
                      _t4574 = _call(Hashtbl$get, [__dict_Hash_int, __dict_Eq_int, tgen_to_actual_4505, tgen_idx]);
                      break _t4575;
                    }
                    if (_t4573._tag === 1) {
                      const ty = _t4573._val;
                      _t4574 = ({_tag: 1, _name: "Some", _val: ty});
                      break _t4575;
                    }
                    if (_t4573._tag === 2) {
                      _t4574 = ({_tag: 0, _name: "None"});
                      break _t4575;
                    }
                    if (_t4573._tag === 3) {
                      _t4574 = ({_tag: 0, _name: "None"});
                      break _t4575;
                    }
                    _match_fail("line 15950");
                  }
                  const tvar_opt_4576 = _t4574;
                  let _t4579;
                  const _t4578 = tvar_opt_4576;
                  _t4580: {
                    if (_t4578._tag === 1 && _t4578._val._tag === 16 && _t4578._val._val.contents._tag === 0) {
                      const r = _t4578._val._val;
                      _t4579 = Types$unify(({_tag: 16, _name: "TVar", _val: r}), resolved_ty);
                      break _t4580;
                    }
                    if (true) {
                      _t4579 = undefined;
                      break _t4580;
                    }
                    _match_fail("line 15950");
                  }
                  const _t4577 = _t4579;
                  const _t4572 = _t4577;
                  _t4569 = _t4572;
                  break _t4570;
                }
                if (true) {
                  _t4569 = undefined;
                  break _t4570;
                }
                _match_fail("line 15950");
              }
              _t4567 = _t4569;
            } else {
              _t4567 = undefined;
            }
            return _t4567;
          }
          const _t4565 = List$iteri(_t4566, improved_4564);
          const _t4563 = _t4565;
          const _t4551 = _t4563;
          _t4548 = _t4551;
          break _t4549;
        }
        _match_fail("line 15950");
      }
      return _t4548;
    }
    const _t4544 = List$iter(_t4545, sch.constraints);
    const _t4506 = _t4544;
    return _t4506;
  }
  const improve_constrained_call_with_scheme_4581 = _t4504;
  function _t4583(name, ty) {
    let _t4585;
    const _t4584 = Types$find_method_class(classes_4500, name);
    _t4586: {
      if (_t4584._tag === 1) {
        const result = _t4584;
        _t4585 = [result, name];
        break _t4586;
      }
      if (_t4584._tag === 0) {
        let _t4588;
        const _t4587 = String$rindex_opt(name, 46);
        _t4589: {
          if (_t4587._tag === 0) {
            _t4588 = [({_tag: 0, _name: "None"}), name];
            break _t4589;
          }
          if (_t4587._tag === 1) {
            const i = _t4587._val;
            const mod_prefix_4590 = String$sub(name, 0, (i + 1));
            const _mml$short_4592 = String$sub(name, (i + 1), ((String$length(name) - i) - 1));
            const class_prefix_4594 = String$sub(name, 0, i);
            let _t4597;
            const _t4596 = Types$find_method_class(classes_4500, _mml$short_4592);
            _t4598: {
              if (_t4596._tag === 1) {
                const class_def = _t4596._val;
                if ((class_def.class_name === class_prefix_4594)) {
                  _t4597 = [({_tag: 1, _name: "Some", _val: class_def}), _mml$short_4592];
                  break _t4598;
                }
              }
              if (_t4596._tag === 1) {
                const class_def = _t4596._val;
                if (((String$length(class_def.class_name) > String$length(mod_prefix_4590)) && (String$sub(class_def.class_name, 0, String$length(mod_prefix_4590)) === mod_prefix_4590))) {
                  _t4597 = [({_tag: 1, _name: "Some", _val: class_def}), _mml$short_4592];
                  break _t4598;
                }
              }
              if (true) {
                _t4597 = [({_tag: 0, _name: "None"}), name];
                break _t4598;
              }
              _match_fail("line 15950");
            }
            const _t4595 = _t4597;
            const _t4593 = _t4595;
            const _t4591 = _t4593;
            _t4588 = _t4591;
            break _t4589;
          }
          _match_fail("line 15950");
        }
        _t4585 = _t4588;
        break _t4586;
      }
      _match_fail("line 15950");
    }
    let _t4600;
    const _t4599 = _t4585;
    _t4601: {
      if (true) {
        const class_opt = _t4599[0];
        const method_name = _t4599[1];
        let _t4603;
        const _t4602 = class_opt;
        _t4604: {
          if (_t4602._tag === 1) {
            const class_def = _t4602._val;
            if (!_eq(class_def.class_fundeps, null)) {
              const method_schema_ty_4605 = List$assoc(method_name, class_def.class_methods);
              const num_params_4607 = List$length(class_def.class_params);
              const found_4609 = Hashtbl$create(num_params_4607);
              function go(s, r) {
                while (true) {
                  const r_4611 = Types$repr(r);
                  let _t4614;
                  const _t4613 = [s, r_4611];
                  _t4615: {
                    if (_t4613[0]._tag === 17) {
                      const i = _t4613[0]._val;
                      if ((i < num_params_4607)) {
                        let _t4616;
                        if ((!_call(Hashtbl$has, [__dict_Hash_int, __dict_Eq_int, found_4609, i]))) {
                          _t4616 = _call(Hashtbl$set, [__dict_Hash_int, __dict_Eq_int, found_4609, i, r_4611]);
                        } else {
                          _t4616 = undefined;
                        }
                        _t4614 = _t4616;
                        break _t4615;
                      }
                    }
                    if ((_t4613[0]._tag === 7 && _t4613[1]._tag === 7 || _t4613[0]._tag === 8 && _t4613[1]._tag === 8)) {
                      const s1 = _t4613[0]._val[0];
                      const s2 = _t4613[0]._val[2];
                      const r1 = _t4613[1]._val[0];
                      const r2 = _t4613[1]._val[2];
                      go(s1, r1);
                      const _t4617 = s2;
                      const _t4618 = r2;
                      s = _t4617;
                      r = _t4618;
                      continue;
                      _t4614 = undefined;
                      break _t4615;
                    }
                    if (_t4613[0]._tag === 9 && _t4613[1]._tag === 9) {
                      const ss = _t4613[0]._val;
                      const rs = _t4613[1]._val;
                      if ((List$length(ss) === List$length(rs))) {
                        _t4614 = List$iter2(go, ss, rs);
                        break _t4615;
                      }
                    }
                    if (_t4613[0]._tag === 10 && _t4613[1]._tag === 10) {
                      const s1 = _t4613[0]._val;
                      const r1 = _t4613[1]._val;
                      const _t4619 = s1;
                      const _t4620 = r1;
                      s = _t4619;
                      r = _t4620;
                      continue;
                      _t4614 = undefined;
                      break _t4615;
                    }
                    if (_t4613[0]._tag === 14 && _t4613[1]._tag === 14) {
                      const s1 = _t4613[0]._val;
                      const r1 = _t4613[1]._val;
                      const _t4621 = s1;
                      const _t4622 = r1;
                      s = _t4621;
                      r = _t4622;
                      continue;
                      _t4614 = undefined;
                      break _t4615;
                    }
                    if (_t4613[0]._tag === 13 && _t4613[1]._tag === 13) {
                      const sk = _t4613[0]._val[0];
                      const sv = _t4613[0]._val[1];
                      const rk = _t4613[1]._val[0];
                      const rv = _t4613[1]._val[1];
                      go(sk, rk);
                      const _t4623 = sv;
                      const _t4624 = rv;
                      s = _t4623;
                      r = _t4624;
                      continue;
                      _t4614 = undefined;
                      break _t4615;
                    }
                    if (_t4613[0]._tag === 12 && _t4613[1]._tag === 12) {
                      const ss = _t4613[0]._val[1];
                      const rs = _t4613[1]._val[1];
                      if ((List$length(ss) === List$length(rs))) {
                        _t4614 = List$iter2(go, ss, rs);
                        break _t4615;
                      }
                    }
                    if (true) {
                      _t4614 = undefined;
                      break _t4615;
                    }
                    _match_fail("line 15950");
                  }
                  const _t4612 = _t4614;
                  return _t4612;
                }
              }
              go(method_schema_ty_4605, ty);
              function _t4626(i) {
                let _t4628;
                const _t4627 = _call(Hashtbl$get, [__dict_Hash_int, __dict_Eq_int, found_4609, i]);
                _t4629: {
                  if (_t4627._tag === 1 && _t4627._val._tag === 16 && _t4627._val._val.contents._tag === 0) {
                    _t4628 = ({_tag: 0, _name: "None"});
                    break _t4629;
                  }
                  if (_t4627._tag === 1) {
                    const t = _t4627._val;
                    _t4628 = ({_tag: 1, _name: "Some", _val: t});
                    break _t4629;
                  }
                  if (_t4627._tag === 0) {
                    _t4628 = ({_tag: 0, _name: "None"});
                    break _t4629;
                  }
                  _match_fail("line 15950");
                }
                return _t4628;
              }
              const partial_4630 = List$init(num_params_4607, _t4626);
              const improved_4632 = Types$improve_with_fundeps(instances_4502, class_def, partial_4630);
              function _t4634(i, opt) {
                let _t4636;
                const _t4635 = [opt, List$nth(partial_4630, i)];
                _t4637: {
                  if (_t4635[0]._tag === 1 && _t4635[1]._tag === 0) {
                    const resolved_ty = _t4635[0]._val;
                    let _t4639;
                    const _t4638 = _call(Hashtbl$get, [__dict_Hash_int, __dict_Eq_int, found_4609, i]);
                    _t4640: {
                      if (_t4638._tag === 1 && _t4638._val._tag === 16 && _t4638._val._val.contents._tag === 0) {
                        const r = _t4638._val._val;
                        _t4639 = Types$unify(({_tag: 16, _name: "TVar", _val: r}), resolved_ty);
                        break _t4640;
                      }
                      if (true) {
                        _t4639 = undefined;
                        break _t4640;
                      }
                      _match_fail("line 15950");
                    }
                    _t4636 = _t4639;
                    break _t4637;
                  }
                  if (true) {
                    _t4636 = undefined;
                    break _t4637;
                  }
                  _match_fail("line 15950");
                }
                return _t4636;
              }
              const _t4633 = List$iteri(_t4634, improved_4632);
              const _t4631 = _t4633;
              const _t4625 = _t4631;
              const _t4610 = _t4625;
              const _t4608 = _t4610;
              const _t4606 = _t4608;
              _t4603 = _t4606;
              break _t4604;
            }
          }
          if (true) {
            _t4603 = undefined;
            break _t4604;
          }
          _match_fail("line 15950");
        }
        _t4600 = _t4603;
        break _t4601;
      }
      _match_fail("line 15950");
    }
    return _t4600;
  }
  const improve_method_call_4641 = _t4583;
  function walk(locals, te) {
    let _t4644;
    const _t4643 = te.expr;
    _t4645: {
      if (_t4643._tag === 7) {
        const name = _t4643._val;
        improve_method_call_4641(name, te.ty);
        _t4644 = improve_constrained_call_local(locals, name, te.ty);
        break _t4645;
      }
      if (true) {
        _t4644 = undefined;
        break _t4645;
      }
      _match_fail("line 15950");
    }
    _t4644;
    return walk_children(locals, te);
  }
  function improve_constrained_call_local(locals, name, ty) {
    let _t4647;
    const _t4646 = List$assoc_opt(name, locals);
    _t4648: {
      if (_t4646._tag === 1) {
        const s = _t4646;
        _t4647 = s;
        break _t4648;
      }
      if (_t4646._tag === 0) {
        let _t4650;
        const _t4649 = List$assoc_opt(name, vars);
        _t4651: {
          if (_t4649._tag === 1) {
            const s = _t4649._val;
            if (!_eq(s.constraints, null)) {
              _t4650 = ({_tag: 1, _name: "Some", _val: s});
              break _t4651;
            }
          }
          if (true) {
            _t4650 = ({_tag: 0, _name: "None"});
            break _t4651;
          }
          _match_fail("line 15950");
        }
        _t4647 = _t4650;
        break _t4648;
      }
      _match_fail("line 15950");
    }
    const scheme_4652 = _t4647;
    let _t4655;
    const _t4654 = scheme_4652;
    _t4656: {
      if (_t4654._tag === 0) {
        _t4655 = undefined;
        break _t4656;
      }
      if (_t4654._tag === 1) {
        const sch = _t4654._val;
        _t4655 = improve_constrained_call_with_scheme_4581(sch, ty);
        break _t4656;
      }
      _match_fail("line 15950");
    }
    const _t4653 = _t4655;
    return _t4653;
  }
  function walk_children(locals, te) {
    let _t4658;
    const _t4657 = te.expr;
    _t4659: {
      if (((((((((_t4657._tag === 0 || _t4657._tag === 1) || _t4657._tag === 2) || _t4657._tag === 3) || _t4657._tag === 4) || _t4657._tag === 5) || _t4657._tag === 6) || _t4657._tag === 7) || _t4657._tag === 22)) {
        _t4658 = undefined;
        break _t4659;
      }
      if (_t4657._tag === 8) {
        const name = _t4657._val[0];
        const sch_opt = _t4657._val[1];
        const e1 = _t4657._val[2];
        const e2 = _t4657._val[3];
        walk(locals, e1);
        let _t4661;
        const _t4660 = sch_opt;
        _t4662: {
          if (_t4660._tag === 1) {
            const sch = _t4660._val;
            if (!_eq(sch.constraints, null)) {
              _t4661 = ({_hd: [name, sch], _tl: locals});
              break _t4662;
            }
          }
          if (true) {
            _t4661 = locals;
            break _t4662;
          }
          _match_fail("line 15950");
        }
        const locals$p_4663 = _t4661;
        const _t4664 = walk(locals$p_4663, e2);
        _t4658 = _t4664;
        break _t4659;
      }
      if (_t4657._tag === 9) {
        const name = _t4657._val[0];
        const sch_opt = _t4657._val[1];
        const e1 = _t4657._val[2];
        const e2 = _t4657._val[3];
        let _t4666;
        const _t4665 = sch_opt;
        _t4667: {
          if (_t4665._tag === 1) {
            const sch = _t4665._val;
            if (!_eq(sch.constraints, null)) {
              _t4666 = ({_hd: [name, sch], _tl: locals});
              break _t4667;
            }
          }
          if (true) {
            _t4666 = locals;
            break _t4667;
          }
          _match_fail("line 15950");
        }
        const locals$p_4668 = _t4666;
        walk(locals$p_4668, e1);
        const _t4669 = walk(locals$p_4668, e2);
        _t4658 = _t4669;
        break _t4659;
      }
      if (_t4657._tag === 25) {
        const e1 = _t4657._val[1];
        const e2 = _t4657._val[2];
        walk(locals, e1);
        _t4658 = walk(locals, e2);
        break _t4659;
      }
      if (_t4657._tag === 10) {
        const body = _t4657._val[1];
        _t4658 = walk(locals, body);
        break _t4659;
      }
      if (_t4657._tag === 11) {
        const f = _t4657._val[0];
        const a = _t4657._val[1];
        walk(locals, f);
        _t4658 = walk(locals, a);
        break _t4659;
      }
      if (_t4657._tag === 12) {
        const c = _t4657._val[0];
        const t = _t4657._val[1];
        const e = _t4657._val[2];
        walk(locals, c);
        walk(locals, t);
        _t4658 = walk(locals, e);
        break _t4659;
      }
      if (_t4657._tag === 13) {
        const l = _t4657._val[1];
        const r = _t4657._val[2];
        walk(locals, l);
        _t4658 = walk(locals, r);
        break _t4659;
      }
      if (_t4657._tag === 14) {
        const e = _t4657._val[1];
        _t4658 = walk(locals, e);
        break _t4659;
      }
      if (_t4657._tag === 15) {
        const es = _t4657._val;
        _t4658 = List$iter(_call(walk, [locals]), es);
        break _t4659;
      }
      if (_t4657._tag === 16) {
        const fs = _t4657._val;
        function _t4670(__p74) {
          let _t4672;
          const _t4671 = __p74;
          _t4673: {
            if (true) {
              const e = _t4671[1];
              _t4672 = walk(locals, e);
              break _t4673;
            }
            _match_fail("line 15950");
          }
          return _t4672;
        }
        _t4658 = List$iter(_t4670, fs);
        break _t4659;
      }
      if (_t4657._tag === 17) {
        const base = _t4657._val[0];
        const overrides = _t4657._val[1];
        walk(locals, base);
        function _t4674(__p75) {
          let _t4676;
          const _t4675 = __p75;
          _t4677: {
            if (true) {
              const e = _t4675[1];
              _t4676 = walk(locals, e);
              break _t4677;
            }
            _match_fail("line 15950");
          }
          return _t4676;
        }
        _t4658 = List$iter(_t4674, overrides);
        break _t4659;
      }
      if (_t4657._tag === 18) {
        const base = _t4657._val[0];
        const pairs = _t4657._val[1];
        walk(locals, base);
        function _t4678(__p76) {
          let _t4680;
          const _t4679 = __p76;
          _t4681: {
            if (true) {
              const i = _t4679[0];
              const v = _t4679[1];
              walk(locals, i);
              _t4680 = walk(locals, v);
              break _t4681;
            }
            _match_fail("line 15950");
          }
          return _t4680;
        }
        _t4658 = List$iter(_t4678, pairs);
        break _t4659;
      }
      if (_t4657._tag === 19) {
        const e = _t4657._val[0];
        _t4658 = walk(locals, e);
        break _t4659;
      }
      if (_t4657._tag === 20) {
        const e = _t4657._val[0];
        const i = _t4657._val[1];
        walk(locals, e);
        _t4658 = walk(locals, i);
        break _t4659;
      }
      if (_t4657._tag === 21) {
        const h = _t4657._val[0];
        const t = _t4657._val[1];
        walk(locals, h);
        _t4658 = walk(locals, t);
        break _t4659;
      }
      if (_t4657._tag === 23) {
        const arg = _t4657._val[1];
        _t4658 = Option$iter(_call(walk, [locals]), arg);
        break _t4659;
      }
      if (_t4657._tag === 24) {
        const s = _t4657._val[0];
        const arms = _t4657._val[1];
        walk(locals, s);
        function _t4682(__p77) {
          let _t4684;
          const _t4683 = __p77;
          _t4685: {
            if (true) {
              const g = _t4683[1];
              const b = _t4683[2];
              Option$iter(_call(walk, [locals]), g);
              _t4684 = walk(locals, b);
              break _t4685;
            }
            _match_fail("line 15950");
          }
          return _t4684;
        }
        _t4658 = List$iter(_t4682, arms);
        break _t4659;
      }
      if (_t4657._tag === 26) {
        const e = _t4657._val[1];
        _t4658 = walk(locals, e);
        break _t4659;
      }
      if (_t4657._tag === 27) {
        const e = _t4657._val[0];
        const v = _t4657._val[2];
        walk(locals, e);
        _t4658 = walk(locals, v);
        break _t4659;
      }
      if (_t4657._tag === 28) {
        const e1 = _t4657._val[0];
        const e2 = _t4657._val[1];
        walk(locals, e1);
        _t4658 = walk(locals, e2);
        break _t4659;
      }
      if (_t4657._tag === 39) {
        const es = _t4657._val;
        _t4658 = List$iter(_call(walk, [locals]), es);
        break _t4659;
      }
      if (_t4657._tag === 38) {
        const kvs = _t4657._val;
        function _t4686(__p78) {
          let _t4688;
          const _t4687 = __p78;
          _t4689: {
            if (true) {
              const k = _t4687[0];
              const v = _t4687[1];
              walk(locals, k);
              _t4688 = walk(locals, v);
              break _t4689;
            }
            _match_fail("line 15950");
          }
          return _t4688;
        }
        _t4658 = List$iter(_t4686, kvs);
        break _t4659;
      }
      if (_t4657._tag === 32) {
        const c = _t4657._val[0];
        const b = _t4657._val[1];
        walk(locals, c);
        _t4658 = walk(locals, b);
        break _t4659;
      }
      if (_t4657._tag === 36) {
        const e = _t4657._val;
        _t4658 = walk(locals, e);
        break _t4659;
      }
      if (_t4657._tag === 40) {
        const e = _t4657._val;
        _t4658 = walk(locals, e);
        break _t4659;
      }
      if (_t4657._tag === 33) {
        const e = _t4657._val;
        _t4658 = walk(locals, e);
        break _t4659;
      }
      if ((_t4657._tag === 34 || _t4657._tag === 35)) {
        _t4658 = undefined;
        break _t4659;
      }
      if (_t4657._tag === 29) {
        const e = _t4657._val[1];
        _t4658 = walk(locals, e);
        break _t4659;
      }
      if (_t4657._tag === 30) {
        const e = _t4657._val[0];
        const arms = _t4657._val[1];
        walk(locals, e);
        function _t4690(arm) {
          let _t4692;
          const _t4691 = arm;
          _t4693: {
            if (_t4691._tag === 0) {
              const body = _t4691._val[1];
              _t4692 = walk(locals, body);
              break _t4693;
            }
            if (_t4691._tag === 1) {
              const body = _t4691._val[3];
              _t4692 = walk(locals, body);
              break _t4693;
            }
            _match_fail("line 15950");
          }
          return _t4692;
        }
        _t4658 = List$iter(_t4690, arms);
        break _t4659;
      }
      if (_t4657._tag === 31) {
        const e1 = _t4657._val[0];
        const e2 = _t4657._val[1];
        walk(locals, e1);
        _t4658 = walk(locals, e2);
        break _t4659;
      }
      if (_t4657._tag === 37) {
        const bindings = _t4657._val[0];
        const body = _t4657._val[1];
        function _t4694(__p79) {
          let _t4696;
          const _t4695 = __p79;
          _t4697: {
            if (true) {
              const e = _t4695[1];
              _t4696 = walk(locals, e);
              break _t4697;
            }
            _match_fail("line 15950");
          }
          return _t4696;
        }
        List$iter(_t4694, bindings);
        _t4658 = walk(locals, body);
        break _t4659;
      }
      _match_fail("line 15950");
    }
    return _t4658;
  }
  const _t4698 = walk(null, te);
  const _t4642 = _t4698;
  const _t4582 = _t4642;
  const _t4503 = _t4582;
  const _t4501 = _t4503;
  return _t4501;
}
function Typechecker$is_syntactic_value(expr) {
  while (true) {
    let _t4700;
    const _t4699 = expr;
    _t4701: {
      if (((((((_t4699._tag === 0 || _t4699._tag === 1) || _t4699._tag === 2) || _t4699._tag === 3) || _t4699._tag === 4) || _t4699._tag === 5) || _t4699._tag === 6)) {
        _t4700 = true;
        break _t4701;
      }
      if (_t4699._tag === 7) {
        _t4700 = true;
        break _t4701;
      }
      if (_t4699._tag === 10) {
        _t4700 = true;
        break _t4701;
      }
      if (_t4699._tag === 21) {
        _t4700 = true;
        break _t4701;
      }
      if (_t4699._tag === 24 && _t4699._val[1]._tag === 0) {
        _t4700 = true;
        break _t4701;
      }
      if (_t4699._tag === 24 && _t4699._val[1]._tag === 1) {
        const e = _t4699._val[1]._val;
        const _t4702 = e;
        expr = _t4702;
        continue;
        _t4700 = undefined;
        break _t4701;
      }
      if ((_t4699._tag === 15 || _t4699._tag === 22)) {
        const es = _t4699._val;
        _t4700 = List$forall(Typechecker$is_syntactic_value, es);
        break _t4701;
      }
      if (_t4699._tag === 16) {
        const fields = _t4699._val;
        function _t4703(__p80) {
          let _t4705;
          const _t4704 = __p80;
          _t4706: {
            if (true) {
              const e = _t4704[1];
              _t4705 = Typechecker$is_syntactic_value(e);
              break _t4706;
            }
            _match_fail("line 15950");
          }
          return _t4705;
        }
        _t4700 = List$forall(_t4703, fields);
        break _t4701;
      }
      if (_t4699._tag === 20) {
        const a = _t4699._val[0];
        const b = _t4699._val[1];
        _t4700 = (Typechecker$is_syntactic_value(a) && Typechecker$is_syntactic_value(b));
        break _t4701;
      }
      if (_t4699._tag === 46 && _t4699._val[1]._tag === 0) {
        _t4700 = true;
        break _t4701;
      }
      if (_t4699._tag === 46 && _t4699._val[1]._tag === 1) {
        const e = _t4699._val[1]._val;
        const _t4707 = e;
        expr = _t4707;
        continue;
        _t4700 = undefined;
        break _t4701;
      }
      if (((_t4699._tag === 30 || _t4699._tag === 47) || _t4699._tag === 49)) {
        const e = ((_t4699._tag === 30 || _t4699._tag === 47) ? _t4699._val[0] : _t4699._val[1]);
        const _t4708 = e;
        expr = _t4708;
        continue;
        _t4700 = undefined;
        break _t4701;
      }
      if (true) {
        _t4700 = false;
        break _t4701;
      }
      _match_fail("line 15950");
    }
    return _t4700;
  }
}
function Typechecker$mono_scheme(ty) {
  return ({body: ty, constraints: null, equant: 0, pvquant: 0, quant: 0, record_evidences: null, rquant: 0});
}
function Typechecker$synth(ctx, level, expr) {
  while (true) {
    let _t4710;
    const _t4709 = expr;
    _t4711: {
      if (_t4709._tag === 49) {
        const loc = _t4709._val[0];
        const inner = _t4709._val[1];
        Ref$set(Typechecker$current_loc, loc);
        const _t4712 = ctx;
        const _t4713 = level;
        const _t4714 = inner;
        ctx = _t4712;
        level = _t4713;
        expr = _t4714;
        continue;
        _t4710 = undefined;
        break _t4711;
      }
      if (_t4709._tag === 0) {
        const n = _t4709._val;
        _t4710 = Typechecker$mk(({_tag: 0, _name: "TEInt", _val: n}), ({_tag: 0, _name: "TInt"}));
        break _t4711;
      }
      if (_t4709._tag === 1) {
        const f = _t4709._val;
        _t4710 = Typechecker$mk(({_tag: 1, _name: "TEFloat", _val: f}), ({_tag: 1, _name: "TFloat"}));
        break _t4711;
      }
      if (_t4709._tag === 2) {
        const b = _t4709._val;
        _t4710 = Typechecker$mk(({_tag: 2, _name: "TEBool", _val: b}), ({_tag: 2, _name: "TBool"}));
        break _t4711;
      }
      if (_t4709._tag === 3) {
        const s = _t4709._val;
        _t4710 = Typechecker$mk(({_tag: 3, _name: "TEString", _val: s}), ({_tag: 3, _name: "TString"}));
        break _t4711;
      }
      if (_t4709._tag === 4) {
        const n = _t4709._val;
        _t4710 = Typechecker$mk(({_tag: 4, _name: "TEByte", _val: n}), ({_tag: 4, _name: "TByte"}));
        break _t4711;
      }
      if (_t4709._tag === 5) {
        const n = _t4709._val;
        _t4710 = Typechecker$mk(({_tag: 5, _name: "TERune", _val: n}), ({_tag: 5, _name: "TRune"}));
        break _t4711;
      }
      if (_t4709._tag === 6) {
        _t4710 = Typechecker$mk(({_tag: 6, _name: "TEUnit"}), ({_tag: 6, _name: "TUnit"}));
        break _t4711;
      }
      if (_t4709._tag === 21) {
        _t4710 = Typechecker$mk(({_tag: 22, _name: "TENil"}), ({_tag: 10, _name: "TList", _val: Types$new_tvar(level)}));
        break _t4711;
      }
      if (_t4709._tag === 7) {
        const name = _t4709._val;
        const ty_4715 = Typechecker$lookup_var(ctx, level, name);
        const resolved_name_4717 = Typechecker$resolve_module_name(ctx, name);
        const _t4718 = Typechecker$mk(({_tag: 7, _name: "TEVar", _val: resolved_name_4717}), ty_4715);
        const _t4716 = _t4718;
        _t4710 = _t4716;
        break _t4711;
      }
      if (_t4709._tag === 13) {
        const op = _t4709._val[0];
        const e1 = _t4709._val[1];
        const e2 = _t4709._val[2];
        _t4710 = Typechecker$synth_binop(ctx, level, op, e1, e2);
        break _t4711;
      }
      if (_t4709._tag === 14) {
        const op = _t4709._val[0];
        const e = _t4709._val[1];
        _t4710 = Typechecker$synth_unop(ctx, level, op, e);
        break _t4711;
      }
      if (_t4709._tag === 11) {
        const fn_ = _t4709._val[0];
        const arg = _t4709._val[1];
        const fn_te_4719 = Typechecker$synth(ctx, level, fn_);
        const arg_te_4721 = Typechecker$synth(ctx, level, arg);
        const ret_ty_4723 = Types$new_tvar(level);
        const call_eff_4725 = Types$new_effvar(level);
        Typechecker$try_unify(fn_te_4719.ty, ({_tag: 7, _name: "TArrow", _val: [arg_te_4721.ty, call_eff_4725, ret_ty_4723]}));
        Typechecker$try_subeffect(call_eff_4725, ctx.current_eff);
        const _t4726 = Typechecker$mk(({_tag: 11, _name: "TEApp", _val: [fn_te_4719, arg_te_4721]}), ret_ty_4723);
        const _t4724 = _t4726;
        const _t4722 = _t4724;
        const _t4720 = _t4722;
        _t4710 = _t4720;
        break _t4711;
      }
      if (_t4709._tag === 10) {
        const param = _t4709._val[0];
        const body = _t4709._val[1];
        let _t4728;
        const _t4727 = param.annot;
        _t4729: {
          if (_t4727._tag === 1) {
            const annot = _t4727._val;
            _t4728 = Typechecker$resolve_ty_annot(ctx, level, annot);
            break _t4729;
          }
          if (_t4727._tag === 0) {
            _t4728 = Types$new_tvar(level);
            break _t4729;
          }
          _match_fail("line 15950");
        }
        const param_ty_4730 = _t4728;
        const body_eff_4732 = Types$new_effvar(level);
        const ret_ty_4734 = Types$new_tvar(level);
        let _t4736;
        if (param.is_generated) {
          const __rec_upd_4737 = ctx;
          const _t4738 = ({constraint_tvars: __rec_upd_4737.constraint_tvars, current_eff: body_eff_4732, current_module: __rec_upd_4737.current_module, inside_handler: __rec_upd_4737.inside_handler, loop_info: __rec_upd_4737.loop_info, mutable_vars: __rec_upd_4737.mutable_vars, return_type: __rec_upd_4737.return_type, return_used: __rec_upd_4737.return_used, type_env: __rec_upd_4737.type_env, vars: __rec_upd_4737.vars});
          _t4736 = _t4738;
        } else {
          const return_used_4739 = Ref$create(false);
          const __rec_upd_4741 = ctx;
          const _t4742 = ({constraint_tvars: __rec_upd_4741.constraint_tvars, current_eff: body_eff_4732, current_module: __rec_upd_4741.current_module, inside_handler: false, loop_info: __rec_upd_4741.loop_info, mutable_vars: __rec_upd_4741.mutable_vars, return_type: ({_tag: 1, _name: "Some", _val: ret_ty_4734}), return_used: return_used_4739, type_env: __rec_upd_4741.type_env, vars: __rec_upd_4741.vars});
          const _t4740 = _t4742;
          _t4736 = _t4740;
        }
        const ctx$p_4743 = _t4736;
        const ctx$p_4745 = Typechecker$extend_var_mono(ctx$p_4743, param.name, param_ty_4730);
        const body_te_4747 = Typechecker$synth(ctx$p_4745, level, body);
        Typechecker$try_unify(body_te_4747.ty, ret_ty_4734);
        let _t4749;
        if (param.is_generated) {
          _t4749 = false;
        } else {
          _t4749 = Ref$get(ctx$p_4745.return_used);
        }
        const has_return_4750 = _t4749;
        const _t4751 = Typechecker$mk(({_tag: 10, _name: "TEFun", _val: [param.name, body_te_4747, has_return_4750]}), ({_tag: 7, _name: "TArrow", _val: [param_ty_4730, body_eff_4732, ret_ty_4734]}));
        const _t4748 = _t4751;
        const _t4746 = _t4748;
        const _t4744 = _t4746;
        const _t4735 = _t4744;
        const _t4733 = _t4735;
        const _t4731 = _t4733;
        _t4710 = _t4731;
        break _t4711;
      }
      if (_t4709._tag === 8) {
        const name = _t4709._val[0];
        const e1 = _t4709._val[1];
        const e2 = _t4709._val[2];
        const e1_te_4752 = Typechecker$synth(ctx, (level + 1), e1);
        Typechecker$improve_fundeps_in_expr(ctx.vars, ctx.type_env, e1_te_4752);
        let _t4754;
        if (Typechecker$is_syntactic_value(e1)) {
          _t4754 = Types$generalize(level, e1_te_4752.ty);
        } else {
          _t4754 = Typechecker$mono_scheme(e1_te_4752.ty);
        }
        const scheme_4755 = _t4754;
        const scheme_4757 = Typechecker$infer_implicit_constraints("", ctx.type_env, ctx.vars, e1_te_4752, scheme_4755);
        const scheme_4759 = Typechecker$infer_record_evidence(ctx.vars, e1_te_4752, scheme_4757);
        let _t4761;
        if (Typechecker$scheme_needs_xform(scheme_4759)) {
          _t4761 = ({_tag: 1, _name: "Some", _val: scheme_4759});
        } else {
          _t4761 = ({_tag: 0, _name: "None"});
        }
        const stored_scheme_4762 = _t4761;
        const ctx$p_4764 = Typechecker$extend_var(ctx, name, scheme_4759);
        const e2_te_4766 = Typechecker$synth(ctx$p_4764, level, e2);
        const _t4767 = Typechecker$mk(({_tag: 8, _name: "TELet", _val: [name, stored_scheme_4762, e1_te_4752, e2_te_4766]}), e2_te_4766.ty);
        const _t4765 = _t4767;
        const _t4763 = _t4765;
        const _t4760 = _t4763;
        const _t4758 = _t4760;
        const _t4756 = _t4758;
        const _t4753 = _t4756;
        _t4710 = _t4753;
        break _t4711;
      }
      if (_t4709._tag === 26) {
        const name = _t4709._val[0];
        const e1 = _t4709._val[1];
        const e2 = _t4709._val[2];
        const e1_te_4768 = Typechecker$synth(ctx, (level + 1), e1);
        const scheme_4770 = ({body: e1_te_4768.ty, constraints: null, equant: 0, pvquant: 0, quant: 0, record_evidences: null, rquant: 0});
        const ctx$p_4772 = Typechecker$extend_var_mutable(ctx, name, scheme_4770);
        const e2_te_4774 = Typechecker$synth(ctx$p_4772, level, e2);
        const _t4775 = Typechecker$mk(({_tag: 25, _name: "TELetMut", _val: [name, e1_te_4768, e2_te_4774]}), e2_te_4774.ty);
        const _t4773 = _t4775;
        const _t4771 = _t4773;
        const _t4769 = _t4771;
        _t4710 = _t4769;
        break _t4711;
      }
      if (_t4709._tag === 27) {
        const name = _t4709._val[0];
        const e = _t4709._val[1];
        let _t4776;
        if ((!List$mem(name, ctx.mutable_vars))) {
          _t4776 = Typechecker$error((("variable " + __dict_Show_string.show(name)) + " is not mutable"));
        } else {
          _t4776 = undefined;
        }
        _t4776;
        const var_ty_4777 = Typechecker$lookup_var(ctx, level, name);
        const e_te_4779 = Typechecker$check(ctx, level, e, var_ty_4777);
        const resolved_name_4781 = Typechecker$resolve_module_name(ctx, name);
        const _t4782 = Typechecker$mk(({_tag: 26, _name: "TEAssign", _val: [resolved_name_4781, e_te_4779]}), ({_tag: 6, _name: "TUnit"}));
        const _t4780 = _t4782;
        const _t4778 = _t4780;
        _t4710 = _t4778;
        break _t4711;
      }
      if (_t4709._tag === 28) {
        const record_expr = _t4709._val[0];
        const field = _t4709._val[1];
        const value_expr = _t4709._val[2];
        const r_te_4783 = Typechecker$synth(ctx, level, record_expr);
        const field_ty_4785 = Types$new_tvar(level);
        const row_tail_4787 = Types$new_rvar(level);
        let _t4790;
        const _t4789 = Types$repr(r_te_4783.ty);
        _t4791: {
          if (_t4789._tag === 16) {
            function _t4792(__p81) {
              let _t4794;
              const _t4793 = __p81;
              _t4795: {
                if (true) {
                  const _name = _t4793[0];
                  const fields = _t4793[1];
                  _t4794 = List$mem_assoc(field, fields);
                  break _t4795;
                }
                _match_fail("line 15950");
              }
              return _t4794;
            }
            const candidates_4796 = List$filter(_t4792, ctx.type_env.records);
            let _t4799;
            const _t4798 = candidates_4796;
            _t4800: {
              if (_t4798 !== null && _t4798._tl === null) {
                const _name = _t4798._hd[0];
                const fields = _t4798._hd[1];
                const row_4801 = Typechecker$instantiate_record_row(level, fields);
                const _t4802 = Typechecker$try_unify(r_te_4783.ty, ({_tag: 11, _name: "TRecord", _val: row_4801}));
                _t4799 = _t4802;
                break _t4800;
              }
              if (true) {
                _t4799 = Typechecker$try_unify(r_te_4783.ty, ({_tag: 11, _name: "TRecord", _val: ({_tag: 0, _name: "RRow", _val: [field, field_ty_4785, row_tail_4787]})}));
                break _t4800;
              }
              _match_fail("line 15950");
            }
            const _t4797 = _t4799;
            _t4790 = _t4797;
            break _t4791;
          }
          if (true) {
            _t4790 = Typechecker$try_unify(r_te_4783.ty, ({_tag: 11, _name: "TRecord", _val: ({_tag: 0, _name: "RRow", _val: [field, field_ty_4785, row_tail_4787]})}));
            break _t4791;
          }
          _match_fail("line 15950");
        }
        _t4790;
        let _t4804;
        const _t4803 = Types$repr(r_te_4783.ty);
        _t4805: {
          if (_t4803._tag === 11) {
            const row = _t4803._val;
            const fields_4806 = Types$record_row_to_fields(row);
            let _t4809;
            const _t4808 = List$assoc_opt(field, fields_4806);
            _t4810: {
              if (_t4808._tag === 1) {
                const ty = _t4808._val;
                _t4809 = ty;
                break _t4810;
              }
              if (_t4808._tag === 0) {
                _t4809 = Typechecker$error(("record has no field " + __dict_Show_string.show(field)));
                break _t4810;
              }
              _match_fail("line 15950");
            }
            const _t4807 = _t4809;
            _t4804 = _t4807;
            break _t4805;
          }
          if (true) {
            _t4804 = Typechecker$error("field assignment on non-record type");
            break _t4805;
          }
          _match_fail("line 15950");
        }
        const actual_field_ty_4811 = _t4804;
        let _t4813;
        if ((!List$mem(field, ctx.type_env.mutable_fields))) {
          _t4813 = Typechecker$error((("field " + __dict_Show_string.show(field)) + " is not mutable"));
        } else {
          _t4813 = undefined;
        }
        _t4813;
        const v_te_4814 = Typechecker$check(ctx, level, value_expr, actual_field_ty_4811);
        const _t4815 = Typechecker$mk(({_tag: 27, _name: "TEFieldAssign", _val: [r_te_4783, field, v_te_4814]}), ({_tag: 6, _name: "TUnit"}));
        const _t4812 = _t4815;
        const _t4788 = _t4812;
        const _t4786 = _t4788;
        const _t4784 = _t4786;
        _t4710 = _t4784;
        break _t4711;
      }
      if (_t4709._tag === 9) {
        const name = _t4709._val[0];
        const type_params = _t4709._val[1];
        const e1 = _t4709._val[2];
        const e2 = _t4709._val[3];
        let _t4817;
        const _t4816 = Typechecker$strip_loc(e1);
        _t4818: {
          if ((_t4816._tag === 10 || _t4816._tag === 30 && _t4816._val[0]._tag === 10)) {
            let _t4819;
            if (!_eq(type_params, null)) {
              let _t4821;
              const _t4820 = Typechecker$extract_fn_info(e1);
              _t4822: {
                if (true) {
                  const params = _t4820[0];
                  const ret_annot = _t4820[1];
                  const body = _t4820[2];
                  let _t4824;
                  const _t4823 = Typechecker$synth_poly_rec_fn(ctx, level, name, "", type_params, params, ret_annot, body);
                  _t4825: {
                    if (true) {
                      const e1_te = _t4823[0];
                      const scheme = _t4823[1];
                      const ctx$p_4826 = Typechecker$extend_var(ctx, name, scheme);
                      const e2_te_4828 = Typechecker$synth(ctx$p_4826, level, e2);
                      const _t4829 = Typechecker$mk(({_tag: 9, _name: "TELetRec", _val: [name, ({_tag: 0, _name: "None"}), e1_te, e2_te_4828]}), e2_te_4828.ty);
                      const _t4827 = _t4829;
                      _t4824 = _t4827;
                      break _t4825;
                    }
                    _match_fail("line 15950");
                  }
                  _t4821 = _t4824;
                  break _t4822;
                }
                _match_fail("line 15950");
              }
              _t4819 = _t4821;
            } else {
              const fn_var_4830 = Types$new_tvar((level + 1));
              const ctx$p_4832 = Typechecker$extend_var_mono(ctx, name, fn_var_4830);
              const e1_te_4834 = Typechecker$synth(ctx$p_4832, (level + 1), e1);
              Typechecker$try_unify(fn_var_4830, e1_te_4834.ty);
              Typechecker$improve_fundeps_in_expr(ctx.vars, ctx.type_env, e1_te_4834);
              const scheme_4836 = Types$generalize(level, e1_te_4834.ty);
              const scheme_4838 = Typechecker$infer_implicit_constraints(name, ctx.type_env, ctx.vars, e1_te_4834, scheme_4836);
              const scheme_4840 = Typechecker$infer_record_evidence(ctx.vars, e1_te_4834, scheme_4838);
              let _t4842;
              if (Typechecker$scheme_needs_xform(scheme_4840)) {
                _t4842 = ({_tag: 1, _name: "Some", _val: scheme_4840});
              } else {
                _t4842 = ({_tag: 0, _name: "None"});
              }
              const stored_scheme_4843 = _t4842;
              const ctx$p$p_4845 = Typechecker$extend_var(ctx, name, scheme_4840);
              const e2_te_4847 = Typechecker$synth(ctx$p$p_4845, level, e2);
              const _t4848 = Typechecker$mk(({_tag: 9, _name: "TELetRec", _val: [name, stored_scheme_4843, e1_te_4834, e2_te_4847]}), e2_te_4847.ty);
              const _t4846 = _t4848;
              const _t4844 = _t4846;
              const _t4841 = _t4844;
              const _t4839 = _t4841;
              const _t4837 = _t4839;
              const _t4835 = _t4837;
              const _t4833 = _t4835;
              const _t4831 = _t4833;
              _t4819 = _t4831;
            }
            _t4817 = _t4819;
            break _t4818;
          }
          if (true) {
            _t4817 = Typechecker$error("let rec binding must be a function");
            break _t4818;
          }
          _match_fail("line 15950");
        }
        _t4710 = _t4817;
        break _t4711;
      }
      if (_t4709._tag === 12) {
        const cond = _t4709._val[0];
        const then_e = _t4709._val[1];
        const else_e = _t4709._val[2];
        const cond_te_4849 = Typechecker$check(ctx, level, cond, ({_tag: 2, _name: "TBool"}));
        const then_te_4851 = Typechecker$synth(ctx, level, then_e);
        const else_te_4853 = Typechecker$check(ctx, level, else_e, then_te_4851.ty);
        const _t4854 = Typechecker$mk(({_tag: 12, _name: "TEIf", _val: [cond_te_4849, then_te_4851, else_te_4853]}), then_te_4851.ty);
        const _t4852 = _t4854;
        const _t4850 = _t4852;
        _t4710 = _t4850;
        break _t4711;
      }
      if (_t4709._tag === 15) {
        const exprs = _t4709._val;
        const tes_4855 = List$map(_call(Typechecker$synth, [ctx, level]), exprs);
        function _t4857(te) {
          return te.ty;
        }
        const tys_4858 = List$map(_t4857, tes_4855);
        const _t4859 = Typechecker$mk(({_tag: 15, _name: "TETuple", _val: tes_4855}), ({_tag: 9, _name: "TTuple", _val: tys_4858}));
        const _t4856 = _t4859;
        _t4710 = _t4856;
        break _t4711;
      }
      if (_t4709._tag === 16) {
        const fields = _t4709._val;
        function _t4860(__p82) {
          let _t4862;
          const _t4861 = __p82;
          _t4863: {
            if (true) {
              const n = _t4861[0];
              const e = _t4861[1];
              const te_4864 = Typechecker$synth(ctx, level, e);
              const _t4865 = [n, te_4864];
              _t4862 = _t4865;
              break _t4863;
            }
            _match_fail("line 15950");
          }
          return _t4862;
        }
        const typed_fields_4866 = List$map(_t4860, fields);
        function _t4868(__p83) {
          let _t4870;
          const _t4869 = __p83;
          _t4871: {
            if (true) {
              const n = _t4869[0];
              const te = _t4869[1];
              _t4870 = [n, te.ty];
              break _t4871;
            }
            _match_fail("line 15950");
          }
          return _t4870;
        }
        const field_tys_4872 = List$map(_t4868, typed_fields_4866);
        function _t4874(__p84, __p85) {
          let _t4876;
          const _t4875 = __p84;
          _t4877: {
            if (true) {
              const a = _t4875[0];
              let _t4879;
              const _t4878 = __p85;
              _t4880: {
                if (true) {
                  const b = _t4878[0];
                  _t4879 = String$compare(a, b);
                  break _t4880;
                }
                _match_fail("line 15950");
              }
              _t4876 = _t4879;
              break _t4877;
            }
            _match_fail("line 15950");
          }
          return _t4876;
        }
        const field_tys_4881 = List$sort(_t4874, field_tys_4872);
        const row_4883 = Types$fields_to_closed_row(field_tys_4881);
        const _t4884 = Typechecker$mk(({_tag: 16, _name: "TERecord", _val: typed_fields_4866}), ({_tag: 11, _name: "TRecord", _val: row_4883}));
        const _t4882 = _t4884;
        const _t4873 = _t4882;
        const _t4867 = _t4873;
        _t4710 = _t4867;
        break _t4711;
      }
      if (_t4709._tag === 17) {
        const base = _t4709._val[0];
        const overrides = _t4709._val[1];
        const base_te_4885 = Typechecker$synth(ctx, level, base);
        let _t4888;
        const _t4887 = Types$repr(base_te_4885.ty);
        _t4889: {
          if (_t4887._tag === 16) {
            const override_names_4890 = List$map(fst, overrides);
            function _t4892(__p86) {
              let _t4894;
              const _t4893 = __p86;
              _t4895: {
                if (true) {
                  const _name = _t4893[0];
                  const rfields = _t4893[1];
                  function _t4896(f) {
                    return List$mem_assoc(f, rfields);
                  }
                  _t4894 = List$forall(_t4896, override_names_4890);
                  break _t4895;
                }
                _match_fail("line 15950");
              }
              return _t4894;
            }
            const candidates_4897 = List$filter(_t4892, ctx.type_env.records);
            let _t4900;
            const _t4899 = candidates_4897;
            _t4901: {
              if (_t4899 !== null && _t4899._tl === null) {
                const rfields = _t4899._hd[1];
                const row_4902 = Typechecker$instantiate_record_row(level, rfields);
                const _t4903 = Typechecker$try_unify(base_te_4885.ty, ({_tag: 11, _name: "TRecord", _val: row_4902}));
                _t4900 = _t4903;
                break _t4901;
              }
              if (true) {
                const row_tail_4904 = Types$new_rvar(level);
                function _t4906(name, acc) {
                  return ({_tag: 0, _name: "RRow", _val: [name, Types$new_tvar(level), acc]});
                }
                const row_4907 = List$fold_right(_t4906, override_names_4890, row_tail_4904);
                const _t4908 = Typechecker$try_unify(base_te_4885.ty, ({_tag: 11, _name: "TRecord", _val: row_4907}));
                const _t4905 = _t4908;
                _t4900 = _t4905;
                break _t4901;
              }
              _match_fail("line 15950");
            }
            const _t4898 = _t4900;
            const _t4891 = _t4898;
            _t4888 = _t4891;
            break _t4889;
          }
          if (_t4887._tag === 11) {
            _t4888 = undefined;
            break _t4889;
          }
          if (true) {
            _t4888 = Typechecker$error("record update on non-record type");
            break _t4889;
          }
          _match_fail("line 15950");
        }
        _t4888;
        function _t4909(__p87) {
          let _t4911;
          const _t4910 = __p87;
          _t4912: {
            if (true) {
              const name = _t4910[0];
              const field_ty_4913 = Types$new_tvar(level);
              const row_tail_4915 = Types$new_rvar(level);
              Typechecker$try_unify(base_te_4885.ty, ({_tag: 11, _name: "TRecord", _val: ({_tag: 0, _name: "RRow", _val: [name, field_ty_4913, row_tail_4915]})}));
              let _t4918;
              const _t4917 = Types$repr(base_te_4885.ty);
              _t4919: {
                if (_t4917._tag === 11) {
                  const row = _t4917._val;
                  const fields_4920 = Types$record_row_to_fields(row);
                  let _t4923;
                  const _t4922 = List$assoc_opt(name, fields_4920);
                  _t4924: {
                    if (_t4922._tag === 1) {
                      const ty = _t4922._val;
                      _t4923 = ty;
                      break _t4924;
                    }
                    if (_t4922._tag === 0) {
                      _t4923 = field_ty_4913;
                      break _t4924;
                    }
                    _match_fail("line 15950");
                  }
                  const _t4921 = _t4923;
                  _t4918 = _t4921;
                  break _t4919;
                }
                if (true) {
                  _t4918 = field_ty_4913;
                  break _t4919;
                }
                _match_fail("line 15950");
              }
              const actual_ty_4925 = _t4918;
              const _t4926 = [name, actual_ty_4925];
              const _t4916 = _t4926;
              const _t4914 = _t4916;
              _t4911 = _t4914;
              break _t4912;
            }
            _match_fail("line 15950");
          }
          return _t4911;
        }
        const override_field_tys_4927 = List$map(_t4909, overrides);
        function _t4929(__p88, __p89) {
          let _t4931;
          const _t4930 = __p88;
          _t4932: {
            if (true) {
              const name = _t4930[0];
              const e = _t4930[1];
              let _t4934;
              const _t4933 = __p89;
              _t4935: {
                if (true) {
                  const expected_ty = _t4933[1];
                  const te_4936 = Typechecker$check(ctx, level, e, expected_ty);
                  const _t4937 = [name, te_4936];
                  _t4934 = _t4937;
                  break _t4935;
                }
                _match_fail("line 15950");
              }
              _t4931 = _t4934;
              break _t4932;
            }
            _match_fail("line 15950");
          }
          return _t4931;
        }
        const typed_overrides_4938 = List$map2(_t4929, overrides, override_field_tys_4927);
        function has_open_tail(row) {
          while (true) {
            let _t4941;
            const _t4940 = Types$rrow_repr(row);
            _t4942: {
              if (_t4940._tag === 0) {
                const tail = _t4940._val[2];
                const _t4943 = tail;
                row = _t4943;
                continue;
                _t4941 = undefined;
                break _t4942;
              }
              if (_t4940._tag === 1 && _t4940._val.contents._tag === 0) {
                _t4941 = true;
                break _t4942;
              }
              if (true) {
                _t4941 = false;
                break _t4942;
              }
              _match_fail("line 15950");
            }
            return _t4941;
          }
        }
        let _t4946;
        const _t4945 = Types$repr(base_te_4885.ty);
        _t4947: {
          if (_t4945._tag === 11) {
            const row = _t4945._val;
            _t4946 = has_open_tail(row);
            break _t4947;
          }
          if (true) {
            _t4946 = false;
            break _t4947;
          }
          _match_fail("line 15950");
        }
        const is_open_4948 = _t4946;
        let _t4950;
        if (is_open_4948) {
          _t4950 = Typechecker$mk(({_tag: 17, _name: "TERecordUpdate", _val: [base_te_4885, typed_overrides_4938]}), base_te_4885.ty);
        } else {
          let _t4952;
          const _t4951 = Types$repr(base_te_4885.ty);
          _t4953: {
            if (_t4951._tag === 11) {
              const row = _t4951._val;
              _t4952 = Types$record_row_to_fields(row);
              break _t4953;
            }
            if (true) {
              _t4952 = Typechecker$error("record update on non-record type");
              break _t4953;
            }
            _match_fail("line 15950");
          }
          const field_tys_4954 = _t4952;
          const tmp_4956 = "__rec_upd";
          const tmp_ty_4958 = base_te_4885.ty;
          function _t4960(__p90) {
            let _t4962;
            const _t4961 = __p90;
            _t4963: {
              if (true) {
                const name = _t4961[0];
                const ty = _t4961[1];
                let _t4965;
                const _t4964 = List$assoc_opt(name, typed_overrides_4938);
                _t4966: {
                  if (_t4964._tag === 1) {
                    const te = _t4964._val;
                    _t4965 = [name, te];
                    break _t4966;
                  }
                  if (_t4964._tag === 0) {
                    _t4965 = [name, Typechecker$mk(({_tag: 19, _name: "TEField", _val: [Typechecker$mk(({_tag: 7, _name: "TEVar", _val: tmp_4956}), tmp_ty_4958), name]}), ty)];
                    break _t4966;
                  }
                  _match_fail("line 15950");
                }
                _t4962 = _t4965;
                break _t4963;
              }
              _match_fail("line 15950");
            }
            return _t4962;
          }
          const all_fields_4967 = List$map(_t4960, field_tys_4954);
          const record_row_4969 = Types$fields_to_closed_row(field_tys_4954);
          const record_expr_4971 = Typechecker$mk(({_tag: 16, _name: "TERecord", _val: all_fields_4967}), ({_tag: 11, _name: "TRecord", _val: record_row_4969}));
          const _t4972 = Typechecker$mk(({_tag: 8, _name: "TELet", _val: [tmp_4956, ({_tag: 0, _name: "None"}), base_te_4885, record_expr_4971]}), ({_tag: 11, _name: "TRecord", _val: record_row_4969}));
          const _t4970 = _t4972;
          const _t4968 = _t4970;
          const _t4959 = _t4968;
          const _t4957 = _t4959;
          const _t4955 = _t4957;
          _t4950 = _t4955;
        }
        const _t4949 = _t4950;
        const _t4944 = _t4949;
        const _t4939 = _t4944;
        const _t4928 = _t4939;
        const _t4886 = _t4928;
        _t4710 = _t4886;
        break _t4711;
      }
      if (_t4709._tag === 18) {
        const e = _t4709._val[0];
        const field = _t4709._val[1];
        const te_4973 = Typechecker$synth(ctx, level, e);
        const field_ty_4975 = Types$new_tvar(level);
        const row_tail_4977 = Types$new_rvar(level);
        let _t4980;
        const _t4979 = Types$repr(te_4973.ty);
        _t4981: {
          if (_t4979._tag === 16) {
            function _t4982(__p91) {
              let _t4984;
              const _t4983 = __p91;
              _t4985: {
                if (true) {
                  const _name = _t4983[0];
                  const fields = _t4983[1];
                  _t4984 = List$mem_assoc(field, fields);
                  break _t4985;
                }
                _match_fail("line 15950");
              }
              return _t4984;
            }
            const candidates_4986 = List$filter(_t4982, ctx.type_env.records);
            let _t4989;
            const _t4988 = candidates_4986;
            _t4990: {
              if (_t4988 !== null && _t4988._tl === null) {
                const _name = _t4988._hd[0];
                const fields = _t4988._hd[1];
                const row_4991 = Typechecker$instantiate_record_row(level, fields);
                const _t4992 = Typechecker$try_unify(te_4973.ty, ({_tag: 11, _name: "TRecord", _val: row_4991}));
                _t4989 = _t4992;
                break _t4990;
              }
              if (true) {
                _t4989 = Typechecker$try_unify(te_4973.ty, ({_tag: 11, _name: "TRecord", _val: ({_tag: 0, _name: "RRow", _val: [field, field_ty_4975, row_tail_4977]})}));
                break _t4990;
              }
              _match_fail("line 15950");
            }
            const _t4987 = _t4989;
            _t4980 = _t4987;
            break _t4981;
          }
          if (true) {
            _t4980 = Typechecker$try_unify(te_4973.ty, ({_tag: 11, _name: "TRecord", _val: ({_tag: 0, _name: "RRow", _val: [field, field_ty_4975, row_tail_4977]})}));
            break _t4981;
          }
          _match_fail("line 15950");
        }
        _t4980;
        let _t4994;
        const _t4993 = Types$repr(te_4973.ty);
        _t4995: {
          if (_t4993._tag === 11) {
            const row = _t4993._val;
            const fields_4996 = Types$record_row_to_fields(row);
            let _t4999;
            const _t4998 = List$assoc_opt(field, fields_4996);
            _t5000: {
              if (_t4998._tag === 1) {
                const ty = _t4998._val;
                _t4999 = ty;
                break _t5000;
              }
              if (_t4998._tag === 0) {
                _t4999 = field_ty_4975;
                break _t5000;
              }
              _match_fail("line 15950");
            }
            const _t4997 = _t4999;
            _t4994 = _t4997;
            break _t4995;
          }
          if (true) {
            _t4994 = field_ty_4975;
            break _t4995;
          }
          _match_fail("line 15950");
        }
        const actual_field_ty_5001 = _t4994;
        const _t5002 = Typechecker$mk(({_tag: 19, _name: "TEField", _val: [te_4973, field]}), actual_field_ty_5001);
        const _t4978 = _t5002;
        const _t4976 = _t4978;
        const _t4974 = _t4976;
        _t4710 = _t4974;
        break _t4711;
      }
      if (_t4709._tag === 19) {
        const base = _t4709._val[0];
        const idx = _t4709._val[1];
        const te_base_5003 = Typechecker$synth(ctx, level, base);
        let _t5006;
        const _t5005 = Types$repr(te_base_5003.ty);
        _t5007: {
          if (_t5005._tag === 3) {
            const te_idx_5008 = Typechecker$check(ctx, level, idx, ({_tag: 0, _name: "TInt"}));
            const _t5009 = Typechecker$mk(({_tag: 20, _name: "TEIndex", _val: [te_base_5003, te_idx_5008]}), ({_tag: 4, _name: "TByte"}));
            _t5006 = _t5009;
            break _t5007;
          }
          if (_t5005._tag === 14) {
            const t = _t5005._val;
            const te_idx_5010 = Typechecker$check(ctx, level, idx, ({_tag: 0, _name: "TInt"}));
            const _t5011 = Typechecker$mk(({_tag: 20, _name: "TEIndex", _val: [te_base_5003, te_idx_5010]}), t);
            _t5006 = _t5011;
            break _t5007;
          }
          if (true) {
            const te_5012 = Typechecker$synth(ctx, level, ({_tag: 11, _name: "EApp", _val: [({_tag: 11, _name: "EApp", _val: [({_tag: 7, _name: "EVar", _val: "at"}), idx]}), base]}));
            function _t5014(c) {
              return (c.class_name === "Index");
            }
            let _t5016;
            const _t5015 = List$find(_t5014, ctx.type_env.classes);
            _t5017: {
              if (_t5015._tag === 1) {
                const class_def = _t5015._val;
                if (!_eq(class_def.class_fundeps, null)) {
                  const container_ty_5018 = Types$repr(te_base_5003.ty);
                  const partial_5020 = ({_hd: ({_tag: 1, _name: "Some", _val: container_ty_5018}), _tl: ({_hd: ({_tag: 0, _name: "None"}), _tl: ({_hd: ({_tag: 0, _name: "None"}), _tl: null})})});
                  const improved_5022 = Types$improve_with_fundeps(ctx.type_env.instances, class_def, partial_5020);
                  let _t5025;
                  const _t5024 = List$nth_opt(improved_5022, 2);
                  _t5026: {
                    if (_t5024._tag === 1 && _t5024._val._tag === 1) {
                      const val_ty = _t5024._val._val;
                      _t5025 = Typechecker$try_unify(te_5012.ty, val_ty);
                      break _t5026;
                    }
                    if (true) {
                      _t5025 = undefined;
                      break _t5026;
                    }
                    _match_fail("line 15950");
                  }
                  const _t5023 = _t5025;
                  const _t5021 = _t5023;
                  const _t5019 = _t5021;
                  _t5016 = _t5019;
                  break _t5017;
                }
              }
              if (true) {
                _t5016 = undefined;
                break _t5017;
              }
              _match_fail("line 15950");
            }
            _t5016;
            const _t5013 = te_5012;
            _t5006 = _t5013;
            break _t5007;
          }
          _match_fail("line 15950");
        }
        const _t5004 = _t5006;
        _t4710 = _t5004;
        break _t4711;
      }
      if (_t4709._tag === 20) {
        const hd = _t4709._val[0];
        const tl = _t4709._val[1];
        const hd_te_5027 = Typechecker$synth(ctx, level, hd);
        const list_ty_5029 = ({_tag: 10, _name: "TList", _val: hd_te_5027.ty});
        const tl_te_5031 = Typechecker$check(ctx, level, tl, list_ty_5029);
        const _t5032 = Typechecker$mk(({_tag: 21, _name: "TECons", _val: [hd_te_5027, tl_te_5031]}), list_ty_5029);
        const _t5030 = _t5032;
        const _t5028 = _t5030;
        _t4710 = _t5028;
        break _t4711;
      }
      if (_t4709._tag === 22 && _t4709._val !== null) {
        const first = _t4709._val._hd;
        const rest = _t4709._val._tl;
        const first_te_5033 = Typechecker$synth(ctx, level, first);
        function _t5035(e) {
          return Typechecker$check(ctx, level, e, first_te_5033.ty);
        }
        const rest_tes_5036 = List$map(_t5035, rest);
        const list_ty_5038 = ({_tag: 10, _name: "TList", _val: first_te_5033.ty});
        function _t5040(te, acc) {
          return Typechecker$mk(({_tag: 21, _name: "TECons", _val: [te, acc]}), list_ty_5038);
        }
        const _t5039 = Typechecker$mk(({_tag: 21, _name: "TECons", _val: [first_te_5033, List$fold_right(_t5040, rest_tes_5036, Typechecker$mk(({_tag: 22, _name: "TENil"}), list_ty_5038))]}), list_ty_5038);
        const _t5037 = _t5039;
        const _t5034 = _t5037;
        _t4710 = _t5034;
        break _t4711;
      }
      if (_t4709._tag === 22 && _t4709._val === null) {
        _t4710 = Typechecker$mk(({_tag: 22, _name: "TENil"}), ({_tag: 10, _name: "TList", _val: Types$new_tvar(level)}));
        break _t4711;
      }
      if (_t4709._tag === 23 && _t4709._val !== null) {
        const first = _t4709._val._hd;
        const rest = _t4709._val._tl;
        const first_te_5041 = Typechecker$synth(ctx, level, first);
        function _t5043(e) {
          return Typechecker$check(ctx, level, e, first_te_5041.ty);
        }
        const rest_tes_5044 = List$map(_t5043, rest);
        const _t5045 = Typechecker$mk(({_tag: 39, _name: "TEArray", _val: ({_hd: first_te_5041, _tl: rest_tes_5044})}), ({_tag: 14, _name: "TArray", _val: first_te_5041.ty}));
        const _t5042 = _t5045;
        _t4710 = _t5042;
        break _t4711;
      }
      if (_t4709._tag === 23 && _t4709._val === null) {
        _t4710 = Typechecker$mk(({_tag: 39, _name: "TEArray", _val: null}), ({_tag: 14, _name: "TArray", _val: Types$new_tvar(level)}));
        break _t4711;
      }
      if (_t4709._tag === 24) {
        const name = _t4709._val[0];
        const arg = _t4709._val[1];
        _t4710 = Typechecker$synth_construct(ctx, level, name, arg);
        break _t4711;
      }
      if (_t4709._tag === 25) {
        const scrut = _t4709._val[0];
        const arms = _t4709._val[1];
        const partial = _t4709._val[2];
        _t4710 = Typechecker$synth_match(({_tag: 0, _name: "None"}), ctx, level, scrut, arms, partial);
        break _t4711;
      }
      if (_t4709._tag === 29) {
        const e1 = _t4709._val[0];
        const e2 = _t4709._val[1];
        const e1_te_5046 = Typechecker$synth(ctx, level, e1);
        const e2_te_5048 = Typechecker$synth(ctx, level, e2);
        const _t5049 = Typechecker$mk(({_tag: 28, _name: "TESeq", _val: [e1_te_5046, e2_te_5048]}), e2_te_5048.ty);
        const _t5047 = _t5049;
        _t4710 = _t5047;
        break _t4711;
      }
      if (_t4709._tag === 30) {
        const e = _t4709._val[0];
        const annot = _t4709._val[1];
        const ty_5050 = Typechecker$resolve_ty_annot(ctx, level, annot);
        const te_5052 = Typechecker$check(ctx, level, e, ty_5050);
        const _t5053 = te_5052;
        const _t5051 = _t5053;
        _t4710 = _t5051;
        break _t4711;
      }
      if (_t4709._tag === 46 && _t4709._val[1]._tag === 0) {
        const tag = _t4709._val[0];
        const tail_5054 = Types$new_pvvar(level);
        const row_5056 = ({_tag: 0, _name: "PVRow", _val: [tag, ({_tag: 0, _name: "None"}), tail_5054]});
        const _t5057 = Typechecker$mk(({_tag: 23, _name: "TEConstruct", _val: [("`" + tag), ({_tag: 0, _name: "None"})]}), ({_tag: 15, _name: "TPolyVariant", _val: row_5056}));
        const _t5055 = _t5057;
        _t4710 = _t5055;
        break _t4711;
      }
      if (_t4709._tag === 46 && _t4709._val[1]._tag === 1) {
        const tag = _t4709._val[0];
        const arg = _t4709._val[1]._val;
        const arg_te_5058 = Typechecker$synth(ctx, level, arg);
        const tail_5060 = Types$new_pvvar(level);
        const row_5062 = ({_tag: 0, _name: "PVRow", _val: [tag, ({_tag: 1, _name: "Some", _val: arg_te_5058.ty}), tail_5060]});
        const _t5063 = Typechecker$mk(({_tag: 23, _name: "TEConstruct", _val: [("`" + tag), ({_tag: 1, _name: "Some", _val: arg_te_5058})]}), ({_tag: 15, _name: "TPolyVariant", _val: row_5062}));
        const _t5061 = _t5063;
        const _t5059 = _t5061;
        _t4710 = _t5059;
        break _t4711;
      }
      if (_t4709._tag === 47) {
        const inner = _t4709._val[0];
        const target_annot = _t4709._val[1];
        const inner_te_5064 = Typechecker$synth(ctx, level, inner);
        const target_ty_5066 = Typechecker$resolve_ty_annot(ctx, level, target_annot);
        Typechecker$try_unify(inner_te_5064.ty, target_ty_5066);
        const __rec_upd_5068 = inner_te_5064;
        const _t5069 = ({expr: __rec_upd_5068.expr, loc: __rec_upd_5068.loc, ty: target_ty_5066});
        const _t5067 = _t5069;
        const _t5065 = _t5067;
        _t4710 = _t5065;
        break _t4711;
      }
      if (_t4709._tag === 39) {
        const op_name = _t4709._val[0];
        const arg = _t4709._val[1];
        _t4710 = Typechecker$synth_perform(ctx, level, op_name, arg);
        break _t4711;
      }
      if (_t4709._tag === 40) {
        const body = _t4709._val[0];
        const arms = _t4709._val[1];
        _t4710 = Typechecker$synth_handle(ctx, level, body, arms);
        break _t4711;
      }
      if (_t4709._tag === 31) {
        const cond = _t4709._val[0];
        const body = _t4709._val[1];
        const __rec_upd_5070 = ctx;
        const _t5071 = ({constraint_tvars: __rec_upd_5070.constraint_tvars, current_eff: __rec_upd_5070.current_eff, current_module: __rec_upd_5070.current_module, inside_handler: __rec_upd_5070.inside_handler, loop_info: ({_tag: 1, _name: "Some", _val: ({_tag: 0, _name: "WhileLoop"})}), mutable_vars: __rec_upd_5070.mutable_vars, return_type: __rec_upd_5070.return_type, return_used: __rec_upd_5070.return_used, type_env: __rec_upd_5070.type_env, vars: __rec_upd_5070.vars});
        const ctx$p_5072 = _t5071;
        const cond_te_5074 = Typechecker$check(ctx$p_5072, level, cond, ({_tag: 2, _name: "TBool"}));
        const body_te_5076 = Typechecker$check(ctx$p_5072, level, body, ({_tag: 6, _name: "TUnit"}));
        const _t5077 = Typechecker$mk(({_tag: 32, _name: "TEWhile", _val: [cond_te_5074, body_te_5076]}), ({_tag: 6, _name: "TUnit"}));
        const _t5075 = _t5077;
        const _t5073 = _t5075;
        _t4710 = _t5073;
        break _t4711;
      }
      if (_t4709._tag === 32) {
        const var_name = _t4709._val[0];
        const coll_expr = _t4709._val[1];
        const body_expr = _t4709._val[2];
        const __rec_upd_5078 = ctx;
        const _t5079 = ({constraint_tvars: __rec_upd_5078.constraint_tvars, current_eff: __rec_upd_5078.current_eff, current_module: __rec_upd_5078.current_module, inside_handler: __rec_upd_5078.inside_handler, loop_info: ({_tag: 1, _name: "Some", _val: ({_tag: 1, _name: "UnitLoop"})}), mutable_vars: __rec_upd_5078.mutable_vars, return_type: __rec_upd_5078.return_type, return_used: __rec_upd_5078.return_used, type_env: __rec_upd_5078.type_env, vars: __rec_upd_5078.vars});
        const ctx$p_5080 = _t5079;
        const desugared_5082 = ({_tag: 11, _name: "EApp", _val: [({_tag: 11, _name: "EApp", _val: [({_tag: 11, _name: "EApp", _val: [({_tag: 7, _name: "EVar", _val: "fold"}), ({_tag: 10, _name: "EFun", _val: [({annot: ({_tag: 0, _name: "None"}), is_generated: true, name: "_"}), ({_tag: 10, _name: "EFun", _val: [({annot: ({_tag: 0, _name: "None"}), is_generated: true, name: var_name}), ({_tag: 29, _name: "ESeq", _val: [body_expr, ({_tag: 6, _name: "EUnit"})]})]})]})]}), ({_tag: 6, _name: "EUnit"})]}), coll_expr]});
        const fold_te_5084 = Typechecker$synth(ctx$p_5080, level, desugared_5082);
        const _t5085 = Typechecker$mk(({_tag: 36, _name: "TEForLoop", _val: fold_te_5084}), ({_tag: 6, _name: "TUnit"}));
        const _t5083 = _t5085;
        const _t5081 = _t5083;
        _t4710 = _t5081;
        break _t4711;
      }
      if (_t4709._tag === 33) {
        const var_name = _t4709._val[0];
        const coll_expr = _t4709._val[1];
        const acc_name = _t4709._val[2];
        const init_expr = _t4709._val[3];
        const body_expr = _t4709._val[4];
        const __rec_upd_5086 = ctx;
        const _t5087 = ({constraint_tvars: __rec_upd_5086.constraint_tvars, current_eff: __rec_upd_5086.current_eff, current_module: __rec_upd_5086.current_module, inside_handler: __rec_upd_5086.inside_handler, loop_info: ({_tag: 1, _name: "Some", _val: ({_tag: 2, _name: "FoldLoop", _val: acc_name})}), mutable_vars: __rec_upd_5086.mutable_vars, return_type: __rec_upd_5086.return_type, return_used: __rec_upd_5086.return_used, type_env: __rec_upd_5086.type_env, vars: __rec_upd_5086.vars});
        const ctx$p_5088 = _t5087;
        const desugared_5090 = ({_tag: 11, _name: "EApp", _val: [({_tag: 11, _name: "EApp", _val: [({_tag: 11, _name: "EApp", _val: [({_tag: 7, _name: "EVar", _val: "fold"}), ({_tag: 10, _name: "EFun", _val: [({annot: ({_tag: 0, _name: "None"}), is_generated: true, name: acc_name}), ({_tag: 10, _name: "EFun", _val: [({annot: ({_tag: 0, _name: "None"}), is_generated: true, name: var_name}), body_expr]})]})]}), init_expr]}), coll_expr]});
        const fold_te_5092 = Typechecker$synth(ctx$p_5088, level, desugared_5090);
        const _t5093 = Typechecker$mk(({_tag: 36, _name: "TEForLoop", _val: fold_te_5092}), fold_te_5092.ty);
        const _t5091 = _t5093;
        const _t5089 = _t5091;
        _t4710 = _t5089;
        break _t4711;
      }
      if (_t4709._tag === 35) {
        const value_opt = _t4709._val;
        let _t5095;
        const _t5094 = ctx.loop_info;
        _t5096: {
          if (_t5094._tag === 0) {
            _t5095 = Typechecker$error("break outside of loop");
            break _t5096;
          }
          if (_t5094._tag === 1 && _t5094._val._tag === 0) {
            let _t5097;
            if (!_eq(value_opt, ({_tag: 0, _name: "None"}))) {
              _t5097 = Typechecker$error("break with value only allowed in fold loops");
            } else {
              _t5097 = undefined;
            }
            _t5097;
            _t5095 = Typechecker$mk(({_tag: 33, _name: "TEBreak", _val: Typechecker$mk(({_tag: 6, _name: "TEUnit"}), ({_tag: 6, _name: "TUnit"}))}), ({_tag: 6, _name: "TUnit"}));
            break _t5096;
          }
          if (_t5094._tag === 1 && _t5094._val._tag === 1) {
            let _t5098;
            if (!_eq(value_opt, ({_tag: 0, _name: "None"}))) {
              _t5098 = Typechecker$error("break with value only allowed in fold loops");
            } else {
              _t5098 = undefined;
            }
            _t5098;
            _t5095 = Typechecker$mk(({_tag: 33, _name: "TEBreak", _val: Typechecker$mk(({_tag: 6, _name: "TEUnit"}), ({_tag: 6, _name: "TUnit"}))}), ({_tag: 6, _name: "TUnit"}));
            break _t5096;
          }
          if (_t5094._tag === 1 && _t5094._val._tag === 2) {
            const acc_name = _t5094._val._val;
            let _t5100;
            const _t5099 = value_opt;
            _t5101: {
              if (_t5099._tag === 1) {
                const e = _t5099._val;
                _t5100 = Typechecker$synth(ctx, level, e);
                break _t5101;
              }
              if (_t5099._tag === 0) {
                _t5100 = Typechecker$synth(ctx, level, ({_tag: 7, _name: "EVar", _val: acc_name}));
                break _t5101;
              }
              _match_fail("line 15950");
            }
            const v_te_5102 = _t5100;
            const _t5103 = Typechecker$mk(({_tag: 33, _name: "TEBreak", _val: v_te_5102}), Types$new_tvar(level));
            _t5095 = _t5103;
            break _t5096;
          }
          _match_fail("line 15950");
        }
        _t4710 = _t5095;
        break _t4711;
      }
      if (_t4709._tag === 36) {
        let _t5105;
        const _t5104 = ctx.loop_info;
        _t5106: {
          if (_t5104._tag === 0) {
            _t5105 = Typechecker$error("continue outside of loop");
            break _t5106;
          }
          if (_t5104._tag === 1 && _t5104._val._tag === 0) {
            _t5105 = Typechecker$mk(({_tag: 34, _name: "TEContinueLoop"}), ({_tag: 6, _name: "TUnit"}));
            break _t5106;
          }
          if (_t5104._tag === 1 && _t5104._val._tag === 1) {
            _t5105 = Typechecker$mk(({_tag: 35, _name: "TEFoldContinue", _val: Typechecker$mk(({_tag: 6, _name: "TEUnit"}), ({_tag: 6, _name: "TUnit"}))}), ({_tag: 6, _name: "TUnit"}));
            break _t5106;
          }
          if (_t5104._tag === 1 && _t5104._val._tag === 2) {
            const acc_name = _t5104._val._val;
            const acc_te_5107 = Typechecker$synth(ctx, level, ({_tag: 7, _name: "EVar", _val: acc_name}));
            const _t5108 = Typechecker$mk(({_tag: 35, _name: "TEFoldContinue", _val: acc_te_5107}), Types$new_tvar(level));
            _t5105 = _t5108;
            break _t5106;
          }
          _match_fail("line 15950");
        }
        _t4710 = _t5105;
        break _t4711;
      }
      if (_t4709._tag === 37) {
        const e = _t4709._val;
        let _t5110;
        const _t5109 = ctx.return_type;
        _t5111: {
          if (_t5109._tag === 0) {
            _t5110 = Typechecker$error("return outside of function");
            break _t5111;
          }
          if (_t5109._tag === 1) {
            const ret_ty = _t5109._val;
            let _t5112;
            if (ctx.inside_handler) {
              _t5112 = Typechecker$error("Type error: return inside try/with is not supported");
            } else {
              _t5112 = undefined;
            }
            _t5112;
            Ref$set(ctx.return_used, true);
            const e_te_5113 = Typechecker$synth(ctx, level, e);
            Typechecker$try_unify(e_te_5113.ty, ret_ty);
            const _t5114 = Typechecker$mk(({_tag: 40, _name: "TEReturn", _val: e_te_5113}), Types$new_tvar(level));
            _t5110 = _t5114;
            break _t5111;
          }
          _match_fail("line 15950");
        }
        _t4710 = _t5110;
        break _t4711;
      }
      if (_t4709._tag === 34) {
        const pat = _t4709._val[0];
        const scrutinee = _t4709._val[1];
        const body = _t4709._val[2];
        const desugared_5115 = ({_tag: 31, _name: "EWhile", _val: [({_tag: 2, _name: "EBool", _val: true}), ({_tag: 25, _name: "EMatch", _val: [scrutinee, ({_hd: [pat, ({_tag: 0, _name: "None"}), body], _tl: ({_hd: [({_tag: 0, _name: "PatWild"}), ({_tag: 0, _name: "None"}), ({_tag: 35, _name: "EBreak", _val: ({_tag: 0, _name: "None"})})], _tl: null})}), false]})]});
        const _t5116 = Typechecker$synth(ctx, level, desugared_5115);
        _t4710 = _t5116;
        break _t4711;
      }
      if (_t4709._tag === 41) {
        const k_expr = _t4709._val[0];
        const v_expr = _t4709._val[1];
        const k_te_5117 = Typechecker$synth(ctx, level, k_expr);
        const v_te_5119 = Typechecker$synth(ctx, level, v_expr);
        const ret_ty_5121 = Types$new_tvar(level);
        const call_eff_5123 = Types$new_effvar(level);
        Typechecker$try_unify(k_te_5117.ty, ({_tag: 8, _name: "TCont", _val: [v_te_5119.ty, call_eff_5123, ret_ty_5121]}));
        Typechecker$try_subeffect(call_eff_5123, ctx.current_eff);
        const _t5124 = Typechecker$mk(({_tag: 31, _name: "TEResume", _val: [k_te_5117, v_te_5119]}), ret_ty_5121);
        const _t5122 = _t5124;
        const _t5120 = _t5122;
        const _t5118 = _t5120;
        _t4710 = _t5118;
        break _t4711;
      }
      if (_t4709._tag === 42 && _t4709._val === null) {
        const kt_5125 = Types$new_tvar(level);
        const vt_5127 = Types$new_tvar(level);
        const _t5128 = Typechecker$mk(({_tag: 38, _name: "TEMap", _val: null}), ({_tag: 13, _name: "TMap", _val: [kt_5125, vt_5127]}));
        const _t5126 = _t5128;
        _t4710 = _t5126;
        break _t4711;
      }
      if (_t4709._tag === 42 && _t4709._val !== null) {
        const k1 = _t4709._val._hd[0];
        const v1 = _t4709._val._hd[1];
        const rest = _t4709._val._tl;
        const k1_te_5129 = Typechecker$synth(ctx, level, k1);
        const v1_te_5131 = Typechecker$synth(ctx, level, v1);
        function _t5133(__p92) {
          let _t5135;
          const _t5134 = __p92;
          _t5136: {
            if (true) {
              const k = _t5134[0];
              const v = _t5134[1];
              const kt_5137 = Typechecker$check(ctx, level, k, k1_te_5129.ty);
              const vt_5139 = Typechecker$check(ctx, level, v, v1_te_5131.ty);
              const _t5140 = [kt_5137, vt_5139];
              const _t5138 = _t5140;
              _t5135 = _t5138;
              break _t5136;
            }
            _match_fail("line 15950");
          }
          return _t5135;
        }
        const rest_tes_5141 = List$map(_t5133, rest);
        const _t5142 = Typechecker$mk(({_tag: 38, _name: "TEMap", _val: ({_hd: [k1_te_5129, v1_te_5131], _tl: rest_tes_5141})}), ({_tag: 13, _name: "TMap", _val: [k1_te_5129.ty, v1_te_5131.ty]}));
        const _t5132 = _t5142;
        const _t5130 = _t5132;
        _t4710 = _t5130;
        break _t4711;
      }
      if (_t4709._tag === 43) {
        const mod_name = _t4709._val[0];
        const pairs = _t4709._val[1];
        function _t5143(__p93) {
          let _t5145;
          const _t5144 = __p93;
          _t5146: {
            if (true) {
              const k = _t5144[0];
              const v = _t5144[1];
              _t5145 = ({_tag: 15, _name: "ETuple", _val: ({_hd: k, _tl: ({_hd: v, _tl: null})})});
              break _t5146;
            }
            _match_fail("line 15950");
          }
          return _t5145;
        }
        const pair_list_5147 = ({_tag: 22, _name: "EList", _val: List$map(_t5143, pairs)});
        const desugared_5149 = ({_tag: 11, _name: "EApp", _val: [({_tag: 7, _name: "EVar", _val: (mod_name + ".of_list")}), pair_list_5147]});
        const _t5150 = Typechecker$synth(ctx, level, desugared_5149);
        const _t5148 = _t5150;
        _t4710 = _t5148;
        break _t4711;
      }
      if (_t4709._tag === 44) {
        const elems = _t4709._val;
        const list_expr_5151 = ({_tag: 22, _name: "EList", _val: elems});
        const desugared_5153 = ({_tag: 11, _name: "EApp", _val: [({_tag: 7, _name: "EVar", _val: "Set.of_list"}), list_expr_5151]});
        const _t5154 = Typechecker$synth(ctx, level, desugared_5153);
        const _t5152 = _t5154;
        _t4710 = _t5152;
        break _t4711;
      }
      if (_t4709._tag === 45) {
        const mod_name = _t4709._val[0];
        const elems = _t4709._val[1];
        const list_expr_5155 = ({_tag: 22, _name: "EList", _val: elems});
        const desugared_5157 = ({_tag: 11, _name: "EApp", _val: [({_tag: 7, _name: "EVar", _val: (mod_name + ".of_list")}), list_expr_5155]});
        const _t5158 = Typechecker$synth(ctx, level, desugared_5157);
        const _t5156 = _t5158;
        _t4710 = _t5156;
        break _t4711;
      }
      if (_t4709._tag === 48) {
        const mod_name = _t4709._val[0];
        const inner_expr = _t4709._val[1];
        let _t5160;
        const _t5159 = Ref$get(Typechecker$find_module_in_env_ref, ctx.type_env, mod_name);
        _t5161: {
          if (_t5159._tag === 1) {
            const m = _t5159._val;
            _t5160 = m;
            break _t5161;
          }
          if (_t5159._tag === 0) {
            _t5160 = Typechecker$error(("unknown module: " + __dict_Show_string.show(mod_name)));
            break _t5161;
          }
          _match_fail("line 15950");
        }
        const minfo_5162 = _t5160;
        function _t5164(body, __p94) {
          let _t5166;
          const _t5165 = __p94;
          _t5167: {
            if (true) {
              const _mml$short = _t5165[0];
              const _scheme = _t5165[1];
              const qualified_5168 = (mod_name + ("." + _mml$short));
              const _t5169 = ({_tag: 8, _name: "ELet", _val: [_mml$short, ({_tag: 7, _name: "EVar", _val: qualified_5168}), body]});
              _t5166 = _t5169;
              break _t5167;
            }
            _match_fail("line 15950");
          }
          return _t5166;
        }
        const desugared_5170 = List$fold(_t5164, inner_expr, minfo_5162.mod_pub_vars);
        const _t5171 = Typechecker$synth(ctx, level, desugared_5170);
        const _t5163 = _t5171;
        _t4710 = _t5163;
        break _t4711;
      }
      if (_t4709._tag === 38) {
        const bindings = _t4709._val[0];
        const body = _t4709._val[1];
        function _t5172(__p95) {
          let _t5174;
          const _t5173 = __p95;
          _t5175: {
            if (true) {
              const tp = _t5173[1];
              _t5174 = !_eq(tp, null);
              break _t5175;
            }
            _match_fail("line 15950");
          }
          return _t5174;
        }
        const has_poly_5176 = List$exists(_t5172, bindings);
        let _t5178;
        if (has_poly_5176) {
          function _t5179(__p96) {
            let _t5181;
            const _t5180 = __p96;
            _t5182: {
              if (true) {
                const name = _t5180[0];
                const type_params = _t5180[1];
                const fn_expr = _t5180[2];
                let _t5184;
                const _t5183 = Typechecker$extract_fn_info(fn_expr);
                _t5185: {
                  if (true) {
                    const params = _t5183[0];
                    const ret_annot = _t5183[1];
                    const inner_body = _t5183[2];
                    _t5184 = [name, type_params, params, ret_annot, inner_body];
                    break _t5185;
                  }
                  _match_fail("line 15950");
                }
                _t5181 = _t5184;
                break _t5182;
              }
              _match_fail("line 15950");
            }
            return _t5181;
          }
          const infos_5186 = List$map(_t5179, bindings);
          function _t5188(__p97) {
            let _t5190;
            const _t5189 = __p97;
            _t5191: {
              if (true) {
                const type_params = _t5189[1];
                const params = _t5189[2];
                const ret_annot = _t5189[3];
                const shared_tvars_5192 = Hashtbl$create(4);
                function _t5194(tp) {
                  return _call(Hashtbl$set, [__dict_Hash_string, __dict_Eq_string, shared_tvars_5192, tp, Types$new_tvar((level + 1))]);
                }
                List$iter(_t5194, type_params);
                function _t5195(p) {
                  let _t5197;
                  const _t5196 = p.annot;
                  _t5198: {
                    if (_t5196._tag === 1) {
                      const annot = _t5196._val;
                      _t5197 = Typechecker$resolve_ty_annot_shared(ctx, (level + 1), shared_tvars_5192, annot);
                      break _t5198;
                    }
                    if (_t5196._tag === 0) {
                      _t5197 = Types$new_tvar((level + 1));
                      break _t5198;
                    }
                    _match_fail("line 15950");
                  }
                  return _t5197;
                }
                const param_tys_5199 = List$map(_t5195, params);
                let _t5202;
                const _t5201 = ret_annot;
                _t5203: {
                  if (_t5201._tag === 1 && _t5201._val._tag === 11) {
                    const ty = _t5201._val._val[0];
                    const eff_annot = _t5201._val._val[1];
                    const ty$p_5204 = Typechecker$resolve_ty_annot_shared(ctx, (level + 1), shared_tvars_5192, ty);
                    let _t5207;
                    const _t5206 = eff_annot;
                    _t5208: {
                      if (_t5206._tag === 0) {
                        _t5207 = ({_tag: 1, _name: "EffEmpty"});
                        break _t5208;
                      }
                      if (_t5206._tag === 1) {
                        const items = _t5206._val;
                        _t5207 = Typechecker$resolve_eff_items(ctx, (level + 1), shared_tvars_5192, items);
                        break _t5208;
                      }
                      _match_fail("line 15950");
                    }
                    const eff_5209 = _t5207;
                    const _t5210 = [ty$p_5204, eff_5209];
                    const _t5205 = _t5210;
                    _t5202 = _t5205;
                    break _t5203;
                  }
                  if (_t5201._tag === 1) {
                    const annot = _t5201._val;
                    _t5202 = [Typechecker$resolve_ty_annot_shared(ctx, (level + 1), shared_tvars_5192, annot), Types$new_effvar((level + 1))];
                    break _t5203;
                  }
                  if (_t5201._tag === 0) {
                    _t5202 = [Types$new_tvar((level + 1)), Types$new_effvar((level + 1))];
                    break _t5203;
                  }
                  _match_fail("line 15950");
                }
                let _t5212;
                const _t5211 = _t5202;
                _t5213: {
                  if (true) {
                    const ret_ty = _t5211[0];
                    const body_eff = _t5211[1];
                    let _t5215;
                    const _t5214 = List$rev(param_tys_5199);
                    _t5216: {
                      if (_t5214 === null) {
                        _t5215 = ret_ty;
                        break _t5216;
                      }
                      if (_t5214 !== null) {
                        const last = _t5214._hd;
                        const rest = _t5214._tl;
                        const inner_5217 = ({_tag: 7, _name: "TArrow", _val: [last, body_eff, ret_ty]});
                        function _t5219(acc, pty) {
                          return ({_tag: 7, _name: "TArrow", _val: [pty, ({_tag: 1, _name: "EffEmpty"}), acc]});
                        }
                        const _t5218 = List$fold(_t5219, inner_5217, rest);
                        _t5215 = _t5218;
                        break _t5216;
                      }
                      _match_fail("line 15950");
                    }
                    const fn_ty_5220 = _t5215;
                    const _t5221 = [param_tys_5199, ret_ty, body_eff, fn_ty_5220];
                    _t5212 = _t5221;
                    break _t5213;
                  }
                  _match_fail("line 15950");
                }
                const _t5200 = _t5212;
                const _t5193 = _t5200;
                _t5190 = _t5193;
                break _t5191;
              }
              _match_fail("line 15950");
            }
            return _t5190;
          }
          const tvars_list_5222 = List$map(_t5188, infos_5186);
          function _t5224(__p98) {
            let _t5226;
            const _t5225 = __p98;
            _t5227: {
              if (true) {
                const fn_ty = _t5225[3];
                _t5226 = Types$generalize(level, fn_ty);
                break _t5227;
              }
              _match_fail("line 15950");
            }
            return _t5226;
          }
          const schemes_5228 = List$map(_t5224, tvars_list_5222);
          function _t5230(ctx, __p99, scheme) {
            let _t5232;
            const _t5231 = __p99;
            _t5233: {
              if (true) {
                const name = _t5231[0];
                _t5232 = Typechecker$extend_var(ctx, name, scheme);
                break _t5233;
              }
              _match_fail("line 15950");
            }
            return _t5232;
          }
          const ctx$p_5234 = List$fold2(_t5230, ctx, infos_5186, schemes_5228);
          function _t5236(__p100, __p101) {
            let _t5238;
            const _t5237 = __p100;
            _t5239: {
              if (true) {
                const params = _t5237[2];
                const inner_body = _t5237[4];
                let _t5241;
                const _t5240 = __p101;
                _t5242: {
                  if (true) {
                    const param_tys = _t5240[0];
                    const ret_ty = _t5240[1];
                    const body_eff = _t5240[2];
                    function _t5243(c, p, ty) {
                      return Typechecker$extend_var_mono(c, p.name, ty);
                    }
                    const __rec_upd_5244 = ctx$p_5234;
                    const _t5245 = ({constraint_tvars: __rec_upd_5244.constraint_tvars, current_eff: body_eff, current_module: __rec_upd_5244.current_module, inside_handler: __rec_upd_5244.inside_handler, loop_info: __rec_upd_5244.loop_info, mutable_vars: __rec_upd_5244.mutable_vars, return_type: __rec_upd_5244.return_type, return_used: __rec_upd_5244.return_used, type_env: __rec_upd_5244.type_env, vars: __rec_upd_5244.vars});
                    const inner_ctx_5246 = List$fold2(_t5243, _t5245, params, param_tys);
                    const body_te_5248 = Typechecker$check(inner_ctx_5246, (level + 1), inner_body, ret_ty);
                    let _t5251;
                    const _t5250 = [List$rev(params), List$rev(param_tys)];
                    _t5252: {
                      if (_t5250[0] === null && _t5250[1] === null) {
                        _t5251 = body_te_5248;
                        break _t5252;
                      }
                      if (_t5250[0] !== null && _t5250[1] !== null) {
                        const last_p = _t5250[0]._hd;
                        const rest_ps = _t5250[0]._tl;
                        const last_pty = _t5250[1]._hd;
                        const rest_ptys = _t5250[1]._tl;
                        const inner_5253 = Typechecker$mk(({_tag: 10, _name: "TEFun", _val: [last_p.name, body_te_5248, false]}), ({_tag: 7, _name: "TArrow", _val: [last_pty, body_eff, body_te_5248.ty]}));
                        function _t5255(acc, p, pty) {
                          return Typechecker$mk(({_tag: 10, _name: "TEFun", _val: [p.name, acc, false]}), ({_tag: 7, _name: "TArrow", _val: [pty, ({_tag: 1, _name: "EffEmpty"}), acc.ty]}));
                        }
                        const _t5254 = List$fold2(_t5255, inner_5253, rest_ps, rest_ptys);
                        _t5251 = _t5254;
                        break _t5252;
                      }
                      if (true) {
                        _t5251 = failwith("assert false");
                        break _t5252;
                      }
                      _match_fail("line 15950");
                    }
                    const _t5249 = _t5251;
                    const _t5247 = _t5249;
                    _t5241 = _t5247;
                    break _t5242;
                  }
                  _match_fail("line 15950");
                }
                _t5238 = _t5241;
                break _t5239;
              }
              _match_fail("line 15950");
            }
            return _t5238;
          }
          const body_tes_5256 = List$map2(_t5236, infos_5186, tvars_list_5222);
          function _t5258(ctx, __p102, scheme) {
            let _t5260;
            const _t5259 = __p102;
            _t5261: {
              if (true) {
                const name = _t5259[0];
                _t5260 = Typechecker$extend_var(ctx, name, scheme);
                break _t5261;
              }
              _match_fail("line 15950");
            }
            return _t5260;
          }
          const ctx$p$p_5262 = List$fold2(_t5258, ctx, infos_5186, schemes_5228);
          const body_te_5264 = Typechecker$synth(ctx$p$p_5262, level, body);
          function _t5266(__p103, te) {
            let _t5268;
            const _t5267 = __p103;
            _t5269: {
              if (true) {
                const name = _t5267[0];
                _t5268 = [name, te];
                break _t5269;
              }
              _match_fail("line 15950");
            }
            return _t5268;
          }
          const typed_bindings_5270 = List$map2(_t5266, infos_5186, body_tes_5256);
          const _t5271 = Typechecker$mk(({_tag: 37, _name: "TELetRecAnd", _val: [typed_bindings_5270, body_te_5264]}), body_te_5264.ty);
          const _t5265 = _t5271;
          const _t5263 = _t5265;
          const _t5257 = _t5263;
          const _t5235 = _t5257;
          const _t5229 = _t5235;
          const _t5223 = _t5229;
          const _t5187 = _t5223;
          _t5178 = _t5187;
        } else {
          function _t5272(__p104) {
            let _t5274;
            const _t5273 = __p104;
            _t5275: {
              if (true) {
                const name = _t5273[0];
                _t5274 = [name, Types$new_tvar((level + 1))];
                break _t5275;
              }
              _match_fail("line 15950");
            }
            return _t5274;
          }
          const fn_vars_5276 = List$map(_t5272, bindings);
          function _t5278(ctx, __p105) {
            let _t5280;
            const _t5279 = __p105;
            _t5281: {
              if (true) {
                const name = _t5279[0];
                const tv = _t5279[1];
                _t5280 = Typechecker$extend_var_mono(ctx, name, tv);
                break _t5281;
              }
              _match_fail("line 15950");
            }
            return _t5280;
          }
          const ctx$p_5282 = List$fold(_t5278, ctx, fn_vars_5276);
          function _t5284(__p106, __p107) {
            let _t5286;
            const _t5285 = __p106;
            _t5287: {
              if (true) {
                const fn_expr = _t5285[2];
                let _t5289;
                const _t5288 = __p107;
                _t5290: {
                  if (true) {
                    const tv = _t5288[1];
                    const te_5291 = Typechecker$synth(ctx$p_5282, (level + 1), fn_expr);
                    Typechecker$try_unify(tv, te_5291.ty);
                    const _t5292 = te_5291;
                    _t5289 = _t5292;
                    break _t5290;
                  }
                  _match_fail("line 15950");
                }
                _t5286 = _t5289;
                break _t5287;
              }
              _match_fail("line 15950");
            }
            return _t5286;
          }
          const body_tes_5293 = List$map2(_t5284, bindings, fn_vars_5276);
          function _t5295(ctx, __p108, __p109) {
            let _t5297;
            const _t5296 = __p108;
            _t5298: {
              if (true) {
                const name = _t5296[0];
                let _t5300;
                const _t5299 = __p109;
                _t5301: {
                  if (true) {
                    const tv = _t5299[1];
                    const scheme_5302 = Types$generalize(level, tv);
                    const _t5303 = Typechecker$extend_var(ctx, name, scheme_5302);
                    _t5300 = _t5303;
                    break _t5301;
                  }
                  _match_fail("line 15950");
                }
                _t5297 = _t5300;
                break _t5298;
              }
              _match_fail("line 15950");
            }
            return _t5297;
          }
          const ctx$p$p_5304 = List$fold2(_t5295, ctx, bindings, fn_vars_5276);
          const body_te_5306 = Typechecker$synth(ctx$p$p_5304, level, body);
          function _t5308(__p110, te) {
            let _t5310;
            const _t5309 = __p110;
            _t5311: {
              if (true) {
                const name = _t5309[0];
                _t5310 = [name, te];
                break _t5311;
              }
              _match_fail("line 15950");
            }
            return _t5310;
          }
          const typed_bindings_5312 = List$map2(_t5308, bindings, body_tes_5293);
          const _t5313 = Typechecker$mk(({_tag: 37, _name: "TELetRecAnd", _val: [typed_bindings_5312, body_te_5306]}), body_te_5306.ty);
          const _t5307 = _t5313;
          const _t5305 = _t5307;
          const _t5294 = _t5305;
          const _t5283 = _t5294;
          const _t5277 = _t5283;
          _t5178 = _t5277;
        }
        const _t5177 = _t5178;
        _t4710 = _t5177;
        break _t4711;
      }
      _match_fail("line 15950");
    }
    return _t4710;
  }
}
function Typechecker$synth_perform(ctx, level, op_name, arg) {
  let _t5315;
  const _t5314 = Types$find_effect_op(ctx.type_env, op_name);
  _t5316: {
    if (_t5314._tag === 0) {
      _t5315 = Typechecker$error(("unknown effect operation: " + __dict_Show_string.show(op_name)));
      break _t5316;
    }
    if (_t5314._tag === 1) {
      const effect_name = _t5314._val[0];
      const op_ty = _t5314._val[1];
      function _t5317(e) {
        return (e.effect_name === effect_name);
      }
      const edef_5318 = list_find(_t5317, ctx.type_env.effects);
      function _t5320(_) {
        return Types$new_tvar(level);
      }
      const fresh_params_5321 = List$map(_t5320, edef_5318.effect_params);
      const concrete_op_ty_5323 = Typechecker$freshen_tvars(level, op_ty);
      let _t5325;
      if (_eq(fresh_params_5321, null)) {
        _t5325 = concrete_op_ty_5323;
      } else {
        _t5325 = Typechecker$subst_tgens(fresh_params_5321, concrete_op_ty_5323);
      }
      const concrete_op_ty_5326 = _t5325;
      let _t5329;
      const _t5328 = Types$repr(concrete_op_ty_5326);
      _t5330: {
        if (_t5328._tag === 7) {
          const param_ty = _t5328._val[0];
          const ret_ty = _t5328._val[2];
          const arg_te_5331 = Typechecker$check(ctx, level, arg, param_ty);
          const fresh_tail_5333 = Types$new_effvar(level);
          Typechecker$try_unify_eff(ctx.current_eff, ({_tag: 2, _name: "EffRow", _val: [effect_name, fresh_params_5321, fresh_tail_5333]}));
          const _t5334 = Typechecker$mk(({_tag: 29, _name: "TEPerform", _val: [op_name, arg_te_5331]}), ret_ty);
          const _t5332 = _t5334;
          _t5329 = _t5332;
          break _t5330;
        }
        if (true) {
          _t5329 = Typechecker$error((("effect operation " + __dict_Show_string.show(op_name)) + " must have function type"));
          break _t5330;
        }
        _match_fail("line 15950");
      }
      const _t5327 = _t5329;
      const _t5324 = _t5327;
      const _t5322 = _t5324;
      const _t5319 = _t5322;
      _t5315 = _t5319;
      break _t5316;
    }
    _match_fail("line 15950");
  }
  return _t5315;
}
function Typechecker$synth_handle(ctx, level, body, arms) {
  const body_eff_5335 = Types$new_effvar(level);
  const __rec_upd_5337 = ctx;
  const _t5338 = ({constraint_tvars: __rec_upd_5337.constraint_tvars, current_eff: body_eff_5335, current_module: __rec_upd_5337.current_module, inside_handler: true, loop_info: __rec_upd_5337.loop_info, mutable_vars: __rec_upd_5337.mutable_vars, return_type: __rec_upd_5337.return_type, return_used: __rec_upd_5337.return_used, type_env: __rec_upd_5337.type_env, vars: __rec_upd_5337.vars});
  const body_ctx_5339 = _t5338;
  const body_te_5341 = Typechecker$synth(body_ctx_5339, level, body);
  const result_ty_5343 = Types$new_tvar(level);
  function _t5345(arm) {
    let _t5347;
    const _t5346 = arm;
    _t5348: {
      if (_t5346._tag === 1) {
        const op_name = _t5346._val[0];
        let _t5350;
        const _t5349 = Types$find_effect_op(ctx.type_env, op_name);
        _t5351: {
          if (_t5349._tag === 1) {
            const effect_name = _t5349._val[0];
            _t5350 = ({_tag: 1, _name: "Some", _val: effect_name});
            break _t5351;
          }
          if (_t5349._tag === 0) {
            _t5350 = Typechecker$error(("unknown effect operation in handler: " + __dict_Show_string.show(op_name)));
            break _t5351;
          }
          _match_fail("line 15950");
        }
        _t5347 = _t5350;
        break _t5348;
      }
      if (true) {
        _t5347 = ({_tag: 0, _name: "None"});
        break _t5348;
      }
      _match_fail("line 15950");
    }
    return _t5347;
  }
  const handled_effects_5352 = List$filter_map(_t5345, arms);
  const unique_effects_5354 = List$sort_uniq(String$compare, handled_effects_5352);
  function _t5356(effect_name) {
    function _t5357(e) {
      return (e.effect_name === effect_name);
    }
    const edef_5358 = list_find(_t5357, ctx.type_env.effects);
    function _t5360(_) {
      return Types$new_tvar(level);
    }
    const fresh_params_5361 = List$map(_t5360, edef_5358.effect_params);
    const _t5362 = [effect_name, fresh_params_5361];
    const _t5359 = _t5362;
    return _t5359;
  }
  const effect_fresh_params_5363 = List$map(_t5356, unique_effects_5354);
  function _t5365(eff, __p111) {
    let _t5367;
    const _t5366 = __p111;
    _t5368: {
      if (true) {
        const effect_name = _t5366[0];
        const fresh_params = _t5366[1];
        const _t5369 = (function() {
          const _t5370 = _h;
          _h = Object.assign({}, _t5370, {
            "unify_error": function(msg, __k) { throw {_e: "unify_error", _v: msg}; },
          });
          try {
            const __x_5371 = Types$rewrite_row(effect_name, fresh_params, eff);
            return __x_5371;
          } catch (_exc) {
            if (_exc && _exc._e === "unify_error") {
              const msg = _exc._v;
              return Typechecker$error(msg);
            } else { throw _exc; }
          } finally { _h = _t5370; }
        })();
        _t5367 = _t5369;
        break _t5368;
      }
      _match_fail("line 15950");
    }
    return _t5367;
  }
  const remaining_eff_5372 = List$fold(_t5365, Types$eff_repr(body_eff_5335), effect_fresh_params_5363);
  Typechecker$try_unify_eff(remaining_eff_5372, ctx.current_eff);
  function _t5374(arm) {
    let _t5376;
    const _t5375 = arm;
    _t5377: {
      if (_t5375._tag === 0) {
        const name = _t5375._val[0];
        const handler_body = _t5375._val[1];
        const ctx$p_5378 = Typechecker$extend_var_mono(ctx, name, body_te_5341.ty);
        const handler_te_5380 = Typechecker$check(ctx$p_5378, level, handler_body, result_ty_5343);
        const _t5381 = ({_tag: 0, _name: "THReturn", _val: [name, handler_te_5380]});
        const _t5379 = _t5381;
        _t5376 = _t5379;
        break _t5377;
      }
      if (_t5375._tag === 1) {
        const op_name = _t5375._val[0];
        const arg_name = _t5375._val[1];
        const k_name = _t5375._val[2];
        const handler_body = _t5375._val[3];
        let _t5383;
        const _t5382 = Types$find_effect_op(ctx.type_env, op_name);
        _t5384: {
          if (_t5382._tag === 0) {
            _t5383 = Typechecker$error(("unknown effect operation in handler: " + __dict_Show_string.show(op_name)));
            break _t5384;
          }
          if (_t5382._tag === 1) {
            const effect_name = _t5382._val[0];
            const op_ty = _t5382._val[1];
            let _t5386;
            const _t5385 = List$assoc_opt(effect_name, effect_fresh_params_5363);
            _t5387: {
              if (_t5385._tag === 1) {
                const p = _t5385._val;
                _t5386 = p;
                break _t5387;
              }
              if (_t5385._tag === 0) {
                _t5386 = null;
                break _t5387;
              }
              _match_fail("line 15950");
            }
            const fresh_params_5388 = _t5386;
            let _t5390;
            if (_eq(fresh_params_5388, null)) {
              _t5390 = op_ty;
            } else {
              _t5390 = Typechecker$subst_tgens(fresh_params_5388, op_ty);
            }
            const concrete_op_ty_5391 = _t5390;
            let _t5394;
            const _t5393 = Types$repr(concrete_op_ty_5391);
            _t5395: {
              if (_t5393._tag === 7) {
                const a = _t5393._val[0];
                const b = _t5393._val[2];
                _t5394 = [a, b];
                break _t5395;
              }
              if (true) {
                _t5394 = Typechecker$error((("effect operation " + __dict_Show_string.show(op_name)) + " must have function type"));
                break _t5395;
              }
              _match_fail("line 15950");
            }
            let _t5397;
            const _t5396 = _t5394;
            _t5398: {
              if (true) {
                const param_ty = _t5396[0];
                const ret_ty_op = _t5396[1];
                const k_ty_5399 = ({_tag: 8, _name: "TCont", _val: [ret_ty_op, ctx.current_eff, result_ty_5343]});
                const ctx$p_5401 = Typechecker$extend_var_mono(ctx, arg_name, param_ty);
                const ctx$p_5403 = Typechecker$extend_var_mono(ctx$p_5401, k_name, k_ty_5399);
                const handler_te_5405 = Typechecker$check(ctx$p_5403, level, handler_body, result_ty_5343);
                const _t5406 = ({_tag: 1, _name: "THOp", _val: [op_name, arg_name, k_name, handler_te_5405]});
                const _t5404 = _t5406;
                const _t5402 = _t5404;
                const _t5400 = _t5402;
                _t5397 = _t5400;
                break _t5398;
              }
              _match_fail("line 15950");
            }
            const _t5392 = _t5397;
            const _t5389 = _t5392;
            _t5383 = _t5389;
            break _t5384;
          }
          _match_fail("line 15950");
        }
        _t5376 = _t5383;
        break _t5377;
      }
      _match_fail("line 15950");
    }
    return _t5376;
  }
  const typed_arms_5407 = List$map(_t5374, arms);
  const _t5408 = Typechecker$mk(({_tag: 30, _name: "TEHandle", _val: [body_te_5341, typed_arms_5407]}), result_ty_5343);
  const _t5373 = _t5408;
  const _t5364 = _t5373;
  const _t5355 = _t5364;
  const _t5353 = _t5355;
  const _t5344 = _t5353;
  const _t5342 = _t5344;
  const _t5340 = _t5342;
  const _t5336 = _t5340;
  return _t5336;
}
function Typechecker$synth_binop(ctx, level, op, e1, e2) {
  let _t5410;
  const _t5409 = op;
  _t5411: {
    if ((((_t5409._tag === 0 || _t5409._tag === 1) || _t5409._tag === 2) || _t5409._tag === 3)) {
      const te1_5412 = Typechecker$synth(ctx, level, e1);
      const te2_5414 = Typechecker$synth(ctx, level, e2);
      Typechecker$try_unify(te1_5412.ty, te2_5414.ty);
      const resolved_5416 = Types$repr(te1_5412.ty);
      let _t5419;
      const _t5418 = resolved_5416;
      _t5420: {
        if (_t5418._tag === 1) {
          _t5419 = Typechecker$mk(({_tag: 13, _name: "TEBinop", _val: [op, te1_5412, te2_5414]}), ({_tag: 1, _name: "TFloat"}));
          break _t5420;
        }
        if (_t5418._tag === 16 && _t5418._val.contents._tag === 0) {
          const id = _t5418._val.contents._val[0];
          let _t5421;
          if (List$mem(id, ctx.constraint_tvars)) {
            _t5421 = Typechecker$mk(({_tag: 13, _name: "TEBinop", _val: [op, te1_5412, te2_5414]}), Types$repr(te1_5412.ty));
          } else {
            Typechecker$try_unify(te1_5412.ty, ({_tag: 0, _name: "TInt"}));
            _t5421 = Typechecker$mk(({_tag: 13, _name: "TEBinop", _val: [op, te1_5412, te2_5414]}), ({_tag: 0, _name: "TInt"}));
          }
          _t5419 = _t5421;
          break _t5420;
        }
        if (_t5418._tag === 0) {
          _t5419 = Typechecker$mk(({_tag: 13, _name: "TEBinop", _val: [op, te1_5412, te2_5414]}), ({_tag: 0, _name: "TInt"}));
          break _t5420;
        }
        if (true) {
          _t5419 = Typechecker$mk(({_tag: 13, _name: "TEBinop", _val: [op, te1_5412, te2_5414]}), Types$repr(te1_5412.ty));
          break _t5420;
        }
        _match_fail("line 15950");
      }
      const _t5417 = _t5419;
      const _t5415 = _t5417;
      const _t5413 = _t5415;
      _t5410 = _t5413;
      break _t5411;
    }
    if (_t5409._tag === 4) {
      const te1_5422 = Typechecker$check(ctx, level, e1, ({_tag: 0, _name: "TInt"}));
      const te2_5424 = Typechecker$check(ctx, level, e2, ({_tag: 0, _name: "TInt"}));
      const _t5425 = Typechecker$mk(({_tag: 13, _name: "TEBinop", _val: [op, te1_5422, te2_5424]}), ({_tag: 0, _name: "TInt"}));
      const _t5423 = _t5425;
      _t5410 = _t5423;
      break _t5411;
    }
    if ((((_t5409._tag === 7 || _t5409._tag === 8) || _t5409._tag === 9) || _t5409._tag === 10)) {
      const te1_5426 = Typechecker$synth(ctx, level, e1);
      const te2_5428 = Typechecker$synth(ctx, level, e2);
      Typechecker$try_unify(te1_5426.ty, te2_5428.ty);
      const _t5429 = Typechecker$mk(({_tag: 13, _name: "TEBinop", _val: [op, te1_5426, te2_5428]}), ({_tag: 2, _name: "TBool"}));
      const _t5427 = _t5429;
      _t5410 = _t5427;
      break _t5411;
    }
    if ((_t5409._tag === 5 || _t5409._tag === 6)) {
      const te1_5430 = Typechecker$synth(ctx, level, e1);
      const te2_5432 = Typechecker$synth(ctx, level, e2);
      Typechecker$try_unify(te1_5430.ty, te2_5432.ty);
      const _t5433 = Typechecker$mk(({_tag: 13, _name: "TEBinop", _val: [op, te1_5430, te2_5432]}), ({_tag: 2, _name: "TBool"}));
      const _t5431 = _t5433;
      _t5410 = _t5431;
      break _t5411;
    }
    if ((_t5409._tag === 11 || _t5409._tag === 12)) {
      const te1_5434 = Typechecker$check(ctx, level, e1, ({_tag: 2, _name: "TBool"}));
      const te2_5436 = Typechecker$check(ctx, level, e2, ({_tag: 2, _name: "TBool"}));
      const _t5437 = Typechecker$mk(({_tag: 13, _name: "TEBinop", _val: [op, te1_5434, te2_5436]}), ({_tag: 2, _name: "TBool"}));
      const _t5435 = _t5437;
      _t5410 = _t5435;
      break _t5411;
    }
    if (_t5409._tag === 13) {
      const te1_5438 = Typechecker$check(ctx, level, e1, ({_tag: 3, _name: "TString"}));
      const te2_5440 = Typechecker$check(ctx, level, e2, ({_tag: 3, _name: "TString"}));
      const _t5441 = Typechecker$mk(({_tag: 13, _name: "TEBinop", _val: [op, te1_5438, te2_5440]}), ({_tag: 3, _name: "TString"}));
      const _t5439 = _t5441;
      _t5410 = _t5439;
      break _t5411;
    }
    if (((((_t5409._tag === 14 || _t5409._tag === 15) || _t5409._tag === 16) || _t5409._tag === 17) || _t5409._tag === 18)) {
      const te1_5442 = Typechecker$synth(ctx, level, e1);
      const te2_5444 = Typechecker$synth(ctx, level, e2);
      Typechecker$try_unify(te1_5442.ty, te2_5444.ty);
      const resolved_5446 = Types$repr(te1_5442.ty);
      let _t5449;
      const _t5448 = resolved_5446;
      _t5450: {
        if (_t5448._tag === 0) {
          _t5449 = Typechecker$mk(({_tag: 13, _name: "TEBinop", _val: [op, te1_5442, te2_5444]}), ({_tag: 0, _name: "TInt"}));
          break _t5450;
        }
        if (_t5448._tag === 16 && _t5448._val.contents._tag === 0) {
          const id = _t5448._val.contents._val[0];
          let _t5451;
          if (List$mem(id, ctx.constraint_tvars)) {
            _t5451 = Typechecker$mk(({_tag: 13, _name: "TEBinop", _val: [op, te1_5442, te2_5444]}), Types$repr(te1_5442.ty));
          } else {
            Typechecker$try_unify(te1_5442.ty, ({_tag: 0, _name: "TInt"}));
            _t5451 = Typechecker$mk(({_tag: 13, _name: "TEBinop", _val: [op, te1_5442, te2_5444]}), ({_tag: 0, _name: "TInt"}));
          }
          _t5449 = _t5451;
          break _t5450;
        }
        if (true) {
          _t5449 = Typechecker$mk(({_tag: 13, _name: "TEBinop", _val: [op, te1_5442, te2_5444]}), Types$repr(te1_5442.ty));
          break _t5450;
        }
        _match_fail("line 15950");
      }
      const _t5447 = _t5449;
      const _t5445 = _t5447;
      const _t5443 = _t5445;
      _t5410 = _t5443;
      break _t5411;
    }
    if (_t5409._tag === 19) {
      const te1_5452 = Typechecker$synth(ctx, level, e1);
      const te2_5454 = Typechecker$synth(ctx, level, e2);
      const ret_ty_5456 = Types$new_tvar(level);
      const call_eff_5458 = Types$new_effvar(level);
      Typechecker$try_unify(te2_5454.ty, ({_tag: 7, _name: "TArrow", _val: [te1_5452.ty, call_eff_5458, ret_ty_5456]}));
      Typechecker$try_subeffect(call_eff_5458, ctx.current_eff);
      const _t5459 = Typechecker$mk(({_tag: 13, _name: "TEBinop", _val: [op, te1_5452, te2_5454]}), ret_ty_5456);
      const _t5457 = _t5459;
      const _t5455 = _t5457;
      const _t5453 = _t5455;
      _t5410 = _t5453;
      break _t5411;
    }
    _match_fail("line 15950");
  }
  return _t5410;
}
function Typechecker$synth_unop(ctx, level, op, e) {
  let _t5461;
  const _t5460 = op;
  _t5462: {
    if (_t5460._tag === 0) {
      const te_5463 = Typechecker$synth(ctx, level, e);
      const resolved_5465 = Types$repr(te_5463.ty);
      let _t5468;
      const _t5467 = resolved_5465;
      _t5469: {
        if (_t5467._tag === 1) {
          _t5468 = Typechecker$mk(({_tag: 14, _name: "TEUnop", _val: [op, te_5463]}), ({_tag: 1, _name: "TFloat"}));
          break _t5469;
        }
        if (_t5467._tag === 16 && _t5467._val.contents._tag === 0) {
          const id = _t5467._val.contents._val[0];
          let _t5470;
          if (List$mem(id, ctx.constraint_tvars)) {
            _t5470 = Typechecker$mk(({_tag: 14, _name: "TEUnop", _val: [op, te_5463]}), Types$repr(te_5463.ty));
          } else {
            Typechecker$try_unify(te_5463.ty, ({_tag: 0, _name: "TInt"}));
            _t5470 = Typechecker$mk(({_tag: 14, _name: "TEUnop", _val: [op, te_5463]}), ({_tag: 0, _name: "TInt"}));
          }
          _t5468 = _t5470;
          break _t5469;
        }
        if (_t5467._tag === 0) {
          _t5468 = Typechecker$mk(({_tag: 14, _name: "TEUnop", _val: [op, te_5463]}), ({_tag: 0, _name: "TInt"}));
          break _t5469;
        }
        if (true) {
          _t5468 = Typechecker$mk(({_tag: 14, _name: "TEUnop", _val: [op, te_5463]}), te_5463.ty);
          break _t5469;
        }
        _match_fail("line 15950");
      }
      const _t5466 = _t5468;
      const _t5464 = _t5466;
      _t5461 = _t5464;
      break _t5462;
    }
    if (_t5460._tag === 1) {
      const te_5471 = Typechecker$check(ctx, level, e, ({_tag: 2, _name: "TBool"}));
      const _t5472 = Typechecker$mk(({_tag: 14, _name: "TEUnop", _val: [op, te_5471]}), ({_tag: 2, _name: "TBool"}));
      _t5461 = _t5472;
      break _t5462;
    }
    if (_t5460._tag === 2) {
      const te_5473 = Typechecker$synth(ctx, level, e);
      const resolved_5475 = Types$repr(te_5473.ty);
      let _t5478;
      const _t5477 = resolved_5475;
      _t5479: {
        if (_t5477._tag === 0) {
          _t5478 = Typechecker$mk(({_tag: 14, _name: "TEUnop", _val: [op, te_5473]}), ({_tag: 0, _name: "TInt"}));
          break _t5479;
        }
        if (_t5477._tag === 16 && _t5477._val.contents._tag === 0) {
          Typechecker$try_unify(te_5473.ty, ({_tag: 0, _name: "TInt"}));
          _t5478 = Typechecker$mk(({_tag: 14, _name: "TEUnop", _val: [op, te_5473]}), ({_tag: 0, _name: "TInt"}));
          break _t5479;
        }
        if (true) {
          _t5478 = Typechecker$mk(({_tag: 14, _name: "TEUnop", _val: [op, te_5473]}), te_5473.ty);
          break _t5479;
        }
        _match_fail("line 15950");
      }
      const _t5476 = _t5478;
      const _t5474 = _t5476;
      _t5461 = _t5474;
      break _t5462;
    }
    _match_fail("line 15950");
  }
  return _t5461;
}
function Typechecker$qualify_ctor_name(type_env, name, info) {
  let _t5480;
  if (String$contains(".", name)) {
    _t5480 = name;
  } else {
    let _t5482;
    const _t5481 = String$rindex_opt(info.ctor_type_name, 46);
    _t5483: {
      if (_t5481._tag === 1) {
        const i = _t5481._val;
        const qualified_5484 = (String$sub(info.ctor_type_name, 0, (i + 1)) + name);
        let _t5486;
        if (!_eq(List$assoc_opt(qualified_5484, type_env.constructors), ({_tag: 0, _name: "None"}))) {
          _t5486 = qualified_5484;
        } else {
          _t5486 = name;
        }
        const _t5485 = _t5486;
        _t5482 = _t5485;
        break _t5483;
      }
      if (_t5481._tag === 0) {
        _t5482 = name;
        break _t5483;
      }
      _match_fail("line 15950");
    }
    _t5480 = _t5482;
  }
  return _t5480;
}
function Typechecker$qualify_pattern(type_env, pat) {
  function go(pat) {
    let _t5488;
    const _t5487 = pat;
    _t5489: {
      if (_t5487._tag === 10) {
        const name = _t5487._val[0];
        const arg = _t5487._val[1];
        let _t5491;
        const _t5490 = List$assoc_opt(name, type_env.constructors);
        _t5492: {
          if (_t5490._tag === 1) {
            const info = _t5490._val;
            _t5491 = Typechecker$qualify_ctor_name(type_env, name, info);
            break _t5492;
          }
          if (_t5490._tag === 0) {
            _t5491 = name;
            break _t5492;
          }
          _match_fail("line 15950");
        }
        const qname_5493 = _t5491;
        const _t5494 = ({_tag: 10, _name: "PatConstruct", _val: [qname_5493, Option$map(go, arg)]});
        _t5488 = _t5494;
        break _t5489;
      }
      if (_t5487._tag === 7) {
        const ps = _t5487._val;
        _t5488 = ({_tag: 7, _name: "PatTuple", _val: List$map(go, ps)});
        break _t5489;
      }
      if (_t5487._tag === 8) {
        const hd = _t5487._val[0];
        const tl = _t5487._val[1];
        _t5488 = ({_tag: 8, _name: "PatCons", _val: [go(hd), go(tl)]});
        break _t5489;
      }
      if (_t5487._tag === 13) {
        const p1 = _t5487._val[0];
        const p2 = _t5487._val[1];
        _t5488 = ({_tag: 13, _name: "PatOr", _val: [go(p1), go(p2)]});
        break _t5489;
      }
      if (_t5487._tag === 12) {
        const p = _t5487._val[0];
        const n = _t5487._val[1];
        _t5488 = ({_tag: 12, _name: "PatAs", _val: [go(p), n]});
        break _t5489;
      }
      if (_t5487._tag === 11) {
        const fields = _t5487._val;
        function _t5495(__p112) {
          let _t5497;
          const _t5496 = __p112;
          _t5498: {
            if (true) {
              const f = _t5496[0];
              const p = _t5496[1];
              _t5497 = [f, go(p)];
              break _t5498;
            }
            _match_fail("line 15950");
          }
          return _t5497;
        }
        _t5488 = ({_tag: 11, _name: "PatRecord", _val: List$map(_t5495, fields)});
        break _t5489;
      }
      if (_t5487._tag === 14) {
        const ps = _t5487._val;
        _t5488 = ({_tag: 14, _name: "PatArray", _val: List$map(go, ps)});
        break _t5489;
      }
      if (_t5487._tag === 15) {
        const kvs = _t5487._val;
        function _t5499(__p113) {
          let _t5501;
          const _t5500 = __p113;
          _t5502: {
            if (true) {
              const k = _t5500[0];
              const v = _t5500[1];
              _t5501 = [go(k), go(v)];
              break _t5502;
            }
            _match_fail("line 15950");
          }
          return _t5501;
        }
        _t5488 = ({_tag: 15, _name: "PatMap", _val: List$map(_t5499, kvs)});
        break _t5489;
      }
      if (_t5487._tag === 18) {
        const p = _t5487._val[0];
        const a = _t5487._val[1];
        _t5488 = ({_tag: 18, _name: "PatAnnot", _val: [go(p), a]});
        break _t5489;
      }
      if (true) {
        _t5488 = pat;
        break _t5489;
      }
      _match_fail("line 15950");
    }
    return _t5488;
  }
  const _t5503 = go(pat);
  return _t5503;
}
function Typechecker$synth_construct(ctx, level, name, arg) {
  let _t5505;
  const _t5504 = List$assoc_opt(name, ctx.type_env.constructors);
  _t5506: {
    if (_t5504._tag === 0) {
      _t5505 = Typechecker$error(("unknown constructor: " + __dict_Show_string.show(name)));
      break _t5506;
    }
    if (_t5504._tag === 1) {
      const info = _t5504._val;
      const qname_5507 = Typechecker$qualify_ctor_name(ctx.type_env, name, info);
      const num_fresh_5509 = (info.ctor_num_params + info.ctor_existentials);
      function _t5511(_) {
        return Types$new_tvar(level);
      }
      const all_fresh_5512 = List$init(num_fresh_5509, _t5511);
      function _t5514(i, _) {
        return (i < info.ctor_num_params);
      }
      const fresh_universals_5515 = List$filteri(_t5514, all_fresh_5512);
      let _t5518;
      const _t5517 = info.ctor_return_ty_params;
      _t5519: {
        if (_t5517._tag === 0) {
          _t5518 = ({_tag: 12, _name: "TVariant", _val: [info.ctor_type_name, fresh_universals_5515]});
          break _t5519;
        }
        if (_t5517._tag === 1) {
          const params = _t5517._val;
          _t5518 = ({_tag: 12, _name: "TVariant", _val: [info.ctor_type_name, List$map(_call(Typechecker$subst_tgens, [all_fresh_5512]), params)]});
          break _t5519;
        }
        _match_fail("line 15950");
      }
      const result_ty_5520 = _t5518;
      let _t5523;
      const _t5522 = [info.ctor_arg_ty, arg];
      _t5524: {
        if (_t5522[0]._tag === 0 && _t5522[1]._tag === 0) {
          _t5523 = Typechecker$mk(({_tag: 23, _name: "TEConstruct", _val: [qname_5507, ({_tag: 0, _name: "None"})]}), result_ty_5520);
          break _t5524;
        }
        if (_t5522[0]._tag === 1 && _t5522[1]._tag === 1) {
          const expected_ty = _t5522[0]._val;
          const arg_expr = _t5522[1]._val;
          const concrete_ty_5525 = Typechecker$freshen_arrow_effects(level, Typechecker$subst_tgens(all_fresh_5512, expected_ty));
          const arg_te_5527 = Typechecker$check(ctx, level, arg_expr, concrete_ty_5525);
          const _t5528 = Typechecker$mk(({_tag: 23, _name: "TEConstruct", _val: [qname_5507, ({_tag: 1, _name: "Some", _val: arg_te_5527})]}), result_ty_5520);
          const _t5526 = _t5528;
          _t5523 = _t5526;
          break _t5524;
        }
        if (_t5522[0]._tag === 0 && _t5522[1]._tag === 1) {
          _t5523 = Typechecker$error((("constructor " + __dict_Show_string.show(name)) + " takes no arguments"));
          break _t5524;
        }
        if (_t5522[0]._tag === 1 && _t5522[1]._tag === 0) {
          const expected_ty = _t5522[0]._val;
          const concrete_ty_5529 = Typechecker$freshen_arrow_effects(level, Typechecker$subst_tgens(all_fresh_5512, expected_ty));
          const param_5531 = "__x";
          const param_var_5533 = Typechecker$mk(({_tag: 7, _name: "TEVar", _val: param_5531}), concrete_ty_5529);
          const body_5535 = Typechecker$mk(({_tag: 23, _name: "TEConstruct", _val: [qname_5507, ({_tag: 1, _name: "Some", _val: param_var_5533})]}), result_ty_5520);
          const _t5536 = Typechecker$mk(({_tag: 10, _name: "TEFun", _val: [param_5531, body_5535, false]}), ({_tag: 7, _name: "TArrow", _val: [concrete_ty_5529, ({_tag: 1, _name: "EffEmpty"}), result_ty_5520]}));
          const _t5534 = _t5536;
          const _t5532 = _t5534;
          const _t5530 = _t5532;
          _t5523 = _t5530;
          break _t5524;
        }
        _match_fail("line 15950");
      }
      const _t5521 = _t5523;
      const _t5516 = _t5521;
      const _t5513 = _t5516;
      const _t5510 = _t5513;
      const _t5508 = _t5510;
      _t5505 = _t5508;
      break _t5506;
    }
    _match_fail("line 15950");
  }
  return _t5505;
}
function Typechecker$freeze_texpr(te) {
  const ft_5537 = Types$deep_repr(te.ty);
  let _t5540;
  const _t5539 = te.expr;
  _t5541: {
    if (((((((((_t5539._tag === 0 || _t5539._tag === 1) || _t5539._tag === 2) || _t5539._tag === 3) || _t5539._tag === 4) || _t5539._tag === 5) || _t5539._tag === 6) || _t5539._tag === 7) || _t5539._tag === 22)) {
      _t5540 = te.expr;
      break _t5541;
    }
    if (_t5539._tag === 8) {
      const n = _t5539._val[0];
      const s = _t5539._val[1];
      const e1 = _t5539._val[2];
      const e2 = _t5539._val[3];
      _t5540 = ({_tag: 8, _name: "TELet", _val: [n, s, Typechecker$freeze_texpr(e1), Typechecker$freeze_texpr(e2)]});
      break _t5541;
    }
    if (_t5539._tag === 9) {
      const n = _t5539._val[0];
      const s = _t5539._val[1];
      const e1 = _t5539._val[2];
      const e2 = _t5539._val[3];
      _t5540 = ({_tag: 9, _name: "TELetRec", _val: [n, s, Typechecker$freeze_texpr(e1), Typechecker$freeze_texpr(e2)]});
      break _t5541;
    }
    if (_t5539._tag === 10) {
      const p = _t5539._val[0];
      const body = _t5539._val[1];
      const hr = _t5539._val[2];
      _t5540 = ({_tag: 10, _name: "TEFun", _val: [p, Typechecker$freeze_texpr(body), hr]});
      break _t5541;
    }
    if (_t5539._tag === 11) {
      const f = _t5539._val[0];
      const a = _t5539._val[1];
      _t5540 = ({_tag: 11, _name: "TEApp", _val: [Typechecker$freeze_texpr(f), Typechecker$freeze_texpr(a)]});
      break _t5541;
    }
    if (_t5539._tag === 12) {
      const c = _t5539._val[0];
      const t = _t5539._val[1];
      const e = _t5539._val[2];
      _t5540 = ({_tag: 12, _name: "TEIf", _val: [Typechecker$freeze_texpr(c), Typechecker$freeze_texpr(t), Typechecker$freeze_texpr(e)]});
      break _t5541;
    }
    if (_t5539._tag === 13) {
      const op = _t5539._val[0];
      const l = _t5539._val[1];
      const r = _t5539._val[2];
      _t5540 = ({_tag: 13, _name: "TEBinop", _val: [op, Typechecker$freeze_texpr(l), Typechecker$freeze_texpr(r)]});
      break _t5541;
    }
    if (_t5539._tag === 14) {
      const op = _t5539._val[0];
      const e = _t5539._val[1];
      _t5540 = ({_tag: 14, _name: "TEUnop", _val: [op, Typechecker$freeze_texpr(e)]});
      break _t5541;
    }
    if (_t5539._tag === 15) {
      const es = _t5539._val;
      _t5540 = ({_tag: 15, _name: "TETuple", _val: List$map(Typechecker$freeze_texpr, es)});
      break _t5541;
    }
    if (_t5539._tag === 16) {
      const fs = _t5539._val;
      function _t5542(__p114) {
        let _t5544;
        const _t5543 = __p114;
        _t5545: {
          if (true) {
            const n = _t5543[0];
            const e = _t5543[1];
            _t5544 = [n, Typechecker$freeze_texpr(e)];
            break _t5545;
          }
          _match_fail("line 15950");
        }
        return _t5544;
      }
      _t5540 = ({_tag: 16, _name: "TERecord", _val: List$map(_t5542, fs)});
      break _t5541;
    }
    if (_t5539._tag === 17) {
      const base = _t5539._val[0];
      const overrides = _t5539._val[1];
      function _t5546(__p115) {
        let _t5548;
        const _t5547 = __p115;
        _t5549: {
          if (true) {
            const n = _t5547[0];
            const e = _t5547[1];
            _t5548 = [n, Typechecker$freeze_texpr(e)];
            break _t5549;
          }
          _match_fail("line 15950");
        }
        return _t5548;
      }
      _t5540 = ({_tag: 17, _name: "TERecordUpdate", _val: [Typechecker$freeze_texpr(base), List$map(_t5546, overrides)]});
      break _t5541;
    }
    if (_t5539._tag === 18) {
      const base = _t5539._val[0];
      const pairs = _t5539._val[1];
      function _t5550(__p116) {
        let _t5552;
        const _t5551 = __p116;
        _t5553: {
          if (true) {
            const i = _t5551[0];
            const v = _t5551[1];
            _t5552 = [Typechecker$freeze_texpr(i), Typechecker$freeze_texpr(v)];
            break _t5553;
          }
          _match_fail("line 15950");
        }
        return _t5552;
      }
      _t5540 = ({_tag: 18, _name: "TERecordUpdateIdx", _val: [Typechecker$freeze_texpr(base), List$map(_t5550, pairs)]});
      break _t5541;
    }
    if (_t5539._tag === 19) {
      const e = _t5539._val[0];
      const f = _t5539._val[1];
      _t5540 = ({_tag: 19, _name: "TEField", _val: [Typechecker$freeze_texpr(e), f]});
      break _t5541;
    }
    if (_t5539._tag === 20) {
      const e = _t5539._val[0];
      const i = _t5539._val[1];
      _t5540 = ({_tag: 20, _name: "TEIndex", _val: [Typechecker$freeze_texpr(e), Typechecker$freeze_texpr(i)]});
      break _t5541;
    }
    if (_t5539._tag === 21) {
      const h = _t5539._val[0];
      const t = _t5539._val[1];
      _t5540 = ({_tag: 21, _name: "TECons", _val: [Typechecker$freeze_texpr(h), Typechecker$freeze_texpr(t)]});
      break _t5541;
    }
    if (_t5539._tag === 23) {
      const n = _t5539._val[0];
      const arg = _t5539._val[1];
      _t5540 = ({_tag: 23, _name: "TEConstruct", _val: [n, Option$map(Typechecker$freeze_texpr, arg)]});
      break _t5541;
    }
    if (_t5539._tag === 24) {
      const s = _t5539._val[0];
      const arms = _t5539._val[1];
      const p = _t5539._val[2];
      function _t5554(__p117) {
        let _t5556;
        const _t5555 = __p117;
        _t5557: {
          if (true) {
            const pat = _t5555[0];
            const g = _t5555[1];
            const b = _t5555[2];
            _t5556 = [pat, Option$map(Typechecker$freeze_texpr, g), Typechecker$freeze_texpr(b)];
            break _t5557;
          }
          _match_fail("line 15950");
        }
        return _t5556;
      }
      _t5540 = ({_tag: 24, _name: "TEMatch", _val: [Typechecker$freeze_texpr(s), List$map(_t5554, arms), p]});
      break _t5541;
    }
    if (_t5539._tag === 25) {
      const n = _t5539._val[0];
      const e1 = _t5539._val[1];
      const e2 = _t5539._val[2];
      _t5540 = ({_tag: 25, _name: "TELetMut", _val: [n, Typechecker$freeze_texpr(e1), Typechecker$freeze_texpr(e2)]});
      break _t5541;
    }
    if (_t5539._tag === 26) {
      const n = _t5539._val[0];
      const e = _t5539._val[1];
      _t5540 = ({_tag: 26, _name: "TEAssign", _val: [n, Typechecker$freeze_texpr(e)]});
      break _t5541;
    }
    if (_t5539._tag === 27) {
      const e = _t5539._val[0];
      const f = _t5539._val[1];
      const v = _t5539._val[2];
      _t5540 = ({_tag: 27, _name: "TEFieldAssign", _val: [Typechecker$freeze_texpr(e), f, Typechecker$freeze_texpr(v)]});
      break _t5541;
    }
    if (_t5539._tag === 28) {
      const e1 = _t5539._val[0];
      const e2 = _t5539._val[1];
      _t5540 = ({_tag: 28, _name: "TESeq", _val: [Typechecker$freeze_texpr(e1), Typechecker$freeze_texpr(e2)]});
      break _t5541;
    }
    if (_t5539._tag === 29) {
      const name = _t5539._val[0];
      const e = _t5539._val[1];
      _t5540 = ({_tag: 29, _name: "TEPerform", _val: [name, Typechecker$freeze_texpr(e)]});
      break _t5541;
    }
    if (_t5539._tag === 30) {
      const e = _t5539._val[0];
      const arms = _t5539._val[1];
      function _t5558(arm) {
        let _t5560;
        const _t5559 = arm;
        _t5561: {
          if (_t5559._tag === 0) {
            const n = _t5559._val[0];
            const b = _t5559._val[1];
            _t5560 = ({_tag: 0, _name: "THReturn", _val: [n, Typechecker$freeze_texpr(b)]});
            break _t5561;
          }
          if (_t5559._tag === 1) {
            const eff = _t5559._val[0];
            const x = _t5559._val[1];
            const k = _t5559._val[2];
            const b = _t5559._val[3];
            _t5560 = ({_tag: 1, _name: "THOp", _val: [eff, x, k, Typechecker$freeze_texpr(b)]});
            break _t5561;
          }
          _match_fail("line 15950");
        }
        return _t5560;
      }
      _t5540 = ({_tag: 30, _name: "TEHandle", _val: [Typechecker$freeze_texpr(e), List$map(_t5558, arms)]});
      break _t5541;
    }
    if (_t5539._tag === 31) {
      const k = _t5539._val[0];
      const v = _t5539._val[1];
      _t5540 = ({_tag: 31, _name: "TEResume", _val: [Typechecker$freeze_texpr(k), Typechecker$freeze_texpr(v)]});
      break _t5541;
    }
    if (_t5539._tag === 32) {
      const c = _t5539._val[0];
      const b = _t5539._val[1];
      _t5540 = ({_tag: 32, _name: "TEWhile", _val: [Typechecker$freeze_texpr(c), Typechecker$freeze_texpr(b)]});
      break _t5541;
    }
    if (_t5539._tag === 33) {
      const e = _t5539._val;
      _t5540 = ({_tag: 33, _name: "TEBreak", _val: Typechecker$freeze_texpr(e)});
      break _t5541;
    }
    if (_t5539._tag === 34) {
      _t5540 = ({_tag: 34, _name: "TEContinueLoop"});
      break _t5541;
    }
    if (_t5539._tag === 35) {
      const e = _t5539._val;
      _t5540 = ({_tag: 35, _name: "TEFoldContinue", _val: Typechecker$freeze_texpr(e)});
      break _t5541;
    }
    if (_t5539._tag === 36) {
      const e = _t5539._val;
      _t5540 = ({_tag: 36, _name: "TEForLoop", _val: Typechecker$freeze_texpr(e)});
      break _t5541;
    }
    if (_t5539._tag === 37) {
      const binds = _t5539._val[0];
      const body = _t5539._val[1];
      function _t5562(__p118) {
        let _t5564;
        const _t5563 = __p118;
        _t5565: {
          if (true) {
            const n = _t5563[0];
            const e = _t5563[1];
            _t5564 = [n, Typechecker$freeze_texpr(e)];
            break _t5565;
          }
          _match_fail("line 15950");
        }
        return _t5564;
      }
      _t5540 = ({_tag: 37, _name: "TELetRecAnd", _val: [List$map(_t5562, binds), Typechecker$freeze_texpr(body)]});
      break _t5541;
    }
    if (_t5539._tag === 38) {
      const pairs = _t5539._val;
      function _t5566(__p119) {
        let _t5568;
        const _t5567 = __p119;
        _t5569: {
          if (true) {
            const k = _t5567[0];
            const v = _t5567[1];
            _t5568 = [Typechecker$freeze_texpr(k), Typechecker$freeze_texpr(v)];
            break _t5569;
          }
          _match_fail("line 15950");
        }
        return _t5568;
      }
      _t5540 = ({_tag: 38, _name: "TEMap", _val: List$map(_t5566, pairs)});
      break _t5541;
    }
    if (_t5539._tag === 39) {
      const es = _t5539._val;
      _t5540 = ({_tag: 39, _name: "TEArray", _val: List$map(Typechecker$freeze_texpr, es)});
      break _t5541;
    }
    if (_t5539._tag === 40) {
      const e = _t5539._val;
      _t5540 = ({_tag: 40, _name: "TEReturn", _val: Typechecker$freeze_texpr(e)});
      break _t5541;
    }
    _match_fail("line 15950");
  }
  const fe_5570 = _t5540;
  const _t5571 = ({expr: fe_5570, loc: te.loc, ty: ft_5537});
  const _t5538 = _t5571;
  return _t5538;
}
function Typechecker$check_pattern_gadt(ctx, level, pat, scrut_ty) {
  let _t5573;
  const _t5572 = pat;
  _t5574: {
    if (_t5572._tag === 10) {
      const name = _t5572._val[0];
      const arg_pat = _t5572._val[1];
      let _t5576;
      const _t5575 = List$assoc_opt(name, ctx.type_env.constructors);
      _t5577: {
        if (_t5575._tag === 0) {
          _t5576 = Typechecker$error(("unknown constructor in pattern: " + __dict_Show_string.show(name)));
          break _t5577;
        }
        if (_t5575._tag === 1) {
          const info = _t5575._val;
          const num_fresh_5578 = (info.ctor_num_params + info.ctor_existentials);
          function _t5580(_) {
            return Types$new_tvar(level);
          }
          const all_fresh_5581 = List$init(num_fresh_5578, _t5580);
          function _t5583(i) {
            let _t5584;
            if ((i >= info.ctor_num_params)) {
              let _t5586;
              const _t5585 = List$nth(all_fresh_5581, i);
              _t5587: {
                if (_t5585._tag === 16) {
                  const r = _t5585._val;
                  _t5586 = ({_tag: 1, _name: "Some", _val: r});
                  break _t5587;
                }
                if (true) {
                  _t5586 = ({_tag: 0, _name: "None"});
                  break _t5587;
                }
                _match_fail("line 15950");
              }
              _t5584 = _t5586;
            } else {
              _t5584 = ({_tag: 0, _name: "None"});
            }
            return _t5584;
          }
          function _t5588(x) {
            return x;
          }
          const existential_refs_5589 = List$filter_map(_t5583, List$init(num_fresh_5578, _t5588));
          let _t5592;
          const _t5591 = info.ctor_return_ty_params;
          _t5593: {
            if (_t5591._tag === 1) {
              const params = _t5591._val;
              _t5592 = ({_tag: 12, _name: "TVariant", _val: [info.ctor_type_name, List$map(_call(Typechecker$subst_tgens, [all_fresh_5581]), params)]});
              break _t5593;
            }
            if (_t5591._tag === 0) {
              function _t5594(i, _) {
                return (i < info.ctor_num_params);
              }
              const fresh_universals_5595 = List$filteri(_t5594, all_fresh_5581);
              const _t5596 = ({_tag: 12, _name: "TVariant", _val: [info.ctor_type_name, fresh_universals_5595]});
              _t5592 = _t5596;
              break _t5593;
            }
            _match_fail("line 15950");
          }
          const return_ty_5597 = _t5592;
          Typechecker$try_unify(scrut_ty, return_ty_5597);
          let _t5600;
          const _t5599 = [info.ctor_arg_ty, arg_pat];
          _t5601: {
            if (_t5599[0]._tag === 0 && _t5599[1]._tag === 0) {
              _t5600 = null;
              break _t5601;
            }
            if (_t5599[0]._tag === 1 && _t5599[1]._tag === 1) {
              const arg_ty = _t5599[0]._val;
              const p = _t5599[1]._val;
              const concrete_ty_5602 = Typechecker$freshen_arrow_effects(level, Typechecker$subst_tgens(all_fresh_5581, arg_ty));
              const _t5603 = Typechecker$check_pattern(ctx, level, p, concrete_ty_5602);
              _t5600 = _t5603;
              break _t5601;
            }
            if (_t5599[0]._tag === 0 && _t5599[1]._tag === 1) {
              _t5600 = Typechecker$error((("constructor " + __dict_Show_string.show(name)) + " takes no arguments"));
              break _t5601;
            }
            if (_t5599[0]._tag === 1 && _t5599[1]._tag === 0) {
              _t5600 = Typechecker$error((("constructor " + __dict_Show_string.show(name)) + " requires an argument"));
              break _t5601;
            }
            _match_fail("line 15950");
          }
          const bindings_5604 = _t5600;
          const _t5605 = [bindings_5604, existential_refs_5589];
          const _t5598 = _t5605;
          const _t5590 = _t5598;
          const _t5582 = _t5590;
          const _t5579 = _t5582;
          _t5576 = _t5579;
          break _t5577;
        }
        _match_fail("line 15950");
      }
      _t5573 = _t5576;
      break _t5574;
    }
    if (true) {
      _t5573 = [Typechecker$check_pattern(ctx, level, pat, scrut_ty), null];
      break _t5574;
    }
    _match_fail("line 15950");
  }
  return _t5573;
}
function Typechecker$check_existential_escape(existential_refs, result_ty) {
  function collect_tvar_refs(acc, ty) {
    while (true) {
      let _t5607;
      const _t5606 = Types$repr(ty);
      _t5608: {
        if (_t5606._tag === 16 && _t5606._val.contents._tag === 0) {
          const r = _t5606._val;
          function _t5609(x) {
            return _eq(x, r);
          }
          let _t5610;
          if (List$exists(_t5609, acc)) {
            _t5610 = acc;
          } else {
            _t5610 = ({_hd: r, _tl: acc});
          }
          _t5607 = _t5610;
          break _t5608;
        }
        if ((_t5606._tag === 7 || _t5606._tag === 8)) {
          const a = _t5606._val[0];
          const b = _t5606._val[2];
          const _t5611 = collect_tvar_refs(acc, a);
          const _t5612 = b;
          acc = _t5611;
          ty = _t5612;
          continue;
          _t5607 = undefined;
          break _t5608;
        }
        if (_t5606._tag === 9) {
          const ts = _t5606._val;
          _t5607 = List$fold(collect_tvar_refs, acc, ts);
          break _t5608;
        }
        if (_t5606._tag === 10) {
          const t = _t5606._val;
          const _t5613 = acc;
          const _t5614 = t;
          acc = _t5613;
          ty = _t5614;
          continue;
          _t5607 = undefined;
          break _t5608;
        }
        if (_t5606._tag === 14) {
          const t = _t5606._val;
          const _t5615 = acc;
          const _t5616 = t;
          acc = _t5615;
          ty = _t5616;
          continue;
          _t5607 = undefined;
          break _t5608;
        }
        if (_t5606._tag === 13) {
          const k = _t5606._val[0];
          const v = _t5606._val[1];
          const _t5617 = collect_tvar_refs(acc, k);
          const _t5618 = v;
          acc = _t5617;
          ty = _t5618;
          continue;
          _t5607 = undefined;
          break _t5608;
        }
        if (_t5606._tag === 11) {
          const row = _t5606._val;
          function _t5619(a, __p120) {
            let _t5621;
            const _t5620 = __p120;
            _t5622: {
              if (true) {
                const t = _t5620[1];
                _t5621 = collect_tvar_refs(a, t);
                break _t5622;
              }
              _match_fail("line 15950");
            }
            return _t5621;
          }
          _t5607 = List$fold(_t5619, acc, Types$record_row_to_fields(row));
          break _t5608;
        }
        if (_t5606._tag === 12) {
          const args = _t5606._val[1];
          _t5607 = List$fold(collect_tvar_refs, acc, args);
          break _t5608;
        }
        if (_t5606._tag === 15) {
          const row = _t5606._val;
          function collect_pv(a, __x) {
            while (true) {
              let _t5624;
              const _t5623 = __x;
              _t5625: {
                if (_t5623._tag === 0 && _t5623._val[1]._tag === 1) {
                  const t = _t5623._val[1]._val;
                  const tail = _t5623._val[2];
                  const _t5626 = collect_tvar_refs(a, t);
                  const _t5627 = tail;
                  a = _t5626;
                  __x = _t5627;
                  continue;
                  _t5624 = undefined;
                  break _t5625;
                }
                if (_t5623._tag === 0 && _t5623._val[1]._tag === 0) {
                  const tail = _t5623._val[2];
                  const _t5628 = a;
                  const _t5629 = tail;
                  a = _t5628;
                  __x = _t5629;
                  continue;
                  _t5624 = undefined;
                  break _t5625;
                }
                if (true) {
                  _t5624 = a;
                  break _t5625;
                }
                _match_fail("line 15950");
              }
              return _t5624;
            }
          }
          const _t5630 = collect_pv(acc, row);
          _t5607 = _t5630;
          break _t5608;
        }
        if (true) {
          _t5607 = acc;
          break _t5608;
        }
        _match_fail("line 15950");
      }
      return _t5607;
    }
  }
  const result_refs_5632 = collect_tvar_refs(null, Types$deep_repr(result_ty));
  function _t5634(exist_ref) {
    let _t5636;
    const _t5635 = Types$repr(({_tag: 16, _name: "TVar", _val: exist_ref}));
    _t5637: {
      if (_t5635._tag === 16 && _t5635._val.contents._tag === 0) {
        const resolved_ref = _t5635._val;
        function _t5638(r) {
          return _eq(r, resolved_ref);
        }
        _t5636 = List$exists(_t5638, result_refs_5632);
        break _t5637;
      }
      if (true) {
        const resolved = _t5635;
        const exist_refs_5639 = collect_tvar_refs(null, resolved);
        function _t5641(er) {
          function _t5642(rr) {
            return _eq(er, rr);
          }
          return List$exists(_t5642, result_refs_5632);
        }
        const _t5640 = List$exists(_t5641, exist_refs_5639);
        _t5636 = _t5640;
        break _t5637;
      }
      _match_fail("line 15950");
    }
    return _t5636;
  }
  const has_escape_5643 = List$exists(_t5634, existential_refs);
  let _t5645;
  if (has_escape_5643) {
    _t5645 = Typechecker$error("existential type variable would escape the scope of its GADT match arm");
  } else {
    _t5645 = undefined;
  }
  const _t5644 = _t5645;
  const _t5633 = _t5644;
  const _t5631 = _t5633;
  return _t5631;
}
function Typechecker$synth_match(expected_ty, ctx, level, scrut, arms, partial) {
  const scrut_te_5646 = Typechecker$synth(ctx, level, scrut);
  let _t5649;
  const _t5648 = Types$repr(scrut_te_5646.ty);
  _t5650: {
    if (_t5648._tag === 12) {
      const name = _t5648._val[0];
      const params = _t5648._val[1];
      let _t5652;
      const _t5651 = Typechecker$find_variant_info(ctx.type_env, name);
      _t5653: {
        if (_t5651._tag === 1 && _t5651._val[3]) {
          _t5652 = ({_tag: 1, _name: "Some", _val: [name, params]});
          break _t5653;
        }
        if (true) {
          _t5652 = ({_tag: 0, _name: "None"});
          break _t5653;
        }
        _match_fail("line 15950");
      }
      _t5649 = _t5652;
      break _t5650;
    }
    if (true) {
      _t5649 = ({_tag: 0, _name: "None"});
      break _t5650;
    }
    _match_fail("line 15950");
  }
  const gadt_info_5654 = _t5649;
  let _t5657;
  const _t5656 = gadt_info_5654;
  _t5658: {
    if (_t5656._tag === 1) {
      const _gadt_name = _t5656._val[0];
      const scrut_params = _t5656._val[1];
      let _t5660;
      const _t5659 = expected_ty;
      _t5661: {
        if (_t5659._tag === 1) {
          const ty = _t5659._val;
          _t5660 = ty;
          break _t5661;
        }
        if (_t5659._tag === 0) {
          _t5660 = Types$new_tvar(level);
          break _t5661;
        }
        _match_fail("line 15950");
      }
      const result_ty_5662 = _t5660;
      function _t5664(ty) {
        let _t5666;
        const _t5665 = Types$repr(ty);
        _t5667: {
          if (_t5665._tag === 16) {
            const r = _t5665._val;
            _t5666 = ({_tag: 1, _name: "Some", _val: r});
            break _t5667;
          }
          if (true) {
            _t5666 = ({_tag: 0, _name: "None"});
            break _t5667;
          }
          _match_fail("line 15950");
        }
        return _t5666;
      }
      const get_tvar_ref_5668 = _t5664;
      function _t5670(p) {
        let _t5672;
        const _t5671 = get_tvar_ref_5668(p);
        _t5673: {
          if (_t5671._tag === 1) {
            const r = _t5671._val;
            _t5672 = ({_tag: 1, _name: "Some", _val: [r, Ref$get(r)]});
            break _t5673;
          }
          if (_t5671._tag === 0) {
            _t5672 = ({_tag: 0, _name: "None"});
            break _t5673;
          }
          _match_fail("line 15950");
        }
        return _t5672;
      }
      const param_refs_5674 = List$filter_map(_t5670, scrut_params);
      function _t5676(_) {
        function _t5677(__p121) {
          let _t5679;
          const _t5678 = __p121;
          _t5680: {
            if (true) {
              const r = _t5678[0];
              _t5679 = [r, Ref$get(r)];
              break _t5680;
            }
            _match_fail("line 15950");
          }
          return _t5679;
        }
        return List$map(_t5677, param_refs_5674);
      }
      const save_snapshot_5681 = _t5676;
      function _t5683(saved) {
        function _t5684(__p122) {
          let _t5686;
          const _t5685 = __p122;
          _t5687: {
            if (true) {
              const r = _t5685[0];
              const v = _t5685[1];
              _t5686 = Ref$set(r, v);
              break _t5687;
            }
            _match_fail("line 15950");
          }
          return _t5686;
        }
        return List$iter(_t5684, saved);
      }
      const restore_snapshot_5688 = _t5683;
      function _t5690(__p123) {
        let _t5692;
        const _t5691 = __p123;
        _t5693: {
          if (true) {
            const pat = _t5691[0];
            const guard = _t5691[1];
            const body = _t5691[2];
            const snapshot_5694 = save_snapshot_5681(undefined);
            let _t5697;
            const _t5696 = pat;
            _t5698: {
              if (_t5696._tag === 10) {
                const name = _t5696._val[0];
                _t5697 = ({_tag: 1, _name: "Some", _val: name});
                break _t5698;
              }
              if (true) {
                _t5697 = ({_tag: 0, _name: "None"});
                break _t5698;
              }
              _match_fail("line 15950");
            }
            const ctor_name_5699 = _t5697;
            let _t5702;
            const _t5701 = ctor_name_5699;
            _t5703: {
              if (_t5701._tag === 1) {
                const name = _t5701._val;
                let _t5705;
                const _t5704 = List$assoc_opt(name, ctx.type_env.constructors);
                _t5706: {
                  if (_t5704._tag === 1) {
                    const info = _t5704._val;
                    _t5705 = !_eq(info.ctor_return_ty_params, ({_tag: 0, _name: "None"}));
                    break _t5706;
                  }
                  if (_t5704._tag === 0) {
                    _t5705 = false;
                    break _t5706;
                  }
                  _match_fail("line 15950");
                }
                _t5702 = _t5705;
                break _t5703;
              }
              if (_t5701._tag === 0) {
                _t5702 = false;
                break _t5703;
              }
              _match_fail("line 15950");
            }
            const is_gadt_ctor_5707 = _t5702;
            let _t5709;
            if (is_gadt_ctor_5707) {
              _t5709 = Typechecker$check_pattern_gadt(ctx, level, pat, scrut_te_5646.ty);
            } else {
              _t5709 = [Typechecker$check_pattern(ctx, level, pat, scrut_te_5646.ty), null];
            }
            let _t5711;
            const _t5710 = _t5709;
            _t5712: {
              if (true) {
                const bindings = _t5710[0];
                const existential_refs = _t5710[1];
                function _t5713(c, __p124) {
                  let _t5715;
                  const _t5714 = __p124;
                  _t5716: {
                    if (true) {
                      const n = _t5714[0];
                      const t = _t5714[1];
                      _t5715 = Typechecker$extend_var_mono(c, n, t);
                      break _t5716;
                    }
                    _match_fail("line 15950");
                  }
                  return _t5715;
                }
                const ctx$p_5717 = List$fold(_t5713, ctx, bindings);
                let _t5720;
                const _t5719 = guard;
                _t5721: {
                  if (_t5719._tag === 1) {
                    const g = _t5719._val;
                    _t5720 = ({_tag: 1, _name: "Some", _val: Typechecker$check(ctx$p_5717, level, g, ({_tag: 2, _name: "TBool"}))});
                    break _t5721;
                  }
                  if (_t5719._tag === 0) {
                    _t5720 = ({_tag: 0, _name: "None"});
                    break _t5721;
                  }
                  _match_fail("line 15950");
                }
                const guard_te_5722 = _t5720;
                const body_te_5724 = Typechecker$check(ctx$p_5717, level, body, result_ty_5662);
                const guard_te_5726 = Option$map(Typechecker$freeze_texpr, guard_te_5722);
                const body_te_5728 = Typechecker$freeze_texpr(body_te_5724);
                let _t5730;
                if (!_eq(existential_refs, null)) {
                  _t5730 = Typechecker$check_existential_escape(existential_refs, result_ty_5662);
                } else {
                  _t5730 = undefined;
                }
                _t5730;
                restore_snapshot_5688(snapshot_5694);
                const _t5729 = [Typechecker$qualify_pattern(ctx.type_env, pat), guard_te_5726, body_te_5728];
                const _t5727 = _t5729;
                const _t5725 = _t5727;
                const _t5723 = _t5725;
                const _t5718 = _t5723;
                _t5711 = _t5718;
                break _t5712;
              }
              _match_fail("line 15950");
            }
            const _t5708 = _t5711;
            const _t5700 = _t5708;
            const _t5695 = _t5700;
            _t5692 = _t5695;
            break _t5693;
          }
          _match_fail("line 15950");
        }
        return _t5692;
      }
      const check_gadt_arm_5731 = _t5690;
      let _t5734;
      const _t5733 = arms;
      _t5735: {
        if (_t5733 === null) {
          _t5734 = Typechecker$error("match expression has no arms");
          break _t5735;
        }
        if (_t5733 !== null) {
          const first = _t5733._hd;
          const rest = _t5733._tl;
          const first_arm_5736 = check_gadt_arm_5731(first);
          const rest_arms_5738 = List$map(check_gadt_arm_5731, rest);
          const all_arms_5740 = ({_hd: first_arm_5736, _tl: rest_arms_5738});
          let _t5742;
          if ((!partial)) {
            _t5742 = Ref$get(Typechecker$exhaustiveness_check_ref, ctx, Types$repr(scrut_te_5646.ty), all_arms_5740);
          } else {
            _t5742 = undefined;
          }
          _t5742;
          const _t5741 = Typechecker$mk(({_tag: 24, _name: "TEMatch", _val: [scrut_te_5646, all_arms_5740, partial]}), result_ty_5662);
          const _t5739 = _t5741;
          const _t5737 = _t5739;
          _t5734 = _t5737;
          break _t5735;
        }
        _match_fail("line 15950");
      }
      const _t5732 = _t5734;
      const _t5689 = _t5732;
      const _t5682 = _t5689;
      const _t5675 = _t5682;
      const _t5669 = _t5675;
      const _t5663 = _t5669;
      _t5657 = _t5663;
      break _t5658;
    }
    if (_t5656._tag === 0) {
      function _t5743(ctx, __p125) {
        let _t5745;
        const _t5744 = __p125;
        _t5746: {
          if (true) {
            const pat = _t5744[0];
            const guard = _t5744[1];
            const body = _t5744[2];
            const bindings_5747 = Typechecker$check_pattern(ctx, level, pat, scrut_te_5646.ty);
            function _t5749(c, __p126) {
              let _t5751;
              const _t5750 = __p126;
              _t5752: {
                if (true) {
                  const n = _t5750[0];
                  const t = _t5750[1];
                  _t5751 = Typechecker$extend_var_mono(c, n, t);
                  break _t5752;
                }
                _match_fail("line 15950");
              }
              return _t5751;
            }
            const ctx$p_5753 = List$fold(_t5749, ctx, bindings_5747);
            let _t5756;
            const _t5755 = guard;
            _t5757: {
              if (_t5755._tag === 1) {
                const g = _t5755._val;
                const gte_5758 = Typechecker$check(ctx$p_5753, level, g, ({_tag: 2, _name: "TBool"}));
                const _t5759 = ({_tag: 1, _name: "Some", _val: gte_5758});
                _t5756 = _t5759;
                break _t5757;
              }
              if (_t5755._tag === 0) {
                _t5756 = ({_tag: 0, _name: "None"});
                break _t5757;
              }
              _match_fail("line 15950");
            }
            const guard_te_5760 = _t5756;
            const body_te_5762 = Typechecker$synth(ctx$p_5753, level, body);
            const _t5763 = [Typechecker$qualify_pattern(ctx.type_env, pat), guard_te_5760, body_te_5762];
            const _t5761 = _t5763;
            const _t5754 = _t5761;
            const _t5748 = _t5754;
            _t5745 = _t5748;
            break _t5746;
          }
          _match_fail("line 15950");
        }
        return _t5745;
      }
      const check_arm_5764 = _t5743;
      let _t5767;
      const _t5766 = arms;
      _t5768: {
        if (_t5766 === null) {
          _t5767 = Typechecker$error("match expression has no arms");
          break _t5768;
        }
        if (_t5766 !== null) {
          const first = _t5766._hd;
          const rest = _t5766._tl;
          let _t5770;
          const _t5769 = check_arm_5764(ctx, first);
          _t5771: {
            if (true) {
              const fp = _t5769[0];
              const fg = _t5769[1];
              const fb = _t5769[2];
              const result_ty_5772 = fb.ty;
              function _t5774(arm) {
                let _t5776;
                const _t5775 = check_arm_5764(ctx, arm);
                _t5777: {
                  if (true) {
                    const p = _t5775[0];
                    const g = _t5775[1];
                    const b = _t5775[2];
                    Typechecker$try_unify(b.ty, result_ty_5772);
                    _t5776 = [p, g, b];
                    break _t5777;
                  }
                  _match_fail("line 15950");
                }
                return _t5776;
              }
              const all_arms_5778 = ({_hd: [fp, fg, fb], _tl: List$map(_t5774, rest)});
              let _t5780;
              if ((!partial)) {
                _t5780 = Ref$get(Typechecker$exhaustiveness_check_ref, ctx, Types$repr(scrut_te_5646.ty), all_arms_5778);
              } else {
                _t5780 = undefined;
              }
              _t5780;
              const _t5779 = Typechecker$mk(({_tag: 24, _name: "TEMatch", _val: [scrut_te_5646, all_arms_5778, partial]}), result_ty_5772);
              const _t5773 = _t5779;
              _t5770 = _t5773;
              break _t5771;
            }
            _match_fail("line 15950");
          }
          _t5767 = _t5770;
          break _t5768;
        }
        _match_fail("line 15950");
      }
      const _t5765 = _t5767;
      _t5657 = _t5765;
      break _t5658;
    }
    _match_fail("line 15950");
  }
  const _t5655 = _t5657;
  const _t5647 = _t5655;
  return _t5647;
}
function Typechecker$check(ctx, level, expr, expected) {
  while (true) {
    let _t5782;
    const _t5781 = expr;
    _t5783: {
      if (_t5781._tag === 49) {
        const loc = _t5781._val[0];
        const inner = _t5781._val[1];
        Ref$set(Typechecker$current_loc, loc);
        const _t5784 = ctx;
        const _t5785 = level;
        const _t5786 = inner;
        const _t5787 = expected;
        ctx = _t5784;
        level = _t5785;
        expr = _t5786;
        expected = _t5787;
        continue;
        _t5782 = undefined;
        break _t5783;
      }
      if (_t5781._tag === 10) {
        const param = _t5781._val[0];
        const body = _t5781._val[1];
        if (_eq(param.annot, ({_tag: 0, _name: "None"}))) {
          const arg_ty_5788 = Types$new_tvar(level);
          const ret_ty_5790 = Types$new_tvar(level);
          const fn_eff_5792 = Types$new_effvar(level);
          Typechecker$try_unify(expected, ({_tag: 7, _name: "TArrow", _val: [arg_ty_5788, fn_eff_5792, ret_ty_5790]}));
          const return_used_5794 = Ref$create(false);
          const __rec_upd_5796 = ctx;
          const _t5797 = ({constraint_tvars: __rec_upd_5796.constraint_tvars, current_eff: fn_eff_5792, current_module: __rec_upd_5796.current_module, inside_handler: false, loop_info: __rec_upd_5796.loop_info, mutable_vars: __rec_upd_5796.mutable_vars, return_type: ({_tag: 1, _name: "Some", _val: ret_ty_5790}), return_used: return_used_5794, type_env: __rec_upd_5796.type_env, vars: __rec_upd_5796.vars});
          const ctx$p_5798 = Typechecker$extend_var_mono(_t5797, param.name, Types$repr(arg_ty_5788));
          const body_te_5800 = Typechecker$check(ctx$p_5798, level, body, ret_ty_5790);
          let _t5802;
          if (param.is_generated) {
            _t5802 = false;
          } else {
            _t5802 = Ref$get(return_used_5794);
          }
          const has_return_5803 = _t5802;
          const _t5804 = Typechecker$mk(({_tag: 10, _name: "TEFun", _val: [param.name, body_te_5800, has_return_5803]}), ({_tag: 7, _name: "TArrow", _val: [arg_ty_5788, fn_eff_5792, body_te_5800.ty]}));
          const _t5801 = _t5804;
          const _t5799 = _t5801;
          const _t5795 = _t5799;
          const _t5793 = _t5795;
          const _t5791 = _t5793;
          const _t5789 = _t5791;
          _t5782 = _t5789;
          break _t5783;
        }
      }
      if (_t5781._tag === 25) {
        const scrut = _t5781._val[0];
        const arms = _t5781._val[1];
        const partial = _t5781._val[2];
        _t5782 = Typechecker$synth_match(({_tag: 1, _name: "Some", _val: expected}), ctx, level, scrut, arms, partial);
        break _t5783;
      }
      if (true) {
        const te_5805 = Typechecker$synth(ctx, level, expr);
        Typechecker$try_unify(te_5805.ty, expected);
        const __rec_upd_5807 = te_5805;
        const _t5808 = ({expr: __rec_upd_5807.expr, loc: __rec_upd_5807.loc, ty: expected});
        const _t5806 = _t5808;
        _t5782 = _t5806;
        break _t5783;
      }
      _match_fail("line 15950");
    }
    return _t5782;
  }
}
function Typechecker$check_pattern(ctx, level, pat, ty) {
  while (true) {
    let _t5810;
    const _t5809 = pat;
    _t5811: {
      if (_t5809._tag === 0) {
        _t5810 = null;
        break _t5811;
      }
      if (_t5809._tag === 1) {
        const name = _t5809._val;
        _t5810 = ({_hd: [name, ty], _tl: null});
        break _t5811;
      }
      if (_t5809._tag === 2) {
        Typechecker$try_unify(ty, ({_tag: 0, _name: "TInt"}));
        _t5810 = null;
        break _t5811;
      }
      if (_t5809._tag === 3) {
        Typechecker$try_unify(ty, ({_tag: 1, _name: "TFloat"}));
        _t5810 = null;
        break _t5811;
      }
      if (_t5809._tag === 4) {
        Typechecker$try_unify(ty, ({_tag: 2, _name: "TBool"}));
        _t5810 = null;
        break _t5811;
      }
      if (_t5809._tag === 5) {
        Typechecker$try_unify(ty, ({_tag: 3, _name: "TString"}));
        _t5810 = null;
        break _t5811;
      }
      if (_t5809._tag === 6) {
        Typechecker$try_unify(ty, ({_tag: 6, _name: "TUnit"}));
        _t5810 = null;
        break _t5811;
      }
      if (_t5809._tag === 7) {
        const pats = _t5809._val;
        function _t5812(_) {
          return Types$new_tvar(level);
        }
        const tys_5813 = List$map(_t5812, pats);
        Typechecker$try_unify(ty, ({_tag: 9, _name: "TTuple", _val: tys_5813}));
        const _t5814 = List$flatten(List$map2(_call(Typechecker$check_pattern, [ctx, level]), pats, tys_5813));
        _t5810 = _t5814;
        break _t5811;
      }
      if (_t5809._tag === 8) {
        const hd_pat = _t5809._val[0];
        const tl_pat = _t5809._val[1];
        const elem_ty_5815 = Types$new_tvar(level);
        Typechecker$try_unify(ty, ({_tag: 10, _name: "TList", _val: elem_ty_5815}));
        const hd_bindings_5817 = Typechecker$check_pattern(ctx, level, hd_pat, elem_ty_5815);
        const tl_bindings_5819 = Typechecker$check_pattern(ctx, level, tl_pat, ty);
        const _t5820 = List$concat(hd_bindings_5817, tl_bindings_5819);
        const _t5818 = _t5820;
        const _t5816 = _t5818;
        _t5810 = _t5816;
        break _t5811;
      }
      if (_t5809._tag === 9) {
        const elem_ty_5821 = Types$new_tvar(level);
        Typechecker$try_unify(ty, ({_tag: 10, _name: "TList", _val: elem_ty_5821}));
        const _t5822 = null;
        _t5810 = _t5822;
        break _t5811;
      }
      if (_t5809._tag === 10) {
        const name = _t5809._val[0];
        const arg_pat = _t5809._val[1];
        let _t5824;
        const _t5823 = List$assoc_opt(name, ctx.type_env.constructors);
        _t5825: {
          if (_t5823._tag === 0) {
            _t5824 = Typechecker$error(("unknown constructor in pattern: " + __dict_Show_string.show(name)));
            break _t5825;
          }
          if (_t5823._tag === 1) {
            const info = _t5823._val;
            function _t5826(_) {
              return Types$new_tvar(level);
            }
            const fresh_args_5827 = List$init(info.ctor_num_params, _t5826);
            const expected_variant_5829 = ({_tag: 12, _name: "TVariant", _val: [info.ctor_type_name, fresh_args_5827]});
            Typechecker$try_unify(ty, expected_variant_5829);
            let _t5832;
            const _t5831 = [info.ctor_arg_ty, arg_pat];
            _t5833: {
              if (_t5831[0]._tag === 0 && _t5831[1]._tag === 0) {
                _t5832 = null;
                break _t5833;
              }
              if (_t5831[0]._tag === 1 && _t5831[1]._tag === 1) {
                const arg_ty = _t5831[0]._val;
                const p = _t5831[1]._val;
                const concrete_ty_5834 = Typechecker$freshen_arrow_effects(level, Typechecker$subst_tgens(fresh_args_5827, arg_ty));
                const _t5836 = ctx;
                const _t5837 = level;
                const _t5838 = p;
                const _t5839 = concrete_ty_5834;
                ctx = _t5836;
                level = _t5837;
                pat = _t5838;
                ty = _t5839;
                continue;
                const _t5835 = undefined;
                _t5832 = _t5835;
                break _t5833;
              }
              if (_t5831[0]._tag === 0 && _t5831[1]._tag === 1) {
                _t5832 = Typechecker$error((("constructor " + __dict_Show_string.show(name)) + " takes no arguments"));
                break _t5833;
              }
              if (_t5831[0]._tag === 1 && _t5831[1]._tag === 0) {
                _t5832 = Typechecker$error((("constructor " + __dict_Show_string.show(name)) + " requires an argument"));
                break _t5833;
              }
              _match_fail("line 15950");
            }
            const _t5830 = _t5832;
            const _t5828 = _t5830;
            _t5824 = _t5828;
            break _t5825;
          }
          _match_fail("line 15950");
        }
        _t5810 = _t5824;
        break _t5811;
      }
      if (_t5809._tag === 11) {
        const field_pats = _t5809._val;
        let _t5841;
        const _t5840 = Types$repr(ty);
        _t5842: {
          if (_t5840._tag === 11) {
            const row = _t5840._val;
            _t5841 = Types$record_row_to_fields(row);
            break _t5842;
          }
          if (true) {
            const pat_field_names_5843 = List$map(fst, field_pats);
            function _t5845(__p127) {
              let _t5847;
              const _t5846 = __p127;
              _t5848: {
                if (true) {
                  const _name = _t5846[0];
                  const fields = _t5846[1];
                  function _t5849(fn_) {
                    return List$mem_assoc(fn_, fields);
                  }
                  _t5847 = List$forall(_t5849, pat_field_names_5843);
                  break _t5848;
                }
                _match_fail("line 15950");
              }
              return _t5847;
            }
            const candidates_5850 = List$filter(_t5845, ctx.type_env.records);
            let _t5853;
            const _t5852 = candidates_5850;
            _t5854: {
              if (_t5852 !== null && _t5852._tl === null) {
                const _name = _t5852._hd[0];
                const fields = _t5852._hd[1];
                const row_5855 = Typechecker$instantiate_record_row(level, fields);
                Typechecker$try_unify(ty, ({_tag: 11, _name: "TRecord", _val: row_5855}));
                const _t5856 = Typechecker$instantiate_record_fields(level, fields);
                _t5853 = _t5856;
                break _t5854;
              }
              if (_t5852 === null) {
                let _t5858;
                const _t5857 = Types$repr(ty);
                _t5859: {
                  if (_t5857._tag === 16) {
                    function _t5860(fname, rest) {
                      return ({_tag: 0, _name: "RRow", _val: [fname, Types$new_tvar(level), rest]});
                    }
                    const row_5861 = List$fold_right(_t5860, pat_field_names_5843, Types$new_rvar(level));
                    Typechecker$try_unify(ty, ({_tag: 11, _name: "TRecord", _val: row_5861}));
                    let _t5864;
                    const _t5863 = Types$repr(ty);
                    _t5865: {
                      if (_t5863._tag === 11) {
                        const r = _t5863._val;
                        _t5864 = r;
                        break _t5865;
                      }
                      if (true) {
                        _t5864 = Typechecker$error("record pattern used with non-record type");
                        break _t5865;
                      }
                      _match_fail("line 15950");
                    }
                    const _t5862 = Types$record_row_to_fields(_t5864);
                    _t5858 = _t5862;
                    break _t5859;
                  }
                  if (true) {
                    _t5858 = Typechecker$error("record pattern used with non-record type");
                    break _t5859;
                  }
                  _match_fail("line 15950");
                }
                _t5853 = _t5858;
                break _t5854;
              }
              if (true) {
                _t5853 = Typechecker$error("ambiguous record pattern â€” annotate the type");
                break _t5854;
              }
              _match_fail("line 15950");
            }
            const _t5851 = _t5853;
            const _t5844 = _t5851;
            _t5841 = _t5844;
            break _t5842;
          }
          _match_fail("line 15950");
        }
        const field_tys_5866 = _t5841;
        function _t5868(__p128) {
          let _t5870;
          const _t5869 = __p128;
          _t5871: {
            if (true) {
              const name = _t5869[0];
              const pat = _t5869[1];
              let _t5873;
              const _t5872 = List$assoc_opt(name, field_tys_5866);
              _t5874: {
                if (_t5872._tag === 1) {
                  const fty = _t5872._val;
                  _t5873 = Typechecker$check_pattern(ctx, level, pat, fty);
                  break _t5874;
                }
                if (_t5872._tag === 0) {
                  _t5873 = Typechecker$error(("record type has no field " + __dict_Show_string.show(name)));
                  break _t5874;
                }
                _match_fail("line 15950");
              }
              _t5870 = _t5873;
              break _t5871;
            }
            _match_fail("line 15950");
          }
          return _t5870;
        }
        const _t5867 = List$flatten(List$map(_t5868, field_pats));
        _t5810 = _t5867;
        break _t5811;
      }
      if (_t5809._tag === 12) {
        const inner_pat = _t5809._val[0];
        const name = _t5809._val[1];
        const bindings_5875 = Typechecker$check_pattern(ctx, level, inner_pat, ty);
        const _t5876 = ({_hd: [name, ty], _tl: bindings_5875});
        _t5810 = _t5876;
        break _t5811;
      }
      if (_t5809._tag === 13) {
        const p1 = _t5809._val[0];
        const p2 = _t5809._val[1];
        const bindings1_5877 = Typechecker$check_pattern(ctx, level, p1, ty);
        const bindings2_5879 = Typechecker$check_pattern(ctx, level, p2, ty);
        const names1_5881 = _call(_call(List$sort, [String$compare]), [List$map(fst, bindings1_5877)]);
        const names2_5883 = _call(_call(List$sort, [String$compare]), [List$map(fst, bindings2_5879)]);
        let _t5885;
        if (!_eq(names1_5881, names2_5883)) {
          _t5885 = Typechecker$error("or-pattern branches must bind the same variables");
        } else {
          _t5885 = undefined;
        }
        _t5885;
        function _t5886(__p129) {
          let _t5888;
          const _t5887 = __p129;
          _t5889: {
            if (true) {
              const name = _t5887[0];
              const ty1 = _t5887[1];
              let _t5891;
              const _t5890 = List$assoc_opt(name, bindings2_5879);
              _t5892: {
                if (_t5890._tag === 1) {
                  const ty2 = _t5890._val;
                  _t5891 = Typechecker$try_unify(ty1, ty2);
                  break _t5892;
                }
                if (_t5890._tag === 0) {
                  _t5891 = undefined;
                  break _t5892;
                }
                _match_fail("line 15950");
              }
              _t5888 = _t5891;
              break _t5889;
            }
            _match_fail("line 15950");
          }
          return _t5888;
        }
        List$iter(_t5886, bindings1_5877);
        const _t5884 = bindings1_5877;
        const _t5882 = _t5884;
        const _t5880 = _t5882;
        const _t5878 = _t5880;
        _t5810 = _t5878;
        break _t5811;
      }
      if (_t5809._tag === 14) {
        const pats = _t5809._val;
        const elem_ty_5893 = Types$new_tvar(level);
        Typechecker$try_unify(ty, ({_tag: 14, _name: "TArray", _val: elem_ty_5893}));
        function _t5895(p) {
          return Typechecker$check_pattern(ctx, level, p, elem_ty_5893);
        }
        const _t5894 = List$concat_map(_t5895, pats);
        _t5810 = _t5894;
        break _t5811;
      }
      if (_t5809._tag === 15) {
        const entries = _t5809._val;
        const key_ty_5896 = Types$new_tvar(level);
        const val_ty_5898 = Types$new_tvar(level);
        Typechecker$try_unify(ty, ({_tag: 13, _name: "TMap", _val: [key_ty_5896, val_ty_5898]}));
        function _t5900(__p130) {
          let _t5902;
          const _t5901 = __p130;
          _t5903: {
            if (true) {
              const kpat = _t5901[0];
              const vpat = _t5901[1];
              _t5902 = List$concat(Typechecker$check_pattern(ctx, level, kpat, key_ty_5896), Typechecker$check_pattern(ctx, level, vpat, val_ty_5898));
              break _t5903;
            }
            _match_fail("line 15950");
          }
          return _t5902;
        }
        const _t5899 = List$concat_map(_t5900, entries);
        const _t5897 = _t5899;
        _t5810 = _t5897;
        break _t5811;
      }
      if (_t5809._tag === 16 && _t5809._val[1]._tag === 0) {
        const tag = _t5809._val[0];
        const tail_5904 = Types$new_pvvar(level);
        const row_5906 = ({_tag: 0, _name: "PVRow", _val: [tag, ({_tag: 0, _name: "None"}), tail_5904]});
        Typechecker$try_unify(ty, ({_tag: 15, _name: "TPolyVariant", _val: row_5906}));
        const _t5907 = null;
        const _t5905 = _t5907;
        _t5810 = _t5905;
        break _t5811;
      }
      if (_t5809._tag === 16 && _t5809._val[1]._tag === 1) {
        const tag = _t5809._val[0];
        const sub_pat = _t5809._val[1]._val;
        const payload_ty_5908 = Types$new_tvar(level);
        const tail_5910 = Types$new_pvvar(level);
        const row_5912 = ({_tag: 0, _name: "PVRow", _val: [tag, ({_tag: 1, _name: "Some", _val: payload_ty_5908}), tail_5910]});
        Typechecker$try_unify(ty, ({_tag: 15, _name: "TPolyVariant", _val: row_5912}));
        const _t5914 = ctx;
        const _t5915 = level;
        const _t5916 = sub_pat;
        const _t5917 = payload_ty_5908;
        ctx = _t5914;
        level = _t5915;
        pat = _t5916;
        ty = _t5917;
        continue;
        const _t5913 = undefined;
        const _t5911 = _t5913;
        const _t5909 = _t5911;
        _t5810 = _t5909;
        break _t5811;
      }
      if (_t5809._tag === 17) {
        const name = _t5809._val;
        let _t5919;
        const _t5918 = List$assoc_opt(name, ctx.vars);
        _t5920: {
          if (_t5918._tag === 1) {
            const scheme = _t5918._val;
            const var_ty_5921 = Types$instantiate(level, scheme);
            Typechecker$try_unify(ty, var_ty_5921);
            const _t5922 = null;
            _t5919 = _t5922;
            break _t5920;
          }
          if (_t5918._tag === 0) {
            _t5919 = Typechecker$error(("unbound variable in pin pattern: " + __dict_Show_string.show(name)));
            break _t5920;
          }
          _match_fail("line 15950");
        }
        _t5810 = _t5919;
        break _t5811;
      }
      if (_t5809._tag === 18) {
        const inner_pat = _t5809._val[0];
        const annot = _t5809._val[1];
        const annot_ty_5923 = Typechecker$resolve_ty_annot(ctx, level, annot);
        Typechecker$try_unify(ty, annot_ty_5923);
        const _t5925 = ctx;
        const _t5926 = level;
        const _t5927 = inner_pat;
        const _t5928 = ty;
        ctx = _t5925;
        level = _t5926;
        pat = _t5927;
        ty = _t5928;
        continue;
        const _t5924 = undefined;
        _t5810 = _t5924;
        break _t5811;
      }
      _match_fail("line 15950");
    }
    return _t5810;
  }
}
function Typechecker$synth_poly_rec_fn(ctx, level, name, qualified_name, type_params, params, ret_annot, body) {
  const shared_tvars_5929 = Hashtbl$create(4);
  function _t5931(tp) {
    return _call(Hashtbl$set, [__dict_Hash_string, __dict_Eq_string, shared_tvars_5929, tp, Types$new_tvar((level + 1))]);
  }
  List$iter(_t5931, type_params);
  function _t5932(p) {
    let _t5934;
    const _t5933 = p.annot;
    _t5935: {
      if (_t5933._tag === 1) {
        const annot = _t5933._val;
        _t5934 = Typechecker$resolve_ty_annot_shared(ctx, (level + 1), shared_tvars_5929, annot);
        break _t5935;
      }
      if (_t5933._tag === 0) {
        _t5934 = Types$new_tvar((level + 1));
        break _t5935;
      }
      _match_fail("line 15950");
    }
    return _t5934;
  }
  const param_tys_5936 = List$map(_t5932, params);
  let _t5939;
  const _t5938 = ret_annot;
  _t5940: {
    if (_t5938._tag === 1 && _t5938._val._tag === 11) {
      const ty = _t5938._val._val[0];
      const eff_annot = _t5938._val._val[1];
      const ty$p_5941 = Typechecker$resolve_ty_annot_shared(ctx, (level + 1), shared_tvars_5929, ty);
      let _t5944;
      const _t5943 = eff_annot;
      _t5945: {
        if (_t5943._tag === 0) {
          _t5944 = ({_tag: 1, _name: "EffEmpty"});
          break _t5945;
        }
        if (_t5943._tag === 1) {
          const items = _t5943._val;
          _t5944 = Typechecker$resolve_eff_items(ctx, (level + 1), shared_tvars_5929, items);
          break _t5945;
        }
        _match_fail("line 15950");
      }
      const eff_5946 = _t5944;
      const _t5947 = [ty$p_5941, eff_5946];
      const _t5942 = _t5947;
      _t5939 = _t5942;
      break _t5940;
    }
    if (_t5938._tag === 1) {
      const annot = _t5938._val;
      _t5939 = [Typechecker$resolve_ty_annot_shared(ctx, (level + 1), shared_tvars_5929, annot), Types$new_effvar((level + 1))];
      break _t5940;
    }
    if (_t5938._tag === 0) {
      _t5939 = [Types$new_tvar((level + 1)), Types$new_effvar((level + 1))];
      break _t5940;
    }
    _match_fail("line 15950");
  }
  let _t5949;
  const _t5948 = _t5939;
  _t5950: {
    if (true) {
      const ret_ty = _t5948[0];
      const body_eff = _t5948[1];
      let _t5952;
      const _t5951 = List$rev(param_tys_5936);
      _t5953: {
        if (_t5951 === null) {
          _t5952 = ret_ty;
          break _t5953;
        }
        if (_t5951 !== null) {
          const last = _t5951._hd;
          const rest = _t5951._tl;
          const inner_5954 = ({_tag: 7, _name: "TArrow", _val: [last, body_eff, ret_ty]});
          function _t5956(acc, pty) {
            return ({_tag: 7, _name: "TArrow", _val: [pty, ({_tag: 1, _name: "EffEmpty"}), acc]});
          }
          const _t5955 = List$fold(_t5956, inner_5954, rest);
          _t5952 = _t5955;
          break _t5953;
        }
        _match_fail("line 15950");
      }
      const fn_ty_5957 = _t5952;
      const scheme_5959 = Types$generalize(level, fn_ty_5957);
      const ctx_with_self_5961 = Typechecker$extend_var(ctx, name, scheme_5959);
      let _t5963;
      if ((qualified_name !== "")) {
        _t5963 = Typechecker$extend_var(ctx_with_self_5961, qualified_name, scheme_5959);
      } else {
        _t5963 = ctx_with_self_5961;
      }
      const ctx_with_self_5964 = _t5963;
      function _t5966(c, p, ty) {
        return Typechecker$extend_var_mono(c, p.name, ty);
      }
      const __rec_upd_5967 = ctx_with_self_5964;
      const _t5968 = ({constraint_tvars: __rec_upd_5967.constraint_tvars, current_eff: body_eff, current_module: __rec_upd_5967.current_module, inside_handler: __rec_upd_5967.inside_handler, loop_info: __rec_upd_5967.loop_info, mutable_vars: __rec_upd_5967.mutable_vars, return_type: __rec_upd_5967.return_type, return_used: __rec_upd_5967.return_used, type_env: __rec_upd_5967.type_env, vars: __rec_upd_5967.vars});
      const inner_ctx_5969 = List$fold2(_t5966, _t5968, params, param_tys_5936);
      const body_te_5971 = Typechecker$check(inner_ctx_5969, (level + 1), body, ret_ty);
      let _t5974;
      const _t5973 = [List$rev(params), List$rev(param_tys_5936)];
      _t5975: {
        if (_t5973[0] === null && _t5973[1] === null) {
          _t5974 = body_te_5971;
          break _t5975;
        }
        if (_t5973[0] !== null && _t5973[1] !== null) {
          const last_p = _t5973[0]._hd;
          const rest_ps = _t5973[0]._tl;
          const last_pty = _t5973[1]._hd;
          const rest_ptys = _t5973[1]._tl;
          const inner_5976 = Typechecker$mk(({_tag: 10, _name: "TEFun", _val: [last_p.name, body_te_5971, false]}), ({_tag: 7, _name: "TArrow", _val: [last_pty, body_eff, body_te_5971.ty]}));
          function _t5978(acc, p, pty) {
            return Typechecker$mk(({_tag: 10, _name: "TEFun", _val: [p.name, acc, false]}), ({_tag: 7, _name: "TArrow", _val: [pty, ({_tag: 1, _name: "EffEmpty"}), acc.ty]}));
          }
          const _t5977 = List$fold2(_t5978, inner_5976, rest_ps, rest_ptys);
          _t5974 = _t5977;
          break _t5975;
        }
        if (true) {
          _t5974 = failwith("assert false");
          break _t5975;
        }
        _match_fail("line 15950");
      }
      const te_5979 = _t5974;
      const _t5980 = [te_5979, scheme_5959];
      const _t5972 = _t5980;
      const _t5970 = _t5972;
      const _t5965 = _t5970;
      const _t5962 = _t5965;
      const _t5960 = _t5962;
      const _t5958 = _t5960;
      _t5949 = _t5958;
      break _t5950;
    }
    _match_fail("line 15950");
  }
  const _t5937 = _t5949;
  const _t5930 = _t5937;
  return _t5930;
}
function Typechecker$normalize_pattern(pat) {
  while (true) {
    let _t5982;
    const _t5981 = pat;
    _t5983: {
      if (_t5981._tag === 12) {
        const inner = _t5981._val[0];
        const _t5984 = inner;
        pat = _t5984;
        continue;
        _t5982 = undefined;
        break _t5983;
      }
      if (_t5981._tag === 13) {
        const p1 = _t5981._val[0];
        const p2 = _t5981._val[1];
        _t5982 = List$concat(Typechecker$normalize_pattern(p1), Typechecker$normalize_pattern(p2));
        break _t5983;
      }
      if (true) {
        const p = _t5981;
        _t5982 = ({_hd: p, _tl: null});
        break _t5983;
      }
      _match_fail("line 15950");
    }
    return _t5982;
  }
}
function Typechecker$ctor_short_name(name) {
  let _t5986;
  const _t5985 = String$rindex_opt(name, 46);
  _t5987: {
    if (_t5985._tag === 1) {
      const i = _t5985._val;
      _t5986 = String$sub(name, (i + 1), ((String$length(name) - i) - 1));
      break _t5987;
    }
    if (_t5985._tag === 0) {
      _t5986 = name;
      break _t5987;
    }
    _match_fail("line 15950");
  }
  return _t5986;
}
function Typechecker$specialize_variant(pats, ctor_name) {
  function _t5988(pat) {
    let _t5990;
    const _t5989 = pat;
    _t5991: {
      if (_t5989._tag === 10) {
        const name = _t5989._val[0];
        const sub = _t5989._val[1];
        if ((Typechecker$ctor_short_name(name) === ctor_name)) {
          let _t5993;
          const _t5992 = sub;
          _t5994: {
            if (_t5992._tag === 1) {
              const p = _t5992._val;
              _t5993 = Typechecker$normalize_pattern(p);
              break _t5994;
            }
            if (_t5992._tag === 0) {
              _t5993 = ({_hd: ({_tag: 0, _name: "PatWild"}), _tl: null});
              break _t5994;
            }
            _match_fail("line 15950");
          }
          _t5990 = _t5993;
          break _t5991;
        }
      }
      if (_t5989._tag === 10) {
        _t5990 = null;
        break _t5991;
      }
      if ((_t5989._tag === 0 || _t5989._tag === 1)) {
        _t5990 = ({_hd: ({_tag: 0, _name: "PatWild"}), _tl: null});
        break _t5991;
      }
      if (_t5989._tag === 12) {
        const inner = _t5989._val[0];
        _t5990 = Typechecker$specialize_variant(Typechecker$normalize_pattern(inner), ctor_name);
        break _t5991;
      }
      if (_t5989._tag === 13) {
        const p1 = _t5989._val[0];
        const p2 = _t5989._val[1];
        _t5990 = List$concat(Typechecker$specialize_variant(Typechecker$normalize_pattern(p1), ctor_name), Typechecker$specialize_variant(Typechecker$normalize_pattern(p2), ctor_name));
        break _t5991;
      }
      if (true) {
        _t5990 = null;
        break _t5991;
      }
      _match_fail("line 15950");
    }
    return _t5990;
  }
  return List$concat_map(_t5988, pats);
}
function Typechecker$has_wildcard(pats) {
  function _t5995(p) {
    let _t5997;
    const _t5996 = p;
    _t5998: {
      if ((_t5996._tag === 0 || _t5996._tag === 1)) {
        _t5997 = true;
        break _t5998;
      }
      if (true) {
        _t5997 = false;
        break _t5998;
      }
      _match_fail("line 15950");
    }
    return _t5997;
  }
  return List$exists(_t5995, pats);
}
function Typechecker$uncovered_patterns(type_env, ty, pats) {
  const pats_5999 = List$concat_map(Typechecker$normalize_pattern, pats);
  let _t6001;
  if (Typechecker$has_wildcard(pats_5999)) {
    _t6001 = null;
  } else {
    let _t6003;
    const _t6002 = Types$repr(ty);
    _t6004: {
      if (_t6002._tag === 12) {
        const name = _t6002._val[0];
        const args = _t6002._val[1];
        let _t6006;
        const _t6005 = Typechecker$find_variant_info(type_env, name);
        _t6007: {
          if (_t6005._tag === 0) {
            _t6006 = null;
            break _t6007;
          }
          if (_t6005._tag === 1) {
            const ctors = _t6005._val[2];
            const is_gadt = _t6005._val[3];
            let _t6008;
            if (is_gadt) {
              function _t6009(__p131) {
                let _t6011;
                const _t6010 = __p131;
                _t6012: {
                  if (true) {
                    const ctor_name = _t6010[0];
                    let _t6014;
                    const _t6013 = List$assoc_opt(ctor_name, type_env.constructors);
                    _t6015: {
                      if (_t6013._tag === 1) {
                        const info = _t6013._val;
                        let _t6017;
                        const _t6016 = info.ctor_return_ty_params;
                        _t6018: {
                          if (_t6016._tag === 0) {
                            _t6017 = true;
                            break _t6018;
                          }
                          if (_t6016._tag === 1) {
                            const ret_params = _t6016._val;
                            let _t6020;
                            if ((List$length(ret_params) === List$length(args))) {
                            function _t6019(p) {
                              return Typechecker$subst_tgens(args, p);
                            }
                              _t6020 = List$forall2(Types$types_compatible, List$map(_t6019, ret_params), args);
                            } else {
                              _t6020 = false;
                            }
                            _t6017 = _t6020;
                            break _t6018;
                          }
                          _match_fail("line 15950");
                        }
                        _t6014 = _t6017;
                        break _t6015;
                      }
                      if (_t6013._tag === 0) {
                        _t6014 = true;
                        break _t6015;
                      }
                      _match_fail("line 15950");
                    }
                    _t6011 = _t6014;
                    break _t6012;
                  }
                  _match_fail("line 15950");
                }
                return _t6011;
              }
              _t6008 = List$filter(_t6009, ctors);
            } else {
              _t6008 = ctors;
            }
            const reachable_ctors_6021 = _t6008;
            function _t6023(__p132) {
              let _t6025;
              const _t6024 = __p132;
              _t6026: {
                if (true) {
                  const ctor_name = _t6024[0];
                  const ctor_arg_ty = _t6024[1];
                  const sub_pats_6027 = Typechecker$specialize_variant(pats_5999, ctor_name);
                  let _t6030;
                  const _t6029 = ctor_arg_ty;
                  _t6031: {
                    if (_t6029._tag === 0) {
                      let _t6032;
                      if ((List$length(sub_pats_6027) === 0)) {
                        _t6032 = ({_hd: ctor_name, _tl: null});
                      } else {
                        _t6032 = null;
                      }
                      _t6030 = _t6032;
                      break _t6031;
                    }
                    if (_t6029._tag === 1) {
                      const arg_ty = _t6029._val;
                      let _t6033;
                      if ((List$length(sub_pats_6027) === 0)) {
                        _t6033 = ({_hd: (ctor_name + " _"), _tl: null});
                      } else {
                        const sub_missing_6034 = Typechecker$uncovered_patterns(type_env, arg_ty, sub_pats_6027);
                        function _t6036(m) {
                          return (ctor_name + (" (" + (m + ")")));
                        }
                        const _t6035 = List$map(_t6036, sub_missing_6034);
                        _t6033 = _t6035;
                      }
                      _t6030 = _t6033;
                      break _t6031;
                    }
                    _match_fail("line 15950");
                  }
                  const _t6028 = _t6030;
                  _t6025 = _t6028;
                  break _t6026;
                }
                _match_fail("line 15950");
              }
              return _t6025;
            }
            const _t6022 = List$concat_map(_t6023, reachable_ctors_6021);
            _t6006 = _t6022;
            break _t6007;
          }
          _match_fail("line 15950");
        }
        _t6003 = _t6006;
        break _t6004;
      }
      if (_t6002._tag === 2) {
        function _t6037(p) {
          let _t6039;
          const _t6038 = p;
          _t6040: {
            if (_t6038._tag === 4 && _t6038._val) {
              _t6039 = true;
              break _t6040;
            }
            if (true) {
              _t6039 = false;
              break _t6040;
            }
            _match_fail("line 15950");
          }
          return _t6039;
        }
        const has_true_6041 = List$exists(_t6037, pats_5999);
        function _t6043(p) {
          let _t6045;
          const _t6044 = p;
          _t6046: {
            if (_t6044._tag === 4 && !_t6044._val) {
              _t6045 = true;
              break _t6046;
            }
            if (true) {
              _t6045 = false;
              break _t6046;
            }
            _match_fail("line 15950");
          }
          return _t6045;
        }
        const has_false_6047 = List$exists(_t6043, pats_5999);
        const missing_6049 = Ref$create(null);
        let _t6051;
        if ((!has_true_6041)) {
          _t6051 = Ref$set(missing_6049, ({_hd: "true", _tl: Ref$get(missing_6049)}));
        } else {
          _t6051 = undefined;
        }
        _t6051;
        let _t6052;
        if ((!has_false_6047)) {
          _t6052 = Ref$set(missing_6049, ({_hd: "false", _tl: Ref$get(missing_6049)}));
        } else {
          _t6052 = undefined;
        }
        _t6052;
        const _t6050 = Ref$get(missing_6049);
        const _t6048 = _t6050;
        const _t6042 = _t6048;
        _t6003 = _t6042;
        break _t6004;
      }
      if (_t6002._tag === 10) {
        function _t6053(p) {
          let _t6055;
          const _t6054 = p;
          _t6056: {
            if (_t6054._tag === 9) {
              _t6055 = true;
              break _t6056;
            }
            if (true) {
              _t6055 = false;
              break _t6056;
            }
            _match_fail("line 15950");
          }
          return _t6055;
        }
        const has_nil_6057 = List$exists(_t6053, pats_5999);
        function _t6059(p) {
          let _t6061;
          const _t6060 = p;
          _t6062: {
            if (_t6060._tag === 8) {
              _t6061 = true;
              break _t6062;
            }
            if (true) {
              _t6061 = false;
              break _t6062;
            }
            _match_fail("line 15950");
          }
          return _t6061;
        }
        const has_cons_6063 = List$exists(_t6059, pats_5999);
        const missing_6065 = Ref$create(null);
        let _t6067;
        if ((!has_nil_6057)) {
          _t6067 = Ref$set(missing_6065, ({_hd: "[]", _tl: Ref$get(missing_6065)}));
        } else {
          _t6067 = undefined;
        }
        _t6067;
        let _t6068;
        if ((!has_cons_6063)) {
          _t6068 = Ref$set(missing_6065, ({_hd: "_ :: _", _tl: Ref$get(missing_6065)}));
        } else {
          _t6068 = undefined;
        }
        _t6068;
        const _t6066 = Ref$get(missing_6065);
        const _t6064 = _t6066;
        const _t6058 = _t6064;
        _t6003 = _t6058;
        break _t6004;
      }
      if (_t6002._tag === 14) {
        function _t6069(p) {
          let _t6071;
          const _t6070 = p;
          _t6072: {
            if (_t6070._tag === 14) {
              const elems = _t6070._val;
              _t6071 = ({_tag: 1, _name: "Some", _val: List$length(elems)});
              break _t6072;
            }
            if (true) {
              _t6071 = ({_tag: 0, _name: "None"});
              break _t6072;
            }
            _match_fail("line 15950");
          }
          return _t6071;
        }
        const lengths_6073 = List$filter_map(_t6069, pats_5999);
        const lengths_set_6075 = List$sort_uniq(compare, lengths_6073);
        function find_missing(n) {
          while (true) {
            let _t6077;
            if (List$mem(n, lengths_set_6075)) {
              const _t6078 = (n + 1);
              n = _t6078;
              continue;
              _t6077 = undefined;
            } else {
              _t6077 = n;
            }
            return _t6077;
          }
        }
        const missing_len_6080 = find_missing(0);
        let _t6082;
        if ((missing_len_6080 === 0)) {
          _t6082 = "#[]";
        } else {
          function _t6083(_) {
            return "_";
          }
          _t6082 = ("#[" + (String$concat("; ", List$init(missing_len_6080, _t6083)) + "]"));
        }
        const missing_pat_6084 = _t6082;
        const _t6085 = ({_hd: missing_pat_6084, _tl: null});
        const _t6081 = _t6085;
        const _t6079 = _t6081;
        const _t6076 = _t6079;
        const _t6074 = _t6076;
        _t6003 = _t6074;
        break _t6004;
      }
      if (_t6002._tag === 13) {
        _t6003 = ({_hd: "_", _tl: null});
        break _t6004;
      }
      if (((_t6002._tag === 0 || _t6002._tag === 1) || _t6002._tag === 3)) {
        _t6003 = ({_hd: "_", _tl: null});
        break _t6004;
      }
      if (_t6002._tag === 6) {
        function _t6086(p) {
          let _t6088;
          const _t6087 = p;
          _t6089: {
            if (_t6087._tag === 6) {
              _t6088 = true;
              break _t6089;
            }
            if (true) {
              _t6088 = false;
              break _t6089;
            }
            _match_fail("line 15950");
          }
          return _t6088;
        }
        const has_unit_6090 = List$exists(_t6086, pats_5999);
        let _t6092;
        if (has_unit_6090) {
          _t6092 = null;
        } else {
          _t6092 = ({_hd: "()", _tl: null});
        }
        const _t6091 = _t6092;
        _t6003 = _t6091;
        break _t6004;
      }
      if (_t6002._tag === 9) {
        const ts = _t6002._val;
        function _t6093(p) {
          let _t6095;
          const _t6094 = p;
          _t6096: {
            if (_t6094._tag === 7) {
              const ps = _t6094._val;
              if ((List$length(ps) === List$length(ts))) {
                _t6095 = ({_tag: 1, _name: "Some", _val: ps});
                break _t6096;
              }
            }
            if (true) {
              _t6095 = ({_tag: 0, _name: "None"});
              break _t6096;
            }
            _match_fail("line 15950");
          }
          return _t6095;
        }
        const tuple_pats_6097 = List$filter_map(_t6093, pats_5999);
        let _t6099;
        if (_eq(tuple_pats_6097, null)) {
          function _t6100(_) {
            return "_";
          }
          _t6099 = ({_hd: ("(" + (String$concat(", ", List$init(List$length(ts), _t6100)) + ")")), _tl: null});
        } else {
          function check_positions(i, __x) {
            while (true) {
              let _t6102;
              const _t6101 = __x;
              _t6103: {
                if (_t6101 === null) {
                  _t6102 = null;
                  break _t6103;
                }
                if (_t6101 !== null) {
                  const elem_ty = _t6101._hd;
                  const rest_tys = _t6101._tl;
                  function _t6104(ps) {
                    return List$nth(ps, i);
                  }
                  const position_pats_6105 = List$map(_t6104, tuple_pats_6097);
                  const sub_missing_6107 = Typechecker$uncovered_patterns(type_env, elem_ty, position_pats_6105);
                  let _t6109;
                  if (!_eq(sub_missing_6107, null)) {
                    function _t6110(j) {
                      let _t6111;
                      if ((j === i)) {
                        _t6111 = List$hd(sub_missing_6107);
                      } else {
                        _t6111 = "_";
                      }
                      return _t6111;
                    }
                    const template_6112 = List$init(List$length(ts), _t6110);
                    const _t6113 = ({_hd: ("(" + (String$concat(", ", template_6112) + ")")), _tl: null});
                    _t6109 = _t6113;
                  } else {
                    const _t6114 = (i + 1);
                    const _t6115 = rest_tys;
                    i = _t6114;
                    __x = _t6115;
                    continue;
                    _t6109 = undefined;
                  }
                  const _t6108 = _t6109;
                  const _t6106 = _t6108;
                  _t6102 = _t6106;
                  break _t6103;
                }
                _match_fail("line 15950");
              }
              return _t6102;
            }
          }
          const _t6116 = check_positions(0, ts);
          _t6099 = _t6116;
        }
        const _t6098 = _t6099;
        _t6003 = _t6098;
        break _t6004;
      }
      if (true) {
        _t6003 = null;
        break _t6004;
      }
      _match_fail("line 15950");
    }
    _t6001 = _t6003;
  }
  const _t6000 = _t6001;
  return _t6000;
}
function Typechecker$exhaustiveness_check(ctx, ty, arms) {
  function _t6117(__p133) {
    let _t6119;
    const _t6118 = __p133;
    _t6120: {
      if (true) {
        const pat = _t6118[0];
        const guard = _t6118[1];
        const _body = _t6118[2];
        let _t6122;
        const _t6121 = guard;
        _t6123: {
          if (_t6121._tag === 0) {
            _t6122 = ({_tag: 1, _name: "Some", _val: pat});
            break _t6123;
          }
          if (_t6121._tag === 1) {
            _t6122 = ({_tag: 0, _name: "None"});
            break _t6123;
          }
          _match_fail("line 15950");
        }
        _t6119 = _t6122;
        break _t6120;
      }
      _match_fail("line 15950");
    }
    return _t6119;
  }
  const unguarded_pats_6124 = List$filter_map(_t6117, arms);
  const missing_6126 = Typechecker$uncovered_patterns(ctx.type_env, ty, unguarded_pats_6124);
  let _t6128;
  if (!_eq(missing_6126, null)) {
    _t6128 = Typechecker$error(("non-exhaustive match, missing: " + __dict_Show_string.show(String$concat(", ", missing_6126))));
  } else {
    _t6128 = undefined;
  }
  const _t6127 = _t6128;
  const _t6125 = _t6127;
  return _t6125;
}
const Typechecker$__destruct = Ref$set(Typechecker$exhaustiveness_check_ref, Typechecker$exhaustiveness_check);
function Typechecker$process_type_def(ctx, type_params, type_name, def) {
  const num_params_6129 = List$length(type_params);
  let _t6132;
  const _t6131 = def;
  _t6133: {
    if (_t6131._tag === 0) {
      const ctors = _t6131._val;
      const __rec_upd_6134 = ctx;
      const __rec_upd_6136 = ctx.type_env;
      const _t6137 = ({classes: __rec_upd_6136.classes, constructors: __rec_upd_6136.constructors, effects: __rec_upd_6136.effects, instances: __rec_upd_6136.instances, modules: __rec_upd_6136.modules, mutable_fields: __rec_upd_6136.mutable_fields, records: __rec_upd_6136.records, type_aliases: __rec_upd_6136.type_aliases, type_synonyms: __rec_upd_6136.type_synonyms, variants: ({_hd: [type_name, num_params_6129, null, false], _tl: ctx.type_env.variants})});
      const _t6135 = ({constraint_tvars: __rec_upd_6134.constraint_tvars, current_eff: __rec_upd_6134.current_eff, current_module: __rec_upd_6134.current_module, inside_handler: __rec_upd_6134.inside_handler, loop_info: __rec_upd_6134.loop_info, mutable_vars: __rec_upd_6134.mutable_vars, return_type: __rec_upd_6134.return_type, return_used: __rec_upd_6134.return_used, type_env: _t6137, vars: __rec_upd_6134.vars});
      const pre_ctx_6138 = _t6135;
      const param_tbl_6140 = Hashtbl$create(4);
      function _t6142(i, name) {
        return _call(Hashtbl$set, [__dict_Hash_string, __dict_Eq_string, param_tbl_6140, name, i]);
      }
      List$iteri(_t6142, type_params);
      function _t6143(annot) {
        const tvars_6144 = Hashtbl$create(4);
        function go(__x) {
          while (true) {
            let _t6147;
            const _t6146 = __x;
            _t6148: {
              if (_t6146._tag === 1) {
                const name = _t6146._val;
                let _t6150;
                const _t6149 = _call(Hashtbl$get, [__dict_Hash_string, __dict_Eq_string, param_tbl_6140, name]);
                _t6151: {
                  if (_t6149._tag === 1) {
                    const idx = _t6149._val;
                    _t6150 = ({_tag: 17, _name: "TGen", _val: idx});
                    break _t6151;
                  }
                  if (_t6149._tag === 0) {
                    let _t6153;
                    const _t6152 = _call(Hashtbl$get, [__dict_Hash_string, __dict_Eq_string, tvars_6144, name]);
                    _t6154: {
                      if (_t6152._tag === 1) {
                        const tv = _t6152._val;
                        _t6153 = tv;
                        break _t6154;
                      }
                      if (_t6152._tag === 0) {
                        const tv_6155 = Types$new_tvar(0);
                        _call(Hashtbl$set, [__dict_Hash_string, __dict_Eq_string, tvars_6144, name, tv_6155]);
                        const _t6156 = tv_6155;
                        _t6153 = _t6156;
                        break _t6154;
                      }
                      _match_fail("line 15950");
                    }
                    _t6150 = _t6153;
                    break _t6151;
                  }
                  _match_fail("line 15950");
                }
                _t6147 = _t6150;
                break _t6148;
              }
              if (_t6146._tag === 0 && _t6146._val === "int") {
                _t6147 = ({_tag: 0, _name: "TInt"});
                break _t6148;
              }
              if (_t6146._tag === 0 && _t6146._val === "float") {
                _t6147 = ({_tag: 1, _name: "TFloat"});
                break _t6148;
              }
              if (_t6146._tag === 0 && _t6146._val === "bool") {
                _t6147 = ({_tag: 2, _name: "TBool"});
                break _t6148;
              }
              if (_t6146._tag === 0 && _t6146._val === "string") {
                _t6147 = ({_tag: 3, _name: "TString"});
                break _t6148;
              }
              if (_t6146._tag === 0 && _t6146._val === "unit") {
                _t6147 = ({_tag: 6, _name: "TUnit"});
                break _t6148;
              }
              if (_t6146._tag === 0) {
                const name = _t6146._val;
                const canonical_6157 = Typechecker$resolve_type_alias(pre_ctx_6138.type_env, name);
                function _t6159(__p134) {
                  let _t6161;
                  const _t6160 = __p134;
                  _t6162: {
                    if (true) {
                      const n = _t6160[0];
                      _t6161 = (n === canonical_6157);
                      break _t6162;
                    }
                    _match_fail("line 15950");
                  }
                  return _t6161;
                }
                let _t6164;
                const _t6163 = List$find(_t6159, pre_ctx_6138.type_env.type_synonyms);
                _t6165: {
                  if (_t6163._tag === 1 && _t6163._val[1] === 0) {
                    const ty = _t6163._val[2];
                    _t6164 = ty;
                    break _t6165;
                  }
                  if (_t6163._tag === 1) {
                    const n = _t6163._val[1];
                    _t6164 = Typechecker$error((((("type " + __dict_Show_string.show(name)) + " expects ") + __dict_Show_int.show(n)) + " type argument(s)"));
                    break _t6165;
                  }
                  if (_t6163._tag === 0) {
                    let _t6167;
                    const _t6166 = Typechecker$find_variant_info(pre_ctx_6138.type_env, name);
                    _t6168: {
                      if (_t6166._tag === 1 && _t6166._val[1] === 0) {
                        _t6167 = ({_tag: 12, _name: "TVariant", _val: [canonical_6157, null]});
                        break _t6168;
                      }
                      if (_t6166._tag === 1) {
                        const n = _t6166._val[1];
                        _t6167 = Typechecker$error((((("type " + __dict_Show_string.show(name)) + " expects ") + __dict_Show_int.show(n)) + " type argument(s)"));
                        break _t6168;
                      }
                      if (_t6166._tag === 0) {
                        let _t6169;
                        if (!_eq(List$assoc_opt(canonical_6157, pre_ctx_6138.type_env.records), ({_tag: 0, _name: "None"}))) {
                          const fields_6170 = List$assoc(canonical_6157, pre_ctx_6138.type_env.records);
                          const _t6171 = ({_tag: 11, _name: "TRecord", _val: Types$fields_to_closed_row(fields_6170)});
                          _t6169 = _t6171;
                        } else {
                          _t6169 = Typechecker$error(("unknown type: " + __dict_Show_string.show(name)));
                        }
                        _t6167 = _t6169;
                        break _t6168;
                      }
                      _match_fail("line 15950");
                    }
                    _t6164 = _t6167;
                    break _t6165;
                  }
                  _match_fail("line 15950");
                }
                const _t6158 = _t6164;
                _t6147 = _t6158;
                break _t6148;
              }
              if (_t6146._tag === 2) {
                const a = _t6146._val[0];
                const b = _t6146._val[1];
                _t6147 = ({_tag: 7, _name: "TArrow", _val: [go(a), ({_tag: 1, _name: "EffEmpty"}), go(b)]});
                break _t6148;
              }
              if (_t6146._tag === 6) {
                const ts = _t6146._val;
                _t6147 = ({_tag: 9, _name: "TTuple", _val: List$map(go, ts)});
                break _t6148;
              }
              if (_t6146._tag === 4) {
                const t = _t6146._val;
                _t6147 = ({_tag: 10, _name: "TList", _val: go(t)});
                break _t6148;
              }
              if (_t6146._tag === 5) {
                const t = _t6146._val;
                _t6147 = ({_tag: 14, _name: "TArray", _val: go(t)});
                break _t6148;
              }
              if (_t6146._tag === 8) {
                const k = _t6146._val[0];
                const v = _t6146._val[1];
                _t6147 = ({_tag: 13, _name: "TMap", _val: [go(k), go(v)]});
                break _t6148;
              }
              if (_t6146._tag === 7) {
                const args = _t6146._val[0];
                const tname = _t6146._val[1];
                const canonical_6172 = Typechecker$resolve_type_alias(pre_ctx_6138.type_env, tname);
                const arg_tys_6174 = List$map(go, args);
                function _t6176(__p135) {
                  let _t6178;
                  const _t6177 = __p135;
                  _t6179: {
                    if (true) {
                      const n = _t6177[0];
                      _t6178 = (n === canonical_6172);
                      break _t6179;
                    }
                    _match_fail("line 15950");
                  }
                  return _t6178;
                }
                let _t6181;
                const _t6180 = List$find(_t6176, pre_ctx_6138.type_env.type_synonyms);
                _t6182: {
                  if (_t6180._tag === 1) {
                    const np = _t6180._val[1];
                    const ty = _t6180._val[2];
                    let _t6183;
                    if ((List$length(arg_tys_6174) !== np)) {
                      _t6183 = Typechecker$error(((((("type " + __dict_Show_string.show(tname)) + " expects ") + __dict_Show_int.show(np)) + " type argument(s), got ") + __dict_Show_int.show(List$length(arg_tys_6174))));
                    } else {
                      _t6183 = undefined;
                    }
                    _t6183;
                    _t6181 = Typechecker$subst_tgens(arg_tys_6174, ty);
                    break _t6182;
                  }
                  if (_t6180._tag === 0) {
                    let _t6185;
                    const _t6184 = Typechecker$find_variant_info(pre_ctx_6138.type_env, tname);
                    _t6186: {
                      if (_t6184._tag === 1) {
                        const np = _t6184._val[1];
                        let _t6187;
                        if ((List$length(arg_tys_6174) !== np)) {
                          _t6187 = Typechecker$error(((((("type " + __dict_Show_string.show(tname)) + " expects ") + __dict_Show_int.show(np)) + " type argument(s), got ") + __dict_Show_int.show(List$length(arg_tys_6174))));
                        } else {
                          _t6187 = undefined;
                        }
                        _t6187;
                        _t6185 = ({_tag: 12, _name: "TVariant", _val: [canonical_6172, arg_tys_6174]});
                        break _t6186;
                      }
                      if (_t6184._tag === 0) {
                        _t6185 = Typechecker$error(("unknown type constructor: " + __dict_Show_string.show(tname)));
                        break _t6186;
                      }
                      _match_fail("line 15950");
                    }
                    _t6181 = _t6185;
                    break _t6182;
                  }
                  _match_fail("line 15950");
                }
                const _t6175 = _t6181;
                const _t6173 = _t6175;
                _t6147 = _t6173;
                break _t6148;
              }
              if (_t6146._tag === 3) {
                const fields = _t6146._val[0];
                const is_open = _t6146._val[1];
                function _t6188(__p136) {
                  let _t6190;
                  const _t6189 = __p136;
                  _t6191: {
                    if (true) {
                      const n = _t6189[0];
                      const t = _t6189[1];
                      _t6190 = [n, go(t)];
                      break _t6191;
                    }
                    _match_fail("line 15950");
                  }
                  return _t6190;
                }
                const fields_6192 = List$map(_t6188, fields);
                function _t6194(__p137, __p138) {
                  let _t6196;
                  const _t6195 = __p137;
                  _t6197: {
                    if (true) {
                      const a = _t6195[0];
                      let _t6199;
                      const _t6198 = __p138;
                      _t6200: {
                        if (true) {
                          const b = _t6198[0];
                          _t6199 = String$compare(a, b);
                          break _t6200;
                        }
                        _match_fail("line 15950");
                      }
                      _t6196 = _t6199;
                      break _t6197;
                    }
                    _match_fail("line 15950");
                  }
                  return _t6196;
                }
                const fields_6201 = List$sort(_t6194, fields_6192);
                let _t6203;
                if (is_open) {
                  _t6203 = Types$new_rvar(0);
                } else {
                  _t6203 = ({_tag: 2, _name: "REmpty"});
                }
                const tail_6204 = _t6203;
                function _t6206(__p139, acc) {
                  let _t6208;
                  const _t6207 = __p139;
                  _t6209: {
                    if (true) {
                      const n = _t6207[0];
                      const t = _t6207[1];
                      _t6208 = ({_tag: 0, _name: "RRow", _val: [n, t, acc]});
                      break _t6209;
                    }
                    _match_fail("line 15950");
                  }
                  return _t6208;
                }
                const _t6205 = ({_tag: 11, _name: "TRecord", _val: List$fold_right(_t6206, fields_6201, tail_6204)});
                const _t6202 = _t6205;
                const _t6193 = _t6202;
                _t6147 = _t6193;
                break _t6148;
              }
              if (_t6146._tag === 9) {
                const path = _t6146._val[0];
                const name = _t6146._val[1];
                const qualified_6210 = (String$concat(".", path) + ("." + name));
                const _t6212 = ({_tag: 0, _name: "TyName", _val: qualified_6210});
                __x = _t6212;
                continue;
                const _t6211 = undefined;
                _t6147 = _t6211;
                break _t6148;
              }
              if (_t6146._tag === 10) {
                const _kind = _t6146._val[0];
                const tags = _t6146._val[1];
                function _t6213(__p140, acc) {
                  let _t6215;
                  const _t6214 = __p140;
                  _t6216: {
                    if (true) {
                      const tag = _t6214[0];
                      const payload_annot = _t6214[1];
                      _t6215 = ({_tag: 0, _name: "PVRow", _val: [tag, Option$map(go, payload_annot), acc]});
                      break _t6216;
                    }
                    _match_fail("line 15950");
                  }
                  return _t6215;
                }
                const row_6217 = List$fold_right(_t6213, tags, ({_tag: 2, _name: "PVEmpty"}));
                const _t6218 = ({_tag: 15, _name: "TPolyVariant", _val: row_6217});
                _t6147 = _t6218;
                break _t6148;
              }
              if (_t6146._tag === 11) {
                const ty = _t6146._val[0];
                const _t6219 = ty;
                __x = _t6219;
                continue;
                _t6147 = undefined;
                break _t6148;
              }
              _match_fail("line 15950");
            }
            return _t6147;
          }
        }
        const _t6220 = go(annot);
        const _t6145 = _t6220;
        return _t6145;
      }
      const resolve_with_params_6221 = _t6143;
      function _t6223(__p141) {
        let _t6225;
        const _t6224 = __p141;
        _t6226: {
          if (true) {
            const ret = _t6224[2];
            _t6225 = !_eq(ret, ({_tag: 0, _name: "None"}));
            break _t6226;
          }
          _match_fail("line 15950");
        }
        return _t6225;
      }
      const is_gadt_6227 = List$exists(_t6223, ctors);
      function collect_annot_vars(acc, __x) {
        while (true) {
          let _t6230;
          const _t6229 = __x;
          _t6231: {
            if (_t6229._tag === 1) {
              const name = _t6229._val;
              let _t6232;
              if (List$mem(name, acc)) {
                _t6232 = acc;
              } else {
                _t6232 = ({_hd: name, _tl: acc});
              }
              _t6230 = _t6232;
              break _t6231;
            }
            if (_t6229._tag === 2) {
              const a = _t6229._val[0];
              const b = _t6229._val[1];
              const _t6233 = collect_annot_vars(acc, a);
              const _t6234 = b;
              acc = _t6233;
              __x = _t6234;
              continue;
              _t6230 = undefined;
              break _t6231;
            }
            if (_t6229._tag === 6) {
              const ts = _t6229._val;
              _t6230 = List$fold(collect_annot_vars, acc, ts);
              break _t6231;
            }
            if ((_t6229._tag === 4 || _t6229._tag === 5)) {
              const t = _t6229._val;
              const _t6235 = acc;
              const _t6236 = t;
              acc = _t6235;
              __x = _t6236;
              continue;
              _t6230 = undefined;
              break _t6231;
            }
            if (_t6229._tag === 8) {
              const k = _t6229._val[0];
              const v = _t6229._val[1];
              const _t6237 = collect_annot_vars(acc, k);
              const _t6238 = v;
              acc = _t6237;
              __x = _t6238;
              continue;
              _t6230 = undefined;
              break _t6231;
            }
            if (_t6229._tag === 7) {
              const args = _t6229._val[0];
              _t6230 = List$fold(collect_annot_vars, acc, args);
              break _t6231;
            }
            if (_t6229._tag === 3) {
              const fs = _t6229._val[0];
              function _t6239(a, __p142) {
                let _t6241;
                const _t6240 = __p142;
                _t6242: {
                  if (true) {
                    const t = _t6240[1];
                    _t6241 = collect_annot_vars(a, t);
                    break _t6242;
                  }
                  _match_fail("line 15950");
                }
                return _t6241;
              }
              _t6230 = List$fold(_t6239, acc, fs);
              break _t6231;
            }
            if ((_t6229._tag === 9 || _t6229._tag === 0)) {
              _t6230 = acc;
              break _t6231;
            }
            if (_t6229._tag === 10) {
              const tags = _t6229._val[1];
              function _t6243(a, __p143) {
                let _t6245;
                const _t6244 = __p143;
                _t6246: {
                  if (true) {
                    const ty_opt = _t6244[1];
                    let _t6248;
                    const _t6247 = ty_opt;
                    _t6249: {
                      if (_t6247._tag === 1) {
                        const t = _t6247._val;
                        _t6248 = collect_annot_vars(a, t);
                        break _t6249;
                      }
                      if (_t6247._tag === 0) {
                        _t6248 = a;
                        break _t6249;
                      }
                      _match_fail("line 15950");
                    }
                    _t6245 = _t6248;
                    break _t6246;
                  }
                  _match_fail("line 15950");
                }
                return _t6245;
              }
              _t6230 = List$fold(_t6243, acc, tags);
              break _t6231;
            }
            if (_t6229._tag === 11) {
              const ty = _t6229._val[0];
              const _t6250 = acc;
              const _t6251 = ty;
              acc = _t6250;
              __x = _t6251;
              continue;
              _t6230 = undefined;
              break _t6231;
            }
            _match_fail("line 15950");
          }
          return _t6230;
        }
      }
      function _t6253(__dict_Show_0, __p144) {
        let _t6255;
        const _t6254 = __p144;
        _t6256: {
          if (true) {
            const name = _t6254[0];
            const arg_annot = _t6254[1];
            const ret_annot = _t6254[2];
            let _t6258;
            const _t6257 = ret_annot;
            _t6259: {
              if (_t6257._tag === 0) {
                const arg_ty_6260 = Option$map(resolve_with_params_6221, arg_annot);
                const info_6262 = ({ctor_arg_ty: arg_ty_6260, ctor_existentials: 0, ctor_num_params: num_params_6129, ctor_return_ty_params: ({_tag: 0, _name: "None"}), ctor_type_name: type_name});
                const _t6263 = [[name, arg_ty_6260], [name, info_6262]];
                const _t6261 = _t6263;
                _t6258 = _t6261;
                break _t6259;
              }
              if (_t6257._tag === 1) {
                const ret = _t6257._val;
                let _t6265;
                const _t6264 = ret;
                _t6266: {
                  if (_t6264._tag === 0) {
                    const n = _t6264._val;
                    _t6265 = [n, null];
                    break _t6266;
                  }
                  if (_t6264._tag === 7) {
                    const args = _t6264._val[0];
                    const n = _t6264._val[1];
                    _t6265 = [n, args];
                    break _t6266;
                  }
                  if (true) {
                    _t6265 = Typechecker$error(((("GADT constructor " + __dict_Show_0.show(name)) + ": return type must be ") + __dict_Show_string.show(type_name)));
                    break _t6266;
                  }
                  _match_fail("line 15950");
                }
                let _t6268;
                const _t6267 = _t6265;
                _t6269: {
                  if (true) {
                    const ret_type_name = _t6267[0];
                    const ret_type_args = _t6267[1];
                    const canonical_ret_6270 = Typechecker$resolve_type_alias(pre_ctx_6138.type_env, ret_type_name);
                    let _t6277;
                    if ((canonical_ret_6270 === type_name)) {
                      _t6277 = true;
                    } else {
                    let _t6273;
                    const _t6272 = String$rindex_opt(type_name, 46);
                    _t6274: {
                      if (_t6272._tag === 1) {
                        const i = _t6272._val;
                        const _mml$short_6275 = String$sub(type_name, (i + 1), ((String$length(type_name) - i) - 1));
                        const _t6276 = (ret_type_name === _mml$short_6275);
                        _t6273 = _t6276;
                        break _t6274;
                      }
                      if (_t6272._tag === 0) {
                        _t6273 = false;
                        break _t6274;
                      }
                      _match_fail("line 15950");
                    }
                      _t6277 = _t6273;
                    }
                    const name_matches_6278 = _t6277;
                    let _t6280;
                    if ((!name_matches_6278)) {
                      _t6280 = Typechecker$error(((((("GADT constructor " + __dict_Show_0.show(name)) + ": return type must be ") + __dict_Show_string.show(type_name)) + ", got ") + __dict_Show_string.show(ret_type_name)));
                    } else {
                      _t6280 = undefined;
                    }
                    _t6280;
                    let _t6281;
                    if ((List$length(ret_type_args) !== num_params_6129)) {
                      _t6281 = Typechecker$error(((((("GADT constructor " + __dict_Show_0.show(name)) + ": return type has ") + __dict_Show_int.show(List$length(ret_type_args))) + " type arg(s), expected ") + __dict_Show_int.show(num_params_6129)));
                    } else {
                      _t6281 = undefined;
                    }
                    _t6281;
                    const ret_vars_6282 = List$fold(collect_annot_vars, null, ret_type_args);
                    let _t6285;
                    const _t6284 = arg_annot;
                    _t6286: {
                      if (_t6284._tag === 0) {
                        _t6285 = null;
                        break _t6286;
                      }
                      if (_t6284._tag === 1) {
                        const a = _t6284._val;
                        _t6285 = collect_annot_vars(null, a);
                        break _t6286;
                      }
                      _match_fail("line 15950");
                    }
                    const arg_vars_6287 = _t6285;
                    function _t6289(v) {
                      return ((!List$mem(v, ret_vars_6282)) && (!List$mem(v, type_params)));
                    }
                    const existentials_6290 = List$filter(_t6289, arg_vars_6287);
                    const num_exist_6292 = List$length(existentials_6290);
                    const gadt_tbl_6294 = Hashtbl$create(8);
                    function _t6296(i, p) {
                      return _call(Hashtbl$set, [__dict_Hash_string, __dict_Eq_string, gadt_tbl_6294, p, i]);
                    }
                    List$iteri(_t6296, type_params);
                    function _t6297(i, e) {
                      return _call(Hashtbl$set, [__dict_Hash_string, __dict_Eq_string, gadt_tbl_6294, e, (num_params_6129 + i)]);
                    }
                    List$iteri(_t6297, existentials_6290);
                    const gadt_tvars_6298 = Hashtbl$create(4);
                    function gadt_resolve(__x) {
                      while (true) {
                        let _t6301;
                        const _t6300 = __x;
                        _t6302: {
                          if (_t6300._tag === 1) {
                            const vname = _t6300._val;
                            let _t6304;
                            const _t6303 = _call(Hashtbl$get, [__dict_Hash_string, __dict_Eq_string, gadt_tbl_6294, vname]);
                            _t6305: {
                              if (_t6303._tag === 1) {
                                const idx = _t6303._val;
                                _t6304 = ({_tag: 17, _name: "TGen", _val: idx});
                                break _t6305;
                              }
                              if (_t6303._tag === 0) {
                                let _t6307;
                                const _t6306 = _call(Hashtbl$get, [__dict_Hash_string, __dict_Eq_string, gadt_tvars_6298, vname]);
                                _t6308: {
                                  if (_t6306._tag === 1) {
                                    const tv = _t6306._val;
                                    _t6307 = tv;
                                    break _t6308;
                                  }
                                  if (_t6306._tag === 0) {
                                    const tv_6309 = Types$new_tvar(0);
                                    _call(Hashtbl$set, [__dict_Hash_string, __dict_Eq_string, gadt_tvars_6298, vname, tv_6309]);
                                    const _t6310 = tv_6309;
                                    _t6307 = _t6310;
                                    break _t6308;
                                  }
                                  _match_fail("line 15950");
                                }
                                _t6304 = _t6307;
                                break _t6305;
                              }
                              _match_fail("line 15950");
                            }
                            _t6301 = _t6304;
                            break _t6302;
                          }
                          if (_t6300._tag === 0 && _t6300._val === "int") {
                            _t6301 = ({_tag: 0, _name: "TInt"});
                            break _t6302;
                          }
                          if (_t6300._tag === 0 && _t6300._val === "float") {
                            _t6301 = ({_tag: 1, _name: "TFloat"});
                            break _t6302;
                          }
                          if (_t6300._tag === 0 && _t6300._val === "bool") {
                            _t6301 = ({_tag: 2, _name: "TBool"});
                            break _t6302;
                          }
                          if (_t6300._tag === 0 && _t6300._val === "string") {
                            _t6301 = ({_tag: 3, _name: "TString"});
                            break _t6302;
                          }
                          if (_t6300._tag === 0 && _t6300._val === "unit") {
                            _t6301 = ({_tag: 6, _name: "TUnit"});
                            break _t6302;
                          }
                          if (_t6300._tag === 0) {
                            const n = _t6300._val;
                            const canonical_6311 = Typechecker$resolve_type_alias(pre_ctx_6138.type_env, n);
                            function _t6313(__p145) {
                              let _t6315;
                              const _t6314 = __p145;
                              _t6316: {
                                if (true) {
                                  const tn = _t6314[0];
                                  _t6315 = (tn === canonical_6311);
                                  break _t6316;
                                }
                                _match_fail("line 15950");
                              }
                              return _t6315;
                            }
                            let _t6318;
                            const _t6317 = List$find(_t6313, pre_ctx_6138.type_env.type_synonyms);
                            _t6319: {
                              if (_t6317._tag === 1 && _t6317._val[1] === 0) {
                                const ty = _t6317._val[2];
                                _t6318 = ty;
                                break _t6319;
                              }
                              if (_t6317._tag === 1) {
                                const np = _t6317._val[1];
                                _t6318 = Typechecker$error((((("type " + __dict_Show_string.show(n)) + " expects ") + __dict_Show_int.show(np)) + " type argument(s)"));
                                break _t6319;
                              }
                              if (_t6317._tag === 0) {
                                let _t6321;
                                const _t6320 = Typechecker$find_variant_info(pre_ctx_6138.type_env, n);
                                _t6322: {
                                  if (_t6320._tag === 1 && _t6320._val[1] === 0) {
                                    _t6321 = ({_tag: 12, _name: "TVariant", _val: [canonical_6311, null]});
                                    break _t6322;
                                  }
                                  if (_t6320._tag === 1) {
                                    const np = _t6320._val[1];
                                    _t6321 = Typechecker$error((((("type " + __dict_Show_string.show(n)) + " expects ") + __dict_Show_int.show(np)) + " type argument(s)"));
                                    break _t6322;
                                  }
                                  if (_t6320._tag === 0) {
                                    let _t6323;
                                    if (!_eq(List$assoc_opt(canonical_6311, pre_ctx_6138.type_env.records), ({_tag: 0, _name: "None"}))) {
                                      const fields_6324 = List$assoc(canonical_6311, pre_ctx_6138.type_env.records);
                                      let _t6326;
                                      if (_eq(fields_6324, null)) {
                                        _t6326 = ({_tag: 11, _name: "TRecord", _val: ({_tag: 4, _name: "RWild"})});
                                      } else {
                                        _t6326 = ({_tag: 11, _name: "TRecord", _val: Types$fields_to_closed_row(fields_6324)});
                                      }
                                      const _t6325 = _t6326;
                                      _t6323 = _t6325;
                                    } else {
                                      _t6323 = Typechecker$error(("unknown type: " + __dict_Show_string.show(n)));
                                    }
                                    _t6321 = _t6323;
                                    break _t6322;
                                  }
                                  _match_fail("line 15950");
                                }
                                _t6318 = _t6321;
                                break _t6319;
                              }
                              _match_fail("line 15950");
                            }
                            const _t6312 = _t6318;
                            _t6301 = _t6312;
                            break _t6302;
                          }
                          if (_t6300._tag === 2) {
                            const a = _t6300._val[0];
                            const b = _t6300._val[1];
                            _t6301 = ({_tag: 7, _name: "TArrow", _val: [gadt_resolve(a), ({_tag: 1, _name: "EffEmpty"}), gadt_resolve(b)]});
                            break _t6302;
                          }
                          if (_t6300._tag === 6) {
                            const ts = _t6300._val;
                            _t6301 = ({_tag: 9, _name: "TTuple", _val: List$map(gadt_resolve, ts)});
                            break _t6302;
                          }
                          if (_t6300._tag === 4) {
                            const t = _t6300._val;
                            _t6301 = ({_tag: 10, _name: "TList", _val: gadt_resolve(t)});
                            break _t6302;
                          }
                          if (_t6300._tag === 5) {
                            const t = _t6300._val;
                            _t6301 = ({_tag: 14, _name: "TArray", _val: gadt_resolve(t)});
                            break _t6302;
                          }
                          if (_t6300._tag === 8) {
                            const k = _t6300._val[0];
                            const v = _t6300._val[1];
                            _t6301 = ({_tag: 13, _name: "TMap", _val: [gadt_resolve(k), gadt_resolve(v)]});
                            break _t6302;
                          }
                          if (_t6300._tag === 7) {
                            const args = _t6300._val[0];
                            const tname = _t6300._val[1];
                            const canonical_6327 = Typechecker$resolve_type_alias(pre_ctx_6138.type_env, tname);
                            const arg_tys_6329 = List$map(gadt_resolve, args);
                            function _t6331(__p146) {
                              let _t6333;
                              const _t6332 = __p146;
                              _t6334: {
                                if (true) {
                                  const tn = _t6332[0];
                                  _t6333 = (tn === canonical_6327);
                                  break _t6334;
                                }
                                _match_fail("line 15950");
                              }
                              return _t6333;
                            }
                            let _t6336;
                            const _t6335 = List$find(_t6331, pre_ctx_6138.type_env.type_synonyms);
                            _t6337: {
                              if (_t6335._tag === 1) {
                                const np = _t6335._val[1];
                                const ty = _t6335._val[2];
                                let _t6338;
                                if ((List$length(arg_tys_6329) !== np)) {
                                  _t6338 = Typechecker$error(((((("type " + __dict_Show_string.show(tname)) + " expects ") + __dict_Show_int.show(np)) + " type argument(s), got ") + __dict_Show_int.show(List$length(arg_tys_6329))));
                                } else {
                                  _t6338 = undefined;
                                }
                                _t6338;
                                _t6336 = Typechecker$subst_tgens(arg_tys_6329, ty);
                                break _t6337;
                              }
                              if (_t6335._tag === 0) {
                                let _t6340;
                                const _t6339 = Typechecker$find_variant_info(pre_ctx_6138.type_env, tname);
                                _t6341: {
                                  if (_t6339._tag === 1) {
                                    const np = _t6339._val[1];
                                    let _t6342;
                                    if ((List$length(arg_tys_6329) !== np)) {
                                      _t6342 = Typechecker$error(((((("type " + __dict_Show_string.show(tname)) + " expects ") + __dict_Show_int.show(np)) + " type argument(s), got ") + __dict_Show_int.show(List$length(arg_tys_6329))));
                                    } else {
                                      _t6342 = undefined;
                                    }
                                    _t6342;
                                    _t6340 = ({_tag: 12, _name: "TVariant", _val: [canonical_6327, arg_tys_6329]});
                                    break _t6341;
                                  }
                                  if (_t6339._tag === 0) {
                                    _t6340 = Typechecker$error(("unknown type constructor: " + __dict_Show_string.show(tname)));
                                    break _t6341;
                                  }
                                  _match_fail("line 15950");
                                }
                                _t6336 = _t6340;
                                break _t6337;
                              }
                              _match_fail("line 15950");
                            }
                            const _t6330 = _t6336;
                            const _t6328 = _t6330;
                            _t6301 = _t6328;
                            break _t6302;
                          }
                          if (_t6300._tag === 3) {
                            const fields = _t6300._val[0];
                            const is_open = _t6300._val[1];
                            function _t6343(__p147, __p148) {
                              let _t6345;
                              const _t6344 = __p147;
                              _t6346: {
                                if (true) {
                                  const a = _t6344[0];
                                  let _t6348;
                                  const _t6347 = __p148;
                                  _t6349: {
                                    if (true) {
                                      const b = _t6347[0];
                                      _t6348 = String$compare(a, b);
                                      break _t6349;
                                    }
                                    _match_fail("line 15950");
                                  }
                                  _t6345 = _t6348;
                                  break _t6346;
                                }
                                _match_fail("line 15950");
                              }
                              return _t6345;
                            }
                            function _t6350(__p149) {
                              let _t6352;
                              const _t6351 = __p149;
                              _t6353: {
                                if (true) {
                                  const fn_ = _t6351[0];
                                  const ft = _t6351[1];
                                  _t6352 = [fn_, gadt_resolve(ft)];
                                  break _t6353;
                                }
                                _match_fail("line 15950");
                              }
                              return _t6352;
                            }
                            const fields_6354 = List$sort(_t6343, List$map(_t6350, fields));
                            let _t6356;
                            if (is_open) {
                              _t6356 = Types$new_rvar(0);
                            } else {
                              _t6356 = ({_tag: 2, _name: "REmpty"});
                            }
                            const tail_6357 = _t6356;
                            function _t6359(__p150, acc) {
                              let _t6361;
                              const _t6360 = __p150;
                              _t6362: {
                                if (true) {
                                  const n = _t6360[0];
                                  const t = _t6360[1];
                                  _t6361 = ({_tag: 0, _name: "RRow", _val: [n, t, acc]});
                                  break _t6362;
                                }
                                _match_fail("line 15950");
                              }
                              return _t6361;
                            }
                            const _t6358 = ({_tag: 11, _name: "TRecord", _val: List$fold_right(_t6359, fields_6354, tail_6357)});
                            const _t6355 = _t6358;
                            _t6301 = _t6355;
                            break _t6302;
                          }
                          if (_t6300._tag === 9) {
                            const path = _t6300._val[0];
                            const n = _t6300._val[1];
                            const qualified_6363 = (String$concat(".", path) + ("." + n));
                            const _t6365 = ({_tag: 0, _name: "TyName", _val: qualified_6363});
                            __x = _t6365;
                            continue;
                            const _t6364 = undefined;
                            _t6301 = _t6364;
                            break _t6302;
                          }
                          if (_t6300._tag === 10) {
                            const _kind = _t6300._val[0];
                            const tags = _t6300._val[1];
                            function _t6366(__p151, acc) {
                              let _t6368;
                              const _t6367 = __p151;
                              _t6369: {
                                if (true) {
                                  const tag = _t6367[0];
                                  const payload_annot = _t6367[1];
                                  _t6368 = ({_tag: 0, _name: "PVRow", _val: [tag, Option$map(gadt_resolve, payload_annot), acc]});
                                  break _t6369;
                                }
                                _match_fail("line 15950");
                              }
                              return _t6368;
                            }
                            const row_6370 = List$fold_right(_t6366, tags, ({_tag: 2, _name: "PVEmpty"}));
                            const _t6371 = ({_tag: 15, _name: "TPolyVariant", _val: row_6370});
                            _t6301 = _t6371;
                            break _t6302;
                          }
                          if (_t6300._tag === 11) {
                            const ty = _t6300._val[0];
                            const _t6372 = ty;
                            __x = _t6372;
                            continue;
                            _t6301 = undefined;
                            break _t6302;
                          }
                          _match_fail("line 15950");
                        }
                        return _t6301;
                      }
                    }
                    const arg_ty_6374 = Option$map(gadt_resolve, arg_annot);
                    const ret_params_6376 = List$map(gadt_resolve, ret_type_args);
                    const info_6378 = ({ctor_arg_ty: arg_ty_6374, ctor_existentials: num_exist_6292, ctor_num_params: num_params_6129, ctor_return_ty_params: ({_tag: 1, _name: "Some", _val: ret_params_6376}), ctor_type_name: type_name});
                    const _t6379 = [[name, arg_ty_6374], [name, info_6378]];
                    const _t6377 = _t6379;
                    const _t6375 = _t6377;
                    const _t6373 = _t6375;
                    const _t6299 = _t6373;
                    const _t6295 = _t6299;
                    const _t6293 = _t6295;
                    const _t6291 = _t6293;
                    const _t6288 = _t6291;
                    const _t6283 = _t6288;
                    const _t6279 = _t6283;
                    const _t6271 = _t6279;
                    _t6268 = _t6271;
                    break _t6269;
                  }
                  _match_fail("line 15950");
                }
                _t6258 = _t6268;
                break _t6259;
              }
              _match_fail("line 15950");
            }
            _t6255 = _t6258;
            break _t6256;
          }
          _match_fail("line 15950");
        }
        return _t6255;
      }
      const process_ctor_6380 = _t6253;
      const results_6382 = List$map(_call(process_ctor_6380, [__dict_Show_string]), ctors);
      const variant_def_6384 = List$map(fst, results_6382);
      const ctor_infos_6386 = List$map(snd, results_6382);
      const __rec_upd_6388 = ctx.type_env;
      const _t6389 = ({classes: __rec_upd_6388.classes, constructors: List$concat(ctor_infos_6386, ctx.type_env.constructors), effects: __rec_upd_6388.effects, instances: __rec_upd_6388.instances, modules: __rec_upd_6388.modules, mutable_fields: __rec_upd_6388.mutable_fields, records: __rec_upd_6388.records, type_aliases: __rec_upd_6388.type_aliases, type_synonyms: __rec_upd_6388.type_synonyms, variants: ({_hd: [type_name, num_params_6129, variant_def_6384, is_gadt_6227], _tl: ctx.type_env.variants})});
      const type_env_6390 = _t6389;
      const __rec_upd_6392 = ctx;
      const _t6393 = ({constraint_tvars: __rec_upd_6392.constraint_tvars, current_eff: __rec_upd_6392.current_eff, current_module: __rec_upd_6392.current_module, inside_handler: __rec_upd_6392.inside_handler, loop_info: __rec_upd_6392.loop_info, mutable_vars: __rec_upd_6392.mutable_vars, return_type: __rec_upd_6392.return_type, return_used: __rec_upd_6392.return_used, type_env: type_env_6390, vars: __rec_upd_6392.vars});
      const _t6391 = _t6393;
      const _t6387 = _t6391;
      const _t6385 = _t6387;
      const _t6383 = _t6385;
      const _t6381 = _t6383;
      const _t6252 = _t6381;
      const _t6228 = _t6252;
      const _t6222 = _t6228;
      const _t6141 = _t6222;
      const _t6139 = _t6141;
      _t6132 = _t6139;
      break _t6133;
    }
    if (_t6131._tag === 1) {
      const fields = _t6131._val;
      const __rec_upd_6394 = ctx;
      const __rec_upd_6396 = ctx.type_env;
      const _t6397 = ({classes: __rec_upd_6396.classes, constructors: __rec_upd_6396.constructors, effects: __rec_upd_6396.effects, instances: __rec_upd_6396.instances, modules: __rec_upd_6396.modules, mutable_fields: __rec_upd_6396.mutable_fields, records: ({_hd: [type_name, null], _tl: ctx.type_env.records}), type_aliases: __rec_upd_6396.type_aliases, type_synonyms: __rec_upd_6396.type_synonyms, variants: __rec_upd_6396.variants});
      const _t6395 = ({constraint_tvars: __rec_upd_6394.constraint_tvars, current_eff: __rec_upd_6394.current_eff, current_module: __rec_upd_6394.current_module, inside_handler: __rec_upd_6394.inside_handler, loop_info: __rec_upd_6394.loop_info, mutable_vars: __rec_upd_6394.mutable_vars, return_type: __rec_upd_6394.return_type, return_used: __rec_upd_6394.return_used, type_env: _t6397, vars: __rec_upd_6394.vars});
      const pre_ctx_6398 = _t6395;
      const param_tbl_6400 = Hashtbl$create(4);
      function _t6402(i, name) {
        return _call(Hashtbl$set, [__dict_Hash_string, __dict_Eq_string, param_tbl_6400, name, i]);
      }
      List$iteri(_t6402, type_params);
      function _t6403(__p152) {
        let _t6405;
        const _t6404 = __p152;
        _t6406: {
          if (true) {
            const _is_mut = _t6404[0];
            const name = _t6404[1];
            const annot = _t6404[2];
            const tvars_6407 = Hashtbl$create(4);
            function resolve_field(__x) {
              while (true) {
                let _t6410;
                const _t6409 = __x;
                _t6411: {
                  if (_t6409._tag === 1) {
                    const vname = _t6409._val;
                    let _t6413;
                    const _t6412 = _call(Hashtbl$get, [__dict_Hash_string, __dict_Eq_string, param_tbl_6400, vname]);
                    _t6414: {
                      if (_t6412._tag === 1) {
                        const idx = _t6412._val;
                        _t6413 = ({_tag: 17, _name: "TGen", _val: idx});
                        break _t6414;
                      }
                      if (_t6412._tag === 0) {
                        let _t6416;
                        const _t6415 = _call(Hashtbl$get, [__dict_Hash_string, __dict_Eq_string, tvars_6407, vname]);
                        _t6417: {
                          if (_t6415._tag === 1) {
                            const tv = _t6415._val;
                            _t6416 = tv;
                            break _t6417;
                          }
                          if (_t6415._tag === 0) {
                            const tv_6418 = Types$new_tvar(0);
                            _call(Hashtbl$set, [__dict_Hash_string, __dict_Eq_string, tvars_6407, vname, tv_6418]);
                            const _t6419 = tv_6418;
                            _t6416 = _t6419;
                            break _t6417;
                          }
                          _match_fail("line 15950");
                        }
                        _t6413 = _t6416;
                        break _t6414;
                      }
                      _match_fail("line 15950");
                    }
                    _t6410 = _t6413;
                    break _t6411;
                  }
                  if (_t6409._tag === 0 && _t6409._val === "int") {
                    _t6410 = ({_tag: 0, _name: "TInt"});
                    break _t6411;
                  }
                  if (_t6409._tag === 0 && _t6409._val === "float") {
                    _t6410 = ({_tag: 1, _name: "TFloat"});
                    break _t6411;
                  }
                  if (_t6409._tag === 0 && _t6409._val === "bool") {
                    _t6410 = ({_tag: 2, _name: "TBool"});
                    break _t6411;
                  }
                  if (_t6409._tag === 0 && _t6409._val === "string") {
                    _t6410 = ({_tag: 3, _name: "TString"});
                    break _t6411;
                  }
                  if (_t6409._tag === 0 && _t6409._val === "unit") {
                    _t6410 = ({_tag: 6, _name: "TUnit"});
                    break _t6411;
                  }
                  if (_t6409._tag === 0) {
                    const n = _t6409._val;
                    _t6410 = Typechecker$resolve_ty_annot(pre_ctx_6398, 0, ({_tag: 0, _name: "TyName", _val: n}));
                    break _t6411;
                  }
                  if (_t6409._tag === 2) {
                    const a = _t6409._val[0];
                    const b = _t6409._val[1];
                    _t6410 = ({_tag: 7, _name: "TArrow", _val: [resolve_field(a), ({_tag: 1, _name: "EffEmpty"}), resolve_field(b)]});
                    break _t6411;
                  }
                  if (_t6409._tag === 6) {
                    const ts = _t6409._val;
                    _t6410 = ({_tag: 9, _name: "TTuple", _val: List$map(resolve_field, ts)});
                    break _t6411;
                  }
                  if (_t6409._tag === 4) {
                    const t = _t6409._val;
                    _t6410 = ({_tag: 10, _name: "TList", _val: resolve_field(t)});
                    break _t6411;
                  }
                  if (_t6409._tag === 5) {
                    const t = _t6409._val;
                    _t6410 = ({_tag: 14, _name: "TArray", _val: resolve_field(t)});
                    break _t6411;
                  }
                  if (_t6409._tag === 8) {
                    const k = _t6409._val[0];
                    const v = _t6409._val[1];
                    _t6410 = ({_tag: 13, _name: "TMap", _val: [resolve_field(k), resolve_field(v)]});
                    break _t6411;
                  }
                  if (_t6409._tag === 7) {
                    const args = _t6409._val[0];
                    const n = _t6409._val[1];
                    const arg_tys_6420 = List$map(resolve_field, args);
                    function _t6422(__p153) {
                      let _t6424;
                      const _t6423 = __p153;
                      _t6425: {
                        if (true) {
                          const tn = _t6423[0];
                          _t6424 = (tn === n);
                          break _t6425;
                        }
                        _match_fail("line 15950");
                      }
                      return _t6424;
                    }
                    let _t6427;
                    const _t6426 = List$find(_t6422, pre_ctx_6398.type_env.type_synonyms);
                    _t6428: {
                      if (_t6426._tag === 1) {
                        const np = _t6426._val[1];
                        const ty = _t6426._val[2];
                        let _t6429;
                        if ((List$length(arg_tys_6420) !== np)) {
                          _t6429 = Typechecker$error(((((("type " + __dict_Show_string.show(n)) + " expects ") + __dict_Show_int.show(np)) + " arg(s), got ") + __dict_Show_int.show(List$length(arg_tys_6420))));
                        } else {
                          _t6429 = undefined;
                        }
                        _t6429;
                        _t6427 = Typechecker$subst_tgens(arg_tys_6420, ty);
                        break _t6428;
                      }
                      if (_t6426._tag === 0) {
                        let _t6431;
                        const _t6430 = Typechecker$find_variant_info(pre_ctx_6398.type_env, n);
                        _t6432: {
                          if (_t6430._tag === 1) {
                            const np = _t6430._val[1];
                            let _t6433;
                            if ((List$length(arg_tys_6420) !== np)) {
                              _t6433 = Typechecker$error(((((("type " + __dict_Show_string.show(n)) + " expects ") + __dict_Show_int.show(np)) + " arg(s), got ") + __dict_Show_int.show(List$length(arg_tys_6420))));
                            } else {
                              _t6433 = undefined;
                            }
                            _t6433;
                            const canonical_6434 = Typechecker$resolve_type_alias(pre_ctx_6398.type_env, n);
                            const _t6435 = ({_tag: 12, _name: "TVariant", _val: [canonical_6434, arg_tys_6420]});
                            _t6431 = _t6435;
                            break _t6432;
                          }
                          if (_t6430._tag === 0) {
                            _t6431 = Typechecker$error(("unknown type constructor: " + __dict_Show_string.show(n)));
                            break _t6432;
                          }
                          _match_fail("line 15950");
                        }
                        _t6427 = _t6431;
                        break _t6428;
                      }
                      _match_fail("line 15950");
                    }
                    const _t6421 = _t6427;
                    _t6410 = _t6421;
                    break _t6411;
                  }
                  if (_t6409._tag === 3) {
                    const fs = _t6409._val[0];
                    const is_open = _t6409._val[1];
                    function _t6436(__p154, __p155) {
                      let _t6438;
                      const _t6437 = __p154;
                      _t6439: {
                        if (true) {
                          const a = _t6437[0];
                          let _t6441;
                          const _t6440 = __p155;
                          _t6442: {
                            if (true) {
                              const b = _t6440[0];
                              _t6441 = String$compare(a, b);
                              break _t6442;
                            }
                            _match_fail("line 15950");
                          }
                          _t6438 = _t6441;
                          break _t6439;
                        }
                        _match_fail("line 15950");
                      }
                      return _t6438;
                    }
                    function _t6443(__p156) {
                      let _t6445;
                      const _t6444 = __p156;
                      _t6446: {
                        if (true) {
                          const fn_ = _t6444[0];
                          const ft = _t6444[1];
                          _t6445 = [fn_, resolve_field(ft)];
                          break _t6446;
                        }
                        _match_fail("line 15950");
                      }
                      return _t6445;
                    }
                    const fields_6447 = List$sort(_t6436, List$map(_t6443, fs));
                    let _t6449;
                    if (is_open) {
                      _t6449 = Types$new_rvar(0);
                    } else {
                      _t6449 = ({_tag: 2, _name: "REmpty"});
                    }
                    const tail_6450 = _t6449;
                    function _t6452(__p157, acc) {
                      let _t6454;
                      const _t6453 = __p157;
                      _t6455: {
                        if (true) {
                          const n = _t6453[0];
                          const t = _t6453[1];
                          _t6454 = ({_tag: 0, _name: "RRow", _val: [n, t, acc]});
                          break _t6455;
                        }
                        _match_fail("line 15950");
                      }
                      return _t6454;
                    }
                    const _t6451 = ({_tag: 11, _name: "TRecord", _val: List$fold_right(_t6452, fields_6447, tail_6450)});
                    const _t6448 = _t6451;
                    _t6410 = _t6448;
                    break _t6411;
                  }
                  if (_t6409._tag === 9) {
                    const path = _t6409._val[0];
                    const n = _t6409._val[1];
                    const qualified_6456 = (String$concat(".", path) + ("." + n));
                    const _t6458 = ({_tag: 0, _name: "TyName", _val: qualified_6456});
                    __x = _t6458;
                    continue;
                    const _t6457 = undefined;
                    _t6410 = _t6457;
                    break _t6411;
                  }
                  if (_t6409._tag === 10) {
                    const _kind = _t6409._val[0];
                    const tags = _t6409._val[1];
                    function _t6459(__p158, acc) {
                      let _t6461;
                      const _t6460 = __p158;
                      _t6462: {
                        if (true) {
                          const tag = _t6460[0];
                          const payload_annot = _t6460[1];
                          _t6461 = ({_tag: 0, _name: "PVRow", _val: [tag, Option$map(resolve_field, payload_annot), acc]});
                          break _t6462;
                        }
                        _match_fail("line 15950");
                      }
                      return _t6461;
                    }
                    const row_6463 = List$fold_right(_t6459, tags, ({_tag: 2, _name: "PVEmpty"}));
                    const _t6464 = ({_tag: 15, _name: "TPolyVariant", _val: row_6463});
                    _t6410 = _t6464;
                    break _t6411;
                  }
                  if (_t6409._tag === 11) {
                    const ty = _t6409._val[0];
                    const _t6465 = ty;
                    __x = _t6465;
                    continue;
                    _t6410 = undefined;
                    break _t6411;
                  }
                  _match_fail("line 15950");
                }
                return _t6410;
              }
            }
            const _t6466 = [name, resolve_field(annot)];
            const _t6408 = _t6466;
            _t6405 = _t6408;
            break _t6406;
          }
          _match_fail("line 15950");
        }
        return _t6405;
      }
      const typed_fields_6467 = List$map(_t6403, fields);
      function _t6469(__p159) {
        let _t6471;
        const _t6470 = __p159;
        _t6472: {
          if (true) {
            const is_mut = _t6470[0];
            const name = _t6470[1];
            let _t6473;
            if (is_mut) {
              _t6473 = ({_tag: 1, _name: "Some", _val: name});
            } else {
              _t6473 = ({_tag: 0, _name: "None"});
            }
            _t6471 = _t6473;
            break _t6472;
          }
          _match_fail("line 15950");
        }
        return _t6471;
      }
      const mut_fields_6474 = List$filter_map(_t6469, fields);
      function _t6476(__p160, __p161) {
        let _t6478;
        const _t6477 = __p160;
        _t6479: {
          if (true) {
            const a = _t6477[0];
            let _t6481;
            const _t6480 = __p161;
            _t6482: {
              if (true) {
                const b = _t6480[0];
                _t6481 = String$compare(a, b);
                break _t6482;
              }
              _match_fail("line 15950");
            }
            _t6478 = _t6481;
            break _t6479;
          }
          _match_fail("line 15950");
        }
        return _t6478;
      }
      const sorted_fields_6483 = List$sort(_t6476, typed_fields_6467);
      const __rec_upd_6485 = ctx.type_env;
      const _t6486 = ({classes: __rec_upd_6485.classes, constructors: __rec_upd_6485.constructors, effects: __rec_upd_6485.effects, instances: __rec_upd_6485.instances, modules: __rec_upd_6485.modules, mutable_fields: List$concat(mut_fields_6474, ctx.type_env.mutable_fields), records: ({_hd: [type_name, sorted_fields_6483], _tl: ctx.type_env.records}), type_aliases: __rec_upd_6485.type_aliases, type_synonyms: ({_hd: [type_name, num_params_6129, ({_tag: 11, _name: "TRecord", _val: Types$fields_to_closed_row(sorted_fields_6483)})], _tl: ctx.type_env.type_synonyms}), variants: __rec_upd_6485.variants});
      const type_env_6487 = _t6486;
      const __rec_upd_6489 = ctx;
      const _t6490 = ({constraint_tvars: __rec_upd_6489.constraint_tvars, current_eff: __rec_upd_6489.current_eff, current_module: __rec_upd_6489.current_module, inside_handler: __rec_upd_6489.inside_handler, loop_info: __rec_upd_6489.loop_info, mutable_vars: __rec_upd_6489.mutable_vars, return_type: __rec_upd_6489.return_type, return_used: __rec_upd_6489.return_used, type_env: type_env_6487, vars: __rec_upd_6489.vars});
      const _t6488 = _t6490;
      const _t6484 = _t6488;
      const _t6475 = _t6484;
      const _t6468 = _t6475;
      const _t6401 = _t6468;
      const _t6399 = _t6401;
      _t6132 = _t6399;
      break _t6133;
    }
    if (_t6131._tag === 2) {
      const annot = _t6131._val;
      const param_tbl_6491 = Hashtbl$create(4);
      function _t6493(i, name) {
        return _call(Hashtbl$set, [__dict_Hash_string, __dict_Eq_string, param_tbl_6491, name, i]);
      }
      List$iteri(_t6493, type_params);
      const tvars_6494 = Hashtbl$create(4);
      function resolve_alias(__x) {
        while (true) {
          let _t6497;
          const _t6496 = __x;
          _t6498: {
            if (_t6496._tag === 1) {
              const name = _t6496._val;
              let _t6500;
              const _t6499 = _call(Hashtbl$get, [__dict_Hash_string, __dict_Eq_string, param_tbl_6491, name]);
              _t6501: {
                if (_t6499._tag === 1) {
                  const idx = _t6499._val;
                  _t6500 = ({_tag: 17, _name: "TGen", _val: idx});
                  break _t6501;
                }
                if (_t6499._tag === 0) {
                  let _t6503;
                  const _t6502 = _call(Hashtbl$get, [__dict_Hash_string, __dict_Eq_string, tvars_6494, name]);
                  _t6504: {
                    if (_t6502._tag === 1) {
                      const tv = _t6502._val;
                      _t6503 = tv;
                      break _t6504;
                    }
                    if (_t6502._tag === 0) {
                      const tv_6505 = Types$new_tvar(0);
                      _call(Hashtbl$set, [__dict_Hash_string, __dict_Eq_string, tvars_6494, name, tv_6505]);
                      const _t6506 = tv_6505;
                      _t6503 = _t6506;
                      break _t6504;
                    }
                    _match_fail("line 15950");
                  }
                  _t6500 = _t6503;
                  break _t6501;
                }
                _match_fail("line 15950");
              }
              _t6497 = _t6500;
              break _t6498;
            }
            if (_t6496._tag === 0 && _t6496._val === "int") {
              _t6497 = ({_tag: 0, _name: "TInt"});
              break _t6498;
            }
            if (_t6496._tag === 0 && _t6496._val === "float") {
              _t6497 = ({_tag: 1, _name: "TFloat"});
              break _t6498;
            }
            if (_t6496._tag === 0 && _t6496._val === "bool") {
              _t6497 = ({_tag: 2, _name: "TBool"});
              break _t6498;
            }
            if (_t6496._tag === 0 && _t6496._val === "string") {
              _t6497 = ({_tag: 3, _name: "TString"});
              break _t6498;
            }
            if (_t6496._tag === 0 && _t6496._val === "unit") {
              _t6497 = ({_tag: 6, _name: "TUnit"});
              break _t6498;
            }
            if (_t6496._tag === 0) {
              const name = _t6496._val;
              const canonical_6507 = Typechecker$resolve_type_alias(ctx.type_env, name);
              function _t6509(__p162) {
                let _t6511;
                const _t6510 = __p162;
                _t6512: {
                  if (true) {
                    const n = _t6510[0];
                    _t6511 = (n === canonical_6507);
                    break _t6512;
                  }
                  _match_fail("line 15950");
                }
                return _t6511;
              }
              let _t6514;
              const _t6513 = List$find(_t6509, ctx.type_env.type_synonyms);
              _t6515: {
                if (_t6513._tag === 1 && _t6513._val[1] === 0) {
                  const ty = _t6513._val[2];
                  _t6514 = ty;
                  break _t6515;
                }
                if (_t6513._tag === 1) {
                  const n = _t6513._val[1];
                  _t6514 = Typechecker$error((((("type " + __dict_Show_string.show(name)) + " expects ") + __dict_Show_int.show(n)) + " type argument(s)"));
                  break _t6515;
                }
                if (_t6513._tag === 0) {
                  let _t6517;
                  const _t6516 = Typechecker$find_variant_info(ctx.type_env, name);
                  _t6518: {
                    if (_t6516._tag === 1 && _t6516._val[1] === 0) {
                      _t6517 = ({_tag: 12, _name: "TVariant", _val: [canonical_6507, null]});
                      break _t6518;
                    }
                    if (_t6516._tag === 1) {
                      const n = _t6516._val[1];
                      _t6517 = Typechecker$error((((("type " + __dict_Show_string.show(name)) + " expects ") + __dict_Show_int.show(n)) + " type argument(s)"));
                      break _t6518;
                    }
                    if (_t6516._tag === 0) {
                      let _t6519;
                      if (!_eq(List$assoc_opt(canonical_6507, ctx.type_env.records), ({_tag: 0, _name: "None"}))) {
                        const fields_6520 = List$assoc(canonical_6507, ctx.type_env.records);
                        let _t6522;
                        if (_eq(fields_6520, null)) {
                          _t6522 = ({_tag: 11, _name: "TRecord", _val: ({_tag: 4, _name: "RWild"})});
                        } else {
                          _t6522 = ({_tag: 11, _name: "TRecord", _val: Types$fields_to_closed_row(fields_6520)});
                        }
                        const _t6521 = _t6522;
                        _t6519 = _t6521;
                      } else {
                        _t6519 = Typechecker$error(("unknown type: " + __dict_Show_string.show(name)));
                      }
                      _t6517 = _t6519;
                      break _t6518;
                    }
                    _match_fail("line 15950");
                  }
                  _t6514 = _t6517;
                  break _t6515;
                }
                _match_fail("line 15950");
              }
              const _t6508 = _t6514;
              _t6497 = _t6508;
              break _t6498;
            }
            if (_t6496._tag === 2) {
              const a = _t6496._val[0];
              const b = _t6496._val[1];
              _t6497 = ({_tag: 7, _name: "TArrow", _val: [resolve_alias(a), ({_tag: 1, _name: "EffEmpty"}), resolve_alias(b)]});
              break _t6498;
            }
            if (_t6496._tag === 6) {
              const ts = _t6496._val;
              _t6497 = ({_tag: 9, _name: "TTuple", _val: List$map(resolve_alias, ts)});
              break _t6498;
            }
            if (_t6496._tag === 4) {
              const t = _t6496._val;
              _t6497 = ({_tag: 10, _name: "TList", _val: resolve_alias(t)});
              break _t6498;
            }
            if (_t6496._tag === 5) {
              const t = _t6496._val;
              _t6497 = ({_tag: 14, _name: "TArray", _val: resolve_alias(t)});
              break _t6498;
            }
            if (_t6496._tag === 8) {
              const k = _t6496._val[0];
              const v = _t6496._val[1];
              _t6497 = ({_tag: 13, _name: "TMap", _val: [resolve_alias(k), resolve_alias(v)]});
              break _t6498;
            }
            if (_t6496._tag === 7) {
              const args = _t6496._val[0];
              const tname = _t6496._val[1];
              const canonical_6523 = Typechecker$resolve_type_alias(ctx.type_env, tname);
              const arg_tys_6525 = List$map(resolve_alias, args);
              function _t6527(__p163) {
                let _t6529;
                const _t6528 = __p163;
                _t6530: {
                  if (true) {
                    const n = _t6528[0];
                    _t6529 = (n === canonical_6523);
                    break _t6530;
                  }
                  _match_fail("line 15950");
                }
                return _t6529;
              }
              let _t6532;
              const _t6531 = List$find(_t6527, ctx.type_env.type_synonyms);
              _t6533: {
                if (_t6531._tag === 1) {
                  const np = _t6531._val[1];
                  const ty = _t6531._val[2];
                  let _t6534;
                  if ((List$length(arg_tys_6525) !== np)) {
                    _t6534 = Typechecker$error(((((("type " + __dict_Show_string.show(tname)) + " expects ") + __dict_Show_int.show(np)) + " type argument(s), got ") + __dict_Show_int.show(List$length(arg_tys_6525))));
                  } else {
                    _t6534 = undefined;
                  }
                  _t6534;
                  _t6532 = Typechecker$subst_tgens(arg_tys_6525, ty);
                  break _t6533;
                }
                if (_t6531._tag === 0) {
                  let _t6536;
                  const _t6535 = Typechecker$find_variant_info(ctx.type_env, tname);
                  _t6537: {
                    if (_t6535._tag === 1) {
                      const np = _t6535._val[1];
                      let _t6538;
                      if ((List$length(arg_tys_6525) !== np)) {
                        _t6538 = Typechecker$error(((((("type " + __dict_Show_string.show(tname)) + " expects ") + __dict_Show_int.show(np)) + " type argument(s), got ") + __dict_Show_int.show(List$length(arg_tys_6525))));
                      } else {
                        _t6538 = undefined;
                      }
                      _t6538;
                      _t6536 = ({_tag: 12, _name: "TVariant", _val: [canonical_6523, arg_tys_6525]});
                      break _t6537;
                    }
                    if (_t6535._tag === 0) {
                      _t6536 = Typechecker$error(("unknown type constructor: " + __dict_Show_string.show(tname)));
                      break _t6537;
                    }
                    _match_fail("line 15950");
                  }
                  _t6532 = _t6536;
                  break _t6533;
                }
                _match_fail("line 15950");
              }
              const _t6526 = _t6532;
              const _t6524 = _t6526;
              _t6497 = _t6524;
              break _t6498;
            }
            if (_t6496._tag === 3) {
              const fields = _t6496._val[0];
              const is_open = _t6496._val[1];
              function _t6539(__p164) {
                let _t6541;
                const _t6540 = __p164;
                _t6542: {
                  if (true) {
                    const n = _t6540[0];
                    const t = _t6540[1];
                    _t6541 = [n, resolve_alias(t)];
                    break _t6542;
                  }
                  _match_fail("line 15950");
                }
                return _t6541;
              }
              const fields_6543 = List$map(_t6539, fields);
              function _t6545(__p165, __p166) {
                let _t6547;
                const _t6546 = __p165;
                _t6548: {
                  if (true) {
                    const a = _t6546[0];
                    let _t6550;
                    const _t6549 = __p166;
                    _t6551: {
                      if (true) {
                        const b = _t6549[0];
                        _t6550 = String$compare(a, b);
                        break _t6551;
                      }
                      _match_fail("line 15950");
                    }
                    _t6547 = _t6550;
                    break _t6548;
                  }
                  _match_fail("line 15950");
                }
                return _t6547;
              }
              const fields_6552 = List$sort(_t6545, fields_6543);
              let _t6554;
              if (is_open) {
                _t6554 = Types$new_rvar(0);
              } else {
                _t6554 = ({_tag: 2, _name: "REmpty"});
              }
              const tail_6555 = _t6554;
              function _t6557(__p167, acc) {
                let _t6559;
                const _t6558 = __p167;
                _t6560: {
                  if (true) {
                    const n = _t6558[0];
                    const t = _t6558[1];
                    _t6559 = ({_tag: 0, _name: "RRow", _val: [n, t, acc]});
                    break _t6560;
                  }
                  _match_fail("line 15950");
                }
                return _t6559;
              }
              const _t6556 = ({_tag: 11, _name: "TRecord", _val: List$fold_right(_t6557, fields_6552, tail_6555)});
              const _t6553 = _t6556;
              const _t6544 = _t6553;
              _t6497 = _t6544;
              break _t6498;
            }
            if (_t6496._tag === 9) {
              const path = _t6496._val[0];
              const name = _t6496._val[1];
              const qualified_6561 = (String$concat(".", path) + ("." + name));
              const _t6563 = ({_tag: 0, _name: "TyName", _val: qualified_6561});
              __x = _t6563;
              continue;
              const _t6562 = undefined;
              _t6497 = _t6562;
              break _t6498;
            }
            if (_t6496._tag === 10) {
              const _kind = _t6496._val[0];
              const tags = _t6496._val[1];
              function _t6564(__p168, acc) {
                let _t6566;
                const _t6565 = __p168;
                _t6567: {
                  if (true) {
                    const tag = _t6565[0];
                    const payload_annot = _t6565[1];
                    _t6566 = ({_tag: 0, _name: "PVRow", _val: [tag, Option$map(resolve_alias, payload_annot), acc]});
                    break _t6567;
                  }
                  _match_fail("line 15950");
                }
                return _t6566;
              }
              const row_6568 = List$fold_right(_t6564, tags, ({_tag: 2, _name: "PVEmpty"}));
              const _t6569 = ({_tag: 15, _name: "TPolyVariant", _val: row_6568});
              _t6497 = _t6569;
              break _t6498;
            }
            if (_t6496._tag === 11) {
              const ty = _t6496._val[0];
              const _t6570 = ty;
              __x = _t6570;
              continue;
              _t6497 = undefined;
              break _t6498;
            }
            _match_fail("line 15950");
          }
          return _t6497;
        }
      }
      const resolved_ty_6572 = resolve_alias(annot);
      const __rec_upd_6574 = ctx.type_env;
      const _t6575 = ({classes: __rec_upd_6574.classes, constructors: __rec_upd_6574.constructors, effects: __rec_upd_6574.effects, instances: __rec_upd_6574.instances, modules: __rec_upd_6574.modules, mutable_fields: __rec_upd_6574.mutable_fields, records: __rec_upd_6574.records, type_aliases: __rec_upd_6574.type_aliases, type_synonyms: ({_hd: [type_name, num_params_6129, resolved_ty_6572], _tl: ctx.type_env.type_synonyms}), variants: __rec_upd_6574.variants});
      const type_env_6576 = _t6575;
      const __rec_upd_6578 = ctx;
      const _t6579 = ({constraint_tvars: __rec_upd_6578.constraint_tvars, current_eff: __rec_upd_6578.current_eff, current_module: __rec_upd_6578.current_module, inside_handler: __rec_upd_6578.inside_handler, loop_info: __rec_upd_6578.loop_info, mutable_vars: __rec_upd_6578.mutable_vars, return_type: __rec_upd_6578.return_type, return_used: __rec_upd_6578.return_used, type_env: type_env_6576, vars: __rec_upd_6578.vars});
      const _t6577 = _t6579;
      const _t6573 = _t6577;
      const _t6571 = _t6573;
      const _t6495 = _t6571;
      const _t6492 = _t6495;
      _t6132 = _t6492;
      break _t6133;
    }
    _match_fail("line 15950");
  }
  const _t6130 = _t6132;
  return _t6130;
}
function Typechecker$wrap_params_decl(params, ret_annot, body) {
  let _t6581;
  const _t6580 = ret_annot;
  _t6582: {
    if (_t6580._tag === 1 && _t6580._val._tag === 11) {
      const ret_ty = _t6580._val._val[0];
      const eff_annot = _t6580._val._val[1];
      if (!_eq(params, null)) {
        const body_6583 = ({_tag: 30, _name: "EAnnot", _val: [body, ret_ty]});
        function _t6585(param, body) {
          return ({_tag: 10, _name: "EFun", _val: [param, body]});
        }
        const full_fun_6586 = List$fold_right(_t6585, params, body_6583);
        function build_arrow(__x) {
          let _t6589;
          const _t6588 = __x;
          _t6590: {
            if (_t6588 === null) {
              _t6589 = ret_ty;
              break _t6590;
            }
            if (_t6588 !== null && _t6588._tl === null) {
              const p = _t6588._hd;
              let _t6592;
              const _t6591 = p.annot;
              _t6593: {
                if (_t6591._tag === 1) {
                  const t = _t6591._val;
                  _t6592 = t;
                  break _t6593;
                }
                if (_t6591._tag === 0) {
                  _t6592 = ({_tag: 1, _name: "TyVar", _val: ("'_eff_p_" + p.name)});
                  break _t6593;
                }
                _match_fail("line 15950");
              }
              const pty_6594 = _t6592;
              const _t6595 = ({_tag: 2, _name: "TyArrow", _val: [pty_6594, ret_ty, ({_tag: 1, _name: "Some", _val: eff_annot})]});
              _t6589 = _t6595;
              break _t6590;
            }
            if (_t6588 !== null) {
              const p = _t6588._hd;
              const rest = _t6588._tl;
              let _t6597;
              const _t6596 = p.annot;
              _t6598: {
                if (_t6596._tag === 1) {
                  const t = _t6596._val;
                  _t6597 = t;
                  break _t6598;
                }
                if (_t6596._tag === 0) {
                  _t6597 = ({_tag: 1, _name: "TyVar", _val: ("'_eff_p_" + p.name)});
                  break _t6598;
                }
                _match_fail("line 15950");
              }
              const pty_6599 = _t6597;
              const _t6600 = ({_tag: 2, _name: "TyArrow", _val: [pty_6599, build_arrow(rest), ({_tag: 0, _name: "None"})]});
              _t6589 = _t6600;
              break _t6590;
            }
            _match_fail("line 15950");
          }
          return _t6589;
        }
        const _t6601 = ({_tag: 30, _name: "EAnnot", _val: [full_fun_6586, build_arrow(params)]});
        const _t6587 = _t6601;
        const _t6584 = _t6587;
        _t6581 = _t6584;
        break _t6582;
      }
    }
    if (true) {
      let _t6603;
      const _t6602 = ret_annot;
      _t6604: {
        if (_t6602._tag === 1) {
          const ty = _t6602._val;
          _t6603 = ({_tag: 30, _name: "EAnnot", _val: [body, ty]});
          break _t6604;
        }
        if (_t6602._tag === 0) {
          _t6603 = body;
          break _t6604;
        }
        _match_fail("line 15950");
      }
      const body_6605 = _t6603;
      function _t6607(param, body) {
        return ({_tag: 10, _name: "EFun", _val: [param, body]});
      }
      const _t6606 = List$fold_right(_t6607, params, body_6605);
      _t6581 = _t6606;
      break _t6582;
    }
    _match_fail("line 15950");
  }
  return _t6581;
}
function Typechecker$process_class_def(ctx, class_name, tyvar_names, fundep_annots, methods) {
  function _t6608(c) {
    return (c.class_name === class_name);
  }
  let _t6609;
  if (List$exists(_t6608, ctx.type_env.classes)) {
    _t6609 = Typechecker$error(("duplicate class definition: " + __dict_Show_string.show(class_name)));
  } else {
    _t6609 = undefined;
  }
  _t6609;
  const num_class_params_6610 = List$length(tyvar_names);
  function _t6612(__p169) {
    let _t6614;
    const _t6613 = __p169;
    _t6615: {
      if (true) {
        const mname = _t6613[0];
        const annot = _t6613[1];
        const tvars_6616 = Hashtbl$create(4);
        function _t6618(i, name) {
          return _call(Hashtbl$set, [__dict_Hash_string, __dict_Eq_string, tvars_6616, name, ({_tag: 17, _name: "TGen", _val: i})]);
        }
        List$iteri(_t6618, tyvar_names);
        const next_gen_6619 = Ref$create(num_class_params_6610);
        const eff_tvars_6621 = Hashtbl$create(2);
        const next_effgen_6623 = Ref$create(0);
        function _t6625(__dict_Hash_0, __dict_Eq_0, name) {
          let _t6627;
          const _t6626 = _call(Hashtbl$get, [__dict_Hash_0, __dict_Eq_0, eff_tvars_6621, name]);
          _t6628: {
            if (_t6626._tag === 1) {
              const eg = _t6626._val;
              _t6627 = eg;
              break _t6628;
            }
            if (_t6626._tag === 0) {
              const idx_6629 = Ref$get(next_effgen_6623);
              Ref$set(next_effgen_6623, (idx_6629 + 1));
              const eg_6631 = ({_tag: 3, _name: "EffGen", _val: idx_6629});
              _call(Hashtbl$set, [__dict_Hash_0, __dict_Eq_0, eff_tvars_6621, name, eg_6631]);
              const _t6632 = eg_6631;
              const _t6630 = _t6632;
              _t6627 = _t6630;
              break _t6628;
            }
            _match_fail("line 15950");
          }
          return _t6627;
        }
        const resolve_eff_var_6633 = _t6625;
        function resolve(__x) {
          while (true) {
            let _t6636;
            const _t6635 = __x;
            _t6637: {
              if (_t6635._tag === 1) {
                const name = _t6635._val;
                let _t6639;
                const _t6638 = _call(Hashtbl$get, [__dict_Hash_string, __dict_Eq_string, tvars_6616, name]);
                _t6640: {
                  if (_t6638._tag === 1) {
                    const tv = _t6638._val;
                    _t6639 = tv;
                    break _t6640;
                  }
                  if (_t6638._tag === 0) {
                    const idx_6641 = Ref$get(next_gen_6619);
                    Ref$set(next_gen_6619, (idx_6641 + 1));
                    _call(Hashtbl$set, [__dict_Hash_string, __dict_Eq_string, tvars_6616, name, ({_tag: 17, _name: "TGen", _val: idx_6641})]);
                    const _t6642 = ({_tag: 17, _name: "TGen", _val: idx_6641});
                    _t6639 = _t6642;
                    break _t6640;
                  }
                  _match_fail("line 15950");
                }
                _t6636 = _t6639;
                break _t6637;
              }
              if (_t6635._tag === 0 && _t6635._val === "int") {
                _t6636 = ({_tag: 0, _name: "TInt"});
                break _t6637;
              }
              if (_t6635._tag === 0 && _t6635._val === "float") {
                _t6636 = ({_tag: 1, _name: "TFloat"});
                break _t6637;
              }
              if (_t6635._tag === 0 && _t6635._val === "bool") {
                _t6636 = ({_tag: 2, _name: "TBool"});
                break _t6637;
              }
              if (_t6635._tag === 0 && _t6635._val === "string") {
                _t6636 = ({_tag: 3, _name: "TString"});
                break _t6637;
              }
              if (_t6635._tag === 0 && _t6635._val === "unit") {
                _t6636 = ({_tag: 6, _name: "TUnit"});
                break _t6637;
              }
              if (_t6635._tag === 0) {
                const name = _t6635._val;
                const canonical_6643 = Typechecker$resolve_type_alias(ctx.type_env, name);
                let _t6646;
                const _t6645 = Typechecker$find_variant_info(ctx.type_env, name);
                _t6647: {
                  if (_t6645._tag === 1 && _t6645._val[1] === 0) {
                    _t6646 = ({_tag: 12, _name: "TVariant", _val: [canonical_6643, null]});
                    break _t6647;
                  }
                  if (_t6645._tag === 1) {
                    const n = _t6645._val[1];
                    _t6646 = Typechecker$error((((("type " + __dict_Show_string.show(name)) + " expects ") + __dict_Show_int.show(n)) + " type argument(s)"));
                    break _t6647;
                  }
                  if (_t6645._tag === 0) {
                    _t6646 = Typechecker$error(("unknown type: " + __dict_Show_string.show(name)));
                    break _t6647;
                  }
                  _match_fail("line 15950");
                }
                const _t6644 = _t6646;
                _t6636 = _t6644;
                break _t6637;
              }
              if (_t6635._tag === 2) {
                const a = _t6635._val[0];
                const b = _t6635._val[1];
                const eff_opt = _t6635._val[2];
                let _t6649;
                const _t6648 = eff_opt;
                _t6650: {
                  if (_t6648._tag === 0) {
                    _t6649 = ({_tag: 1, _name: "EffEmpty"});
                    break _t6650;
                  }
                  if (_t6648._tag === 1 && _t6648._val._tag === 0) {
                    _t6649 = ({_tag: 1, _name: "EffEmpty"});
                    break _t6650;
                  }
                  if (_t6648._tag === 1 && _t6648._val._tag === 1) {
                    const items = _t6648._val._val;
                    _t6649 = resolve_class_eff_items(items);
                    break _t6650;
                  }
                  _match_fail("line 15950");
                }
                const eff_6651 = _t6649;
                const _t6652 = ({_tag: 7, _name: "TArrow", _val: [resolve(a), eff_6651, resolve(b)]});
                _t6636 = _t6652;
                break _t6637;
              }
              if (_t6635._tag === 6) {
                const ts = _t6635._val;
                _t6636 = ({_tag: 9, _name: "TTuple", _val: List$map(resolve, ts)});
                break _t6637;
              }
              if (_t6635._tag === 4) {
                const t = _t6635._val;
                _t6636 = ({_tag: 10, _name: "TList", _val: resolve(t)});
                break _t6637;
              }
              if (_t6635._tag === 5) {
                const t = _t6635._val;
                _t6636 = ({_tag: 14, _name: "TArray", _val: resolve(t)});
                break _t6637;
              }
              if (_t6635._tag === 8) {
                const k = _t6635._val[0];
                const v = _t6635._val[1];
                _t6636 = ({_tag: 13, _name: "TMap", _val: [resolve(k), resolve(v)]});
                break _t6637;
              }
              if (_t6635._tag === 7) {
                const args = _t6635._val[0];
                const name = _t6635._val[1];
                const canonical_6653 = Typechecker$resolve_type_alias(ctx.type_env, name);
                const arg_tys_6655 = List$map(resolve, args);
                let _t6658;
                const _t6657 = Typechecker$find_variant_info(ctx.type_env, name);
                _t6659: {
                  if (_t6657._tag === 1) {
                    const np = _t6657._val[1];
                    let _t6660;
                    if ((List$length(arg_tys_6655) !== np)) {
                      _t6660 = Typechecker$error(((((("type " + __dict_Show_string.show(name)) + " expects ") + __dict_Show_int.show(np)) + " type argument(s), got ") + __dict_Show_int.show(List$length(arg_tys_6655))));
                    } else {
                      _t6660 = undefined;
                    }
                    _t6660;
                    _t6658 = ({_tag: 12, _name: "TVariant", _val: [canonical_6653, arg_tys_6655]});
                    break _t6659;
                  }
                  if (_t6657._tag === 0) {
                    _t6658 = Typechecker$error(("unknown type constructor: " + __dict_Show_string.show(name)));
                    break _t6659;
                  }
                  _match_fail("line 15950");
                }
                const _t6656 = _t6658;
                const _t6654 = _t6656;
                _t6636 = _t6654;
                break _t6637;
              }
              if (_t6635._tag === 3) {
                const fields = _t6635._val[0];
                const is_open = _t6635._val[1];
                function _t6661(__p170, __p171) {
                  let _t6663;
                  const _t6662 = __p170;
                  _t6664: {
                    if (true) {
                      const a = _t6662[0];
                      let _t6666;
                      const _t6665 = __p171;
                      _t6667: {
                        if (true) {
                          const b = _t6665[0];
                          _t6666 = String$compare(a, b);
                          break _t6667;
                        }
                        _match_fail("line 15950");
                      }
                      _t6663 = _t6666;
                      break _t6664;
                    }
                    _match_fail("line 15950");
                  }
                  return _t6663;
                }
                function _t6668(__p172) {
                  let _t6670;
                  const _t6669 = __p172;
                  _t6671: {
                    if (true) {
                      const n = _t6669[0];
                      const t = _t6669[1];
                      _t6670 = [n, resolve(t)];
                      break _t6671;
                    }
                    _match_fail("line 15950");
                  }
                  return _t6670;
                }
                const fields_6672 = List$sort(_t6661, List$map(_t6668, fields));
                let _t6674;
                if (is_open) {
                  _t6674 = Types$new_rvar(0);
                } else {
                  _t6674 = ({_tag: 2, _name: "REmpty"});
                }
                const tail_6675 = _t6674;
                function _t6677(__p173, acc) {
                  let _t6679;
                  const _t6678 = __p173;
                  _t6680: {
                    if (true) {
                      const n = _t6678[0];
                      const t = _t6678[1];
                      _t6679 = ({_tag: 0, _name: "RRow", _val: [n, t, acc]});
                      break _t6680;
                    }
                    _match_fail("line 15950");
                  }
                  return _t6679;
                }
                const _t6676 = ({_tag: 11, _name: "TRecord", _val: List$fold_right(_t6677, fields_6672, tail_6675)});
                const _t6673 = _t6676;
                _t6636 = _t6673;
                break _t6637;
              }
              if (_t6635._tag === 9) {
                const path = _t6635._val[0];
                const name = _t6635._val[1];
                const qualified_6681 = (String$concat(".", path) + ("." + name));
                const _t6683 = ({_tag: 0, _name: "TyName", _val: qualified_6681});
                __x = _t6683;
                continue;
                const _t6682 = undefined;
                _t6636 = _t6682;
                break _t6637;
              }
              if (_t6635._tag === 10) {
                const _kind = _t6635._val[0];
                const tags = _t6635._val[1];
                function _t6684(__p174, acc) {
                  let _t6686;
                  const _t6685 = __p174;
                  _t6687: {
                    if (true) {
                      const tag = _t6685[0];
                      const payload_annot = _t6685[1];
                      _t6686 = ({_tag: 0, _name: "PVRow", _val: [tag, Option$map(resolve, payload_annot), acc]});
                      break _t6687;
                    }
                    _match_fail("line 15950");
                  }
                  return _t6686;
                }
                const row_6688 = List$fold_right(_t6684, tags, ({_tag: 2, _name: "PVEmpty"}));
                const _t6689 = ({_tag: 15, _name: "TPolyVariant", _val: row_6688});
                _t6636 = _t6689;
                break _t6637;
              }
              if (_t6635._tag === 11) {
                const ty = _t6635._val[0];
                const _t6690 = ty;
                __x = _t6690;
                continue;
                _t6636 = undefined;
                break _t6637;
              }
              _match_fail("line 15950");
            }
            return _t6636;
          }
        }
        function resolve_class_eff_items(items) {
          const labels_6691 = Ref$create(null);
          const tail_6693 = Ref$create(({_tag: 1, _name: "EffEmpty"}));
          function _t6695(item) {
            let _t6697;
            const _t6696 = item;
            _t6698: {
              if (_t6696._tag === 0) {
                const name = _t6696._val[0];
                const param_annots = _t6696._val[1];
                const resolved_params_6699 = List$map(resolve, param_annots);
                const _t6700 = Ref$set(labels_6691, ({_hd: [name, resolved_params_6699], _tl: Ref$get(labels_6691)}));
                _t6697 = _t6700;
                break _t6698;
              }
              if (_t6696._tag === 1) {
                const name = _t6696._val;
                _t6697 = Ref$set(tail_6693, _call(resolve_eff_var_6633, [__dict_Hash_string, __dict_Eq_string, name]));
                break _t6698;
              }
              _match_fail("line 15950");
            }
            return _t6697;
          }
          List$iter(_t6695, items);
          function _t6701(__p175, acc) {
            let _t6703;
            const _t6702 = __p175;
            _t6704: {
              if (true) {
                const name = _t6702[0];
                const params = _t6702[1];
                _t6703 = ({_tag: 2, _name: "EffRow", _val: [name, params, acc]});
                break _t6704;
              }
              _match_fail("line 15950");
            }
            return _t6703;
          }
          const _t6694 = List$fold_right(_t6701, List$rev(Ref$get(labels_6691)), Ref$get(tail_6693));
          const _t6692 = _t6694;
          return _t6692;
        }
        const ty_6706 = resolve(annot);
        const method_quant_6708 = Ref$get(next_gen_6619);
        const method_equant_6710 = Ref$get(next_effgen_6623);
        const _t6711 = [mname, ty_6706, method_quant_6708, method_equant_6710];
        const _t6709 = _t6711;
        const _t6707 = _t6709;
        const _t6705 = _t6707;
        const _t6634 = _t6705;
        const _t6624 = _t6634;
        const _t6622 = _t6624;
        const _t6620 = _t6622;
        const _t6617 = _t6620;
        _t6614 = _t6617;
        break _t6615;
      }
      _match_fail("line 15950");
    }
    return _t6614;
  }
  const method_tys_6712 = List$map(_t6612, methods);
  function _t6714(__p176) {
    let _t6716;
    const _t6715 = __p176;
    _t6717: {
      if (true) {
        const from_names = _t6715[0];
        const to_names = _t6715[1];
        function _t6718(name) {
          function _t6719(n) {
            return (n === name);
          }
          let _t6721;
          const _t6720 = List$find_index(_t6719, tyvar_names);
          _t6722: {
            if (_t6720._tag === 1) {
              const i = _t6720._val;
              _t6721 = i;
              break _t6722;
            }
            if (_t6720._tag === 0) {
              _t6721 = Typechecker$error((("functional dependency type variable '" + __dict_Show_string.show(name)) + " not in class parameters"));
              break _t6722;
            }
            _match_fail("line 15950");
          }
          return _t6721;
        }
        const resolve_idx_6723 = _t6718;
        const _t6724 = ({fd_from: List$map(resolve_idx_6723, from_names), fd_to: List$map(resolve_idx_6723, to_names)});
        _t6716 = _t6724;
        break _t6717;
      }
      _match_fail("line 15950");
    }
    return _t6716;
  }
  const class_fundeps_6725 = List$map(_t6714, fundep_annots);
  function _t6727(__p177) {
    let _t6729;
    const _t6728 = __p177;
    _t6730: {
      if (true) {
        const m = _t6728[0];
        const t = _t6728[1];
        _t6729 = [m, t];
        break _t6730;
      }
      _match_fail("line 15950");
    }
    return _t6729;
  }
  const class_def_6731 = ({class_fundeps: class_fundeps_6725, class_methods: List$map(_t6727, method_tys_6712), class_name: class_name, class_params: tyvar_names});
  function _t6733(ctx, __p178) {
    let _t6735;
    const _t6734 = __p178;
    _t6736: {
      if (true) {
        const mname = _t6734[0];
        const mty = _t6734[1];
        const mquant = _t6734[2];
        const mequant = _t6734[3];
        const scheme_6737 = ({body: mty, constraints: null, equant: mequant, pvquant: 0, quant: mquant, record_evidences: null, rquant: 0});
        const _t6738 = Typechecker$extend_var(ctx, mname, scheme_6737);
        _t6735 = _t6738;
        break _t6736;
      }
      _match_fail("line 15950");
    }
    return _t6735;
  }
  const ctx_6739 = List$fold(_t6733, ctx, method_tys_6712);
  const __rec_upd_6741 = ctx_6739.type_env;
  const _t6742 = ({classes: ({_hd: class_def_6731, _tl: ctx_6739.type_env.classes}), constructors: __rec_upd_6741.constructors, effects: __rec_upd_6741.effects, instances: __rec_upd_6741.instances, modules: __rec_upd_6741.modules, mutable_fields: __rec_upd_6741.mutable_fields, records: __rec_upd_6741.records, type_aliases: __rec_upd_6741.type_aliases, type_synonyms: __rec_upd_6741.type_synonyms, variants: __rec_upd_6741.variants});
  const type_env_6743 = _t6742;
  const __rec_upd_6745 = ctx_6739;
  const _t6746 = ({constraint_tvars: __rec_upd_6745.constraint_tvars, current_eff: __rec_upd_6745.current_eff, current_module: __rec_upd_6745.current_module, inside_handler: __rec_upd_6745.inside_handler, loop_info: __rec_upd_6745.loop_info, mutable_vars: __rec_upd_6745.mutable_vars, return_type: __rec_upd_6745.return_type, return_used: __rec_upd_6745.return_used, type_env: type_env_6743, vars: __rec_upd_6745.vars});
  const ctx_6747 = _t6746;
  const _t6748 = [ctx_6747, ({_tag: 6, _name: "TDClass", _val: class_name})];
  const _t6744 = _t6748;
  const _t6740 = _t6744;
  const _t6732 = _t6740;
  const _t6726 = _t6732;
  const _t6713 = _t6726;
  const _t6611 = _t6713;
  return _t6611;
}
function Typechecker$resolve_inst_tys(ctx, annots) {
  const tvars_6749 = Hashtbl$create(4);
  const next_idx_6751 = Ref$create(0);
  function go(__x) {
    while (true) {
      let _t6754;
      const _t6753 = __x;
      _t6755: {
        if (_t6753._tag === 1) {
          const name = _t6753._val;
          let _t6757;
          const _t6756 = _call(Hashtbl$get, [__dict_Hash_string, __dict_Eq_string, tvars_6749, name]);
          _t6758: {
            if (_t6756._tag === 1) {
              const idx = _t6756._val;
              _t6757 = ({_tag: 17, _name: "TGen", _val: idx});
              break _t6758;
            }
            if (_t6756._tag === 0) {
              const idx_6759 = Ref$get(next_idx_6751);
              Ref$set(next_idx_6751, (idx_6759 + 1));
              _call(Hashtbl$set, [__dict_Hash_string, __dict_Eq_string, tvars_6749, name, idx_6759]);
              const _t6760 = ({_tag: 17, _name: "TGen", _val: idx_6759});
              _t6757 = _t6760;
              break _t6758;
            }
            _match_fail("line 15950");
          }
          _t6754 = _t6757;
          break _t6755;
        }
        if (_t6753._tag === 0 && _t6753._val === "int") {
          _t6754 = ({_tag: 0, _name: "TInt"});
          break _t6755;
        }
        if (_t6753._tag === 0 && _t6753._val === "float") {
          _t6754 = ({_tag: 1, _name: "TFloat"});
          break _t6755;
        }
        if (_t6753._tag === 0 && _t6753._val === "bool") {
          _t6754 = ({_tag: 2, _name: "TBool"});
          break _t6755;
        }
        if (_t6753._tag === 0 && _t6753._val === "string") {
          _t6754 = ({_tag: 3, _name: "TString"});
          break _t6755;
        }
        if (_t6753._tag === 0 && _t6753._val === "byte") {
          _t6754 = ({_tag: 4, _name: "TByte"});
          break _t6755;
        }
        if (_t6753._tag === 0 && _t6753._val === "rune") {
          _t6754 = ({_tag: 5, _name: "TRune"});
          break _t6755;
        }
        if (_t6753._tag === 0 && _t6753._val === "unit") {
          _t6754 = ({_tag: 6, _name: "TUnit"});
          break _t6755;
        }
        if (_t6753._tag === 0) {
          const name = _t6753._val;
          const canonical_6761 = Typechecker$resolve_type_alias(ctx.type_env, name);
          let _t6764;
          const _t6763 = Typechecker$find_variant_info(ctx.type_env, name);
          _t6765: {
            if (_t6763._tag === 1 && _t6763._val[1] === 0) {
              _t6764 = ({_tag: 12, _name: "TVariant", _val: [canonical_6761, null]});
              break _t6765;
            }
            if (_t6763._tag === 1) {
              const n = _t6763._val[1];
              _t6764 = Typechecker$error((((("type " + __dict_Show_string.show(name)) + " expects ") + __dict_Show_int.show(n)) + " type argument(s)"));
              break _t6765;
            }
            if (_t6763._tag === 0) {
              let _t6766;
              if (!_eq(List$assoc_opt(name, ctx.type_env.records), ({_tag: 0, _name: "None"}))) {
                const fields_6767 = List$assoc(name, ctx.type_env.records);
                let _t6769;
                if (_eq(fields_6767, null)) {
                  _t6769 = ({_tag: 11, _name: "TRecord", _val: ({_tag: 4, _name: "RWild"})});
                } else {
                  _t6769 = ({_tag: 11, _name: "TRecord", _val: Types$fields_to_closed_row(fields_6767)});
                }
                const _t6768 = _t6769;
                _t6766 = _t6768;
              } else {
                _t6766 = Typechecker$error(("unknown type: " + __dict_Show_string.show(name)));
              }
              _t6764 = _t6766;
              break _t6765;
            }
            _match_fail("line 15950");
          }
          const _t6762 = _t6764;
          _t6754 = _t6762;
          break _t6755;
        }
        if (_t6753._tag === 2) {
          const a = _t6753._val[0];
          const b = _t6753._val[1];
          _t6754 = ({_tag: 7, _name: "TArrow", _val: [go(a), ({_tag: 1, _name: "EffEmpty"}), go(b)]});
          break _t6755;
        }
        if (_t6753._tag === 6) {
          const ts = _t6753._val;
          _t6754 = ({_tag: 9, _name: "TTuple", _val: List$map(go, ts)});
          break _t6755;
        }
        if (_t6753._tag === 4) {
          const t = _t6753._val;
          _t6754 = ({_tag: 10, _name: "TList", _val: go(t)});
          break _t6755;
        }
        if (_t6753._tag === 5) {
          const t = _t6753._val;
          _t6754 = ({_tag: 14, _name: "TArray", _val: go(t)});
          break _t6755;
        }
        if (_t6753._tag === 8) {
          const k = _t6753._val[0];
          const v = _t6753._val[1];
          _t6754 = ({_tag: 13, _name: "TMap", _val: [go(k), go(v)]});
          break _t6755;
        }
        if (_t6753._tag === 7) {
          const args = _t6753._val[0];
          const name = _t6753._val[1];
          const canonical_6770 = Typechecker$resolve_type_alias(ctx.type_env, name);
          const arg_tys_6772 = List$map(go, args);
          let _t6775;
          const _t6774 = Typechecker$find_variant_info(ctx.type_env, name);
          _t6776: {
            if (_t6774._tag === 1) {
              const np = _t6774._val[1];
              let _t6777;
              if ((List$length(arg_tys_6772) !== np)) {
                _t6777 = Typechecker$error(((((("type " + __dict_Show_string.show(name)) + " expects ") + __dict_Show_int.show(np)) + " type argument(s), got ") + __dict_Show_int.show(List$length(arg_tys_6772))));
              } else {
                _t6777 = undefined;
              }
              _t6777;
              _t6775 = ({_tag: 12, _name: "TVariant", _val: [canonical_6770, arg_tys_6772]});
              break _t6776;
            }
            if (_t6774._tag === 0) {
              _t6775 = Typechecker$error(("unknown type constructor: " + __dict_Show_string.show(name)));
              break _t6776;
            }
            _match_fail("line 15950");
          }
          const _t6773 = _t6775;
          const _t6771 = _t6773;
          _t6754 = _t6771;
          break _t6755;
        }
        if (_t6753._tag === 3) {
          const fields = _t6753._val[0];
          const is_open = _t6753._val[1];
          function _t6778(__p179) {
            let _t6780;
            const _t6779 = __p179;
            _t6781: {
              if (true) {
                const n = _t6779[0];
                const t = _t6779[1];
                _t6780 = [n, go(t)];
                break _t6781;
              }
              _match_fail("line 15950");
            }
            return _t6780;
          }
          const fields_6782 = List$map(_t6778, fields);
          function _t6784(__p180, __p181) {
            let _t6786;
            const _t6785 = __p180;
            _t6787: {
              if (true) {
                const a = _t6785[0];
                let _t6789;
                const _t6788 = __p181;
                _t6790: {
                  if (true) {
                    const b = _t6788[0];
                    _t6789 = String$compare(a, b);
                    break _t6790;
                  }
                  _match_fail("line 15950");
                }
                _t6786 = _t6789;
                break _t6787;
              }
              _match_fail("line 15950");
            }
            return _t6786;
          }
          const fields_6791 = List$sort(_t6784, fields_6782);
          let _t6793;
          if (is_open) {
            _t6793 = Types$new_rvar(0);
          } else {
            _t6793 = ({_tag: 2, _name: "REmpty"});
          }
          const tail_6794 = _t6793;
          function _t6796(__p182, acc) {
            let _t6798;
            const _t6797 = __p182;
            _t6799: {
              if (true) {
                const n = _t6797[0];
                const t = _t6797[1];
                _t6798 = ({_tag: 0, _name: "RRow", _val: [n, t, acc]});
                break _t6799;
              }
              _match_fail("line 15950");
            }
            return _t6798;
          }
          const _t6795 = ({_tag: 11, _name: "TRecord", _val: List$fold_right(_t6796, fields_6791, tail_6794)});
          const _t6792 = _t6795;
          const _t6783 = _t6792;
          _t6754 = _t6783;
          break _t6755;
        }
        if (_t6753._tag === 9) {
          const path = _t6753._val[0];
          const name = _t6753._val[1];
          const qualified_6800 = (String$concat(".", path) + ("." + name));
          const _t6802 = ({_tag: 0, _name: "TyName", _val: qualified_6800});
          __x = _t6802;
          continue;
          const _t6801 = undefined;
          _t6754 = _t6801;
          break _t6755;
        }
        if (_t6753._tag === 10) {
          const _kind = _t6753._val[0];
          const tags = _t6753._val[1];
          function _t6803(__p183, acc) {
            let _t6805;
            const _t6804 = __p183;
            _t6806: {
              if (true) {
                const tag = _t6804[0];
                const payload_annot = _t6804[1];
                _t6805 = ({_tag: 0, _name: "PVRow", _val: [tag, Option$map(go, payload_annot), acc]});
                break _t6806;
              }
              _match_fail("line 15950");
            }
            return _t6805;
          }
          const row_6807 = List$fold_right(_t6803, tags, ({_tag: 2, _name: "PVEmpty"}));
          const _t6808 = ({_tag: 15, _name: "TPolyVariant", _val: row_6807});
          _t6754 = _t6808;
          break _t6755;
        }
        if (_t6753._tag === 11) {
          const ty = _t6753._val[0];
          const _t6809 = ty;
          __x = _t6809;
          continue;
          _t6754 = undefined;
          break _t6755;
        }
        _match_fail("line 15950");
      }
      return _t6754;
    }
  }
  const tys_6811 = List$map(go, annots);
  const _t6812 = [tys_6811, Ref$get(next_idx_6751), tvars_6749];
  const _t6810 = _t6812;
  const _t6752 = _t6810;
  const _t6750 = _t6752;
  return _t6750;
}
function Typechecker$process_instance_def(ctx, level, class_name, inst_ty_annots, constraints, methods) {
  const class_name_6813 = Typechecker$resolve_type_alias(ctx.type_env, class_name);
  function _t6815(c) {
    return (c.class_name === class_name_6813);
  }
  let _t6817;
  const _t6816 = List$find(_t6815, ctx.type_env.classes);
  _t6818: {
    if (_t6816._tag === 1) {
      const c = _t6816._val;
      _t6817 = c;
      break _t6818;
    }
    if (_t6816._tag === 0) {
      _t6817 = Typechecker$error(("unknown class: " + __dict_Show_string.show(class_name_6813)));
      break _t6818;
    }
    _match_fail("line 15950");
  }
  const class_def_6819 = _t6817;
  const num_class_params_6821 = List$length(class_def_6819.class_params);
  let _t6824;
  const _t6823 = Typechecker$resolve_inst_tys(ctx, inst_ty_annots);
  _t6825: {
    if (true) {
      const stored_tys = _t6823[0];
      const num_inst_vars = _t6823[1];
      const inst_tvars = _t6823[2];
      let _t6826;
      if ((List$length(stored_tys) !== num_class_params_6821)) {
        _t6826 = Typechecker$error(((((("class " + __dict_Show_string.show(class_name_6813)) + " expects ") + __dict_Show_int.show(num_class_params_6821)) + " type parameters, got ") + __dict_Show_int.show(List$length(stored_tys))));
      } else {
        _t6826 = undefined;
      }
      _t6826;
      const dname_6827 = _call(Types$dict_name, [__dict_Show_string, class_name_6813, stored_tys]);
      function _t6829(_) {
        return Types$new_tvar((level + 1));
      }
      const check_tvar_list_6830 = List$init(num_inst_vars, _t6829);
      function _t6832(t) {
        return Typechecker$subst_tgens(check_tvar_list_6830, t);
      }
      const check_tys_6833 = List$map(_t6832, stored_tys);
      function _t6835(i) {
        let _t6838;
        if ((i.inst_class === class_name_6813)) {
        let _t6837;
        if ((List$length(i.inst_tys) === List$length(stored_tys))) {
        function _t6836(t) {
          return ({_tag: 1, _name: "Some", _val: t});
        }
          _t6837 = Types$match_partial_inst(i.inst_tys, List$map(_t6836, stored_tys));
        } else {
          _t6837 = false;
        }
          _t6838 = _t6837;
        } else {
          _t6838 = false;
        }
        return _t6838;
      }
      let _t6839;
      if (List$exists(_t6835, ctx.type_env.instances)) {
        _t6839 = Typechecker$error(((("duplicate instance " + __dict_Show_string.show(class_name_6813)) + " for types ") + __dict_Show_string.show(String$concat(", ", List$map(Types$pp_ty, stored_tys)))));
      } else {
        _t6839 = undefined;
      }
      _t6839;
      function _t6840(__p184) {
        let _t6842;
        const _t6841 = __p184;
        _t6843: {
          if (true) {
            const mname = _t6841[0];
            function _t6844(__p185) {
              let _t6846;
              const _t6845 = __p185;
              _t6847: {
                if (true) {
                  const n = _t6845[0];
                  _t6846 = (n === mname);
                  break _t6847;
                }
                _match_fail("line 15950");
              }
              return _t6846;
            }
            let _t6848;
            if ((!List$exists(_t6844, methods))) {
              _t6848 = Typechecker$error(((((("instance " + __dict_Show_string.show(class_name_6813)) + " ") + __dict_Show_string.show(String$concat(" ", List$map(Types$pp_ty, stored_tys)))) + " missing method: ") + __dict_Show_string.show(mname)));
            } else {
              _t6848 = undefined;
            }
            _t6842 = _t6848;
            break _t6843;
          }
          _match_fail("line 15950");
        }
        return _t6842;
      }
      List$iter(_t6840, class_def_6819.class_methods);
      function _t6849(__p186) {
        let _t6851;
        const _t6850 = __p186;
        _t6852: {
          if (true) {
            const mname = _t6850[0];
            const params = _t6850[1];
            const body = _t6850[2];
            let _t6854;
            const _t6853 = List$assoc_opt(mname, class_def_6819.class_methods);
            _t6855: {
              if (_t6853._tag === 1) {
                const ty = _t6853._val;
                _t6854 = ty;
                break _t6855;
              }
              if (_t6853._tag === 0) {
                _t6854 = Typechecker$error(((__dict_Show_string.show(mname) + " is not a method of class ") + __dict_Show_string.show(class_name_6813)));
                break _t6855;
              }
              _match_fail("line 15950");
            }
            const method_schema_ty_6856 = _t6854;
            const concrete_method_ty_6858 = Typechecker$subst_tgens(check_tys_6833, method_schema_ty_6856);
            const max_tgen_6860 = Typechecker$max_tgen_in_ty(concrete_method_ty_6858);
            const max_effgen_6862 = Typechecker$max_effgen_in_ty(concrete_method_ty_6858);
            let _t6864;
            if ((max_tgen_6860 >= 0)) {
              _t6864 = (max_tgen_6860 + 1);
            } else {
              _t6864 = 0;
            }
            const quant_6865 = _t6864;
            let _t6867;
            if ((max_effgen_6862 >= 0)) {
              _t6867 = (max_effgen_6862 + 1);
            } else {
              _t6867 = 0;
            }
            const equant_6868 = _t6867;
            let _t6870;
            if (((quant_6865 > 0) || (equant_6868 > 0))) {
              _t6870 = Types$instantiate((level + 1), ({body: concrete_method_ty_6858, constraints: null, equant: equant_6868, pvquant: 0, quant: quant_6865, record_evidences: null, rquant: 0}));
            } else {
              _t6870 = concrete_method_ty_6858;
            }
            const concrete_method_ty_6871 = _t6870;
            const full_body_6873 = Typechecker$wrap_params_decl(params, ({_tag: 0, _name: "None"}), body);
            const te_6875 = Typechecker$check(ctx, (level + 1), full_body_6873, concrete_method_ty_6871);
            const _t6876 = [mname, te_6875];
            const _t6874 = _t6876;
            const _t6872 = _t6874;
            const _t6869 = _t6872;
            const _t6866 = _t6869;
            const _t6863 = _t6866;
            const _t6861 = _t6863;
            const _t6859 = _t6861;
            const _t6857 = _t6859;
            _t6851 = _t6857;
            break _t6852;
          }
          _match_fail("line 15950");
        }
        return _t6851;
      }
      const typed_methods_6877 = List$map(_t6849, methods);
      function _t6879(__p187, __p188) {
        let _t6881;
        const _t6880 = __p187;
        _t6882: {
          if (true) {
            const a = _t6880[0];
            let _t6884;
            const _t6883 = __p188;
            _t6885: {
              if (true) {
                const b = _t6883[0];
                _t6884 = String$compare(a, b);
                break _t6885;
              }
              _match_fail("line 15950");
            }
            _t6881 = _t6884;
            break _t6882;
          }
          _match_fail("line 15950");
        }
        return _t6881;
      }
      const sorted_methods_6886 = List$sort(_t6879, typed_methods_6877);
      function _t6888(__p189) {
        let _t6890;
        const _t6889 = __p189;
        _t6891: {
          if (true) {
            const n = _t6889[0];
            const te = _t6889[1];
            _t6890 = [n, te.ty];
            break _t6891;
          }
          _match_fail("line 15950");
        }
        return _t6890;
      }
      const record_ty_6892 = ({_tag: 11, _name: "TRecord", _val: Types$fields_to_closed_row(List$map(_t6888, sorted_methods_6886))});
      const dict_expr_6894 = Typechecker$mk(({_tag: 16, _name: "TERecord", _val: sorted_methods_6886}), record_ty_6892);
      function _t6896(__p190) {
        let _t6898;
        const _t6897 = __p190;
        _t6899: {
          if (true) {
            const cclass = _t6897[0];
            const tyvar_names = _t6897[1];
            const cclass_6900 = Typechecker$resolve_type_alias(ctx.type_env, cclass);
            function _t6902(tvname) {
              let _t6904;
              const _t6903 = _call(Hashtbl$get, [__dict_Hash_string, __dict_Eq_string, inst_tvars, tvname]);
              _t6905: {
                if (_t6903._tag === 1) {
                  const idx = _t6903._val;
                  _t6904 = ({_tag: 0, _name: "CATGen", _val: idx});
                  break _t6905;
                }
                if (_t6903._tag === 0) {
                  _t6904 = Typechecker$error((("constraint type variable '" + __dict_Show_string.show(tvname)) + " not found in instance type parameters"));
                  break _t6905;
                }
                _match_fail("line 15950");
              }
              return _t6904;
            }
            const cc_args_6906 = List$map(_t6902, tyvar_names);
            const _t6907 = ({cc_args: cc_args_6906, cc_class: cclass_6900});
            const _t6901 = _t6907;
            _t6898 = _t6901;
            break _t6899;
          }
          _match_fail("line 15950");
        }
        return _t6898;
      }
      const inst_constraints_6908 = List$map(_t6896, constraints);
      const inst_def_6910 = ({inst_class: class_name_6813, inst_constraints: inst_constraints_6908, inst_dict_name: dname_6827, inst_tys: stored_tys});
      const _t6912 = (function() {
        const _t6913 = _h;
        _h = Object.assign({}, _t6913, {
          "unify_error": function(msg, __k) { throw {_e: "unify_error", _v: msg}; },
        });
        try {
          const __x_6914 = Types$check_fundep_consistency(class_def_6819, inst_def_6910, ctx.type_env.instances);
          return __x_6914;
        } catch (_exc) {
          if (_exc && _exc._e === "unify_error") {
            const msg = _exc._v;
            return Typechecker$error(msg);
          } else { throw _exc; }
        } finally { _h = _t6913; }
      })();
      _t6912;
      const __rec_upd_6915 = ctx.type_env;
      const _t6916 = ({classes: __rec_upd_6915.classes, constructors: __rec_upd_6915.constructors, effects: __rec_upd_6915.effects, instances: ({_hd: inst_def_6910, _tl: ctx.type_env.instances}), modules: __rec_upd_6915.modules, mutable_fields: __rec_upd_6915.mutable_fields, records: __rec_upd_6915.records, type_aliases: __rec_upd_6915.type_aliases, type_synonyms: __rec_upd_6915.type_synonyms, variants: __rec_upd_6915.variants});
      const type_env_6917 = _t6916;
      const __rec_upd_6919 = ctx;
      const _t6920 = ({constraint_tvars: __rec_upd_6919.constraint_tvars, current_eff: __rec_upd_6919.current_eff, current_module: __rec_upd_6919.current_module, inside_handler: __rec_upd_6919.inside_handler, loop_info: __rec_upd_6919.loop_info, mutable_vars: __rec_upd_6919.mutable_vars, return_type: __rec_upd_6919.return_type, return_used: __rec_upd_6919.return_used, type_env: type_env_6917, vars: __rec_upd_6919.vars});
      const ctx_6921 = _t6920;
      const _t6922 = [ctx_6921, ({_tag: 0, _name: "TDLet", _val: [dname_6827, dict_expr_6894]})];
      const _t6918 = _t6922;
      const _t6911 = _t6918;
      const _t6909 = _t6911;
      const _t6895 = _t6909;
      const _t6893 = _t6895;
      const _t6887 = _t6893;
      const _t6878 = _t6887;
      const _t6834 = _t6878;
      const _t6831 = _t6834;
      const _t6828 = _t6831;
      _t6824 = _t6828;
      break _t6825;
    }
    _match_fail("line 15950");
  }
  const _t6822 = _t6824;
  const _t6820 = _t6822;
  const _t6814 = _t6820;
  return _t6814;
}
function Typechecker$extract_tyvar_ids(annot, ty) {
  let _t6924;
  const _t6923 = Hashtbl$create(4);
  _t6925: {
    if (true) {
      const mapping = _t6923;
      function walk(annot, ty) {
        while (true) {
          let _t6927;
          const _t6926 = [annot, Types$repr(ty)];
          _t6928: {
            if (_t6926[0]._tag === 1 && _t6926[1]._tag === 16 && _t6926[1]._val.contents._tag === 0) {
              const name = _t6926[0]._val;
              const id = _t6926[1]._val.contents._val[0];
              let _t6929;
              if ((!_call(Hashtbl$has, [__dict_Hash_string, __dict_Eq_string, mapping, name]))) {
                _t6929 = _call(Hashtbl$set, [__dict_Hash_string, __dict_Eq_string, mapping, name, id]);
              } else {
                _t6929 = undefined;
              }
              _t6927 = _t6929;
              break _t6928;
            }
            if (_t6926[0]._tag === 2 && (_t6926[1]._tag === 7 || _t6926[1]._tag === 8)) {
              const a1 = _t6926[0]._val[0];
              const a2 = _t6926[0]._val[1];
              const t1 = _t6926[1]._val[0];
              const t2 = _t6926[1]._val[2];
              walk(a1, t1);
              const _t6930 = a2;
              const _t6931 = t2;
              annot = _t6930;
              ty = _t6931;
              continue;
              _t6927 = undefined;
              break _t6928;
            }
            if (_t6926[0]._tag === 6 && _t6926[1]._tag === 9) {
              const anns = _t6926[0]._val;
              const tys = _t6926[1]._val;
              if ((List$length(anns) === List$length(tys))) {
                _t6927 = List$iter2(walk, anns, tys);
                break _t6928;
              }
            }
            if (_t6926[0]._tag === 4 && _t6926[1]._tag === 10) {
              const a = _t6926[0]._val;
              const t = _t6926[1]._val;
              const _t6932 = a;
              const _t6933 = t;
              annot = _t6932;
              ty = _t6933;
              continue;
              _t6927 = undefined;
              break _t6928;
            }
            if (_t6926[0]._tag === 5 && _t6926[1]._tag === 14) {
              const a = _t6926[0]._val;
              const t = _t6926[1]._val;
              const _t6934 = a;
              const _t6935 = t;
              annot = _t6934;
              ty = _t6935;
              continue;
              _t6927 = undefined;
              break _t6928;
            }
            if (_t6926[0]._tag === 8 && _t6926[1]._tag === 13) {
              const k1 = _t6926[0]._val[0];
              const v1 = _t6926[0]._val[1];
              const k2 = _t6926[1]._val[0];
              const v2 = _t6926[1]._val[1];
              walk(k1, k2);
              const _t6936 = v1;
              const _t6937 = v2;
              annot = _t6936;
              ty = _t6937;
              continue;
              _t6927 = undefined;
              break _t6928;
            }
            if (_t6926[0]._tag === 7 && _t6926[1]._tag === 12) {
              const args = _t6926[0]._val[0];
              const tys = _t6926[1]._val[1];
              if ((List$length(args) === List$length(tys))) {
                _t6927 = List$iter2(walk, args, tys);
                break _t6928;
              }
            }
            if (_t6926[0]._tag === 11) {
              const a = _t6926[0]._val[0];
              const _t6938 = a;
              const _t6939 = ty;
              annot = _t6938;
              ty = _t6939;
              continue;
              _t6927 = undefined;
              break _t6928;
            }
            if (true) {
              _t6927 = undefined;
              break _t6928;
            }
            _match_fail("line 15950");
          }
          return _t6927;
        }
      }
      walk(annot, ty);
      const _t6940 = mapping;
      _t6924 = _t6940;
      break _t6925;
    }
    _match_fail("line 15950");
  }
  return _t6924;
}
function Typechecker$resolve_let_constraints(type_env, level, constraints, params, ret_annot, te_ty, shared_tvars) {
  let _t6941;
  if (_eq(constraints, null)) {
    _t6941 = Types$generalize(level, te_ty);
  } else {
    let _t6943;
    const _t6942 = Hashtbl$create(4);
    _t6944: {
      if (true) {
        const name_to_tvar = _t6942;
        function _t6945(tbl) {
          function _t6946(k, v) {
            let _t6947;
            if ((!_call(Hashtbl$has, [__dict_Hash_string, __dict_Eq_string, name_to_tvar, k]))) {
              _t6947 = _call(Hashtbl$set, [__dict_Hash_string, __dict_Eq_string, name_to_tvar, k, v]);
            } else {
              _t6947 = undefined;
            }
            return _t6947;
          }
          return Hashtbl$iter(_t6946, tbl);
        }
        const merge_into_6948 = _t6945;
        function walk_params(params, ty) {
          while (true) {
            let _t6951;
            const _t6950 = [params, Types$repr(ty)];
            _t6952: {
              if (_t6950[0] !== null && (_t6950[1]._tag === 7 || _t6950[1]._tag === 8)) {
                const p = _t6950[0]._hd;
                const rest = _t6950[0]._tl;
                const param_ty = _t6950[1]._val[0];
                const ret_ty = _t6950[1]._val[2];
                let _t6954;
                const _t6953 = p.annot;
                _t6955: {
                  if (_t6953._tag === 1) {
                    const annot = _t6953._val;
                    _t6954 = merge_into_6948(Typechecker$extract_tyvar_ids(annot, param_ty));
                    break _t6955;
                  }
                  if (_t6953._tag === 0) {
                    _t6954 = undefined;
                    break _t6955;
                  }
                  _match_fail("line 15950");
                }
                _t6954;
                const _t6956 = rest;
                const _t6957 = ret_ty;
                params = _t6956;
                ty = _t6957;
                continue;
                _t6951 = undefined;
                break _t6952;
              }
              if (true) {
                _t6951 = undefined;
                break _t6952;
              }
              _match_fail("line 15950");
            }
            return _t6951;
          }
        }
        walk_params(params, te_ty);
        let _t6960;
        const _t6959 = ret_annot;
        _t6961: {
          if (_t6959._tag === 1) {
            const annot = _t6959._val;
            function skip_arrows(ty, n) {
              while (true) {
                let _t6962;
                if ((n === 0)) {
                  _t6962 = ty;
                } else {
                  let _t6964;
                  const _t6963 = Types$repr(ty);
                  _t6965: {
                    if ((_t6963._tag === 7 || _t6963._tag === 8)) {
                      const rest = _t6963._val[2];
                      const _t6966 = rest;
                      const _t6967 = (n - 1);
                      ty = _t6966;
                      n = _t6967;
                      continue;
                      _t6964 = undefined;
                      break _t6965;
                    }
                    if (true) {
                      _t6964 = ty;
                      break _t6965;
                    }
                    _match_fail("line 15950");
                  }
                  _t6962 = _t6964;
                }
                return _t6962;
              }
            }
            const ret_ty_6969 = skip_arrows(te_ty, List$length(params));
            const _t6970 = merge_into_6948(Typechecker$extract_tyvar_ids(annot, ret_ty_6969));
            const _t6968 = _t6970;
            _t6960 = _t6968;
            break _t6961;
          }
          if (_t6959._tag === 0) {
            _t6960 = undefined;
            break _t6961;
          }
          _match_fail("line 15950");
        }
        _t6960;
        let _t6972;
        const _t6971 = Types$generalize_with_map(level, te_ty);
        _t6973: {
          if (true) {
            const scheme = _t6971[0];
            const id_map = _t6971[1];
            const phantom_counter_6974 = Ref$create(scheme.quant);
            const phantom_map_6976 = Hashtbl$create(4);
            function _t6978(__p191) {
              let _t6980;
              const _t6979 = __p191;
              _t6981: {
                if (true) {
                  const cclass = _t6979[0];
                  const tyvar_names = _t6979[1];
                  const cclass_6982 = Typechecker$resolve_type_alias(type_env, cclass);
                  function _t6984(tvname) {
                    let _t6986;
                    const _t6985 = _call(Hashtbl$get, [__dict_Hash_string, __dict_Eq_string, name_to_tvar, tvname]);
                    _t6987: {
                      if (_t6985._tag === 1) {
                        const tvar_id = _t6985._val;
                        let _t6989;
                        const _t6988 = _call(Hashtbl$get, [__dict_Hash_int, __dict_Eq_int, id_map, tvar_id]);
                        _t6990: {
                          if (_t6988._tag === 1 && _t6988._val._tag === 17) {
                            const idx = _t6988._val._val;
                            _t6989 = ({_tag: 0, _name: "CATGen", _val: idx});
                            break _t6990;
                          }
                          if (true) {
                            _t6989 = Typechecker$error((("constraint type variable '" + __dict_Show_string.show(tvname)) + " is not polymorphic"));
                            break _t6990;
                          }
                          _match_fail("line 15950");
                        }
                        _t6986 = _t6989;
                        break _t6987;
                      }
                      if (_t6985._tag === 0) {
                        let _t6992;
                        const _t6991 = _call(Hashtbl$get, [__dict_Hash_string, __dict_Eq_string, shared_tvars, tvname]);
                        _t6993: {
                          if (_t6991._tag === 1) {
                            const tv = _t6991._val;
                            let _t6995;
                            const _t6994 = Types$repr(tv);
                            _t6996: {
                              if (_t6994._tag === 16 && _t6994._val.contents._tag === 0) {
                                const id = _t6994._val.contents._val[0];
                                _t6995 = ({_tag: 1, _name: "Some", _val: id});
                                break _t6996;
                              }
                              if (true) {
                                _t6995 = ({_tag: 0, _name: "None"});
                                break _t6996;
                              }
                              _match_fail("line 15950");
                            }
                            const tv_id_6997 = _t6995;
                            let _t7000;
                            const _t6999 = tv_id_6997;
                            _t7001: {
                              if (_t6999._tag === 1) {
                                const id = _t6999._val;
                                _t7000 = _call(Hashtbl$get, [__dict_Hash_int, __dict_Eq_int, id_map, id]);
                                break _t7001;
                              }
                              if (_t6999._tag === 0) {
                                _t7000 = ({_tag: 0, _name: "None"});
                                break _t7001;
                              }
                              _match_fail("line 15950");
                            }
                            const tgen_from_map_7002 = _t7000;
                            let _t7005;
                            const _t7004 = tgen_from_map_7002;
                            _t7006: {
                              if (_t7004._tag === 1 && _t7004._val._tag === 17) {
                                const idx = _t7004._val._val;
                                _t7005 = ({_tag: 0, _name: "CATGen", _val: idx});
                                break _t7006;
                              }
                              if (true) {
                                let _t7008;
                                const _t7007 = _call(Hashtbl$get, [__dict_Hash_string, __dict_Eq_string, phantom_map_6976, tvname]);
                                _t7009: {
                                  if (_t7007._tag === 1) {
                                    const idx = _t7007._val;
                                    _t7008 = idx;
                                    break _t7009;
                                  }
                                  if (_t7007._tag === 0) {
                                    const idx_7010 = Ref$get(phantom_counter_6974);
                                    Ref$set(phantom_counter_6974, (Ref$get(phantom_counter_6974) + 1));
                                    _call(Hashtbl$set, [__dict_Hash_string, __dict_Eq_string, phantom_map_6976, tvname, idx_7010]);
                                    const _t7011 = idx_7010;
                                    _t7008 = _t7011;
                                    break _t7009;
                                  }
                                  _match_fail("line 15950");
                                }
                                const idx_7012 = _t7008;
                                const _t7013 = ({_tag: 3, _name: "CAPhantom", _val: [idx_7012, tv]});
                                _t7005 = _t7013;
                                break _t7006;
                              }
                              _match_fail("line 15950");
                            }
                            const _t7003 = _t7005;
                            const _t6998 = _t7003;
                            _t6992 = _t6998;
                            break _t6993;
                          }
                          if (_t6991._tag === 0) {
                            _t6992 = Typechecker$error((("constraint type variable '" + __dict_Show_string.show(tvname)) + " not found in function signature"));
                            break _t6993;
                          }
                          _match_fail("line 15950");
                        }
                        _t6986 = _t6992;
                        break _t6987;
                      }
                      _match_fail("line 15950");
                    }
                    return _t6986;
                  }
                  const cc_args_7014 = List$map(_t6984, tyvar_names);
                  const _t7015 = ({cc_args: cc_args_7014, cc_class: cclass_6982});
                  const _t6983 = _t7015;
                  _t6980 = _t6983;
                  break _t6981;
                }
                _match_fail("line 15950");
              }
              return _t6980;
            }
            const cc_list_7016 = List$map(_t6978, constraints);
            const __rec_upd_7018 = scheme;
            const _t7019 = ({body: __rec_upd_7018.body, constraints: cc_list_7016, equant: __rec_upd_7018.equant, pvquant: __rec_upd_7018.pvquant, quant: __rec_upd_7018.quant, record_evidences: __rec_upd_7018.record_evidences, rquant: __rec_upd_7018.rquant});
            const _t7017 = _t7019;
            const _t6977 = _t7017;
            const _t6975 = _t6977;
            _t6972 = _t6975;
            break _t6973;
          }
          _match_fail("line 15950");
        }
        const _t6958 = _t6972;
        const _t6949 = _t6958;
        _t6943 = _t6949;
        break _t6944;
      }
      _match_fail("line 15950");
    }
    _t6941 = _t6943;
  }
  return _t6941;
}
function Typechecker$unify_constraint_tvars(__dict_Hash_0, __dict_Eq_0, type_env, constraints, shared_tvars, body_te) {
  const classes_7020 = type_env.classes;
  function walk(te) {
    let _t7023;
    const _t7022 = te.expr;
    _t7024: {
      if (_t7022._tag === 7) {
        const name = _t7022._val;
        let _t7026;
        const _t7025 = Types$find_method_class(classes_7020, name);
        _t7027: {
          if (_t7025._tag === 1) {
            const r = _t7025;
            _t7026 = r;
            break _t7027;
          }
          if (_t7025._tag === 0) {
            let _t7029;
            const _t7028 = String$rindex_opt(name, 46);
            _t7030: {
              if (_t7028._tag === 0) {
                _t7029 = ({_tag: 0, _name: "None"});
                break _t7030;
              }
              if (_t7028._tag === 1) {
                const i = _t7028._val;
                const _mml$short_7031 = String$sub(name, (i + 1), ((String$length(name) - i) - 1));
                const _t7032 = Types$find_method_class(classes_7020, _mml$short_7031);
                _t7029 = _t7032;
                break _t7030;
              }
              _match_fail("line 15950");
            }
            _t7026 = _t7029;
            break _t7027;
          }
          _match_fail("line 15950");
        }
        const class_opt_7033 = _t7026;
        let _t7036;
        const _t7035 = class_opt_7033;
        _t7037: {
          if (_t7035._tag === 1) {
            const class_def = _t7035._val;
            let _t7039;
            const _t7038 = String$rindex_opt(name, 46);
            _t7040: {
              if (_t7038._tag === 1) {
                const i = _t7038._val;
                _t7039 = String$sub(name, (i + 1), ((String$length(name) - i) - 1));
                break _t7040;
              }
              if (_t7038._tag === 0) {
                _t7039 = name;
                break _t7040;
              }
              _match_fail("line 15950");
            }
            const method_name_7041 = _t7039;
            let _t7044;
            const _t7043 = List$assoc_opt(method_name_7041, class_def.class_methods);
            _t7045: {
              if (_t7043._tag === 1) {
                const method_schema_ty = _t7043._val;
                const num_params_7046 = List$length(class_def.class_params);
                const param_map_7048 = Hashtbl$create(num_params_7046);
                function go(s, r) {
                  while (true) {
                    const r_7050 = Types$repr(r);
                    let _t7053;
                    const _t7052 = [s, r_7050];
                    _t7054: {
                      if (_t7052[0]._tag === 17) {
                        const i = _t7052[0]._val;
                        if ((i < num_params_7046)) {
                          let _t7055;
                          if ((!_call(Hashtbl$has, [__dict_Hash_int, __dict_Eq_int, param_map_7048, i]))) {
                            _t7055 = _call(Hashtbl$set, [__dict_Hash_int, __dict_Eq_int, param_map_7048, i, r_7050]);
                          } else {
                            _t7055 = undefined;
                          }
                          _t7053 = _t7055;
                          break _t7054;
                        }
                      }
                      if ((_t7052[0]._tag === 7 && _t7052[1]._tag === 7 || _t7052[0]._tag === 8 && _t7052[1]._tag === 8)) {
                        const s1 = _t7052[0]._val[0];
                        const s2 = _t7052[0]._val[2];
                        const r1 = _t7052[1]._val[0];
                        const r2 = _t7052[1]._val[2];
                        go(s1, r1);
                        const _t7056 = s2;
                        const _t7057 = r2;
                        s = _t7056;
                        r = _t7057;
                        continue;
                        _t7053 = undefined;
                        break _t7054;
                      }
                      if (_t7052[0]._tag === 9 && _t7052[1]._tag === 9) {
                        const ss = _t7052[0]._val;
                        const rs = _t7052[1]._val;
                        if ((List$length(ss) === List$length(rs))) {
                          _t7053 = List$iter2(go, ss, rs);
                          break _t7054;
                        }
                      }
                      if (_t7052[0]._tag === 10 && _t7052[1]._tag === 10) {
                        const s1 = _t7052[0]._val;
                        const r1 = _t7052[1]._val;
                        const _t7058 = s1;
                        const _t7059 = r1;
                        s = _t7058;
                        r = _t7059;
                        continue;
                        _t7053 = undefined;
                        break _t7054;
                      }
                      if (_t7052[0]._tag === 14 && _t7052[1]._tag === 14) {
                        const s1 = _t7052[0]._val;
                        const r1 = _t7052[1]._val;
                        const _t7060 = s1;
                        const _t7061 = r1;
                        s = _t7060;
                        r = _t7061;
                        continue;
                        _t7053 = undefined;
                        break _t7054;
                      }
                      if (_t7052[0]._tag === 13 && _t7052[1]._tag === 13) {
                        const sk = _t7052[0]._val[0];
                        const sv = _t7052[0]._val[1];
                        const rk = _t7052[1]._val[0];
                        const rv = _t7052[1]._val[1];
                        go(sk, rk);
                        const _t7062 = sv;
                        const _t7063 = rv;
                        s = _t7062;
                        r = _t7063;
                        continue;
                        _t7053 = undefined;
                        break _t7054;
                      }
                      if (_t7052[0]._tag === 12 && _t7052[1]._tag === 12) {
                        const ss = _t7052[0]._val[1];
                        const rs = _t7052[1]._val[1];
                        if ((List$length(ss) === List$length(rs))) {
                          _t7053 = List$iter2(go, ss, rs);
                          break _t7054;
                        }
                      }
                      if (true) {
                        _t7053 = undefined;
                        break _t7054;
                      }
                      _match_fail("line 15950");
                    }
                    const _t7051 = _t7053;
                    return _t7051;
                  }
                }
                go(method_schema_ty, te.ty);
                function _t7065(__p192) {
                  let _t7067;
                  const _t7066 = __p192;
                  _t7068: {
                    if (true) {
                      const cclass = _t7066[0];
                      const tyvar_names = _t7066[1];
                      let _t7069;
                      if (((cclass === class_def.class_name) && (List$length(tyvar_names) === num_params_7046))) {
                        function _t7070(fd) {
                          function _t7071(fi) {
                            let _t7073;
                            const _t7072 = _call(Hashtbl$get, [__dict_Hash_int, __dict_Eq_int, param_map_7048, fi]);
                            _t7074: {
                              if (_t7072._tag === 1) {
                                const body_tv = _t7072._val;
                                const tvname_7075 = List$nth(tyvar_names, fi);
                                let _t7078;
                                const _t7077 = _call(Hashtbl$get, [__dict_Hash_0, __dict_Eq_0, shared_tvars, tvname_7075]);
                                _t7079: {
                                  if (_t7077._tag === 1) {
                                    const constraint_tv = _t7077._val;
                                    _t7078 = _eq(Types$repr(body_tv), Types$repr(constraint_tv));
                                    break _t7079;
                                  }
                                  if (_t7077._tag === 0) {
                                    _t7078 = true;
                                    break _t7079;
                                  }
                                  _match_fail("line 15950");
                                }
                                const _t7076 = _t7078;
                                _t7073 = _t7076;
                                break _t7074;
                              }
                              if (_t7072._tag === 0) {
                                _t7073 = true;
                                break _t7074;
                              }
                              _match_fail("line 15950");
                            }
                            return _t7073;
                          }
                          return List$forall(_t7071, fd.fd_from);
                        }
                        const from_match_7080 = List$forall(_t7070, class_def.class_fundeps);
                        let _t7082;
                        if (from_match_7080) {
                          function _t7083(fd) {
                            function _t7084(ti) {
                              let _t7086;
                              const _t7085 = _call(Hashtbl$get, [__dict_Hash_int, __dict_Eq_int, param_map_7048, ti]);
                              _t7087: {
                                if (_t7085._tag === 1) {
                                  const body_tv = _t7085._val;
                                  const tvname_7088 = List$nth(tyvar_names, ti);
                                  let _t7091;
                                  const _t7090 = _call(Hashtbl$get, [__dict_Hash_0, __dict_Eq_0, shared_tvars, tvname_7088]);
                                  _t7092: {
                                    if (_t7090._tag === 1) {
                                      const constraint_tv = _t7090._val;
                                      _t7091 = Types$unify(body_tv, constraint_tv);
                                      break _t7092;
                                    }
                                    if (_t7090._tag === 0) {
                                      _t7091 = undefined;
                                      break _t7092;
                                    }
                                    _match_fail("line 15950");
                                  }
                                  const _t7089 = _t7091;
                                  _t7086 = _t7089;
                                  break _t7087;
                                }
                                if (_t7085._tag === 0) {
                                  _t7086 = undefined;
                                  break _t7087;
                                }
                                _match_fail("line 15950");
                              }
                              return _t7086;
                            }
                            return List$iter(_t7084, fd.fd_to);
                          }
                          _t7082 = List$iter(_t7083, class_def.class_fundeps);
                        } else {
                          _t7082 = undefined;
                        }
                        const _t7081 = _t7082;
                        _t7069 = _t7081;
                      } else {
                        _t7069 = undefined;
                      }
                      _t7067 = _t7069;
                      break _t7068;
                    }
                    _match_fail("line 15950");
                  }
                  return _t7067;
                }
                const _t7064 = List$iter(_t7065, constraints);
                const _t7049 = _t7064;
                const _t7047 = _t7049;
                _t7044 = _t7047;
                break _t7045;
              }
              if (_t7043._tag === 0) {
                _t7044 = undefined;
                break _t7045;
              }
              _match_fail("line 15950");
            }
            const _t7042 = _t7044;
            _t7036 = _t7042;
            break _t7037;
          }
          if (_t7035._tag === 0) {
            _t7036 = undefined;
            break _t7037;
          }
          _match_fail("line 15950");
        }
        const _t7034 = _t7036;
        _t7023 = _t7034;
        break _t7024;
      }
      if (_t7022._tag === 11) {
        const f = _t7022._val[0];
        const x = _t7022._val[1];
        walk(f);
        _t7023 = walk(x);
        break _t7024;
      }
      if (_t7022._tag === 10) {
        const body = _t7022._val[1];
        _t7023 = walk(body);
        break _t7024;
      }
      if (_t7022._tag === 8) {
        const e1 = _t7022._val[2];
        const e2 = _t7022._val[3];
        walk(e1);
        _t7023 = walk(e2);
        break _t7024;
      }
      if (_t7022._tag === 9) {
        const e1 = _t7022._val[2];
        const e2 = _t7022._val[3];
        walk(e1);
        _t7023 = walk(e2);
        break _t7024;
      }
      if (_t7022._tag === 12) {
        const c = _t7022._val[0];
        const t = _t7022._val[1];
        const e = _t7022._val[2];
        walk(c);
        walk(t);
        _t7023 = walk(e);
        break _t7024;
      }
      if (_t7022._tag === 13) {
        const a = _t7022._val[1];
        const b = _t7022._val[2];
        walk(a);
        _t7023 = walk(b);
        break _t7024;
      }
      if (_t7022._tag === 14) {
        const a = _t7022._val[1];
        _t7023 = walk(a);
        break _t7024;
      }
      if (_t7022._tag === 15) {
        const es = _t7022._val;
        _t7023 = List$iter(walk, es);
        break _t7024;
      }
      if (_t7022._tag === 16) {
        const fields = _t7022._val;
        function _t7093(__p193) {
          let _t7095;
          const _t7094 = __p193;
          _t7096: {
            if (true) {
              const e = _t7094[1];
              _t7095 = walk(e);
              break _t7096;
            }
            _match_fail("line 15950");
          }
          return _t7095;
        }
        _t7023 = List$iter(_t7093, fields);
        break _t7024;
      }
      if (_t7022._tag === 17) {
        const e = _t7022._val[0];
        const fields = _t7022._val[1];
        walk(e);
        function _t7097(__p194) {
          let _t7099;
          const _t7098 = __p194;
          _t7100: {
            if (true) {
              const e = _t7098[1];
              _t7099 = walk(e);
              break _t7100;
            }
            _match_fail("line 15950");
          }
          return _t7099;
        }
        _t7023 = List$iter(_t7097, fields);
        break _t7024;
      }
      if (_t7022._tag === 18) {
        const e = _t7022._val[0];
        const pairs = _t7022._val[1];
        walk(e);
        function _t7101(__p195) {
          let _t7103;
          const _t7102 = __p195;
          _t7104: {
            if (true) {
              const i = _t7102[0];
              const v = _t7102[1];
              walk(i);
              _t7103 = walk(v);
              break _t7104;
            }
            _match_fail("line 15950");
          }
          return _t7103;
        }
        _t7023 = List$iter(_t7101, pairs);
        break _t7024;
      }
      if (_t7022._tag === 19) {
        const e = _t7022._val[0];
        _t7023 = walk(e);
        break _t7024;
      }
      if (_t7022._tag === 20) {
        const e1 = _t7022._val[0];
        const e2 = _t7022._val[1];
        walk(e1);
        _t7023 = walk(e2);
        break _t7024;
      }
      if (_t7022._tag === 21) {
        const hd = _t7022._val[0];
        const tl = _t7022._val[1];
        walk(hd);
        _t7023 = walk(tl);
        break _t7024;
      }
      if (_t7022._tag === 24) {
        const scrut = _t7022._val[0];
        const branches = _t7022._val[1];
        walk(scrut);
        function _t7105(__p196) {
          let _t7107;
          const _t7106 = __p196;
          _t7108: {
            if (true) {
              const guard = _t7106[1];
              const body = _t7106[2];
              let _t7110;
              const _t7109 = guard;
              _t7111: {
                if (_t7109._tag === 1) {
                  const g = _t7109._val;
                  _t7110 = walk(g);
                  break _t7111;
                }
                if (_t7109._tag === 0) {
                  _t7110 = undefined;
                  break _t7111;
                }
                _match_fail("line 15950");
              }
              _t7110;
              _t7107 = walk(body);
              break _t7108;
            }
            _match_fail("line 15950");
          }
          return _t7107;
        }
        _t7023 = List$iter(_t7105, branches);
        break _t7024;
      }
      if (_t7022._tag === 28) {
        const e1 = _t7022._val[0];
        const e2 = _t7022._val[1];
        walk(e1);
        _t7023 = walk(e2);
        break _t7024;
      }
      if (_t7022._tag === 25) {
        const e1 = _t7022._val[1];
        const e2 = _t7022._val[2];
        walk(e1);
        _t7023 = walk(e2);
        break _t7024;
      }
      if (_t7022._tag === 26) {
        const e = _t7022._val[1];
        _t7023 = walk(e);
        break _t7024;
      }
      if (_t7022._tag === 27) {
        const e1 = _t7022._val[0];
        const e2 = _t7022._val[2];
        walk(e1);
        _t7023 = walk(e2);
        break _t7024;
      }
      if (_t7022._tag === 23 && _t7022._val[1]._tag === 1) {
        const e = _t7022._val[1]._val;
        _t7023 = walk(e);
        break _t7024;
      }
      if (_t7022._tag === 29) {
        const e = _t7022._val[1];
        _t7023 = walk(e);
        break _t7024;
      }
      if (_t7022._tag === 30) {
        const body = _t7022._val[0];
        _t7023 = walk(body);
        break _t7024;
      }
      if (_t7022._tag === 31) {
        const e1 = _t7022._val[0];
        const e2 = _t7022._val[1];
        walk(e1);
        _t7023 = walk(e2);
        break _t7024;
      }
      if (_t7022._tag === 32) {
        const cond = _t7022._val[0];
        const body = _t7022._val[1];
        walk(cond);
        _t7023 = walk(body);
        break _t7024;
      }
      if (_t7022._tag === 36) {
        const body = _t7022._val;
        _t7023 = walk(body);
        break _t7024;
      }
      if (_t7022._tag === 38) {
        const kvs = _t7022._val;
        function _t7112(__p197) {
          let _t7114;
          const _t7113 = __p197;
          _t7115: {
            if (true) {
              const k = _t7113[0];
              const v = _t7113[1];
              walk(k);
              _t7114 = walk(v);
              break _t7115;
            }
            _match_fail("line 15950");
          }
          return _t7114;
        }
        _t7023 = List$iter(_t7112, kvs);
        break _t7024;
      }
      if (_t7022._tag === 39) {
        const es = _t7022._val;
        _t7023 = List$iter(walk, es);
        break _t7024;
      }
      if (_t7022._tag === 40) {
        const e = _t7022._val;
        _t7023 = walk(e);
        break _t7024;
      }
      if (_t7022._tag === 33) {
        const e = _t7022._val;
        _t7023 = walk(e);
        break _t7024;
      }
      if (_t7022._tag === 35) {
        const e = _t7022._val;
        _t7023 = walk(e);
        break _t7024;
      }
      if (_t7022._tag === 37) {
        const bindings = _t7022._val[0];
        const body = _t7022._val[1];
        function _t7116(__p198) {
          let _t7118;
          const _t7117 = __p198;
          _t7119: {
            if (true) {
              const e = _t7117[1];
              _t7118 = walk(e);
              break _t7119;
            }
            _match_fail("line 15950");
          }
          return _t7118;
        }
        List$iter(_t7116, bindings);
        _t7023 = walk(body);
        break _t7024;
      }
      if (true) {
        _t7023 = undefined;
        break _t7024;
      }
      _match_fail("line 15950");
    }
    return _t7023;
  }
  const _t7120 = walk(body_te);
  const _t7021 = _t7120;
  return _t7021;
}
function Typechecker$synth_constrained_fn(ctx, level, constraints, params, ret_annot, body) {
  const shared_tvars_7121 = Hashtbl$create(4);
  function _t7123(__p199) {
    let _t7125;
    const _t7124 = __p199;
    _t7126: {
      if (true) {
        const names = _t7124[1];
        _t7125 = names;
        break _t7126;
      }
      _match_fail("line 15950");
    }
    return _t7125;
  }
  const constraint_tyvar_names_7127 = _call(_call(List$sort_uniq, [String$compare]), [List$flatten(List$map(_t7123, constraints))]);
  function _t7129(tvname) {
    return _call(Hashtbl$set, [__dict_Hash_string, __dict_Eq_string, shared_tvars_7121, tvname, Types$new_tvar((level + 1))]);
  }
  List$iter(_t7129, constraint_tyvar_names_7127);
  function _t7130(tvname) {
    let _t7132;
    const _t7131 = Types$repr(_call(Hashtbl$find, [__dict_Hash_string, __dict_Eq_string, shared_tvars_7121, tvname]));
    _t7133: {
      if (_t7131._tag === 16 && _t7131._val.contents._tag === 0) {
        const id = _t7131._val.contents._val[0];
        _t7132 = ({_tag: 1, _name: "Some", _val: id});
        break _t7133;
      }
      if (true) {
        _t7132 = ({_tag: 0, _name: "None"});
        break _t7133;
      }
      _match_fail("line 15950");
    }
    return _t7132;
  }
  const constraint_tvar_ids_7134 = List$filter_map(_t7130, constraint_tyvar_names_7127);
  function _t7136(p) {
    let _t7138;
    const _t7137 = p.annot;
    _t7139: {
      if (_t7137._tag === 1) {
        const annot = _t7137._val;
        _t7138 = Typechecker$resolve_ty_annot_shared(ctx, (level + 1), shared_tvars_7121, annot);
        break _t7139;
      }
      if (_t7137._tag === 0) {
        _t7138 = Types$new_tvar((level + 1));
        break _t7139;
      }
      _match_fail("line 15950");
    }
    return _t7138;
  }
  const param_tys_7140 = List$map(_t7136, params);
  let _t7143;
  const _t7142 = ret_annot;
  _t7144: {
    if (_t7142._tag === 1) {
      const annot = _t7142._val;
      _t7143 = ({_tag: 1, _name: "Some", _val: Typechecker$resolve_ty_annot_shared(ctx, (level + 1), shared_tvars_7121, annot)});
      break _t7144;
    }
    if (_t7142._tag === 0) {
      _t7143 = ({_tag: 0, _name: "None"});
      break _t7144;
    }
    _match_fail("line 15950");
  }
  const ret_ty_opt_7145 = _t7143;
  const body_eff_7147 = Types$new_effvar((level + 1));
  function _t7149(c, p, ty) {
    return Typechecker$extend_var_mono(c, p.name, ty);
  }
  const __rec_upd_7150 = ctx;
  const _t7151 = ({constraint_tvars: List$concat(constraint_tvar_ids_7134, ctx.constraint_tvars), current_eff: body_eff_7147, current_module: __rec_upd_7150.current_module, inside_handler: __rec_upd_7150.inside_handler, loop_info: __rec_upd_7150.loop_info, mutable_vars: __rec_upd_7150.mutable_vars, return_type: __rec_upd_7150.return_type, return_used: __rec_upd_7150.return_used, type_env: __rec_upd_7150.type_env, vars: __rec_upd_7150.vars});
  const inner_ctx_7152 = List$fold2(_t7149, _t7151, params, param_tys_7140);
  let _t7155;
  const _t7154 = ret_ty_opt_7145;
  _t7156: {
    if (_t7154._tag === 1) {
      const ret_ty = _t7154._val;
      _t7155 = Typechecker$check(inner_ctx_7152, (level + 1), body, ret_ty);
      break _t7156;
    }
    if (_t7154._tag === 0) {
      _t7155 = Typechecker$synth(inner_ctx_7152, (level + 1), body);
      break _t7156;
    }
    _match_fail("line 15950");
  }
  const body_te_7157 = _t7155;
  _call(Typechecker$unify_constraint_tvars, [__dict_Hash_string, __dict_Eq_string, ctx.type_env, constraints, shared_tvars_7121, body_te_7157]);
  let _t7160;
  const _t7159 = [List$rev(params), List$rev(param_tys_7140)];
  _t7161: {
    if (_t7159[0] === null && _t7159[1] === null) {
      _t7160 = body_te_7157;
      break _t7161;
    }
    if (_t7159[0] !== null && _t7159[1] !== null) {
      const last_p = _t7159[0]._hd;
      const rest_ps = _t7159[0]._tl;
      const last_pty = _t7159[1]._hd;
      const rest_ptys = _t7159[1]._tl;
      const inner_7162 = Typechecker$mk(({_tag: 10, _name: "TEFun", _val: [last_p.name, body_te_7157, false]}), ({_tag: 7, _name: "TArrow", _val: [last_pty, body_eff_7147, body_te_7157.ty]}));
      function _t7164(acc, p, pty) {
        return Typechecker$mk(({_tag: 10, _name: "TEFun", _val: [p.name, acc, false]}), ({_tag: 7, _name: "TArrow", _val: [pty, ({_tag: 1, _name: "EffEmpty"}), acc.ty]}));
      }
      const _t7163 = List$fold2(_t7164, inner_7162, rest_ps, rest_ptys);
      _t7160 = _t7163;
      break _t7161;
    }
    if (true) {
      _t7160 = failwith("assert false");
      break _t7161;
    }
    _match_fail("line 15950");
  }
  const te_7165 = _t7160;
  const scheme_7167 = Typechecker$resolve_let_constraints(ctx.type_env, level, constraints, params, ret_annot, te_7165.ty, shared_tvars_7121);
  const _t7168 = [te_7165, scheme_7167];
  const _t7166 = _t7168;
  const _t7158 = _t7166;
  const _t7153 = _t7158;
  const _t7148 = _t7153;
  const _t7146 = _t7148;
  const _t7141 = _t7146;
  const _t7135 = _t7141;
  const _t7128 = _t7135;
  const _t7122 = _t7128;
  return _t7122;
}
function Typechecker$find_module_in_env(type_env, mod_name) {
  let _t7170;
  const _t7169 = String$split(".", mod_name);
  _t7171: {
    if (_t7169 === null) {
      _t7170 = ({_tag: 0, _name: "None"});
      break _t7171;
    }
    if (_t7169 !== null && _t7169._tl === null) {
      const name = _t7169._hd;
      _t7170 = List$assoc_opt(name, type_env.modules);
      break _t7171;
    }
    if (_t7169 !== null) {
      const first = _t7169._hd;
      const rest = _t7169._tl;
      let _t7173;
      const _t7172 = List$assoc_opt(first, type_env.modules);
      _t7174: {
        if (_t7172._tag === 0) {
          _t7173 = ({_tag: 0, _name: "None"});
          break _t7174;
        }
        if (_t7172._tag === 1) {
          const minfo = _t7172._val;
          function drill(mi, __x) {
            while (true) {
              let _t7176;
              const _t7175 = __x;
              _t7177: {
                if (_t7175 === null) {
                  _t7176 = ({_tag: 1, _name: "Some", _val: mi});
                  break _t7177;
                }
                if (_t7175 !== null) {
                  const seg = _t7175._hd;
                  const rest = _t7175._tl;
                  let _t7179;
                  const _t7178 = List$assoc_opt(seg, mi.mod_submodules);
                  _t7180: {
                    if (_t7178._tag === 0) {
                      _t7179 = ({_tag: 0, _name: "None"});
                      break _t7180;
                    }
                    if (_t7178._tag === 1) {
                      const sub = _t7178._val;
                      const _t7181 = sub;
                      const _t7182 = rest;
                      mi = _t7181;
                      __x = _t7182;
                      continue;
                      _t7179 = undefined;
                      break _t7180;
                    }
                    _match_fail("line 15950");
                  }
                  _t7176 = _t7179;
                  break _t7177;
                }
                _match_fail("line 15950");
              }
              return _t7176;
            }
          }
          const _t7183 = drill(minfo, rest);
          _t7173 = _t7183;
          break _t7174;
        }
        _match_fail("line 15950");
      }
      _t7170 = _t7173;
      break _t7171;
    }
    _match_fail("line 15950");
  }
  return _t7170;
}
function Typechecker$open_module_into_ctx(ctx, mod_name, names_opt) {
  let _t7185;
  const _t7184 = Typechecker$find_module_in_env(ctx.type_env, mod_name);
  _t7186: {
    if (_t7184._tag === 0) {
      _t7185 = Typechecker$error(("unknown module: " + __dict_Show_string.show(mod_name)));
      break _t7186;
    }
    if (_t7184._tag === 1) {
      const minfo = _t7184._val;
      function _t7187(name) {
        let _t7189;
        const _t7188 = names_opt;
        _t7190: {
          if (_t7188._tag === 0) {
            _t7189 = true;
            break _t7190;
          }
          if (_t7188._tag === 1) {
            const names = _t7188._val;
            _t7189 = List$mem(name, names);
            break _t7190;
          }
          _match_fail("line 15950");
        }
        return _t7189;
      }
      const filter_7191 = _t7187;
      function _t7193(ctx, __p200) {
        let _t7195;
        const _t7194 = __p200;
        _t7196: {
          if (true) {
            const _mml$short = _t7194[0];
            const scheme = _t7194[1];
            let _t7197;
            if (filter_7191(_mml$short)) {
              let _t7198;
              if (List$mem(_mml$short, minfo.mod_pub_mutable_vars)) {
                _t7198 = Typechecker$extend_var_mutable(ctx, _mml$short, scheme);
              } else {
                _t7198 = Typechecker$extend_var(ctx, _mml$short, scheme);
              }
              _t7197 = _t7198;
            } else {
              _t7197 = ctx;
            }
            _t7195 = _t7197;
            break _t7196;
          }
          _match_fail("line 15950");
        }
        return _t7195;
      }
      const ctx_7199 = List$fold(_t7193, ctx, minfo.mod_pub_vars);
      function _t7201(te, __p201) {
        let _t7203;
        const _t7202 = __p201;
        _t7204: {
          if (true) {
            const _mml$short = _t7202[0];
            const info = _t7202[1];
            let _t7205;
            if (filter_7191(_mml$short)) {
              const __rec_upd_7206 = te;
              const _t7207 = ({classes: __rec_upd_7206.classes, constructors: ({_hd: [_mml$short, info], _tl: te.constructors}), effects: __rec_upd_7206.effects, instances: __rec_upd_7206.instances, modules: __rec_upd_7206.modules, mutable_fields: __rec_upd_7206.mutable_fields, records: __rec_upd_7206.records, type_aliases: __rec_upd_7206.type_aliases, type_synonyms: __rec_upd_7206.type_synonyms, variants: __rec_upd_7206.variants});
              _t7205 = _t7207;
            } else {
              _t7205 = te;
            }
            _t7203 = _t7205;
            break _t7204;
          }
          _match_fail("line 15950");
        }
        return _t7203;
      }
      const type_env_7208 = List$fold(_t7201, ctx_7199.type_env, minfo.mod_pub_constructors);
      function _t7210(te, qname) {
        let _t7212;
        const _t7211 = String$rindex_opt(qname, 46);
        _t7213: {
          if (_t7211._tag === 1) {
            const i = _t7211._val;
            _t7212 = String$sub(qname, (i + 1), ((String$length(qname) - i) - 1));
            break _t7213;
          }
          if (_t7211._tag === 0) {
            _t7212 = qname;
            break _t7213;
          }
          _match_fail("line 15950");
        }
        const _mml$short_7214 = _t7212;
        let _t7216;
        if (filter_7191(_mml$short_7214)) {
          function _t7217(__p202) {
            let _t7219;
            const _t7218 = __p202;
            _t7220: {
              if (true) {
                const n = _t7218[0];
                _t7219 = (n === qname);
                break _t7220;
              }
              _match_fail("line 15950");
            }
            return _t7219;
          }
          let _t7222;
          const _t7221 = List$find(_t7217, te.variants);
          _t7223: {
            if (_t7221._tag === 1) {
              const np = _t7221._val[1];
              const vdef = _t7221._val[2];
              const is_gadt = _t7221._val[3];
              function _t7224(__p203) {
                let _t7226;
                const _t7225 = __p203;
                _t7227: {
                  if (true) {
                    const n = _t7225[0];
                    _t7226 = (n === _mml$short_7214);
                    break _t7227;
                  }
                  _match_fail("line 15950");
                }
                return _t7226;
              }
              let _t7228;
              if (List$exists(_t7224, te.variants)) {
                _t7228 = te;
              } else {
                const __rec_upd_7229 = te;
                const _t7230 = ({classes: __rec_upd_7229.classes, constructors: __rec_upd_7229.constructors, effects: __rec_upd_7229.effects, instances: __rec_upd_7229.instances, modules: __rec_upd_7229.modules, mutable_fields: __rec_upd_7229.mutable_fields, records: __rec_upd_7229.records, type_aliases: __rec_upd_7229.type_aliases, type_synonyms: __rec_upd_7229.type_synonyms, variants: ({_hd: [_mml$short_7214, np, vdef, is_gadt], _tl: te.variants})});
                _t7228 = _t7230;
              }
              _t7222 = _t7228;
              break _t7223;
            }
            if (_t7221._tag === 0) {
              _t7222 = te;
              break _t7223;
            }
            _match_fail("line 15950");
          }
          const te_7231 = _t7222;
          let _t7234;
          const _t7233 = List$assoc_opt(qname, te_7231.records);
          _t7235: {
            if (_t7233._tag === 1) {
              const fields = _t7233._val;
              let _t7236;
              if (!_eq(List$assoc_opt(_mml$short_7214, te_7231.records), ({_tag: 0, _name: "None"}))) {
                _t7236 = te_7231;
              } else {
                const __rec_upd_7237 = te_7231;
                const _t7238 = ({classes: __rec_upd_7237.classes, constructors: __rec_upd_7237.constructors, effects: __rec_upd_7237.effects, instances: __rec_upd_7237.instances, modules: __rec_upd_7237.modules, mutable_fields: __rec_upd_7237.mutable_fields, records: ({_hd: [_mml$short_7214, fields], _tl: te_7231.records}), type_aliases: __rec_upd_7237.type_aliases, type_synonyms: __rec_upd_7237.type_synonyms, variants: __rec_upd_7237.variants});
                _t7236 = _t7238;
              }
              _t7234 = _t7236;
              break _t7235;
            }
            if (_t7233._tag === 0) {
              _t7234 = te_7231;
              break _t7235;
            }
            _match_fail("line 15950");
          }
          const te_7239 = _t7234;
          function _t7241(__p204) {
            let _t7243;
            const _t7242 = __p204;
            _t7244: {
              if (true) {
                const n = _t7242[0];
                _t7243 = (n === qname);
                break _t7244;
              }
              _match_fail("line 15950");
            }
            return _t7243;
          }
          let _t7246;
          const _t7245 = List$find(_t7241, te_7239.type_synonyms);
          _t7247: {
            if (_t7245._tag === 1) {
              const np = _t7245._val[1];
              const expanded = _t7245._val[2];
              function _t7248(__p205) {
                let _t7250;
                const _t7249 = __p205;
                _t7251: {
                  if (true) {
                    const n = _t7249[0];
                    _t7250 = (n === _mml$short_7214);
                    break _t7251;
                  }
                  _match_fail("line 15950");
                }
                return _t7250;
              }
              let _t7252;
              if (List$exists(_t7248, te_7239.type_synonyms)) {
                _t7252 = te_7239;
              } else {
                const __rec_upd_7253 = te_7239;
                const _t7254 = ({classes: __rec_upd_7253.classes, constructors: __rec_upd_7253.constructors, effects: __rec_upd_7253.effects, instances: __rec_upd_7253.instances, modules: __rec_upd_7253.modules, mutable_fields: __rec_upd_7253.mutable_fields, records: __rec_upd_7253.records, type_aliases: __rec_upd_7253.type_aliases, type_synonyms: ({_hd: [_mml$short_7214, np, expanded], _tl: te_7239.type_synonyms}), variants: __rec_upd_7253.variants});
                _t7252 = _t7254;
              }
              _t7246 = _t7252;
              break _t7247;
            }
            if (_t7245._tag === 0) {
              _t7246 = te_7239;
              break _t7247;
            }
            _match_fail("line 15950");
          }
          const te_7255 = _t7246;
          let _t7257;
          if ((_mml$short_7214 === qname)) {
            _t7257 = te_7255;
          } else {
            const __rec_upd_7258 = te_7255;
            const _t7259 = ({classes: __rec_upd_7258.classes, constructors: __rec_upd_7258.constructors, effects: __rec_upd_7258.effects, instances: __rec_upd_7258.instances, modules: __rec_upd_7258.modules, mutable_fields: __rec_upd_7258.mutable_fields, records: __rec_upd_7258.records, type_aliases: ({_hd: [_mml$short_7214, qname], _tl: te_7255.type_aliases}), type_synonyms: __rec_upd_7258.type_synonyms, variants: __rec_upd_7258.variants});
            _t7257 = _t7259;
          }
          const te_7260 = _t7257;
          const _t7261 = te_7260;
          const _t7256 = _t7261;
          const _t7240 = _t7256;
          const _t7232 = _t7240;
          _t7216 = _t7232;
        } else {
          _t7216 = te;
        }
        const _t7215 = _t7216;
        return _t7215;
      }
      const type_env_7262 = List$fold(_t7210, type_env_7208, minfo.mod_pub_types);
      function _t7264(te, __p206) {
        let _t7266;
        const _t7265 = __p206;
        _t7267: {
          if (true) {
            const sub_name = _t7265[0];
            const sub_info = _t7265[1];
            let _t7268;
            if (filter_7191(sub_name)) {
              const __rec_upd_7269 = te;
              const _t7270 = ({classes: __rec_upd_7269.classes, constructors: __rec_upd_7269.constructors, effects: __rec_upd_7269.effects, instances: __rec_upd_7269.instances, modules: ({_hd: [sub_name, sub_info], _tl: te.modules}), mutable_fields: __rec_upd_7269.mutable_fields, records: __rec_upd_7269.records, type_aliases: __rec_upd_7269.type_aliases, type_synonyms: __rec_upd_7269.type_synonyms, variants: __rec_upd_7269.variants});
              _t7268 = _t7270;
            } else {
              _t7268 = te;
            }
            _t7266 = _t7268;
            break _t7267;
          }
          _match_fail("line 15950");
        }
        return _t7266;
      }
      const type_env_7271 = List$fold(_t7264, type_env_7262, minfo.mod_submodules);
      function _t7273(te, qname) {
        let _t7275;
        const _t7274 = String$rindex_opt(qname, 46);
        _t7276: {
          if (_t7274._tag === 1) {
            const i = _t7274._val;
            _t7275 = String$sub(qname, (i + 1), ((String$length(qname) - i) - 1));
            break _t7276;
          }
          if (_t7274._tag === 0) {
            _t7275 = qname;
            break _t7276;
          }
          _match_fail("line 15950");
        }
        const _mml$short_7277 = _t7275;
        let _t7279;
        if (filter_7191(_mml$short_7277)) {
          const __rec_upd_7280 = te;
          const _t7281 = ({classes: __rec_upd_7280.classes, constructors: __rec_upd_7280.constructors, effects: __rec_upd_7280.effects, instances: __rec_upd_7280.instances, modules: __rec_upd_7280.modules, mutable_fields: __rec_upd_7280.mutable_fields, records: __rec_upd_7280.records, type_aliases: ({_hd: [_mml$short_7277, qname], _tl: te.type_aliases}), type_synonyms: __rec_upd_7280.type_synonyms, variants: __rec_upd_7280.variants});
          _t7279 = _t7281;
        } else {
          _t7279 = te;
        }
        const _t7278 = _t7279;
        return _t7278;
      }
      const type_env_7282 = List$fold(_t7273, type_env_7271, minfo.mod_pub_classes);
      const __rec_upd_7284 = ctx_7199;
      const _t7285 = ({constraint_tvars: __rec_upd_7284.constraint_tvars, current_eff: __rec_upd_7284.current_eff, current_module: __rec_upd_7284.current_module, inside_handler: __rec_upd_7284.inside_handler, loop_info: __rec_upd_7284.loop_info, mutable_vars: __rec_upd_7284.mutable_vars, return_type: __rec_upd_7284.return_type, return_used: __rec_upd_7284.return_used, type_env: type_env_7282, vars: __rec_upd_7284.vars});
      const _t7283 = _t7285;
      const _t7272 = _t7283;
      const _t7263 = _t7272;
      const _t7209 = _t7263;
      const _t7200 = _t7209;
      const _t7192 = _t7200;
      _t7185 = _t7192;
      break _t7186;
    }
    _match_fail("line 15950");
  }
  return _t7185;
}
const _t7286_Typechecker$__destruct = Ref$set(Typechecker$find_module_in_env_ref, Typechecker$find_module_in_env);
const _t7287_Typechecker$__destruct = Ref$set(Typechecker$open_module_into_ctx_ref, Typechecker$open_module_into_ctx);
function Typechecker$collect_tyvars_annot(__x) {
  while (true) {
    let _t7289;
    const _t7288 = __x;
    _t7290: {
      if (_t7288._tag === 1) {
        const s = _t7288._val;
        _t7289 = ({_hd: s, _tl: null});
        break _t7290;
      }
      if (_t7288._tag === 2) {
        const a = _t7288._val[0];
        const b = _t7288._val[1];
        _t7289 = List$concat(Typechecker$collect_tyvars_annot(a), Typechecker$collect_tyvars_annot(b));
        break _t7290;
      }
      if (_t7288._tag === 6) {
        const ts = _t7288._val;
        _t7289 = List$concat_map(Typechecker$collect_tyvars_annot, ts);
        break _t7290;
      }
      if ((_t7288._tag === 4 || _t7288._tag === 5)) {
        const t = _t7288._val;
        const _t7291 = t;
        __x = _t7291;
        continue;
        _t7289 = undefined;
        break _t7290;
      }
      if (_t7288._tag === 7) {
        const args = _t7288._val[0];
        _t7289 = List$concat_map(Typechecker$collect_tyvars_annot, args);
        break _t7290;
      }
      if (_t7288._tag === 8) {
        const k = _t7288._val[0];
        const v = _t7288._val[1];
        _t7289 = List$concat(Typechecker$collect_tyvars_annot(k), Typechecker$collect_tyvars_annot(v));
        break _t7290;
      }
      if (_t7288._tag === 3) {
        const fs = _t7288._val[0];
        function _t7292(__p207) {
          let _t7294;
          const _t7293 = __p207;
          _t7295: {
            if (true) {
              const t = _t7293[1];
              _t7294 = Typechecker$collect_tyvars_annot(t);
              break _t7295;
            }
            _match_fail("line 15950");
          }
          return _t7294;
        }
        _t7289 = List$concat_map(_t7292, fs);
        break _t7290;
      }
      if ((_t7288._tag === 0 || _t7288._tag === 9)) {
        _t7289 = null;
        break _t7290;
      }
      if (_t7288._tag === 10) {
        const tags = _t7288._val[1];
        function _t7296(__p208) {
          let _t7298;
          const _t7297 = __p208;
          _t7299: {
            if (true) {
              const ty_opt = _t7297[1];
              let _t7301;
              const _t7300 = ty_opt;
              _t7302: {
                if (_t7300._tag === 1) {
                  const t = _t7300._val;
                  _t7301 = Typechecker$collect_tyvars_annot(t);
                  break _t7302;
                }
                if (_t7300._tag === 0) {
                  _t7301 = null;
                  break _t7302;
                }
                _match_fail("line 15950");
              }
              _t7298 = _t7301;
              break _t7299;
            }
            _match_fail("line 15950");
          }
          return _t7298;
        }
        _t7289 = List$concat_map(_t7296, tags);
        break _t7290;
      }
      if (_t7288._tag === 11) {
        const ty = _t7288._val[0];
        const _t7303 = ty;
        __x = _t7303;
        continue;
        _t7289 = undefined;
        break _t7290;
      }
      _match_fail("line 15950");
    }
    return _t7289;
  }
}
function Typechecker$concat_str_exprs(__x) {
  let _t7305;
  const _t7304 = __x;
  _t7306: {
    if (_t7304 === null) {
      _t7305 = ({_tag: 3, _name: "EString", _val: ""});
      break _t7306;
    }
    if (_t7304 !== null && _t7304._tl === null) {
      const e = _t7304._hd;
      _t7305 = e;
      break _t7306;
    }
    if (_t7304 !== null) {
      const first = _t7304._hd;
      const rest = _t7304._tl;
      function _t7307(acc, e) {
        return ({_tag: 13, _name: "EBinop", _val: [({_tag: 13, _name: "Concat"}), acc, e]});
      }
      _t7305 = List$fold(_t7307, first, rest);
      break _t7306;
    }
    _match_fail("line 15950");
  }
  return _t7305;
}
function Typechecker$make_inst_ty(type_params, name) {
  let _t7308;
  if (_eq(type_params, null)) {
    _t7308 = ({_tag: 0, _name: "TyName", _val: name});
  } else {
    function _t7309(p) {
      return ({_tag: 1, _name: "TyVar", _val: p});
    }
    _t7308 = ({_tag: 7, _name: "TyApp", _val: [List$map(_t7309, type_params), name]});
  }
  return _t7308;
}
function Typechecker$make_constraints(class_name, type_params, annots) {
  function _t7310(ann) {
    return Typechecker$collect_tyvars_annot(ann);
  }
  const all_vars_7311 = List$concat_map(_t7310, annots);
  const unique_vars_7313 = List$sort_uniq(String$compare, all_vars_7311);
  function _t7315(v) {
    return List$mem(v, type_params);
  }
  const param_vars_7316 = List$filter(_t7315, unique_vars_7313);
  function _t7318(v) {
    return [class_name, ({_hd: v, _tl: null})];
  }
  const _t7317 = List$map(_t7318, param_vars_7316);
  const _t7314 = _t7317;
  const _t7312 = _t7314;
  return _t7312;
}
function Typechecker$gen_show_variant(type_params, name, ctors) {
  const inst_ty_7319 = Typechecker$make_inst_ty(type_params, name);
  function _t7321(__p209) {
    let _t7323;
    const _t7322 = __p209;
    _t7324: {
      if (true) {
        const a = _t7322[1];
        _t7323 = a;
        break _t7324;
      }
      _match_fail("line 15950");
    }
    return _t7323;
  }
  const annots_7325 = List$filter_map(_t7321, ctors);
  const constraints_7327 = Typechecker$make_constraints("Show", type_params, annots_7325);
  function _t7329(__p210) {
    let _t7331;
    const _t7330 = __p210;
    _t7332: {
      if (true) {
        const ctor_name = _t7330[0];
        const arg_annot = _t7330[1];
        let _t7334;
        const _t7333 = arg_annot;
        _t7335: {
          if (_t7333._tag === 0) {
            _t7334 = [({_tag: 10, _name: "PatConstruct", _val: [ctor_name, ({_tag: 0, _name: "None"})]}), ({_tag: 0, _name: "None"}), ({_tag: 3, _name: "EString", _val: ctor_name})];
            break _t7335;
          }
          if (_t7333._tag === 1 && _t7333._val._tag === 6) {
            const tys = _t7333._val._val;
            const n_7336 = List$length(tys);
            function _t7338(i) {
              return ("__v" + __dict_Show_int.show(i));
            }
            const vars_7339 = List$init(n_7336, _t7338);
            function _t7341(v) {
              return ({_tag: 1, _name: "PatVar", _val: v});
            }
            const pat_7342 = ({_tag: 10, _name: "PatConstruct", _val: [ctor_name, ({_tag: 1, _name: "Some", _val: ({_tag: 7, _name: "PatTuple", _val: List$map(_t7341, vars_7339)})})]});
            function _t7344(i, v) {
              const sv_7345 = ({_tag: 11, _name: "EApp", _val: [({_tag: 7, _name: "EVar", _val: "show"}), ({_tag: 7, _name: "EVar", _val: v})]});
              let _t7347;
              if ((i === 0)) {
                _t7347 = ({_hd: sv_7345, _tl: null});
              } else {
                _t7347 = ({_hd: ({_tag: 3, _name: "EString", _val: ", "}), _tl: ({_hd: sv_7345, _tl: null})});
              }
              const _t7346 = _t7347;
              return _t7346;
            }
            const parts_7348 = List$concat(({_hd: ({_tag: 3, _name: "EString", _val: (ctor_name + "(")}), _tl: null}), List$concat(List$flatten(List$mapi(_t7344, vars_7339)), ({_hd: ({_tag: 3, _name: "EString", _val: ")"}), _tl: null})));
            const _t7349 = [pat_7342, ({_tag: 0, _name: "None"}), Typechecker$concat_str_exprs(parts_7348)];
            const _t7343 = _t7349;
            const _t7340 = _t7343;
            const _t7337 = _t7340;
            _t7334 = _t7337;
            break _t7335;
          }
          if (_t7333._tag === 1) {
            const pat_7350 = ({_tag: 10, _name: "PatConstruct", _val: [ctor_name, ({_tag: 1, _name: "Some", _val: ({_tag: 1, _name: "PatVar", _val: "__v0"})})]});
            const body_7352 = Typechecker$concat_str_exprs(({_hd: ({_tag: 3, _name: "EString", _val: (ctor_name + "(")}), _tl: ({_hd: ({_tag: 11, _name: "EApp", _val: [({_tag: 7, _name: "EVar", _val: "show"}), ({_tag: 7, _name: "EVar", _val: "__v0"})]}), _tl: ({_hd: ({_tag: 3, _name: "EString", _val: ")"}), _tl: null})})}));
            const _t7353 = [pat_7350, ({_tag: 0, _name: "None"}), body_7352];
            const _t7351 = _t7353;
            _t7334 = _t7351;
            break _t7335;
          }
          _match_fail("line 15950");
        }
        _t7331 = _t7334;
        break _t7332;
      }
      _match_fail("line 15950");
    }
    return _t7331;
  }
  const arms_7354 = List$map(_t7329, ctors);
  const body_7356 = ({_tag: 25, _name: "EMatch", _val: [({_tag: 7, _name: "EVar", _val: "__x"}), arms_7354, false]});
  const _t7357 = ["Show", ({_hd: inst_ty_7319, _tl: null}), constraints_7327, ({_hd: ["show", ({_hd: ({annot: ({_tag: 0, _name: "None"}), is_generated: false, name: "__x"}), _tl: null}), body_7356], _tl: null})];
  const _t7355 = _t7357;
  const _t7328 = _t7355;
  const _t7326 = _t7328;
  const _t7320 = _t7326;
  return _t7320;
}
function Typechecker$gen_show_record(type_params, name, fields) {
  const inst_ty_7358 = Typechecker$make_inst_ty(type_params, name);
  function _t7360(__p211) {
    let _t7362;
    const _t7361 = __p211;
    _t7363: {
      if (true) {
        const a = _t7361[2];
        _t7362 = a;
        break _t7363;
      }
      _match_fail("line 15950");
    }
    return _t7362;
  }
  const annots_7364 = List$map(_t7360, fields);
  const constraints_7366 = Typechecker$make_constraints("Show", type_params, annots_7364);
  function _t7368(i, __p212) {
    let _t7370;
    const _t7369 = __p212;
    _t7371: {
      if (true) {
        const fname = _t7369[1];
        const sf_7372 = ({_tag: 11, _name: "EApp", _val: [({_tag: 7, _name: "EVar", _val: "show"}), ({_tag: 18, _name: "EField", _val: [({_tag: 7, _name: "EVar", _val: "__x"}), fname]})]});
        let _t7374;
        if ((i === 0)) {
          _t7374 = ({_hd: ({_tag: 3, _name: "EString", _val: (fname + " = ")}), _tl: ({_hd: sf_7372, _tl: null})});
        } else {
          _t7374 = ({_hd: ({_tag: 3, _name: "EString", _val: ("; " + (fname + " = "))}), _tl: ({_hd: sf_7372, _tl: null})});
        }
        const _t7373 = _t7374;
        _t7370 = _t7373;
        break _t7371;
      }
      _match_fail("line 15950");
    }
    return _t7370;
  }
  const parts_7375 = List$concat(({_hd: ({_tag: 3, _name: "EString", _val: "{ "}), _tl: null}), List$concat(List$flatten(List$mapi(_t7368, fields)), ({_hd: ({_tag: 3, _name: "EString", _val: " }"}), _tl: null})));
  const body_7377 = Typechecker$concat_str_exprs(parts_7375);
  const _t7378 = ["Show", ({_hd: inst_ty_7358, _tl: null}), constraints_7366, ({_hd: ["show", ({_hd: ({annot: ({_tag: 0, _name: "None"}), is_generated: false, name: "__x"}), _tl: null}), body_7377], _tl: null})];
  const _t7376 = _t7378;
  const _t7367 = _t7376;
  const _t7365 = _t7367;
  const _t7359 = _t7365;
  return _t7359;
}
function Typechecker$gen_eq_variant(type_params, name, ctors) {
  const inst_ty_7379 = Typechecker$make_inst_ty(type_params, name);
  function _t7381(__p213) {
    let _t7383;
    const _t7382 = __p213;
    _t7384: {
      if (true) {
        const a = _t7382[1];
        _t7383 = a;
        break _t7384;
      }
      _match_fail("line 15950");
    }
    return _t7383;
  }
  const annots_7385 = List$filter_map(_t7381, ctors);
  const constraints_7387 = Typechecker$make_constraints("Eq", type_params, annots_7385);
  function _t7389(__x) {
    let _t7391;
    const _t7390 = __x;
    _t7392: {
      if (_t7390 === null) {
        _t7391 = ({_tag: 2, _name: "EBool", _val: true});
        break _t7392;
      }
      if (_t7390 !== null && _t7390._tl === null) {
        const e = _t7390._hd;
        _t7391 = e;
        break _t7392;
      }
      if (_t7390 !== null) {
        const first = _t7390._hd;
        const rest = _t7390._tl;
        function _t7393(a, e) {
          return ({_tag: 13, _name: "EBinop", _val: [({_tag: 11, _name: "And"}), a, e]});
        }
        _t7391 = List$fold(_t7393, first, rest);
        break _t7392;
      }
      _match_fail("line 15950");
    }
    return _t7391;
  }
  const and_exprs_7394 = _t7389;
  function _t7396(__p214) {
    let _t7398;
    const _t7397 = __p214;
    _t7399: {
      if (true) {
        const ctor_name = _t7397[0];
        const arg_annot = _t7397[1];
        let _t7401;
        const _t7400 = arg_annot;
        _t7402: {
          if (_t7400._tag === 0) {
            const pat_7403 = ({_tag: 7, _name: "PatTuple", _val: ({_hd: ({_tag: 10, _name: "PatConstruct", _val: [ctor_name, ({_tag: 0, _name: "None"})]}), _tl: ({_hd: ({_tag: 10, _name: "PatConstruct", _val: [ctor_name, ({_tag: 0, _name: "None"})]}), _tl: null})})});
            const _t7404 = [pat_7403, ({_tag: 0, _name: "None"}), ({_tag: 2, _name: "EBool", _val: true})];
            _t7401 = _t7404;
            break _t7402;
          }
          if (_t7400._tag === 1 && _t7400._val._tag === 6) {
            const tys = _t7400._val._val;
            const n_7405 = List$length(tys);
            function _t7407(i) {
              return ("__v" + __dict_Show_int.show(i));
            }
            const vs_7408 = List$init(n_7405, _t7407);
            function _t7410(i) {
              return ("__w" + __dict_Show_int.show(i));
            }
            const ws_7411 = List$init(n_7405, _t7410);
            function _t7413(v) {
              return ({_tag: 1, _name: "PatVar", _val: v});
            }
            const lp_7414 = ({_tag: 10, _name: "PatConstruct", _val: [ctor_name, ({_tag: 1, _name: "Some", _val: ({_tag: 7, _name: "PatTuple", _val: List$map(_t7413, vs_7408)})})]});
            function _t7416(v) {
              return ({_tag: 1, _name: "PatVar", _val: v});
            }
            const rp_7417 = ({_tag: 10, _name: "PatConstruct", _val: [ctor_name, ({_tag: 1, _name: "Some", _val: ({_tag: 7, _name: "PatTuple", _val: List$map(_t7416, ws_7411)})})]});
            function _t7419(v, w) {
              return ({_tag: 13, _name: "EBinop", _val: [({_tag: 5, _name: "Eq"}), ({_tag: 7, _name: "EVar", _val: v}), ({_tag: 7, _name: "EVar", _val: w})]});
            }
            const eqs_7420 = List$map2(_t7419, vs_7408, ws_7411);
            const _t7421 = [({_tag: 7, _name: "PatTuple", _val: ({_hd: lp_7414, _tl: ({_hd: rp_7417, _tl: null})})}), ({_tag: 0, _name: "None"}), and_exprs_7394(eqs_7420)];
            const _t7418 = _t7421;
            const _t7415 = _t7418;
            const _t7412 = _t7415;
            const _t7409 = _t7412;
            const _t7406 = _t7409;
            _t7401 = _t7406;
            break _t7402;
          }
          if (_t7400._tag === 1) {
            const lp_7422 = ({_tag: 10, _name: "PatConstruct", _val: [ctor_name, ({_tag: 1, _name: "Some", _val: ({_tag: 1, _name: "PatVar", _val: "__v0"})})]});
            const rp_7424 = ({_tag: 10, _name: "PatConstruct", _val: [ctor_name, ({_tag: 1, _name: "Some", _val: ({_tag: 1, _name: "PatVar", _val: "__w0"})})]});
            const _t7425 = [({_tag: 7, _name: "PatTuple", _val: ({_hd: lp_7422, _tl: ({_hd: rp_7424, _tl: null})})}), ({_tag: 0, _name: "None"}), ({_tag: 13, _name: "EBinop", _val: [({_tag: 5, _name: "Eq"}), ({_tag: 7, _name: "EVar", _val: "__v0"}), ({_tag: 7, _name: "EVar", _val: "__w0"})]})];
            const _t7423 = _t7425;
            _t7401 = _t7423;
            break _t7402;
          }
          _match_fail("line 15950");
        }
        _t7398 = _t7401;
        break _t7399;
      }
      _match_fail("line 15950");
    }
    return _t7398;
  }
  const arms_7426 = List$map(_t7396, ctors);
  const arms_7428 = List$concat(arms_7426, ({_hd: [({_tag: 0, _name: "PatWild"}), ({_tag: 0, _name: "None"}), ({_tag: 2, _name: "EBool", _val: false})], _tl: null}));
  const eq_body_7430 = ({_tag: 25, _name: "EMatch", _val: [({_tag: 15, _name: "ETuple", _val: ({_hd: ({_tag: 7, _name: "EVar", _val: "__a"}), _tl: ({_hd: ({_tag: 7, _name: "EVar", _val: "__b"}), _tl: null})})}), arms_7428, false]});
  function _t7432(__p215) {
    let _t7434;
    const _t7433 = __p215;
    _t7435: {
      if (true) {
        const p = _t7433[0];
        const g = _t7433[1];
        const e = _t7433[2];
        _t7434 = [p, g, e];
        break _t7435;
      }
      _match_fail("line 15950");
    }
    return _t7434;
  }
  const neq_body_7436 = ({_tag: 14, _name: "EUnop", _val: [({_tag: 1, _name: "Not"}), ({_tag: 25, _name: "EMatch", _val: [({_tag: 15, _name: "ETuple", _val: ({_hd: ({_tag: 7, _name: "EVar", _val: "__a"}), _tl: ({_hd: ({_tag: 7, _name: "EVar", _val: "__b"}), _tl: null})})}), List$map(_t7432, arms_7428), false]})]});
  const _t7437 = ["Eq", ({_hd: inst_ty_7379, _tl: null}), constraints_7387, ({_hd: ["=", ({_hd: ({annot: ({_tag: 0, _name: "None"}), is_generated: false, name: "__a"}), _tl: ({_hd: ({annot: ({_tag: 0, _name: "None"}), is_generated: false, name: "__b"}), _tl: null})}), eq_body_7430], _tl: ({_hd: ["<>", ({_hd: ({annot: ({_tag: 0, _name: "None"}), is_generated: false, name: "__a"}), _tl: ({_hd: ({annot: ({_tag: 0, _name: "None"}), is_generated: false, name: "__b"}), _tl: null})}), neq_body_7436], _tl: null})})];
  const _t7431 = _t7437;
  const _t7429 = _t7431;
  const _t7427 = _t7429;
  const _t7395 = _t7427;
  const _t7388 = _t7395;
  const _t7386 = _t7388;
  const _t7380 = _t7386;
  return _t7380;
}
function Typechecker$gen_eq_record(type_params, name, fields) {
  const inst_ty_7438 = Typechecker$make_inst_ty(type_params, name);
  function _t7440(__p216) {
    let _t7442;
    const _t7441 = __p216;
    _t7443: {
      if (true) {
        const a = _t7441[2];
        _t7442 = a;
        break _t7443;
      }
      _match_fail("line 15950");
    }
    return _t7442;
  }
  const annots_7444 = List$map(_t7440, fields);
  const constraints_7446 = Typechecker$make_constraints("Eq", type_params, annots_7444);
  function _t7448(__p217) {
    let _t7450;
    const _t7449 = __p217;
    _t7451: {
      if (true) {
        const fname = _t7449[1];
        _t7450 = ({_tag: 13, _name: "EBinop", _val: [({_tag: 5, _name: "Eq"}), ({_tag: 18, _name: "EField", _val: [({_tag: 7, _name: "EVar", _val: "__a"}), fname]}), ({_tag: 18, _name: "EField", _val: [({_tag: 7, _name: "EVar", _val: "__b"}), fname]})]});
        break _t7451;
      }
      _match_fail("line 15950");
    }
    return _t7450;
  }
  const eqs_7452 = List$map(_t7448, fields);
  let _t7455;
  const _t7454 = eqs_7452;
  _t7456: {
    if (_t7454 === null) {
      _t7455 = ({_tag: 2, _name: "EBool", _val: true});
      break _t7456;
    }
    if (_t7454 !== null && _t7454._tl === null) {
      const e = _t7454._hd;
      _t7455 = e;
      break _t7456;
    }
    if (_t7454 !== null) {
      const first = _t7454._hd;
      const rest = _t7454._tl;
      function _t7457(a, e) {
        return ({_tag: 13, _name: "EBinop", _val: [({_tag: 11, _name: "And"}), a, e]});
      }
      _t7455 = List$fold(_t7457, first, rest);
      break _t7456;
    }
    _match_fail("line 15950");
  }
  const eq_body_7458 = _t7455;
  const neq_body_7460 = ({_tag: 14, _name: "EUnop", _val: [({_tag: 1, _name: "Not"}), eq_body_7458]});
  const _t7461 = ["Eq", ({_hd: inst_ty_7438, _tl: null}), constraints_7446, ({_hd: ["=", ({_hd: ({annot: ({_tag: 0, _name: "None"}), is_generated: false, name: "__a"}), _tl: ({_hd: ({annot: ({_tag: 0, _name: "None"}), is_generated: false, name: "__b"}), _tl: null})}), eq_body_7458], _tl: ({_hd: ["<>", ({_hd: ({annot: ({_tag: 0, _name: "None"}), is_generated: false, name: "__a"}), _tl: ({_hd: ({annot: ({_tag: 0, _name: "None"}), is_generated: false, name: "__b"}), _tl: null})}), neq_body_7460], _tl: null})})];
  const _t7459 = _t7461;
  const _t7453 = _t7459;
  const _t7447 = _t7453;
  const _t7445 = _t7447;
  const _t7439 = _t7445;
  return _t7439;
}
function Typechecker$generate_derived_instance(type_params, name, def, class_name) {
  let _t7463;
  const _t7462 = [class_name, def];
  _t7464: {
    if (_t7462[1]._tag === 0) {
      const ctors = _t7462[1]._val;
      function _t7465(__p218) {
        let _t7467;
        const _t7466 = __p218;
        _t7468: {
          if (true) {
            const ret = _t7466[2];
            _t7467 = !_eq(ret, ({_tag: 0, _name: "None"}));
            break _t7468;
          }
          _match_fail("line 15950");
        }
        return _t7467;
      }
      if (List$exists(_t7465, ctors)) {
        _t7463 = Typechecker$error(((("cannot derive " + __dict_Show_string.show(class_name)) + " for GADT type ") + __dict_Show_string.show(name)));
        break _t7464;
      }
    }
    if (_t7462[0] === "Show" && _t7462[1]._tag === 0) {
      const ctors = _t7462[1]._val;
      _t7463 = ({_tag: 1, _name: "Some", _val: Typechecker$gen_show_variant(type_params, name, ctors)});
      break _t7464;
    }
    if (_t7462[0] === "Show" && _t7462[1]._tag === 1) {
      const fields = _t7462[1]._val;
      _t7463 = ({_tag: 1, _name: "Some", _val: Typechecker$gen_show_record(type_params, name, fields)});
      break _t7464;
    }
    if (_t7462[0] === "Eq" && _t7462[1]._tag === 0) {
      const ctors = _t7462[1]._val;
      _t7463 = ({_tag: 1, _name: "Some", _val: Typechecker$gen_eq_variant(type_params, name, ctors)});
      break _t7464;
    }
    if (_t7462[0] === "Eq" && _t7462[1]._tag === 1) {
      const fields = _t7462[1]._val;
      _t7463 = ({_tag: 1, _name: "Some", _val: Typechecker$gen_eq_record(type_params, name, fields)});
      break _t7464;
    }
    if (true) {
      _t7463 = ({_tag: 0, _name: "None"});
      break _t7464;
    }
    _match_fail("line 15950");
  }
  return _t7463;
}
function Typechecker$process_module_def(ctx, level, mod_name, items) {
  let _t7470;
  const _t7469 = ctx.current_module;
  _t7471: {
    if (_t7469._tag === 0) {
      _t7470 = (mod_name + ".");
      break _t7471;
    }
    if (_t7469._tag === 1) {
      const parent = _t7469._val;
      _t7470 = (parent + (mod_name + "."));
      break _t7471;
    }
    _match_fail("line 15950");
  }
  const prefix_7472 = _t7470;
  const __rec_upd_7474 = ctx;
  const _t7475 = ({constraint_tvars: __rec_upd_7474.constraint_tvars, current_eff: __rec_upd_7474.current_eff, current_module: ({_tag: 1, _name: "Some", _val: prefix_7472}), inside_handler: __rec_upd_7474.inside_handler, loop_info: __rec_upd_7474.loop_info, mutable_vars: __rec_upd_7474.mutable_vars, return_type: __rec_upd_7474.return_type, return_used: __rec_upd_7474.return_used, type_env: __rec_upd_7474.type_env, vars: __rec_upd_7474.vars});
  const sub_ctx_7476 = _t7475;
  const pub_vars_7478 = Ref$create(null);
  const pub_mutable_vars_7480 = Ref$create(null);
  const pub_types_7482 = Ref$create(null);
  const opaque_types_7484 = Ref$create(null);
  const pub_constructors_7486 = Ref$create(null);
  const all_instances_7488 = Ref$create(null);
  const submodules_7490 = Ref$create(null);
  const pub_classes_7492 = Ref$create(null);
  const typed_decls_7494 = Ref$create(null);
  function _t7496(sub_ctx, item) {
    let _t7498;
    const _t7497 = Typechecker$check_module_item(sub_ctx, level, prefix_7472, item, pub_vars_7478, pub_mutable_vars_7480, pub_types_7482, opaque_types_7484, pub_constructors_7486, all_instances_7488, submodules_7490, pub_classes_7492, typed_decls_7494);
    _t7499: {
      if (true) {
        const sub_ctx$p = _t7497[0];
        const tdecl = _t7497[1];
        Ref$set(typed_decls_7494, ({_hd: tdecl, _tl: Ref$get(typed_decls_7494)}));
        _t7498 = sub_ctx$p;
        break _t7499;
      }
      _match_fail("line 15950");
    }
    return _t7498;
  }
  const sub_ctx_7500 = List$fold(_t7496, sub_ctx_7476, items);
  const minfo_7502 = ({mod_instances: Ref$get(all_instances_7488), mod_name: mod_name, mod_opaque_types: Ref$get(opaque_types_7484), mod_pub_classes: Ref$get(pub_classes_7492), mod_pub_constructors: Ref$get(pub_constructors_7486), mod_pub_mutable_vars: Ref$get(pub_mutable_vars_7480), mod_pub_types: Ref$get(pub_types_7482), mod_pub_vars: Ref$get(pub_vars_7478), mod_submodules: Ref$get(submodules_7490)});
  const __rec_upd_7504 = sub_ctx_7500.type_env;
  const _t7505 = ({classes: __rec_upd_7504.classes, constructors: __rec_upd_7504.constructors, effects: __rec_upd_7504.effects, instances: __rec_upd_7504.instances, modules: ({_hd: [mod_name, minfo_7502], _tl: ctx.type_env.modules}), mutable_fields: __rec_upd_7504.mutable_fields, records: __rec_upd_7504.records, type_aliases: __rec_upd_7504.type_aliases, type_synonyms: __rec_upd_7504.type_synonyms, variants: __rec_upd_7504.variants});
  const outer_type_env_7506 = _t7505;
  const __rec_upd_7508 = outer_type_env_7506;
  const _t7509 = ({classes: __rec_upd_7508.classes, constructors: __rec_upd_7508.constructors, effects: __rec_upd_7508.effects, instances: __rec_upd_7508.instances, modules: __rec_upd_7508.modules, mutable_fields: __rec_upd_7508.mutable_fields, records: __rec_upd_7508.records, type_aliases: ctx.type_env.type_aliases, type_synonyms: __rec_upd_7508.type_synonyms, variants: __rec_upd_7508.variants});
  const outer_type_env_7510 = _t7509;
  function _t7512(vars, __p219) {
    let _t7514;
    const _t7513 = __p219;
    _t7515: {
      if (true) {
        const _mml$short = _t7513[0];
        const scheme = _t7513[1];
        const qualified_7516 = (prefix_7472 + _mml$short);
        const _t7517 = ({_hd: [qualified_7516, scheme], _tl: vars});
        _t7514 = _t7517;
        break _t7515;
      }
      _match_fail("line 15950");
    }
    return _t7514;
  }
  const outer_vars_7518 = List$fold(_t7512, ctx.vars, Ref$get(pub_vars_7478));
  function _t7520(te, __p220) {
    let _t7522;
    const _t7521 = __p220;
    _t7523: {
      if (true) {
        const _mml$short = _t7521[0];
        const info = _t7521[1];
        const qualified_7524 = (prefix_7472 + _mml$short);
        const __rec_upd_7526 = te;
        const _t7527 = ({classes: __rec_upd_7526.classes, constructors: ({_hd: [qualified_7524, info], _tl: te.constructors}), effects: __rec_upd_7526.effects, instances: __rec_upd_7526.instances, modules: __rec_upd_7526.modules, mutable_fields: __rec_upd_7526.mutable_fields, records: __rec_upd_7526.records, type_aliases: __rec_upd_7526.type_aliases, type_synonyms: __rec_upd_7526.type_synonyms, variants: __rec_upd_7526.variants});
        const _t7525 = _t7527;
        _t7522 = _t7525;
        break _t7523;
      }
      _match_fail("line 15950");
    }
    return _t7522;
  }
  const outer_type_env_7528 = List$fold(_t7520, outer_type_env_7510, Ref$get(pub_constructors_7486));
  function _t7530(i) {
    return i.inst_dict_name;
  }
  const existing_dict_names_7531 = List$map(_t7530, outer_type_env_7528.instances);
  function _t7533(inst) {
    return (!List$mem(inst.inst_dict_name, existing_dict_names_7531));
  }
  const new_insts_7534 = List$filter(_t7533, Ref$get(all_instances_7488));
  const __rec_upd_7536 = outer_type_env_7528;
  const _t7537 = ({classes: __rec_upd_7536.classes, constructors: __rec_upd_7536.constructors, effects: __rec_upd_7536.effects, instances: List$concat(new_insts_7534, outer_type_env_7528.instances), modules: __rec_upd_7536.modules, mutable_fields: __rec_upd_7536.mutable_fields, records: __rec_upd_7536.records, type_aliases: __rec_upd_7536.type_aliases, type_synonyms: __rec_upd_7536.type_synonyms, variants: __rec_upd_7536.variants});
  const outer_type_env_7538 = _t7537;
  function _t7540(mvs, _mml$short) {
    const qualified_7541 = (prefix_7472 + _mml$short);
    const _t7542 = ({_hd: qualified_7541, _tl: mvs});
    return _t7542;
  }
  const outer_mutable_vars_7543 = List$fold(_t7540, ctx.mutable_vars, Ref$get(pub_mutable_vars_7480));
  const __rec_upd_7545 = ctx;
  const _t7546 = ({constraint_tvars: __rec_upd_7545.constraint_tvars, current_eff: __rec_upd_7545.current_eff, current_module: __rec_upd_7545.current_module, inside_handler: __rec_upd_7545.inside_handler, loop_info: __rec_upd_7545.loop_info, mutable_vars: outer_mutable_vars_7543, return_type: __rec_upd_7545.return_type, return_used: __rec_upd_7545.return_used, type_env: outer_type_env_7538, vars: outer_vars_7518});
  const outer_ctx_7547 = _t7546;
  const _t7548 = [outer_ctx_7547, ({_tag: 9, _name: "TDModule", _val: [mod_name, List$rev(Ref$get(typed_decls_7494))]})];
  const _t7544 = _t7548;
  const _t7539 = _t7544;
  const _t7535 = _t7539;
  const _t7532 = _t7535;
  const _t7529 = _t7532;
  const _t7519 = _t7529;
  const _t7511 = _t7519;
  const _t7507 = _t7511;
  const _t7503 = _t7507;
  const _t7501 = _t7503;
  const _t7495 = _t7501;
  const _t7493 = _t7495;
  const _t7491 = _t7493;
  const _t7489 = _t7491;
  const _t7487 = _t7489;
  const _t7485 = _t7487;
  const _t7483 = _t7485;
  const _t7481 = _t7483;
  const _t7479 = _t7481;
  const _t7477 = _t7479;
  const _t7473 = _t7477;
  return _t7473;
}
function Typechecker$check_module_item(sub_ctx, level, prefix, item, pub_vars, pub_mutable_vars, pub_types, opaque_types, pub_constructors, all_instances, submodules, pub_classes, typed_decls) {
  const decl_7549 = item.decl;
  let _t7552;
  const _t7551 = decl_7549;
  _t7553: {
    if (_t7551._tag === 11) {
      const inner_name = _t7551._val[0];
      const inner_items = _t7551._val[1];
      let _t7555;
      const _t7554 = Typechecker$process_module_def(sub_ctx, level, inner_name, inner_items);
      _t7556: {
        if (true) {
          const sub_ctx$p = _t7554[0];
          const tdecl = _t7554[1];
          let _t7558;
          const _t7557 = item.vis;
          _t7559: {
            if (_t7557._tag === 0) {
              let _t7561;
              const _t7560 = Typechecker$find_module_in_env(sub_ctx$p.type_env, inner_name);
              _t7562: {
                if (_t7560._tag === 1) {
                  const inner_info = _t7560._val;
                  Ref$set(submodules, ({_hd: [inner_name, inner_info], _tl: Ref$get(submodules)}));
                  function _t7563(__p221) {
                    let _t7565;
                    const _t7564 = __p221;
                    _t7566: {
                      if (true) {
                        const _mml$short = _t7564[0];
                        const scheme = _t7564[1];
                        _t7565 = Ref$set(pub_vars, ({_hd: [(inner_name + ("." + _mml$short)), scheme], _tl: Ref$get(pub_vars)}));
                        break _t7566;
                      }
                      _match_fail("line 15950");
                    }
                    return _t7565;
                  }
                  List$iter(_t7563, inner_info.mod_pub_vars);
                  function _t7567(__p222) {
                    let _t7569;
                    const _t7568 = __p222;
                    _t7570: {
                      if (true) {
                        const _mml$short = _t7568[0];
                        const info = _t7568[1];
                        _t7569 = Ref$set(pub_constructors, ({_hd: [(inner_name + ("." + _mml$short)), info], _tl: Ref$get(pub_constructors)}));
                        break _t7570;
                      }
                      _match_fail("line 15950");
                    }
                    return _t7569;
                  }
                  _t7561 = List$iter(_t7567, inner_info.mod_pub_constructors);
                  break _t7562;
                }
                if (_t7560._tag === 0) {
                  _t7561 = undefined;
                  break _t7562;
                }
                _match_fail("line 15950");
              }
              _t7558 = _t7561;
              break _t7559;
            }
            if (true) {
              _t7558 = undefined;
              break _t7559;
            }
            _match_fail("line 15950");
          }
          _t7558;
          _t7555 = [sub_ctx$p, tdecl];
          break _t7556;
        }
        _match_fail("line 15950");
      }
      _t7552 = _t7555;
      break _t7553;
    }
    if (_t7551._tag === 4) {
      const type_params = _t7551._val[0];
      const name = _t7551._val[1];
      const def = _t7551._val[2];
      const deriving_ = _t7551._val[3];
      const qualified_name_7571 = (prefix + name);
      const __rec_upd_7573 = sub_ctx;
      const __rec_upd_7575 = sub_ctx.type_env;
      const _t7576 = ({classes: __rec_upd_7575.classes, constructors: __rec_upd_7575.constructors, effects: __rec_upd_7575.effects, instances: __rec_upd_7575.instances, modules: __rec_upd_7575.modules, mutable_fields: __rec_upd_7575.mutable_fields, records: __rec_upd_7575.records, type_aliases: ({_hd: [name, qualified_name_7571], _tl: sub_ctx.type_env.type_aliases}), type_synonyms: __rec_upd_7575.type_synonyms, variants: __rec_upd_7575.variants});
      const _t7574 = ({constraint_tvars: __rec_upd_7573.constraint_tvars, current_eff: __rec_upd_7573.current_eff, current_module: __rec_upd_7573.current_module, inside_handler: __rec_upd_7573.inside_handler, loop_info: __rec_upd_7573.loop_info, mutable_vars: __rec_upd_7573.mutable_vars, return_type: __rec_upd_7573.return_type, return_used: __rec_upd_7573.return_used, type_env: _t7576, vars: __rec_upd_7573.vars});
      const sub_ctx_with_alias_7577 = _t7574;
      const sub_ctx$p_7579 = Typechecker$process_type_def(sub_ctx_with_alias_7577, type_params, qualified_name_7571, def);
      let _t7582;
      const _t7581 = item.vis;
      _t7583: {
        if (_t7581._tag === 0) {
          Ref$set(pub_types, ({_hd: qualified_name_7571, _tl: Ref$get(pub_types)}));
          let _t7585;
          const _t7584 = def;
          _t7586: {
            if (_t7584._tag === 0) {
              const ctors = _t7584._val;
              function _t7587(__p223) {
                let _t7589;
                const _t7588 = __p223;
                _t7590: {
                  if (true) {
                    const ctor_name = _t7588[0];
                    let _t7592;
                    const _t7591 = List$assoc_opt(ctor_name, sub_ctx$p_7579.type_env.constructors);
                    _t7593: {
                      if (_t7591._tag === 1) {
                        const info = _t7591._val;
                        const __rec_upd_7594 = info;
                        const _t7595 = ({ctor_arg_ty: __rec_upd_7594.ctor_arg_ty, ctor_existentials: __rec_upd_7594.ctor_existentials, ctor_num_params: __rec_upd_7594.ctor_num_params, ctor_return_ty_params: __rec_upd_7594.ctor_return_ty_params, ctor_type_name: qualified_name_7571});
                        const qual_info_7596 = _t7595;
                        const _t7597 = Ref$set(pub_constructors, ({_hd: [ctor_name, qual_info_7596], _tl: Ref$get(pub_constructors)}));
                        _t7592 = _t7597;
                        break _t7593;
                      }
                      if (_t7591._tag === 0) {
                        _t7592 = undefined;
                        break _t7593;
                      }
                      _match_fail("line 15950");
                    }
                    _t7589 = _t7592;
                    break _t7590;
                  }
                  _match_fail("line 15950");
                }
                return _t7589;
              }
              _t7585 = List$iter(_t7587, ctors);
              break _t7586;
            }
            if ((_t7584._tag === 1 || _t7584._tag === 2)) {
              _t7585 = undefined;
              break _t7586;
            }
            _match_fail("line 15950");
          }
          _t7582 = _t7585;
          break _t7583;
        }
        if (_t7581._tag === 2) {
          Ref$set(pub_types, ({_hd: qualified_name_7571, _tl: Ref$get(pub_types)}));
          _t7582 = Ref$set(opaque_types, ({_hd: qualified_name_7571, _tl: Ref$get(opaque_types)}));
          break _t7583;
        }
        if (_t7581._tag === 1) {
          _t7582 = undefined;
          break _t7583;
        }
        _match_fail("line 15950");
      }
      _t7582;
      function _t7598(ctx, cls) {
        let _t7600;
        const _t7599 = Typechecker$generate_derived_instance(type_params, name, def, cls);
        _t7601: {
          if (_t7599._tag === 1) {
            const class_name = _t7599._val[0];
            const inst_tys = _t7599._val[1];
            const constraints = _t7599._val[2];
            const methods = _t7599._val[3];
            let _t7603;
            const _t7602 = Typechecker$process_instance_def(ctx, level, class_name, inst_tys, constraints, methods);
            _t7604: {
              if (true) {
                const ctx$p = _t7602[0];
                const tdecl = _t7602[1];
                Ref$set(typed_decls, ({_hd: tdecl, _tl: Ref$get(typed_decls)}));
                Ref$set(all_instances, ctx$p.type_env.instances);
                _t7603 = ctx$p;
                break _t7604;
              }
              _match_fail("line 15950");
            }
            _t7600 = _t7603;
            break _t7601;
          }
          if (_t7599._tag === 0) {
            _t7600 = Typechecker$error(((("cannot derive " + __dict_Show_string.show(cls)) + " for type ") + __dict_Show_string.show(name)));
            break _t7601;
          }
          _match_fail("line 15950");
        }
        return _t7600;
      }
      const sub_ctx$p_7605 = List$fold(_t7598, sub_ctx$p_7579, deriving_);
      const _t7606 = [sub_ctx$p_7605, ({_tag: 4, _name: "TDType", _val: [qualified_name_7571, def]})];
      const _t7580 = _t7606;
      const _t7578 = _t7580;
      const _t7572 = _t7578;
      _t7552 = _t7572;
      break _t7553;
    }
    if (_t7551._tag === 0) {
      const name = _t7551._val[0];
      const params = _t7551._val[1];
      const ret_annot = _t7551._val[2];
      const constraints = _t7551._val[3];
      const body = _t7551._val[4];
      const qualified_name_7607 = (prefix + name);
      let _t7609;
      if (!_eq(constraints, null)) {
        _t7609 = Typechecker$synth_constrained_fn(sub_ctx, level, constraints, params, ret_annot, body);
      } else {
        const full_body_7610 = Typechecker$wrap_params_decl(params, ret_annot, body);
        const te_7612 = Typechecker$synth(sub_ctx, (level + 1), full_body_7610);
        Typechecker$improve_fundeps_in_expr(sub_ctx.vars, sub_ctx.type_env, te_7612);
        let _t7614;
        if ((_eq(params, null) && (!Typechecker$is_syntactic_value(body)))) {
          _t7614 = Typechecker$mono_scheme(te_7612.ty);
        } else {
          _t7614 = Typechecker$resolve_let_constraints(Types$empty_type_env, level, null, params, ret_annot, te_7612.ty, Hashtbl$create(0));
        }
        const scheme_7615 = _t7614;
        const scheme_7617 = Typechecker$infer_implicit_constraints("", sub_ctx.type_env, sub_ctx.vars, te_7612, scheme_7615);
        const scheme_7619 = Typechecker$infer_record_evidence(sub_ctx.vars, te_7612, scheme_7617);
        const _t7620 = [te_7612, scheme_7619];
        const _t7618 = _t7620;
        const _t7616 = _t7618;
        const _t7613 = _t7616;
        const _t7611 = _t7613;
        _t7609 = _t7611;
      }
      let _t7622;
      const _t7621 = _t7609;
      _t7623: {
        if (true) {
          const te = _t7621[0];
          const scheme = _t7621[1];
          const sub_ctx$p_7624 = Typechecker$extend_var(sub_ctx, name, scheme);
          const sub_ctx$p_7626 = Typechecker$extend_var(sub_ctx$p_7624, qualified_name_7607, scheme);
          let _t7629;
          const _t7628 = item.vis;
          _t7630: {
            if (_t7628._tag === 0) {
              _t7629 = Ref$set(pub_vars, ({_hd: [name, scheme], _tl: Ref$get(pub_vars)}));
              break _t7630;
            }
            if (true) {
              _t7629 = undefined;
              break _t7630;
            }
            _match_fail("line 15950");
          }
          _t7629;
          const _t7627 = [sub_ctx$p_7626, ({_tag: 0, _name: "TDLet", _val: [qualified_name_7607, te]})];
          const _t7625 = _t7627;
          _t7622 = _t7625;
          break _t7623;
        }
        _match_fail("line 15950");
      }
      const _t7608 = _t7622;
      _t7552 = _t7608;
      break _t7553;
    }
    if (_t7551._tag === 1) {
      const name = _t7551._val[0];
      const body = _t7551._val[1];
      const qualified_name_7631 = (prefix + name);
      const te_7633 = Typechecker$synth(sub_ctx, (level + 1), body);
      const scheme_7635 = Typechecker$mono_scheme(te_7633.ty);
      const sub_ctx$p_7637 = Typechecker$extend_var_mutable(sub_ctx, name, scheme_7635);
      const sub_ctx$p_7639 = Typechecker$extend_var_mutable(sub_ctx$p_7637, qualified_name_7631, scheme_7635);
      let _t7642;
      const _t7641 = item.vis;
      _t7643: {
        if (_t7641._tag === 0) {
          Ref$set(pub_vars, ({_hd: [name, scheme_7635], _tl: Ref$get(pub_vars)}));
          _t7642 = Ref$set(pub_mutable_vars, ({_hd: name, _tl: Ref$get(pub_mutable_vars)}));
          break _t7643;
        }
        if (true) {
          _t7642 = undefined;
          break _t7643;
        }
        _match_fail("line 15950");
      }
      _t7642;
      const _t7640 = [sub_ctx$p_7639, ({_tag: 1, _name: "TDLetMut", _val: [qualified_name_7631, te_7633]})];
      const _t7638 = _t7640;
      const _t7636 = _t7638;
      const _t7634 = _t7636;
      const _t7632 = _t7634;
      _t7552 = _t7632;
      break _t7553;
    }
    if (_t7551._tag === 2) {
      const name = _t7551._val[0];
      const type_params = _t7551._val[1];
      const params = _t7551._val[2];
      const ret_annot = _t7551._val[3];
      const constraints = _t7551._val[4];
      const body = _t7551._val[5];
      const qualified_name_7644 = (prefix + name);
      let _t7646;
      if (!_eq(type_params, null)) {
        _t7646 = Typechecker$synth_poly_rec_fn(sub_ctx, level, name, qualified_name_7644, type_params, params, ret_annot, body);
      } else {
        let _t7647;
        if (!_eq(constraints, null)) {
          const fn_var_7648 = Types$new_tvar((level + 1));
          const sub_ctx_self_7650 = Typechecker$extend_var_mono(sub_ctx, name, fn_var_7648);
          const sub_ctx_self_7652 = Typechecker$extend_var_mono(sub_ctx_self_7650, qualified_name_7644, fn_var_7648);
          let _t7655;
          const _t7654 = Typechecker$synth_constrained_fn(sub_ctx_self_7652, level, constraints, params, ret_annot, body);
          _t7656: {
            if (true) {
              const te = _t7654[0];
              const scheme = _t7654[1];
              Typechecker$try_unify(fn_var_7648, te.ty);
              _t7655 = [te, scheme];
              break _t7656;
            }
            _match_fail("line 15950");
          }
          const _t7653 = _t7655;
          const _t7651 = _t7653;
          const _t7649 = _t7651;
          _t7647 = _t7649;
        } else {
          const full_body_7657 = Typechecker$wrap_params_decl(params, ret_annot, body);
          const fn_var_7659 = Types$new_tvar((level + 1));
          const sub_ctx$p_7661 = Typechecker$extend_var_mono(sub_ctx, name, fn_var_7659);
          const sub_ctx$p_7663 = Typechecker$extend_var_mono(sub_ctx$p_7661, qualified_name_7644, fn_var_7659);
          const fn_te_7665 = Typechecker$synth(sub_ctx$p_7663, (level + 1), full_body_7657);
          Typechecker$try_unify(fn_var_7659, fn_te_7665.ty);
          Typechecker$improve_fundeps_in_expr(sub_ctx.vars, sub_ctx.type_env, fn_te_7665);
          const scheme_7667 = Typechecker$resolve_let_constraints(Types$empty_type_env, level, null, params, ret_annot, fn_te_7665.ty, Hashtbl$create(0));
          const scheme_7669 = Typechecker$infer_implicit_constraints(name, sub_ctx.type_env, sub_ctx.vars, fn_te_7665, scheme_7667);
          const scheme_7671 = Typechecker$infer_record_evidence(sub_ctx.vars, fn_te_7665, scheme_7669);
          const _t7672 = [fn_te_7665, scheme_7671];
          const _t7670 = _t7672;
          const _t7668 = _t7670;
          const _t7666 = _t7668;
          const _t7664 = _t7666;
          const _t7662 = _t7664;
          const _t7660 = _t7662;
          const _t7658 = _t7660;
          _t7647 = _t7658;
        }
        _t7646 = _t7647;
      }
      let _t7674;
      const _t7673 = _t7646;
      _t7675: {
        if (true) {
          const fn_te = _t7673[0];
          const scheme = _t7673[1];
          const sub_ctx$p$p_7676 = Typechecker$extend_var(sub_ctx, name, scheme);
          const sub_ctx$p$p_7678 = Typechecker$extend_var(sub_ctx$p$p_7676, qualified_name_7644, scheme);
          let _t7681;
          const _t7680 = item.vis;
          _t7682: {
            if (_t7680._tag === 0) {
              _t7681 = Ref$set(pub_vars, ({_hd: [name, scheme], _tl: Ref$get(pub_vars)}));
              break _t7682;
            }
            if (true) {
              _t7681 = undefined;
              break _t7682;
            }
            _match_fail("line 15950");
          }
          _t7681;
          const _t7679 = [sub_ctx$p$p_7678, ({_tag: 2, _name: "TDLetRec", _val: [qualified_name_7644, fn_te]})];
          const _t7677 = _t7679;
          _t7674 = _t7677;
          break _t7675;
        }
        _match_fail("line 15950");
      }
      const _t7645 = _t7674;
      _t7552 = _t7645;
      break _t7553;
    }
    if (_t7551._tag === 7) {
      const name = _t7551._val[0];
      const tyvars = _t7551._val[1];
      const fundeps = _t7551._val[2];
      const methods = _t7551._val[3];
      const qualified_7683 = (prefix + name);
      let _t7686;
      const _t7685 = Typechecker$process_class_def(sub_ctx, qualified_7683, tyvars, fundeps, methods);
      _t7687: {
        if (true) {
          const sub_ctx$p = _t7685[0];
          const tdecl = _t7685[1];
          const __rec_upd_7688 = sub_ctx$p;
          const __rec_upd_7690 = sub_ctx$p.type_env;
          const _t7691 = ({classes: __rec_upd_7690.classes, constructors: __rec_upd_7690.constructors, effects: __rec_upd_7690.effects, instances: __rec_upd_7690.instances, modules: __rec_upd_7690.modules, mutable_fields: __rec_upd_7690.mutable_fields, records: __rec_upd_7690.records, type_aliases: ({_hd: [name, qualified_7683], _tl: sub_ctx$p.type_env.type_aliases}), type_synonyms: __rec_upd_7690.type_synonyms, variants: __rec_upd_7690.variants});
          const _t7689 = ({constraint_tvars: __rec_upd_7688.constraint_tvars, current_eff: __rec_upd_7688.current_eff, current_module: __rec_upd_7688.current_module, inside_handler: __rec_upd_7688.inside_handler, loop_info: __rec_upd_7688.loop_info, mutable_vars: __rec_upd_7688.mutable_vars, return_type: __rec_upd_7688.return_type, return_used: __rec_upd_7688.return_used, type_env: _t7691, vars: __rec_upd_7688.vars});
          const sub_ctx$p_7692 = _t7689;
          let _t7695;
          const _t7694 = item.vis;
          _t7696: {
            if (_t7694._tag === 0) {
              Ref$set(pub_classes, ({_hd: qualified_7683, _tl: Ref$get(pub_classes)}));
              function _t7697(__p224) {
                let _t7699;
                const _t7698 = __p224;
                _t7700: {
                  if (true) {
                    const mname = _t7698[0];
                    let _t7702;
                    const _t7701 = List$assoc_opt(mname, sub_ctx$p_7692.vars);
                    _t7703: {
                      if (_t7701._tag === 1) {
                        const scheme = _t7701._val;
                        _t7702 = Ref$set(pub_vars, ({_hd: [mname, scheme], _tl: Ref$get(pub_vars)}));
                        break _t7703;
                      }
                      if (_t7701._tag === 0) {
                        _t7702 = undefined;
                        break _t7703;
                      }
                      _match_fail("line 15950");
                    }
                    _t7699 = _t7702;
                    break _t7700;
                  }
                  _match_fail("line 15950");
                }
                return _t7699;
              }
              _t7695 = List$iter(_t7697, methods);
              break _t7696;
            }
            if (true) {
              _t7695 = undefined;
              break _t7696;
            }
            _match_fail("line 15950");
          }
          _t7695;
          const _t7693 = [sub_ctx$p_7692, tdecl];
          _t7686 = _t7693;
          break _t7687;
        }
        _match_fail("line 15950");
      }
      const _t7684 = _t7686;
      _t7552 = _t7684;
      break _t7553;
    }
    if (_t7551._tag === 8) {
      const class_name = _t7551._val[0];
      const inst_ty_annots = _t7551._val[1];
      const constraints = _t7551._val[2];
      const methods = _t7551._val[3];
      let _t7705;
      const _t7704 = Typechecker$process_instance_def(sub_ctx, level, class_name, inst_ty_annots, constraints, methods);
      _t7706: {
        if (true) {
          const sub_ctx$p = _t7704[0];
          const tdecl = _t7704[1];
          function _t7707(inst) {
            function _t7708(prev) {
              return (prev.inst_dict_name === inst.inst_dict_name);
            }
            return (!List$exists(_t7708, sub_ctx.type_env.instances));
          }
          const new_insts_7709 = List$filter(_t7707, sub_ctx$p.type_env.instances);
          Ref$set(all_instances, List$concat(new_insts_7709, Ref$get(all_instances)));
          const _t7710 = [sub_ctx$p, tdecl];
          _t7705 = _t7710;
          break _t7706;
        }
        _match_fail("line 15950");
      }
      _t7552 = _t7705;
      break _t7553;
    }
    if (_t7551._tag === 9) {
      const name = _t7551._val[0];
      const type_params = _t7551._val[1];
      const ops = _t7551._val[2];
      const tvars_7711 = Hashtbl$create(4);
      function _t7713(i, p) {
        return _call(Hashtbl$set, [__dict_Hash_string, __dict_Eq_string, tvars_7711, p, ({_tag: 17, _name: "TGen", _val: i})]);
      }
      List$iteri(_t7713, type_params);
      function _t7714(__p225) {
        let _t7716;
        const _t7715 = __p225;
        _t7717: {
          if (true) {
            const op_name = _t7715[0];
            const annot = _t7715[1];
            const ty_7718 = Typechecker$resolve_ty_annot_shared(sub_ctx, 0, tvars_7711, annot);
            const _t7719 = [op_name, ty_7718];
            _t7716 = _t7719;
            break _t7717;
          }
          _match_fail("line 15950");
        }
        return _t7716;
      }
      const resolved_ops_7720 = List$map(_t7714, ops);
      const effect_def_7722 = ({effect_name: name, effect_ops: resolved_ops_7720, effect_params: type_params});
      const __rec_upd_7724 = sub_ctx.type_env;
      const _t7725 = ({classes: __rec_upd_7724.classes, constructors: __rec_upd_7724.constructors, effects: ({_hd: effect_def_7722, _tl: sub_ctx.type_env.effects}), instances: __rec_upd_7724.instances, modules: __rec_upd_7724.modules, mutable_fields: __rec_upd_7724.mutable_fields, records: __rec_upd_7724.records, type_aliases: __rec_upd_7724.type_aliases, type_synonyms: __rec_upd_7724.type_synonyms, variants: __rec_upd_7724.variants});
      const type_env_7726 = _t7725;
      const __rec_upd_7728 = sub_ctx;
      const _t7729 = ({constraint_tvars: __rec_upd_7728.constraint_tvars, current_eff: __rec_upd_7728.current_eff, current_module: __rec_upd_7728.current_module, inside_handler: __rec_upd_7728.inside_handler, loop_info: __rec_upd_7728.loop_info, mutable_vars: __rec_upd_7728.mutable_vars, return_type: __rec_upd_7728.return_type, return_used: __rec_upd_7728.return_used, type_env: type_env_7726, vars: __rec_upd_7728.vars});
      const sub_ctx$p_7730 = _t7729;
      const _t7731 = [sub_ctx$p_7730, ({_tag: 7, _name: "TDEffect", _val: name})];
      const _t7727 = _t7731;
      const _t7723 = _t7727;
      const _t7721 = _t7723;
      const _t7712 = _t7721;
      _t7552 = _t7712;
      break _t7553;
    }
    if (_t7551._tag === 10) {
      const name = _t7551._val[0];
      const ty_annot = _t7551._val[1];
      const qualified_name_7732 = (prefix + name);
      const tvars_7734 = Hashtbl$create(4);
      const ty_7736 = Typechecker$resolve_ty_annot_shared(sub_ctx, 1, tvars_7734, ty_annot);
      const scheme_7738 = Types$generalize(0, ty_7736);
      const sub_ctx$p_7740 = Typechecker$extend_var(sub_ctx, name, scheme_7738);
      const sub_ctx$p_7742 = Typechecker$extend_var(sub_ctx$p_7740, qualified_name_7732, scheme_7738);
      let _t7745;
      const _t7744 = item.vis;
      _t7746: {
        if (_t7744._tag === 0) {
          _t7745 = Ref$set(pub_vars, ({_hd: [name, scheme_7738], _tl: Ref$get(pub_vars)}));
          break _t7746;
        }
        if (true) {
          _t7745 = undefined;
          break _t7746;
        }
        _match_fail("line 15950");
      }
      _t7745;
      const _t7743 = [sub_ctx$p_7742, ({_tag: 8, _name: "TDExtern", _val: [qualified_name_7732, scheme_7738]})];
      const _t7741 = _t7743;
      const _t7739 = _t7741;
      const _t7737 = _t7739;
      const _t7735 = _t7737;
      const _t7733 = _t7735;
      _t7552 = _t7733;
      break _t7553;
    }
    if (_t7551._tag === 6) {
      const expr = _t7551._val;
      const te_7747 = Typechecker$synth(sub_ctx, level, expr);
      const _t7748 = [sub_ctx, ({_tag: 5, _name: "TDExpr", _val: te_7747})];
      _t7552 = _t7748;
      break _t7553;
    }
    if (_t7551._tag === 12) {
      const mod_name = _t7551._val[0];
      const names_opt = _t7551._val[1];
      const sub_ctx$p_7749 = Typechecker$open_module_into_ctx(sub_ctx, mod_name, names_opt);
      let _t7752;
      const _t7751 = Typechecker$find_module_in_env(sub_ctx.type_env, mod_name);
      _t7753: {
        if (_t7751._tag === 1) {
          const m = _t7751._val;
          _t7752 = m;
          break _t7753;
        }
        if (_t7751._tag === 0) {
          _t7752 = Typechecker$error(("unknown module: " + __dict_Show_string.show(mod_name)));
          break _t7753;
        }
        _match_fail("line 15950");
      }
      const minfo_7754 = _t7752;
      function _t7756(qname) {
        function _t7757(c) {
          return (c.class_name === qname);
        }
        let _t7759;
        const _t7758 = List$find(_t7757, sub_ctx.type_env.classes);
        _t7760: {
          if (_t7758._tag === 1) {
            const cls = _t7758._val;
            _t7759 = List$map(fst, cls.class_methods);
            break _t7760;
          }
          if (_t7758._tag === 0) {
            _t7759 = null;
            break _t7760;
          }
          _match_fail("line 15950");
        }
        return _t7759;
      }
      const class_method_names_7761 = List$concat_map(_t7756, minfo_7754.mod_pub_classes);
      function _t7763(name) {
        let _t7765;
        const _t7764 = names_opt;
        _t7766: {
          if (_t7764._tag === 0) {
            _t7765 = true;
            break _t7766;
          }
          if (_t7764._tag === 1) {
            const names = _t7764._val;
            _t7765 = List$mem(name, names);
            break _t7766;
          }
          _match_fail("line 15950");
        }
        return _t7765;
      }
      const filter_7767 = _t7763;
      function _t7769(__p226) {
        let _t7771;
        const _t7770 = __p226;
        _t7772: {
          if (true) {
            const _mml$short = _t7770[0];
            const scheme = _t7770[1];
            let _t7773;
            if ((filter_7767(_mml$short) && (!List$mem(_mml$short, class_method_names_7761)))) {
              const qualified_dst_7774 = (prefix + _mml$short);
              const qualified_src_7776 = (mod_name + ("." + _mml$short));
              scheme;
              undefined;
              const _t7777 = ({_tag: 1, _name: "Some", _val: [qualified_dst_7774, qualified_src_7776]});
              const _t7775 = _t7777;
              _t7773 = _t7775;
            } else {
              _t7773 = ({_tag: 0, _name: "None"});
            }
            _t7771 = _t7773;
            break _t7772;
          }
          _match_fail("line 15950");
        }
        return _t7771;
      }
      const alias_pairs_7778 = List$filter_map(_t7769, minfo_7754.mod_pub_vars);
      function _t7780(ctx, __p227) {
        let _t7782;
        const _t7781 = __p227;
        _t7783: {
          if (true) {
            const _mml$short = _t7781[0];
            const scheme = _t7781[1];
            let _t7784;
            if ((filter_7767(_mml$short) && (!List$mem(_mml$short, class_method_names_7761)))) {
              _t7784 = Typechecker$extend_var(ctx, (prefix + _mml$short), scheme);
            } else {
              _t7784 = ctx;
            }
            _t7782 = _t7784;
            break _t7783;
          }
          _match_fail("line 15950");
        }
        return _t7782;
      }
      const sub_ctx$p_7785 = List$fold(_t7780, sub_ctx$p_7749, minfo_7754.mod_pub_vars);
      const _t7786 = [sub_ctx$p_7785, ({_tag: 10, _name: "TDOpen", _val: alias_pairs_7778})];
      const _t7779 = _t7786;
      const _t7768 = _t7779;
      const _t7762 = _t7768;
      const _t7755 = _t7762;
      const _t7750 = _t7755;
      _t7552 = _t7750;
      break _t7553;
    }
    if (_t7551._tag === 3) {
      const bindings = _t7551._val;
      function _t7787(__p228) {
        let _t7789;
        const _t7788 = __p228;
        _t7790: {
          if (true) {
            const tp = _t7788[1];
            _t7789 = !_eq(tp, null);
            break _t7790;
          }
          _match_fail("line 15950");
        }
        return _t7789;
      }
      const has_poly_7791 = List$exists(_t7787, bindings);
      let _t7793;
      if (has_poly_7791) {
        function _t7794(__p229) {
          let _t7796;
          const _t7795 = __p229;
          _t7797: {
            if (true) {
              const type_params = _t7795[1];
              const params = _t7795[2];
              const ret_annot = _t7795[3];
              const shared_tvars_7798 = Hashtbl$create(4);
              function _t7800(tp) {
                return _call(Hashtbl$set, [__dict_Hash_string, __dict_Eq_string, shared_tvars_7798, tp, Types$new_tvar((level + 1))]);
              }
              List$iter(_t7800, type_params);
              function _t7801(p) {
                let _t7803;
                const _t7802 = p.annot;
                _t7804: {
                  if (_t7802._tag === 1) {
                    const annot = _t7802._val;
                    _t7803 = Typechecker$resolve_ty_annot_shared(sub_ctx, (level + 1), shared_tvars_7798, annot);
                    break _t7804;
                  }
                  if (_t7802._tag === 0) {
                    _t7803 = Types$new_tvar((level + 1));
                    break _t7804;
                  }
                  _match_fail("line 15950");
                }
                return _t7803;
              }
              const param_tys_7805 = List$map(_t7801, params);
              let _t7808;
              const _t7807 = ret_annot;
              _t7809: {
                if (_t7807._tag === 1 && _t7807._val._tag === 11) {
                  const ty = _t7807._val._val[0];
                  const eff_annot = _t7807._val._val[1];
                  const ty$p_7810 = Typechecker$resolve_ty_annot_shared(sub_ctx, (level + 1), shared_tvars_7798, ty);
                  let _t7813;
                  const _t7812 = eff_annot;
                  _t7814: {
                    if (_t7812._tag === 0) {
                      _t7813 = ({_tag: 1, _name: "EffEmpty"});
                      break _t7814;
                    }
                    if (_t7812._tag === 1) {
                      const items = _t7812._val;
                      _t7813 = Typechecker$resolve_eff_items(sub_ctx, (level + 1), shared_tvars_7798, items);
                      break _t7814;
                    }
                    _match_fail("line 15950");
                  }
                  const eff_7815 = _t7813;
                  const _t7816 = [ty$p_7810, eff_7815];
                  const _t7811 = _t7816;
                  _t7808 = _t7811;
                  break _t7809;
                }
                if (_t7807._tag === 1) {
                  const annot = _t7807._val;
                  _t7808 = [Typechecker$resolve_ty_annot_shared(sub_ctx, (level + 1), shared_tvars_7798, annot), Types$new_effvar((level + 1))];
                  break _t7809;
                }
                if (_t7807._tag === 0) {
                  _t7808 = [Types$new_tvar((level + 1)), Types$new_effvar((level + 1))];
                  break _t7809;
                }
                _match_fail("line 15950");
              }
              let _t7818;
              const _t7817 = _t7808;
              _t7819: {
                if (true) {
                  const ret_ty = _t7817[0];
                  const body_eff = _t7817[1];
                  let _t7821;
                  const _t7820 = List$rev(param_tys_7805);
                  _t7822: {
                    if (_t7820 === null) {
                      _t7821 = ret_ty;
                      break _t7822;
                    }
                    if (_t7820 !== null) {
                      const last = _t7820._hd;
                      const rest = _t7820._tl;
                      const inner_7823 = ({_tag: 7, _name: "TArrow", _val: [last, body_eff, ret_ty]});
                      function _t7825(acc, pty) {
                        return ({_tag: 7, _name: "TArrow", _val: [pty, ({_tag: 1, _name: "EffEmpty"}), acc]});
                      }
                      const _t7824 = List$fold(_t7825, inner_7823, rest);
                      _t7821 = _t7824;
                      break _t7822;
                    }
                    _match_fail("line 15950");
                  }
                  const fn_ty_7826 = _t7821;
                  const _t7827 = [shared_tvars_7798, param_tys_7805, ret_ty, body_eff, fn_ty_7826];
                  _t7818 = _t7827;
                  break _t7819;
                }
                _match_fail("line 15950");
              }
              const _t7806 = _t7818;
              const _t7799 = _t7806;
              _t7796 = _t7799;
              break _t7797;
            }
            _match_fail("line 15950");
          }
          return _t7796;
        }
        const shared_tvars_list_7828 = List$map(_t7794, bindings);
        function _t7830(__p230) {
          let _t7832;
          const _t7831 = __p230;
          _t7833: {
            if (true) {
              const fn_ty = _t7831[4];
              _t7832 = Types$generalize(level, fn_ty);
              break _t7833;
            }
            _match_fail("line 15950");
          }
          return _t7832;
        }
        const schemes_7834 = List$map(_t7830, shared_tvars_list_7828);
        function _t7836(ctx, __p231, scheme) {
          let _t7838;
          const _t7837 = __p231;
          _t7839: {
            if (true) {
              const name = _t7837[0];
              const qualified_name_7840 = (prefix + name);
              const ctx_7842 = Typechecker$extend_var(ctx, name, scheme);
              const _t7843 = Typechecker$extend_var(ctx_7842, qualified_name_7840, scheme);
              const _t7841 = _t7843;
              _t7838 = _t7841;
              break _t7839;
            }
            _match_fail("line 15950");
          }
          return _t7838;
        }
        const sub_ctx$p_7844 = List$fold2(_t7836, sub_ctx, bindings, schemes_7834);
        function _t7846(__p232, __p233) {
          let _t7848;
          const _t7847 = __p232;
          _t7849: {
            if (true) {
              const params = _t7847[2];
              const body = _t7847[5];
              let _t7851;
              const _t7850 = __p233;
              _t7852: {
                if (true) {
                  const param_tys = _t7850[1];
                  const ret_ty = _t7850[2];
                  const body_eff = _t7850[3];
                  function _t7853(c, p, ty) {
                    return Typechecker$extend_var_mono(c, p.name, ty);
                  }
                  const __rec_upd_7854 = sub_ctx$p_7844;
                  const _t7855 = ({constraint_tvars: __rec_upd_7854.constraint_tvars, current_eff: body_eff, current_module: __rec_upd_7854.current_module, inside_handler: __rec_upd_7854.inside_handler, loop_info: __rec_upd_7854.loop_info, mutable_vars: __rec_upd_7854.mutable_vars, return_type: __rec_upd_7854.return_type, return_used: __rec_upd_7854.return_used, type_env: __rec_upd_7854.type_env, vars: __rec_upd_7854.vars});
                  const inner_ctx_7856 = List$fold2(_t7853, _t7855, params, param_tys);
                  const body_te_7858 = Typechecker$check(inner_ctx_7856, (level + 1), body, ret_ty);
                  let _t7861;
                  const _t7860 = [List$rev(params), List$rev(param_tys)];
                  _t7862: {
                    if (_t7860[0] === null && _t7860[1] === null) {
                      _t7861 = body_te_7858;
                      break _t7862;
                    }
                    if (_t7860[0] !== null && _t7860[1] !== null) {
                      const last_p = _t7860[0]._hd;
                      const rest_ps = _t7860[0]._tl;
                      const last_pty = _t7860[1]._hd;
                      const rest_ptys = _t7860[1]._tl;
                      const inner_7863 = Typechecker$mk(({_tag: 10, _name: "TEFun", _val: [last_p.name, body_te_7858, false]}), ({_tag: 7, _name: "TArrow", _val: [last_pty, body_eff, body_te_7858.ty]}));
                      function _t7865(acc, p, pty) {
                        return Typechecker$mk(({_tag: 10, _name: "TEFun", _val: [p.name, acc, false]}), ({_tag: 7, _name: "TArrow", _val: [pty, ({_tag: 1, _name: "EffEmpty"}), acc.ty]}));
                      }
                      const _t7864 = List$fold2(_t7865, inner_7863, rest_ps, rest_ptys);
                      _t7861 = _t7864;
                      break _t7862;
                    }
                    if (true) {
                      _t7861 = failwith("assert false");
                      break _t7862;
                    }
                    _match_fail("line 15950");
                  }
                  const _t7859 = _t7861;
                  const _t7857 = _t7859;
                  _t7851 = _t7857;
                  break _t7852;
                }
                _match_fail("line 15950");
              }
              _t7848 = _t7851;
              break _t7849;
            }
            _match_fail("line 15950");
          }
          return _t7848;
        }
        const body_tes_7866 = List$map2(_t7846, bindings, shared_tvars_list_7828);
        function _t7868(ctx, __p234, scheme) {
          let _t7870;
          const _t7869 = __p234;
          _t7871: {
            if (true) {
              const name = _t7869[0];
              const qualified_name_7872 = (prefix + name);
              const ctx_7874 = Typechecker$extend_var(ctx, name, scheme);
              const _t7875 = Typechecker$extend_var(ctx_7874, qualified_name_7872, scheme);
              const _t7873 = _t7875;
              _t7870 = _t7873;
              break _t7871;
            }
            _match_fail("line 15950");
          }
          return _t7870;
        }
        const sub_ctx$p$p_7876 = List$fold2(_t7868, sub_ctx, bindings, schemes_7834);
        function _t7878(__p235, te) {
          let _t7880;
          const _t7879 = __p235;
          _t7881: {
            if (true) {
              const name = _t7879[0];
              const qualified_name_7882 = (prefix + name);
              const _t7883 = [qualified_name_7882, te];
              _t7880 = _t7883;
              break _t7881;
            }
            _match_fail("line 15950");
          }
          return _t7880;
        }
        const typed_bindings_7884 = List$map2(_t7878, bindings, body_tes_7866);
        function _t7886(__p236) {
          let _t7888;
          const _t7887 = __p236;
          _t7889: {
            if (true) {
              const name = _t7887[0];
              function _t7890(__p237, s) {
                let _t7892;
                const _t7891 = __p237;
                _t7893: {
                  if (true) {
                    const n = _t7891[0];
                    _t7892 = [n, s];
                    break _t7893;
                  }
                  _match_fail("line 15950");
                }
                return _t7892;
              }
              const scheme_7894 = List$assoc(name, List$map2(_t7890, bindings, schemes_7834));
              let _t7897;
              const _t7896 = item.vis;
              _t7898: {
                if (_t7896._tag === 0) {
                  _t7897 = Ref$set(pub_vars, ({_hd: [name, scheme_7894], _tl: Ref$get(pub_vars)}));
                  break _t7898;
                }
                if (true) {
                  _t7897 = undefined;
                  break _t7898;
                }
                _match_fail("line 15950");
              }
              const _t7895 = _t7897;
              _t7888 = _t7895;
              break _t7889;
            }
            _match_fail("line 15950");
          }
          return _t7888;
        }
        List$iter(_t7886, bindings);
        const _t7885 = [sub_ctx$p$p_7876, ({_tag: 3, _name: "TDLetRecAnd", _val: typed_bindings_7884})];
        const _t7877 = _t7885;
        const _t7867 = _t7877;
        const _t7845 = _t7867;
        const _t7835 = _t7845;
        const _t7829 = _t7835;
        _t7793 = _t7829;
      } else {
        function _t7899(__p238) {
          let _t7901;
          const _t7900 = __p238;
          _t7902: {
            if (true) {
              const name = _t7900[0];
              _t7901 = [name, Types$new_tvar((level + 1))];
              break _t7902;
            }
            _match_fail("line 15950");
          }
          return _t7901;
        }
        const fn_vars_7903 = List$map(_t7899, bindings);
        function _t7905(ctx, __p239) {
          let _t7907;
          const _t7906 = __p239;
          _t7908: {
            if (true) {
              const name = _t7906[0];
              const tv = _t7906[1];
              const qualified_name_7909 = (prefix + name);
              const ctx_7911 = Typechecker$extend_var_mono(ctx, name, tv);
              const _t7912 = Typechecker$extend_var_mono(ctx_7911, qualified_name_7909, tv);
              const _t7910 = _t7912;
              _t7907 = _t7910;
              break _t7908;
            }
            _match_fail("line 15950");
          }
          return _t7907;
        }
        const sub_ctx$p_7913 = List$fold(_t7905, sub_ctx, fn_vars_7903);
        function _t7915(__p240, __p241) {
          let _t7917;
          const _t7916 = __p240;
          _t7918: {
            if (true) {
              const name = _t7916[0];
              const params = _t7916[2];
              const ret_annot = _t7916[3];
              const constraints = _t7916[4];
              const body = _t7916[5];
              let _t7920;
              const _t7919 = __p241;
              _t7921: {
                if (true) {
                  const tv = _t7919[1];
                  name;
                  undefined;
                  let _t7922;
                  if (!_eq(constraints, null)) {
                    let _t7924;
                    const _t7923 = Typechecker$synth_constrained_fn(sub_ctx$p_7913, level, constraints, params, ret_annot, body);
                    _t7925: {
                      if (true) {
                        const te = _t7923[0];
                        const _scheme = _t7923[1];
                        Typechecker$try_unify(tv, te.ty);
                        _t7924 = te;
                        break _t7925;
                      }
                      _match_fail("line 15950");
                    }
                    _t7922 = _t7924;
                  } else {
                    const full_body_7926 = Typechecker$wrap_params_decl(params, ret_annot, body);
                    const te_7928 = Typechecker$synth(sub_ctx$p_7913, (level + 1), full_body_7926);
                    Typechecker$try_unify(tv, te_7928.ty);
                    const _t7929 = te_7928;
                    const _t7927 = _t7929;
                    _t7922 = _t7927;
                  }
                  _t7920 = _t7922;
                  break _t7921;
                }
                _match_fail("line 15950");
              }
              _t7917 = _t7920;
              break _t7918;
            }
            _match_fail("line 15950");
          }
          return _t7917;
        }
        const body_tes_7930 = List$map2(_t7915, bindings, fn_vars_7903);
        function _t7932(ctx, __p242, __p243) {
          let _t7934;
          const _t7933 = __p242;
          _t7935: {
            if (true) {
              const name = _t7933[0];
              let _t7937;
              const _t7936 = __p243;
              _t7938: {
                if (true) {
                  const tv = _t7936[1];
                  const qualified_name_7939 = (prefix + name);
                  const scheme_7941 = Types$generalize(level, tv);
                  const ctx_7943 = Typechecker$extend_var(ctx, name, scheme_7941);
                  const _t7944 = Typechecker$extend_var(ctx_7943, qualified_name_7939, scheme_7941);
                  const _t7942 = _t7944;
                  const _t7940 = _t7942;
                  _t7937 = _t7940;
                  break _t7938;
                }
                _match_fail("line 15950");
              }
              _t7934 = _t7937;
              break _t7935;
            }
            _match_fail("line 15950");
          }
          return _t7934;
        }
        const sub_ctx$p$p_7945 = List$fold2(_t7932, sub_ctx, bindings, fn_vars_7903);
        function _t7947(__p244, te) {
          let _t7949;
          const _t7948 = __p244;
          _t7950: {
            if (true) {
              const name = _t7948[0];
              const qualified_name_7951 = (prefix + name);
              const _t7952 = [qualified_name_7951, te];
              _t7949 = _t7952;
              break _t7950;
            }
            _match_fail("line 15950");
          }
          return _t7949;
        }
        const typed_bindings_7953 = List$map2(_t7947, bindings, body_tes_7930);
        function _t7955(__p245, __p246) {
          let _t7957;
          const _t7956 = __p245;
          _t7958: {
            if (true) {
              const name = _t7956[0];
              let _t7960;
              const _t7959 = __p246;
              _t7961: {
                if (true) {
                  const tv = _t7959[1];
                  const scheme_7962 = Types$generalize(level, tv);
                  let _t7965;
                  const _t7964 = item.vis;
                  _t7966: {
                    if (_t7964._tag === 0) {
                      _t7965 = Ref$set(pub_vars, ({_hd: [name, scheme_7962], _tl: Ref$get(pub_vars)}));
                      break _t7966;
                    }
                    if (true) {
                      _t7965 = undefined;
                      break _t7966;
                    }
                    _match_fail("line 15950");
                  }
                  const _t7963 = _t7965;
                  _t7960 = _t7963;
                  break _t7961;
                }
                _match_fail("line 15950");
              }
              _t7957 = _t7960;
              break _t7958;
            }
            _match_fail("line 15950");
          }
          return _t7957;
        }
        List$iter2(_t7955, bindings, fn_vars_7903);
        const _t7954 = [sub_ctx$p$p_7945, ({_tag: 3, _name: "TDLetRecAnd", _val: typed_bindings_7953})];
        const _t7946 = _t7954;
        const _t7931 = _t7946;
        const _t7914 = _t7931;
        const _t7904 = _t7914;
        _t7793 = _t7904;
      }
      const _t7792 = _t7793;
      _t7552 = _t7792;
      break _t7553;
    }
    if (_t7551._tag === 5) {
      const type_defs = _t7551._val;
      function _t7967(ctx, __p247) {
        let _t7969;
        const _t7968 = __p247;
        _t7970: {
          if (true) {
            const type_params = _t7968[0];
            const name = _t7968[1];
            const def = _t7968[2];
            const _deriving = _t7968[3];
            const qualified_name_7971 = (prefix + name);
            const num_params_7973 = List$length(type_params);
            const __rec_upd_7975 = ctx;
            const __rec_upd_7977 = ctx.type_env;
            const _t7978 = ({classes: __rec_upd_7977.classes, constructors: __rec_upd_7977.constructors, effects: __rec_upd_7977.effects, instances: __rec_upd_7977.instances, modules: __rec_upd_7977.modules, mutable_fields: __rec_upd_7977.mutable_fields, records: __rec_upd_7977.records, type_aliases: ({_hd: [name, qualified_name_7971], _tl: ctx.type_env.type_aliases}), type_synonyms: __rec_upd_7977.type_synonyms, variants: __rec_upd_7977.variants});
            const _t7976 = ({constraint_tvars: __rec_upd_7975.constraint_tvars, current_eff: __rec_upd_7975.current_eff, current_module: __rec_upd_7975.current_module, inside_handler: __rec_upd_7975.inside_handler, loop_info: __rec_upd_7975.loop_info, mutable_vars: __rec_upd_7975.mutable_vars, return_type: __rec_upd_7975.return_type, return_used: __rec_upd_7975.return_used, type_env: _t7978, vars: __rec_upd_7975.vars});
            const ctx_7979 = _t7976;
            let _t7982;
            const _t7981 = def;
            _t7983: {
              if (_t7981._tag === 0) {
                const __rec_upd_7984 = ctx_7979;
                const __rec_upd_7986 = ctx_7979.type_env;
                const _t7987 = ({classes: __rec_upd_7986.classes, constructors: __rec_upd_7986.constructors, effects: __rec_upd_7986.effects, instances: __rec_upd_7986.instances, modules: __rec_upd_7986.modules, mutable_fields: __rec_upd_7986.mutable_fields, records: __rec_upd_7986.records, type_aliases: __rec_upd_7986.type_aliases, type_synonyms: __rec_upd_7986.type_synonyms, variants: ({_hd: [qualified_name_7971, num_params_7973, null, false], _tl: ctx_7979.type_env.variants})});
                const _t7985 = ({constraint_tvars: __rec_upd_7984.constraint_tvars, current_eff: __rec_upd_7984.current_eff, current_module: __rec_upd_7984.current_module, inside_handler: __rec_upd_7984.inside_handler, loop_info: __rec_upd_7984.loop_info, mutable_vars: __rec_upd_7984.mutable_vars, return_type: __rec_upd_7984.return_type, return_used: __rec_upd_7984.return_used, type_env: _t7987, vars: __rec_upd_7984.vars});
                _t7982 = _t7985;
                break _t7983;
              }
              if (_t7981._tag === 1) {
                const __rec_upd_7988 = ctx_7979;
                const __rec_upd_7990 = ctx_7979.type_env;
                const _t7991 = ({classes: __rec_upd_7990.classes, constructors: __rec_upd_7990.constructors, effects: __rec_upd_7990.effects, instances: __rec_upd_7990.instances, modules: __rec_upd_7990.modules, mutable_fields: __rec_upd_7990.mutable_fields, records: ({_hd: [qualified_name_7971, null], _tl: ctx_7979.type_env.records}), type_aliases: __rec_upd_7990.type_aliases, type_synonyms: __rec_upd_7990.type_synonyms, variants: __rec_upd_7990.variants});
                const _t7989 = ({constraint_tvars: __rec_upd_7988.constraint_tvars, current_eff: __rec_upd_7988.current_eff, current_module: __rec_upd_7988.current_module, inside_handler: __rec_upd_7988.inside_handler, loop_info: __rec_upd_7988.loop_info, mutable_vars: __rec_upd_7988.mutable_vars, return_type: __rec_upd_7988.return_type, return_used: __rec_upd_7988.return_used, type_env: _t7991, vars: __rec_upd_7988.vars});
                _t7982 = _t7989;
                break _t7983;
              }
              if (_t7981._tag === 2) {
                _t7982 = ctx_7979;
                break _t7983;
              }
              _match_fail("line 15950");
            }
            const _t7980 = _t7982;
            const _t7974 = _t7980;
            const _t7972 = _t7974;
            _t7969 = _t7972;
            break _t7970;
          }
          _match_fail("line 15950");
        }
        return _t7969;
      }
      const sub_ctx$p_7992 = List$fold(_t7967, sub_ctx, type_defs);
      function _t7994(ctx, __p248) {
        let _t7996;
        const _t7995 = __p248;
        _t7997: {
          if (true) {
            const type_params = _t7995[0];
            const name = _t7995[1];
            const def = _t7995[2];
            const _deriving = _t7995[3];
            let _t7999;
            const _t7998 = def;
            _t8000: {
              if (_t7998._tag === 1) {
                const qualified_name_8001 = (prefix + name);
                const _t8002 = Typechecker$process_type_def(ctx, type_params, qualified_name_8001, def);
                _t7999 = _t8002;
                break _t8000;
              }
              if (true) {
                _t7999 = ctx;
                break _t8000;
              }
              _match_fail("line 15950");
            }
            _t7996 = _t7999;
            break _t7997;
          }
          _match_fail("line 15950");
        }
        return _t7996;
      }
      const sub_ctx$p_8003 = List$fold(_t7994, sub_ctx$p_7992, type_defs);
      function _t8005(ctx, __p249) {
        let _t8007;
        const _t8006 = __p249;
        _t8008: {
          if (true) {
            const type_params = _t8006[0];
            const name = _t8006[1];
            const def = _t8006[2];
            const _deriving = _t8006[3];
            let _t8010;
            const _t8009 = def;
            _t8011: {
              if (_t8009._tag === 1) {
                _t8010 = ctx;
                break _t8011;
              }
              if (true) {
                const qualified_name_8012 = (prefix + name);
                const _t8013 = Typechecker$process_type_def(ctx, type_params, qualified_name_8012, def);
                _t8010 = _t8013;
                break _t8011;
              }
              _match_fail("line 15950");
            }
            _t8007 = _t8010;
            break _t8008;
          }
          _match_fail("line 15950");
        }
        return _t8007;
      }
      const sub_ctx$p_8014 = List$fold(_t8005, sub_ctx$p_8003, type_defs);
      function _t8016(__p250) {
        let _t8018;
        const _t8017 = __p250;
        _t8019: {
          if (true) {
            const _type_params = _t8017[0];
            const name = _t8017[1];
            const def = _t8017[2];
            const _deriving = _t8017[3];
            const qualified_name_8020 = (prefix + name);
            let _t8023;
            const _t8022 = item.vis;
            _t8024: {
              if (_t8022._tag === 0) {
                Ref$set(pub_types, ({_hd: qualified_name_8020, _tl: Ref$get(pub_types)}));
                let _t8026;
                const _t8025 = def;
                _t8027: {
                  if (_t8025._tag === 0) {
                    const ctors = _t8025._val;
                    function _t8028(__p251) {
                      let _t8030;
                      const _t8029 = __p251;
                      _t8031: {
                        if (true) {
                          const ctor_name = _t8029[0];
                          let _t8033;
                          const _t8032 = List$assoc_opt(ctor_name, sub_ctx$p_8014.type_env.constructors);
                          _t8034: {
                            if (_t8032._tag === 1) {
                              const info = _t8032._val;
                              const __rec_upd_8035 = info;
                              const _t8036 = ({ctor_arg_ty: __rec_upd_8035.ctor_arg_ty, ctor_existentials: __rec_upd_8035.ctor_existentials, ctor_num_params: __rec_upd_8035.ctor_num_params, ctor_return_ty_params: __rec_upd_8035.ctor_return_ty_params, ctor_type_name: qualified_name_8020});
                              const qual_info_8037 = _t8036;
                              const _t8038 = Ref$set(pub_constructors, ({_hd: [ctor_name, qual_info_8037], _tl: Ref$get(pub_constructors)}));
                              _t8033 = _t8038;
                              break _t8034;
                            }
                            if (_t8032._tag === 0) {
                              _t8033 = undefined;
                              break _t8034;
                            }
                            _match_fail("line 15950");
                          }
                          _t8030 = _t8033;
                          break _t8031;
                        }
                        _match_fail("line 15950");
                      }
                      return _t8030;
                    }
                    _t8026 = List$iter(_t8028, ctors);
                    break _t8027;
                  }
                  if ((_t8025._tag === 1 || _t8025._tag === 2)) {
                    _t8026 = undefined;
                    break _t8027;
                  }
                  _match_fail("line 15950");
                }
                _t8023 = _t8026;
                break _t8024;
              }
              if (_t8022._tag === 2) {
                Ref$set(pub_types, ({_hd: qualified_name_8020, _tl: Ref$get(pub_types)}));
                _t8023 = Ref$set(opaque_types, ({_hd: qualified_name_8020, _tl: Ref$get(opaque_types)}));
                break _t8024;
              }
              if (_t8022._tag === 1) {
                _t8023 = undefined;
                break _t8024;
              }
              _match_fail("line 15950");
            }
            const _t8021 = _t8023;
            _t8018 = _t8021;
            break _t8019;
          }
          _match_fail("line 15950");
        }
        return _t8018;
      }
      List$iter(_t8016, type_defs);
      function _t8039(ctx, __p252) {
        let _t8041;
        const _t8040 = __p252;
        _t8042: {
          if (true) {
            const type_params = _t8040[0];
            const name = _t8040[1];
            const def = _t8040[2];
            const deriving_ = _t8040[3];
            function _t8043(ctx, cls) {
              let _t8045;
              const _t8044 = Typechecker$generate_derived_instance(type_params, name, def, cls);
              _t8046: {
                if (_t8044._tag === 1) {
                  const class_name = _t8044._val[0];
                  const inst_tys = _t8044._val[1];
                  const constraints = _t8044._val[2];
                  const methods = _t8044._val[3];
                  let _t8048;
                  const _t8047 = Typechecker$process_instance_def(ctx, level, class_name, inst_tys, constraints, methods);
                  _t8049: {
                    if (true) {
                      const ctx$p = _t8047[0];
                      const tdecl = _t8047[1];
                      Ref$set(typed_decls, ({_hd: tdecl, _tl: Ref$get(typed_decls)}));
                      Ref$set(all_instances, ctx$p.type_env.instances);
                      _t8048 = ctx$p;
                      break _t8049;
                    }
                    _match_fail("line 15950");
                  }
                  _t8045 = _t8048;
                  break _t8046;
                }
                if (_t8044._tag === 0) {
                  _t8045 = Typechecker$error(((("cannot derive " + __dict_Show_string.show(cls)) + " for type ") + __dict_Show_string.show(name)));
                  break _t8046;
                }
                _match_fail("line 15950");
              }
              return _t8045;
            }
            _t8041 = List$fold(_t8043, ctx, deriving_);
            break _t8042;
          }
          _match_fail("line 15950");
        }
        return _t8041;
      }
      const sub_ctx$p_8050 = List$fold(_t8039, sub_ctx$p_8014, type_defs);
      function _t8052(__p253) {
        let _t8054;
        const _t8053 = __p253;
        _t8055: {
          if (true) {
            const _tp = _t8053[0];
            const name = _t8053[1];
            const def = _t8053[2];
            const _d = _t8053[3];
            _t8054 = ({_tag: 4, _name: "TDType", _val: [(prefix + name), def]});
            break _t8055;
          }
          _match_fail("line 15950");
        }
        return _t8054;
      }
      const type_decls_8056 = List$map(_t8052, type_defs);
      function push_all_but_last(__x) {
        while (true) {
          let _t8059;
          const _t8058 = __x;
          _t8060: {
            if (_t8058 === null) {
              _t8059 = failwith("empty DTypeAnd");
              break _t8060;
            }
            if (_t8058 !== null && _t8058._tl === null) {
              const last = _t8058._hd;
              _t8059 = last;
              break _t8060;
            }
            if (_t8058 !== null) {
              const hd = _t8058._hd;
              const tl = _t8058._tl;
              Ref$set(typed_decls, ({_hd: hd, _tl: Ref$get(typed_decls)}));
              const _t8061 = tl;
              __x = _t8061;
              continue;
              _t8059 = undefined;
              break _t8060;
            }
            _match_fail("line 15950");
          }
          return _t8059;
        }
      }
      const last_tdecl_8063 = push_all_but_last(type_decls_8056);
      const _t8064 = [sub_ctx$p_8050, last_tdecl_8063];
      const _t8062 = _t8064;
      const _t8057 = _t8062;
      const _t8051 = _t8057;
      const _t8015 = _t8051;
      const _t8004 = _t8015;
      const _t7993 = _t8004;
      _t7552 = _t7993;
      break _t7553;
    }
    _match_fail("line 15950");
  }
  const _t7550 = _t7552;
  return _t7550;
}
function Typechecker$process_open(ctx, mod_name, names_opt) {
  let _t8066;
  const _t8065 = Typechecker$find_module_in_env(ctx.type_env, mod_name);
  _t8067: {
    if (_t8065._tag === 1) {
      const m = _t8065._val;
      _t8066 = m;
      break _t8067;
    }
    if (_t8065._tag === 0) {
      _t8066 = Typechecker$error(("unknown module: " + __dict_Show_string.show(mod_name)));
      break _t8067;
    }
    _match_fail("line 15950");
  }
  const minfo_8068 = _t8066;
  function _t8070(qname) {
    function _t8071(c) {
      return (c.class_name === qname);
    }
    let _t8073;
    const _t8072 = List$find(_t8071, ctx.type_env.classes);
    _t8074: {
      if (_t8072._tag === 1) {
        const cls = _t8072._val;
        _t8073 = List$map(fst, cls.class_methods);
        break _t8074;
      }
      if (_t8072._tag === 0) {
        _t8073 = null;
        break _t8074;
      }
      _match_fail("line 15950");
    }
    return _t8073;
  }
  const class_method_names_8075 = List$concat_map(_t8070, minfo_8068.mod_pub_classes);
  const alias_pairs_8077 = Ref$create(null);
  function _t8079(name) {
    let _t8081;
    const _t8080 = names_opt;
    _t8082: {
      if (_t8080._tag === 0) {
        _t8081 = true;
        break _t8082;
      }
      if (_t8080._tag === 1) {
        const names = _t8080._val;
        _t8081 = List$mem(name, names);
        break _t8082;
      }
      _match_fail("line 15950");
    }
    return _t8081;
  }
  const filter_8083 = _t8079;
  function _t8085(__p254) {
    let _t8087;
    const _t8086 = __p254;
    _t8088: {
      if (true) {
        const _mml$short = _t8086[0];
        const _scheme = _t8086[1];
        let _t8089;
        if ((filter_8083(_mml$short) && (!List$mem(_mml$short, class_method_names_8075)))) {
          const qualified_8090 = (mod_name + ("." + _mml$short));
          const _t8091 = Ref$set(alias_pairs_8077, ({_hd: [_mml$short, qualified_8090], _tl: Ref$get(alias_pairs_8077)}));
          _t8089 = _t8091;
        } else {
          _t8089 = undefined;
        }
        _t8087 = _t8089;
        break _t8088;
      }
      _match_fail("line 15950");
    }
    return _t8087;
  }
  List$iter(_t8085, minfo_8068.mod_pub_vars);
  const ctx$p_8092 = Typechecker$open_module_into_ctx(ctx, mod_name, names_opt);
  const _t8093 = [ctx$p_8092, ({_tag: 10, _name: "TDOpen", _val: Ref$get(alias_pairs_8077)})];
  const _t8084 = _t8093;
  const _t8078 = _t8084;
  const _t8076 = _t8078;
  const _t8069 = _t8076;
  return _t8069;
}
function Typechecker$check_decl(ctx, level, decl) {
  let _t8095;
  const _t8094 = decl;
  _t8096: {
    if (_t8094._tag === 4) {
      const type_params = _t8094._val[0];
      const name = _t8094._val[1];
      const def = _t8094._val[2];
      const deriving_ = _t8094._val[3];
      const ctx$p_8097 = Typechecker$process_type_def(ctx, type_params, name, def);
      function _t8099(__p255, cls) {
        let _t8101;
        const _t8100 = __p255;
        _t8102: {
          if (true) {
            const ctx = _t8100[0];
            const acc = _t8100[1];
            let _t8104;
            const _t8103 = Typechecker$generate_derived_instance(type_params, name, def, cls);
            _t8105: {
              if (_t8103._tag === 1) {
                const class_name = _t8103._val[0];
                const inst_tys = _t8103._val[1];
                const constraints = _t8103._val[2];
                const methods = _t8103._val[3];
                let _t8107;
                const _t8106 = Typechecker$process_instance_def(ctx, level, class_name, inst_tys, constraints, methods);
                _t8108: {
                  if (true) {
                    const ctx$p = _t8106[0];
                    const tdecl = _t8106[1];
                    _t8107 = [ctx$p, ({_hd: tdecl, _tl: acc})];
                    break _t8108;
                  }
                  _match_fail("line 15950");
                }
                _t8104 = _t8107;
                break _t8105;
              }
              if (_t8103._tag === 0) {
                _t8104 = Typechecker$error(((("cannot derive " + __dict_Show_string.show(cls)) + " for type ") + __dict_Show_string.show(name)));
                break _t8105;
              }
              _match_fail("line 15950");
            }
            _t8101 = _t8104;
            break _t8102;
          }
          _match_fail("line 15950");
        }
        return _t8101;
      }
      let _t8110;
      const _t8109 = List$fold(_t8099, [ctx$p_8097, null], deriving_);
      _t8111: {
        if (true) {
          const ctx$p = _t8109[0];
          const derived_tdecls = _t8109[1];
          _t8110 = [ctx$p, ({_hd: ({_tag: 4, _name: "TDType", _val: [name, def]}), _tl: List$rev(derived_tdecls)})];
          break _t8111;
        }
        _match_fail("line 15950");
      }
      const _t8098 = _t8110;
      _t8095 = _t8098;
      break _t8096;
    }
    if (_t8094._tag === 0) {
      const name = _t8094._val[0];
      const params = _t8094._val[1];
      const ret_annot = _t8094._val[2];
      const constraints = _t8094._val[3];
      const body = _t8094._val[4];
      let _t8112;
      if (!_eq(constraints, null)) {
        let _t8114;
        const _t8113 = Typechecker$synth_constrained_fn(ctx, level, constraints, params, ret_annot, body);
        _t8115: {
          if (true) {
            const te = _t8113[0];
            const scheme = _t8113[1];
            const ctx$p_8116 = Typechecker$extend_var(ctx, name, scheme);
            const _t8117 = [ctx$p_8116, ({_hd: ({_tag: 0, _name: "TDLet", _val: [name, te]}), _tl: null})];
            _t8114 = _t8117;
            break _t8115;
          }
          _match_fail("line 15950");
        }
        _t8112 = _t8114;
      } else {
        const eff_8118 = Types$new_effvar(level);
        const __rec_upd_8120 = ctx;
        const _t8121 = ({constraint_tvars: __rec_upd_8120.constraint_tvars, current_eff: eff_8118, current_module: __rec_upd_8120.current_module, inside_handler: __rec_upd_8120.inside_handler, loop_info: __rec_upd_8120.loop_info, mutable_vars: __rec_upd_8120.mutable_vars, return_type: __rec_upd_8120.return_type, return_used: __rec_upd_8120.return_used, type_env: __rec_upd_8120.type_env, vars: __rec_upd_8120.vars});
        const eff_ctx_8122 = _t8121;
        const full_body_8124 = Typechecker$wrap_params_decl(params, ret_annot, body);
        const te_8126 = Typechecker$synth(eff_ctx_8122, (level + 1), full_body_8124);
        Typechecker$improve_fundeps_in_expr(ctx.vars, ctx.type_env, te_8126);
        let _t8128;
        if ((_eq(params, null) && (!Typechecker$is_syntactic_value(body)))) {
          _t8128 = Typechecker$mono_scheme(te_8126.ty);
        } else {
          _t8128 = Typechecker$resolve_let_constraints(Types$empty_type_env, level, null, params, ret_annot, te_8126.ty, Hashtbl$create(0));
        }
        const scheme_8129 = _t8128;
        const scheme_8131 = Typechecker$infer_implicit_constraints("", ctx.type_env, ctx.vars, te_8126, scheme_8129);
        const scheme_8133 = Typechecker$infer_record_evidence(ctx.vars, te_8126, scheme_8131);
        const ctx$p_8135 = Typechecker$extend_var(ctx, name, scheme_8133);
        const _t8136 = [ctx$p_8135, ({_hd: ({_tag: 0, _name: "TDLet", _val: [name, te_8126]}), _tl: null})];
        const _t8134 = _t8136;
        const _t8132 = _t8134;
        const _t8130 = _t8132;
        const _t8127 = _t8130;
        const _t8125 = _t8127;
        const _t8123 = _t8125;
        const _t8119 = _t8123;
        _t8112 = _t8119;
      }
      _t8095 = _t8112;
      break _t8096;
    }
    if (_t8094._tag === 1) {
      const name = _t8094._val[0];
      const body = _t8094._val[1];
      const eff_8137 = Types$new_effvar(level);
      const __rec_upd_8139 = ctx;
      const _t8140 = ({constraint_tvars: __rec_upd_8139.constraint_tvars, current_eff: eff_8137, current_module: __rec_upd_8139.current_module, inside_handler: __rec_upd_8139.inside_handler, loop_info: __rec_upd_8139.loop_info, mutable_vars: __rec_upd_8139.mutable_vars, return_type: __rec_upd_8139.return_type, return_used: __rec_upd_8139.return_used, type_env: __rec_upd_8139.type_env, vars: __rec_upd_8139.vars});
      const eff_ctx_8141 = _t8140;
      const te_8143 = Typechecker$synth(eff_ctx_8141, (level + 1), body);
      const scheme_8145 = Typechecker$mono_scheme(te_8143.ty);
      const ctx$p_8147 = Typechecker$extend_var_mutable(ctx, name, scheme_8145);
      const _t8148 = [ctx$p_8147, ({_hd: ({_tag: 1, _name: "TDLetMut", _val: [name, te_8143]}), _tl: null})];
      const _t8146 = _t8148;
      const _t8144 = _t8146;
      const _t8142 = _t8144;
      const _t8138 = _t8142;
      _t8095 = _t8138;
      break _t8096;
    }
    if (_t8094._tag === 2) {
      const name = _t8094._val[0];
      const type_params = _t8094._val[1];
      const params = _t8094._val[2];
      const ret_annot = _t8094._val[3];
      const constraints = _t8094._val[4];
      const body = _t8094._val[5];
      let _t8149;
      if (!_eq(type_params, null)) {
        let _t8151;
        const _t8150 = Typechecker$synth_poly_rec_fn(ctx, level, name, "", type_params, params, ret_annot, body);
        _t8152: {
          if (true) {
            const te = _t8150[0];
            const scheme = _t8150[1];
            const ctx$p_8153 = Typechecker$extend_var(ctx, name, scheme);
            const _t8154 = [ctx$p_8153, ({_hd: ({_tag: 2, _name: "TDLetRec", _val: [name, te]}), _tl: null})];
            _t8151 = _t8154;
            break _t8152;
          }
          _match_fail("line 15950");
        }
        _t8149 = _t8151;
      } else {
        let _t8155;
        if (!_eq(constraints, null)) {
          const fn_var_8156 = Types$new_tvar((level + 1));
          const ctx_with_self_8158 = Typechecker$extend_var_mono(ctx, name, fn_var_8156);
          let _t8161;
          const _t8160 = Typechecker$synth_constrained_fn(ctx_with_self_8158, level, constraints, params, ret_annot, body);
          _t8162: {
            if (true) {
              const te = _t8160[0];
              const scheme = _t8160[1];
              Typechecker$try_unify(fn_var_8156, te.ty);
              const ctx$p_8163 = Typechecker$extend_var(ctx, name, scheme);
              const _t8164 = [ctx$p_8163, ({_hd: ({_tag: 2, _name: "TDLetRec", _val: [name, te]}), _tl: null})];
              _t8161 = _t8164;
              break _t8162;
            }
            _match_fail("line 15950");
          }
          const _t8159 = _t8161;
          const _t8157 = _t8159;
          _t8155 = _t8157;
        } else {
          const eff_8165 = Types$new_effvar(level);
          const __rec_upd_8167 = ctx;
          const _t8168 = ({constraint_tvars: __rec_upd_8167.constraint_tvars, current_eff: eff_8165, current_module: __rec_upd_8167.current_module, inside_handler: __rec_upd_8167.inside_handler, loop_info: __rec_upd_8167.loop_info, mutable_vars: __rec_upd_8167.mutable_vars, return_type: __rec_upd_8167.return_type, return_used: __rec_upd_8167.return_used, type_env: __rec_upd_8167.type_env, vars: __rec_upd_8167.vars});
          const eff_ctx_8169 = _t8168;
          const full_body_8171 = Typechecker$wrap_params_decl(params, ret_annot, body);
          const fn_var_8173 = Types$new_tvar((level + 1));
          const ctx$p_8175 = Typechecker$extend_var_mono(eff_ctx_8169, name, fn_var_8173);
          const fn_te_8177 = Typechecker$synth(ctx$p_8175, (level + 1), full_body_8171);
          Typechecker$try_unify(fn_var_8173, fn_te_8177.ty);
          Typechecker$improve_fundeps_in_expr(ctx.vars, ctx.type_env, fn_te_8177);
          const scheme_8179 = Typechecker$resolve_let_constraints(Types$empty_type_env, level, null, params, ret_annot, fn_te_8177.ty, Hashtbl$create(0));
          const scheme_8181 = Typechecker$infer_implicit_constraints(name, ctx.type_env, ctx.vars, fn_te_8177, scheme_8179);
          const scheme_8183 = Typechecker$infer_record_evidence(ctx.vars, fn_te_8177, scheme_8181);
          const ctx$p$p_8185 = Typechecker$extend_var(ctx, name, scheme_8183);
          const _t8186 = [ctx$p$p_8185, ({_hd: ({_tag: 2, _name: "TDLetRec", _val: [name, fn_te_8177]}), _tl: null})];
          const _t8184 = _t8186;
          const _t8182 = _t8184;
          const _t8180 = _t8182;
          const _t8178 = _t8180;
          const _t8176 = _t8178;
          const _t8174 = _t8176;
          const _t8172 = _t8174;
          const _t8170 = _t8172;
          const _t8166 = _t8170;
          _t8155 = _t8166;
        }
        _t8149 = _t8155;
      }
      _t8095 = _t8149;
      break _t8096;
    }
    if (_t8094._tag === 6) {
      const expr = _t8094._val;
      const eff_8187 = Types$new_effvar(level);
      const __rec_upd_8189 = ctx;
      const _t8190 = ({constraint_tvars: __rec_upd_8189.constraint_tvars, current_eff: eff_8187, current_module: __rec_upd_8189.current_module, inside_handler: __rec_upd_8189.inside_handler, loop_info: __rec_upd_8189.loop_info, mutable_vars: __rec_upd_8189.mutable_vars, return_type: __rec_upd_8189.return_type, return_used: __rec_upd_8189.return_used, type_env: __rec_upd_8189.type_env, vars: __rec_upd_8189.vars});
      const ctx$p_8191 = _t8190;
      const te_8193 = Typechecker$synth(ctx$p_8191, level, expr);
      const _t8195 = (function() {
        const _t8196 = _h;
        _h = Object.assign({}, _t8196, {
          "unify_error": function(_, __k) { throw {_e: "unify_error", _v: _}; },
        });
        try {
          const __x_8197 = Types$unify_eff(Types$eff_repr(eff_8187), ({_tag: 1, _name: "EffEmpty"}));
          return __x_8197;
        } catch (_exc) {
          if (_exc && _exc._e === "unify_error") {
            const _ = _exc._v;
            return Typechecker$error(("expression has unhandled effects: " + __dict_Show_string.show(Types$pp_eff(eff_8187))));
          } else { throw _exc; }
        } finally { _h = _t8196; }
      })();
      _t8195;
      const _t8194 = [ctx, ({_hd: ({_tag: 5, _name: "TDExpr", _val: te_8193}), _tl: null})];
      const _t8192 = _t8194;
      const _t8188 = _t8192;
      _t8095 = _t8188;
      break _t8096;
    }
    if (_t8094._tag === 7) {
      const name = _t8094._val[0];
      const tyvars = _t8094._val[1];
      const fundeps = _t8094._val[2];
      const methods = _t8094._val[3];
      let _t8199;
      const _t8198 = Typechecker$process_class_def(ctx, name, tyvars, fundeps, methods);
      _t8200: {
        if (true) {
          const ctx$p = _t8198[0];
          const td = _t8198[1];
          _t8199 = [ctx$p, ({_hd: td, _tl: null})];
          break _t8200;
        }
        _match_fail("line 15950");
      }
      _t8095 = _t8199;
      break _t8096;
    }
    if (_t8094._tag === 8) {
      const class_name = _t8094._val[0];
      const inst_ty_annots = _t8094._val[1];
      const constraints = _t8094._val[2];
      const methods = _t8094._val[3];
      let _t8202;
      const _t8201 = Typechecker$process_instance_def(ctx, level, class_name, inst_ty_annots, constraints, methods);
      _t8203: {
        if (true) {
          const ctx$p = _t8201[0];
          const td = _t8201[1];
          _t8202 = [ctx$p, ({_hd: td, _tl: null})];
          break _t8203;
        }
        _match_fail("line 15950");
      }
      _t8095 = _t8202;
      break _t8096;
    }
    if (_t8094._tag === 9) {
      const name = _t8094._val[0];
      const type_params = _t8094._val[1];
      const ops = _t8094._val[2];
      const tvars_8204 = Hashtbl$create(4);
      function _t8206(i, p) {
        return _call(Hashtbl$set, [__dict_Hash_string, __dict_Eq_string, tvars_8204, p, ({_tag: 17, _name: "TGen", _val: i})]);
      }
      List$iteri(_t8206, type_params);
      function _t8207(__p256) {
        let _t8209;
        const _t8208 = __p256;
        _t8210: {
          if (true) {
            const op_name = _t8208[0];
            const annot = _t8208[1];
            const ty_8211 = Typechecker$resolve_ty_annot_shared(ctx, 0, tvars_8204, annot);
            const _t8212 = [op_name, ty_8211];
            _t8209 = _t8212;
            break _t8210;
          }
          _match_fail("line 15950");
        }
        return _t8209;
      }
      const resolved_ops_8213 = List$map(_t8207, ops);
      const effect_def_8215 = ({effect_name: name, effect_ops: resolved_ops_8213, effect_params: type_params});
      const __rec_upd_8217 = ctx.type_env;
      const _t8218 = ({classes: __rec_upd_8217.classes, constructors: __rec_upd_8217.constructors, effects: ({_hd: effect_def_8215, _tl: ctx.type_env.effects}), instances: __rec_upd_8217.instances, modules: __rec_upd_8217.modules, mutable_fields: __rec_upd_8217.mutable_fields, records: __rec_upd_8217.records, type_aliases: __rec_upd_8217.type_aliases, type_synonyms: __rec_upd_8217.type_synonyms, variants: __rec_upd_8217.variants});
      const type_env_8219 = _t8218;
      const __rec_upd_8221 = ctx;
      const _t8222 = ({constraint_tvars: __rec_upd_8221.constraint_tvars, current_eff: __rec_upd_8221.current_eff, current_module: __rec_upd_8221.current_module, inside_handler: __rec_upd_8221.inside_handler, loop_info: __rec_upd_8221.loop_info, mutable_vars: __rec_upd_8221.mutable_vars, return_type: __rec_upd_8221.return_type, return_used: __rec_upd_8221.return_used, type_env: type_env_8219, vars: __rec_upd_8221.vars});
      const ctx_8223 = _t8222;
      const _t8224 = [ctx_8223, ({_hd: ({_tag: 7, _name: "TDEffect", _val: name}), _tl: null})];
      const _t8220 = _t8224;
      const _t8216 = _t8220;
      const _t8214 = _t8216;
      const _t8205 = _t8214;
      _t8095 = _t8205;
      break _t8096;
    }
    if (_t8094._tag === 10) {
      const name = _t8094._val[0];
      const ty_annot = _t8094._val[1];
      const tvars_8225 = Hashtbl$create(4);
      const ty_8227 = Typechecker$resolve_ty_annot_shared(ctx, 1, tvars_8225, ty_annot);
      const scheme_8229 = Types$generalize(0, ty_8227);
      const ctx_8231 = Typechecker$extend_var(ctx, name, scheme_8229);
      const _t8232 = [ctx_8231, ({_hd: ({_tag: 8, _name: "TDExtern", _val: [name, scheme_8229]}), _tl: null})];
      const _t8230 = _t8232;
      const _t8228 = _t8230;
      const _t8226 = _t8228;
      _t8095 = _t8226;
      break _t8096;
    }
    if (_t8094._tag === 11) {
      const name = _t8094._val[0];
      const items = _t8094._val[1];
      let _t8234;
      const _t8233 = Typechecker$process_module_def(ctx, level, name, items);
      _t8235: {
        if (true) {
          const ctx$p = _t8233[0];
          const td = _t8233[1];
          _t8234 = [ctx$p, ({_hd: td, _tl: null})];
          break _t8235;
        }
        _match_fail("line 15950");
      }
      _t8095 = _t8234;
      break _t8096;
    }
    if (_t8094._tag === 12) {
      const mod_name = _t8094._val[0];
      const names_opt = _t8094._val[1];
      let _t8237;
      const _t8236 = Typechecker$process_open(ctx, mod_name, names_opt);
      _t8238: {
        if (true) {
          const ctx$p = _t8236[0];
          const td = _t8236[1];
          _t8237 = [ctx$p, ({_hd: td, _tl: null})];
          break _t8238;
        }
        _match_fail("line 15950");
      }
      _t8095 = _t8237;
      break _t8096;
    }
    if (_t8094._tag === 3) {
      const bindings = _t8094._val;
      function _t8239(__p257) {
        let _t8241;
        const _t8240 = __p257;
        _t8242: {
          if (true) {
            const tp = _t8240[1];
            _t8241 = !_eq(tp, null);
            break _t8242;
          }
          _match_fail("line 15950");
        }
        return _t8241;
      }
      const has_poly_8243 = List$exists(_t8239, bindings);
      let _t8245;
      if (has_poly_8243) {
        function _t8246(__p258) {
          let _t8248;
          const _t8247 = __p258;
          _t8249: {
            if (true) {
              const type_params = _t8247[1];
              const params = _t8247[2];
              const ret_annot = _t8247[3];
              const shared_tvars_8250 = Hashtbl$create(4);
              function _t8252(tp) {
                return _call(Hashtbl$set, [__dict_Hash_string, __dict_Eq_string, shared_tvars_8250, tp, Types$new_tvar((level + 1))]);
              }
              List$iter(_t8252, type_params);
              function _t8253(p) {
                let _t8255;
                const _t8254 = p.annot;
                _t8256: {
                  if (_t8254._tag === 1) {
                    const annot = _t8254._val;
                    _t8255 = Typechecker$resolve_ty_annot_shared(ctx, (level + 1), shared_tvars_8250, annot);
                    break _t8256;
                  }
                  if (_t8254._tag === 0) {
                    _t8255 = Types$new_tvar((level + 1));
                    break _t8256;
                  }
                  _match_fail("line 15950");
                }
                return _t8255;
              }
              const param_tys_8257 = List$map(_t8253, params);
              let _t8260;
              const _t8259 = ret_annot;
              _t8261: {
                if (_t8259._tag === 1 && _t8259._val._tag === 11) {
                  const ty = _t8259._val._val[0];
                  const eff_annot = _t8259._val._val[1];
                  const ty$p_8262 = Typechecker$resolve_ty_annot_shared(ctx, (level + 1), shared_tvars_8250, ty);
                  let _t8265;
                  const _t8264 = eff_annot;
                  _t8266: {
                    if (_t8264._tag === 0) {
                      _t8265 = ({_tag: 1, _name: "EffEmpty"});
                      break _t8266;
                    }
                    if (_t8264._tag === 1) {
                      const items = _t8264._val;
                      _t8265 = Typechecker$resolve_eff_items(ctx, (level + 1), shared_tvars_8250, items);
                      break _t8266;
                    }
                    _match_fail("line 15950");
                  }
                  const eff_8267 = _t8265;
                  const _t8268 = [ty$p_8262, eff_8267];
                  const _t8263 = _t8268;
                  _t8260 = _t8263;
                  break _t8261;
                }
                if (_t8259._tag === 1) {
                  const annot = _t8259._val;
                  _t8260 = [Typechecker$resolve_ty_annot_shared(ctx, (level + 1), shared_tvars_8250, annot), Types$new_effvar((level + 1))];
                  break _t8261;
                }
                if (_t8259._tag === 0) {
                  _t8260 = [Types$new_tvar((level + 1)), Types$new_effvar((level + 1))];
                  break _t8261;
                }
                _match_fail("line 15950");
              }
              let _t8270;
              const _t8269 = _t8260;
              _t8271: {
                if (true) {
                  const ret_ty = _t8269[0];
                  const body_eff = _t8269[1];
                  let _t8273;
                  const _t8272 = List$rev(param_tys_8257);
                  _t8274: {
                    if (_t8272 === null) {
                      _t8273 = ret_ty;
                      break _t8274;
                    }
                    if (_t8272 !== null) {
                      const last = _t8272._hd;
                      const rest = _t8272._tl;
                      const inner_8275 = ({_tag: 7, _name: "TArrow", _val: [last, body_eff, ret_ty]});
                      function _t8277(acc, pty) {
                        return ({_tag: 7, _name: "TArrow", _val: [pty, ({_tag: 1, _name: "EffEmpty"}), acc]});
                      }
                      const _t8276 = List$fold(_t8277, inner_8275, rest);
                      _t8273 = _t8276;
                      break _t8274;
                    }
                    _match_fail("line 15950");
                  }
                  const fn_ty_8278 = _t8273;
                  const _t8279 = [shared_tvars_8250, param_tys_8257, ret_ty, body_eff, fn_ty_8278];
                  _t8270 = _t8279;
                  break _t8271;
                }
                _match_fail("line 15950");
              }
              const _t8258 = _t8270;
              const _t8251 = _t8258;
              _t8248 = _t8251;
              break _t8249;
            }
            _match_fail("line 15950");
          }
          return _t8248;
        }
        const shared_tvars_list_8280 = List$map(_t8246, bindings);
        function _t8282(__p259) {
          let _t8284;
          const _t8283 = __p259;
          _t8285: {
            if (true) {
              const fn_ty = _t8283[4];
              _t8284 = Types$generalize(level, fn_ty);
              break _t8285;
            }
            _match_fail("line 15950");
          }
          return _t8284;
        }
        const schemes_8286 = List$map(_t8282, shared_tvars_list_8280);
        function _t8288(ctx, __p260, scheme) {
          let _t8290;
          const _t8289 = __p260;
          _t8291: {
            if (true) {
              const name = _t8289[0];
              _t8290 = Typechecker$extend_var(ctx, name, scheme);
              break _t8291;
            }
            _match_fail("line 15950");
          }
          return _t8290;
        }
        const ctx$p_8292 = List$fold2(_t8288, ctx, bindings, schemes_8286);
        function _t8294(__p261, __p262) {
          let _t8296;
          const _t8295 = __p261;
          _t8297: {
            if (true) {
              const params = _t8295[2];
              const body = _t8295[5];
              let _t8299;
              const _t8298 = __p262;
              _t8300: {
                if (true) {
                  const param_tys = _t8298[1];
                  const ret_ty = _t8298[2];
                  const body_eff = _t8298[3];
                  function _t8301(c, p, ty) {
                    return Typechecker$extend_var_mono(c, p.name, ty);
                  }
                  const __rec_upd_8302 = ctx$p_8292;
                  const _t8303 = ({constraint_tvars: __rec_upd_8302.constraint_tvars, current_eff: body_eff, current_module: __rec_upd_8302.current_module, inside_handler: __rec_upd_8302.inside_handler, loop_info: __rec_upd_8302.loop_info, mutable_vars: __rec_upd_8302.mutable_vars, return_type: __rec_upd_8302.return_type, return_used: __rec_upd_8302.return_used, type_env: __rec_upd_8302.type_env, vars: __rec_upd_8302.vars});
                  const inner_ctx_8304 = List$fold2(_t8301, _t8303, params, param_tys);
                  const body_te_8306 = Typechecker$check(inner_ctx_8304, (level + 1), body, ret_ty);
                  let _t8309;
                  const _t8308 = [List$rev(params), List$rev(param_tys)];
                  _t8310: {
                    if (_t8308[0] === null && _t8308[1] === null) {
                      _t8309 = body_te_8306;
                      break _t8310;
                    }
                    if (_t8308[0] !== null && _t8308[1] !== null) {
                      const last_p = _t8308[0]._hd;
                      const rest_ps = _t8308[0]._tl;
                      const last_pty = _t8308[1]._hd;
                      const rest_ptys = _t8308[1]._tl;
                      const inner_8311 = Typechecker$mk(({_tag: 10, _name: "TEFun", _val: [last_p.name, body_te_8306, false]}), ({_tag: 7, _name: "TArrow", _val: [last_pty, body_eff, body_te_8306.ty]}));
                      function _t8313(acc, p, pty) {
                        return Typechecker$mk(({_tag: 10, _name: "TEFun", _val: [p.name, acc, false]}), ({_tag: 7, _name: "TArrow", _val: [pty, ({_tag: 1, _name: "EffEmpty"}), acc.ty]}));
                      }
                      const _t8312 = List$fold2(_t8313, inner_8311, rest_ps, rest_ptys);
                      _t8309 = _t8312;
                      break _t8310;
                    }
                    if (true) {
                      _t8309 = failwith("assert false");
                      break _t8310;
                    }
                    _match_fail("line 15950");
                  }
                  const _t8307 = _t8309;
                  const _t8305 = _t8307;
                  _t8299 = _t8305;
                  break _t8300;
                }
                _match_fail("line 15950");
              }
              _t8296 = _t8299;
              break _t8297;
            }
            _match_fail("line 15950");
          }
          return _t8296;
        }
        const body_tes_8314 = List$map2(_t8294, bindings, shared_tvars_list_8280);
        function _t8316(ctx, __p263, scheme) {
          let _t8318;
          const _t8317 = __p263;
          _t8319: {
            if (true) {
              const name = _t8317[0];
              _t8318 = Typechecker$extend_var(ctx, name, scheme);
              break _t8319;
            }
            _match_fail("line 15950");
          }
          return _t8318;
        }
        const ctx$p$p_8320 = List$fold2(_t8316, ctx, bindings, schemes_8286);
        function _t8322(__p264, te) {
          let _t8324;
          const _t8323 = __p264;
          _t8325: {
            if (true) {
              const name = _t8323[0];
              _t8324 = [name, te];
              break _t8325;
            }
            _match_fail("line 15950");
          }
          return _t8324;
        }
        const typed_bindings_8326 = List$map2(_t8322, bindings, body_tes_8314);
        const _t8327 = [ctx$p$p_8320, ({_hd: ({_tag: 3, _name: "TDLetRecAnd", _val: typed_bindings_8326}), _tl: null})];
        const _t8321 = _t8327;
        const _t8315 = _t8321;
        const _t8293 = _t8315;
        const _t8287 = _t8293;
        const _t8281 = _t8287;
        _t8245 = _t8281;
      } else {
        function _t8328(__p265) {
          let _t8330;
          const _t8329 = __p265;
          _t8331: {
            if (true) {
              const name = _t8329[0];
              _t8330 = [name, Types$new_tvar((level + 1))];
              break _t8331;
            }
            _match_fail("line 15950");
          }
          return _t8330;
        }
        const fn_vars_8332 = List$map(_t8328, bindings);
        function _t8334(ctx, __p266) {
          let _t8336;
          const _t8335 = __p266;
          _t8337: {
            if (true) {
              const name = _t8335[0];
              const tv = _t8335[1];
              _t8336 = Typechecker$extend_var_mono(ctx, name, tv);
              break _t8337;
            }
            _match_fail("line 15950");
          }
          return _t8336;
        }
        const ctx$p_8338 = List$fold(_t8334, ctx, fn_vars_8332);
        function _t8340(__p267, __p268) {
          let _t8342;
          const _t8341 = __p267;
          _t8343: {
            if (true) {
              const name = _t8341[0];
              const params = _t8341[2];
              const ret_annot = _t8341[3];
              const constraints = _t8341[4];
              const body = _t8341[5];
              let _t8345;
              const _t8344 = __p268;
              _t8346: {
                if (true) {
                  const tv = _t8344[1];
                  name;
                  undefined;
                  let _t8347;
                  if (!_eq(constraints, null)) {
                    let _t8349;
                    const _t8348 = Typechecker$synth_constrained_fn(ctx$p_8338, level, constraints, params, ret_annot, body);
                    _t8350: {
                      if (true) {
                        const te = _t8348[0];
                        const _scheme = _t8348[1];
                        Typechecker$try_unify(tv, te.ty);
                        _t8349 = te;
                        break _t8350;
                      }
                      _match_fail("line 15950");
                    }
                    _t8347 = _t8349;
                  } else {
                    const full_body_8351 = Typechecker$wrap_params_decl(params, ret_annot, body);
                    const te_8353 = Typechecker$synth(ctx$p_8338, (level + 1), full_body_8351);
                    Typechecker$try_unify(tv, te_8353.ty);
                    const _t8354 = te_8353;
                    const _t8352 = _t8354;
                    _t8347 = _t8352;
                  }
                  _t8345 = _t8347;
                  break _t8346;
                }
                _match_fail("line 15950");
              }
              _t8342 = _t8345;
              break _t8343;
            }
            _match_fail("line 15950");
          }
          return _t8342;
        }
        const body_tes_8355 = List$map2(_t8340, bindings, fn_vars_8332);
        function _t8357(ctx, __p269, __p270) {
          let _t8359;
          const _t8358 = __p269;
          _t8360: {
            if (true) {
              const name = _t8358[0];
              let _t8362;
              const _t8361 = __p270;
              _t8363: {
                if (true) {
                  const tv = _t8361[1];
                  const scheme_8364 = Types$generalize(level, tv);
                  const _t8365 = Typechecker$extend_var(ctx, name, scheme_8364);
                  _t8362 = _t8365;
                  break _t8363;
                }
                _match_fail("line 15950");
              }
              _t8359 = _t8362;
              break _t8360;
            }
            _match_fail("line 15950");
          }
          return _t8359;
        }
        const ctx$p$p_8366 = List$fold2(_t8357, ctx, bindings, fn_vars_8332);
        function _t8368(__p271, te) {
          let _t8370;
          const _t8369 = __p271;
          _t8371: {
            if (true) {
              const name = _t8369[0];
              _t8370 = [name, te];
              break _t8371;
            }
            _match_fail("line 15950");
          }
          return _t8370;
        }
        const typed_bindings_8372 = List$map2(_t8368, bindings, body_tes_8355);
        const _t8373 = [ctx$p$p_8366, ({_hd: ({_tag: 3, _name: "TDLetRecAnd", _val: typed_bindings_8372}), _tl: null})];
        const _t8367 = _t8373;
        const _t8356 = _t8367;
        const _t8339 = _t8356;
        const _t8333 = _t8339;
        _t8245 = _t8333;
      }
      const _t8244 = _t8245;
      _t8095 = _t8244;
      break _t8096;
    }
    if (_t8094._tag === 5) {
      const type_defs = _t8094._val;
      function _t8374(ctx, __p272) {
        let _t8376;
        const _t8375 = __p272;
        _t8377: {
          if (true) {
            const type_params = _t8375[0];
            const name = _t8375[1];
            const def = _t8375[2];
            const _deriving = _t8375[3];
            const num_params_8378 = List$length(type_params);
            let _t8381;
            const _t8380 = def;
            _t8382: {
              if (_t8380._tag === 0) {
                const __rec_upd_8383 = ctx.type_env;
                const _t8384 = ({classes: __rec_upd_8383.classes, constructors: __rec_upd_8383.constructors, effects: __rec_upd_8383.effects, instances: __rec_upd_8383.instances, modules: __rec_upd_8383.modules, mutable_fields: __rec_upd_8383.mutable_fields, records: __rec_upd_8383.records, type_aliases: __rec_upd_8383.type_aliases, type_synonyms: __rec_upd_8383.type_synonyms, variants: ({_hd: [name, num_params_8378, null, false], _tl: ctx.type_env.variants})});
                const type_env_8385 = _t8384;
                const __rec_upd_8387 = ctx;
                const _t8388 = ({constraint_tvars: __rec_upd_8387.constraint_tvars, current_eff: __rec_upd_8387.current_eff, current_module: __rec_upd_8387.current_module, inside_handler: __rec_upd_8387.inside_handler, loop_info: __rec_upd_8387.loop_info, mutable_vars: __rec_upd_8387.mutable_vars, return_type: __rec_upd_8387.return_type, return_used: __rec_upd_8387.return_used, type_env: type_env_8385, vars: __rec_upd_8387.vars});
                const _t8386 = _t8388;
                _t8381 = _t8386;
                break _t8382;
              }
              if (_t8380._tag === 1) {
                const __rec_upd_8389 = ctx.type_env;
                const _t8390 = ({classes: __rec_upd_8389.classes, constructors: __rec_upd_8389.constructors, effects: __rec_upd_8389.effects, instances: __rec_upd_8389.instances, modules: __rec_upd_8389.modules, mutable_fields: __rec_upd_8389.mutable_fields, records: ({_hd: [name, null], _tl: ctx.type_env.records}), type_aliases: __rec_upd_8389.type_aliases, type_synonyms: __rec_upd_8389.type_synonyms, variants: __rec_upd_8389.variants});
                const type_env_8391 = _t8390;
                const __rec_upd_8393 = ctx;
                const _t8394 = ({constraint_tvars: __rec_upd_8393.constraint_tvars, current_eff: __rec_upd_8393.current_eff, current_module: __rec_upd_8393.current_module, inside_handler: __rec_upd_8393.inside_handler, loop_info: __rec_upd_8393.loop_info, mutable_vars: __rec_upd_8393.mutable_vars, return_type: __rec_upd_8393.return_type, return_used: __rec_upd_8393.return_used, type_env: type_env_8391, vars: __rec_upd_8393.vars});
                const _t8392 = _t8394;
                _t8381 = _t8392;
                break _t8382;
              }
              if (_t8380._tag === 2) {
                _t8381 = ctx;
                break _t8382;
              }
              _match_fail("line 15950");
            }
            const _t8379 = _t8381;
            _t8376 = _t8379;
            break _t8377;
          }
          _match_fail("line 15950");
        }
        return _t8376;
      }
      const ctx$p_8395 = List$fold(_t8374, ctx, type_defs);
      function _t8397(ctx, __p273) {
        let _t8399;
        const _t8398 = __p273;
        _t8400: {
          if (true) {
            const type_params = _t8398[0];
            const name = _t8398[1];
            const def = _t8398[2];
            const _deriving = _t8398[3];
            let _t8402;
            const _t8401 = def;
            _t8403: {
              if (_t8401._tag === 1) {
                _t8402 = Typechecker$process_type_def(ctx, type_params, name, def);
                break _t8403;
              }
              if (true) {
                _t8402 = ctx;
                break _t8403;
              }
              _match_fail("line 15950");
            }
            _t8399 = _t8402;
            break _t8400;
          }
          _match_fail("line 15950");
        }
        return _t8399;
      }
      const ctx$p_8404 = List$fold(_t8397, ctx$p_8395, type_defs);
      function _t8406(ctx, __p274) {
        let _t8408;
        const _t8407 = __p274;
        _t8409: {
          if (true) {
            const type_params = _t8407[0];
            const name = _t8407[1];
            const def = _t8407[2];
            const _deriving = _t8407[3];
            let _t8411;
            const _t8410 = def;
            _t8412: {
              if (_t8410._tag === 1) {
                _t8411 = ctx;
                break _t8412;
              }
              if (true) {
                _t8411 = Typechecker$process_type_def(ctx, type_params, name, def);
                break _t8412;
              }
              _match_fail("line 15950");
            }
            _t8408 = _t8411;
            break _t8409;
          }
          _match_fail("line 15950");
        }
        return _t8408;
      }
      const ctx$p$p_8413 = List$fold(_t8406, ctx$p_8404, type_defs);
      function _t8415(__p275, __p276) {
        let _t8417;
        const _t8416 = __p275;
        _t8418: {
          if (true) {
            const ctx = _t8416[0];
            const acc = _t8416[1];
            let _t8420;
            const _t8419 = __p276;
            _t8421: {
              if (true) {
                const type_params = _t8419[0];
                const name = _t8419[1];
                const def = _t8419[2];
                const deriving_ = _t8419[3];
                function _t8422(__p277, cls) {
                  let _t8424;
                  const _t8423 = __p277;
                  _t8425: {
                    if (true) {
                      const ctx = _t8423[0];
                      const acc = _t8423[1];
                      let _t8427;
                      const _t8426 = Typechecker$generate_derived_instance(type_params, name, def, cls);
                      _t8428: {
                        if (_t8426._tag === 1) {
                          const class_name = _t8426._val[0];
                          const inst_tys = _t8426._val[1];
                          const constraints = _t8426._val[2];
                          const methods = _t8426._val[3];
                          let _t8430;
                          const _t8429 = Typechecker$process_instance_def(ctx, level, class_name, inst_tys, constraints, methods);
                          _t8431: {
                            if (true) {
                              const ctx$p = _t8429[0];
                              const tdecl = _t8429[1];
                              _t8430 = [ctx$p, ({_hd: tdecl, _tl: acc})];
                              break _t8431;
                            }
                            _match_fail("line 15950");
                          }
                          _t8427 = _t8430;
                          break _t8428;
                        }
                        if (_t8426._tag === 0) {
                          _t8427 = Typechecker$error(((("cannot derive " + __dict_Show_string.show(cls)) + " for type ") + __dict_Show_string.show(name)));
                          break _t8428;
                        }
                        _match_fail("line 15950");
                      }
                      _t8424 = _t8427;
                      break _t8425;
                    }
                    _match_fail("line 15950");
                  }
                  return _t8424;
                }
                let _t8433;
                const _t8432 = List$fold(_t8422, [ctx, null], deriving_);
                _t8434: {
                  if (true) {
                    const ctx$p = _t8432[0];
                    const new_decls = _t8432[1];
                    _t8433 = [ctx$p, List$concat(List$rev(new_decls), acc)];
                    break _t8434;
                  }
                  _match_fail("line 15950");
                }
                _t8420 = _t8433;
                break _t8421;
              }
              _match_fail("line 15950");
            }
            _t8417 = _t8420;
            break _t8418;
          }
          _match_fail("line 15950");
        }
        return _t8417;
      }
      let _t8436;
      const _t8435 = List$fold(_t8415, [ctx$p$p_8413, null], type_defs);
      _t8437: {
        if (true) {
          const ctx_final = _t8435[0];
          const derived_tdecls = _t8435[1];
          function _t8438(__p278) {
            let _t8440;
            const _t8439 = __p278;
            _t8441: {
              if (true) {
                const _tp = _t8439[0];
                const name = _t8439[1];
                const def = _t8439[2];
                const _d = _t8439[3];
                _t8440 = ({_tag: 4, _name: "TDType", _val: [name, def]});
                break _t8441;
              }
              _match_fail("line 15950");
            }
            return _t8440;
          }
          const type_decls_8442 = List$map(_t8438, type_defs);
          const _t8443 = [ctx_final, List$concat(type_decls_8442, List$rev(derived_tdecls))];
          _t8436 = _t8443;
          break _t8437;
        }
        _match_fail("line 15950");
      }
      const _t8414 = _t8436;
      const _t8405 = _t8414;
      const _t8396 = _t8405;
      _t8095 = _t8396;
      break _t8096;
    }
    _match_fail("line 15950");
  }
  return _t8095;
}
const Typechecker$empty_ctx = ({constraint_tvars: null, current_eff: ({_tag: 1, _name: "EffEmpty"}), current_module: ({_tag: 0, _name: "None"}), inside_handler: false, loop_info: ({_tag: 0, _name: "None"}), mutable_vars: null, return_type: ({_tag: 0, _name: "None"}), return_used: Ref$create(false), type_env: Types$empty_type_env, vars: null});
function Typechecker$build_tgen_map(schema_ty, actual_ty) {
  const map_8444 = Hashtbl$create(4);
  function walk(s, a) {
    while (true) {
      const a_8446 = Types$repr(a);
      let _t8449;
      const _t8448 = s;
      _t8450: {
        if (_t8448._tag === 17) {
          const i = _t8448._val;
          let _t8451;
          if ((!_call(Hashtbl$has, [__dict_Hash_int, __dict_Eq_int, map_8444, i]))) {
            _t8451 = _call(Hashtbl$set, [__dict_Hash_int, __dict_Eq_int, map_8444, i, a_8446]);
          } else {
            _t8451 = undefined;
          }
          _t8449 = _t8451;
          break _t8450;
        }
        if (_t8448._tag === 7) {
          const s1 = _t8448._val[0];
          const s2 = _t8448._val[2];
          let _t8453;
          const _t8452 = a_8446;
          _t8454: {
            if (_t8452._tag === 7) {
              const a1 = _t8452._val[0];
              const a2 = _t8452._val[2];
              walk(s1, a1);
              const _t8455 = s2;
              const _t8456 = a2;
              s = _t8455;
              a = _t8456;
              continue;
              _t8453 = undefined;
              break _t8454;
            }
            if (true) {
              _t8453 = undefined;
              break _t8454;
            }
            _match_fail("line 15950");
          }
          _t8449 = _t8453;
          break _t8450;
        }
        if (_t8448._tag === 8) {
          const s1 = _t8448._val[0];
          const s2 = _t8448._val[2];
          let _t8458;
          const _t8457 = a_8446;
          _t8459: {
            if (_t8457._tag === 8) {
              const a1 = _t8457._val[0];
              const a2 = _t8457._val[2];
              walk(s1, a1);
              const _t8460 = s2;
              const _t8461 = a2;
              s = _t8460;
              a = _t8461;
              continue;
              _t8458 = undefined;
              break _t8459;
            }
            if (true) {
              _t8458 = undefined;
              break _t8459;
            }
            _match_fail("line 15950");
          }
          _t8449 = _t8458;
          break _t8450;
        }
        if (_t8448._tag === 9) {
          const ss = _t8448._val;
          let _t8463;
          const _t8462 = a_8446;
          _t8464: {
            if (_t8462._tag === 9) {
              const aa = _t8462._val;
              if ((List$length(ss) === List$length(aa))) {
                _t8463 = List$iter2(walk, ss, aa);
                break _t8464;
              }
            }
            if (true) {
              _t8463 = undefined;
              break _t8464;
            }
            _match_fail("line 15950");
          }
          _t8449 = _t8463;
          break _t8450;
        }
        if (_t8448._tag === 10) {
          const s1 = _t8448._val;
          let _t8466;
          const _t8465 = a_8446;
          _t8467: {
            if (_t8465._tag === 10) {
              const a1 = _t8465._val;
              const _t8468 = s1;
              const _t8469 = a1;
              s = _t8468;
              a = _t8469;
              continue;
              _t8466 = undefined;
              break _t8467;
            }
            if (true) {
              _t8466 = undefined;
              break _t8467;
            }
            _match_fail("line 15950");
          }
          _t8449 = _t8466;
          break _t8450;
        }
        if (_t8448._tag === 14) {
          const s1 = _t8448._val;
          let _t8471;
          const _t8470 = a_8446;
          _t8472: {
            if (_t8470._tag === 14) {
              const a1 = _t8470._val;
              const _t8473 = s1;
              const _t8474 = a1;
              s = _t8473;
              a = _t8474;
              continue;
              _t8471 = undefined;
              break _t8472;
            }
            if (true) {
              _t8471 = undefined;
              break _t8472;
            }
            _match_fail("line 15950");
          }
          _t8449 = _t8471;
          break _t8450;
        }
        if (_t8448._tag === 13) {
          const sk = _t8448._val[0];
          const sv = _t8448._val[1];
          let _t8476;
          const _t8475 = a_8446;
          _t8477: {
            if (_t8475._tag === 13) {
              const ak = _t8475._val[0];
              const av = _t8475._val[1];
              walk(sk, ak);
              const _t8478 = sv;
              const _t8479 = av;
              s = _t8478;
              a = _t8479;
              continue;
              _t8476 = undefined;
              break _t8477;
            }
            if (true) {
              _t8476 = undefined;
              break _t8477;
            }
            _match_fail("line 15950");
          }
          _t8449 = _t8476;
          break _t8450;
        }
        if (_t8448._tag === 12) {
          const ss = _t8448._val[1];
          let _t8481;
          const _t8480 = a_8446;
          _t8482: {
            if (_t8480._tag === 12) {
              const aa = _t8480._val[1];
              if ((List$length(ss) === List$length(aa))) {
                _t8481 = List$iter2(walk, ss, aa);
                break _t8482;
              }
            }
            if (true) {
              _t8481 = undefined;
              break _t8482;
            }
            _match_fail("line 15950");
          }
          _t8449 = _t8481;
          break _t8450;
        }
        if (_t8448._tag === 11) {
          const srow = _t8448._val;
          let _t8484;
          const _t8483 = a_8446;
          _t8485: {
            if (_t8483._tag === 11) {
              const arow = _t8483._val;
              const sf_8486 = Types$record_row_to_fields(srow);
              const af_8488 = Types$record_row_to_fields(arow);
              function _t8490(__p279) {
                let _t8492;
                const _t8491 = __p279;
                _t8493: {
                  if (true) {
                    const sname = _t8491[0];
                    const sty = _t8491[1];
                    let _t8495;
                    const _t8494 = List$assoc_opt(sname, af_8488);
                    _t8496: {
                      if (_t8494._tag === 1) {
                        const aty = _t8494._val;
                        _t8495 = walk(sty, aty);
                        break _t8496;
                      }
                      if (_t8494._tag === 0) {
                        _t8495 = undefined;
                        break _t8496;
                      }
                      _match_fail("line 15950");
                    }
                    _t8492 = _t8495;
                    break _t8493;
                  }
                  _match_fail("line 15950");
                }
                return _t8492;
              }
              const _t8489 = List$iter(_t8490, sf_8486);
              const _t8487 = _t8489;
              _t8484 = _t8487;
              break _t8485;
            }
            if (true) {
              _t8484 = undefined;
              break _t8485;
            }
            _match_fail("line 15950");
          }
          _t8449 = _t8484;
          break _t8450;
        }
        if (_t8448._tag === 15) {
          const srow = _t8448._val;
          let _t8498;
          const _t8497 = a_8446;
          _t8499: {
            if (_t8497._tag === 15) {
              const arow = _t8497._val;
              _t8498 = walk_pvrows(srow, arow);
              break _t8499;
            }
            if (true) {
              _t8498 = undefined;
              break _t8499;
            }
            _match_fail("line 15950");
          }
          _t8449 = _t8498;
          break _t8450;
        }
        if (true) {
          _t8449 = undefined;
          break _t8450;
        }
        _match_fail("line 15950");
      }
      const _t8447 = _t8449;
      return _t8447;
    }
  }
  function walk_pvrows(srow, arow) {
    function collect_tags(row) {
      while (true) {
        let _t8501;
        const _t8500 = row;
        _t8502: {
          if (_t8500._tag === 0) {
            const tag = _t8500._val[0];
            const ty_opt = _t8500._val[1];
            const tail = _t8500._val[2];
            _t8501 = ({_hd: [tag, ty_opt], _tl: collect_tags(tail)});
            break _t8502;
          }
          if (_t8500._tag === 1 && _t8500._val.contents._tag === 1) {
            const r = _t8500._val.contents._val;
            const _t8503 = r;
            row = _t8503;
            continue;
            _t8501 = undefined;
            break _t8502;
          }
          if (true) {
            _t8501 = null;
            break _t8502;
          }
          _match_fail("line 15950");
        }
        return _t8501;
      }
    }
    const atags_8505 = collect_tags(arow);
    function go(row) {
      while (true) {
        let _t8508;
        const _t8507 = row;
        _t8509: {
          if (_t8507._tag === 0) {
            const stag = _t8507._val[0];
            const sty_opt = _t8507._val[1];
            const stail = _t8507._val[2];
            let _t8511;
            const _t8510 = List$assoc_opt(stag, atags_8505);
            _t8512: {
              if (_t8510._tag === 1) {
                const aty_opt = _t8510._val;
                let _t8514;
                const _t8513 = [sty_opt, aty_opt];
                _t8515: {
                  if (_t8513[0]._tag === 1 && _t8513[1]._tag === 1) {
                    const sty = _t8513[0]._val;
                    const aty = _t8513[1]._val;
                    _t8514 = walk(sty, aty);
                    break _t8515;
                  }
                  if (true) {
                    _t8514 = undefined;
                    break _t8515;
                  }
                  _match_fail("line 15950");
                }
                _t8511 = _t8514;
                break _t8512;
              }
              if (_t8510._tag === 0) {
                _t8511 = undefined;
                break _t8512;
              }
              _match_fail("line 15950");
            }
            _t8511;
            const _t8516 = stail;
            row = _t8516;
            continue;
            _t8508 = undefined;
            break _t8509;
          }
          if (_t8507._tag === 1 && _t8507._val.contents._tag === 1) {
            const r = _t8507._val.contents._val;
            const _t8517 = r;
            row = _t8517;
            continue;
            _t8508 = undefined;
            break _t8509;
          }
          if (true) {
            _t8508 = undefined;
            break _t8509;
          }
          _match_fail("line 15950");
        }
        return _t8508;
      }
    }
    const _t8518 = go(srow);
    const _t8506 = _t8518;
    const _t8504 = _t8506;
    return _t8504;
  }
  walk(schema_ty, actual_ty);
  const _t8519 = map_8444;
  const _t8445 = _t8519;
  return _t8445;
}
function Typechecker$find_constrained_dict(xctx, tvar_id, class_name) {
  function _t8520(__p280) {
    let _t8522;
    const _t8521 = __p280;
    _t8523: {
      if (true) {
        const tid = _t8521[0];
        const dparam = _t8521[1];
        const cls = _t8521[2];
        let _t8524;
        if (((tid === tvar_id) && (cls === class_name))) {
          _t8524 = ({_tag: 1, _name: "Some", _val: dparam});
        } else {
          _t8524 = ({_tag: 0, _name: "None"});
        }
        _t8522 = _t8524;
        break _t8523;
      }
      _match_fail("line 15950");
    }
    return _t8522;
  }
  return List$find_map(_t8520, xctx.xf_constrained);
}
function Typechecker$resolve_dict_arg(xctx, cc, tgen_map) {
  function _t8525(ca) {
    let _t8527;
    const _t8526 = ca;
    _t8528: {
      if (_t8526._tag === 0) {
        const idx = _t8526._val;
        let _t8530;
        const _t8529 = _call(Hashtbl$get, [__dict_Hash_int, __dict_Eq_int, tgen_map, idx]);
        _t8531: {
          if (_t8529._tag === 1) {
            const ty = _t8529._val;
            _t8530 = ({_tag: 1, _name: "Some", _val: Types$repr(ty)});
            break _t8531;
          }
          if (_t8529._tag === 0) {
            _t8530 = ({_tag: 0, _name: "None"});
            break _t8531;
          }
          _match_fail("line 15950");
        }
        _t8527 = _t8530;
        break _t8528;
      }
      if (_t8526._tag === 1) {
        const ty = _t8526._val;
        _t8527 = ({_tag: 1, _name: "Some", _val: Types$freshen_unbound(ty)});
        break _t8528;
      }
      if (_t8526._tag === 2) {
        _t8527 = ({_tag: 1, _name: "Some", _val: Types$new_tvar(1)});
        break _t8528;
      }
      if (_t8526._tag === 3) {
        const idx = _t8526._val[0];
        let _t8533;
        const _t8532 = _call(Hashtbl$get, [__dict_Hash_int, __dict_Eq_int, tgen_map, idx]);
        _t8534: {
          if (_t8532._tag === 1) {
            const ty = _t8532._val;
            _t8533 = ({_tag: 1, _name: "Some", _val: Types$repr(ty)});
            break _t8534;
          }
          if (_t8532._tag === 0) {
            const tv_8535 = Types$new_tvar(1);
            _call(Hashtbl$set, [__dict_Hash_int, __dict_Eq_int, tgen_map, idx, tv_8535]);
            const _t8536 = ({_tag: 1, _name: "Some", _val: tv_8535});
            _t8533 = _t8536;
            break _t8534;
          }
          _match_fail("line 15950");
        }
        _t8527 = _t8533;
        break _t8528;
      }
      _match_fail("line 15950");
    }
    return _t8527;
  }
  const arg_types_8537 = List$map(_t8525, cc.cc_args);
  function _t8539(opt) {
    return _eq(opt, ({_tag: 0, _name: "None"}));
  }
  const has_unresolved_8540 = List$exists(_t8539, arg_types_8537);
  let _t8542;
  if (has_unresolved_8540) {
    let _t8543;
    if ((cc.cc_class === "Show")) {
      _t8543 = Typechecker$mk(({_tag: 16, _name: "TERecord", _val: ({_hd: ["show", Typechecker$mk(({_tag: 7, _name: "TEVar", _val: "__show_value"}), ({_tag: 6, _name: "TUnit"}))], _tl: null})}), ({_tag: 6, _name: "TUnit"}));
    } else {
      _t8543 = Typechecker$error(("could not resolve constraint type argument for " + __dict_Show_string.show(cc.cc_class)));
    }
    _t8542 = _t8543;
  } else {
    function _t8544(x) {
      return x;
    }
    const arg_types_8545 = List$filter_map(_t8544, arg_types_8537);
    function _t8547(ty) {
      let _t8549;
      const _t8548 = ty;
      _t8550: {
        if (_t8548._tag === 16 && _t8548._val.contents._tag === 0) {
          _t8549 = true;
          break _t8550;
        }
        if (true) {
          _t8549 = false;
          break _t8550;
        }
        _match_fail("line 15950");
      }
      return _t8549;
    }
    const has_unbound_8551 = List$exists(_t8547, arg_types_8545);
    let _t8553;
    if (has_unbound_8551) {
      function _t8554(cls) {
        return ((cls.class_name === cc.cc_class) && !_eq(cls.class_fundeps, null));
      }
      const class_opt_8555 = List$find(_t8554, xctx.xf_type_env.classes);
      let _t8558;
      const _t8557 = class_opt_8555;
      _t8559: {
        if (_t8557._tag === 1) {
          const class_def = _t8557._val;
          function _t8560(ty) {
            let _t8562;
            const _t8561 = Types$repr(ty);
            _t8563: {
              if (_t8561._tag === 16 && _t8561._val.contents._tag === 0) {
                _t8562 = ({_tag: 0, _name: "None"});
                break _t8563;
              }
              if (true) {
                const t = _t8561;
                _t8562 = ({_tag: 1, _name: "Some", _val: t});
                break _t8563;
              }
              _match_fail("line 15950");
            }
            return _t8562;
          }
          const partial_8564 = List$map(_t8560, arg_types_8545);
          const improved_8566 = Types$improve_with_fundeps(xctx.xf_type_env.instances, class_def, partial_8564);
          function _t8568(orig_ty, imp) {
            let _t8570;
            const _t8569 = [imp, Types$repr(orig_ty)];
            _t8571: {
              if (_t8569[0]._tag === 1 && _t8569[1]._tag === 16 && _t8569[1]._val.contents._tag === 0) {
                const resolved = _t8569[0]._val;
                const r = _t8569[1]._val;
                _t8570 = Types$unify(({_tag: 16, _name: "TVar", _val: r}), resolved);
                break _t8571;
              }
              if (true) {
                _t8570 = undefined;
                break _t8571;
              }
              _match_fail("line 15950");
            }
            return _t8570;
          }
          List$iter2(_t8568, arg_types_8545, improved_8566);
          const _t8567 = List$map(Types$repr, arg_types_8545);
          const _t8565 = _t8567;
          _t8558 = _t8565;
          break _t8559;
        }
        if (_t8557._tag === 0) {
          _t8558 = arg_types_8545;
          break _t8559;
        }
        _match_fail("line 15950");
      }
      const _t8556 = _t8558;
      _t8553 = _t8556;
    } else {
      _t8553 = arg_types_8545;
    }
    const _t8552 = _t8553;
    const arg_types_8572 = _t8552;
    function _t8574(ty) {
      let _t8576;
      const _t8575 = ty;
      _t8577: {
        if (_t8575._tag === 16 && _t8575._val.contents._tag === 0) {
          const id = _t8575._val.contents._val[0];
          _t8576 = Typechecker$find_constrained_dict(xctx, id, cc.cc_class);
          break _t8577;
        }
        if (true) {
          _t8576 = ({_tag: 0, _name: "None"});
          break _t8577;
        }
        _match_fail("line 15950");
      }
      return _t8576;
    }
    const constrained_match_8578 = List$find_map(_t8574, arg_types_8572);
    let _t8581;
    const _t8580 = constrained_match_8578;
    _t8582: {
      if (_t8580._tag === 1) {
        const dparam = _t8580._val;
        _t8581 = Typechecker$mk(({_tag: 7, _name: "TEVar", _val: dparam}), ({_tag: 6, _name: "TUnit"}));
        break _t8582;
      }
      if (_t8580._tag === 0) {
        function _t8583(ty) {
          let _t8585;
          const _t8584 = ty;
          _t8586: {
            if (_t8584._tag === 16 && _t8584._val.contents._tag === 0) {
              _t8585 = true;
              break _t8586;
            }
            if (true) {
              _t8585 = false;
              break _t8586;
            }
            _match_fail("line 15950");
          }
          return _t8585;
        }
        const has_unbound_tvar_8587 = List$exists(_t8583, arg_types_8572);
        let _t8589;
        if (has_unbound_tvar_8587) {
          let _t8590;
          if ((cc.cc_class === "Show")) {
            _t8590 = Typechecker$mk(({_tag: 16, _name: "TERecord", _val: ({_hd: ["show", Typechecker$mk(({_tag: 7, _name: "TEVar", _val: "__show_value"}), ({_tag: 6, _name: "TUnit"}))], _tl: null})}), ({_tag: 6, _name: "TUnit"}));
          } else {
            _t8590 = Typechecker$error(((("no instance of " + __dict_Show_string.show(cc.cc_class)) + " for types ") + __dict_Show_string.show(String$concat(", ", List$map(Types$pp_ty, arg_types_8572)))));
          }
          _t8589 = _t8590;
        } else {
          function _t8591(ty) {
            return ({_tag: 1, _name: "Some", _val: ty});
          }
          const partial_8592 = List$map(_t8591, arg_types_8572);
          function _t8594(inst) {
            return ((inst.inst_class === cc.cc_class) && ((List$length(inst.inst_tys) === List$length(arg_types_8572)) && Types$match_partial_inst(inst.inst_tys, partial_8592)));
          }
          const matching_8595 = List$filter(_t8594, xctx.xf_type_env.instances);
          let _t8598;
          const _t8597 = matching_8595;
          _t8599: {
            if (_t8597 !== null && _t8597._tl === null) {
              const inst = _t8597._hd;
              let _t8600;
              if (!_eq(inst.inst_constraints, null)) {
                _t8600 = Typechecker$resolve_factory_dict(xctx, inst, arg_types_8572);
              } else {
                _t8600 = Typechecker$mk(({_tag: 7, _name: "TEVar", _val: inst.inst_dict_name}), ({_tag: 6, _name: "TUnit"}));
              }
              _t8598 = _t8600;
              break _t8599;
            }
            if (_t8597 === null) {
              function _t8601(ty) {
                let _t8603;
                const _t8602 = Types$repr(ty);
                _t8604: {
                  if ((_t8602._tag === 15 || _t8602._tag === 11)) {
                    _t8603 = true;
                    break _t8604;
                  }
                  if (true) {
                    _t8603 = false;
                    break _t8604;
                  }
                  _match_fail("line 15950");
                }
                return _t8603;
              }
              const is_structural_8605 = List$exists(_t8601, arg_types_8572);
              let _t8607;
              if ((is_structural_8605 && (cc.cc_class === "Show"))) {
                _t8607 = Typechecker$mk(({_tag: 16, _name: "TERecord", _val: ({_hd: ["show", Typechecker$mk(({_tag: 7, _name: "TEVar", _val: "__show_value"}), ({_tag: 6, _name: "TUnit"}))], _tl: null})}), ({_tag: 6, _name: "TUnit"}));
              } else {
                _t8607 = Typechecker$error(((("no instance of " + __dict_Show_string.show(cc.cc_class)) + " for types ") + __dict_Show_string.show(String$concat(", ", List$map(Types$pp_ty, arg_types_8572)))));
              }
              const _t8606 = _t8607;
              _t8598 = _t8606;
              break _t8599;
            }
            if (true) {
              let _t8609;
              const _t8608 = Types$most_specific_inst(matching_8595);
              _t8610: {
                if (_t8608._tag === 1) {
                  const inst = _t8608._val;
                  let _t8611;
                  if (!_eq(inst.inst_constraints, null)) {
                    _t8611 = Typechecker$resolve_factory_dict(xctx, inst, arg_types_8572);
                  } else {
                    _t8611 = Typechecker$mk(({_tag: 7, _name: "TEVar", _val: inst.inst_dict_name}), ({_tag: 6, _name: "TUnit"}));
                  }
                  _t8609 = _t8611;
                  break _t8610;
                }
                if (_t8608._tag === 0) {
                  _t8609 = Typechecker$error(("ambiguous instance for " + __dict_Show_string.show(cc.cc_class)));
                  break _t8610;
                }
                _match_fail("line 15950");
              }
              _t8598 = _t8609;
              break _t8599;
            }
            _match_fail("line 15950");
          }
          const _t8596 = _t8598;
          const _t8593 = _t8596;
          _t8589 = _t8593;
        }
        const _t8588 = _t8589;
        _t8581 = _t8588;
        break _t8582;
      }
      _match_fail("line 15950");
    }
    const _t8579 = _t8581;
    const _t8573 = _t8579;
    const _t8546 = _t8573;
    _t8542 = _t8546;
  }
  const _t8541 = _t8542;
  const _t8538 = _t8541;
  return _t8538;
}
function Typechecker$resolve_factory_dict(xctx, inst, arg_types) {
  const sub_map_8612 = Hashtbl$create(4);
  function _t8614(inst_ty, actual_ty) {
    function walk(s, a) {
      while (true) {
        const a_8615 = Types$repr(a);
        let _t8618;
        const _t8617 = s;
        _t8619: {
          if (_t8617._tag === 17) {
            const i = _t8617._val;
            let _t8620;
            if ((!_call(Hashtbl$has, [__dict_Hash_int, __dict_Eq_int, sub_map_8612, i]))) {
              _t8620 = _call(Hashtbl$set, [__dict_Hash_int, __dict_Eq_int, sub_map_8612, i, a_8615]);
            } else {
              _t8620 = undefined;
            }
            _t8618 = _t8620;
            break _t8619;
          }
          if (_t8617._tag === 7) {
            const s1 = _t8617._val[0];
            const s2 = _t8617._val[2];
            let _t8622;
            const _t8621 = a_8615;
            _t8623: {
              if (_t8621._tag === 7) {
                const a1 = _t8621._val[0];
                const a2 = _t8621._val[2];
                walk(s1, a1);
                const _t8624 = s2;
                const _t8625 = a2;
                s = _t8624;
                a = _t8625;
                continue;
                _t8622 = undefined;
                break _t8623;
              }
              if (true) {
                _t8622 = undefined;
                break _t8623;
              }
              _match_fail("line 15950");
            }
            _t8618 = _t8622;
            break _t8619;
          }
          if (_t8617._tag === 8) {
            const s1 = _t8617._val[0];
            const s2 = _t8617._val[2];
            let _t8627;
            const _t8626 = a_8615;
            _t8628: {
              if (_t8626._tag === 8) {
                const a1 = _t8626._val[0];
                const a2 = _t8626._val[2];
                walk(s1, a1);
                const _t8629 = s2;
                const _t8630 = a2;
                s = _t8629;
                a = _t8630;
                continue;
                _t8627 = undefined;
                break _t8628;
              }
              if (true) {
                _t8627 = undefined;
                break _t8628;
              }
              _match_fail("line 15950");
            }
            _t8618 = _t8627;
            break _t8619;
          }
          if (_t8617._tag === 9) {
            const ss = _t8617._val;
            let _t8632;
            const _t8631 = a_8615;
            _t8633: {
              if (_t8631._tag === 9) {
                const aa = _t8631._val;
                if ((List$length(ss) === List$length(aa))) {
                  _t8632 = List$iter2(walk, ss, aa);
                  break _t8633;
                }
              }
              if (true) {
                _t8632 = undefined;
                break _t8633;
              }
              _match_fail("line 15950");
            }
            _t8618 = _t8632;
            break _t8619;
          }
          if (_t8617._tag === 10) {
            const s1 = _t8617._val;
            let _t8635;
            const _t8634 = a_8615;
            _t8636: {
              if (_t8634._tag === 10) {
                const a1 = _t8634._val;
                const _t8637 = s1;
                const _t8638 = a1;
                s = _t8637;
                a = _t8638;
                continue;
                _t8635 = undefined;
                break _t8636;
              }
              if (true) {
                _t8635 = undefined;
                break _t8636;
              }
              _match_fail("line 15950");
            }
            _t8618 = _t8635;
            break _t8619;
          }
          if (_t8617._tag === 14) {
            const s1 = _t8617._val;
            let _t8640;
            const _t8639 = a_8615;
            _t8641: {
              if (_t8639._tag === 14) {
                const a1 = _t8639._val;
                const _t8642 = s1;
                const _t8643 = a1;
                s = _t8642;
                a = _t8643;
                continue;
                _t8640 = undefined;
                break _t8641;
              }
              if (true) {
                _t8640 = undefined;
                break _t8641;
              }
              _match_fail("line 15950");
            }
            _t8618 = _t8640;
            break _t8619;
          }
          if (_t8617._tag === 13) {
            const sk = _t8617._val[0];
            const sv = _t8617._val[1];
            let _t8645;
            const _t8644 = a_8615;
            _t8646: {
              if (_t8644._tag === 13) {
                const ak = _t8644._val[0];
                const av = _t8644._val[1];
                walk(sk, ak);
                const _t8647 = sv;
                const _t8648 = av;
                s = _t8647;
                a = _t8648;
                continue;
                _t8645 = undefined;
                break _t8646;
              }
              if (true) {
                _t8645 = undefined;
                break _t8646;
              }
              _match_fail("line 15950");
            }
            _t8618 = _t8645;
            break _t8619;
          }
          if (_t8617._tag === 12) {
            const ss = _t8617._val[1];
            let _t8650;
            const _t8649 = a_8615;
            _t8651: {
              if (_t8649._tag === 12) {
                const aa = _t8649._val[1];
                if ((List$length(ss) === List$length(aa))) {
                  _t8650 = List$iter2(walk, ss, aa);
                  break _t8651;
                }
              }
              if (true) {
                _t8650 = undefined;
                break _t8651;
              }
              _match_fail("line 15950");
            }
            _t8618 = _t8650;
            break _t8619;
          }
          if (true) {
            _t8618 = undefined;
            break _t8619;
          }
          _match_fail("line 15950");
        }
        const _t8616 = _t8618;
        return _t8616;
      }
    }
    const _t8652 = walk(inst_ty, actual_ty);
    return _t8652;
  }
  List$iter2(_t8614, inst.inst_tys, arg_types);
  const base_8653 = Typechecker$mk(({_tag: 7, _name: "TEVar", _val: inst.inst_dict_name}), ({_tag: 6, _name: "TUnit"}));
  function _t8655(fn_, sub_cc) {
    const sub_dict_8656 = Typechecker$resolve_dict_arg(xctx, sub_cc, sub_map_8612);
    const _t8657 = Typechecker$mk(({_tag: 11, _name: "TEApp", _val: [fn_, sub_dict_8656]}), ({_tag: 6, _name: "TUnit"}));
    return _t8657;
  }
  const _t8654 = List$fold(_t8655, base_8653, inst.inst_constraints);
  const _t8613 = _t8654;
  return _t8613;
}
function Typechecker$pat_bound_names(__x) {
  while (true) {
    let _t8659;
    const _t8658 = __x;
    _t8660: {
      if (_t8658._tag === 1) {
        const name = _t8658._val;
        _t8659 = ({_hd: name, _tl: null});
        break _t8660;
      }
      if ((_t8658._tag === 7 || _t8658._tag === 14)) {
        const pats = _t8658._val;
        _t8659 = List$concat_map(Typechecker$pat_bound_names, pats);
        break _t8660;
      }
      if (_t8658._tag === 8) {
        const p1 = _t8658._val[0];
        const p2 = _t8658._val[1];
        _t8659 = List$concat(Typechecker$pat_bound_names(p1), Typechecker$pat_bound_names(p2));
        break _t8660;
      }
      if ((_t8658._tag === 10 && _t8658._val[1]._tag === 1 || _t8658._tag === 16 && _t8658._val[1]._tag === 1)) {
        const p = _t8658._val[1]._val;
        const _t8661 = p;
        __x = _t8661;
        continue;
        _t8659 = undefined;
        break _t8660;
      }
      if (_t8658._tag === 11) {
        const fields = _t8658._val;
        function _t8662(__p281) {
          let _t8664;
          const _t8663 = __p281;
          _t8665: {
            if (true) {
              const p = _t8663[1];
              _t8664 = Typechecker$pat_bound_names(p);
              break _t8665;
            }
            _match_fail("line 15950");
          }
          return _t8664;
        }
        _t8659 = List$concat_map(_t8662, fields);
        break _t8660;
      }
      if (_t8658._tag === 12) {
        const p = _t8658._val[0];
        const name = _t8658._val[1];
        _t8659 = ({_hd: name, _tl: Typechecker$pat_bound_names(p)});
        break _t8660;
      }
      if (_t8658._tag === 13) {
        const p1 = _t8658._val[0];
        const _t8666 = p1;
        __x = _t8666;
        continue;
        _t8659 = undefined;
        break _t8660;
      }
      if (_t8658._tag === 15) {
        const pairs = _t8658._val;
        function _t8667(__p282) {
          let _t8669;
          const _t8668 = __p282;
          _t8670: {
            if (true) {
              const v = _t8668[1];
              _t8669 = Typechecker$pat_bound_names(v);
              break _t8670;
            }
            _match_fail("line 15950");
          }
          return _t8669;
        }
        _t8659 = List$concat_map(_t8667, pairs);
        break _t8660;
      }
      if (_t8658._tag === 18) {
        const p = _t8658._val[0];
        const _t8671 = p;
        __x = _t8671;
        continue;
        _t8659 = undefined;
        break _t8660;
      }
      if ((((((((((_t8658._tag === 0 || _t8658._tag === 2) || _t8658._tag === 3) || _t8658._tag === 4) || _t8658._tag === 5) || _t8658._tag === 6) || _t8658._tag === 9) || _t8658._tag === 17) || _t8658._tag === 10 && _t8658._val[1]._tag === 0) || _t8658._tag === 16 && _t8658._val[1]._tag === 0)) {
        _t8659 = null;
        break _t8660;
      }
      _match_fail("line 15950");
    }
    return _t8659;
  }
}
function Typechecker$xform_expr(xctx, te) {
  let _t8673;
  const _t8672 = te.expr;
  _t8674: {
    if (_t8672._tag === 7) {
      const name = _t8672._val;
      const te_8675 = Typechecker$xform_class_method(xctx, name, te);
      const _t8676 = Typechecker$xform_constrained_ref(xctx, name, te_8675);
      _t8673 = _t8676;
      break _t8674;
    }
    if (_t8672._tag === 13) {
      const op = _t8672._val[0];
      const e1 = _t8672._val[1];
      const e2 = _t8672._val[2];
      const e1$p_8677 = Typechecker$xform_expr(xctx, e1);
      const e2$p_8679 = Typechecker$xform_expr(xctx, e2);
      const _t8680 = Typechecker$xform_binop(xctx, op, e1$p_8677, e2$p_8679, te.ty);
      const _t8678 = _t8680;
      _t8673 = _t8678;
      break _t8674;
    }
    if (_t8672._tag === 14) {
      const op = _t8672._val[0];
      const e = _t8672._val[1];
      const e$p_8681 = Typechecker$xform_expr(xctx, e);
      const _t8682 = Typechecker$xform_unop(xctx, op, e$p_8681, te.ty);
      _t8673 = _t8682;
      break _t8674;
    }
    if (_t8672._tag === 11) {
      const fn_ = _t8672._val[0];
      const arg = _t8672._val[1];
      const fn$p_8683 = Typechecker$xform_expr(xctx, fn_);
      const arg$p_8685 = Typechecker$xform_expr(xctx, arg);
      const _t8686 = Typechecker$mk(({_tag: 11, _name: "TEApp", _val: [fn$p_8683, arg$p_8685]}), te.ty);
      const _t8684 = _t8686;
      _t8673 = _t8684;
      break _t8674;
    }
    if (_t8672._tag === 10) {
      const param = _t8672._val[0];
      const body = _t8672._val[1];
      const hr = _t8672._val[2];
      const __rec_upd_8687 = xctx;
      const _t8688 = ({xf_constrained: __rec_upd_8687.xf_constrained, xf_locals: ({_hd: param, _tl: xctx.xf_locals}), xf_record_evidence: __rec_upd_8687.xf_record_evidence, xf_schemes: __rec_upd_8687.xf_schemes, xf_type_env: __rec_upd_8687.xf_type_env});
      const xctx$p_8689 = _t8688;
      const _t8690 = Typechecker$mk(({_tag: 10, _name: "TEFun", _val: [param, Typechecker$xform_expr(xctx$p_8689, body), hr]}), te.ty);
      _t8673 = _t8690;
      break _t8674;
    }
    if (_t8672._tag === 8 && _t8672._val[1]._tag === 1) {
      const name = _t8672._val[0];
      const scheme = _t8672._val[1]._val;
      const e1 = _t8672._val[2];
      const e2 = _t8672._val[3];
      const e1$p_8691 = Typechecker$xform_constrained_def(xctx, scheme, e1);
      const __rec_upd_8693 = xctx;
      const _t8694 = ({xf_constrained: __rec_upd_8693.xf_constrained, xf_locals: __rec_upd_8693.xf_locals, xf_record_evidence: __rec_upd_8693.xf_record_evidence, xf_schemes: ({_hd: [name, scheme], _tl: xctx.xf_schemes}), xf_type_env: __rec_upd_8693.xf_type_env});
      const xctx$p_8695 = _t8694;
      const _t8696 = Typechecker$mk(({_tag: 8, _name: "TELet", _val: [name, ({_tag: 1, _name: "Some", _val: scheme}), e1$p_8691, Typechecker$xform_expr(xctx$p_8695, e2)]}), te.ty);
      const _t8692 = _t8696;
      _t8673 = _t8692;
      break _t8674;
    }
    if (_t8672._tag === 8 && _t8672._val[1]._tag === 0) {
      const name = _t8672._val[0];
      const e1 = _t8672._val[2];
      const e2 = _t8672._val[3];
      const __rec_upd_8697 = xctx;
      const _t8698 = ({xf_constrained: __rec_upd_8697.xf_constrained, xf_locals: ({_hd: name, _tl: xctx.xf_locals}), xf_record_evidence: __rec_upd_8697.xf_record_evidence, xf_schemes: __rec_upd_8697.xf_schemes, xf_type_env: __rec_upd_8697.xf_type_env});
      const xctx$p_8699 = _t8698;
      const _t8700 = Typechecker$mk(({_tag: 8, _name: "TELet", _val: [name, ({_tag: 0, _name: "None"}), Typechecker$xform_expr(xctx, e1), Typechecker$xform_expr(xctx$p_8699, e2)]}), te.ty);
      _t8673 = _t8700;
      break _t8674;
    }
    if (_t8672._tag === 9 && _t8672._val[1]._tag === 1) {
      const name = _t8672._val[0];
      const scheme = _t8672._val[1]._val;
      const e1 = _t8672._val[2];
      const e2 = _t8672._val[3];
      const __rec_upd_8701 = xctx;
      const _t8702 = ({xf_constrained: __rec_upd_8701.xf_constrained, xf_locals: __rec_upd_8701.xf_locals, xf_record_evidence: __rec_upd_8701.xf_record_evidence, xf_schemes: ({_hd: [name, scheme], _tl: xctx.xf_schemes}), xf_type_env: __rec_upd_8701.xf_type_env});
      const xctx$p_8703 = _t8702;
      const e1$p_8705 = Typechecker$xform_constrained_def(xctx$p_8703, scheme, e1);
      const _t8706 = Typechecker$mk(({_tag: 9, _name: "TELetRec", _val: [name, ({_tag: 1, _name: "Some", _val: scheme}), e1$p_8705, Typechecker$xform_expr(xctx$p_8703, e2)]}), te.ty);
      const _t8704 = _t8706;
      _t8673 = _t8704;
      break _t8674;
    }
    if (_t8672._tag === 9 && _t8672._val[1]._tag === 0) {
      const name = _t8672._val[0];
      const e1 = _t8672._val[2];
      const e2 = _t8672._val[3];
      const __rec_upd_8707 = xctx;
      const _t8708 = ({xf_constrained: __rec_upd_8707.xf_constrained, xf_locals: ({_hd: name, _tl: xctx.xf_locals}), xf_record_evidence: __rec_upd_8707.xf_record_evidence, xf_schemes: __rec_upd_8707.xf_schemes, xf_type_env: __rec_upd_8707.xf_type_env});
      const xctx$p_8709 = _t8708;
      const _t8710 = Typechecker$mk(({_tag: 9, _name: "TELetRec", _val: [name, ({_tag: 0, _name: "None"}), Typechecker$xform_expr(xctx$p_8709, e1), Typechecker$xform_expr(xctx$p_8709, e2)]}), te.ty);
      _t8673 = _t8710;
      break _t8674;
    }
    if (_t8672._tag === 25) {
      const name = _t8672._val[0];
      const e1 = _t8672._val[1];
      const e2 = _t8672._val[2];
      const __rec_upd_8711 = xctx;
      const _t8712 = ({xf_constrained: __rec_upd_8711.xf_constrained, xf_locals: ({_hd: name, _tl: xctx.xf_locals}), xf_record_evidence: __rec_upd_8711.xf_record_evidence, xf_schemes: __rec_upd_8711.xf_schemes, xf_type_env: __rec_upd_8711.xf_type_env});
      const xctx$p_8713 = _t8712;
      const _t8714 = Typechecker$mk(({_tag: 25, _name: "TELetMut", _val: [name, Typechecker$xform_expr(xctx, e1), Typechecker$xform_expr(xctx$p_8713, e2)]}), te.ty);
      _t8673 = _t8714;
      break _t8674;
    }
    if (_t8672._tag === 32) {
      const cond = _t8672._val[0];
      const body = _t8672._val[1];
      _t8673 = Typechecker$mk(({_tag: 32, _name: "TEWhile", _val: [Typechecker$xform_expr(xctx, cond), Typechecker$xform_expr(xctx, body)]}), te.ty);
      break _t8674;
    }
    if (_t8672._tag === 37) {
      const bindings = _t8672._val[0];
      const body = _t8672._val[1];
      const names_8715 = List$map(fst, bindings);
      const __rec_upd_8717 = xctx;
      const _t8718 = ({xf_constrained: __rec_upd_8717.xf_constrained, xf_locals: List$concat(names_8715, xctx.xf_locals), xf_record_evidence: __rec_upd_8717.xf_record_evidence, xf_schemes: __rec_upd_8717.xf_schemes, xf_type_env: __rec_upd_8717.xf_type_env});
      const xctx$p_8719 = _t8718;
      function _t8721(__p283) {
        let _t8723;
        const _t8722 = __p283;
        _t8724: {
          if (true) {
            const n = _t8722[0];
            const e = _t8722[1];
            _t8723 = [n, Typechecker$xform_expr(xctx$p_8719, e)];
            break _t8724;
          }
          _match_fail("line 15950");
        }
        return _t8723;
      }
      const bindings$p_8725 = List$map(_t8721, bindings);
      const _t8726 = Typechecker$mk(({_tag: 37, _name: "TELetRecAnd", _val: [bindings$p_8725, Typechecker$xform_expr(xctx$p_8719, body)]}), te.ty);
      const _t8720 = _t8726;
      const _t8716 = _t8720;
      _t8673 = _t8716;
      break _t8674;
    }
    if (_t8672._tag === 12) {
      const c = _t8672._val[0];
      const t = _t8672._val[1];
      const e = _t8672._val[2];
      _t8673 = Typechecker$mk(({_tag: 12, _name: "TEIf", _val: [Typechecker$xform_expr(xctx, c), Typechecker$xform_expr(xctx, t), Typechecker$xform_expr(xctx, e)]}), te.ty);
      break _t8674;
    }
    if (_t8672._tag === 15) {
      const es = _t8672._val;
      _t8673 = Typechecker$mk(({_tag: 15, _name: "TETuple", _val: List$map(_call(Typechecker$xform_expr, [xctx]), es)}), te.ty);
      break _t8674;
    }
    if (_t8672._tag === 16) {
      const fields = _t8672._val;
      function _t8727(__p284) {
        let _t8729;
        const _t8728 = __p284;
        _t8730: {
          if (true) {
            const n = _t8728[0];
            const e = _t8728[1];
            _t8729 = [n, Typechecker$xform_expr(xctx, e)];
            break _t8730;
          }
          _match_fail("line 15950");
        }
        return _t8729;
      }
      _t8673 = Typechecker$mk(({_tag: 16, _name: "TERecord", _val: List$map(_t8727, fields)}), te.ty);
      break _t8674;
    }
    if (_t8672._tag === 17) {
      const base = _t8672._val[0];
      const overrides = _t8672._val[1];
      const base$p_8731 = Typechecker$xform_expr(xctx, base);
      function _t8733(__p285) {
        let _t8735;
        const _t8734 = __p285;
        _t8736: {
          if (true) {
            const n = _t8734[0];
            const e = _t8734[1];
            _t8735 = [n, Typechecker$xform_expr(xctx, e)];
            break _t8736;
          }
          _match_fail("line 15950");
        }
        return _t8735;
      }
      const overrides$p_8737 = List$map(_t8733, overrides);
      function get_row_tail(row) {
        while (true) {
          let _t8740;
          const _t8739 = Types$rrow_repr(row);
          _t8741: {
            if (_t8739._tag === 0) {
              const tail = _t8739._val[2];
              const _t8742 = tail;
              row = _t8742;
              continue;
              _t8740 = undefined;
              break _t8741;
            }
            if (true) {
              const tail = _t8739;
              _t8740 = tail;
              break _t8741;
            }
            _match_fail("line 15950");
          }
          return _t8740;
        }
      }
      let _t8745;
      const _t8744 = Types$repr(base$p_8731.ty);
      _t8746: {
        if (_t8744._tag === 11) {
          const row = _t8744._val;
          let _t8748;
          const _t8747 = get_row_tail(row);
          _t8749: {
            if (_t8747._tag === 1 && _t8747._val.contents._tag === 0) {
              const id = _t8747._val.contents._val[0];
              function _t8750(__p286) {
                let _t8752;
                const _t8751 = __p286;
                _t8753: {
                  if (true) {
                    const rid = _t8751[0];
                    _t8752 = (rid === id);
                    break _t8753;
                  }
                  _match_fail("line 15950");
                }
                return _t8752;
              }
              _t8748 = List$exists(_t8750, xctx.xf_record_evidence);
              break _t8749;
            }
            if (true) {
              _t8748 = false;
              break _t8749;
            }
            _match_fail("line 15950");
          }
          _t8745 = _t8748;
          break _t8746;
        }
        if (true) {
          _t8745 = false;
          break _t8746;
        }
        _match_fail("line 15950");
      }
      const has_evidence_8754 = _t8745;
      let _t8756;
      if (has_evidence_8754) {
        let _t8758;
        const _t8757 = Types$repr(base$p_8731.ty);
        _t8759: {
          if (_t8757._tag === 11) {
            const r = _t8757._val;
            _t8758 = r;
            break _t8759;
          }
          if (true) {
            _t8758 = failwith("assert false");
            break _t8759;
          }
          _match_fail("line 15950");
        }
        const row_8760 = _t8758;
        let _t8763;
        const _t8762 = get_row_tail(row_8760);
        _t8764: {
          if (_t8762._tag === 1 && _t8762._val.contents._tag === 0) {
            const id = _t8762._val.contents._val[0];
            _t8763 = id;
            break _t8764;
          }
          if (true) {
            _t8763 = failwith("assert false");
            break _t8764;
          }
          _match_fail("line 15950");
        }
        const rvar_id_8765 = _t8763;
        function _t8767(__p287) {
          let _t8769;
          const _t8768 = __p287;
          _t8770: {
            if (true) {
              const name = _t8768[0];
              const e = _t8768[1];
              function _t8771(__p288) {
                let _t8773;
                const _t8772 = __p288;
                _t8774: {
                  if (true) {
                    const rid = _t8772[0];
                    const fname = _t8772[1];
                    const pname = _t8772[2];
                    let _t8775;
                    if (((rid === rvar_id_8765) && (fname === name))) {
                      _t8775 = ({_tag: 1, _name: "Some", _val: pname});
                    } else {
                      _t8775 = ({_tag: 0, _name: "None"});
                    }
                    _t8773 = _t8775;
                    break _t8774;
                  }
                  _match_fail("line 15950");
                }
                return _t8773;
              }
              const ev_param_8776 = List$find_map(_t8771, xctx.xf_record_evidence);
              let _t8779;
              const _t8778 = ev_param_8776;
              _t8780: {
                if (_t8778._tag === 1) {
                  const pname = _t8778._val;
                  _t8779 = [Typechecker$mk(({_tag: 7, _name: "TEVar", _val: pname}), ({_tag: 0, _name: "TInt"})), e];
                  break _t8780;
                }
                if (_t8778._tag === 0) {
                  _t8779 = Typechecker$error(("missing record evidence for field " + __dict_Show_string.show(name)));
                  break _t8780;
                }
                _match_fail("line 15950");
              }
              const _t8777 = _t8779;
              _t8769 = _t8777;
              break _t8770;
            }
            _match_fail("line 15950");
          }
          return _t8769;
        }
        const idx_val_pairs_8781 = List$map(_t8767, overrides$p_8737);
        const _t8782 = Typechecker$mk(({_tag: 18, _name: "TERecordUpdateIdx", _val: [base$p_8731, idx_val_pairs_8781]}), te.ty);
        const _t8766 = _t8782;
        const _t8761 = _t8766;
        _t8756 = _t8761;
      } else {
        _t8756 = Typechecker$mk(({_tag: 17, _name: "TERecordUpdate", _val: [base$p_8731, overrides$p_8737]}), te.ty);
      }
      const _t8755 = _t8756;
      const _t8743 = _t8755;
      const _t8738 = _t8743;
      const _t8732 = _t8738;
      _t8673 = _t8732;
      break _t8674;
    }
    if (_t8672._tag === 18) {
      const base = _t8672._val[0];
      const pairs = _t8672._val[1];
      function _t8783(__p289) {
        let _t8785;
        const _t8784 = __p289;
        _t8786: {
          if (true) {
            const i = _t8784[0];
            const v = _t8784[1];
            _t8785 = [Typechecker$xform_expr(xctx, i), Typechecker$xform_expr(xctx, v)];
            break _t8786;
          }
          _match_fail("line 15950");
        }
        return _t8785;
      }
      _t8673 = Typechecker$mk(({_tag: 18, _name: "TERecordUpdateIdx", _val: [Typechecker$xform_expr(xctx, base), List$map(_t8783, pairs)]}), te.ty);
      break _t8674;
    }
    if (_t8672._tag === 19) {
      const e = _t8672._val[0];
      const name = _t8672._val[1];
      _t8673 = Typechecker$mk(({_tag: 19, _name: "TEField", _val: [Typechecker$xform_expr(xctx, e), name]}), te.ty);
      break _t8674;
    }
    if (_t8672._tag === 21) {
      const hd = _t8672._val[0];
      const tl = _t8672._val[1];
      _t8673 = Typechecker$mk(({_tag: 21, _name: "TECons", _val: [Typechecker$xform_expr(xctx, hd), Typechecker$xform_expr(xctx, tl)]}), te.ty);
      break _t8674;
    }
    if (_t8672._tag === 23) {
      const name = _t8672._val[0];
      const arg = _t8672._val[1];
      _t8673 = Typechecker$mk(({_tag: 23, _name: "TEConstruct", _val: [name, Option$map(_call(Typechecker$xform_expr, [xctx]), arg)]}), te.ty);
      break _t8674;
    }
    if (_t8672._tag === 24) {
      const scrutinee = _t8672._val[0];
      const arms = _t8672._val[1];
      const partial = _t8672._val[2];
      function _t8787(__p290) {
        let _t8789;
        const _t8788 = __p290;
        _t8790: {
          if (true) {
            const pat = _t8788[0];
            const guard = _t8788[1];
            const body = _t8788[2];
            const pvars_8791 = Typechecker$pat_bound_names(pat);
            const __rec_upd_8793 = xctx;
            const _t8794 = ({xf_constrained: __rec_upd_8793.xf_constrained, xf_locals: List$concat(pvars_8791, xctx.xf_locals), xf_record_evidence: __rec_upd_8793.xf_record_evidence, xf_schemes: __rec_upd_8793.xf_schemes, xf_type_env: __rec_upd_8793.xf_type_env});
            const xctx$p_8795 = _t8794;
            const _t8796 = [pat, Option$map(_call(Typechecker$xform_expr, [xctx$p_8795]), guard), Typechecker$xform_expr(xctx$p_8795, body)];
            const _t8792 = _t8796;
            _t8789 = _t8792;
            break _t8790;
          }
          _match_fail("line 15950");
        }
        return _t8789;
      }
      const arms$p_8797 = List$map(_t8787, arms);
      const _t8798 = Typechecker$mk(({_tag: 24, _name: "TEMatch", _val: [Typechecker$xform_expr(xctx, scrutinee), arms$p_8797, partial]}), te.ty);
      _t8673 = _t8798;
      break _t8674;
    }
    if (_t8672._tag === 26) {
      const name = _t8672._val[0];
      const e = _t8672._val[1];
      _t8673 = Typechecker$mk(({_tag: 26, _name: "TEAssign", _val: [name, Typechecker$xform_expr(xctx, e)]}), te.ty);
      break _t8674;
    }
    if (_t8672._tag === 27) {
      const r = _t8672._val[0];
      const f = _t8672._val[1];
      const e = _t8672._val[2];
      _t8673 = Typechecker$mk(({_tag: 27, _name: "TEFieldAssign", _val: [Typechecker$xform_expr(xctx, r), f, Typechecker$xform_expr(xctx, e)]}), te.ty);
      break _t8674;
    }
    if (_t8672._tag === 28) {
      const e1 = _t8672._val[0];
      const e2 = _t8672._val[1];
      _t8673 = Typechecker$mk(({_tag: 28, _name: "TESeq", _val: [Typechecker$xform_expr(xctx, e1), Typechecker$xform_expr(xctx, e2)]}), te.ty);
      break _t8674;
    }
    if (_t8672._tag === 29) {
      const name = _t8672._val[0];
      const e = _t8672._val[1];
      _t8673 = Typechecker$mk(({_tag: 29, _name: "TEPerform", _val: [name, Typechecker$xform_expr(xctx, e)]}), te.ty);
      break _t8674;
    }
    if (_t8672._tag === 30) {
      const body = _t8672._val[0];
      const arms = _t8672._val[1];
      function _t8799(arm) {
        let _t8801;
        const _t8800 = arm;
        _t8802: {
          if (_t8800._tag === 0) {
            const n = _t8800._val[0];
            const e = _t8800._val[1];
            const __rec_upd_8803 = xctx;
            const _t8804 = ({xf_constrained: __rec_upd_8803.xf_constrained, xf_locals: ({_hd: n, _tl: xctx.xf_locals}), xf_record_evidence: __rec_upd_8803.xf_record_evidence, xf_schemes: __rec_upd_8803.xf_schemes, xf_type_env: __rec_upd_8803.xf_type_env});
            const xctx$p_8805 = _t8804;
            const _t8806 = ({_tag: 0, _name: "THReturn", _val: [n, Typechecker$xform_expr(xctx$p_8805, e)]});
            _t8801 = _t8806;
            break _t8802;
          }
          if (_t8800._tag === 1) {
            const op = _t8800._val[0];
            const p = _t8800._val[1];
            const k = _t8800._val[2];
            const e = _t8800._val[3];
            const __rec_upd_8807 = xctx;
            const _t8808 = ({xf_constrained: __rec_upd_8807.xf_constrained, xf_locals: ({_hd: k, _tl: ({_hd: p, _tl: xctx.xf_locals})}), xf_record_evidence: __rec_upd_8807.xf_record_evidence, xf_schemes: __rec_upd_8807.xf_schemes, xf_type_env: __rec_upd_8807.xf_type_env});
            const xctx$p_8809 = _t8808;
            const _t8810 = ({_tag: 1, _name: "THOp", _val: [op, p, k, Typechecker$xform_expr(xctx$p_8809, e)]});
            _t8801 = _t8810;
            break _t8802;
          }
          _match_fail("line 15950");
        }
        return _t8801;
      }
      const arms$p_8811 = List$map(_t8799, arms);
      const _t8812 = Typechecker$mk(({_tag: 30, _name: "TEHandle", _val: [Typechecker$xform_expr(xctx, body), arms$p_8811]}), te.ty);
      _t8673 = _t8812;
      break _t8674;
    }
    if (_t8672._tag === 31) {
      const k = _t8672._val[0];
      const e = _t8672._val[1];
      _t8673 = Typechecker$mk(({_tag: 31, _name: "TEResume", _val: [Typechecker$xform_expr(xctx, k), Typechecker$xform_expr(xctx, e)]}), te.ty);
      break _t8674;
    }
    if (_t8672._tag === 38) {
      const pairs = _t8672._val;
      function _t8813(__p291) {
        let _t8815;
        const _t8814 = __p291;
        _t8816: {
          if (true) {
            const k = _t8814[0];
            const v = _t8814[1];
            _t8815 = [Typechecker$xform_expr(xctx, k), Typechecker$xform_expr(xctx, v)];
            break _t8816;
          }
          _match_fail("line 15950");
        }
        return _t8815;
      }
      _t8673 = Typechecker$mk(({_tag: 38, _name: "TEMap", _val: List$map(_t8813, pairs)}), te.ty);
      break _t8674;
    }
    if (_t8672._tag === 39) {
      const es = _t8672._val;
      _t8673 = Typechecker$mk(({_tag: 39, _name: "TEArray", _val: List$map(_call(Typechecker$xform_expr, [xctx]), es)}), te.ty);
      break _t8674;
    }
    if (_t8672._tag === 20) {
      const base = _t8672._val[0];
      const idx = _t8672._val[1];
      _t8673 = Typechecker$mk(({_tag: 20, _name: "TEIndex", _val: [Typechecker$xform_expr(xctx, base), Typechecker$xform_expr(xctx, idx)]}), te.ty);
      break _t8674;
    }
    if (_t8672._tag === 33) {
      const e = _t8672._val;
      _t8673 = Typechecker$mk(({_tag: 33, _name: "TEBreak", _val: Typechecker$xform_expr(xctx, e)}), te.ty);
      break _t8674;
    }
    if (_t8672._tag === 34) {
      _t8673 = te;
      break _t8674;
    }
    if (_t8672._tag === 35) {
      const e = _t8672._val;
      _t8673 = Typechecker$mk(({_tag: 35, _name: "TEFoldContinue", _val: Typechecker$xform_expr(xctx, e)}), te.ty);
      break _t8674;
    }
    if (_t8672._tag === 36) {
      const e = _t8672._val;
      _t8673 = Typechecker$mk(({_tag: 36, _name: "TEForLoop", _val: Typechecker$xform_expr(xctx, e)}), te.ty);
      break _t8674;
    }
    if (_t8672._tag === 40) {
      const e = _t8672._val;
      _t8673 = Typechecker$mk(({_tag: 40, _name: "TEReturn", _val: Typechecker$xform_expr(xctx, e)}), te.ty);
      break _t8674;
    }
    if ((((((((_t8672._tag === 0 || _t8672._tag === 1) || _t8672._tag === 2) || _t8672._tag === 3) || _t8672._tag === 4) || _t8672._tag === 5) || _t8672._tag === 6) || _t8672._tag === 22)) {
      _t8673 = te;
      break _t8674;
    }
    _match_fail("line 15950");
  }
  return _t8673;
}
function Typechecker$xform_class_method(xctx, name, te) {
  let _t8817;
  if (List$mem(name, xctx.xf_locals)) {
    _t8817 = te;
  } else {
    let _t8819;
    const _t8818 = Types$find_method_class(xctx.xf_type_env.classes, name);
    _t8820: {
      if (_t8818._tag === 1) {
        const result = _t8818;
        _t8819 = [result, name];
        break _t8820;
      }
      if (_t8818._tag === 0) {
        let _t8822;
        const _t8821 = String$rindex_opt(name, 46);
        _t8823: {
          if (_t8821._tag === 0) {
            _t8822 = [({_tag: 0, _name: "None"}), name];
            break _t8823;
          }
          if (_t8821._tag === 1) {
            const i = _t8821._val;
            const mod_prefix_8824 = String$sub(name, 0, (i + 1));
            const _mml$short_8826 = String$sub(name, (i + 1), ((String$length(name) - i) - 1));
            const class_prefix_8828 = String$sub(name, 0, i);
            let _t8831;
            const _t8830 = Types$find_method_class(xctx.xf_type_env.classes, _mml$short_8826);
            _t8832: {
              if (_t8830._tag === 1) {
                const class_def = _t8830._val;
                if ((class_def.class_name === class_prefix_8828)) {
                  _t8831 = [({_tag: 1, _name: "Some", _val: class_def}), _mml$short_8826];
                  break _t8832;
                }
              }
              if (_t8830._tag === 1) {
                const class_def = _t8830._val;
                if (((String$length(class_def.class_name) > String$length(mod_prefix_8824)) && (String$sub(class_def.class_name, 0, String$length(mod_prefix_8824)) === mod_prefix_8824))) {
                  _t8831 = [({_tag: 1, _name: "Some", _val: class_def}), _mml$short_8826];
                  break _t8832;
                }
              }
              if (true) {
                _t8831 = [({_tag: 0, _name: "None"}), name];
                break _t8832;
              }
              _match_fail("line 15950");
            }
            const _t8829 = _t8831;
            const _t8827 = _t8829;
            const _t8825 = _t8827;
            _t8822 = _t8825;
            break _t8823;
          }
          _match_fail("line 15950");
        }
        _t8819 = _t8822;
        break _t8820;
      }
      _match_fail("line 15950");
    }
    let _t8834;
    const _t8833 = _t8819;
    _t8835: {
      if (true) {
        const class_opt = _t8833[0];
        const method_name = _t8833[1];
        let _t8837;
        const _t8836 = class_opt;
        _t8838: {
          if (_t8836._tag === 1) {
            const class_def = _t8836._val;
            const method_schema_ty_8839 = List$assoc(method_name, class_def.class_methods);
            let _t8842;
            const _t8841 = List$assoc_opt(name, xctx.xf_schemes);
            _t8843: {
              if (_t8841._tag === 1) {
                const s = _t8841._val;
                _t8842 = !_eq(s.body, method_schema_ty_8839);
                break _t8843;
              }
              if (_t8841._tag === 0) {
                _t8842 = false;
                break _t8843;
              }
              _match_fail("line 15950");
            }
            const is_overridden_8844 = _t8842;
            let _t8846;
            if (is_overridden_8844) {
              _t8846 = te;
            } else {
              const num_params_8847 = List$length(class_def.class_params);
              const found_8849 = Hashtbl$create(num_params_8847);
              function go(s, r) {
                while (true) {
                  const r_8851 = Types$repr(r);
                  let _t8854;
                  const _t8853 = [s, r_8851];
                  _t8855: {
                    if (_t8853[0]._tag === 17) {
                      const i = _t8853[0]._val;
                      if ((i < num_params_8847)) {
                        let _t8856;
                        if ((!_call(Hashtbl$has, [__dict_Hash_int, __dict_Eq_int, found_8849, i]))) {
                          _t8856 = _call(Hashtbl$set, [__dict_Hash_int, __dict_Eq_int, found_8849, i, r_8851]);
                        } else {
                          _t8856 = undefined;
                        }
                        _t8854 = _t8856;
                        break _t8855;
                      }
                    }
                    if ((_t8853[0]._tag === 7 && _t8853[1]._tag === 7 || _t8853[0]._tag === 8 && _t8853[1]._tag === 8)) {
                      const s1 = _t8853[0]._val[0];
                      const s2 = _t8853[0]._val[2];
                      const r1 = _t8853[1]._val[0];
                      const r2 = _t8853[1]._val[2];
                      go(s1, r1);
                      const _t8857 = s2;
                      const _t8858 = r2;
                      s = _t8857;
                      r = _t8858;
                      continue;
                      _t8854 = undefined;
                      break _t8855;
                    }
                    if (_t8853[0]._tag === 9 && _t8853[1]._tag === 9) {
                      const ss = _t8853[0]._val;
                      const rs = _t8853[1]._val;
                      if ((List$length(ss) === List$length(rs))) {
                        _t8854 = List$iter2(go, ss, rs);
                        break _t8855;
                      }
                    }
                    if (_t8853[0]._tag === 10 && _t8853[1]._tag === 10) {
                      const s1 = _t8853[0]._val;
                      const r1 = _t8853[1]._val;
                      const _t8859 = s1;
                      const _t8860 = r1;
                      s = _t8859;
                      r = _t8860;
                      continue;
                      _t8854 = undefined;
                      break _t8855;
                    }
                    if (_t8853[0]._tag === 14 && _t8853[1]._tag === 14) {
                      const s1 = _t8853[0]._val;
                      const r1 = _t8853[1]._val;
                      const _t8861 = s1;
                      const _t8862 = r1;
                      s = _t8861;
                      r = _t8862;
                      continue;
                      _t8854 = undefined;
                      break _t8855;
                    }
                    if (_t8853[0]._tag === 13 && _t8853[1]._tag === 13) {
                      const sk = _t8853[0]._val[0];
                      const sv = _t8853[0]._val[1];
                      const rk = _t8853[1]._val[0];
                      const rv = _t8853[1]._val[1];
                      go(sk, rk);
                      const _t8863 = sv;
                      const _t8864 = rv;
                      s = _t8863;
                      r = _t8864;
                      continue;
                      _t8854 = undefined;
                      break _t8855;
                    }
                    if (_t8853[0]._tag === 12 && _t8853[1]._tag === 12) {
                      const ss = _t8853[0]._val[1];
                      const rs = _t8853[1]._val[1];
                      if ((List$length(ss) === List$length(rs))) {
                        _t8854 = List$iter2(go, ss, rs);
                        break _t8855;
                      }
                    }
                    if (true) {
                      _t8854 = undefined;
                      break _t8855;
                    }
                    _match_fail("line 15950");
                  }
                  const _t8852 = _t8854;
                  return _t8852;
                }
              }
              go(method_schema_ty_8839, te.ty);
              let _t8866;
              if (!_eq(xctx.xf_constrained, null)) {
                function _t8867(i) {
                  let _t8869;
                  const _t8868 = _call(Hashtbl$get, [__dict_Hash_int, __dict_Eq_int, found_8849, i]);
                  _t8870: {
                    if (_t8868._tag === 1 && _t8868._val._tag === 16 && _t8868._val._val.contents._tag === 0) {
                      const id = _t8868._val._val.contents._val[0];
                      _t8869 = Typechecker$find_constrained_dict(xctx, id, class_def.class_name);
                      break _t8870;
                    }
                    if (true) {
                      _t8869 = ({_tag: 0, _name: "None"});
                      break _t8870;
                    }
                    _match_fail("line 15950");
                  }
                  return _t8869;
                }
                function _t8871(x) {
                  return x;
                }
                const exact_match_8872 = List$find_map(_t8867, List$init(num_params_8847, _t8871));
                let _t8875;
                const _t8874 = exact_match_8872;
                _t8876: {
                  if (_t8874._tag === 1) {
                    _t8875 = exact_match_8872;
                    break _t8876;
                  }
                  if (_t8874._tag === 0) {
                    function _t8877(i) {
                      let _t8879;
                      const _t8878 = _call(Hashtbl$get, [__dict_Hash_int, __dict_Eq_int, found_8849, i]);
                      _t8880: {
                        if (_t8878._tag === 1 && _t8878._val._tag === 16 && _t8878._val._val.contents._tag === 0) {
                          _t8879 = true;
                          break _t8880;
                        }
                        if (true) {
                          _t8879 = false;
                          break _t8880;
                        }
                        _match_fail("line 15950");
                      }
                      return _t8879;
                    }
                    function _t8881(x) {
                      return x;
                    }
                    const has_unbound_arg_8882 = List$exists(_t8877, List$init(num_params_8847, _t8881));
                    let _t8884;
                    if (has_unbound_arg_8882) {
                      function _t8885(__p292) {
                        let _t8887;
                        const _t8886 = __p292;
                        _t8888: {
                          if (true) {
                            const _tid = _t8886[0];
                            const _dp = _t8886[1];
                            const cls = _t8886[2];
                            _t8887 = (cls === class_def.class_name);
                            break _t8888;
                          }
                          _match_fail("line 15950");
                        }
                        return _t8887;
                      }
                      const matching_constraints_8889 = List$filter(_t8885, xctx.xf_constrained);
                      let _t8892;
                      const _t8891 = matching_constraints_8889;
                      _t8893: {
                        if (_t8891 !== null && _t8891._tl === null) {
                          const _tid = _t8891._hd[0];
                          const dp = _t8891._hd[1];
                          const _cls = _t8891._hd[2];
                          _t8892 = ({_tag: 1, _name: "Some", _val: dp});
                          break _t8893;
                        }
                        if (true) {
                          _t8892 = ({_tag: 0, _name: "None"});
                          break _t8893;
                        }
                        _match_fail("line 15950");
                      }
                      const _t8890 = _t8892;
                      _t8884 = _t8890;
                    } else {
                      _t8884 = ({_tag: 0, _name: "None"});
                    }
                    const _t8883 = _t8884;
                    _t8875 = _t8883;
                    break _t8876;
                  }
                  _match_fail("line 15950");
                }
                const _t8873 = _t8875;
                _t8866 = _t8873;
              } else {
                _t8866 = ({_tag: 0, _name: "None"});
              }
              const constrained_match_8894 = _t8866;
              let _t8897;
              const _t8896 = constrained_match_8894;
              _t8898: {
                if (_t8896._tag === 1) {
                  const dp = _t8896._val;
                  _t8897 = Typechecker$mk(({_tag: 19, _name: "TEField", _val: [Typechecker$mk(({_tag: 7, _name: "TEVar", _val: dp}), ({_tag: 6, _name: "TUnit"})), method_name]}), te.ty);
                  break _t8898;
                }
                if (_t8896._tag === 0) {
                  function _t8899(i) {
                    return _call(Hashtbl$get, [__dict_Hash_int, __dict_Eq_int, found_8849, i]);
                  }
                  const type_args_8900 = List$init(num_params_8847, _t8899);
                  function _t8902(opt) {
                    let _t8904;
                    const _t8903 = opt;
                    _t8905: {
                      if (_t8903._tag === 1) {
                        const ty = _t8903._val;
                        let _t8907;
                        const _t8906 = Types$repr(ty);
                        _t8908: {
                          if (_t8906._tag === 16 && _t8906._val.contents._tag === 0) {
                            _t8907 = ({_tag: 0, _name: "None"});
                            break _t8908;
                          }
                          if (true) {
                            _t8907 = ({_tag: 1, _name: "Some", _val: ty});
                            break _t8908;
                          }
                          _match_fail("line 15950");
                        }
                        _t8904 = _t8907;
                        break _t8905;
                      }
                      if (_t8903._tag === 0) {
                        _t8904 = ({_tag: 0, _name: "None"});
                        break _t8905;
                      }
                      _match_fail("line 15950");
                    }
                    return _t8904;
                  }
                  const partial_args_8909 = List$map(_t8902, type_args_8900);
                  function _t8911(opt) {
                    return !_eq(opt, ({_tag: 0, _name: "None"}));
                  }
                  const has_info_8912 = List$exists(_t8911, partial_args_8909);
                  let _t8914;
                  if (has_info_8912) {
                    function _t8915(inst) {
                      return ((inst.inst_class === class_def.class_name) && ((List$length(inst.inst_tys) === List$length(partial_args_8909)) && Types$match_partial_inst(inst.inst_tys, partial_args_8909)));
                    }
                    const matching_8916 = List$filter(_t8915, xctx.xf_type_env.instances);
                    function _t8918(opt) {
                      return !_eq(opt, ({_tag: 0, _name: "None"}));
                    }
                    const all_concrete_8919 = List$forall(_t8918, partial_args_8909);
                    let _t8922;
                    const _t8921 = matching_8916;
                    _t8923: {
                      if (_t8921 !== null && _t8921._tl === null) {
                        const inst = _t8921._hd;
                        _t8922 = ({_tag: 1, _name: "Some", _val: inst});
                        break _t8923;
                      }
                      if (_t8921 !== null) {
                        _t8922 = Types$most_specific_inst(matching_8916);
                        break _t8923;
                      }
                      if (_t8921 === null) {
                        _t8922 = ({_tag: 0, _name: "None"});
                        break _t8923;
                      }
                      _match_fail("line 15950");
                    }
                    const resolved_8924 = _t8922;
                    let _t8927;
                    const _t8926 = resolved_8924;
                    _t8928: {
                      if (_t8926._tag === 1) {
                        const inst = _t8926._val;
                        if ((!_eq(inst.inst_constraints, null) && all_concrete_8919)) {
                          function _t8929(x) {
                            return x;
                          }
                          const arg_types_8930 = List$filter_map(_t8929, type_args_8900);
                          const factory_8932 = Typechecker$resolve_factory_dict(xctx, inst, arg_types_8930);
                          const _t8933 = Typechecker$mk(({_tag: 19, _name: "TEField", _val: [factory_8932, method_name]}), te.ty);
                          const _t8931 = _t8933;
                          _t8927 = _t8931;
                          break _t8928;
                        }
                      }
                      if (_t8926._tag === 1) {
                        const inst = _t8926._val;
                        if (_eq(inst.inst_constraints, null)) {
                          _t8927 = Typechecker$mk(({_tag: 19, _name: "TEField", _val: [Typechecker$mk(({_tag: 7, _name: "TEVar", _val: inst.inst_dict_name}), ({_tag: 6, _name: "TUnit"})), method_name]}), te.ty);
                          break _t8928;
                        }
                      }
                      if (true) {
                        _t8927 = te;
                        break _t8928;
                      }
                      _match_fail("line 15950");
                    }
                    const _t8925 = _t8927;
                    const _t8920 = _t8925;
                    const _t8917 = _t8920;
                    _t8914 = _t8917;
                  } else {
                    _t8914 = te;
                  }
                  const _t8913 = _t8914;
                  const _t8910 = _t8913;
                  const _t8901 = _t8910;
                  _t8897 = _t8901;
                  break _t8898;
                }
                _match_fail("line 15950");
              }
              const _t8895 = _t8897;
              const _t8865 = _t8895;
              const _t8850 = _t8865;
              const _t8848 = _t8850;
              _t8846 = _t8848;
            }
            const _t8845 = _t8846;
            const _t8840 = _t8845;
            _t8837 = _t8840;
            break _t8838;
          }
          if (_t8836._tag === 0) {
            _t8837 = te;
            break _t8838;
          }
          _match_fail("line 15950");
        }
        _t8834 = _t8837;
        break _t8835;
      }
      _match_fail("line 15950");
    }
    _t8817 = _t8834;
  }
  return _t8817;
}
function Typechecker$xform_constrained_ref(xctx, name, te) {
  let _t8935;
  const _t8934 = List$assoc_opt(name, xctx.xf_schemes);
  _t8936: {
    if (_t8934._tag === 1) {
      const scheme = _t8934._val;
      if (Typechecker$scheme_needs_xform(scheme)) {
        const result_8937 = Ref$create(te);
        let _t8939;
        if (!_eq(scheme.constraints, null)) {
          const tgen_map_8940 = Typechecker$build_tgen_map(scheme.body, te.ty);
          function _t8942(cc) {
            return Typechecker$resolve_dict_arg(xctx, cc, tgen_map_8940);
          }
          const dict_args_8943 = List$map(_t8942, scheme.constraints);
          function _t8945(fn_, dict_arg) {
            return Typechecker$mk(({_tag: 11, _name: "TEApp", _val: [fn_, dict_arg]}), ({_tag: 6, _name: "TUnit"}));
          }
          const _t8944 = Ref$set(result_8937, List$fold(_t8945, Ref$get(result_8937), dict_args_8943));
          const _t8941 = _t8944;
          _t8939 = _t8941;
        } else {
          _t8939 = undefined;
        }
        _t8939;
        let _t8946;
        if (!_eq(scheme.record_evidences, null)) {
          const rgen_map_8947 = Typechecker$build_rgen_map(scheme.body, te.ty);
          function _t8949(re) {
            return Typechecker$resolve_record_evidence_args(xctx, rgen_map_8947, re);
          }
          const ev_args_8950 = List$concat_map(_t8949, scheme.record_evidences);
          function _t8952(fn_, ev_arg) {
            return Typechecker$mk(({_tag: 11, _name: "TEApp", _val: [fn_, ev_arg]}), ({_tag: 6, _name: "TUnit"}));
          }
          const _t8951 = Ref$set(result_8937, List$fold(_t8952, Ref$get(result_8937), ev_args_8950));
          const _t8948 = _t8951;
          _t8946 = _t8948;
        } else {
          _t8946 = undefined;
        }
        _t8946;
        const _t8938 = Ref$get(result_8937);
        _t8935 = _t8938;
        break _t8936;
      }
    }
    if (true) {
      _t8935 = te;
      break _t8936;
    }
    _match_fail("line 15950");
  }
  return _t8935;
}
function Typechecker$resolve_record_evidence_args(xctx, rgen_map, re) {
  let _t8954;
  const _t8953 = _call(Hashtbl$get, [__dict_Hash_int, __dict_Eq_int, rgen_map, re.re_rgen]);
  _t8955: {
    if (_t8953._tag === 1) {
      const arow = _t8953._val;
      const fields_8956 = Types$record_row_to_fields(arow);
      function _t8958(__p293, __p294) {
        let _t8960;
        const _t8959 = __p293;
        _t8961: {
          if (true) {
            const a = _t8959[0];
            let _t8963;
            const _t8962 = __p294;
            _t8964: {
              if (true) {
                const b = _t8962[0];
                _t8963 = String$compare(a, b);
                break _t8964;
              }
              _match_fail("line 15950");
            }
            _t8960 = _t8963;
            break _t8961;
          }
          _match_fail("line 15950");
        }
        return _t8960;
      }
      const sorted_names_8965 = List$map(fst, List$sort(_t8958, fields_8956));
      function is_closed(r) {
        while (true) {
          let _t8968;
          const _t8967 = Types$rrow_repr(r);
          _t8969: {
            if (_t8967._tag === 0) {
              const tail = _t8967._val[2];
              const _t8970 = tail;
              r = _t8970;
              continue;
              _t8968 = undefined;
              break _t8969;
            }
            if (_t8967._tag === 2) {
              _t8968 = true;
              break _t8969;
            }
            if (true) {
              _t8968 = false;
              break _t8969;
            }
            _match_fail("line 15950");
          }
          return _t8968;
        }
      }
      let _t8972;
      if (is_closed(arow)) {
        function _t8973(field_name) {
          const idx_8974 = Ref$create((-1));
          function _t8976(i, n) {
            let _t8977;
            if ((n === field_name)) {
              _t8977 = Ref$set(idx_8974, i);
            } else {
              _t8977 = undefined;
            }
            return _t8977;
          }
          List$iteri(_t8976, sorted_names_8965);
          let _t8978;
          if ((Ref$get(idx_8974) >= 0)) {
            _t8978 = Typechecker$mk(({_tag: 0, _name: "TEInt", _val: Ref$get(idx_8974)}), ({_tag: 0, _name: "TInt"}));
          } else {
            _t8978 = Typechecker$error((("field " + __dict_Show_string.show(field_name)) + " not found in concrete record for evidence"));
          }
          const _t8975 = _t8978;
          return _t8975;
        }
        _t8972 = List$map(_t8973, re.re_fields);
      } else {
        function get_tail(r) {
          while (true) {
            let _t8980;
            const _t8979 = Types$rrow_repr(r);
            _t8981: {
              if (_t8979._tag === 0) {
                const tail = _t8979._val[2];
                const _t8982 = tail;
                r = _t8982;
                continue;
                _t8980 = undefined;
                break _t8981;
              }
              if (true) {
                const tail = _t8979;
                _t8980 = tail;
                break _t8981;
              }
              _match_fail("line 15950");
            }
            return _t8980;
          }
        }
        let _t8985;
        const _t8984 = get_tail(arow);
        _t8986: {
          if (_t8984._tag === 1 && _t8984._val.contents._tag === 0) {
            const id = _t8984._val.contents._val[0];
            function _t8987(field_name) {
              function _t8988(__p295) {
                let _t8990;
                const _t8989 = __p295;
                _t8991: {
                  if (true) {
                    const rid = _t8989[0];
                    const fname = _t8989[1];
                    const pname = _t8989[2];
                    let _t8992;
                    if (((rid === id) && (fname === field_name))) {
                      _t8992 = ({_tag: 1, _name: "Some", _val: pname});
                    } else {
                      _t8992 = ({_tag: 0, _name: "None"});
                    }
                    _t8990 = _t8992;
                    break _t8991;
                  }
                  _match_fail("line 15950");
                }
                return _t8990;
              }
              let _t8994;
              const _t8993 = List$find_map(_t8988, xctx.xf_record_evidence);
              _t8995: {
                if (_t8993._tag === 1) {
                  const pname = _t8993._val;
                  _t8994 = Typechecker$mk(({_tag: 7, _name: "TEVar", _val: pname}), ({_tag: 0, _name: "TInt"}));
                  break _t8995;
                }
                if (_t8993._tag === 0) {
                  _t8994 = Typechecker$error((("no evidence for field " + __dict_Show_string.show(field_name)) + " in polymorphic context"));
                  break _t8995;
                }
                _match_fail("line 15950");
              }
              return _t8994;
            }
            _t8985 = List$map(_t8987, re.re_fields);
            break _t8986;
          }
          if (true) {
            _t8985 = Typechecker$error("expected open row for evidence forwarding");
            break _t8986;
          }
          _match_fail("line 15950");
        }
        const _t8983 = _t8985;
        _t8972 = _t8983;
      }
      const _t8971 = _t8972;
      const _t8966 = _t8971;
      const _t8957 = _t8966;
      _t8954 = _t8957;
      break _t8955;
    }
    if (_t8953._tag === 0) {
      _t8954 = Typechecker$error((("internal error: no record evidence for fields [" + __dict_Show_string.show(String$concat(", ", re.re_fields))) + "]"));
      break _t8955;
    }
    _match_fail("line 15950");
  }
  return _t8954;
}
function Typechecker$xform_binop(xctx, op, e1, e2, result_ty) {
  let _t8997;
  const _t8996 = op;
  _t8998: {
    if (_t8996._tag === 0) {
      _t8997 = ({_tag: 1, _name: "Some", _val: ["Num", "+"]});
      break _t8998;
    }
    if (_t8996._tag === 1) {
      _t8997 = ({_tag: 1, _name: "Some", _val: ["Num", "-"]});
      break _t8998;
    }
    if (_t8996._tag === 2) {
      _t8997 = ({_tag: 1, _name: "Some", _val: ["Num", "*"]});
      break _t8998;
    }
    if (_t8996._tag === 3) {
      _t8997 = ({_tag: 1, _name: "Some", _val: ["Num", "/"]});
      break _t8998;
    }
    if (_t8996._tag === 5) {
      _t8997 = ({_tag: 1, _name: "Some", _val: ["Eq", "="]});
      break _t8998;
    }
    if (_t8996._tag === 6) {
      _t8997 = ({_tag: 1, _name: "Some", _val: ["Eq", "<>"]});
      break _t8998;
    }
    if (_t8996._tag === 7) {
      _t8997 = ({_tag: 1, _name: "Some", _val: ["Ord", "<"]});
      break _t8998;
    }
    if (_t8996._tag === 8) {
      _t8997 = ({_tag: 1, _name: "Some", _val: ["Ord", ">"]});
      break _t8998;
    }
    if (_t8996._tag === 9) {
      _t8997 = ({_tag: 1, _name: "Some", _val: ["Ord", "<="]});
      break _t8998;
    }
    if (_t8996._tag === 10) {
      _t8997 = ({_tag: 1, _name: "Some", _val: ["Ord", ">="]});
      break _t8998;
    }
    if (_t8996._tag === 14) {
      _t8997 = ({_tag: 1, _name: "Some", _val: ["Bitwise", "land"]});
      break _t8998;
    }
    if (_t8996._tag === 15) {
      _t8997 = ({_tag: 1, _name: "Some", _val: ["Bitwise", "lor"]});
      break _t8998;
    }
    if (_t8996._tag === 16) {
      _t8997 = ({_tag: 1, _name: "Some", _val: ["Bitwise", "lxor"]});
      break _t8998;
    }
    if (_t8996._tag === 17) {
      _t8997 = ({_tag: 1, _name: "Some", _val: ["Bitwise", "lsl"]});
      break _t8998;
    }
    if (_t8996._tag === 18) {
      _t8997 = ({_tag: 1, _name: "Some", _val: ["Bitwise", "lsr"]});
      break _t8998;
    }
    if (true) {
      _t8997 = ({_tag: 0, _name: "None"});
      break _t8998;
    }
    _match_fail("line 15950");
  }
  const class_info_8999 = _t8997;
  let _t9002;
  const _t9001 = class_info_8999;
  _t9003: {
    if (_t9001._tag === 1) {
      const class_name = _t9001._val[0];
      const method_name = _t9001._val[1];
      if (!_eq(xctx.xf_constrained, null)) {
        let _t9005;
        const _t9004 = Types$repr(e1.ty);
        _t9006: {
          if (_t9004._tag === 16 && _t9004._val.contents._tag === 0) {
            const id = _t9004._val.contents._val[0];
            let _t9008;
            const _t9007 = Typechecker$find_constrained_dict(xctx, id, class_name);
            _t9009: {
              if (_t9007._tag === 1) {
                const dparam = _t9007._val;
                const dict_ref_9010 = Typechecker$mk(({_tag: 7, _name: "TEVar", _val: dparam}), ({_tag: 6, _name: "TUnit"}));
                const method_ref_9012 = Typechecker$mk(({_tag: 19, _name: "TEField", _val: [dict_ref_9010, method_name]}), ({_tag: 6, _name: "TUnit"}));
                const app1_9014 = Typechecker$mk(({_tag: 11, _name: "TEApp", _val: [method_ref_9012, e1]}), ({_tag: 6, _name: "TUnit"}));
                const _t9015 = Typechecker$mk(({_tag: 11, _name: "TEApp", _val: [app1_9014, e2]}), result_ty);
                const _t9013 = _t9015;
                const _t9011 = _t9013;
                _t9008 = _t9011;
                break _t9009;
              }
              if (_t9007._tag === 0) {
                _t9008 = Typechecker$mk(({_tag: 13, _name: "TEBinop", _val: [op, e1, e2]}), result_ty);
                break _t9009;
              }
              _match_fail("line 15950");
            }
            _t9005 = _t9008;
            break _t9006;
          }
          if (true) {
            _t9005 = Typechecker$mk(({_tag: 13, _name: "TEBinop", _val: [op, e1, e2]}), result_ty);
            break _t9006;
          }
          _match_fail("line 15950");
        }
        _t9002 = _t9005;
        break _t9003;
      }
    }
    if (true) {
      _t9002 = Typechecker$mk(({_tag: 13, _name: "TEBinop", _val: [op, e1, e2]}), result_ty);
      break _t9003;
    }
    _match_fail("line 15950");
  }
  const _t9000 = _t9002;
  return _t9000;
}
function Typechecker$xform_unop(xctx, op, e, result_ty) {
  let _t9017;
  const _t9016 = op;
  _t9018: {
    if (_t9016._tag === 0) {
      _t9017 = ({_tag: 1, _name: "Some", _val: ["Num", "negate"]});
      break _t9018;
    }
    if (true) {
      _t9017 = ({_tag: 0, _name: "None"});
      break _t9018;
    }
    _match_fail("line 15950");
  }
  const class_info_9019 = _t9017;
  let _t9022;
  const _t9021 = class_info_9019;
  _t9023: {
    if (_t9021._tag === 1) {
      const class_name = _t9021._val[0];
      const method_name = _t9021._val[1];
      if (!_eq(xctx.xf_constrained, null)) {
        let _t9025;
        const _t9024 = Types$repr(e.ty);
        _t9026: {
          if (_t9024._tag === 16 && _t9024._val.contents._tag === 0) {
            const id = _t9024._val.contents._val[0];
            let _t9028;
            const _t9027 = Typechecker$find_constrained_dict(xctx, id, class_name);
            _t9029: {
              if (_t9027._tag === 1) {
                const dparam = _t9027._val;
                const dict_ref_9030 = Typechecker$mk(({_tag: 7, _name: "TEVar", _val: dparam}), ({_tag: 6, _name: "TUnit"}));
                const method_ref_9032 = Typechecker$mk(({_tag: 19, _name: "TEField", _val: [dict_ref_9030, method_name]}), ({_tag: 6, _name: "TUnit"}));
                const _t9033 = Typechecker$mk(({_tag: 11, _name: "TEApp", _val: [method_ref_9032, e]}), result_ty);
                const _t9031 = _t9033;
                _t9028 = _t9031;
                break _t9029;
              }
              if (_t9027._tag === 0) {
                _t9028 = Typechecker$mk(({_tag: 14, _name: "TEUnop", _val: [op, e]}), result_ty);
                break _t9029;
              }
              _match_fail("line 15950");
            }
            _t9025 = _t9028;
            break _t9026;
          }
          if (true) {
            _t9025 = Typechecker$mk(({_tag: 14, _name: "TEUnop", _val: [op, e]}), result_ty);
            break _t9026;
          }
          _match_fail("line 15950");
        }
        _t9022 = _t9025;
        break _t9023;
      }
    }
    if (true) {
      _t9022 = Typechecker$mk(({_tag: 14, _name: "TEUnop", _val: [op, e]}), result_ty);
      break _t9023;
    }
    _match_fail("line 15950");
  }
  const _t9020 = _t9022;
  return _t9020;
}
function Typechecker$xform_constrained_def(xctx, scheme, te) {
  const tgen_map_9034 = Typechecker$build_tgen_map(scheme.body, te.ty);
  function _t9036(__p296, cc) {
    let _t9038;
    const _t9037 = __p296;
    _t9039: {
      if (true) {
        const entries = _t9037[0];
        const params = _t9037[1];
        function _t9040(ca) {
          let _t9042;
          const _t9041 = ca;
          _t9043: {
            if (_t9041._tag === 0) {
              const tgen_idx = _t9041._val;
              let _t9045;
              const _t9044 = _call(Hashtbl$get, [__dict_Hash_int, __dict_Eq_int, tgen_map_9034, tgen_idx]);
              _t9046: {
                if (_t9044._tag === 1 && _t9044._val._tag === 16 && _t9044._val._val.contents._tag === 0) {
                  const id = _t9044._val._val.contents._val[0];
                  _t9045 = ({_tag: 1, _name: "Some", _val: [id, tgen_idx]});
                  break _t9046;
                }
                if (true) {
                  _t9045 = ({_tag: 0, _name: "None"});
                  break _t9046;
                }
                _match_fail("line 15950");
              }
              _t9042 = _t9045;
              break _t9043;
            }
            if (_t9041._tag === 1) {
              const ty = _t9041._val;
              let _t9048;
              const _t9047 = Types$repr(ty);
              _t9049: {
                if (_t9047._tag === 16 && _t9047._val.contents._tag === 0) {
                  const id = _t9047._val.contents._val[0];
                  _t9048 = ({_tag: 1, _name: "Some", _val: [id, (1000 + id)]});
                  break _t9049;
                }
                if (true) {
                  _t9048 = ({_tag: 0, _name: "None"});
                  break _t9049;
                }
                _match_fail("line 15950");
              }
              _t9042 = _t9048;
              break _t9043;
            }
            if (_t9041._tag === 2) {
              _t9042 = ({_tag: 0, _name: "None"});
              break _t9043;
            }
            if (_t9041._tag === 3) {
              const tv = _t9041._val[1];
              let _t9051;
              const _t9050 = Types$repr(tv);
              _t9052: {
                if (_t9050._tag === 16 && _t9050._val.contents._tag === 0) {
                  const id = _t9050._val.contents._val[0];
                  _t9051 = ({_tag: 1, _name: "Some", _val: [id, (1000 + id)]});
                  break _t9052;
                }
                if (true) {
                  _t9051 = ({_tag: 0, _name: "None"});
                  break _t9052;
                }
                _match_fail("line 15950");
              }
              _t9042 = _t9051;
              break _t9043;
            }
            _match_fail("line 15950");
          }
          return _t9042;
        }
        const tvar_entries_9053 = List$filter_map(_t9040, cc.cc_args);
        let _t9056;
        const _t9055 = tvar_entries_9053;
        _t9057: {
          if (_t9055 === null) {
            const dparam_9058 = ((("__dict_" + __dict_Show_string.show(cc.cc_class)) + "_resolved_") + __dict_Show_int.show(List$length(params)));
            const _t9059 = [entries, ({_hd: dparam_9058, _tl: params})];
            _t9056 = _t9059;
            break _t9057;
          }
          if (true) {
            function _t9060(__p297) {
              let _t9062;
              const _t9061 = __p297;
              _t9063: {
                if (true) {
                  const idx = _t9061[1];
                  _t9062 = string_of_int(idx);
                  break _t9063;
                }
                _match_fail("line 15950");
              }
              return _t9062;
            }
            const dparam_9064 = ((("__dict_" + __dict_Show_string.show(cc.cc_class)) + "_") + __dict_Show_string.show(String$concat("_", List$map(_t9060, tvar_entries_9053))));
            function _t9066(__p298) {
              let _t9068;
              const _t9067 = __p298;
              _t9069: {
                if (true) {
                  const id = _t9067[0];
                  _t9068 = [id, dparam_9064, cc.cc_class];
                  break _t9069;
                }
                _match_fail("line 15950");
              }
              return _t9068;
            }
            const new_entries_9070 = List$map(_t9066, tvar_entries_9053);
            const _t9071 = [List$concat(new_entries_9070, entries), ({_hd: dparam_9064, _tl: params})];
            const _t9065 = _t9071;
            _t9056 = _t9065;
            break _t9057;
          }
          _match_fail("line 15950");
        }
        const _t9054 = _t9056;
        _t9038 = _t9054;
        break _t9039;
      }
      _match_fail("line 15950");
    }
    return _t9038;
  }
  let _t9073;
  const _t9072 = List$fold(_t9036, [null, null], scheme.constraints);
  _t9074: {
    if (true) {
      const all_constrained = _t9072[0];
      const dict_param_names = _t9072[1];
      const dict_param_names_9075 = List$rev(dict_param_names);
      const rgen_map_9077 = Typechecker$build_rgen_map(scheme.body, te.ty);
      function _t9079(__p299, re) {
        let _t9081;
        const _t9080 = __p299;
        _t9082: {
          if (true) {
            const entries = _t9080[0];
            const params = _t9080[1];
            function _t9083(__p300, field_name) {
              let _t9085;
              const _t9084 = __p300;
              _t9086: {
                if (true) {
                  const entries = _t9084[0];
                  const params = _t9084[1];
                  const pname_9087 = ((("__ev_" + __dict_Show_string.show(field_name)) + "_r") + __dict_Show_int.show(re.re_rgen));
                  let _t9090;
                  const _t9089 = _call(Hashtbl$get, [__dict_Hash_int, __dict_Eq_int, rgen_map_9077, re.re_rgen]);
                  _t9091: {
                    if (_t9089._tag === 1) {
                      const arow = _t9089._val;
                      function get_tail(r) {
                        while (true) {
                          let _t9093;
                          const _t9092 = Types$rrow_repr(r);
                          _t9094: {
                            if (_t9092._tag === 0) {
                              const tail = _t9092._val[2];
                              const _t9095 = tail;
                              r = _t9095;
                              continue;
                              _t9093 = undefined;
                              break _t9094;
                            }
                            if (true) {
                              const tail = _t9092;
                              _t9093 = tail;
                              break _t9094;
                            }
                            _match_fail("line 15950");
                          }
                          return _t9093;
                        }
                      }
                      let _t9098;
                      const _t9097 = get_tail(arow);
                      _t9099: {
                        if (_t9097._tag === 1 && _t9097._val.contents._tag === 0) {
                          const id = _t9097._val.contents._val[0];
                          _t9098 = ({_hd: [id, field_name, pname_9087], _tl: null});
                          break _t9099;
                        }
                        if (true) {
                          _t9098 = null;
                          break _t9099;
                        }
                        _match_fail("line 15950");
                      }
                      const _t9096 = _t9098;
                      _t9090 = _t9096;
                      break _t9091;
                    }
                    if (_t9089._tag === 0) {
                      _t9090 = null;
                      break _t9091;
                    }
                    _match_fail("line 15950");
                  }
                  const rvar_entries_9100 = _t9090;
                  const _t9101 = [List$concat(rvar_entries_9100, entries), ({_hd: pname_9087, _tl: params})];
                  const _t9088 = _t9101;
                  _t9085 = _t9088;
                  break _t9086;
                }
                _match_fail("line 15950");
              }
              return _t9085;
            }
            _t9081 = List$fold(_t9083, [entries, params], re.re_fields);
            break _t9082;
          }
          _match_fail("line 15950");
        }
        return _t9081;
      }
      let _t9103;
      const _t9102 = List$fold(_t9079, [null, null], scheme.record_evidences);
      _t9104: {
        if (true) {
          const all_record_ev = _t9102[0];
          const ev_param_names = _t9102[1];
          const ev_param_names_9105 = List$rev(ev_param_names);
          const __rec_upd_9107 = xctx;
          const _t9108 = ({xf_constrained: List$concat(all_constrained, xctx.xf_constrained), xf_locals: __rec_upd_9107.xf_locals, xf_record_evidence: List$concat(all_record_ev, xctx.xf_record_evidence), xf_schemes: __rec_upd_9107.xf_schemes, xf_type_env: __rec_upd_9107.xf_type_env});
          const xctx_9109 = _t9108;
          const rewritten_9111 = Typechecker$xform_expr(xctx_9109, te);
          const all_params_9113 = List$concat(dict_param_names_9075, ev_param_names_9105);
          function _t9115(dparam, body) {
            return Typechecker$mk(({_tag: 10, _name: "TEFun", _val: [dparam, body, false]}), ({_tag: 7, _name: "TArrow", _val: [({_tag: 6, _name: "TUnit"}), ({_tag: 1, _name: "EffEmpty"}), body.ty]}));
          }
          const _t9114 = List$fold_right(_t9115, all_params_9113, rewritten_9111);
          const _t9112 = _t9114;
          const _t9110 = _t9112;
          const _t9106 = _t9110;
          _t9103 = _t9106;
          break _t9104;
        }
        _match_fail("line 15950");
      }
      const _t9078 = _t9103;
      const _t9076 = _t9078;
      _t9073 = _t9076;
      break _t9074;
    }
    _match_fail("line 15950");
  }
  const _t9035 = _t9073;
  return _t9035;
}
function Typechecker$xform_constrained_inst(xctx, inst_def, dict_expr) {
  let _t9117;
  const _t9116 = dict_expr.expr;
  _t9118: {
    if (_t9116._tag === 16) {
      const fs = _t9116._val;
      _t9117 = fs;
      break _t9118;
    }
    if (true) {
      _t9117 = failwith("assert false");
      break _t9118;
    }
    _match_fail("line 15950");
  }
  let _t9120;
  const _t9119 = Types$find_method_class(xctx.xf_type_env.classes, fst(List$hd(_t9117)));
  _t9121: {
    if (_t9119._tag === 1) {
      const cd = _t9119._val;
      if ((cd.class_name === inst_def.inst_class)) {
        _t9120 = cd;
        break _t9121;
      }
    }
    if (true) {
      function _t9122(c) {
        return (c.class_name === inst_def.inst_class);
      }
      let _t9124;
      const _t9123 = List$find(_t9122, xctx.xf_type_env.classes);
      _t9125: {
        if (_t9123._tag === 1) {
          const cd = _t9123._val;
          _t9124 = cd;
          break _t9125;
        }
        if (_t9123._tag === 0) {
          _t9124 = Typechecker$error((("class " + __dict_Show_string.show(inst_def.inst_class)) + " not found"));
          break _t9125;
        }
        _match_fail("line 15950");
      }
      _t9120 = _t9124;
      break _t9121;
    }
    _match_fail("line 15950");
  }
  const class_def_9126 = _t9120;
  const class_param_map_9128 = Hashtbl$create(4);
  const inst_tvar_map_9130 = Hashtbl$create(4);
  let _t9133;
  const _t9132 = dict_expr.expr;
  _t9134: {
    if (_t9132._tag === 16) {
      const fields = _t9132._val;
      function _t9135(__p301) {
        let _t9137;
        const _t9136 = __p301;
        _t9138: {
          if (true) {
            const mname = _t9136[0];
            const mte = _t9136[1];
            let _t9140;
            const _t9139 = List$assoc_opt(mname, class_def_9126.class_methods);
            _t9141: {
              if (_t9139._tag === 1) {
                const class_method_ty = _t9139._val;
                function walk_class(s, a) {
                  while (true) {
                    const a_9142 = Types$repr(a);
                    let _t9145;
                    const _t9144 = s;
                    _t9146: {
                      if (_t9144._tag === 17) {
                        const i = _t9144._val;
                        let _t9147;
                        if ((!_call(Hashtbl$has, [__dict_Hash_int, __dict_Eq_int, class_param_map_9128, i]))) {
                          _t9147 = _call(Hashtbl$set, [__dict_Hash_int, __dict_Eq_int, class_param_map_9128, i, a_9142]);
                        } else {
                          _t9147 = undefined;
                        }
                        _t9145 = _t9147;
                        break _t9146;
                      }
                      if (_t9144._tag === 7) {
                        const s1 = _t9144._val[0];
                        const s2 = _t9144._val[2];
                        let _t9149;
                        const _t9148 = a_9142;
                        _t9150: {
                          if (_t9148._tag === 7) {
                            const a1 = _t9148._val[0];
                            const a2 = _t9148._val[2];
                            walk_class(s1, a1);
                            const _t9151 = s2;
                            const _t9152 = a2;
                            s = _t9151;
                            a = _t9152;
                            continue;
                            _t9149 = undefined;
                            break _t9150;
                          }
                          if (true) {
                            _t9149 = undefined;
                            break _t9150;
                          }
                          _match_fail("line 15950");
                        }
                        _t9145 = _t9149;
                        break _t9146;
                      }
                      if (_t9144._tag === 8) {
                        const s1 = _t9144._val[0];
                        const s2 = _t9144._val[2];
                        let _t9154;
                        const _t9153 = a_9142;
                        _t9155: {
                          if (_t9153._tag === 8) {
                            const a1 = _t9153._val[0];
                            const a2 = _t9153._val[2];
                            walk_class(s1, a1);
                            const _t9156 = s2;
                            const _t9157 = a2;
                            s = _t9156;
                            a = _t9157;
                            continue;
                            _t9154 = undefined;
                            break _t9155;
                          }
                          if (true) {
                            _t9154 = undefined;
                            break _t9155;
                          }
                          _match_fail("line 15950");
                        }
                        _t9145 = _t9154;
                        break _t9146;
                      }
                      if (_t9144._tag === 9) {
                        const ss = _t9144._val;
                        let _t9159;
                        const _t9158 = a_9142;
                        _t9160: {
                          if (_t9158._tag === 9) {
                            const aa = _t9158._val;
                            if ((List$length(ss) === List$length(aa))) {
                              _t9159 = List$iter2(walk_class, ss, aa);
                              break _t9160;
                            }
                          }
                          if (true) {
                            _t9159 = undefined;
                            break _t9160;
                          }
                          _match_fail("line 15950");
                        }
                        _t9145 = _t9159;
                        break _t9146;
                      }
                      if (_t9144._tag === 10) {
                        const s1 = _t9144._val;
                        let _t9162;
                        const _t9161 = a_9142;
                        _t9163: {
                          if (_t9161._tag === 10) {
                            const a1 = _t9161._val;
                            const _t9164 = s1;
                            const _t9165 = a1;
                            s = _t9164;
                            a = _t9165;
                            continue;
                            _t9162 = undefined;
                            break _t9163;
                          }
                          if (true) {
                            _t9162 = undefined;
                            break _t9163;
                          }
                          _match_fail("line 15950");
                        }
                        _t9145 = _t9162;
                        break _t9146;
                      }
                      if (_t9144._tag === 14) {
                        const s1 = _t9144._val;
                        let _t9167;
                        const _t9166 = a_9142;
                        _t9168: {
                          if (_t9166._tag === 14) {
                            const a1 = _t9166._val;
                            const _t9169 = s1;
                            const _t9170 = a1;
                            s = _t9169;
                            a = _t9170;
                            continue;
                            _t9167 = undefined;
                            break _t9168;
                          }
                          if (true) {
                            _t9167 = undefined;
                            break _t9168;
                          }
                          _match_fail("line 15950");
                        }
                        _t9145 = _t9167;
                        break _t9146;
                      }
                      if (_t9144._tag === 13) {
                        const sk = _t9144._val[0];
                        const sv = _t9144._val[1];
                        let _t9172;
                        const _t9171 = a_9142;
                        _t9173: {
                          if (_t9171._tag === 13) {
                            const ak = _t9171._val[0];
                            const av = _t9171._val[1];
                            walk_class(sk, ak);
                            const _t9174 = sv;
                            const _t9175 = av;
                            s = _t9174;
                            a = _t9175;
                            continue;
                            _t9172 = undefined;
                            break _t9173;
                          }
                          if (true) {
                            _t9172 = undefined;
                            break _t9173;
                          }
                          _match_fail("line 15950");
                        }
                        _t9145 = _t9172;
                        break _t9146;
                      }
                      if (_t9144._tag === 12) {
                        const ss = _t9144._val[1];
                        let _t9177;
                        const _t9176 = a_9142;
                        _t9178: {
                          if (_t9176._tag === 12) {
                            const aa = _t9176._val[1];
                            if ((List$length(ss) === List$length(aa))) {
                              _t9177 = List$iter2(walk_class, ss, aa);
                              break _t9178;
                            }
                          }
                          if (true) {
                            _t9177 = undefined;
                            break _t9178;
                          }
                          _match_fail("line 15950");
                        }
                        _t9145 = _t9177;
                        break _t9146;
                      }
                      if (true) {
                        _t9145 = undefined;
                        break _t9146;
                      }
                      _match_fail("line 15950");
                    }
                    const _t9143 = _t9145;
                    return _t9143;
                  }
                }
                const _t9179 = walk_class(class_method_ty, mte.ty);
                _t9140 = _t9179;
                break _t9141;
              }
              if (_t9139._tag === 0) {
                _t9140 = undefined;
                break _t9141;
              }
              _match_fail("line 15950");
            }
            _t9137 = _t9140;
            break _t9138;
          }
          _match_fail("line 15950");
        }
        return _t9137;
      }
      List$iter(_t9135, fields);
      function _t9180(class_idx, stored_ty) {
        let _t9182;
        const _t9181 = _call(Hashtbl$get, [__dict_Hash_int, __dict_Eq_int, class_param_map_9128, class_idx]);
        _t9183: {
          if (_t9181._tag === 1) {
            const actual_ty = _t9181._val;
            function walk_inst(s, a) {
              while (true) {
                const a_9184 = Types$repr(a);
                let _t9187;
                const _t9186 = s;
                _t9188: {
                  if (_t9186._tag === 17) {
                    const i = _t9186._val;
                    let _t9189;
                    if ((!_call(Hashtbl$has, [__dict_Hash_int, __dict_Eq_int, inst_tvar_map_9130, i]))) {
                      let _t9191;
                      const _t9190 = a_9184;
                      _t9192: {
                        if (_t9190._tag === 16 && _t9190._val.contents._tag === 0) {
                          const id = _t9190._val.contents._val[0];
                          _t9191 = _call(Hashtbl$set, [__dict_Hash_int, __dict_Eq_int, inst_tvar_map_9130, i, id]);
                          break _t9192;
                        }
                        if (true) {
                          _t9191 = undefined;
                          break _t9192;
                        }
                        _match_fail("line 15950");
                      }
                      _t9189 = _t9191;
                    } else {
                      _t9189 = undefined;
                    }
                    _t9187 = _t9189;
                    break _t9188;
                  }
                  if (_t9186._tag === 7) {
                    const s1 = _t9186._val[0];
                    const s2 = _t9186._val[2];
                    let _t9194;
                    const _t9193 = a_9184;
                    _t9195: {
                      if (_t9193._tag === 7) {
                        const a1 = _t9193._val[0];
                        const a2 = _t9193._val[2];
                        walk_inst(s1, a1);
                        const _t9196 = s2;
                        const _t9197 = a2;
                        s = _t9196;
                        a = _t9197;
                        continue;
                        _t9194 = undefined;
                        break _t9195;
                      }
                      if (true) {
                        _t9194 = undefined;
                        break _t9195;
                      }
                      _match_fail("line 15950");
                    }
                    _t9187 = _t9194;
                    break _t9188;
                  }
                  if (_t9186._tag === 8) {
                    const s1 = _t9186._val[0];
                    const s2 = _t9186._val[2];
                    let _t9199;
                    const _t9198 = a_9184;
                    _t9200: {
                      if (_t9198._tag === 8) {
                        const a1 = _t9198._val[0];
                        const a2 = _t9198._val[2];
                        walk_inst(s1, a1);
                        const _t9201 = s2;
                        const _t9202 = a2;
                        s = _t9201;
                        a = _t9202;
                        continue;
                        _t9199 = undefined;
                        break _t9200;
                      }
                      if (true) {
                        _t9199 = undefined;
                        break _t9200;
                      }
                      _match_fail("line 15950");
                    }
                    _t9187 = _t9199;
                    break _t9188;
                  }
                  if (_t9186._tag === 9) {
                    const ss = _t9186._val;
                    let _t9204;
                    const _t9203 = a_9184;
                    _t9205: {
                      if (_t9203._tag === 9) {
                        const aa = _t9203._val;
                        if ((List$length(ss) === List$length(aa))) {
                          _t9204 = List$iter2(walk_inst, ss, aa);
                          break _t9205;
                        }
                      }
                      if (true) {
                        _t9204 = undefined;
                        break _t9205;
                      }
                      _match_fail("line 15950");
                    }
                    _t9187 = _t9204;
                    break _t9188;
                  }
                  if (_t9186._tag === 10) {
                    const s1 = _t9186._val;
                    let _t9207;
                    const _t9206 = a_9184;
                    _t9208: {
                      if (_t9206._tag === 10) {
                        const a1 = _t9206._val;
                        const _t9209 = s1;
                        const _t9210 = a1;
                        s = _t9209;
                        a = _t9210;
                        continue;
                        _t9207 = undefined;
                        break _t9208;
                      }
                      if (true) {
                        _t9207 = undefined;
                        break _t9208;
                      }
                      _match_fail("line 15950");
                    }
                    _t9187 = _t9207;
                    break _t9188;
                  }
                  if (_t9186._tag === 14) {
                    const s1 = _t9186._val;
                    let _t9212;
                    const _t9211 = a_9184;
                    _t9213: {
                      if (_t9211._tag === 14) {
                        const a1 = _t9211._val;
                        const _t9214 = s1;
                        const _t9215 = a1;
                        s = _t9214;
                        a = _t9215;
                        continue;
                        _t9212 = undefined;
                        break _t9213;
                      }
                      if (true) {
                        _t9212 = undefined;
                        break _t9213;
                      }
                      _match_fail("line 15950");
                    }
                    _t9187 = _t9212;
                    break _t9188;
                  }
                  if (_t9186._tag === 13) {
                    const sk = _t9186._val[0];
                    const sv = _t9186._val[1];
                    let _t9217;
                    const _t9216 = a_9184;
                    _t9218: {
                      if (_t9216._tag === 13) {
                        const ak = _t9216._val[0];
                        const av = _t9216._val[1];
                        walk_inst(sk, ak);
                        const _t9219 = sv;
                        const _t9220 = av;
                        s = _t9219;
                        a = _t9220;
                        continue;
                        _t9217 = undefined;
                        break _t9218;
                      }
                      if (true) {
                        _t9217 = undefined;
                        break _t9218;
                      }
                      _match_fail("line 15950");
                    }
                    _t9187 = _t9217;
                    break _t9188;
                  }
                  if (_t9186._tag === 12) {
                    const ss = _t9186._val[1];
                    let _t9222;
                    const _t9221 = a_9184;
                    _t9223: {
                      if (_t9221._tag === 12) {
                        const aa = _t9221._val[1];
                        if ((List$length(ss) === List$length(aa))) {
                          _t9222 = List$iter2(walk_inst, ss, aa);
                          break _t9223;
                        }
                      }
                      if (true) {
                        _t9222 = undefined;
                        break _t9223;
                      }
                      _match_fail("line 15950");
                    }
                    _t9187 = _t9222;
                    break _t9188;
                  }
                  if (true) {
                    _t9187 = undefined;
                    break _t9188;
                  }
                  _match_fail("line 15950");
                }
                const _t9185 = _t9187;
                return _t9185;
              }
            }
            const _t9224 = walk_inst(stored_ty, actual_ty);
            _t9182 = _t9224;
            break _t9183;
          }
          if (_t9181._tag === 0) {
            _t9182 = undefined;
            break _t9183;
          }
          _match_fail("line 15950");
        }
        return _t9182;
      }
      _t9133 = List$iteri(_t9180, inst_def.inst_tys);
      break _t9134;
    }
    if (true) {
      _t9133 = undefined;
      break _t9134;
    }
    _match_fail("line 15950");
  }
  _t9133;
  function _t9225(__p302, cc) {
    let _t9227;
    const _t9226 = __p302;
    _t9228: {
      if (true) {
        const entries = _t9226[0];
        const params = _t9226[1];
        function _t9229(ca) {
          let _t9231;
          const _t9230 = ca;
          _t9232: {
            if (_t9230._tag === 0) {
              const tgen_idx = _t9230._val;
              let _t9234;
              const _t9233 = _call(Hashtbl$get, [__dict_Hash_int, __dict_Eq_int, inst_tvar_map_9130, tgen_idx]);
              _t9235: {
                if (_t9233._tag === 1) {
                  const tvar_id = _t9233._val;
                  _t9234 = ({_tag: 1, _name: "Some", _val: [tvar_id, tgen_idx]});
                  break _t9235;
                }
                if (_t9233._tag === 0) {
                  _t9234 = ({_tag: 0, _name: "None"});
                  break _t9235;
                }
                _match_fail("line 15950");
              }
              _t9231 = _t9234;
              break _t9232;
            }
            if (_t9230._tag === 1) {
              _t9231 = ({_tag: 0, _name: "None"});
              break _t9232;
            }
            if (_t9230._tag === 2) {
              _t9231 = ({_tag: 0, _name: "None"});
              break _t9232;
            }
            if (_t9230._tag === 3) {
              _t9231 = ({_tag: 0, _name: "None"});
              break _t9232;
            }
            _match_fail("line 15950");
          }
          return _t9231;
        }
        const tvar_entries_9236 = List$filter_map(_t9229, cc.cc_args);
        let _t9239;
        const _t9238 = tvar_entries_9236;
        _t9240: {
          if (_t9238 === null) {
            _t9239 = [entries, params];
            break _t9240;
          }
          if (true) {
            function _t9241(__p303) {
              let _t9243;
              const _t9242 = __p303;
              _t9244: {
                if (true) {
                  const idx = _t9242[1];
                  _t9243 = string_of_int(idx);
                  break _t9244;
                }
                _match_fail("line 15950");
              }
              return _t9243;
            }
            const dparam_9245 = ((("__dict_" + __dict_Show_string.show(cc.cc_class)) + "_") + __dict_Show_string.show(String$concat("_", List$map(_t9241, tvar_entries_9236))));
            function _t9247(__p304) {
              let _t9249;
              const _t9248 = __p304;
              _t9250: {
                if (true) {
                  const id = _t9248[0];
                  _t9249 = [id, dparam_9245, cc.cc_class];
                  break _t9250;
                }
                _match_fail("line 15950");
              }
              return _t9249;
            }
            const new_entries_9251 = List$map(_t9247, tvar_entries_9236);
            const _t9252 = [List$concat(new_entries_9251, entries), ({_hd: dparam_9245, _tl: params})];
            const _t9246 = _t9252;
            _t9239 = _t9246;
            break _t9240;
          }
          _match_fail("line 15950");
        }
        const _t9237 = _t9239;
        _t9227 = _t9237;
        break _t9228;
      }
      _match_fail("line 15950");
    }
    return _t9227;
  }
  let _t9254;
  const _t9253 = List$fold(_t9225, [null, null], inst_def.inst_constraints);
  _t9255: {
    if (true) {
      const all_constrained = _t9253[0];
      const dict_param_names = _t9253[1];
      const dict_param_names_9256 = List$rev(dict_param_names);
      const __rec_upd_9258 = xctx;
      const _t9259 = ({xf_constrained: List$concat(all_constrained, xctx.xf_constrained), xf_locals: __rec_upd_9258.xf_locals, xf_record_evidence: __rec_upd_9258.xf_record_evidence, xf_schemes: __rec_upd_9258.xf_schemes, xf_type_env: __rec_upd_9258.xf_type_env});
      const xctx_9260 = _t9259;
      const rewritten_9262 = Typechecker$xform_expr(xctx_9260, dict_expr);
      function _t9264(dparam, body) {
        return Typechecker$mk(({_tag: 10, _name: "TEFun", _val: [dparam, body, false]}), ({_tag: 7, _name: "TArrow", _val: [({_tag: 6, _name: "TUnit"}), ({_tag: 1, _name: "EffEmpty"}), body.ty]}));
      }
      const _t9263 = List$fold_right(_t9264, dict_param_names_9256, rewritten_9262);
      const _t9261 = _t9263;
      const _t9257 = _t9261;
      _t9254 = _t9257;
      break _t9255;
    }
    _match_fail("line 15950");
  }
  const _t9131 = _t9254;
  const _t9129 = _t9131;
  const _t9127 = _t9129;
  return _t9127;
}
function Typechecker$apply_fundep_improvement(type_env, vars, tprog) {
  function _t9265(tdecl) {
    let _t9267;
    const _t9266 = tdecl;
    _t9268: {
      if ((((_t9266._tag === 0 || _t9266._tag === 2) || _t9266._tag === 5) || _t9266._tag === 1)) {
        const te = (((_t9266._tag === 0 || _t9266._tag === 2) || _t9266._tag === 5) ? ((_t9266._tag === 0 || _t9266._tag === 2) ? _t9266._val[1] : _t9266._val) : _t9266._val[1]);
        _t9267 = Typechecker$improve_fundeps_in_expr(vars, type_env, te);
        break _t9268;
      }
      if (_t9266._tag === 3) {
        const bindings = _t9266._val;
        function _t9269(__p305) {
          let _t9271;
          const _t9270 = __p305;
          _t9272: {
            if (true) {
              const te = _t9270[1];
              _t9271 = Typechecker$improve_fundeps_in_expr(vars, type_env, te);
              break _t9272;
            }
            _match_fail("line 15950");
          }
          return _t9271;
        }
        _t9267 = List$iter(_t9269, bindings);
        break _t9268;
      }
      if (_t9266._tag === 9) {
        const decls = _t9266._val[1];
        function _t9273(d) {
          let _t9275;
          const _t9274 = d;
          _t9276: {
            if ((((_t9274._tag === 0 || _t9274._tag === 2) || _t9274._tag === 5) || _t9274._tag === 1)) {
              const te = (((_t9274._tag === 0 || _t9274._tag === 2) || _t9274._tag === 5) ? ((_t9274._tag === 0 || _t9274._tag === 2) ? _t9274._val[1] : _t9274._val) : _t9274._val[1]);
              _t9275 = Typechecker$improve_fundeps_in_expr(vars, type_env, te);
              break _t9276;
            }
            if (_t9274._tag === 3) {
              const bindings = _t9274._val;
              function _t9277(__p306) {
                let _t9279;
                const _t9278 = __p306;
                _t9280: {
                  if (true) {
                    const te = _t9278[1];
                    _t9279 = Typechecker$improve_fundeps_in_expr(vars, type_env, te);
                    break _t9280;
                  }
                  _match_fail("line 15950");
                }
                return _t9279;
              }
              _t9275 = List$iter(_t9277, bindings);
              break _t9276;
            }
            if (true) {
              _t9275 = undefined;
              break _t9276;
            }
            _match_fail("line 15950");
          }
          return _t9275;
        }
        _t9267 = List$iter(_t9273, decls);
        break _t9268;
      }
      if (true) {
        _t9267 = undefined;
        break _t9268;
      }
      _match_fail("line 15950");
    }
    return _t9267;
  }
  return List$iter(_t9265, tprog);
}
function Typechecker$transform_constraints(ctx, tprog) {
  Typechecker$apply_fundep_improvement(ctx.type_env, ctx.vars, tprog);
  const xctx_9281 = ({xf_constrained: null, xf_locals: null, xf_record_evidence: null, xf_schemes: ctx.vars, xf_type_env: ctx.type_env});
  function _t9283(xctx, tdecl) {
    let _t9285;
    const _t9284 = tdecl;
    _t9286: {
      if (_t9284._tag === 0) {
        const name = _t9284._val[0];
        const te = _t9284._val[1];
        let _t9288;
        const _t9287 = List$assoc_opt(name, xctx.xf_schemes);
        _t9289: {
          if (_t9287._tag === 1) {
            const scheme = _t9287._val;
            if (Typechecker$scheme_needs_xform(scheme)) {
              _t9288 = ({_tag: 0, _name: "TDLet", _val: [name, Typechecker$xform_constrained_def(xctx, scheme, te)]});
              break _t9289;
            }
          }
          if (true) {
            function _t9290(i) {
              return ((i.inst_dict_name === name) && !_eq(i.inst_constraints, null));
            }
            const inst_9291 = List$find(_t9290, xctx.xf_type_env.instances);
            let _t9294;
            const _t9293 = inst_9291;
            _t9295: {
              if (_t9293._tag === 1) {
                const inst_def = _t9293._val;
                _t9294 = ({_tag: 0, _name: "TDLet", _val: [name, Typechecker$xform_constrained_inst(xctx, inst_def, te)]});
                break _t9295;
              }
              if (_t9293._tag === 0) {
                _t9294 = ({_tag: 0, _name: "TDLet", _val: [name, Typechecker$xform_expr(xctx, te)]});
                break _t9295;
              }
              _match_fail("line 15950");
            }
            const _t9292 = _t9294;
            _t9288 = _t9292;
            break _t9289;
          }
          _match_fail("line 15950");
        }
        _t9285 = _t9288;
        break _t9286;
      }
      if (_t9284._tag === 2) {
        const name = _t9284._val[0];
        const te = _t9284._val[1];
        let _t9297;
        const _t9296 = List$assoc_opt(name, xctx.xf_schemes);
        _t9298: {
          if (_t9296._tag === 1) {
            const scheme = _t9296._val;
            if (Typechecker$scheme_needs_xform(scheme)) {
              _t9297 = ({_tag: 2, _name: "TDLetRec", _val: [name, Typechecker$xform_constrained_def(xctx, scheme, te)]});
              break _t9298;
            }
          }
          if (true) {
            _t9297 = ({_tag: 2, _name: "TDLetRec", _val: [name, Typechecker$xform_expr(xctx, te)]});
            break _t9298;
          }
          _match_fail("line 15950");
        }
        _t9285 = _t9297;
        break _t9286;
      }
      if (_t9284._tag === 3) {
        const bindings = _t9284._val;
        function _t9299(__p307) {
          let _t9301;
          const _t9300 = __p307;
          _t9302: {
            if (true) {
              const n = _t9300[0];
              const te = _t9300[1];
              let _t9304;
              const _t9303 = List$assoc_opt(n, xctx.xf_schemes);
              _t9305: {
                if (_t9303._tag === 1) {
                  const scheme = _t9303._val;
                  if (Typechecker$scheme_needs_xform(scheme)) {
                    _t9304 = [n, Typechecker$xform_constrained_def(xctx, scheme, te)];
                    break _t9305;
                  }
                }
                if (true) {
                  _t9304 = [n, Typechecker$xform_expr(xctx, te)];
                  break _t9305;
                }
                _match_fail("line 15950");
              }
              _t9301 = _t9304;
              break _t9302;
            }
            _match_fail("line 15950");
          }
          return _t9301;
        }
        _t9285 = ({_tag: 3, _name: "TDLetRecAnd", _val: List$map(_t9299, bindings)});
        break _t9286;
      }
      if (_t9284._tag === 5) {
        const te = _t9284._val;
        _t9285 = ({_tag: 5, _name: "TDExpr", _val: Typechecker$xform_expr(xctx, te)});
        break _t9286;
      }
      if (_t9284._tag === 1) {
        const name = _t9284._val[0];
        const te = _t9284._val[1];
        _t9285 = ({_tag: 1, _name: "TDLetMut", _val: [name, Typechecker$xform_expr(xctx, te)]});
        break _t9286;
      }
      if (true) {
        const other = _t9284;
        _t9285 = other;
        break _t9286;
      }
      _match_fail("line 15950");
    }
    return _t9285;
  }
  const xform_decl_9306 = _t9283;
  function _t9308(tdecl) {
    let _t9310;
    const _t9309 = tdecl;
    _t9311: {
      if (((_t9309._tag === 0 || _t9309._tag === 2) || _t9309._tag === 1)) {
        const name = _t9309._val[0];
        _t9310 = ({_hd: name, _tl: null});
        break _t9311;
      }
      if (_t9309._tag === 3) {
        const bindings = _t9309._val;
        _t9310 = List$map(fst, bindings);
        break _t9311;
      }
      if (true) {
        _t9310 = null;
        break _t9311;
      }
      _match_fail("line 15950");
    }
    return _t9310;
  }
  const decl_names_9312 = _t9308;
  function _t9314(xctx, tdecl) {
    let _t9316;
    const _t9315 = tdecl;
    _t9317: {
      if (_t9315._tag === 10) {
        const alias_pairs = _t9315._val;
        function _t9318(schemes, __p308) {
          let _t9320;
          const _t9319 = __p308;
          _t9321: {
            if (true) {
              const dst = _t9319[0];
              const src = _t9319[1];
              let _t9323;
              const _t9322 = List$assoc_opt(src, schemes);
              _t9324: {
                if (_t9322._tag === 1) {
                  const scheme = _t9322._val;
                  _t9323 = ({_hd: [dst, scheme], _tl: schemes});
                  break _t9324;
                }
                if (_t9322._tag === 0) {
                  _t9323 = schemes;
                  break _t9324;
                }
                _match_fail("line 15950");
              }
              _t9320 = _t9323;
              break _t9321;
            }
            _match_fail("line 15950");
          }
          return _t9320;
        }
        _t9316 = List$fold(_t9318, xctx.xf_schemes, alias_pairs);
        break _t9317;
      }
      if (true) {
        _t9316 = xctx.xf_schemes;
        break _t9317;
      }
      _match_fail("line 15950");
    }
    return _t9316;
  }
  const open_schemes_9325 = _t9314;
  function xform_decls(xctx, __x) {
    let _t9328;
    const _t9327 = __x;
    _t9329: {
      if (_t9327 === null) {
        _t9328 = null;
        break _t9329;
      }
      if (_t9327 !== null) {
        const tdecl = _t9327._hd;
        const rest = _t9327._tl;
        let _t9331;
        const _t9330 = tdecl;
        _t9332: {
          if (_t9330._tag === 9) {
            const name = _t9330._val[0];
            const decls = _t9330._val[1];
            _t9331 = ({_tag: 9, _name: "TDModule", _val: [name, xform_decls(xctx, decls)]});
            break _t9332;
          }
          if (true) {
            _t9331 = xform_decl_9306(xctx, tdecl);
            break _t9332;
          }
          _match_fail("line 15950");
        }
        const tdecl$p_9333 = _t9331;
        const names_9335 = decl_names_9312(tdecl);
        const __rec_upd_9337 = xctx;
        const _t9338 = ({xf_constrained: __rec_upd_9337.xf_constrained, xf_locals: List$concat(names_9335, xctx.xf_locals), xf_record_evidence: __rec_upd_9337.xf_record_evidence, xf_schemes: open_schemes_9325(xctx, tdecl$p_9333), xf_type_env: __rec_upd_9337.xf_type_env});
        const xctx$p_9339 = _t9338;
        const _t9340 = ({_hd: tdecl$p_9333, _tl: xform_decls(xctx$p_9339, rest)});
        const _t9336 = _t9340;
        const _t9334 = _t9336;
        _t9328 = _t9334;
        break _t9329;
      }
      _match_fail("line 15950");
    }
    return _t9328;
  }
  const _t9341 = xform_decls(xctx_9281, tprog);
  const _t9326 = _t9341;
  const _t9313 = _t9326;
  const _t9307 = _t9313;
  const _t9282 = _t9307;
  return _t9282;
}
function Typechecker$check_program(program) {
  function _t9342(__p309, decl) {
    let _t9344;
    const _t9343 = __p309;
    _t9345: {
      if (true) {
        const ctx = _t9343[0];
        const decls = _t9343[1];
        let _t9347;
        const _t9346 = Typechecker$check_decl(ctx, 0, decl);
        _t9348: {
          if (true) {
            const ctx$p = _t9346[0];
            const tdecls = _t9346[1];
            _t9347 = [ctx$p, List$rev_append(tdecls, decls)];
            break _t9348;
          }
          _match_fail("line 15950");
        }
        _t9344 = _t9347;
        break _t9345;
      }
      _match_fail("line 15950");
    }
    return _t9344;
  }
  let _t9350;
  const _t9349 = List$fold(_t9342, [Typechecker$empty_ctx, null], program);
  _t9351: {
    if (true) {
      const ctx = _t9349[0];
      const decls = _t9349[1];
      _t9350 = [List$rev(decls), ctx.type_env];
      break _t9351;
    }
    _match_fail("line 15950");
  }
  return _t9350;
}
function Typechecker$check_program_in_ctx(ctx, program) {
  function _t9352(__p310, decl) {
    let _t9354;
    const _t9353 = __p310;
    _t9355: {
      if (true) {
        const ctx = _t9353[0];
        const decls = _t9353[1];
        let _t9357;
        const _t9356 = Typechecker$check_decl(ctx, 0, decl);
        _t9358: {
          if (true) {
            const ctx$p = _t9356[0];
            const tdecls = _t9356[1];
            _t9357 = [ctx$p, List$rev_append(tdecls, decls)];
            break _t9358;
          }
          _match_fail("line 15950");
        }
        _t9354 = _t9357;
        break _t9355;
      }
      _match_fail("line 15950");
    }
    return _t9354;
  }
  let _t9360;
  const _t9359 = List$fold(_t9352, [ctx, null], program);
  _t9361: {
    if (true) {
      const ctx = _t9359[0];
      const decls = _t9359[1];
      _t9360 = [ctx, List$rev(decls)];
      break _t9361;
    }
    _match_fail("line 15950");
  }
  return _t9360;
}
function Optimize$collect_jump_targets(code) {
  const targets_9362 = Hashtbl$create(64);
  function _t9364(op) {
    let _t9366;
    const _t9365 = op;
    _t9367: {
      if (((((_t9365._tag === 37 || _t9365._tag === 38) || _t9365._tag === 39) || _t9365._tag === 68) || _t9365._tag === 71)) {
        const t = _t9365._val;
        _t9366 = _call(Hashtbl$set, [__dict_Hash_int, __dict_Eq_int, targets_9362, t, undefined]);
        break _t9367;
      }
      if (true) {
        _t9366 = undefined;
        break _t9367;
      }
      _match_fail("line 15950");
    }
    return _t9366;
  }
  Array$iter(_t9364, code);
  const _t9363 = targets_9362;
  return _t9363;
}
function Optimize$is_jump_target(__dict_Hash_0, __dict_Eq_0, targets, offset) {
  return _call(Hashtbl$has, [__dict_Hash_0, __dict_Eq_0, targets, offset]);
}
function Optimize$mark_dead_after_tail_call(code, targets, actions) {
  const len_9368 = Array$length(code);
  const i_9370 = Ref$create(0);
  let _t9372 = undefined;
  let _t9373 = false, _t9374;
  while (true) {
    if (!((Ref$get(i_9370) < len_9368))) break;
    let _t9376;
    const _t9375 = Array$get(code, Ref$get(i_9370));
    _t9377: {
      if ((_t9375._tag === 43 || _t9375._tag === 84)) {
        const j_9378 = Ref$create((Ref$get(i_9370) + 1));
        let _t9380 = undefined;
        let _t9381 = false, _t9382;
        while (true) {
          if (!(((Ref$get(j_9378) < len_9368) && (!_call(Optimize$is_jump_target, [__dict_Hash_int, __dict_Eq_int, targets, Ref$get(j_9378)]))))) break;
          Array$set(actions, Ref$get(j_9378), ({_tag: 1, _name: "Remove"}));
          Ref$set(j_9378, (Ref$get(j_9378) + 1));
          if (_t9381) break;
        }
        _t9380 = _t9381 ? _t9382 : undefined;
        _t9380;
        const _t9379 = Ref$set(i_9370, Ref$get(j_9378));
        _t9376 = _t9379;
        break _t9377;
      }
      if (true) {
        _t9376 = Ref$set(i_9370, (Ref$get(i_9370) + 1));
        break _t9377;
      }
      _match_fail("line 15950");
    }
    _t9376;
    if (_t9373) break;
  }
  _t9372 = _t9373 ? _t9374 : undefined;
  const _t9371 = _t9372;
  const _t9369 = _t9371;
  return _t9369;
}
function Optimize$mark_jump_to_next(code, actions) {
  const len_9383 = Array$length(code);
  let i_9385 = 0;
  let _t9387 = undefined;
  let _t9388 = false, _t9389;
  while (true) {
    if (!((i_9385 <= (len_9383 - 1)))) break;
    let _t9391;
    const _t9390 = Array$get(code, i_9385);
    _t9392: {
      if (_t9390._tag === 37) {
        const target = _t9390._val;
        if ((target === (i_9385 + 1))) {
          _t9391 = Array$set(actions, i_9385, ({_tag: 1, _name: "Remove"}));
          break _t9392;
        }
      }
      if (true) {
        _t9391 = undefined;
        break _t9392;
      }
      _match_fail("line 15950");
    }
    _t9391;
    (i_9385 = (i_9385 + 1), undefined);
    if (_t9388) break;
  }
  _t9387 = _t9388 ? _t9389 : undefined;
  const _t9386 = _t9387;
  const _t9384 = _t9386;
  return _t9384;
}
function Optimize$reads_slot(op, n) {
  let _t9394;
  const _t9393 = op;
  _t9395: {
    if ((((_t9393._tag === 3 || _t9393._tag === 77) || _t9393._tag === 78) || _t9393._tag === 79)) {
      const s = (((_t9393._tag === 3 || _t9393._tag === 77) || _t9393._tag === 78) ? ((_t9393._tag === 3 || _t9393._tag === 77) ? (_t9393._tag === 3 ? _t9393._val : _t9393._val[0]) : _t9393._val[0]) : _t9393._val[0]);
      _t9394 = (s === n);
      break _t9395;
    }
    if ((_t9393._tag === 40 || _t9393._tag === 41)) {
      const caps = _t9393._val[1];
      function _t9396(c) {
        return _eq(c, ({_tag: 0, _name: "CaptureLocal", _val: n}));
      }
      _t9394 = List$exists(_t9396, caps);
      break _t9395;
    }
    if (true) {
      _t9394 = false;
      break _t9395;
    }
    _match_fail("line 15950");
  }
  return _t9394;
}
function Optimize$writes_slot(op, n) {
  let _t9398;
  const _t9397 = op;
  _t9399: {
    if (_t9397._tag === 4) {
      const s = _t9397._val;
      _t9398 = (s === n);
      break _t9399;
    }
    if (true) {
      _t9398 = false;
      break _t9399;
    }
    _match_fail("line 15950");
  }
  return _t9398;
}
function Optimize$is_slot_dead(code, actions, targets, n, start) {
  const len_9400 = Array$length(code);
  const i_9402 = Ref$create(start);
  const result_9404 = Ref$create(true);
  const done__9406 = Ref$create(false);
  let _t9408 = undefined;
  let _t9409 = false, _t9410;
  while (true) {
    if (!(((Ref$get(i_9402) < len_9400) && (!Ref$get(done__9406))))) break;
    let _t9411;
    if (_eq(Array$get(actions, Ref$get(i_9402)), ({_tag: 1, _name: "Remove"}))) {
      _t9411 = Ref$set(i_9402, (Ref$get(i_9402) + 1));
    } else {
      let _t9412;
      if (_call(Optimize$is_jump_target, [__dict_Hash_int, __dict_Eq_int, targets, Ref$get(i_9402)])) {
        Ref$set(result_9404, false);
        _t9412 = Ref$set(done__9406, true);
      } else {
        const op_9413 = Array$get(code, Ref$get(i_9402));
        let _t9415;
        if (Optimize$reads_slot(op_9413, n)) {
          Ref$set(result_9404, false);
          _t9415 = Ref$set(done__9406, true);
        } else {
          let _t9416;
          if (Optimize$writes_slot(op_9413, n)) {
            _t9416 = Ref$set(done__9406, true);
          } else {
            let _t9418;
            const _t9417 = op_9413;
            _t9419: {
              if ((((((_t9417._tag === 44 || _t9417._tag === 45) || _t9417._tag === 43) || _t9417._tag === 84) || _t9417._tag === 64) || _t9417._tag === 76)) {
                _t9418 = Ref$set(done__9406, true);
                break _t9419;
              }
              if ((((((((_t9417._tag === 37 || _t9417._tag === 38) || _t9417._tag === 39) || _t9417._tag === 70) || _t9417._tag === 71) || _t9417._tag === 72) || _t9417._tag === 68) || _t9417._tag === 82)) {
                Ref$set(result_9404, false);
                _t9418 = Ref$set(done__9406, true);
                break _t9419;
              }
              if (true) {
                _t9418 = Ref$set(i_9402, (Ref$get(i_9402) + 1));
                break _t9419;
              }
              _match_fail("line 15950");
            }
            _t9416 = _t9418;
          }
          _t9415 = _t9416;
        }
        const _t9414 = _t9415;
        _t9412 = _t9414;
      }
      _t9411 = _t9412;
    }
    _t9411;
    if (_t9409) break;
  }
  _t9408 = _t9409 ? _t9410 : undefined;
  _t9408;
  const _t9407 = Ref$get(result_9404);
  const _t9405 = _t9407;
  const _t9403 = _t9405;
  const _t9401 = _t9403;
  return _t9401;
}
function Optimize$mark_set_get_pairs(code, targets, actions) {
  const len_9420 = Array$length(code);
  const i_9422 = Ref$create(0);
  let _t9424 = undefined;
  let _t9425 = false, _t9426;
  while (true) {
    if (!((Ref$get(i_9422) < (len_9420 - 1)))) break;
    let _t9427;
    if ((_eq(Array$get(actions, Ref$get(i_9422)), ({_tag: 0, _name: "Keep"})) && (_eq(Array$get(actions, (Ref$get(i_9422) + 1)), ({_tag: 0, _name: "Keep"})) && (!_call(Optimize$is_jump_target, [__dict_Hash_int, __dict_Eq_int, targets, (Ref$get(i_9422) + 1)]))))) {
      let _t9429;
      const _t9428 = [Array$get(code, Ref$get(i_9422)), Array$get(code, (Ref$get(i_9422) + 1))];
      _t9430: {
        if (_t9428[0]._tag === 4 && _t9428[1]._tag === 3) {
          const n = _t9428[0]._val;
          const m = _t9428[1]._val;
          if ((n === m)) {
            let _t9431;
            if (Optimize$is_slot_dead(code, actions, targets, n, (Ref$get(i_9422) + 2))) {
              Array$set(actions, Ref$get(i_9422), ({_tag: 1, _name: "Remove"}));
              Array$set(actions, (Ref$get(i_9422) + 1), ({_tag: 1, _name: "Remove"}));
              _t9431 = Ref$set(i_9422, (Ref$get(i_9422) + 2));
            } else {
              Array$set(actions, Ref$get(i_9422), ({_tag: 2, _name: "ReplaceWith", _val: ({_hd: ({_tag: 2, _name: "DUP"}), _tl: ({_hd: ({_tag: 4, _name: "SET_LOCAL", _val: n}), _tl: null})})}));
              Array$set(actions, (Ref$get(i_9422) + 1), ({_tag: 1, _name: "Remove"}));
              _t9431 = Ref$set(i_9422, (Ref$get(i_9422) + 2));
            }
            _t9429 = _t9431;
            break _t9430;
          }
        }
        if (true) {
          _t9429 = Ref$set(i_9422, (Ref$get(i_9422) + 1));
          break _t9430;
        }
        _match_fail("line 15950");
      }
      _t9427 = _t9429;
    } else {
      _t9427 = Ref$set(i_9422, (Ref$get(i_9422) + 1));
    }
    _t9427;
    if (_t9425) break;
  }
  _t9424 = _t9425 ? _t9426 : undefined;
  const _t9423 = _t9424;
  const _t9421 = _t9423;
  return _t9421;
}
function Optimize$mark_dead_stores(code, targets, actions) {
  const len_9432 = Array$length(code);
  const i_9434 = Ref$create(0);
  let _t9436 = undefined;
  let _t9437 = false, _t9438;
  while (true) {
    if (!((Ref$get(i_9434) < len_9432))) break;
    const handled_9439 = Ref$create(false);
    let _t9441;
    if ((((Ref$get(i_9434) + 1) < len_9432) && (_eq(Array$get(actions, Ref$get(i_9434)), ({_tag: 0, _name: "Keep"})) && (_eq(Array$get(actions, (Ref$get(i_9434) + 1)), ({_tag: 0, _name: "Keep"})) && (!_call(Optimize$is_jump_target, [__dict_Hash_int, __dict_Eq_int, targets, (Ref$get(i_9434) + 1)])))))) {
      let _t9443;
      const _t9442 = [Array$get(code, Ref$get(i_9434)), Array$get(code, (Ref$get(i_9434) + 1))];
      _t9444: {
        if (_t9442[0]._tag === 2 && _t9442[1]._tag === 4) {
          const n = _t9442[1]._val;
          if (Optimize$is_slot_dead(code, actions, targets, n, (Ref$get(i_9434) + 2))) {
            Array$set(actions, Ref$get(i_9434), ({_tag: 1, _name: "Remove"}));
            Array$set(actions, (Ref$get(i_9434) + 1), ({_tag: 1, _name: "Remove"}));
            Ref$set(i_9434, (Ref$get(i_9434) + 2));
            _t9443 = Ref$set(handled_9439, true);
            break _t9444;
          }
        }
        if (true) {
          _t9443 = undefined;
          break _t9444;
        }
        _match_fail("line 15950");
      }
      _t9441 = _t9443;
    } else {
      _t9441 = undefined;
    }
    _t9441;
    let _t9445;
    if ((!Ref$get(handled_9439))) {
      let _t9447;
      const _t9446 = Array$get(code, Ref$get(i_9434));
      _t9448: {
        if (_t9446._tag === 4) {
          const n = _t9446._val;
          if ((_eq(Array$get(actions, Ref$get(i_9434)), ({_tag: 0, _name: "Keep"})) && Optimize$is_slot_dead(code, actions, targets, n, (Ref$get(i_9434) + 1)))) {
            Array$set(actions, Ref$get(i_9434), ({_tag: 2, _name: "ReplaceWith", _val: ({_hd: ({_tag: 1, _name: "POP"}), _tl: null})}));
            _t9447 = Ref$set(i_9434, (Ref$get(i_9434) + 1));
            break _t9448;
          }
        }
        if (true) {
          _t9447 = Ref$set(i_9434, (Ref$get(i_9434) + 1));
          break _t9448;
        }
        _match_fail("line 15950");
      }
      _t9445 = _t9447;
    } else {
      _t9445 = undefined;
    }
    const _t9440 = _t9445;
    _t9440;
    if (_t9437) break;
  }
  _t9436 = _t9437 ? _t9438 : undefined;
  const _t9435 = _t9436;
  const _t9433 = _t9435;
  return _t9433;
}
function Optimize$mark_superinstructions(code, targets, actions) {
  const len_9449 = Array$length(code);
  const i_9451 = Ref$create(0);
  let _t9453 = undefined;
  let _t9454 = false, _t9455;
  while (true) {
    if (!((Ref$get(i_9451) < len_9449))) break;
    let _t9456;
    if ((((Ref$get(i_9451) + 1) < len_9449) && (_eq(Array$get(actions, Ref$get(i_9451)), ({_tag: 0, _name: "Keep"})) && (_eq(Array$get(actions, (Ref$get(i_9451) + 1)), ({_tag: 0, _name: "Keep"})) && (!_call(Optimize$is_jump_target, [__dict_Hash_int, __dict_Eq_int, targets, (Ref$get(i_9451) + 1)])))))) {
      let _t9458;
      const _t9457 = [Array$get(code, Ref$get(i_9451)), Array$get(code, (Ref$get(i_9451) + 1))];
      _t9459: {
        if (_t9457[0]._tag === 3 && _t9457[1]._tag === 42) {
          const slot = _t9457[0]._val;
          const arity = _t9457[1]._val;
          Array$set(actions, Ref$get(i_9451), ({_tag: 2, _name: "ReplaceWith", _val: ({_hd: ({_tag: 77, _name: "GET_LOCAL_CALL", _val: [slot, arity]}), _tl: null})}));
          Array$set(actions, (Ref$get(i_9451) + 1), ({_tag: 1, _name: "Remove"}));
          _t9458 = Ref$set(i_9451, (Ref$get(i_9451) + 2));
          break _t9459;
        }
        if (_t9457[0]._tag === 3 && _t9457[1]._tag === 49) {
          const slot = _t9457[0]._val;
          const idx = _t9457[1]._val;
          Array$set(actions, Ref$get(i_9451), ({_tag: 2, _name: "ReplaceWith", _val: ({_hd: ({_tag: 78, _name: "GET_LOCAL_TUPLE_GET", _val: [slot, idx]}), _tl: null})}));
          Array$set(actions, (Ref$get(i_9451) + 1), ({_tag: 1, _name: "Remove"}));
          _t9458 = Ref$set(i_9451, (Ref$get(i_9451) + 2));
          break _t9459;
        }
        if (_t9457[0]._tag === 3 && _t9457[1]._tag === 51) {
          const slot = _t9457[0]._val;
          const name = _t9457[1]._val;
          Array$set(actions, Ref$get(i_9451), ({_tag: 2, _name: "ReplaceWith", _val: ({_hd: ({_tag: 79, _name: "GET_LOCAL_FIELD", _val: [slot, name]}), _tl: null})}));
          Array$set(actions, (Ref$get(i_9451) + 1), ({_tag: 1, _name: "Remove"}));
          _t9458 = Ref$set(i_9451, (Ref$get(i_9451) + 2));
          break _t9459;
        }
        if (_t9457[0]._tag === 10 && _t9457[1]._tag === 42) {
          const idx = _t9457[0]._val;
          const arity = _t9457[1]._val;
          Array$set(actions, Ref$get(i_9451), ({_tag: 2, _name: "ReplaceWith", _val: ({_hd: ({_tag: 80, _name: "GET_GLOBAL_CALL", _val: [idx, arity]}), _tl: null})}));
          Array$set(actions, (Ref$get(i_9451) + 1), ({_tag: 1, _name: "Remove"}));
          _t9458 = Ref$set(i_9451, (Ref$get(i_9451) + 2));
          break _t9459;
        }
        if (_t9457[0]._tag === 10 && _t9457[1]._tag === 51) {
          const idx = _t9457[0]._val;
          const name = _t9457[1]._val;
          Array$set(actions, Ref$get(i_9451), ({_tag: 2, _name: "ReplaceWith", _val: ({_hd: ({_tag: 81, _name: "GET_GLOBAL_FIELD", _val: [idx, name]}), _tl: null})}));
          Array$set(actions, (Ref$get(i_9451) + 1), ({_tag: 1, _name: "Remove"}));
          _t9458 = Ref$set(i_9451, (Ref$get(i_9451) + 2));
          break _t9459;
        }
        if (true) {
          _t9458 = Ref$set(i_9451, (Ref$get(i_9451) + 1));
          break _t9459;
        }
        _match_fail("line 15950");
      }
      _t9456 = _t9458;
    } else {
      _t9456 = Ref$set(i_9451, (Ref$get(i_9451) + 1));
    }
    _t9456;
    if (_t9454) break;
  }
  _t9453 = _t9454 ? _t9455 : undefined;
  const _t9452 = _t9453;
  const _t9450 = _t9452;
  return _t9450;
}
function Optimize$detect_tag_chain(code, _targets, start_pos, scrut_slot) {
  const len_9460 = Array$length(code);
  const arms_9462 = Ref$create(null);
  const pos_9464 = Ref$create(start_pos);
  const continue__9466 = Ref$create(true);
  const default_target_9468 = Ref$create(0);
  const chain_positions_9470 = Hashtbl$create(16);
  let _t9472 = undefined;
  let _t9473 = false, _t9474;
  while (true) {
    if (!(Ref$get(continue__9466))) break;
    let _t9486;
    if (((Ref$get(pos_9464) + 2) < len_9460)) {
    let _t9476;
    const _t9475 = Array$get(code, Ref$get(pos_9464));
    _t9477: {
      if (_t9475._tag === 3) {
        const s = _t9475._val;
        if ((s === scrut_slot)) {
          _t9476 = true;
          break _t9477;
        }
      }
      if (true) {
        _t9476 = false;
        break _t9477;
      }
      _match_fail("line 15950");
    }
    let _t9485;
    if (_t9476) {
    let _t9479;
    const _t9478 = Array$get(code, (Ref$get(pos_9464) + 1));
    _t9480: {
      if (_t9478._tag === 58) {
        _t9479 = true;
        break _t9480;
      }
      if (true) {
        _t9479 = false;
        break _t9480;
      }
      _match_fail("line 15950");
    }
    let _t9484;
    if (_t9479) {
    let _t9482;
    const _t9481 = Array$get(code, (Ref$get(pos_9464) + 2));
    _t9483: {
      if (_t9481._tag === 38) {
        const t = _t9481._val;
        _t9482 = (t > Ref$get(pos_9464));
        break _t9483;
      }
      if (true) {
        _t9482 = false;
        break _t9483;
      }
      _match_fail("line 15950");
    }
      _t9484 = _t9482;
    } else {
      _t9484 = false;
    }
      _t9485 = _t9484;
    } else {
      _t9485 = false;
    }
      _t9486 = _t9485;
    } else {
      _t9486 = false;
    }
    let _t9487;
    if (_t9486) {
      let _t9489;
      const _t9488 = Array$get(code, (Ref$get(pos_9464) + 1));
      _t9490: {
        if (_t9488._tag === 58) {
          const t = _t9488._val;
          _t9489 = t;
          break _t9490;
        }
        if (true) {
          _t9489 = failwith("assert false");
          break _t9490;
        }
        _match_fail("line 15950");
      }
      const tag_9491 = _t9489;
      let _t9494;
      const _t9493 = Array$get(code, (Ref$get(pos_9464) + 2));
      _t9495: {
        if (_t9493._tag === 38) {
          const t = _t9493._val;
          _t9494 = t;
          break _t9495;
        }
        if (true) {
          _t9494 = failwith("assert false");
          break _t9495;
        }
        _match_fail("line 15950");
      }
      const next_9496 = _t9494;
      const arm_body_9498 = (Ref$get(pos_9464) + 3);
      Ref$set(arms_9462, ({_hd: [tag_9491, arm_body_9498], _tl: Ref$get(arms_9462)}));
      _call(Hashtbl$set, [__dict_Hash_int, __dict_Eq_int, chain_positions_9470, Ref$get(pos_9464), undefined]);
      _call(Hashtbl$set, [__dict_Hash_int, __dict_Eq_int, chain_positions_9470, (Ref$get(pos_9464) + 1), undefined]);
      _call(Hashtbl$set, [__dict_Hash_int, __dict_Eq_int, chain_positions_9470, (Ref$get(pos_9464) + 2), undefined]);
      const _t9499 = Ref$set(pos_9464, next_9496);
      const _t9497 = _t9499;
      const _t9492 = _t9497;
      _t9487 = _t9492;
    } else {
      Ref$set(default_target_9468, Ref$get(pos_9464));
      _t9487 = Ref$set(continue__9466, false);
    }
    _t9487;
    if (_t9473) break;
  }
  _t9472 = _t9473 ? _t9474 : undefined;
  _t9472;
  const arms_9500 = List$rev(Ref$get(arms_9462));
  const valid_9502 = (List$length(arms_9500) >= 2);
  let _t9515;
  if (valid_9502) {
  const ok_9504 = Ref$create(true);
  function _t9506(i, op) {
    let _t9507;
    if ((Ref$get(ok_9504) && (!_call(Hashtbl$has, [__dict_Hash_int, __dict_Eq_int, chain_positions_9470, i])))) {
      function _t9508(t) {
        let _t9509;
        if (_call(Hashtbl$has, [__dict_Hash_int, __dict_Eq_int, chain_positions_9470, t])) {
          _t9509 = Ref$set(ok_9504, false);
        } else {
          _t9509 = undefined;
        }
        return _t9509;
      }
      const check_target_9510 = _t9508;
      let _t9513;
      const _t9512 = op;
      _t9514: {
        if (((((_t9512._tag === 37 || _t9512._tag === 38) || _t9512._tag === 39) || _t9512._tag === 68) || _t9512._tag === 71)) {
          const t = _t9512._val;
          _t9513 = check_target_9510(t);
          break _t9514;
        }
        if (true) {
          _t9513 = undefined;
          break _t9514;
        }
        _match_fail("line 15950");
      }
      const _t9511 = _t9513;
      _t9507 = _t9511;
    } else {
      _t9507 = undefined;
    }
    return _t9507;
  }
  Array$iteri(_t9506, code);
  const _t9505 = Ref$get(ok_9504);
    _t9515 = _t9505;
  } else {
    _t9515 = false;
  }
  const valid_9516 = _t9515;
  let _t9518;
  if ((valid_9516 && !_eq(arms_9500, null))) {
    const tags_9519 = List$map(fst, arms_9500);
    const unique_tags_9521 = List$sort_uniq(compare, tags_9519);
    let _t9523;
    if ((List$length(unique_tags_9521) !== List$length(tags_9519))) {
      _t9523 = ({_tag: 0, _name: "None"});
    } else {
      const min_tag_9524 = List$fold(min, List$hd(tags_9519), tags_9519);
      const max_tag_9526 = List$fold(max, List$hd(tags_9519), tags_9519);
      const range_9528 = ((max_tag_9526 - min_tag_9524) + 1);
      let _t9530;
      if ((range_9528 <= (2 * List$length(arms_9500)))) {
        _t9530 = ({_tag: 1, _name: "Some", _val: [arms_9500, min_tag_9524, max_tag_9526, Ref$get(default_target_9468)]});
      } else {
        _t9530 = ({_tag: 0, _name: "None"});
      }
      const _t9529 = _t9530;
      const _t9527 = _t9529;
      const _t9525 = _t9527;
      _t9523 = _t9525;
    }
    const _t9522 = _t9523;
    const _t9520 = _t9522;
    _t9518 = _t9520;
  } else {
    _t9518 = ({_tag: 0, _name: "None"});
  }
  const _t9517 = _t9518;
  const _t9503 = _t9517;
  const _t9501 = _t9503;
  const _t9471 = _t9501;
  const _t9469 = _t9471;
  const _t9467 = _t9469;
  const _t9465 = _t9467;
  const _t9463 = _t9465;
  const _t9461 = _t9463;
  return _t9461;
}
function Optimize$mark_jump_tables(code, targets, actions) {
  const len_9531 = Array$length(code);
  const i_9533 = Ref$create(0);
  let _t9535 = undefined;
  let _t9536 = false, _t9537;
  while (true) {
    if (!((Ref$get(i_9533) < len_9531))) break;
    let _t9538;
    if ((((Ref$get(i_9533) + 2) < len_9531) && _eq(Array$get(actions, Ref$get(i_9533)), ({_tag: 0, _name: "Keep"})))) {
      let _t9540;
      const _t9539 = [Array$get(code, Ref$get(i_9533)), Array$get(code, (Ref$get(i_9533) + 1)), Array$get(code, (Ref$get(i_9533) + 2))];
      _t9541: {
        if (_t9539[0]._tag === 3 && _t9539[1]._tag === 58 && _t9539[2]._tag === 38) {
          const scrut_slot = _t9539[0]._val;
          let _t9543;
          const _t9542 = Optimize$detect_tag_chain(code, targets, Ref$get(i_9533), scrut_slot);
          _t9544: {
            if (_t9542._tag === 1) {
              const arms = _t9542._val[0];
              const min_tag = _t9542._val[1];
              const max_tag = _t9542._val[2];
              const default_target = _t9542._val[3];
              const range_9545 = ((max_tag - min_tag) + 1);
              const table_9547 = Array$make(range_9545, default_target);
              function _t9549(__p311) {
                let _t9551;
                const _t9550 = __p311;
                _t9552: {
                  if (true) {
                    const tag = _t9550[0];
                    const arm_body = _t9550[1];
                    _t9551 = Array$set(table_9547, (tag - min_tag), arm_body);
                    break _t9552;
                  }
                  _match_fail("line 15950");
                }
                return _t9551;
              }
              List$iter(_t9549, arms);
              Array$set(actions, (Ref$get(i_9533) + 1), ({_tag: 2, _name: "ReplaceWith", _val: ({_hd: ({_tag: 82, _name: "JUMP_TABLE", _val: [min_tag, table_9547, default_target]}), _tl: null})}));
              Array$set(actions, (Ref$get(i_9533) + 2), ({_tag: 1, _name: "Remove"}));
              const remaining_9553 = List$tl(arms);
              function _t9555(__p312) {
                let _t9557;
                const _t9556 = __p312;
                _t9558: {
                  if (true) {
                    const arm_body = _t9556[1];
                    const chain_start_9559 = (arm_body - 3);
                    let _t9561;
                    if (((chain_start_9559 >= 0) && (chain_start_9559 < len_9531))) {
                      let _t9562;
                      if (_eq(Array$get(actions, chain_start_9559), ({_tag: 0, _name: "Keep"}))) {
                        _t9562 = Array$set(actions, chain_start_9559, ({_tag: 1, _name: "Remove"}));
                      } else {
                        _t9562 = undefined;
                      }
                      _t9562;
                      let _t9563;
                      if ((((chain_start_9559 + 1) < len_9531) && _eq(Array$get(actions, (chain_start_9559 + 1)), ({_tag: 0, _name: "Keep"})))) {
                        _t9563 = Array$set(actions, (chain_start_9559 + 1), ({_tag: 1, _name: "Remove"}));
                      } else {
                        _t9563 = undefined;
                      }
                      _t9563;
                      let _t9564;
                      if ((((chain_start_9559 + 2) < len_9531) && _eq(Array$get(actions, (chain_start_9559 + 2)), ({_tag: 0, _name: "Keep"})))) {
                        _t9564 = Array$set(actions, (chain_start_9559 + 2), ({_tag: 1, _name: "Remove"}));
                      } else {
                        _t9564 = undefined;
                      }
                      _t9561 = _t9564;
                    } else {
                      _t9561 = undefined;
                    }
                    const _t9560 = _t9561;
                    _t9557 = _t9560;
                    break _t9558;
                  }
                  _match_fail("line 15950");
                }
                return _t9557;
              }
              List$iter(_t9555, remaining_9553);
              const last_arm_9565 = List$nth(arms, (List$length(arms) - 1));
              const _t9566 = Ref$set(i_9533, snd(last_arm_9565));
              const _t9554 = _t9566;
              const _t9548 = _t9554;
              const _t9546 = _t9548;
              _t9543 = _t9546;
              break _t9544;
            }
            if (_t9542._tag === 0) {
              _t9543 = Ref$set(i_9533, (Ref$get(i_9533) + 1));
              break _t9544;
            }
            _match_fail("line 15950");
          }
          _t9540 = _t9543;
          break _t9541;
        }
        if (true) {
          _t9540 = Ref$set(i_9533, (Ref$get(i_9533) + 1));
          break _t9541;
        }
        _match_fail("line 15950");
      }
      _t9538 = _t9540;
    } else {
      _t9538 = Ref$set(i_9533, (Ref$get(i_9533) + 1));
    }
    _t9538;
    if (_t9536) break;
  }
  _t9535 = _t9536 ? _t9537 : undefined;
  const _t9534 = _t9535;
  const _t9532 = _t9534;
  return _t9532;
}
function Optimize$mark_push_pop(code, targets, actions) {
  const len_9567 = Array$length(code);
  const i_9569 = Ref$create(0);
  let _t9571 = undefined;
  let _t9572 = false, _t9573;
  while (true) {
    if (!((Ref$get(i_9569) < (len_9567 - 1)))) break;
    let _t9574;
    if ((_eq(Array$get(actions, Ref$get(i_9569)), ({_tag: 0, _name: "Keep"})) && (_eq(Array$get(actions, (Ref$get(i_9569) + 1)), ({_tag: 0, _name: "Keep"})) && (!_call(Optimize$is_jump_target, [__dict_Hash_int, __dict_Eq_int, targets, (Ref$get(i_9569) + 1)]))))) {
      let _t9576;
      const _t9575 = Array$get(code, Ref$get(i_9569));
      _t9577: {
        if ((((((_t9575._tag === 0 || _t9575._tag === 3) || _t9575._tag === 10) || _t9575._tag === 5) || _t9575._tag === 57) || _t9575._tag === 2)) {
          _t9576 = true;
          break _t9577;
        }
        if (true) {
          _t9576 = false;
          break _t9577;
        }
        _match_fail("line 15950");
      }
      const is_pure_push_9578 = _t9576;
      let _t9581;
      const _t9580 = Array$get(code, (Ref$get(i_9569) + 1));
      _t9582: {
        if (_t9580._tag === 1) {
          if (is_pure_push_9578) {
            Array$set(actions, Ref$get(i_9569), ({_tag: 1, _name: "Remove"}));
            Array$set(actions, (Ref$get(i_9569) + 1), ({_tag: 1, _name: "Remove"}));
            _t9581 = Ref$set(i_9569, (Ref$get(i_9569) + 2));
            break _t9582;
          }
        }
        if (true) {
          _t9581 = Ref$set(i_9569, (Ref$get(i_9569) + 1));
          break _t9582;
        }
        _match_fail("line 15950");
      }
      const _t9579 = _t9581;
      _t9574 = _t9579;
    } else {
      _t9574 = Ref$set(i_9569, (Ref$get(i_9569) + 1));
    }
    _t9574;
    if (_t9572) break;
  }
  _t9571 = _t9572 ? _t9573 : undefined;
  const _t9570 = _t9571;
  const _t9568 = _t9570;
  return _t9568;
}
function Optimize$rewrite(code, line_table, actions) {
  const len_9583 = Array$length(code);
  const new_code_9585 = Ref$create(null);
  const new_lines_9587 = Ref$create(null);
  const offset_map_9589 = Array$make((len_9583 + 1), 0);
  const new_offset_9591 = Ref$create(0);
  let i_9593 = 0;
  let _t9595 = undefined;
  let _t9596 = false, _t9597;
  while (true) {
    if (!((i_9593 <= (len_9583 - 1)))) break;
    Array$set(offset_map_9589, i_9593, Ref$get(new_offset_9591));
    let _t9598;
    if ((i_9593 < Array$length(line_table))) {
      _t9598 = Array$get(line_table, i_9593);
    } else {
      _t9598 = 0;
    }
    const line_9599 = _t9598;
    let _t9602;
    const _t9601 = Array$get(actions, i_9593);
    _t9603: {
      if (_t9601._tag === 0) {
        Ref$set(new_code_9585, ({_hd: Array$get(code, i_9593), _tl: Ref$get(new_code_9585)}));
        Ref$set(new_lines_9587, ({_hd: line_9599, _tl: Ref$get(new_lines_9587)}));
        _t9602 = Ref$set(new_offset_9591, (Ref$get(new_offset_9591) + 1));
        break _t9603;
      }
      if (_t9601._tag === 1) {
        _t9602 = undefined;
        break _t9603;
      }
      if (_t9601._tag === 2) {
        const ops = _t9601._val;
        function _t9604(op) {
          Ref$set(new_code_9585, ({_hd: op, _tl: Ref$get(new_code_9585)}));
          Ref$set(new_lines_9587, ({_hd: line_9599, _tl: Ref$get(new_lines_9587)}));
          return Ref$set(new_offset_9591, (Ref$get(new_offset_9591) + 1));
        }
        _t9602 = List$iter(_t9604, ops);
        break _t9603;
      }
      _match_fail("line 15950");
    }
    const _t9600 = _t9602;
    _t9600;
    (i_9593 = (i_9593 + 1), undefined);
    if (_t9596) break;
  }
  _t9595 = _t9596 ? _t9597 : undefined;
  _t9595;
  Array$set(offset_map_9589, len_9583, Ref$get(new_offset_9591));
  const new_code_9605 = Array$of_list(List$rev(Ref$get(new_code_9585)));
  const new_lines_9607 = Array$of_list(List$rev(Ref$get(new_lines_9587)));
  const _t9608 = [new_code_9605, new_lines_9607, offset_map_9589];
  const _t9606 = _t9608;
  const _t9594 = _t9606;
  const _t9592 = _t9594;
  const _t9590 = _t9592;
  const _t9588 = _t9590;
  const _t9586 = _t9588;
  const _t9584 = _t9586;
  return _t9584;
}
function Optimize$fixup_jumps(code, offset_map) {
  const map_len_9609 = Array$length(offset_map);
  function _t9611(t) {
    let _t9612;
    if (((t >= 0) && (t < map_len_9609))) {
      _t9612 = Array$get(offset_map, t);
    } else {
      _t9612 = t;
    }
    return _t9612;
  }
  const remap_9613 = _t9611;
  function _t9615(i, op) {
    let _t9617;
    const _t9616 = op;
    _t9618: {
      if (_t9616._tag === 37) {
        const t = _t9616._val;
        _t9617 = ({_tag: 37, _name: "JUMP", _val: remap_9613(t)});
        break _t9618;
      }
      if (_t9616._tag === 38) {
        const t = _t9616._val;
        _t9617 = ({_tag: 38, _name: "JUMP_IF_FALSE", _val: remap_9613(t)});
        break _t9618;
      }
      if (_t9616._tag === 39) {
        const t = _t9616._val;
        _t9617 = ({_tag: 39, _name: "JUMP_IF_TRUE", _val: remap_9613(t)});
        break _t9618;
      }
      if (_t9616._tag === 68) {
        const t = _t9616._val;
        _t9617 = ({_tag: 68, _name: "ENTER_LOOP", _val: remap_9613(t)});
        break _t9618;
      }
      if (_t9616._tag === 71) {
        const t = _t9616._val;
        _t9617 = ({_tag: 71, _name: "LOOP_CONTINUE", _val: remap_9613(t)});
        break _t9618;
      }
      if (_t9616._tag === 82) {
        const min_tag = _t9616._val[0];
        const targets = _t9616._val[1];
        const _mml$default = _t9616._val[2];
        function _t9619(t) {
          return remap_9613(t);
        }
        const new_targets_9620 = Array$map(_t9619, targets);
        const new_default_9622 = remap_9613(_mml$default);
        const _t9623 = ({_tag: 82, _name: "JUMP_TABLE", _val: [min_tag, new_targets_9620, new_default_9622]});
        const _t9621 = _t9623;
        _t9617 = _t9621;
        break _t9618;
      }
      if (true) {
        const other = _t9616;
        _t9617 = other;
        break _t9618;
      }
      _match_fail("line 15950");
    }
    const remapped_9624 = _t9617;
    const _t9625 = Array$set(code, i, remapped_9624);
    return _t9625;
  }
  const _t9614 = Array$iteri(_t9615, code);
  const _t9610 = _t9614;
  return _t9610;
}
function Optimize$thread_jumps(code) {
  const len_9626 = Array$length(code);
  let _t9628;
  if ((len_9626 === 0)) {
    _t9628 = undefined;
  } else {
    function _t9629(target) {
      const visited_9630 = Hashtbl$create(8);
      const t_9632 = Ref$create(target);
      const continue__9634 = Ref$create(true);
      let _t9636 = undefined;
      let _t9637 = false, _t9638;
      while (true) {
        if (!(Ref$get(continue__9634))) break;
        let _t9639;
        if (((Ref$get(t_9632) < 0) || ((Ref$get(t_9632) >= len_9626) || _call(Hashtbl$has, [__dict_Hash_int, __dict_Eq_int, visited_9630, Ref$get(t_9632)])))) {
          _t9639 = Ref$set(continue__9634, false);
        } else {
          let _t9641;
          const _t9640 = Array$get(code, Ref$get(t_9632));
          _t9642: {
            if (_t9640._tag === 37) {
              const next = _t9640._val;
              _call(Hashtbl$set, [__dict_Hash_int, __dict_Eq_int, visited_9630, Ref$get(t_9632), undefined]);
              _t9641 = Ref$set(t_9632, next);
              break _t9642;
            }
            if (true) {
              _t9641 = Ref$set(continue__9634, false);
              break _t9642;
            }
            _match_fail("line 15950");
          }
          _t9639 = _t9641;
        }
        _t9639;
        if (_t9637) break;
      }
      _t9636 = _t9637 ? _t9638 : undefined;
      _t9636;
      const _t9635 = Ref$get(t_9632);
      const _t9633 = _t9635;
      const _t9631 = _t9633;
      return _t9631;
    }
    const resolve_target_9643 = _t9629;
    const control_depth_9645 = Array$make(len_9626, 0);
    const depth_9647 = Ref$create(0);
    let i_9649 = 0;
    let _t9651 = undefined;
    let _t9652 = false, _t9653;
    while (true) {
      if (!((i_9649 <= (len_9626 - 1)))) break;
      Array$set(control_depth_9645, i_9649, Ref$get(depth_9647));
      let _t9655;
      const _t9654 = Array$get(code, i_9649);
      _t9656: {
        if (_t9654._tag === 68) {
          _t9655 = Ref$set(depth_9647, (Ref$get(depth_9647) + 1));
          break _t9656;
        }
        if (_t9654._tag === 69) {
          let _t9657;
          if ((Ref$get(depth_9647) > 0)) {
            _t9657 = Ref$set(depth_9647, (Ref$get(depth_9647) - 1));
          } else {
            _t9657 = undefined;
          }
          _t9655 = _t9657;
          break _t9656;
        }
        if (true) {
          _t9655 = undefined;
          break _t9656;
        }
        _match_fail("line 15950");
      }
      _t9655;
      (i_9649 = (i_9649 + 1), undefined);
      if (_t9652) break;
    }
    _t9651 = _t9652 ? _t9653 : undefined;
    _t9651;
    let i_9658 = 0;
    let _t9660 = undefined;
    let _t9661 = false, _t9662;
    while (true) {
      if (!((i_9658 <= (len_9626 - 1)))) break;
      let _t9664;
      const _t9663 = Array$get(code, i_9658);
      _t9665: {
        if (_t9663._tag === 37) {
          const target = _t9663._val;
          const final_target_9666 = resolve_target_9643(target);
          let _t9668;
          if (((final_target_9666 >= 0) && ((final_target_9666 < len_9626) && (Array$get(control_depth_9645, i_9658) === 0)))) {
            let _t9670;
            const _t9669 = Array$get(code, final_target_9666);
            _t9671: {
              if (_t9669._tag === 44) {
                _t9670 = Array$set(code, i_9658, ({_tag: 44, _name: "RETURN"}));
                break _t9671;
              }
              if (true) {
                let _t9672;
                if ((final_target_9666 !== target)) {
                  _t9672 = Array$set(code, i_9658, ({_tag: 37, _name: "JUMP", _val: final_target_9666}));
                } else {
                  _t9672 = undefined;
                }
                _t9670 = _t9672;
                break _t9671;
              }
              _match_fail("line 15950");
            }
            _t9668 = _t9670;
          } else {
            let _t9673;
            if ((final_target_9666 !== target)) {
              _t9673 = Array$set(code, i_9658, ({_tag: 37, _name: "JUMP", _val: final_target_9666}));
            } else {
              _t9673 = undefined;
            }
            _t9668 = _t9673;
          }
          const _t9667 = _t9668;
          _t9664 = _t9667;
          break _t9665;
        }
        if (_t9663._tag === 38) {
          const target = _t9663._val;
          const final_target_9674 = resolve_target_9643(target);
          let _t9676;
          if ((final_target_9674 !== target)) {
            _t9676 = Array$set(code, i_9658, ({_tag: 38, _name: "JUMP_IF_FALSE", _val: final_target_9674}));
          } else {
            _t9676 = undefined;
          }
          const _t9675 = _t9676;
          _t9664 = _t9675;
          break _t9665;
        }
        if (_t9663._tag === 39) {
          const target = _t9663._val;
          const final_target_9677 = resolve_target_9643(target);
          let _t9679;
          if ((final_target_9677 !== target)) {
            _t9679 = Array$set(code, i_9658, ({_tag: 39, _name: "JUMP_IF_TRUE", _val: final_target_9677}));
          } else {
            _t9679 = undefined;
          }
          const _t9678 = _t9679;
          _t9664 = _t9678;
          break _t9665;
        }
        if (_t9663._tag === 82) {
          const min_tag = _t9663._val[0];
          const targets = _t9663._val[1];
          const default_target = _t9663._val[2];
          const changed_9680 = Ref$create(false);
          function _t9682(t) {
            const final_t_9683 = resolve_target_9643(t);
            let _t9685;
            if ((final_t_9683 !== t)) {
              _t9685 = Ref$set(changed_9680, true);
            } else {
              _t9685 = undefined;
            }
            _t9685;
            const _t9684 = final_t_9683;
            return _t9684;
          }
          const new_targets_9686 = Array$map(_t9682, targets);
          const new_default_9688 = resolve_target_9643(default_target);
          let _t9690;
          if ((new_default_9688 !== default_target)) {
            _t9690 = Ref$set(changed_9680, true);
          } else {
            _t9690 = undefined;
          }
          _t9690;
          let _t9691;
          if (Ref$get(changed_9680)) {
            _t9691 = Array$set(code, i_9658, ({_tag: 82, _name: "JUMP_TABLE", _val: [min_tag, new_targets_9686, new_default_9688]}));
          } else {
            _t9691 = undefined;
          }
          const _t9689 = _t9691;
          const _t9687 = _t9689;
          const _t9681 = _t9687;
          _t9664 = _t9681;
          break _t9665;
        }
        if (true) {
          _t9664 = undefined;
          break _t9665;
        }
        _match_fail("line 15950");
      }
      _t9664;
      (i_9658 = (i_9658 + 1), undefined);
      if (_t9661) break;
    }
    _t9660 = _t9661 ? _t9662 : undefined;
    const _t9659 = _t9660;
    const _t9650 = _t9659;
    const _t9648 = _t9650;
    const _t9646 = _t9648;
    const _t9644 = _t9646;
    _t9628 = _t9644;
  }
  const _t9627 = _t9628;
  return _t9627;
}
function Optimize$optimize_code(_constants, code, line_table) {
  const len_9692 = Array$length(code);
  let _t9694;
  if ((len_9692 === 0)) {
    _t9694 = [code, line_table];
  } else {
    const targets_9695 = Optimize$collect_jump_targets(code);
    const actions_9697 = Array$make(len_9692, ({_tag: 0, _name: "Keep"}));
    Optimize$mark_dead_after_tail_call(code, targets_9695, actions_9697);
    Optimize$mark_jump_to_next(code, actions_9697);
    Optimize$mark_dead_stores(code, targets_9695, actions_9697);
    Optimize$mark_set_get_pairs(code, targets_9695, actions_9697);
    Optimize$mark_jump_tables(code, targets_9695, actions_9697);
    Optimize$mark_push_pop(code, targets_9695, actions_9697);
    Optimize$mark_superinstructions(code, targets_9695, actions_9697);
    const any_changes_9699 = Ref$create(false);
    function _t9701(a) {
      let _t9702;
      if (!_eq(a, ({_tag: 0, _name: "Keep"}))) {
        _t9702 = Ref$set(any_changes_9699, true);
      } else {
        _t9702 = undefined;
      }
      return _t9702;
    }
    Array$iter(_t9701, actions_9697);
    let _t9703;
    if ((!Ref$get(any_changes_9699))) {
      _t9703 = [code, line_table];
    } else {
      let _t9705;
      const _t9704 = Optimize$rewrite(code, line_table, actions_9697);
      _t9706: {
        if (true) {
          const new_code = _t9704[0];
          const new_lines = _t9704[1];
          const offset_map = _t9704[2];
          Optimize$fixup_jumps(new_code, offset_map);
          _t9705 = [new_code, new_lines];
          break _t9706;
        }
        _match_fail("line 15950");
      }
      _t9703 = _t9705;
    }
    let _t9708;
    const _t9707 = _t9703;
    _t9709: {
      if (true) {
        const final_code = _t9707[0];
        const final_lines = _t9707[1];
        Optimize$thread_jumps(final_code);
        _t9708 = [final_code, final_lines];
        break _t9709;
      }
      _match_fail("line 15950");
    }
    const _t9700 = _t9708;
    const _t9698 = _t9700;
    const _t9696 = _t9698;
    _t9694 = _t9696;
  }
  const _t9693 = _t9694;
  return _t9693;
}
function Optimize$optimize_proto(proto) {
  function _t9710(v) {
    let _t9712;
    const _t9711 = v;
    _t9713: {
      if (_t9711._tag === 13) {
        const p = _t9711._val;
        _t9712 = ({_tag: 13, _name: "VProto", _val: Optimize$optimize_proto(p)});
        break _t9713;
      }
      if (true) {
        const other = _t9711;
        _t9712 = other;
        break _t9713;
      }
      _match_fail("line 15950");
    }
    return _t9712;
  }
  const new_constants_9714 = Array$map(_t9710, proto.constants);
  let _t9717;
  const _t9716 = Optimize$optimize_code(new_constants_9714, proto.code, proto.line_table);
  _t9718: {
    if (true) {
      const new_code = _t9716[0];
      const new_lines = _t9716[1];
      const __rec_upd_9719 = proto;
      const _t9720 = ({arity: __rec_upd_9719.arity, code: new_code, constants: new_constants_9714, line_table: new_lines, name: __rec_upd_9719.name, num_locals: __rec_upd_9719.num_locals});
      _t9717 = _t9720;
      break _t9718;
    }
    _match_fail("line 15950");
  }
  const _t9715 = _t9717;
  return _t9715;
}
const Compiler$optimize_enabled = Ref$create(true);
function Compiler$error(msg) {
  return _trampoline(function() {
    return _h["compile_error"](msg, function(_t9721) {
      return _bounce(function() {
        return _t9721;
      });
    });
  }, Compiler$error);
}
function Compiler$create_state(enclosing, arity, global_names, mutable_globals, type_env, name) {
  return ({arity: arity, code: Dynarray$empty(undefined), constants: Dynarray$empty(undefined), current_line: 0, enclosing: enclosing, global_names: global_names, lines: Dynarray$empty(undefined), locals: null, loop_start: ({_tag: 0, _name: "None"}), max_locals: 0, mutable_globals: mutable_globals, mutable_locals: null, num_locals: 0, operand_depth: 0, proto_name: name, scope_depth: 0, type_env: type_env, upvalues: null});
}
function Compiler$emit(s, op) {
  Dynarray$push(s.code, op);
  return Dynarray$push(s.lines, s.current_line);
}
function Compiler$emit_idx(s, op) {
  const idx_9722 = Dynarray$length(s.code);
  Dynarray$push(s.code, op);
  Dynarray$push(s.lines, s.current_line);
  const _t9723 = idx_9722;
  return _t9723;
}
function Compiler$patch(s, idx, op) {
  return Dynarray$set(s.code, idx, op);
}
function Compiler$current_offset(s) {
  return Dynarray$length(s.code);
}
function Compiler$add_constant(s, v) {
  const len_9724 = Dynarray$length(s.constants);
  function find(i) {
    while (true) {
      let _t9726;
      if ((i >= len_9724)) {
        Dynarray$push(s.constants, v);
        _t9726 = len_9724;
      } else {
        let _t9727;
        if (_eq(Dynarray$get(s.constants, i), v)) {
          _t9727 = i;
        } else {
          const _t9728 = (i + 1);
          i = _t9728;
          continue;
          _t9727 = undefined;
        }
        _t9726 = _t9727;
      }
      return _t9726;
    }
  }
  const _t9729 = find(0);
  const _t9725 = _t9729;
  return _t9725;
}
function Compiler$emit_constant(s, v) {
  const idx_9730 = Compiler$add_constant(s, v);
  const _t9731 = Compiler$emit(s, ({_tag: 0, _name: "CONST", _val: idx_9730}));
  return _t9731;
}
function Compiler$allocate_local(s, name) {
  const slot_9732 = s.num_locals;
  (s.locals = ({_hd: ({depth: s.scope_depth, name: name, slot: slot_9732}), _tl: s.locals}), undefined);
  (s.num_locals = (s.num_locals + 1), undefined);
  let _t9734;
  if ((s.num_locals > s.max_locals)) {
    _t9734 = (s.max_locals = s.num_locals, undefined);
  } else {
    _t9734 = undefined;
  }
  _t9734;
  const _t9733 = slot_9732;
  return _t9733;
}
function Compiler$free_local(s) {
  let _t9736;
  const _t9735 = s.locals;
  _t9737: {
    if (_t9735 === null) {
      _t9736 = Compiler$error("no locals to free");
      break _t9737;
    }
    if (_t9735 !== null) {
      const rest = _t9735._tl;
      (s.locals = rest, undefined);
      _t9736 = (s.num_locals = (s.num_locals - 1), undefined);
      break _t9737;
    }
    _match_fail("line 15950");
  }
  return _t9736;
}
function Compiler$find_local(s, name) {
  function search(__x) {
    while (true) {
      let _t9739;
      const _t9738 = __x;
      _t9740: {
        if (_t9738 === null) {
          _t9739 = ({_tag: 0, _name: "None"});
          break _t9740;
        }
        if (_t9738 !== null) {
          const local = _t9738._hd;
          if ((local.name === name)) {
            _t9739 = ({_tag: 1, _name: "Some", _val: local.slot});
            break _t9740;
          }
        }
        if (_t9738 !== null) {
          const rest = _t9738._tl;
          const _t9741 = rest;
          __x = _t9741;
          continue;
          _t9739 = undefined;
          break _t9740;
        }
        _match_fail("line 15950");
      }
      return _t9739;
    }
  }
  const _t9742 = search(s.locals);
  return _t9742;
}
function Compiler$remove_first_occurrence(name, __x) {
  let _t9744;
  const _t9743 = __x;
  _t9745: {
    if (_t9743 === null) {
      _t9744 = null;
      break _t9745;
    }
    if (_t9743 !== null) {
      const x = _t9743._hd;
      const rest = _t9743._tl;
      if (_eq(x, name)) {
        _t9744 = rest;
        break _t9745;
      }
    }
    if (_t9743 !== null) {
      const x = _t9743._hd;
      const rest = _t9743._tl;
      _t9744 = ({_hd: x, _tl: Compiler$remove_first_occurrence(name, rest)});
      break _t9745;
    }
    _match_fail("line 15950");
  }
  return _t9744;
}
function Compiler$is_mutable_local(s, name) {
  while (true) {
    let _t9746;
    if (List$mem(name, s.mutable_locals)) {
      _t9746 = true;
    } else {
      let _t9748;
      const _t9747 = s.enclosing;
      _t9749: {
        if (_t9747._tag === 1) {
          const enc = _t9747._val;
          const _t9750 = enc;
          const _t9751 = name;
          s = _t9750;
          name = _t9751;
          continue;
          _t9748 = undefined;
          break _t9749;
        }
        if (_t9747._tag === 0) {
          _t9748 = false;
          break _t9749;
        }
        _match_fail("line 15950");
      }
      _t9746 = _t9748;
    }
    return _t9746;
  }
}
function Compiler$is_mutable_global(s, name) {
  return _call(Hashtbl$has, [__dict_Hash_string, __dict_Eq_string, s.mutable_globals, name]);
}
function Compiler$add_upvalue(s, capture, name) {
  function find(i, __x) {
    while (true) {
      let _t9753;
      const _t9752 = __x;
      _t9754: {
        if (_t9752 === null) {
          (s.upvalues = List$concat(s.upvalues, ({_hd: ({capture: capture, uv_name: name}), _tl: null})), undefined);
          _t9753 = (List$length(s.upvalues) - 1);
          break _t9754;
        }
        if (_t9752 !== null) {
          const uv = _t9752._hd;
          if (((uv.uv_name === name) && _eq(uv.capture, capture))) {
            _t9753 = i;
            break _t9754;
          }
        }
        if (_t9752 !== null) {
          const rest = _t9752._tl;
          const _t9755 = (i + 1);
          const _t9756 = rest;
          i = _t9755;
          __x = _t9756;
          continue;
          _t9753 = undefined;
          break _t9754;
        }
        _match_fail("line 15950");
      }
      return _t9753;
    }
  }
  const _t9757 = find(0, s.upvalues);
  return _t9757;
}
function Compiler$resolve_upvalue(s, name) {
  let _t9759;
  const _t9758 = s.enclosing;
  _t9760: {
    if (_t9758._tag === 0) {
      _t9759 = ({_tag: 0, _name: "None"});
      break _t9760;
    }
    if (_t9758._tag === 1) {
      const enc = _t9758._val;
      let _t9762;
      const _t9761 = Compiler$find_local(enc, name);
      _t9763: {
        if (_t9761._tag === 1) {
          const slot = _t9761._val;
          const idx_9764 = Compiler$add_upvalue(s, ({_tag: 0, _name: "CaptureLocal", _val: slot}), name);
          const _t9765 = ({_tag: 1, _name: "Some", _val: idx_9764});
          _t9762 = _t9765;
          break _t9763;
        }
        if (_t9761._tag === 0) {
          let _t9767;
          const _t9766 = Compiler$resolve_upvalue(enc, name);
          _t9768: {
            if (_t9766._tag === 1) {
              const enc_uv_idx = _t9766._val;
              const idx_9769 = Compiler$add_upvalue(s, ({_tag: 1, _name: "CaptureUpvalue", _val: enc_uv_idx}), name);
              const _t9770 = ({_tag: 1, _name: "Some", _val: idx_9769});
              _t9767 = _t9770;
              break _t9768;
            }
            if (_t9766._tag === 0) {
              _t9767 = ({_tag: 0, _name: "None"});
              break _t9768;
            }
            _match_fail("line 15950");
          }
          _t9762 = _t9767;
          break _t9763;
        }
        _match_fail("line 15950");
      }
      _t9759 = _t9762;
      break _t9760;
    }
    _match_fail("line 15950");
  }
  return _t9759;
}
function Compiler$find_global(s, name) {
  const len_9771 = Dynarray$length(s.global_names);
  function find(i) {
    while (true) {
      let _t9773;
      if ((i >= len_9771)) {
        _t9773 = ({_tag: 0, _name: "None"});
      } else {
        let _t9774;
        if (_eq(Dynarray$get(s.global_names, i), name)) {
          _t9774 = ({_tag: 1, _name: "Some", _val: i});
        } else {
          const _t9775 = (i + 1);
          i = _t9775;
          continue;
          _t9774 = undefined;
        }
        _t9773 = _t9774;
      }
      return _t9773;
    }
  }
  const _t9776 = find(0);
  const _t9772 = _t9776;
  return _t9772;
}
function Compiler$find_or_add_global(s, name) {
  let _t9778;
  const _t9777 = Compiler$find_global(s, name);
  _t9779: {
    if (_t9777._tag === 1) {
      const i = _t9777._val;
      _t9778 = i;
      break _t9779;
    }
    if (_t9777._tag === 0) {
      const len_9780 = Dynarray$length(s.global_names);
      Dynarray$push(s.global_names, name);
      const _t9781 = len_9780;
      _t9778 = _t9781;
      break _t9779;
    }
    _match_fail("line 15950");
  }
  return _t9778;
}
function Compiler$tag_for_constructor(type_env, name) {
  let _t9783;
  const _t9782 = List$assoc_opt(name, type_env.constructors);
  _t9784: {
    if (_t9782._tag === 0) {
      _t9783 = Compiler$error(("unknown constructor: " + __dict_Show_string.show(name)));
      break _t9784;
    }
    if (_t9782._tag === 1) {
      const info = _t9782._val;
      function _t9785(__p313) {
        let _t9787;
        const _t9786 = __p313;
        _t9788: {
          if (true) {
            const n = _t9786[0];
            _t9787 = (n === info.ctor_type_name);
            break _t9788;
          }
          _match_fail("line 15950");
        }
        return _t9787;
      }
      let _t9790;
      const _t9789 = list_find(_t9785, type_env.variants);
      _t9791: {
        if (true) {
          const variant_def = _t9789[2];
          let _t9793;
          const _t9792 = String$rindex_opt(name, 46);
          _t9794: {
            if (_t9792._tag === 1) {
              const i = _t9792._val;
              _t9793 = String$sub(name, (i + 1), ((String$length(name) - i) - 1));
              break _t9794;
            }
            if (_t9792._tag === 0) {
              _t9793 = name;
              break _t9794;
            }
            _match_fail("line 15950");
          }
          const short_name_9795 = _t9793;
          function find_tag(i, __x) {
            while (true) {
              let _t9798;
              const _t9797 = __x;
              _t9799: {
                if (_t9797 === null) {
                  _t9798 = Compiler$error((("constructor " + __dict_Show_string.show(name)) + " not found in type"));
                  break _t9799;
                }
                if (_t9797 !== null) {
                  const cname = _t9797._hd[0];
                  if ((cname === short_name_9795)) {
                    _t9798 = i;
                    break _t9799;
                  }
                }
                if (_t9797 !== null) {
                  const rest = _t9797._tl;
                  const _t9800 = (i + 1);
                  const _t9801 = rest;
                  i = _t9800;
                  __x = _t9801;
                  continue;
                  _t9798 = undefined;
                  break _t9799;
                }
                _match_fail("line 15950");
              }
              return _t9798;
            }
          }
          const _t9802 = find_tag(0, variant_def);
          const _t9796 = _t9802;
          _t9790 = _t9796;
          break _t9791;
        }
        _match_fail("line 15950");
      }
      _t9783 = _t9790;
      break _t9784;
    }
    _match_fail("line 15950");
  }
  return _t9783;
}
function Compiler$extract_class_ty_args(num_params, schema_ty, resolved_ty) {
  const found_9803 = Hashtbl$create(num_params);
  function go(schema_ty, resolved_ty) {
    while (true) {
      const resolved_ty_9805 = Types$repr(resolved_ty);
      let _t9808;
      const _t9807 = [schema_ty, resolved_ty_9805];
      _t9809: {
        if (_t9807[0]._tag === 17) {
          const i = _t9807[0]._val;
          const ty = _t9807[1];
          if ((i < num_params)) {
            let _t9810;
            if ((!_call(Hashtbl$has, [__dict_Hash_int, __dict_Eq_int, found_9803, i]))) {
              _t9810 = _call(Hashtbl$set, [__dict_Hash_int, __dict_Eq_int, found_9803, i, ty]);
            } else {
              _t9810 = undefined;
            }
            _t9808 = _t9810;
            break _t9809;
          }
        }
        if ((_t9807[0]._tag === 7 && _t9807[1]._tag === 7 || _t9807[0]._tag === 8 && _t9807[1]._tag === 8)) {
          const s_a = _t9807[0]._val[0];
          const s_r = _t9807[0]._val[2];
          const r_a = _t9807[1]._val[0];
          const r_r = _t9807[1]._val[2];
          go(s_a, r_a);
          const _t9811 = s_r;
          const _t9812 = r_r;
          schema_ty = _t9811;
          resolved_ty = _t9812;
          continue;
          _t9808 = undefined;
          break _t9809;
        }
        if (_t9807[0]._tag === 9 && _t9807[1]._tag === 9) {
          const ss = _t9807[0]._val;
          const rs = _t9807[1]._val;
          if ((List$length(ss) === List$length(rs))) {
            _t9808 = List$iter2(go, ss, rs);
            break _t9809;
          }
        }
        if (_t9807[0]._tag === 10 && _t9807[1]._tag === 10) {
          const s = _t9807[0]._val;
          const r = _t9807[1]._val;
          const _t9813 = s;
          const _t9814 = r;
          schema_ty = _t9813;
          resolved_ty = _t9814;
          continue;
          _t9808 = undefined;
          break _t9809;
        }
        if (true) {
          _t9808 = undefined;
          break _t9809;
        }
        _match_fail("line 15950");
      }
      const _t9806 = _t9808;
      return _t9806;
    }
  }
  go(schema_ty, resolved_ty);
  function _t9816(i) {
    return _call(Hashtbl$get, [__dict_Hash_int, __dict_Eq_int, found_9803, i]);
  }
  const _t9815 = List$init(num_params, _t9816);
  const _t9804 = _t9815;
  return _t9804;
}
function Compiler$emit_builtin_call1(s, name) {
  const gidx_9817 = Compiler$find_or_add_global(s, name);
  Compiler$emit(s, ({_tag: 10, _name: "GET_GLOBAL", _val: gidx_9817}));
  const _t9818 = Compiler$emit(s, ({_tag: 42, _name: "CALL", _val: 1}));
  return _t9818;
}
function Compiler$emit_builtin_call2(s, name) {
  const gidx_9819 = Compiler$find_or_add_global(s, name);
  const _t9820 = Compiler$emit(s, ({_tag: 10, _name: "GET_GLOBAL", _val: gidx_9819}));
  return _t9820;
}
function Compiler$compile_expr(tail, s, te) {
  let _t9821;
  if ((te.loc.line > 0)) {
    _t9821 = (s.current_line = te.loc.line, undefined);
  } else {
    _t9821 = undefined;
  }
  _t9821;
  let _t9823;
  const _t9822 = te.expr;
  _t9824: {
    if (_t9822._tag === 0) {
      const n = _t9822._val;
      _t9823 = Compiler$emit_constant(s, ({_tag: 0, _name: "VInt", _val: n}));
      break _t9824;
    }
    if (_t9822._tag === 1) {
      const f = _t9822._val;
      _t9823 = Compiler$emit_constant(s, ({_tag: 1, _name: "VFloat", _val: f}));
      break _t9824;
    }
    if (_t9822._tag === 2) {
      const b = _t9822._val;
      _t9823 = Compiler$emit_constant(s, ({_tag: 2, _name: "VBool", _val: b}));
      break _t9824;
    }
    if (_t9822._tag === 3) {
      const str = _t9822._val;
      _t9823 = Compiler$emit_constant(s, ({_tag: 3, _name: "VString", _val: str}));
      break _t9824;
    }
    if (_t9822._tag === 4) {
      const n = _t9822._val;
      _t9823 = Compiler$emit_constant(s, ({_tag: 4, _name: "VByte", _val: n}));
      break _t9824;
    }
    if (_t9822._tag === 5) {
      const n = _t9822._val;
      _t9823 = Compiler$emit_constant(s, ({_tag: 5, _name: "VRune", _val: n}));
      break _t9824;
    }
    if (_t9822._tag === 6) {
      _t9823 = Compiler$emit_constant(s, ({_tag: 6, _name: "VUnit"}));
      break _t9824;
    }
    if (_t9822._tag === 22) {
      _t9823 = Compiler$emit(s, ({_tag: 57, _name: "NIL"}));
      break _t9824;
    }
    if (_t9822._tag === 7) {
      const name = _t9822._val;
      let _t9825;
      if ((_eq(Compiler$find_local(s, name), ({_tag: 0, _name: "None"})) && (_eq(Compiler$resolve_upvalue(s, name), ({_tag: 0, _name: "None"})) && _eq(Compiler$find_global(s, name), ({_tag: 0, _name: "None"}))))) {
        let _t9827;
        const _t9826 = Types$find_method_class(s.type_env.classes, name);
        _t9828: {
          if (_t9826._tag === 1) {
            const result = _t9826;
            _t9827 = [result, name];
            break _t9828;
          }
          if (_t9826._tag === 0) {
            let _t9830;
            const _t9829 = String$rindex_opt(name, 46);
            _t9831: {
              if (_t9829._tag === 0) {
                _t9830 = [({_tag: 0, _name: "None"}), name];
                break _t9831;
              }
              if (_t9829._tag === 1) {
                const i = _t9829._val;
                const mod_prefix_9832 = String$sub(name, 0, (i + 1));
                const _mml$short_9834 = String$sub(name, (i + 1), ((String$length(name) - i) - 1));
                const class_prefix_9836 = String$sub(name, 0, i);
                let _t9839;
                const _t9838 = Types$find_method_class(s.type_env.classes, _mml$short_9834);
                _t9840: {
                  if (_t9838._tag === 1) {
                    const class_def = _t9838._val;
                    if ((class_def.class_name === class_prefix_9836)) {
                      _t9839 = [({_tag: 1, _name: "Some", _val: class_def}), _mml$short_9834];
                      break _t9840;
                    }
                  }
                  if (_t9838._tag === 1) {
                    const class_def = _t9838._val;
                    if (((String$length(class_def.class_name) > String$length(mod_prefix_9832)) && (String$sub(class_def.class_name, 0, String$length(mod_prefix_9832)) === mod_prefix_9832))) {
                      _t9839 = [({_tag: 1, _name: "Some", _val: class_def}), _mml$short_9834];
                      break _t9840;
                    }
                  }
                  if (true) {
                    _t9839 = [({_tag: 0, _name: "None"}), name];
                    break _t9840;
                  }
                  _match_fail("line 15950");
                }
                const _t9837 = _t9839;
                const _t9835 = _t9837;
                const _t9833 = _t9835;
                _t9830 = _t9833;
                break _t9831;
              }
              _match_fail("line 15950");
            }
            _t9827 = _t9830;
            break _t9828;
          }
          _match_fail("line 15950");
        }
        let _t9842;
        const _t9841 = _t9827;
        _t9843: {
          if (true) {
            const class_opt = _t9841[0];
            const method_name = _t9841[1];
            let _t9845;
            const _t9844 = class_opt;
            _t9846: {
              if (_t9844._tag === 1) {
                const class_def = _t9844._val;
                const method_schema_ty_9847 = List$assoc(method_name, class_def.class_methods);
                const num_params_9849 = List$length(class_def.class_params);
                const partial_9851 = Compiler$extract_class_ty_args(num_params_9849, method_schema_ty_9847, te.ty);
                function _t9853(opt) {
                  let _t9855;
                  const _t9854 = opt;
                  _t9856: {
                    if (_t9854._tag === 1) {
                      const ty = _t9854._val;
                      let _t9858;
                      const _t9857 = Types$repr(ty);
                      _t9859: {
                        if (_t9857._tag === 16 && _t9857._val.contents._tag === 0) {
                          _t9858 = ({_tag: 0, _name: "None"});
                          break _t9859;
                        }
                        if (true) {
                          _t9858 = ({_tag: 1, _name: "Some", _val: Types$repr(ty)});
                          break _t9859;
                        }
                        _match_fail("line 15950");
                      }
                      _t9855 = _t9858;
                      break _t9856;
                    }
                    if (_t9854._tag === 0) {
                      _t9855 = ({_tag: 0, _name: "None"});
                      break _t9856;
                    }
                    _match_fail("line 15950");
                  }
                  return _t9855;
                }
                const concrete_partial_9860 = List$map(_t9853, partial_9851);
                let _t9862;
                if (!_eq(class_def.class_fundeps, null)) {
                  _t9862 = Types$improve_with_fundeps(s.type_env.instances, class_def, concrete_partial_9860);
                } else {
                  _t9862 = concrete_partial_9860;
                }
                const concrete_partial_9863 = _t9862;
                function _t9865(inst) {
                  return ((inst.inst_class === class_def.class_name) && ((List$length(inst.inst_tys) === num_params_9849) && Types$match_partial_inst(inst.inst_tys, concrete_partial_9863)));
                }
                const matching_9866 = List$filter(_t9865, s.type_env.instances);
                let _t9869;
                const _t9868 = matching_9866;
                _t9870: {
                  if (_t9868 !== null && _t9868._tl === null) {
                    const inst = _t9868._hd;
                    let _t9871;
                    if (_eq(inst.inst_constraints, null)) {
                      const method_gidx_9872 = Compiler$find_or_add_global(s, (inst.inst_dict_name + ("$" + method_name)));
                      const _t9873 = Compiler$emit(s, ({_tag: 10, _name: "GET_GLOBAL", _val: method_gidx_9872}));
                      _t9871 = _t9873;
                    } else {
                      const dict_gidx_9874 = Compiler$find_or_add_global(s, inst.inst_dict_name);
                      Compiler$emit(s, ({_tag: 10, _name: "GET_GLOBAL", _val: dict_gidx_9874}));
                      const _t9875 = Compiler$emit(s, ({_tag: 51, _name: "FIELD", _val: method_name}));
                      _t9871 = _t9875;
                    }
                    _t9869 = _t9871;
                    break _t9870;
                  }
                  if (_t9868 === null) {
                    function _t9876(__x) {
                      let _t9878;
                      const _t9877 = __x;
                      _t9879: {
                        if (_t9877._tag === 1) {
                          const ty = _t9877._val;
                          let _t9881;
                          const _t9880 = Types$repr(ty);
                          _t9882: {
                            if ((_t9880._tag === 15 || _t9880._tag === 11)) {
                              _t9881 = true;
                              break _t9882;
                            }
                            if (true) {
                              _t9881 = false;
                              break _t9882;
                            }
                            _match_fail("line 15950");
                          }
                          _t9878 = _t9881;
                          break _t9879;
                        }
                        if (_t9877._tag === 0) {
                          _t9878 = false;
                          break _t9879;
                        }
                        _match_fail("line 15950");
                      }
                      return _t9878;
                    }
                    const is_structural_9883 = List$exists(_t9876, partial_9851);
                    let _t9885;
                    if ((is_structural_9883 && ((class_def.class_name === "Show") && (method_name === "show")))) {
                      const gidx_9886 = Compiler$find_or_add_global(s, "__show_value");
                      const _t9887 = Compiler$emit(s, ({_tag: 10, _name: "GET_GLOBAL", _val: gidx_9886}));
                      _t9885 = _t9887;
                    } else {
                      function _t9888(__x) {
                        let _t9890;
                        const _t9889 = __x;
                        _t9891: {
                          if (_t9889._tag === 1) {
                            const ty = _t9889._val;
                            _t9890 = Types$pp_ty(ty);
                            break _t9891;
                          }
                          if (_t9889._tag === 0) {
                            _t9890 = "_";
                            break _t9891;
                          }
                          _match_fail("line 15950");
                        }
                        return _t9890;
                      }
                      const ty_strs_9892 = List$map(_t9888, partial_9851);
                      const _t9893 = Compiler$error(((("no instance of " + __dict_Show_string.show(class_def.class_name)) + " for types ") + __dict_Show_string.show(String$concat(", ", ty_strs_9892))));
                      _t9885 = _t9893;
                    }
                    const _t9884 = _t9885;
                    _t9869 = _t9884;
                    break _t9870;
                  }
                  if (true) {
                    let _t9895;
                    const _t9894 = Types$most_specific_inst(matching_9866);
                    _t9896: {
                      if (_t9894._tag === 1) {
                        const inst = _t9894._val;
                        let _t9897;
                        if (_eq(inst.inst_constraints, null)) {
                          const method_gidx_9898 = Compiler$find_or_add_global(s, (inst.inst_dict_name + ("$" + method_name)));
                          const _t9899 = Compiler$emit(s, ({_tag: 10, _name: "GET_GLOBAL", _val: method_gidx_9898}));
                          _t9897 = _t9899;
                        } else {
                          const dict_gidx_9900 = Compiler$find_or_add_global(s, inst.inst_dict_name);
                          Compiler$emit(s, ({_tag: 10, _name: "GET_GLOBAL", _val: dict_gidx_9900}));
                          const _t9901 = Compiler$emit(s, ({_tag: 51, _name: "FIELD", _val: method_name}));
                          _t9897 = _t9901;
                        }
                        _t9895 = _t9897;
                        break _t9896;
                      }
                      if (_t9894._tag === 0) {
                        _t9895 = Compiler$error(((("ambiguous instance for " + __dict_Show_string.show(class_def.class_name)) + " method ") + __dict_Show_string.show(method_name)));
                        break _t9896;
                      }
                      _match_fail("line 15950");
                    }
                    _t9869 = _t9895;
                    break _t9870;
                  }
                  _match_fail("line 15950");
                }
                const _t9867 = _t9869;
                const _t9864 = _t9867;
                const _t9861 = _t9864;
                const _t9852 = _t9861;
                const _t9850 = _t9852;
                const _t9848 = _t9850;
                _t9845 = _t9848;
                break _t9846;
              }
              if (_t9844._tag === 0) {
                _t9845 = Compiler$compile_var_access(s, name);
                break _t9846;
              }
              _match_fail("line 15950");
            }
            _t9842 = _t9845;
            break _t9843;
          }
          _match_fail("line 15950");
        }
        _t9825 = _t9842;
      } else {
        _t9825 = Compiler$compile_var_access(s, name);
      }
      _t9823 = _t9825;
      break _t9824;
    }
    if (_t9822._tag === 13) {
      const op = _t9822._val[0];
      const e1 = _t9822._val[1];
      const e2 = _t9822._val[2];
      _t9823 = Compiler$compile_binop(s, op, e1, e2);
      break _t9824;
    }
    if (_t9822._tag === 14) {
      const op = _t9822._val[0];
      const e = _t9822._val[1];
      _t9823 = Compiler$compile_unop(s, op, e);
      break _t9824;
    }
    if (_t9822._tag === 11) {
      const fn_ = _t9822._val[0];
      const arg = _t9822._val[1];
      function collect_args(expr, acc) {
        while (true) {
          let _t9903;
          const _t9902 = expr.expr;
          _t9904: {
            if (_t9902._tag === 11) {
              const inner_fn = _t9902._val[0];
              const inner_arg = _t9902._val[1];
              const _t9905 = inner_fn;
              const _t9906 = ({_hd: inner_arg, _tl: acc});
              expr = _t9905;
              acc = _t9906;
              continue;
              _t9903 = undefined;
              break _t9904;
            }
            if (true) {
              _t9903 = [expr, acc];
              break _t9904;
            }
            _match_fail("line 15950");
          }
          return _t9903;
        }
      }
      let _t9909;
      const _t9908 = collect_args(fn_, ({_hd: arg, _tl: null}));
      _t9910: {
        if (true) {
          const base_fn = _t9908[0];
          const all_args = _t9908[1];
          const n_9911 = List$length(all_args);
          Compiler$compile_expr(false, s, base_fn);
          function _t9913(a) {
            return Compiler$compile_expr(false, s, a);
          }
          List$iter(_t9913, all_args);
          let _t9914;
          if ((n_9911 > 1)) {
            let _t9915;
            if (tail) {
              _t9915 = ({_tag: 84, _name: "TAIL_CALL_N", _val: n_9911});
            } else {
              _t9915 = ({_tag: 83, _name: "CALL_N", _val: n_9911});
            }
            _t9914 = Compiler$emit(s, _t9915);
          } else {
            let _t9916;
            if (tail) {
              _t9916 = ({_tag: 43, _name: "TAIL_CALL", _val: 1});
            } else {
              _t9916 = ({_tag: 42, _name: "CALL", _val: 1});
            }
            _t9914 = Compiler$emit(s, _t9916);
          }
          const _t9912 = _t9914;
          _t9909 = _t9912;
          break _t9910;
        }
        _match_fail("line 15950");
      }
      const _t9907 = _t9909;
      _t9823 = _t9907;
      break _t9824;
    }
    if (_t9822._tag === 10) {
      const param = _t9822._val[0];
      const body = _t9822._val[1];
      const has_return = _t9822._val[2];
      _t9823 = Compiler$compile_function(has_return, s, param, body, te.ty);
      break _t9824;
    }
    if (_t9822._tag === 8) {
      const name = _t9822._val[0];
      const _scheme = _t9822._val[1];
      const e1 = _t9822._val[2];
      const e2 = _t9822._val[3];
      Compiler$compile_expr(false, s, e1);
      const was_mutable_9917 = List$mem(name, s.mutable_locals);
      let _t9919;
      if (was_mutable_9917) {
        function _t9920(n) {
          return (n !== name);
        }
        _t9919 = (s.mutable_locals = List$filter(_t9920, s.mutable_locals), undefined);
      } else {
        _t9919 = undefined;
      }
      _t9919;
      const slot_9921 = Compiler$allocate_local(s, name);
      Compiler$emit(s, ({_tag: 4, _name: "SET_LOCAL", _val: slot_9921}));
      Compiler$compile_expr(tail, s, e2);
      let _t9923;
      if (was_mutable_9917) {
        _t9923 = (s.mutable_locals = ({_hd: name, _tl: s.mutable_locals}), undefined);
      } else {
        _t9923 = undefined;
      }
      _t9923;
      const _t9922 = Compiler$free_local(s);
      const _t9918 = _t9922;
      _t9823 = _t9918;
      break _t9824;
    }
    if (_t9822._tag === 25) {
      const name = _t9822._val[0];
      const e1 = _t9822._val[1];
      const e2 = _t9822._val[2];
      Compiler$compile_expr(false, s, e1);
      Compiler$emit(s, ({_tag: 7, _name: "MAKE_REF"}));
      const slot_9924 = Compiler$allocate_local(s, name);
      (s.mutable_locals = ({_hd: name, _tl: s.mutable_locals}), undefined);
      Compiler$emit(s, ({_tag: 4, _name: "SET_LOCAL", _val: slot_9924}));
      Compiler$compile_expr(tail, s, e2);
      (s.mutable_locals = Compiler$remove_first_occurrence(name, s.mutable_locals), undefined);
      const _t9925 = Compiler$free_local(s);
      _t9823 = _t9925;
      break _t9824;
    }
    if (_t9822._tag === 32) {
      const cond = _t9822._val[0];
      const body = _t9822._val[1];
      const enter_idx_9926 = Compiler$emit_idx(s, ({_tag: 68, _name: "ENTER_LOOP", _val: 0}));
      const prev_loop_start_9928 = s.loop_start;
      const loop_start_9930 = Compiler$current_offset(s);
      (s.loop_start = ({_tag: 1, _name: "Some", _val: loop_start_9930}), undefined);
      Compiler$compile_expr(false, s, cond);
      const exit_jump_9932 = Compiler$emit_idx(s, ({_tag: 38, _name: "JUMP_IF_FALSE", _val: 0}));
      Compiler$compile_expr(false, s, body);
      Compiler$emit(s, ({_tag: 1, _name: "POP"}));
      Compiler$emit(s, ({_tag: 37, _name: "JUMP", _val: loop_start_9930}));
      const exit_normal_9934 = Compiler$current_offset(s);
      Compiler$patch(s, exit_jump_9932, ({_tag: 38, _name: "JUMP_IF_FALSE", _val: exit_normal_9934}));
      Compiler$emit(s, ({_tag: 69, _name: "EXIT_LOOP"}));
      const unit_idx_9936 = Compiler$add_constant(s, ({_tag: 6, _name: "VUnit"}));
      Compiler$emit(s, ({_tag: 0, _name: "CONST", _val: unit_idx_9936}));
      const end_jump_9938 = Compiler$emit_idx(s, ({_tag: 37, _name: "JUMP", _val: 0}));
      const break_target_9940 = Compiler$current_offset(s);
      const end_target_9942 = Compiler$current_offset(s);
      Compiler$patch(s, enter_idx_9926, ({_tag: 68, _name: "ENTER_LOOP", _val: break_target_9940}));
      Compiler$patch(s, end_jump_9938, ({_tag: 37, _name: "JUMP", _val: end_target_9942}));
      const _t9943 = (s.loop_start = prev_loop_start_9928, undefined);
      const _t9941 = _t9943;
      const _t9939 = _t9941;
      const _t9937 = _t9939;
      const _t9935 = _t9937;
      const _t9933 = _t9935;
      const _t9931 = _t9933;
      const _t9929 = _t9931;
      const _t9927 = _t9929;
      _t9823 = _t9927;
      break _t9824;
    }
    if (_t9822._tag === 26) {
      const name = _t9822._val[0];
      const e = _t9822._val[1];
      let _t9945;
      const _t9944 = Compiler$find_local(s, name);
      _t9946: {
        if (_t9944._tag === 1) {
          const slot = _t9944._val;
          Compiler$compile_expr(false, s, e);
          Compiler$emit(s, ({_tag: 3, _name: "GET_LOCAL", _val: slot}));
          _t9945 = Compiler$emit(s, ({_tag: 9, _name: "SET_REF"}));
          break _t9946;
        }
        if (_t9944._tag === 0) {
          let _t9948;
          const _t9947 = Compiler$resolve_upvalue(s, name);
          _t9949: {
            if (_t9947._tag === 1) {
              const idx = _t9947._val;
              Compiler$compile_expr(false, s, e);
              Compiler$emit(s, ({_tag: 5, _name: "GET_UPVALUE", _val: idx}));
              _t9948 = Compiler$emit(s, ({_tag: 9, _name: "SET_REF"}));
              break _t9949;
            }
            if (_t9947._tag === 0) {
              Compiler$compile_expr(false, s, e);
              const gidx_9950 = Compiler$find_or_add_global(s, name);
              Compiler$emit(s, ({_tag: 10, _name: "GET_GLOBAL", _val: gidx_9950}));
              const _t9951 = Compiler$emit(s, ({_tag: 9, _name: "SET_REF"}));
              _t9948 = _t9951;
              break _t9949;
            }
            _match_fail("line 15950");
          }
          _t9945 = _t9948;
          break _t9946;
        }
        _match_fail("line 15950");
      }
      _t9945;
      _t9823 = Compiler$emit_constant(s, ({_tag: 6, _name: "VUnit"}));
      break _t9824;
    }
    if (_t9822._tag === 27) {
      const record_e = _t9822._val[0];
      const field = _t9822._val[1];
      const value_e = _t9822._val[2];
      Compiler$compile_expr(false, s, record_e);
      Compiler$compile_expr(false, s, value_e);
      Compiler$emit(s, ({_tag: 52, _name: "SET_FIELD", _val: field}));
      _t9823 = Compiler$emit_constant(s, ({_tag: 6, _name: "VUnit"}));
      break _t9824;
    }
    if (_t9822._tag === 9) {
      const name = _t9822._val[0];
      const _scheme = _t9822._val[1];
      const e1 = _t9822._val[2];
      const e2 = _t9822._val[3];
      Compiler$compile_let_rec(s, name, e1);
      Compiler$compile_expr(tail, s, e2);
      _t9823 = Compiler$free_local(s);
      break _t9824;
    }
    if (_t9822._tag === 12) {
      const cond = _t9822._val[0];
      const then_e = _t9822._val[1];
      const else_e = _t9822._val[2];
      _t9823 = Compiler$compile_if(tail, s, cond, then_e, else_e);
      break _t9824;
    }
    if (_t9822._tag === 15) {
      const exprs = _t9822._val;
      List$iter(_call(Compiler$compile_expr, [false, s]), exprs);
      _t9823 = Compiler$emit(s, ({_tag: 48, _name: "MAKE_TUPLE", _val: List$length(exprs)}));
      break _t9824;
    }
    if (_t9822._tag === 16) {
      const fields = _t9822._val;
      function _t9952(__p314, __p315) {
        let _t9954;
        const _t9953 = __p314;
        _t9955: {
          if (true) {
            const a = _t9953[0];
            let _t9957;
            const _t9956 = __p315;
            _t9958: {
              if (true) {
                const b = _t9956[0];
                _t9957 = String$compare(a, b);
                break _t9958;
              }
              _match_fail("line 15950");
            }
            _t9954 = _t9957;
            break _t9955;
          }
          _match_fail("line 15950");
        }
        return _t9954;
      }
      const sorted_9959 = List$sort(_t9952, fields);
      const names_9961 = List$map(fst, sorted_9959);
      function _t9963(__p316) {
        let _t9965;
        const _t9964 = __p316;
        _t9966: {
          if (true) {
            const e = _t9964[1];
            _t9965 = Compiler$compile_expr(false, s, e);
            break _t9966;
          }
          _match_fail("line 15950");
        }
        return _t9965;
      }
      List$iter(_t9963, sorted_9959);
      const _t9962 = Compiler$emit(s, ({_tag: 50, _name: "MAKE_RECORD", _val: names_9961}));
      const _t9960 = _t9962;
      _t9823 = _t9960;
      break _t9824;
    }
    if (_t9822._tag === 17) {
      const base = _t9822._val[0];
      const overrides = _t9822._val[1];
      Compiler$compile_expr(false, s, base);
      function _t9967(__p317) {
        let _t9969;
        const _t9968 = __p317;
        _t9970: {
          if (true) {
            const e = _t9968[1];
            _t9969 = Compiler$compile_expr(false, s, e);
            break _t9970;
          }
          _match_fail("line 15950");
        }
        return _t9969;
      }
      List$iter(_t9967, overrides);
      const field_names_9971 = List$map(fst, overrides);
      const _t9972 = Compiler$emit(s, ({_tag: 53, _name: "RECORD_UPDATE", _val: field_names_9971}));
      _t9823 = _t9972;
      break _t9824;
    }
    if (_t9822._tag === 18) {
      const base = _t9822._val[0];
      const pairs = _t9822._val[1];
      Compiler$compile_expr(false, s, base);
      function _t9973(__p318) {
        let _t9975;
        const _t9974 = __p318;
        _t9976: {
          if (true) {
            const idx_e = _t9974[0];
            const val_e = _t9974[1];
            Compiler$compile_expr(false, s, idx_e);
            _t9975 = Compiler$compile_expr(false, s, val_e);
            break _t9976;
          }
          _match_fail("line 15950");
        }
        return _t9975;
      }
      List$iter(_t9973, pairs);
      _t9823 = Compiler$emit(s, ({_tag: 54, _name: "RECORD_UPDATE_DYN", _val: List$length(pairs)}));
      break _t9824;
    }
    if (_t9822._tag === 19) {
      const e = _t9822._val[0];
      const field = _t9822._val[1];
      Compiler$compile_expr(false, s, e);
      _t9823 = Compiler$emit(s, ({_tag: 51, _name: "FIELD", _val: field}));
      break _t9824;
    }
    if (_t9822._tag === 20) {
      const base = _t9822._val[0];
      const idx = _t9822._val[1];
      Compiler$compile_expr(false, s, base);
      Compiler$compile_expr(false, s, idx);
      _t9823 = Compiler$emit(s, ({_tag: 75, _name: "INDEX"}));
      break _t9824;
    }
    if (_t9822._tag === 21) {
      const hd = _t9822._val[0];
      const tl = _t9822._val[1];
      Compiler$compile_expr(false, s, hd);
      Compiler$compile_expr(false, s, tl);
      _t9823 = Compiler$emit(s, ({_tag: 56, _name: "CONS"}));
      break _t9824;
    }
    if (_t9822._tag === 23) {
      const name = _t9822._val[0];
      const arg = _t9822._val[1];
      let _t9977;
      if (((String$length(name) > 0) && (String$get(name, 0) === 96))) {
        _t9977 = (__dict_Hash_string.hash(String$sub(name, 1, (String$length(name) - 1))) & 1073741823);
      } else {
        _t9977 = Compiler$tag_for_constructor(s.type_env, name);
      }
      const tag_9978 = _t9977;
      let _t9981;
      const _t9980 = String$rindex_opt(name, 46);
      _t9982: {
        if (_t9980._tag === 1) {
          const i = _t9980._val;
          _t9981 = String$sub(name, (i + 1), ((String$length(name) - i) - 1));
          break _t9982;
        }
        if (_t9980._tag === 0) {
          _t9981 = name;
          break _t9982;
        }
        _match_fail("line 15950");
      }
      const short_name_9983 = _t9981;
      let _t9986;
      const _t9985 = arg;
      _t9987: {
        if (_t9985._tag === 1) {
          const e = _t9985._val;
          Compiler$compile_expr(false, s, e);
          _t9986 = Compiler$emit(s, ({_tag: 55, _name: "MAKE_VARIANT", _val: [tag_9978, short_name_9983, true]}));
          break _t9987;
        }
        if (_t9985._tag === 0) {
          _t9986 = Compiler$emit(s, ({_tag: 55, _name: "MAKE_VARIANT", _val: [tag_9978, short_name_9983, false]}));
          break _t9987;
        }
        _match_fail("line 15950");
      }
      const _t9984 = _t9986;
      const _t9979 = _t9984;
      _t9823 = _t9979;
      break _t9824;
    }
    if (_t9822._tag === 24) {
      const scrut = _t9822._val[0];
      const arms = _t9822._val[1];
      const _partial = _t9822._val[2];
      _t9823 = Compiler$compile_match(tail, s, scrut, arms);
      break _t9824;
    }
    if (_t9822._tag === 28) {
      const e1 = _t9822._val[0];
      const e2 = _t9822._val[1];
      Compiler$compile_expr(false, s, e1);
      Compiler$emit(s, ({_tag: 1, _name: "POP"}));
      _t9823 = Compiler$compile_expr(tail, s, e2);
      break _t9824;
    }
    if (_t9822._tag === 29) {
      const op_name = _t9822._val[0];
      const arg_te = _t9822._val[1];
      Compiler$compile_expr(false, s, arg_te);
      _t9823 = Compiler$emit(s, ({_tag: 65, _name: "PERFORM", _val: op_name}));
      break _t9824;
    }
    if (_t9822._tag === 30) {
      const body_te = _t9822._val[0];
      const arms = _t9822._val[1];
      _t9823 = Compiler$compile_handle(s, body_te, arms);
      break _t9824;
    }
    if (_t9822._tag === 31) {
      const k_te = _t9822._val[0];
      const v_te = _t9822._val[1];
      Compiler$compile_expr(false, s, k_te);
      Compiler$compile_expr(false, s, v_te);
      _t9823 = Compiler$emit(s, ({_tag: 67, _name: "RESUME"}));
      break _t9824;
    }
    if (_t9822._tag === 33) {
      const value_te = _t9822._val;
      Compiler$compile_expr(false, s, value_te);
      _t9823 = Compiler$emit(s, ({_tag: 70, _name: "LOOP_BREAK"}));
      break _t9824;
    }
    if (_t9822._tag === 34) {
      let _t9989;
      const _t9988 = s.loop_start;
      _t9990: {
        if (_t9988._tag === 1) {
          const target = _t9988._val;
          _t9989 = Compiler$emit(s, ({_tag: 71, _name: "LOOP_CONTINUE", _val: target}));
          break _t9990;
        }
        if (_t9988._tag === 0) {
          _t9989 = Compiler$error("continue outside of loop");
          break _t9990;
        }
        _match_fail("line 15950");
      }
      _t9823 = _t9989;
      break _t9824;
    }
    if (_t9822._tag === 35) {
      const value_te = _t9822._val;
      const depth_before_9991 = s.operand_depth;
      Compiler$compile_expr(false, s, value_te);
      const n_pops_9993 = depth_before_9991;
      const _t9994 = Compiler$emit(s, ({_tag: 72, _name: "FOLD_CONTINUE", _val: n_pops_9993}));
      const _t9992 = _t9994;
      _t9823 = _t9992;
      break _t9824;
    }
    if (_t9822._tag === 36) {
      const fold_te = _t9822._val;
      const enter_idx_9995 = Compiler$emit_idx(s, ({_tag: 68, _name: "ENTER_LOOP", _val: 0}));
      const prev_loop_start_9997 = s.loop_start;
      (s.loop_start = ({_tag: 0, _name: "None"}), undefined);
      Compiler$compile_expr(false, s, fold_te);
      Compiler$emit(s, ({_tag: 69, _name: "EXIT_LOOP"}));
      const end_jump_9999 = Compiler$emit_idx(s, ({_tag: 37, _name: "JUMP", _val: 0}));
      const break_target_10001 = Compiler$current_offset(s);
      const end_target_10003 = Compiler$current_offset(s);
      Compiler$patch(s, enter_idx_9995, ({_tag: 68, _name: "ENTER_LOOP", _val: break_target_10001}));
      Compiler$patch(s, end_jump_9999, ({_tag: 37, _name: "JUMP", _val: end_target_10003}));
      const _t10004 = (s.loop_start = prev_loop_start_9997, undefined);
      const _t10002 = _t10004;
      const _t10000 = _t10002;
      const _t9998 = _t10000;
      const _t9996 = _t9998;
      _t9823 = _t9996;
      break _t9824;
    }
    if (_t9822._tag === 38) {
      const pairs = _t9822._val;
      function _t10005(__p319) {
        let _t10007;
        const _t10006 = __p319;
        _t10008: {
          if (true) {
            const k = _t10006[0];
            const v = _t10006[1];
            Compiler$compile_expr(false, s, k);
            _t10007 = Compiler$compile_expr(false, s, v);
            break _t10008;
          }
          _match_fail("line 15950");
        }
        return _t10007;
      }
      List$iter(_t10005, pairs);
      _t9823 = Compiler$emit(s, ({_tag: 73, _name: "MAKE_MAP", _val: List$length(pairs)}));
      break _t9824;
    }
    if (_t9822._tag === 39) {
      const elems = _t9822._val;
      List$iter(_call(Compiler$compile_expr, [false, s]), elems);
      _t9823 = Compiler$emit(s, ({_tag: 74, _name: "MAKE_ARRAY", _val: List$length(elems)}));
      break _t9824;
    }
    if (_t9822._tag === 40) {
      const value_te = _t9822._val;
      Compiler$compile_expr(false, s, value_te);
      _t9823 = Compiler$emit(s, ({_tag: 45, _name: "FUNC_RETURN"}));
      break _t9824;
    }
    if (_t9822._tag === 37) {
      const bindings = _t9822._val[0];
      const body = _t9822._val[1];
      function _t10009(__p320) {
        let _t10011;
        const _t10010 = __p320;
        _t10012: {
          if (true) {
            const name = _t10010[0];
            const unit_idx_10013 = Compiler$add_constant(s, ({_tag: 6, _name: "VUnit"}));
            Compiler$emit(s, ({_tag: 0, _name: "CONST", _val: unit_idx_10013}));
            Compiler$emit(s, ({_tag: 7, _name: "MAKE_REF"}));
            const slot_10015 = Compiler$allocate_local(s, name);
            (s.mutable_locals = ({_hd: name, _tl: s.mutable_locals}), undefined);
            Compiler$emit(s, ({_tag: 4, _name: "SET_LOCAL", _val: slot_10015}));
            const _t10016 = slot_10015;
            const _t10014 = _t10016;
            _t10011 = _t10014;
            break _t10012;
          }
          _match_fail("line 15950");
        }
        return _t10011;
      }
      const slots_10017 = List$map(_t10009, bindings);
      function _t10019(__p321, slot) {
        let _t10021;
        const _t10020 = __p321;
        _t10022: {
          if (true) {
            const _name = _t10020[0];
            const fn_te = _t10020[1];
            Compiler$compile_expr(false, s, fn_te);
            Compiler$emit(s, ({_tag: 3, _name: "GET_LOCAL", _val: slot}));
            _t10021 = Compiler$emit(s, ({_tag: 9, _name: "SET_REF"}));
            break _t10022;
          }
          _match_fail("line 15950");
        }
        return _t10021;
      }
      List$iter2(_t10019, bindings, slots_10017);
      Compiler$compile_expr(tail, s, body);
      function _t10023(__p322) {
        let _t10025;
        const _t10024 = __p322;
        _t10026: {
          if (true) {
            const name = _t10024[0];
            function _t10027(n) {
              return (n !== name);
            }
            _t10025 = (s.mutable_locals = List$filter(_t10027, s.mutable_locals), undefined);
            break _t10026;
          }
          _match_fail("line 15950");
        }
        return _t10025;
      }
      List$iter(_t10023, bindings);
      function _t10028(_) {
        return Compiler$free_local(s);
      }
      const _t10018 = List$iter(_t10028, bindings);
      _t9823 = _t10018;
      break _t9824;
    }
    _match_fail("line 15950");
  }
  return _t9823;
}
function Compiler$compile_var_access(s, name) {
  let _t10030;
  const _t10029 = Compiler$find_local(s, name);
  _t10031: {
    if (_t10029._tag === 1) {
      const slot = _t10029._val;
      Compiler$emit(s, ({_tag: 3, _name: "GET_LOCAL", _val: slot}));
      let _t10032;
      if (Compiler$is_mutable_local(s, name)) {
        _t10032 = Compiler$emit(s, ({_tag: 8, _name: "DEREF"}));
      } else {
        _t10032 = undefined;
      }
      _t10030 = _t10032;
      break _t10031;
    }
    if (_t10029._tag === 0) {
      let _t10034;
      const _t10033 = Compiler$resolve_upvalue(s, name);
      _t10035: {
        if (_t10033._tag === 1) {
          const idx = _t10033._val;
          Compiler$emit(s, ({_tag: 5, _name: "GET_UPVALUE", _val: idx}));
          let _t10036;
          if (Compiler$is_mutable_local(s, name)) {
            _t10036 = Compiler$emit(s, ({_tag: 8, _name: "DEREF"}));
          } else {
            _t10036 = undefined;
          }
          _t10034 = _t10036;
          break _t10035;
        }
        if (_t10033._tag === 0) {
          const gidx_10037 = Compiler$find_or_add_global(s, name);
          Compiler$emit(s, ({_tag: 10, _name: "GET_GLOBAL", _val: gidx_10037}));
          let _t10039;
          if (Compiler$is_mutable_global(s, name)) {
            _t10039 = Compiler$emit(s, ({_tag: 8, _name: "DEREF"}));
          } else {
            _t10039 = undefined;
          }
          const _t10038 = _t10039;
          _t10034 = _t10038;
          break _t10035;
        }
        _match_fail("line 15950");
      }
      _t10030 = _t10034;
      break _t10031;
    }
    _match_fail("line 15950");
  }
  return _t10030;
}
function Compiler$compile_binop(s, op, e1, e2) {
  let _t10041;
  const _t10040 = op;
  _t10042: {
    if (_t10040._tag === 11) {
      Compiler$compile_expr(false, s, e1);
      Compiler$emit(s, ({_tag: 2, _name: "DUP"}));
      const jump_idx_10043 = Compiler$emit_idx(s, ({_tag: 38, _name: "JUMP_IF_FALSE", _val: 0}));
      Compiler$emit(s, ({_tag: 1, _name: "POP"}));
      Compiler$compile_expr(false, s, e2);
      const target_10045 = Compiler$current_offset(s);
      const _t10046 = Compiler$patch(s, jump_idx_10043, ({_tag: 38, _name: "JUMP_IF_FALSE", _val: target_10045}));
      const _t10044 = _t10046;
      _t10041 = _t10044;
      break _t10042;
    }
    if (_t10040._tag === 12) {
      Compiler$compile_expr(false, s, e1);
      Compiler$emit(s, ({_tag: 2, _name: "DUP"}));
      const jump_idx_10047 = Compiler$emit_idx(s, ({_tag: 39, _name: "JUMP_IF_TRUE", _val: 0}));
      Compiler$emit(s, ({_tag: 1, _name: "POP"}));
      Compiler$compile_expr(false, s, e2);
      const target_10049 = Compiler$current_offset(s);
      const _t10050 = Compiler$patch(s, jump_idx_10047, ({_tag: 39, _name: "JUMP_IF_TRUE", _val: target_10049}));
      const _t10048 = _t10050;
      _t10041 = _t10048;
      break _t10042;
    }
    if ((((_t10040._tag === 0 || _t10040._tag === 1) || _t10040._tag === 2) || _t10040._tag === 3)) {
      const resolved_10051 = Types$repr(e1.ty);
      let _t10054;
      const _t10053 = resolved_10051;
      _t10055: {
        if (_t10053._tag === 0) {
          Compiler$compile_expr(false, s, e1);
          Compiler$compile_expr(false, s, e2);
          let _t10057;
          const _t10056 = op;
          _t10058: {
            if (_t10056._tag === 0) {
              _t10057 = ({_tag: 13, _name: "ADD"});
              break _t10058;
            }
            if (_t10056._tag === 1) {
              _t10057 = ({_tag: 14, _name: "SUB"});
              break _t10058;
            }
            if (_t10056._tag === 2) {
              _t10057 = ({_tag: 15, _name: "MUL"});
              break _t10058;
            }
            if (_t10056._tag === 3) {
              _t10057 = ({_tag: 16, _name: "DIV"});
              break _t10058;
            }
            if (true) {
              _t10057 = failwith("assert false");
              break _t10058;
            }
            _match_fail("line 15950");
          }
          _t10054 = Compiler$emit(s, _t10057);
          break _t10055;
        }
        if (_t10053._tag === 1) {
          Compiler$compile_expr(false, s, e1);
          Compiler$compile_expr(false, s, e2);
          let _t10060;
          const _t10059 = op;
          _t10061: {
            if (_t10059._tag === 0) {
              _t10060 = ({_tag: 19, _name: "FADD"});
              break _t10061;
            }
            if (_t10059._tag === 1) {
              _t10060 = ({_tag: 20, _name: "FSUB"});
              break _t10061;
            }
            if (_t10059._tag === 2) {
              _t10060 = ({_tag: 21, _name: "FMUL"});
              break _t10061;
            }
            if (_t10059._tag === 3) {
              _t10060 = ({_tag: 22, _name: "FDIV"});
              break _t10061;
            }
            if (true) {
              _t10060 = failwith("assert false");
              break _t10061;
            }
            _match_fail("line 15950");
          }
          _t10054 = Compiler$emit(s, _t10060);
          break _t10055;
        }
        if (true) {
          let _t10063;
          const _t10062 = op;
          _t10064: {
            if (_t10062._tag === 0) {
              _t10063 = "+";
              break _t10064;
            }
            if (_t10062._tag === 1) {
              _t10063 = "-";
              break _t10064;
            }
            if (_t10062._tag === 2) {
              _t10063 = "*";
              break _t10064;
            }
            if (_t10062._tag === 3) {
              _t10063 = "/";
              break _t10064;
            }
            if (true) {
              _t10063 = failwith("assert false");
              break _t10064;
            }
            _match_fail("line 15950");
          }
          const method_name_10065 = _t10063;
          const _t10066 = Compiler$compile_class_binop(s, "Num", method_name_10065, e1.ty, e1, e2);
          _t10054 = _t10066;
          break _t10055;
        }
        _match_fail("line 15950");
      }
      const _t10052 = _t10054;
      _t10041 = _t10052;
      break _t10042;
    }
    if (_t10040._tag === 4) {
      Compiler$compile_expr(false, s, e1);
      Compiler$compile_expr(false, s, e2);
      _t10041 = Compiler$emit(s, ({_tag: 17, _name: "MOD"}));
      break _t10042;
    }
    if ((_t10040._tag === 5 || _t10040._tag === 6)) {
      const resolved_10067 = Types$repr(e1.ty);
      function _t10069(class_name, ty) {
        function _t10070(inst) {
          return ((inst.inst_class === class_name) && ((List$length(inst.inst_tys) === 1) && Types$match_partial_inst(inst.inst_tys, ({_hd: ({_tag: 1, _name: "Some", _val: ty}), _tl: null}))));
        }
        return List$exists(_t10070, s.type_env.instances);
      }
      const has_custom_instance_10071 = _t10069;
      let _t10074;
      const _t10073 = resolved_10067;
      _t10075: {
        if ((((((((((((((_t10073._tag === 0 || _t10073._tag === 1) || _t10073._tag === 2) || _t10073._tag === 3) || _t10073._tag === 4) || _t10073._tag === 5) || _t10073._tag === 6) || _t10073._tag === 10) || _t10073._tag === 9) || _t10073._tag === 12) || _t10073._tag === 15) || _t10073._tag === 13) || _t10073._tag === 14) || _t10073._tag === 16 && _t10073._val.contents._tag === 0)) {
          _t10074 = true;
          break _t10075;
        }
        if (_t10073._tag === 11) {
          _t10074 = (!has_custom_instance_10071("Eq", resolved_10067));
          break _t10075;
        }
        if (true) {
          _t10074 = false;
          break _t10075;
        }
        _match_fail("line 15950");
      }
      const use_structural_10076 = _t10074;
      let _t10078;
      if (use_structural_10076) {
        Compiler$compile_expr(false, s, e1);
        Compiler$compile_expr(false, s, e2);
        let _t10079;
        if (_eq(op, ({_tag: 5, _name: "Eq"}))) {
          _t10079 = ({_tag: 24, _name: "EQ"});
        } else {
          _t10079 = ({_tag: 25, _name: "NEQ"});
        }
        _t10078 = Compiler$emit(s, _t10079);
      } else {
        let _t10080;
        if (_eq(op, ({_tag: 5, _name: "Eq"}))) {
          _t10080 = "=";
        } else {
          _t10080 = "<>";
        }
        const method_name_10081 = _t10080;
        const _t10082 = Compiler$compile_class_binop(s, "Eq", method_name_10081, e1.ty, e1, e2);
        _t10078 = _t10082;
      }
      const _t10077 = _t10078;
      const _t10072 = _t10077;
      const _t10068 = _t10072;
      _t10041 = _t10068;
      break _t10042;
    }
    if ((((_t10040._tag === 7 || _t10040._tag === 8) || _t10040._tag === 9) || _t10040._tag === 10)) {
      const resolved_10083 = Types$repr(e1.ty);
      let _t10086;
      const _t10085 = resolved_10083;
      _t10087: {
        if ((((((_t10085._tag === 0 || _t10085._tag === 1) || _t10085._tag === 3) || _t10085._tag === 4) || _t10085._tag === 5) || _t10085._tag === 16 && _t10085._val.contents._tag === 0)) {
          _t10086 = true;
          break _t10087;
        }
        if (true) {
          _t10086 = false;
          break _t10087;
        }
        _match_fail("line 15950");
      }
      const is_builtin_10088 = _t10086;
      let _t10090;
      if (is_builtin_10088) {
        Compiler$compile_expr(false, s, e1);
        Compiler$compile_expr(false, s, e2);
        let _t10092;
        const _t10091 = op;
        _t10093: {
          if (_t10091._tag === 7) {
            _t10092 = ({_tag: 26, _name: "LT"});
            break _t10093;
          }
          if (_t10091._tag === 8) {
            _t10092 = ({_tag: 27, _name: "GT"});
            break _t10093;
          }
          if (_t10091._tag === 9) {
            _t10092 = ({_tag: 28, _name: "LE"});
            break _t10093;
          }
          if (_t10091._tag === 10) {
            _t10092 = ({_tag: 29, _name: "GE"});
            break _t10093;
          }
          if (true) {
            _t10092 = failwith("assert false");
            break _t10093;
          }
          _match_fail("line 15950");
        }
        _t10090 = Compiler$emit(s, _t10092);
      } else {
        let _t10095;
        const _t10094 = op;
        _t10096: {
          if (_t10094._tag === 7) {
            _t10095 = "<";
            break _t10096;
          }
          if (_t10094._tag === 8) {
            _t10095 = ">";
            break _t10096;
          }
          if (_t10094._tag === 9) {
            _t10095 = "<=";
            break _t10096;
          }
          if (_t10094._tag === 10) {
            _t10095 = ">=";
            break _t10096;
          }
          if (true) {
            _t10095 = failwith("assert false");
            break _t10096;
          }
          _match_fail("line 15950");
        }
        const method_name_10097 = _t10095;
        const _t10098 = Compiler$compile_class_binop(s, "Ord", method_name_10097, e1.ty, e1, e2);
        _t10090 = _t10098;
      }
      const _t10089 = _t10090;
      const _t10084 = _t10089;
      _t10041 = _t10084;
      break _t10042;
    }
    if (_t10040._tag === 13) {
      const gidx_10099 = Compiler$find_or_add_global(s, "^");
      Compiler$emit(s, ({_tag: 10, _name: "GET_GLOBAL", _val: gidx_10099}));
      Compiler$compile_expr(false, s, e1);
      Compiler$emit(s, ({_tag: 42, _name: "CALL", _val: 1}));
      Compiler$compile_expr(false, s, e2);
      const _t10100 = Compiler$emit(s, ({_tag: 42, _name: "CALL", _val: 1}));
      _t10041 = _t10100;
      break _t10042;
    }
    if (((((_t10040._tag === 14 || _t10040._tag === 15) || _t10040._tag === 16) || _t10040._tag === 17) || _t10040._tag === 18)) {
      const resolved_10101 = Types$repr(e1.ty);
      let _t10104;
      const _t10103 = resolved_10101;
      _t10105: {
        if (_t10103._tag === 0) {
          Compiler$compile_expr(false, s, e1);
          Compiler$compile_expr(false, s, e2);
          let _t10107;
          const _t10106 = op;
          _t10108: {
            if (_t10106._tag === 14) {
              _t10107 = ({_tag: 31, _name: "BAND"});
              break _t10108;
            }
            if (_t10106._tag === 15) {
              _t10107 = ({_tag: 32, _name: "BOR"});
              break _t10108;
            }
            if (_t10106._tag === 16) {
              _t10107 = ({_tag: 33, _name: "BXOR"});
              break _t10108;
            }
            if (_t10106._tag === 17) {
              _t10107 = ({_tag: 35, _name: "BSHL"});
              break _t10108;
            }
            if (_t10106._tag === 18) {
              _t10107 = ({_tag: 36, _name: "BSHR"});
              break _t10108;
            }
            if (true) {
              _t10107 = failwith("assert false");
              break _t10108;
            }
            _match_fail("line 15950");
          }
          _t10104 = Compiler$emit(s, _t10107);
          break _t10105;
        }
        if (true) {
          let _t10110;
          const _t10109 = op;
          _t10111: {
            if (_t10109._tag === 14) {
              _t10110 = "land";
              break _t10111;
            }
            if (_t10109._tag === 15) {
              _t10110 = "lor";
              break _t10111;
            }
            if (_t10109._tag === 16) {
              _t10110 = "lxor";
              break _t10111;
            }
            if (_t10109._tag === 17) {
              _t10110 = "lsl";
              break _t10111;
            }
            if (_t10109._tag === 18) {
              _t10110 = "lsr";
              break _t10111;
            }
            if (true) {
              _t10110 = failwith("assert false");
              break _t10111;
            }
            _match_fail("line 15950");
          }
          const method_name_10112 = _t10110;
          const _t10113 = Compiler$compile_class_binop(s, "Bitwise", method_name_10112, e1.ty, e1, e2);
          _t10104 = _t10113;
          break _t10105;
        }
        _match_fail("line 15950");
      }
      const _t10102 = _t10104;
      _t10041 = _t10102;
      break _t10042;
    }
    if (_t10040._tag === 19) {
      Compiler$compile_expr(false, s, e2);
      Compiler$compile_expr(false, s, e1);
      _t10041 = Compiler$emit(s, ({_tag: 42, _name: "CALL", _val: 1}));
      break _t10042;
    }
    _match_fail("line 15950");
  }
  return _t10041;
}
function Compiler$compile_class_binop(s, class_name, method_name, operand_ty, e1, e2) {
  const conc_ty_10114 = Types$repr(operand_ty);
  function _t10116(c) {
    return (c.class_name === class_name);
  }
  let _t10118;
  const _t10117 = List$find(_t10116, s.type_env.classes);
  _t10119: {
    if (_t10117._tag === 1) {
      const cd = _t10117._val;
      _t10118 = cd;
      break _t10119;
    }
    if (_t10117._tag === 0) {
      _t10118 = Compiler$error((("class " + __dict_Show_string.show(class_name)) + " not found"));
      break _t10119;
    }
    _match_fail("line 15950");
  }
  const class_def_10120 = _t10118;
  const num_params_10122 = List$length(class_def_10120.class_params);
  function _t10124(_) {
    return ({_tag: 1, _name: "Some", _val: conc_ty_10114});
  }
  const partial_10125 = List$init(num_params_10122, _t10124);
  function _t10127(opt) {
    let _t10129;
    const _t10128 = opt;
    _t10130: {
      if (_t10128._tag === 1) {
        const ty = _t10128._val;
        let _t10132;
        const _t10131 = Types$repr(ty);
        _t10133: {
          if (_t10131._tag === 16 && _t10131._val.contents._tag === 0) {
            _t10132 = ({_tag: 0, _name: "None"});
            break _t10133;
          }
          if (true) {
            _t10132 = ({_tag: 1, _name: "Some", _val: Types$repr(ty)});
            break _t10133;
          }
          _match_fail("line 15950");
        }
        _t10129 = _t10132;
        break _t10130;
      }
      if (_t10128._tag === 0) {
        _t10129 = ({_tag: 0, _name: "None"});
        break _t10130;
      }
      _match_fail("line 15950");
    }
    return _t10129;
  }
  const concrete_partial_10134 = List$map(_t10127, partial_10125);
  function _t10136(inst) {
    return ((inst.inst_class === class_name) && ((List$length(inst.inst_tys) === num_params_10122) && Types$match_partial_inst(inst.inst_tys, concrete_partial_10134)));
  }
  const matching_10137 = List$filter(_t10136, s.type_env.instances);
  let _t10140;
  const _t10139 = matching_10137;
  _t10141: {
    if (_t10139 !== null && _t10139._tl === null) {
      const inst = _t10139._hd;
      let _t10142;
      if (_eq(inst.inst_constraints, null)) {
        const method_gidx_10143 = Compiler$find_or_add_global(s, (inst.inst_dict_name + ("$" + method_name)));
        const _t10144 = Compiler$emit(s, ({_tag: 10, _name: "GET_GLOBAL", _val: method_gidx_10143}));
        _t10142 = _t10144;
      } else {
        const dict_gidx_10145 = Compiler$find_or_add_global(s, inst.inst_dict_name);
        Compiler$emit(s, ({_tag: 10, _name: "GET_GLOBAL", _val: dict_gidx_10145}));
        const _t10146 = Compiler$emit(s, ({_tag: 51, _name: "FIELD", _val: method_name}));
        _t10142 = _t10146;
      }
      _t10142;
      Compiler$compile_expr(false, s, e1);
      Compiler$emit(s, ({_tag: 42, _name: "CALL", _val: 1}));
      Compiler$compile_expr(false, s, e2);
      _t10140 = Compiler$emit(s, ({_tag: 42, _name: "CALL", _val: 1}));
      break _t10141;
    }
    if (_t10139 === null) {
      _t10140 = Compiler$error(((("no instance of " + __dict_Show_string.show(class_name)) + " for type ") + __dict_Show_string.show(Types$pp_ty(conc_ty_10114))));
      break _t10141;
    }
    if (true) {
      _t10140 = Compiler$error(((("ambiguous instance for " + __dict_Show_string.show(class_name)) + " method ") + __dict_Show_string.show(method_name)));
      break _t10141;
    }
    _match_fail("line 15950");
  }
  const _t10138 = _t10140;
  const _t10135 = _t10138;
  const _t10126 = _t10135;
  const _t10123 = _t10126;
  const _t10121 = _t10123;
  const _t10115 = _t10121;
  return _t10115;
}
function Compiler$compile_class_unop(s, class_name, method_name, operand_ty, e) {
  const conc_ty_10147 = Types$repr(operand_ty);
  function _t10149(c) {
    return (c.class_name === class_name);
  }
  let _t10151;
  const _t10150 = List$find(_t10149, s.type_env.classes);
  _t10152: {
    if (_t10150._tag === 1) {
      const cd = _t10150._val;
      _t10151 = cd;
      break _t10152;
    }
    if (_t10150._tag === 0) {
      _t10151 = Compiler$error((("class " + __dict_Show_string.show(class_name)) + " not found"));
      break _t10152;
    }
    _match_fail("line 15950");
  }
  const class_def_10153 = _t10151;
  const num_params_10155 = List$length(class_def_10153.class_params);
  function _t10157(_) {
    return ({_tag: 1, _name: "Some", _val: conc_ty_10147});
  }
  const partial_10158 = List$init(num_params_10155, _t10157);
  function _t10160(opt) {
    let _t10162;
    const _t10161 = opt;
    _t10163: {
      if (_t10161._tag === 1) {
        const ty = _t10161._val;
        let _t10165;
        const _t10164 = Types$repr(ty);
        _t10166: {
          if (_t10164._tag === 16 && _t10164._val.contents._tag === 0) {
            _t10165 = ({_tag: 0, _name: "None"});
            break _t10166;
          }
          if (true) {
            _t10165 = ({_tag: 1, _name: "Some", _val: Types$repr(ty)});
            break _t10166;
          }
          _match_fail("line 15950");
        }
        _t10162 = _t10165;
        break _t10163;
      }
      if (_t10161._tag === 0) {
        _t10162 = ({_tag: 0, _name: "None"});
        break _t10163;
      }
      _match_fail("line 15950");
    }
    return _t10162;
  }
  const concrete_partial_10167 = List$map(_t10160, partial_10158);
  function _t10169(inst) {
    return ((inst.inst_class === class_name) && ((List$length(inst.inst_tys) === num_params_10155) && Types$match_partial_inst(inst.inst_tys, concrete_partial_10167)));
  }
  const matching_10170 = List$filter(_t10169, s.type_env.instances);
  let _t10173;
  const _t10172 = matching_10170;
  _t10174: {
    if (_t10172 !== null && _t10172._tl === null) {
      const inst = _t10172._hd;
      let _t10175;
      if (_eq(inst.inst_constraints, null)) {
        const method_gidx_10176 = Compiler$find_or_add_global(s, (inst.inst_dict_name + ("$" + method_name)));
        const _t10177 = Compiler$emit(s, ({_tag: 10, _name: "GET_GLOBAL", _val: method_gidx_10176}));
        _t10175 = _t10177;
      } else {
        const dict_gidx_10178 = Compiler$find_or_add_global(s, inst.inst_dict_name);
        Compiler$emit(s, ({_tag: 10, _name: "GET_GLOBAL", _val: dict_gidx_10178}));
        const _t10179 = Compiler$emit(s, ({_tag: 51, _name: "FIELD", _val: method_name}));
        _t10175 = _t10179;
      }
      _t10175;
      Compiler$compile_expr(false, s, e);
      _t10173 = Compiler$emit(s, ({_tag: 42, _name: "CALL", _val: 1}));
      break _t10174;
    }
    if (_t10172 === null) {
      _t10173 = Compiler$error(((("no instance of " + __dict_Show_string.show(class_name)) + " for type ") + __dict_Show_string.show(Types$pp_ty(conc_ty_10147))));
      break _t10174;
    }
    if (true) {
      _t10173 = Compiler$error(((("ambiguous instance for " + __dict_Show_string.show(class_name)) + " method ") + __dict_Show_string.show(method_name)));
      break _t10174;
    }
    _match_fail("line 15950");
  }
  const _t10171 = _t10173;
  const _t10168 = _t10171;
  const _t10159 = _t10168;
  const _t10156 = _t10159;
  const _t10154 = _t10156;
  const _t10148 = _t10154;
  return _t10148;
}
function Compiler$compile_unop(s, op, e) {
  let _t10181;
  const _t10180 = op;
  _t10182: {
    if (_t10180._tag === 0) {
      const resolved_10183 = Types$repr(e.ty);
      let _t10186;
      const _t10185 = resolved_10183;
      _t10187: {
        if (_t10185._tag === 0) {
          Compiler$compile_expr(false, s, e);
          _t10186 = Compiler$emit(s, ({_tag: 18, _name: "NEG"}));
          break _t10187;
        }
        if (_t10185._tag === 1) {
          Compiler$compile_expr(false, s, e);
          _t10186 = Compiler$emit(s, ({_tag: 23, _name: "FNEG"}));
          break _t10187;
        }
        if (true) {
          _t10186 = Compiler$compile_class_unop(s, "Num", "neg", e.ty, e);
          break _t10187;
        }
        _match_fail("line 15950");
      }
      const _t10184 = _t10186;
      _t10181 = _t10184;
      break _t10182;
    }
    if (_t10180._tag === 1) {
      Compiler$compile_expr(false, s, e);
      _t10181 = Compiler$emit(s, ({_tag: 30, _name: "NOT"}));
      break _t10182;
    }
    if (_t10180._tag === 2) {
      const resolved_10188 = Types$repr(e.ty);
      let _t10191;
      const _t10190 = resolved_10188;
      _t10192: {
        if (_t10190._tag === 0) {
          Compiler$compile_expr(false, s, e);
          _t10191 = Compiler$emit(s, ({_tag: 34, _name: "BNOT"}));
          break _t10192;
        }
        if (true) {
          _t10191 = Compiler$compile_class_unop(s, "Bitwise", "lnot", e.ty, e);
          break _t10192;
        }
        _match_fail("line 15950");
      }
      const _t10189 = _t10191;
      _t10181 = _t10189;
      break _t10182;
    }
    _match_fail("line 15950");
  }
  return _t10181;
}
function Compiler$compile_if(tail, s, cond, then_e, else_e) {
  Compiler$compile_expr(false, s, cond);
  const else_jump_10193 = Compiler$emit_idx(s, ({_tag: 38, _name: "JUMP_IF_FALSE", _val: 0}));
  Compiler$compile_expr(tail, s, then_e);
  const end_jump_10195 = Compiler$emit_idx(s, ({_tag: 37, _name: "JUMP", _val: 0}));
  const else_target_10197 = Compiler$current_offset(s);
  Compiler$patch(s, else_jump_10193, ({_tag: 38, _name: "JUMP_IF_FALSE", _val: else_target_10197}));
  Compiler$compile_expr(tail, s, else_e);
  const end_target_10199 = Compiler$current_offset(s);
  const _t10200 = Compiler$patch(s, end_jump_10195, ({_tag: 37, _name: "JUMP", _val: end_target_10199}));
  const _t10198 = _t10200;
  const _t10196 = _t10198;
  const _t10194 = _t10196;
  return _t10194;
}
function Compiler$compile_function(has_return, s, param_name, body, _fn_ty) {
  function collect_params(params, body_expr, hr) {
    while (true) {
      let _t10202;
      const _t10201 = body_expr.expr;
      _t10203: {
        if (_t10201._tag === 10) {
          const p = _t10201._val[0];
          const inner = _t10201._val[1];
          const inner_hr = _t10201._val[2];
          const _t10204 = ({_hd: p, _tl: params});
          const _t10205 = inner;
          const _t10206 = (hr || inner_hr);
          params = _t10204;
          body_expr = _t10205;
          hr = _t10206;
          continue;
          _t10202 = undefined;
          break _t10203;
        }
        if (true) {
          _t10202 = [List$rev(params), body_expr, hr];
          break _t10203;
        }
        _match_fail("line 15950");
      }
      return _t10202;
    }
  }
  let _t10209;
  const _t10208 = collect_params(null, body, has_return);
  _t10210: {
    if (true) {
      const extra_params = _t10208[0];
      const final_body = _t10208[1];
      const combined_hr = _t10208[2];
      const all_params_10211 = ({_hd: param_name, _tl: extra_params});
      const arity_10213 = List$length(all_params_10211);
      const sub_10215 = Compiler$create_state(({_tag: 1, _name: "Some", _val: s}), arity_10213, s.global_names, s.mutable_globals, s.type_env, param_name);
      function _t10217(p) {
        Compiler$allocate_local(sub_10215, p);
        return undefined;
      }
      List$iter(_t10217, all_params_10211);
      let _t10218;
      if (combined_hr) {
        _t10218 = Compiler$emit(sub_10215, ({_tag: 46, _name: "ENTER_FUNC"}));
      } else {
        _t10218 = undefined;
      }
      _t10218;
      Compiler$compile_expr((!combined_hr), sub_10215, final_body);
      let _t10219;
      if (combined_hr) {
        _t10219 = Compiler$emit(sub_10215, ({_tag: 47, _name: "EXIT_FUNC"}));
      } else {
        _t10219 = undefined;
      }
      _t10219;
      Compiler$emit(sub_10215, ({_tag: 44, _name: "RETURN"}));
      const proto_10220 = Compiler$finalize_proto(sub_10215);
      const proto_idx_10222 = Compiler$add_constant(s, ({_tag: 13, _name: "VProto", _val: proto_10220}));
      function _t10224(uv) {
        return uv.capture;
      }
      const captures_10225 = List$map(_t10224, sub_10215.upvalues);
      const _t10226 = Compiler$emit(s, ({_tag: 40, _name: "CLOSURE", _val: [proto_idx_10222, captures_10225]}));
      const _t10223 = _t10226;
      const _t10221 = _t10223;
      const _t10216 = _t10221;
      const _t10214 = _t10216;
      const _t10212 = _t10214;
      _t10209 = _t10212;
      break _t10210;
    }
    _match_fail("line 15950");
  }
  const _t10207 = _t10209;
  return _t10207;
}
function Compiler$count_arrows(ty) {
  let _t10228;
  const _t10227 = Types$repr(ty);
  _t10229: {
    if ((_t10227._tag === 7 || _t10227._tag === 8)) {
      const r = _t10227._val[2];
      _t10228 = (1 + Compiler$count_arrows(r));
      break _t10229;
    }
    if (true) {
      _t10228 = 0;
      break _t10229;
    }
    _match_fail("line 15950");
  }
  return _t10228;
}
function Compiler$finalize_proto(s) {
  return ({arity: s.arity, code: Dynarray$to_array(s.code), constants: Dynarray$to_array(s.constants), line_table: Dynarray$to_array(s.lines), name: s.proto_name, num_locals: s.max_locals});
}
function Compiler$compile_let_rec(s, name, fn_expr) {
  const slot_10230 = Compiler$allocate_local(s, name);
  let _t10233;
  const _t10232 = fn_expr.expr;
  _t10234: {
    if (_t10232._tag === 10) {
      const param = _t10232._val[0];
      const body = _t10232._val[1];
      const has_return = _t10232._val[2];
      function collect_params(params, body_expr, hr) {
        while (true) {
          let _t10236;
          const _t10235 = body_expr.expr;
          _t10237: {
            if (_t10235._tag === 10) {
              const p = _t10235._val[0];
              const inner = _t10235._val[1];
              const inner_hr = _t10235._val[2];
              const _t10238 = ({_hd: p, _tl: params});
              const _t10239 = inner;
              const _t10240 = (hr || inner_hr);
              params = _t10238;
              body_expr = _t10239;
              hr = _t10240;
              continue;
              _t10236 = undefined;
              break _t10237;
            }
            if (true) {
              _t10236 = [List$rev(params), body_expr, hr];
              break _t10237;
            }
            _match_fail("line 15950");
          }
          return _t10236;
        }
      }
      let _t10243;
      const _t10242 = collect_params(null, body, has_return);
      _t10244: {
        if (true) {
          const extra_params = _t10242[0];
          const final_body = _t10242[1];
          const combined_hr = _t10242[2];
          const all_params_10245 = ({_hd: param, _tl: extra_params});
          const arity_10247 = List$length(all_params_10245);
          const sub_10249 = Compiler$create_state(({_tag: 1, _name: "Some", _val: s}), arity_10247, s.global_names, s.mutable_globals, s.type_env, name);
          function _t10251(p) {
            Compiler$allocate_local(sub_10249, p);
            return undefined;
          }
          List$iter(_t10251, all_params_10245);
          let _t10252;
          if (combined_hr) {
            _t10252 = Compiler$emit(sub_10249, ({_tag: 46, _name: "ENTER_FUNC"}));
          } else {
            _t10252 = undefined;
          }
          _t10252;
          Compiler$compile_expr((!combined_hr), sub_10249, final_body);
          let _t10253;
          if (combined_hr) {
            _t10253 = Compiler$emit(sub_10249, ({_tag: 47, _name: "EXIT_FUNC"}));
          } else {
            _t10253 = undefined;
          }
          _t10253;
          Compiler$emit(sub_10249, ({_tag: 44, _name: "RETURN"}));
          const proto_10254 = Compiler$finalize_proto(sub_10249);
          const proto_idx_10256 = Compiler$add_constant(s, ({_tag: 13, _name: "VProto", _val: proto_10254}));
          function _t10258(uv) {
            return uv.capture;
          }
          const captures_10259 = List$map(_t10258, sub_10249.upvalues);
          function _t10261(__p323) {
            let _t10263;
            const _t10262 = __p323;
            _t10264: {
              if (true) {
                const i = _t10262[0];
                const uv = _t10262[1];
                let _t10265;
                if ((uv.uv_name === name)) {
                  _t10265 = ({_tag: 1, _name: "Some", _val: i});
                } else {
                  _t10265 = ({_tag: 0, _name: "None"});
                }
                _t10263 = _t10265;
                break _t10264;
              }
              _match_fail("line 15950");
            }
            return _t10263;
          }
          function _t10266(i, uv) {
            return [i, uv];
          }
          const self_idx_10267 = List$find_map(_t10261, List$mapi(_t10266, sub_10249.upvalues));
          let _t10270;
          const _t10269 = self_idx_10267;
          _t10271: {
            if (_t10269._tag === 1) {
              const si = _t10269._val;
              _t10270 = Compiler$emit(s, ({_tag: 41, _name: "CLOSURE_REC", _val: [proto_idx_10256, captures_10259, si]}));
              break _t10271;
            }
            if (_t10269._tag === 0) {
              _t10270 = Compiler$emit(s, ({_tag: 40, _name: "CLOSURE", _val: [proto_idx_10256, captures_10259]}));
              break _t10271;
            }
            _match_fail("line 15950");
          }
          _t10270;
          const _t10268 = Compiler$emit(s, ({_tag: 4, _name: "SET_LOCAL", _val: slot_10230}));
          const _t10260 = _t10268;
          const _t10257 = _t10260;
          const _t10255 = _t10257;
          const _t10250 = _t10255;
          const _t10248 = _t10250;
          const _t10246 = _t10248;
          _t10243 = _t10246;
          break _t10244;
        }
        _match_fail("line 15950");
      }
      const _t10241 = _t10243;
      _t10233 = _t10241;
      break _t10234;
    }
    if (true) {
      _t10233 = Compiler$error("let rec must bind a function");
      break _t10234;
    }
    _match_fail("line 15950");
  }
  const _t10231 = _t10233;
  return _t10231;
}
function Compiler$compile_match(tail, s, scrut, arms) {
  Compiler$compile_expr(false, s, scrut);
  const scrut_slot_10272 = Compiler$allocate_local(s, "_match_scrut");
  Compiler$emit(s, ({_tag: 4, _name: "SET_LOCAL", _val: scrut_slot_10272}));
  const end_jumps_10274 = Ref$create(null);
  function _t10276(__p324) {
    let _t10278;
    const _t10277 = __p324;
    _t10279: {
      if (true) {
        const pat = _t10277[0];
        const guard = _t10277[1];
        const body = _t10277[2];
        const saved_num_locals_10280 = s.num_locals;
        const saved_locals_10282 = s.locals;
        const fail_jumps_10284 = Ref$create(null);
        Compiler$compile_pattern(s, scrut_slot_10272, pat, fail_jumps_10284);
        let _t10287;
        const _t10286 = guard;
        _t10288: {
          if (_t10286._tag === 1) {
            const guard_te = _t10286._val;
            Compiler$compile_expr(false, s, guard_te);
            _t10287 = Ref$set(fail_jumps_10284, ({_hd: Compiler$emit_idx(s, ({_tag: 38, _name: "JUMP_IF_FALSE", _val: 0})), _tl: Ref$get(fail_jumps_10284)}));
            break _t10288;
          }
          if (_t10286._tag === 0) {
            _t10287 = undefined;
            break _t10288;
          }
          _match_fail("line 15950");
        }
        _t10287;
        Compiler$compile_expr(tail, s, body);
        (s.num_locals = saved_num_locals_10280, undefined);
        (s.locals = saved_locals_10282, undefined);
        Ref$set(end_jumps_10274, ({_hd: Compiler$emit_idx(s, ({_tag: 37, _name: "JUMP", _val: 0})), _tl: Ref$get(end_jumps_10274)}));
        const target_10289 = Compiler$current_offset(s);
        function _t10291(idx) {
          return Compiler$patch(s, idx, ({_tag: 38, _name: "JUMP_IF_FALSE", _val: target_10289}));
        }
        const _t10290 = List$iter(_t10291, Ref$get(fail_jumps_10284));
        const _t10285 = _t10290;
        const _t10283 = _t10285;
        const _t10281 = _t10283;
        _t10278 = _t10281;
        break _t10279;
      }
      _match_fail("line 15950");
    }
    return _t10278;
  }
  List$iter(_t10276, arms);
  const loc_str_10292 = ("line " + __dict_Show_int.show(scrut.loc.line));
  Compiler$emit(s, ({_tag: 64, _name: "MATCH_FAIL", _val: loc_str_10292}));
  const end_target_10294 = Compiler$current_offset(s);
  function _t10296(idx) {
    return Compiler$patch(s, idx, ({_tag: 37, _name: "JUMP", _val: end_target_10294}));
  }
  List$iter(_t10296, Ref$get(end_jumps_10274));
  const _t10295 = Compiler$free_local(s);
  const _t10293 = _t10295;
  const _t10275 = _t10293;
  const _t10273 = _t10275;
  return _t10273;
}
function Compiler$compile_pattern(s, slot, pat, fail_jumps) {
  while (true) {
    let _t10298;
    const _t10297 = pat;
    _t10299: {
      if (_t10297._tag === 0) {
        _t10298 = undefined;
        break _t10299;
      }
      if (_t10297._tag === 1) {
        const name = _t10297._val;
        const var_slot_10300 = Compiler$allocate_local(s, name);
        Compiler$emit(s, ({_tag: 3, _name: "GET_LOCAL", _val: slot}));
        const _t10301 = Compiler$emit(s, ({_tag: 4, _name: "SET_LOCAL", _val: var_slot_10300}));
        _t10298 = _t10301;
        break _t10299;
      }
      if (_t10297._tag === 2) {
        const n = _t10297._val;
        Compiler$emit(s, ({_tag: 3, _name: "GET_LOCAL", _val: slot}));
        Compiler$emit_constant(s, ({_tag: 0, _name: "VInt", _val: n}));
        Compiler$emit(s, ({_tag: 24, _name: "EQ"}));
        _t10298 = Ref$set(fail_jumps, ({_hd: Compiler$emit_idx(s, ({_tag: 38, _name: "JUMP_IF_FALSE", _val: 0})), _tl: Ref$get(fail_jumps)}));
        break _t10299;
      }
      if (_t10297._tag === 3) {
        const f = _t10297._val;
        Compiler$emit(s, ({_tag: 3, _name: "GET_LOCAL", _val: slot}));
        Compiler$emit_constant(s, ({_tag: 1, _name: "VFloat", _val: f}));
        Compiler$emit(s, ({_tag: 24, _name: "EQ"}));
        _t10298 = Ref$set(fail_jumps, ({_hd: Compiler$emit_idx(s, ({_tag: 38, _name: "JUMP_IF_FALSE", _val: 0})), _tl: Ref$get(fail_jumps)}));
        break _t10299;
      }
      if (_t10297._tag === 4) {
        const b = _t10297._val;
        Compiler$emit(s, ({_tag: 3, _name: "GET_LOCAL", _val: slot}));
        Compiler$emit_constant(s, ({_tag: 2, _name: "VBool", _val: b}));
        Compiler$emit(s, ({_tag: 24, _name: "EQ"}));
        _t10298 = Ref$set(fail_jumps, ({_hd: Compiler$emit_idx(s, ({_tag: 38, _name: "JUMP_IF_FALSE", _val: 0})), _tl: Ref$get(fail_jumps)}));
        break _t10299;
      }
      if (_t10297._tag === 5) {
        const str = _t10297._val;
        Compiler$emit(s, ({_tag: 3, _name: "GET_LOCAL", _val: slot}));
        Compiler$emit_constant(s, ({_tag: 3, _name: "VString", _val: str}));
        Compiler$emit(s, ({_tag: 24, _name: "EQ"}));
        _t10298 = Ref$set(fail_jumps, ({_hd: Compiler$emit_idx(s, ({_tag: 38, _name: "JUMP_IF_FALSE", _val: 0})), _tl: Ref$get(fail_jumps)}));
        break _t10299;
      }
      if (_t10297._tag === 6) {
        _t10298 = undefined;
        break _t10299;
      }
      if (_t10297._tag === 9) {
        Compiler$emit(s, ({_tag: 3, _name: "GET_LOCAL", _val: slot}));
        Compiler$emit(s, ({_tag: 59, _name: "IS_NIL"}));
        _t10298 = Ref$set(fail_jumps, ({_hd: Compiler$emit_idx(s, ({_tag: 38, _name: "JUMP_IF_FALSE", _val: 0})), _tl: Ref$get(fail_jumps)}));
        break _t10299;
      }
      if (_t10297._tag === 8) {
        const hd_pat = _t10297._val[0];
        const tl_pat = _t10297._val[1];
        Compiler$emit(s, ({_tag: 3, _name: "GET_LOCAL", _val: slot}));
        Compiler$emit(s, ({_tag: 60, _name: "IS_CONS"}));
        Ref$set(fail_jumps, ({_hd: Compiler$emit_idx(s, ({_tag: 38, _name: "JUMP_IF_FALSE", _val: 0})), _tl: Ref$get(fail_jumps)}));
        const hd_slot_10302 = Compiler$allocate_local(s, "_hd");
        Compiler$emit(s, ({_tag: 3, _name: "GET_LOCAL", _val: slot}));
        Compiler$emit(s, ({_tag: 61, _name: "HEAD"}));
        Compiler$emit(s, ({_tag: 4, _name: "SET_LOCAL", _val: hd_slot_10302}));
        const tl_slot_10304 = Compiler$allocate_local(s, "_tl");
        Compiler$emit(s, ({_tag: 3, _name: "GET_LOCAL", _val: slot}));
        Compiler$emit(s, ({_tag: 62, _name: "TAIL"}));
        Compiler$emit(s, ({_tag: 4, _name: "SET_LOCAL", _val: tl_slot_10304}));
        Compiler$compile_pattern(s, hd_slot_10302, hd_pat, fail_jumps);
        const _t10306 = s;
        const _t10307 = tl_slot_10304;
        const _t10308 = tl_pat;
        const _t10309 = fail_jumps;
        s = _t10306;
        slot = _t10307;
        pat = _t10308;
        fail_jumps = _t10309;
        continue;
        const _t10305 = undefined;
        const _t10303 = _t10305;
        _t10298 = _t10303;
        break _t10299;
      }
      if (_t10297._tag === 10) {
        const name = _t10297._val[0];
        const arg_pat = _t10297._val[1];
        const tag_10310 = Compiler$tag_for_constructor(s.type_env, name);
        Compiler$emit(s, ({_tag: 3, _name: "GET_LOCAL", _val: slot}));
        Compiler$emit(s, ({_tag: 58, _name: "TAG_EQ", _val: tag_10310}));
        Ref$set(fail_jumps, ({_hd: Compiler$emit_idx(s, ({_tag: 38, _name: "JUMP_IF_FALSE", _val: 0})), _tl: Ref$get(fail_jumps)}));
        let _t10313;
        const _t10312 = arg_pat;
        _t10314: {
          if (_t10312._tag === 1) {
            const sub_pat = _t10312._val;
            const payload_slot_10315 = Compiler$allocate_local(s, "_payload");
            Compiler$emit(s, ({_tag: 3, _name: "GET_LOCAL", _val: slot}));
            Compiler$emit(s, ({_tag: 63, _name: "VARIANT_PAYLOAD"}));
            Compiler$emit(s, ({_tag: 4, _name: "SET_LOCAL", _val: payload_slot_10315}));
            const _t10317 = s;
            const _t10318 = payload_slot_10315;
            const _t10319 = sub_pat;
            const _t10320 = fail_jumps;
            s = _t10317;
            slot = _t10318;
            pat = _t10319;
            fail_jumps = _t10320;
            continue;
            const _t10316 = undefined;
            _t10313 = _t10316;
            break _t10314;
          }
          if (_t10312._tag === 0) {
            _t10313 = undefined;
            break _t10314;
          }
          _match_fail("line 15950");
        }
        const _t10311 = _t10313;
        _t10298 = _t10311;
        break _t10299;
      }
      if (_t10297._tag === 7) {
        const pats = _t10297._val;
        function _t10321(i, sub_pat) {
          const elem_slot_10322 = Compiler$allocate_local(s, "_tup");
          Compiler$emit(s, ({_tag: 3, _name: "GET_LOCAL", _val: slot}));
          Compiler$emit(s, ({_tag: 49, _name: "TUPLE_GET", _val: i}));
          Compiler$emit(s, ({_tag: 4, _name: "SET_LOCAL", _val: elem_slot_10322}));
          const _t10323 = Compiler$compile_pattern(s, elem_slot_10322, sub_pat, fail_jumps);
          return _t10323;
        }
        _t10298 = List$iteri(_t10321, pats);
        break _t10299;
      }
      if (_t10297._tag === 11) {
        const field_pats = _t10297._val;
        function _t10324(__p325) {
          let _t10326;
          const _t10325 = __p325;
          _t10327: {
            if (true) {
              const fname = _t10325[0];
              const sub_pat = _t10325[1];
              const field_slot_10328 = Compiler$allocate_local(s, "_fld");
              Compiler$emit(s, ({_tag: 3, _name: "GET_LOCAL", _val: slot}));
              Compiler$emit(s, ({_tag: 51, _name: "FIELD", _val: fname}));
              Compiler$emit(s, ({_tag: 4, _name: "SET_LOCAL", _val: field_slot_10328}));
              const _t10329 = Compiler$compile_pattern(s, field_slot_10328, sub_pat, fail_jumps);
              _t10326 = _t10329;
              break _t10327;
            }
            _match_fail("line 15950");
          }
          return _t10326;
        }
        _t10298 = List$iter(_t10324, field_pats);
        break _t10299;
      }
      if (_t10297._tag === 12) {
        const inner_pat = _t10297._val[0];
        const name = _t10297._val[1];
        Compiler$compile_pattern(s, slot, inner_pat, fail_jumps);
        const var_slot_10330 = Compiler$allocate_local(s, name);
        Compiler$emit(s, ({_tag: 3, _name: "GET_LOCAL", _val: slot}));
        const _t10331 = Compiler$emit(s, ({_tag: 4, _name: "SET_LOCAL", _val: var_slot_10330}));
        _t10298 = _t10331;
        break _t10299;
      }
      if (_t10297._tag === 13) {
        const p1 = _t10297._val[0];
        const p2 = _t10297._val[1];
        const saved_locals_10332 = s.locals;
        const saved_num_locals_10334 = s.num_locals;
        const or_fail_jumps_10336 = Ref$create(null);
        Compiler$compile_pattern(s, slot, p1, or_fail_jumps_10336);
        function _t10338(l) {
          let _t10339;
          if (((l.slot >= saved_num_locals_10334) && ((l.name !== "") && (String$get(l.name, 0) !== 95)))) {
            _t10339 = ({_tag: 1, _name: "Some", _val: [l.name, l.slot]});
          } else {
            _t10339 = ({_tag: 0, _name: "None"});
          }
          return _t10339;
        }
        const p1_bindings_10340 = List$filter_map(_t10338, s.locals);
        const success_jump_10342 = Compiler$emit_idx(s, ({_tag: 37, _name: "JUMP", _val: 0}));
        const p2_target_10344 = Compiler$current_offset(s);
        function _t10346(idx) {
          return Compiler$patch(s, idx, ({_tag: 38, _name: "JUMP_IF_FALSE", _val: p2_target_10344}));
        }
        List$iter(_t10346, Ref$get(or_fail_jumps_10336));
        (s.locals = saved_locals_10332, undefined);
        (s.num_locals = saved_num_locals_10334, undefined);
        Compiler$compile_pattern(s, slot, p2, fail_jumps);
        function _t10347(__p326) {
          let _t10349;
          const _t10348 = __p326;
          _t10350: {
            if (true) {
              const name = _t10348[0];
              const p1_slot = _t10348[1];
              function _t10351(l) {
                return ((l.name === name) && (l.slot >= saved_num_locals_10334));
              }
              let _t10353;
              const _t10352 = List$find(_t10351, s.locals);
              _t10354: {
                if (_t10352._tag === 1) {
                  const l = _t10352._val;
                  if ((l.slot !== p1_slot)) {
                    _t10353 = ({_tag: 1, _name: "Some", _val: [l.slot, p1_slot]});
                    break _t10354;
                  }
                }
                if (true) {
                  _t10353 = ({_tag: 0, _name: "None"});
                  break _t10354;
                }
                _match_fail("line 15950");
              }
              _t10349 = _t10353;
              break _t10350;
            }
            _match_fail("line 15950");
          }
          return _t10349;
        }
        const remaps_10355 = List$filter_map(_t10347, p1_bindings_10340);
        let _t10357;
        if (!_eq(remaps_10355, null)) {
          function _t10358(__p327) {
            let _t10360;
            const _t10359 = __p327;
            _t10361: {
              if (true) {
                const src = _t10359[0];
                const _dst = _t10359[1];
                const tmp_10362 = Compiler$allocate_local(s, "_or_tmp");
                Compiler$emit(s, ({_tag: 3, _name: "GET_LOCAL", _val: src}));
                Compiler$emit(s, ({_tag: 4, _name: "SET_LOCAL", _val: tmp_10362}));
                const _t10363 = tmp_10362;
                _t10360 = _t10363;
                break _t10361;
              }
              _match_fail("line 15950");
            }
            return _t10360;
          }
          const temps_10364 = List$map(_t10358, remaps_10355);
          function _t10366(tmp, __p328) {
            let _t10368;
            const _t10367 = __p328;
            _t10369: {
              if (true) {
                const _src = _t10367[0];
                const dst = _t10367[1];
                Compiler$emit(s, ({_tag: 3, _name: "GET_LOCAL", _val: tmp}));
                _t10368 = Compiler$emit(s, ({_tag: 4, _name: "SET_LOCAL", _val: dst}));
                break _t10369;
              }
              _match_fail("line 15950");
            }
            return _t10368;
          }
          const _t10365 = List$iter2(_t10366, temps_10364, remaps_10355);
          _t10357 = _t10365;
        } else {
          _t10357 = undefined;
        }
        _t10357;
        const success_target_10370 = Compiler$current_offset(s);
        Compiler$patch(s, success_jump_10342, ({_tag: 37, _name: "JUMP", _val: success_target_10370}));
        function _t10372(l) {
          let _t10377;
          if ((l.slot < saved_num_locals_10334)) {
            _t10377 = true;
          } else {
          function _t10373(__p329) {
            let _t10375;
            const _t10374 = __p329;
            _t10376: {
              if (true) {
                const n = _t10374[0];
                _t10375 = (n === l.name);
                break _t10376;
              }
              _match_fail("line 15950");
            }
            return _t10375;
          }
            _t10377 = List$exists(_t10373, p1_bindings_10340);
          }
          return _t10377;
        }
        const p2_only_locals_10378 = List$filter(_t10372, s.locals);
        function _t10380(l) {
          let _t10382;
          const _t10381 = List$assoc_opt(l.name, p1_bindings_10340);
          _t10383: {
            if (_t10381._tag === 1) {
              const p1_slot = _t10381._val;
              if ((l.slot >= saved_num_locals_10334)) {
                const __rec_upd_10384 = l;
                const _t10385 = ({depth: __rec_upd_10384.depth, name: __rec_upd_10384.name, slot: p1_slot});
                _t10382 = _t10385;
                break _t10383;
              }
            }
            if (true) {
              _t10382 = l;
              break _t10383;
            }
            _match_fail("line 15950");
          }
          return _t10382;
        }
        const remapped_10386 = List$map(_t10380, p2_only_locals_10378);
        const _t10387 = (s.locals = remapped_10386, undefined);
        const _t10379 = _t10387;
        const _t10371 = _t10379;
        const _t10356 = _t10371;
        const _t10345 = _t10356;
        const _t10343 = _t10345;
        const _t10341 = _t10343;
        const _t10337 = _t10341;
        const _t10335 = _t10337;
        const _t10333 = _t10335;
        _t10298 = _t10333;
        break _t10299;
      }
      if (_t10297._tag === 14) {
        const pats = _t10297._val;
        const al_gidx_10388 = Compiler$find_or_add_global(s, "array_length");
        Compiler$emit(s, ({_tag: 10, _name: "GET_GLOBAL", _val: al_gidx_10388}));
        Compiler$emit(s, ({_tag: 3, _name: "GET_LOCAL", _val: slot}));
        Compiler$emit(s, ({_tag: 42, _name: "CALL", _val: 1}));
        Compiler$emit_constant(s, ({_tag: 0, _name: "VInt", _val: List$length(pats)}));
        Compiler$emit(s, ({_tag: 24, _name: "EQ"}));
        Ref$set(fail_jumps, ({_hd: Compiler$emit_idx(s, ({_tag: 38, _name: "JUMP_IF_FALSE", _val: 0})), _tl: Ref$get(fail_jumps)}));
        function _t10390(i, sub_pat) {
          const elem_slot_10391 = Compiler$allocate_local(s, "_arr_elem");
          Compiler$emit(s, ({_tag: 3, _name: "GET_LOCAL", _val: slot}));
          Compiler$emit_constant(s, ({_tag: 0, _name: "VInt", _val: i}));
          Compiler$emit(s, ({_tag: 75, _name: "INDEX"}));
          Compiler$emit(s, ({_tag: 4, _name: "SET_LOCAL", _val: elem_slot_10391}));
          const _t10392 = Compiler$compile_pattern(s, elem_slot_10391, sub_pat, fail_jumps);
          return _t10392;
        }
        const _t10389 = List$iteri(_t10390, pats);
        _t10298 = _t10389;
        break _t10299;
      }
      if (_t10297._tag === 15) {
        const entries = _t10297._val;
        const has_gidx_10393 = Compiler$find_or_add_global(s, "__map_has");
        const get_gidx_10395 = Compiler$find_or_add_global(s, "__map_get");
        function _t10397(__p330) {
          let _t10399;
          const _t10398 = __p330;
          _t10400: {
            if (true) {
              const key_pat = _t10398[0];
              const val_pat = _t10398[1];
              let _t10402;
              const _t10401 = key_pat;
              _t10403: {
                if (_t10401._tag === 2) {
                  const n = _t10401._val;
                  _t10402 = ({_tag: 0, _name: "VInt", _val: n});
                  break _t10403;
                }
                if (_t10401._tag === 5) {
                  const s = _t10401._val;
                  _t10402 = ({_tag: 3, _name: "VString", _val: s});
                  break _t10403;
                }
                if (_t10401._tag === 4) {
                  const b = _t10401._val;
                  _t10402 = ({_tag: 2, _name: "VBool", _val: b});
                  break _t10403;
                }
                if (_t10401._tag === 3) {
                  const f = _t10401._val;
                  _t10402 = ({_tag: 1, _name: "VFloat", _val: f});
                  break _t10403;
                }
                if (true) {
                  _t10402 = Compiler$error("map pattern keys must be literals");
                  break _t10403;
                }
                _match_fail("line 15950");
              }
              const key_val_10404 = _t10402;
              Compiler$emit(s, ({_tag: 10, _name: "GET_GLOBAL", _val: has_gidx_10393}));
              Compiler$emit(s, ({_tag: 3, _name: "GET_LOCAL", _val: slot}));
              Compiler$emit(s, ({_tag: 42, _name: "CALL", _val: 1}));
              Compiler$emit_constant(s, key_val_10404);
              Compiler$emit(s, ({_tag: 42, _name: "CALL", _val: 1}));
              Ref$set(fail_jumps, ({_hd: Compiler$emit_idx(s, ({_tag: 38, _name: "JUMP_IF_FALSE", _val: 0})), _tl: Ref$get(fail_jumps)}));
              const val_slot_10406 = Compiler$allocate_local(s, "_map_val");
              Compiler$emit(s, ({_tag: 10, _name: "GET_GLOBAL", _val: get_gidx_10395}));
              Compiler$emit(s, ({_tag: 3, _name: "GET_LOCAL", _val: slot}));
              Compiler$emit(s, ({_tag: 42, _name: "CALL", _val: 1}));
              Compiler$emit_constant(s, key_val_10404);
              Compiler$emit(s, ({_tag: 42, _name: "CALL", _val: 1}));
              Compiler$emit(s, ({_tag: 4, _name: "SET_LOCAL", _val: val_slot_10406}));
              const _t10407 = Compiler$compile_pattern(s, val_slot_10406, val_pat, fail_jumps);
              const _t10405 = _t10407;
              _t10399 = _t10405;
              break _t10400;
            }
            _match_fail("line 15950");
          }
          return _t10399;
        }
        const _t10396 = List$iter(_t10397, entries);
        const _t10394 = _t10396;
        _t10298 = _t10394;
        break _t10299;
      }
      if (_t10297._tag === 16) {
        const tag = _t10297._val[0];
        const arg_pat = _t10297._val[1];
        const num_tag_10408 = (__dict_Hash_string.hash(tag) & 1073741823);
        Compiler$emit(s, ({_tag: 3, _name: "GET_LOCAL", _val: slot}));
        Compiler$emit(s, ({_tag: 58, _name: "TAG_EQ", _val: num_tag_10408}));
        Ref$set(fail_jumps, ({_hd: Compiler$emit_idx(s, ({_tag: 38, _name: "JUMP_IF_FALSE", _val: 0})), _tl: Ref$get(fail_jumps)}));
        let _t10411;
        const _t10410 = arg_pat;
        _t10412: {
          if (_t10410._tag === 1) {
            const sub_pat = _t10410._val;
            const payload_slot_10413 = Compiler$allocate_local(s, "_payload");
            Compiler$emit(s, ({_tag: 3, _name: "GET_LOCAL", _val: slot}));
            Compiler$emit(s, ({_tag: 63, _name: "VARIANT_PAYLOAD"}));
            Compiler$emit(s, ({_tag: 4, _name: "SET_LOCAL", _val: payload_slot_10413}));
            const _t10415 = s;
            const _t10416 = payload_slot_10413;
            const _t10417 = sub_pat;
            const _t10418 = fail_jumps;
            s = _t10415;
            slot = _t10416;
            pat = _t10417;
            fail_jumps = _t10418;
            continue;
            const _t10414 = undefined;
            _t10411 = _t10414;
            break _t10412;
          }
          if (_t10410._tag === 0) {
            _t10411 = undefined;
            break _t10412;
          }
          _match_fail("line 15950");
        }
        const _t10409 = _t10411;
        _t10298 = _t10409;
        break _t10299;
      }
      if (_t10297._tag === 17) {
        const name = _t10297._val;
        Compiler$emit(s, ({_tag: 3, _name: "GET_LOCAL", _val: slot}));
        Compiler$compile_var_access(s, name);
        Compiler$emit(s, ({_tag: 24, _name: "EQ"}));
        _t10298 = Ref$set(fail_jumps, ({_hd: Compiler$emit_idx(s, ({_tag: 38, _name: "JUMP_IF_FALSE", _val: 0})), _tl: Ref$get(fail_jumps)}));
        break _t10299;
      }
      if (_t10297._tag === 18) {
        const inner_pat = _t10297._val[0];
        const _t10419 = s;
        const _t10420 = slot;
        const _t10421 = inner_pat;
        const _t10422 = fail_jumps;
        s = _t10419;
        slot = _t10420;
        pat = _t10421;
        fail_jumps = _t10422;
        continue;
        _t10298 = undefined;
        break _t10299;
      }
      _match_fail("line 15950");
    }
    return _t10298;
  }
}
function Compiler$compile_handle(s, body_te, arms) {
  const return_arm_10423 = Ref$create(({_tag: 0, _name: "None"}));
  const op_arms_10425 = Ref$create(null);
  function _t10427(__x) {
    let _t10429;
    const _t10428 = __x;
    _t10430: {
      if (_t10428._tag === 0) {
        const name = _t10428._val[0];
        const handler_body = _t10428._val[1];
        _t10429 = Ref$set(return_arm_10423, ({_tag: 1, _name: "Some", _val: [name, handler_body]}));
        break _t10430;
      }
      if (_t10428._tag === 1) {
        const op_name = _t10428._val[0];
        const arg_name = _t10428._val[1];
        const k_name = _t10428._val[2];
        const handler_body = _t10428._val[3];
        _t10429 = Ref$set(op_arms_10425, ({_hd: [op_name, arg_name, k_name, handler_body], _tl: Ref$get(op_arms_10425)}));
        break _t10430;
      }
      _match_fail("line 15950");
    }
    return _t10429;
  }
  List$iter(_t10427, arms);
  const op_arms_10431 = List$rev(Ref$get(op_arms_10425));
  let _t10434;
  const _t10433 = Ref$get(return_arm_10423);
  _t10435: {
    if (_t10433._tag === 1) {
      const arm = _t10433._val;
      _t10434 = arm;
      break _t10435;
    }
    if (_t10433._tag === 0) {
      _t10434 = Compiler$error("handle expression missing return arm");
      break _t10435;
    }
    _match_fail("line 15950");
  }
  let _t10437;
  const _t10436 = _t10434;
  _t10438: {
    if (true) {
      const ret_name = _t10436[0];
      const ret_body = _t10436[1];
      Compiler$compile_function(false, s, "_", body_te, ({_tag: 7, _name: "TArrow", _val: [({_tag: 6, _name: "TUnit"}), ({_tag: 1, _name: "EffEmpty"}), ({_tag: 6, _name: "TUnit"})]}));
      Compiler$compile_function(false, s, ret_name, ret_body, ({_tag: 7, _name: "TArrow", _val: [({_tag: 6, _name: "TUnit"}), ({_tag: 1, _name: "EffEmpty"}), ({_tag: 6, _name: "TUnit"})]}));
      function _t10439(__p331) {
        let _t10441;
        const _t10440 = __p331;
        _t10442: {
          if (true) {
            const op_name = _t10440[0];
            const arg_name = _t10440[1];
            const k_name = _t10440[2];
            const handler_body = _t10440[3];
            Compiler$emit_constant(s, ({_tag: 3, _name: "VString", _val: op_name}));
            _t10441 = Compiler$compile_op_handler(s, arg_name, k_name, handler_body);
            break _t10442;
          }
          _match_fail("line 15950");
        }
        return _t10441;
      }
      List$iter(_t10439, op_arms_10431);
      _t10437 = Compiler$emit(s, ({_tag: 66, _name: "HANDLE", _val: List$length(op_arms_10431)}));
      break _t10438;
    }
    _match_fail("line 15950");
  }
  const _t10432 = _t10437;
  const _t10426 = _t10432;
  const _t10424 = _t10426;
  return _t10424;
}
function Compiler$compile_op_handler(s, arg_name, k_name, handler_body) {
  const sub_10443 = Compiler$create_state(({_tag: 1, _name: "Some", _val: s}), 1, s.global_names, s.mutable_globals, s.type_env, "__handler");
  const pair_slot_10445 = Compiler$allocate_local(sub_10443, "__pair");
  const arg_slot_10447 = Compiler$allocate_local(sub_10443, arg_name);
  Compiler$emit(sub_10443, ({_tag: 3, _name: "GET_LOCAL", _val: pair_slot_10445}));
  Compiler$emit(sub_10443, ({_tag: 49, _name: "TUPLE_GET", _val: 0}));
  Compiler$emit(sub_10443, ({_tag: 4, _name: "SET_LOCAL", _val: arg_slot_10447}));
  const k_slot_10449 = Compiler$allocate_local(sub_10443, k_name);
  Compiler$emit(sub_10443, ({_tag: 3, _name: "GET_LOCAL", _val: pair_slot_10445}));
  Compiler$emit(sub_10443, ({_tag: 49, _name: "TUPLE_GET", _val: 1}));
  Compiler$emit(sub_10443, ({_tag: 4, _name: "SET_LOCAL", _val: k_slot_10449}));
  [arg_slot_10447, k_slot_10449];
  undefined;
  Compiler$compile_expr(true, sub_10443, handler_body);
  Compiler$emit(sub_10443, ({_tag: 44, _name: "RETURN"}));
  const proto_10451 = Compiler$finalize_proto(sub_10443);
  const proto_idx_10453 = Compiler$add_constant(s, ({_tag: 13, _name: "VProto", _val: proto_10451}));
  function _t10455(uv) {
    return uv.capture;
  }
  const captures_10456 = List$map(_t10455, sub_10443.upvalues);
  const _t10457 = Compiler$emit(s, ({_tag: 40, _name: "CLOSURE", _val: [proto_idx_10453, captures_10456]}));
  const _t10454 = _t10457;
  const _t10452 = _t10454;
  const _t10450 = _t10452;
  const _t10448 = _t10450;
  const _t10446 = _t10448;
  const _t10444 = _t10446;
  return _t10444;
}
function Compiler$compile_decl(s, decl) {
  let _t10459;
  const _t10458 = decl;
  _t10460: {
    if (((_t10458._tag === 4 || _t10458._tag === 6) || _t10458._tag === 7)) {
      _t10459 = undefined;
      break _t10460;
    }
    if (_t10458._tag === 8) {
      const name = _t10458._val[0];
      Compiler$find_or_add_global(s, name);
      _t10459 = undefined;
      break _t10460;
    }
    if (_t10458._tag === 0) {
      const name = _t10458._val[0];
      const te = _t10458._val[1];
      Compiler$compile_expr(false, s, te);
      _call(Hashtbl$remove, [__dict_Hash_string, __dict_Eq_string, s.mutable_globals, name]);
      const gidx_10461 = Compiler$find_or_add_global(s, name);
      Compiler$emit(s, ({_tag: 12, _name: "DEF_GLOBAL", _val: gidx_10461}));
      let _t10463;
      if (((String$length(name) > 6) && (String$sub(name, 0, 6) === "__dict"))) {
        function _t10464(inst) {
          return (inst.inst_dict_name === name);
        }
        const inst_opt_10465 = List$find(_t10464, s.type_env.instances);
        let _t10468;
        const _t10467 = inst_opt_10465;
        _t10469: {
          if (_t10467._tag === 1) {
            const inst = _t10467._val;
            if (_eq(inst.inst_constraints, null)) {
              function _t10470(c) {
                return (c.class_name === inst.inst_class);
              }
              const class_opt_10471 = List$find(_t10470, s.type_env.classes);
              let _t10474;
              const _t10473 = class_opt_10471;
              _t10475: {
                if (_t10473._tag === 1) {
                  const class_def = _t10473._val;
                  function _t10476(__p332) {
                    let _t10478;
                    const _t10477 = __p332;
                    _t10479: {
                      if (true) {
                        const method_name = _t10477[0];
                        const mgidx_10480 = Compiler$find_or_add_global(s, (name + ("$" + method_name)));
                        Compiler$emit(s, ({_tag: 10, _name: "GET_GLOBAL", _val: gidx_10461}));
                        Compiler$emit(s, ({_tag: 51, _name: "FIELD", _val: method_name}));
                        const _t10481 = Compiler$emit(s, ({_tag: 12, _name: "DEF_GLOBAL", _val: mgidx_10480}));
                        _t10478 = _t10481;
                        break _t10479;
                      }
                      _match_fail("line 15950");
                    }
                    return _t10478;
                  }
                  _t10474 = List$iter(_t10476, class_def.class_methods);
                  break _t10475;
                }
                if (_t10473._tag === 0) {
                  _t10474 = undefined;
                  break _t10475;
                }
                _match_fail("line 15950");
              }
              const _t10472 = _t10474;
              _t10468 = _t10472;
              break _t10469;
            }
          }
          if (true) {
            _t10468 = undefined;
            break _t10469;
          }
          _match_fail("line 15950");
        }
        const _t10466 = _t10468;
        _t10463 = _t10466;
      } else {
        _t10463 = undefined;
      }
      const _t10462 = _t10463;
      _t10459 = _t10462;
      break _t10460;
    }
    if (_t10458._tag === 1) {
      const name = _t10458._val[0];
      const te = _t10458._val[1];
      Compiler$compile_expr(false, s, te);
      Compiler$emit(s, ({_tag: 7, _name: "MAKE_REF"}));
      _call(Hashtbl$set, [__dict_Hash_string, __dict_Eq_string, s.mutable_globals, name, undefined]);
      const gidx_10482 = Compiler$find_or_add_global(s, name);
      const _t10483 = Compiler$emit(s, ({_tag: 12, _name: "DEF_GLOBAL", _val: gidx_10482}));
      _t10459 = _t10483;
      break _t10460;
    }
    if (_t10458._tag === 2) {
      const name = _t10458._val[0];
      const te = _t10458._val[1];
      _call(Hashtbl$remove, [__dict_Hash_string, __dict_Eq_string, s.mutable_globals, name]);
      const gidx_10484 = Compiler$find_or_add_global(s, name);
      Compiler$compile_expr(false, s, te);
      const _t10485 = Compiler$emit(s, ({_tag: 12, _name: "DEF_GLOBAL", _val: gidx_10484}));
      _t10459 = _t10485;
      break _t10460;
    }
    if (_t10458._tag === 3) {
      const bindings = _t10458._val;
      function _t10486(__p333) {
        let _t10488;
        const _t10487 = __p333;
        _t10489: {
          if (true) {
            const name = _t10487[0];
            _t10488 = _call(Hashtbl$remove, [__dict_Hash_string, __dict_Eq_string, s.mutable_globals, name]);
            break _t10489;
          }
          _match_fail("line 15950");
        }
        return _t10488;
      }
      List$iter(_t10486, bindings);
      function _t10490(__p334) {
        let _t10492;
        const _t10491 = __p334;
        _t10493: {
          if (true) {
            const name = _t10491[0];
            _t10492 = Compiler$find_or_add_global(s, name);
            break _t10493;
          }
          _match_fail("line 15950");
        }
        return _t10492;
      }
      const gidxs_10494 = List$map(_t10490, bindings);
      function _t10496(__p335, gidx) {
        let _t10498;
        const _t10497 = __p335;
        _t10499: {
          if (true) {
            const _name = _t10497[0];
            const te = _t10497[1];
            Compiler$compile_expr(false, s, te);
            _t10498 = Compiler$emit(s, ({_tag: 12, _name: "DEF_GLOBAL", _val: gidx}));
            break _t10499;
          }
          _match_fail("line 15950");
        }
        return _t10498;
      }
      const _t10495 = List$iter2(_t10496, bindings, gidxs_10494);
      _t10459 = _t10495;
      break _t10460;
    }
    if (_t10458._tag === 5) {
      const te = _t10458._val;
      Compiler$compile_expr(false, s, te);
      _t10459 = Compiler$emit(s, ({_tag: 1, _name: "POP"}));
      break _t10460;
    }
    if (_t10458._tag === 9) {
      const _name = _t10458._val[0];
      const inner_decls = _t10458._val[1];
      function _t10500(d) {
        return Compiler$compile_decl(s, d);
      }
      _t10459 = List$iter(_t10500, inner_decls);
      break _t10460;
    }
    if (_t10458._tag === 10) {
      const alias_pairs = _t10458._val;
      function _t10501(__p336) {
        let _t10503;
        const _t10502 = __p336;
        _t10504: {
          if (true) {
            const short_name = _t10502[0];
            const qualified_name = _t10502[1];
            const src_idx_10505 = Compiler$find_or_add_global(s, qualified_name);
            const dst_idx_10507 = Compiler$find_or_add_global(s, short_name);
            Compiler$emit(s, ({_tag: 10, _name: "GET_GLOBAL", _val: src_idx_10505}));
            Compiler$emit(s, ({_tag: 12, _name: "DEF_GLOBAL", _val: dst_idx_10507}));
            let _t10509;
            if (Compiler$is_mutable_global(s, qualified_name)) {
              _t10509 = _call(Hashtbl$set, [__dict_Hash_string, __dict_Eq_string, s.mutable_globals, short_name, undefined]);
            } else {
              _t10509 = _call(Hashtbl$remove, [__dict_Hash_string, __dict_Eq_string, s.mutable_globals, short_name]);
            }
            const _t10508 = _t10509;
            const _t10506 = _t10508;
            _t10503 = _t10506;
            break _t10504;
          }
          _match_fail("line 15950");
        }
        return _t10503;
      }
      _t10459 = List$iter(_t10501, alias_pairs);
      break _t10460;
    }
    _match_fail("line 15950");
  }
  return _t10459;
}
function Compiler$compile_decl_last(s, decl) {
  let _t10511;
  const _t10510 = decl;
  _t10512: {
    if (_t10510._tag === 5) {
      const te = _t10510._val;
      _t10511 = Compiler$compile_expr(false, s, te);
      break _t10512;
    }
    if (true) {
      _t10511 = Compiler$compile_decl(s, decl);
      break _t10512;
    }
    _match_fail("line 15950");
  }
  return _t10511;
}
function Compiler$compile_program_with_globals(type_env, global_names, mutable_globals, program) {
  const s_10513 = Compiler$create_state(({_tag: 0, _name: "None"}), 0, global_names, mutable_globals, type_env, "<main>");
  function compile_all(__x) {
    while (true) {
      let _t10516;
      const _t10515 = __x;
      _t10517: {
        if (_t10515 === null) {
          _t10516 = undefined;
          break _t10517;
        }
        if (_t10515 !== null && _t10515._tl === null) {
          const last = _t10515._hd;
          _t10516 = Compiler$compile_decl_last(s_10513, last);
          break _t10517;
        }
        if (_t10515 !== null) {
          const decl = _t10515._hd;
          const rest = _t10515._tl;
          Compiler$compile_decl(s_10513, decl);
          const _t10518 = rest;
          __x = _t10518;
          continue;
          _t10516 = undefined;
          break _t10517;
        }
        _match_fail("line 15950");
      }
      return _t10516;
    }
  }
  compile_all(program);
  Compiler$emit(s_10513, ({_tag: 76, _name: "HALT"}));
  const main_10520 = Compiler$finalize_proto(s_10513);
  let _t10522;
  if (Ref$get(Compiler$optimize_enabled)) {
    _t10522 = Optimize$optimize_proto(main_10520);
  } else {
    _t10522 = main_10520;
  }
  const main_10523 = _t10522;
  const gn_10525 = Dynarray$to_array(global_names);
  const _t10526 = ({global_names: gn_10525, main: main_10523});
  const _t10524 = _t10526;
  const _t10521 = _t10524;
  const _t10519 = _t10521;
  const _t10514 = _t10519;
  return _t10514;
}
function Compiler$compile_program(type_env, program) {
  return Compiler$compile_program_with_globals(type_env, Dynarray$empty(undefined), Hashtbl$create(8), program);
}
function Serialize$json_escape_string(s) {
  const buf_10527 = Buffer$create((String$length(s) + 8));
  Buffer$add_byte(buf_10527, 34);
  function _t10529(c) {
    let _t10531;
    const _t10530 = c;
    _t10532: {
      if (true) {
        const _c = _t10530;
        if ((_c === 34)) {
          _t10531 = Buffer$add_string(buf_10527, "\\\"");
          break _t10532;
        }
      }
      if (true) {
        const _c = _t10530;
        if ((_c === 92)) {
          _t10531 = Buffer$add_string(buf_10527, "\\\\");
          break _t10532;
        }
      }
      if (true) {
        const _c = _t10530;
        if ((_c === 10)) {
          _t10531 = Buffer$add_string(buf_10527, "\\n");
          break _t10532;
        }
      }
      if (true) {
        const _c = _t10530;
        if ((_c === 13)) {
          _t10531 = Buffer$add_string(buf_10527, "\\r");
          break _t10532;
        }
      }
      if (true) {
        const _c = _t10530;
        if ((_c === 9)) {
          _t10531 = Buffer$add_string(buf_10527, "\\t");
          break _t10532;
        }
      }
      if (true) {
        const c = _t10530;
        if ((Byte$to_int(c) < 32)) {
          _t10531 = Buffer$add_string(buf_10527, ("\\u" + __fmt_zero_pad(4, __fmt_hex(Byte$to_int(c)))));
          break _t10532;
        }
      }
      if (true) {
        const c = _t10530;
        _t10531 = Buffer$add_byte(buf_10527, c);
        break _t10532;
      }
      _match_fail("line 15950");
    }
    return _t10531;
  }
  String$iter(_t10529, s);
  Buffer$add_byte(buf_10527, 34);
  const _t10528 = Buffer$contents(buf_10527);
  return _t10528;
}
function Serialize$serialize_capture(__x) {
  let _t10534;
  const _t10533 = __x;
  _t10535: {
    if (_t10533._tag === 0) {
      const i = _t10533._val;
      _t10534 = (("[\"local\"," + __dict_Show_int.show(i)) + "]");
      break _t10535;
    }
    if (_t10533._tag === 1) {
      const i = _t10533._val;
      _t10534 = (("[\"upvalue\"," + __dict_Show_int.show(i)) + "]");
      break _t10535;
    }
    _match_fail("line 15950");
  }
  return _t10534;
}
function Serialize$serialize_captures(caps) {
  return ("[" + (String$concat(",", List$map(Serialize$serialize_capture, caps)) + "]"));
}
function Serialize$serialize_opcode(__x) {
  let _t10537;
  const _t10536 = __x;
  _t10538: {
    if (_t10536._tag === 0) {
      const i = _t10536._val;
      _t10537 = (("[\"CONST\"," + __dict_Show_int.show(i)) + "]");
      break _t10538;
    }
    if (_t10536._tag === 1) {
      _t10537 = "[\"POP\"]";
      break _t10538;
    }
    if (_t10536._tag === 2) {
      _t10537 = "[\"DUP\"]";
      break _t10538;
    }
    if (_t10536._tag === 3) {
      const i = _t10536._val;
      _t10537 = (("[\"GET_LOCAL\"," + __dict_Show_int.show(i)) + "]");
      break _t10538;
    }
    if (_t10536._tag === 4) {
      const i = _t10536._val;
      _t10537 = (("[\"SET_LOCAL\"," + __dict_Show_int.show(i)) + "]");
      break _t10538;
    }
    if (_t10536._tag === 5) {
      const i = _t10536._val;
      _t10537 = (("[\"GET_UPVALUE\"," + __dict_Show_int.show(i)) + "]");
      break _t10538;
    }
    if (_t10536._tag === 6) {
      const i = _t10536._val;
      _t10537 = (("[\"SET_UPVALUE\"," + __dict_Show_int.show(i)) + "]");
      break _t10538;
    }
    if (_t10536._tag === 7) {
      _t10537 = "[\"MAKE_REF\"]";
      break _t10538;
    }
    if (_t10536._tag === 8) {
      _t10537 = "[\"DEREF\"]";
      break _t10538;
    }
    if (_t10536._tag === 9) {
      _t10537 = "[\"SET_REF\"]";
      break _t10538;
    }
    if (_t10536._tag === 10) {
      const i = _t10536._val;
      _t10537 = (("[\"GET_GLOBAL\"," + __dict_Show_int.show(i)) + "]");
      break _t10538;
    }
    if (_t10536._tag === 11) {
      const i = _t10536._val;
      _t10537 = (("[\"SET_GLOBAL\"," + __dict_Show_int.show(i)) + "]");
      break _t10538;
    }
    if (_t10536._tag === 12) {
      const i = _t10536._val;
      _t10537 = (("[\"DEF_GLOBAL\"," + __dict_Show_int.show(i)) + "]");
      break _t10538;
    }
    if (_t10536._tag === 13) {
      _t10537 = "[\"ADD\"]";
      break _t10538;
    }
    if (_t10536._tag === 14) {
      _t10537 = "[\"SUB\"]";
      break _t10538;
    }
    if (_t10536._tag === 15) {
      _t10537 = "[\"MUL\"]";
      break _t10538;
    }
    if (_t10536._tag === 16) {
      _t10537 = "[\"DIV\"]";
      break _t10538;
    }
    if (_t10536._tag === 17) {
      _t10537 = "[\"MOD\"]";
      break _t10538;
    }
    if (_t10536._tag === 18) {
      _t10537 = "[\"NEG\"]";
      break _t10538;
    }
    if (_t10536._tag === 19) {
      _t10537 = "[\"FADD\"]";
      break _t10538;
    }
    if (_t10536._tag === 20) {
      _t10537 = "[\"FSUB\"]";
      break _t10538;
    }
    if (_t10536._tag === 21) {
      _t10537 = "[\"FMUL\"]";
      break _t10538;
    }
    if (_t10536._tag === 22) {
      _t10537 = "[\"FDIV\"]";
      break _t10538;
    }
    if (_t10536._tag === 23) {
      _t10537 = "[\"FNEG\"]";
      break _t10538;
    }
    if (_t10536._tag === 24) {
      _t10537 = "[\"EQ\"]";
      break _t10538;
    }
    if (_t10536._tag === 25) {
      _t10537 = "[\"NEQ\"]";
      break _t10538;
    }
    if (_t10536._tag === 26) {
      _t10537 = "[\"LT\"]";
      break _t10538;
    }
    if (_t10536._tag === 27) {
      _t10537 = "[\"GT\"]";
      break _t10538;
    }
    if (_t10536._tag === 28) {
      _t10537 = "[\"LE\"]";
      break _t10538;
    }
    if (_t10536._tag === 29) {
      _t10537 = "[\"GE\"]";
      break _t10538;
    }
    if (_t10536._tag === 30) {
      _t10537 = "[\"NOT\"]";
      break _t10538;
    }
    if (_t10536._tag === 31) {
      _t10537 = "[\"BAND\"]";
      break _t10538;
    }
    if (_t10536._tag === 32) {
      _t10537 = "[\"BOR\"]";
      break _t10538;
    }
    if (_t10536._tag === 33) {
      _t10537 = "[\"BXOR\"]";
      break _t10538;
    }
    if (_t10536._tag === 34) {
      _t10537 = "[\"BNOT\"]";
      break _t10538;
    }
    if (_t10536._tag === 35) {
      _t10537 = "[\"BSHL\"]";
      break _t10538;
    }
    if (_t10536._tag === 36) {
      _t10537 = "[\"BSHR\"]";
      break _t10538;
    }
    if (_t10536._tag === 37) {
      const off = _t10536._val;
      _t10537 = (("[\"JUMP\"," + __dict_Show_int.show(off)) + "]");
      break _t10538;
    }
    if (_t10536._tag === 38) {
      const off = _t10536._val;
      _t10537 = (("[\"JUMP_IF_FALSE\"," + __dict_Show_int.show(off)) + "]");
      break _t10538;
    }
    if (_t10536._tag === 39) {
      const off = _t10536._val;
      _t10537 = (("[\"JUMP_IF_TRUE\"," + __dict_Show_int.show(off)) + "]");
      break _t10538;
    }
    if (_t10536._tag === 40) {
      const i = _t10536._val[0];
      const caps = _t10536._val[1];
      _t10537 = (((("[\"CLOSURE\"," + __dict_Show_int.show(i)) + ",") + __dict_Show_string.show(Serialize$serialize_captures(caps))) + "]");
      break _t10538;
    }
    if (_t10536._tag === 41) {
      const i = _t10536._val[0];
      const caps = _t10536._val[1];
      const self = _t10536._val[2];
      _t10537 = (((((("[\"CLOSURE_REC\"," + __dict_Show_int.show(i)) + ",") + __dict_Show_string.show(Serialize$serialize_captures(caps))) + ",") + __dict_Show_int.show(self)) + "]");
      break _t10538;
    }
    if (_t10536._tag === 42) {
      const n = _t10536._val;
      _t10537 = (("[\"CALL\"," + __dict_Show_int.show(n)) + "]");
      break _t10538;
    }
    if (_t10536._tag === 43) {
      const n = _t10536._val;
      _t10537 = (("[\"TAIL_CALL\"," + __dict_Show_int.show(n)) + "]");
      break _t10538;
    }
    if (_t10536._tag === 44) {
      _t10537 = "[\"RETURN\"]";
      break _t10538;
    }
    if (_t10536._tag === 45) {
      _t10537 = "[\"FUNC_RETURN\"]";
      break _t10538;
    }
    if (_t10536._tag === 46) {
      _t10537 = "[\"ENTER_FUNC\"]";
      break _t10538;
    }
    if (_t10536._tag === 47) {
      _t10537 = "[\"EXIT_FUNC\"]";
      break _t10538;
    }
    if (_t10536._tag === 48) {
      const n = _t10536._val;
      _t10537 = (("[\"MAKE_TUPLE\"," + __dict_Show_int.show(n)) + "]");
      break _t10538;
    }
    if (_t10536._tag === 49) {
      const i = _t10536._val;
      _t10537 = (("[\"TUPLE_GET\"," + __dict_Show_int.show(i)) + "]");
      break _t10538;
    }
    if (_t10536._tag === 50) {
      const fields = _t10536._val;
      _t10537 = (("[\"MAKE_RECORD\",[" + __dict_Show_string.show(String$concat(",", List$map(Serialize$json_escape_string, fields)))) + "]]");
      break _t10538;
    }
    if (_t10536._tag === 51) {
      const name = _t10536._val;
      _t10537 = (("[\"FIELD\"," + __dict_Show_string.show(Serialize$json_escape_string(name))) + "]");
      break _t10538;
    }
    if (_t10536._tag === 52) {
      const name = _t10536._val;
      _t10537 = (("[\"SET_FIELD\"," + __dict_Show_string.show(Serialize$json_escape_string(name))) + "]");
      break _t10538;
    }
    if (_t10536._tag === 53) {
      const fields = _t10536._val;
      _t10537 = (("[\"RECORD_UPDATE\",[" + __dict_Show_string.show(String$concat(",", List$map(Serialize$json_escape_string, fields)))) + "]]");
      break _t10538;
    }
    if (_t10536._tag === 54) {
      const n = _t10536._val;
      _t10537 = (("[\"RECORD_UPDATE_DYN\"," + __dict_Show_int.show(n)) + "]");
      break _t10538;
    }
    if (_t10536._tag === 55) {
      const tag = _t10536._val[0];
      const name = _t10536._val[1];
      const has_payload = _t10536._val[2];
      _t10537 = (((((("[\"MAKE_VARIANT\"," + __dict_Show_int.show(tag)) + ",") + __dict_Show_string.show(Serialize$json_escape_string(name))) + ",") + __dict_Show_bool.show(has_payload)) + "]");
      break _t10538;
    }
    if (_t10536._tag === 56) {
      _t10537 = "[\"CONS\"]";
      break _t10538;
    }
    if (_t10536._tag === 57) {
      _t10537 = "[\"NIL\"]";
      break _t10538;
    }
    if (_t10536._tag === 58) {
      const tag = _t10536._val;
      _t10537 = (("[\"TAG_EQ\"," + __dict_Show_int.show(tag)) + "]");
      break _t10538;
    }
    if (_t10536._tag === 59) {
      _t10537 = "[\"IS_NIL\"]";
      break _t10538;
    }
    if (_t10536._tag === 60) {
      _t10537 = "[\"IS_CONS\"]";
      break _t10538;
    }
    if (_t10536._tag === 61) {
      _t10537 = "[\"HEAD\"]";
      break _t10538;
    }
    if (_t10536._tag === 62) {
      _t10537 = "[\"TAIL\"]";
      break _t10538;
    }
    if (_t10536._tag === 63) {
      _t10537 = "[\"VARIANT_PAYLOAD\"]";
      break _t10538;
    }
    if (_t10536._tag === 64) {
      const loc = _t10536._val;
      _t10537 = (("[\"MATCH_FAIL\"," + __dict_Show_string.show(Serialize$json_escape_string(loc))) + "]");
      break _t10538;
    }
    if (_t10536._tag === 65) {
      const op = _t10536._val;
      _t10537 = (("[\"PERFORM\"," + __dict_Show_string.show(Serialize$json_escape_string(op))) + "]");
      break _t10538;
    }
    if (_t10536._tag === 66) {
      const n = _t10536._val;
      _t10537 = (("[\"HANDLE\"," + __dict_Show_int.show(n)) + "]");
      break _t10538;
    }
    if (_t10536._tag === 67) {
      _t10537 = "[\"RESUME\"]";
      break _t10538;
    }
    if (_t10536._tag === 68) {
      const n = _t10536._val;
      _t10537 = (("[\"ENTER_LOOP\"," + __dict_Show_int.show(n)) + "]");
      break _t10538;
    }
    if (_t10536._tag === 69) {
      _t10537 = "[\"EXIT_LOOP\"]";
      break _t10538;
    }
    if (_t10536._tag === 70) {
      _t10537 = "[\"LOOP_BREAK\"]";
      break _t10538;
    }
    if (_t10536._tag === 71) {
      const n = _t10536._val;
      _t10537 = (("[\"LOOP_CONTINUE\"," + __dict_Show_int.show(n)) + "]");
      break _t10538;
    }
    if (_t10536._tag === 72) {
      const n = _t10536._val;
      _t10537 = (("[\"FOLD_CONTINUE\"," + __dict_Show_int.show(n)) + "]");
      break _t10538;
    }
    if (_t10536._tag === 73) {
      const n = _t10536._val;
      _t10537 = (("[\"MAKE_MAP\"," + __dict_Show_int.show(n)) + "]");
      break _t10538;
    }
    if (_t10536._tag === 74) {
      const n = _t10536._val;
      _t10537 = (("[\"MAKE_ARRAY\"," + __dict_Show_int.show(n)) + "]");
      break _t10538;
    }
    if (_t10536._tag === 75) {
      _t10537 = "[\"INDEX\"]";
      break _t10538;
    }
    if (_t10536._tag === 76) {
      _t10537 = "[\"HALT\"]";
      break _t10538;
    }
    if (_t10536._tag === 77) {
      const slot = _t10536._val[0];
      const arity = _t10536._val[1];
      _t10537 = (((("[\"GET_LOCAL_CALL\"," + __dict_Show_int.show(slot)) + ",") + __dict_Show_int.show(arity)) + "]");
      break _t10538;
    }
    if (_t10536._tag === 78) {
      const slot = _t10536._val[0];
      const idx = _t10536._val[1];
      _t10537 = (((("[\"GET_LOCAL_TUPLE_GET\"," + __dict_Show_int.show(slot)) + ",") + __dict_Show_int.show(idx)) + "]");
      break _t10538;
    }
    if (_t10536._tag === 79) {
      const slot = _t10536._val[0];
      const name = _t10536._val[1];
      _t10537 = (((("[\"GET_LOCAL_FIELD\"," + __dict_Show_int.show(slot)) + ",") + __dict_Show_string.show(Serialize$json_escape_string(name))) + "]");
      break _t10538;
    }
    if (_t10536._tag === 80) {
      const idx = _t10536._val[0];
      const arity = _t10536._val[1];
      _t10537 = (((("[\"GET_GLOBAL_CALL\"," + __dict_Show_int.show(idx)) + ",") + __dict_Show_int.show(arity)) + "]");
      break _t10538;
    }
    if (_t10536._tag === 81) {
      const idx = _t10536._val[0];
      const name = _t10536._val[1];
      _t10537 = (((("[\"GET_GLOBAL_FIELD\"," + __dict_Show_int.show(idx)) + ",") + __dict_Show_string.show(Serialize$json_escape_string(name))) + "]");
      break _t10538;
    }
    if (_t10536._tag === 82) {
      const min_tag = _t10536._val[0];
      const targets = _t10536._val[1];
      const _mml$default = _t10536._val[2];
      _t10537 = (((((("[\"JUMP_TABLE\"," + __dict_Show_int.show(min_tag)) + ",[") + __dict_Show_string.show(String$concat(",", Array$to_list(Array$map(string_of_int, targets))))) + "],") + __dict_Show_int.show(_mml$default)) + "]");
      break _t10538;
    }
    if (_t10536._tag === 83) {
      const n = _t10536._val;
      _t10537 = (("[\"CALL_N\"," + __dict_Show_int.show(n)) + "]");
      break _t10538;
    }
    if (_t10536._tag === 84) {
      const n = _t10536._val;
      _t10537 = (("[\"TAIL_CALL_N\"," + __dict_Show_int.show(n)) + "]");
      break _t10538;
    }
    _match_fail("line 15950");
  }
  return _t10537;
}
function Serialize$serialize_value(__x) {
  let _t10540;
  const _t10539 = __x;
  _t10541: {
    if (_t10539._tag === 0) {
      const n = _t10539._val;
      _t10540 = (("{\"t\":\"i\",\"v\":" + __dict_Show_int.show(n)) + "}");
      break _t10541;
    }
    if (_t10539._tag === 1) {
      const f = _t10539._val;
      const s_10542 = __dict_Show_float.show(f);
      const _t10543 = (("{\"t\":\"f\",\"v\":" + __dict_Show_string.show(s_10542)) + "}");
      _t10540 = _t10543;
      break _t10541;
    }
    if (_t10539._tag === 2) {
      const b = _t10539._val;
      _t10540 = (("{\"t\":\"b\",\"v\":" + __dict_Show_bool.show(b)) + "}");
      break _t10541;
    }
    if (_t10539._tag === 3) {
      const s = _t10539._val;
      _t10540 = (("{\"t\":\"s\",\"v\":" + __dict_Show_string.show(Serialize$json_escape_string(s))) + "}");
      break _t10541;
    }
    if (_t10539._tag === 4) {
      const n = _t10539._val;
      _t10540 = (("{\"t\":\"y\",\"v\":" + __dict_Show_int.show(n)) + "}");
      break _t10541;
    }
    if (_t10539._tag === 5) {
      const n = _t10539._val;
      _t10540 = (("{\"t\":\"r\",\"v\":" + __dict_Show_int.show(n)) + "}");
      break _t10541;
    }
    if (_t10539._tag === 6) {
      _t10540 = "{\"t\":\"u\"}";
      break _t10541;
    }
    if (_t10539._tag === 13) {
      const p = _t10539._val;
      _t10540 = (("{\"t\":\"p\",\"v\":" + __dict_Show_string.show(Serialize$serialize_prototype(p))) + "}");
      break _t10541;
    }
    if (_t10539._tag === 7) {
      const vs = _t10539._val;
      _t10540 = (("{\"t\":\"T\",\"v\":[" + __dict_Show_string.show(String$concat(",", List$map(Serialize$serialize_value, Array$to_list(vs))))) + "]}");
      break _t10541;
    }
    if (_t10539._tag === 8) {
      const vs = _t10539._val;
      _t10540 = (("{\"t\":\"L\",\"v\":[" + __dict_Show_string.show(String$concat(",", List$map(Serialize$serialize_value, vs)))) + "]}");
      break _t10541;
    }
    if (_t10539._tag === 10) {
      const tag = _t10539._val[0];
      const name = _t10539._val[1];
      const payload = _t10539._val[2];
      let _t10545;
      const _t10544 = payload;
      _t10546: {
        if (_t10544._tag === 0) {
          _t10545 = "null";
          break _t10546;
        }
        if (_t10544._tag === 1) {
          const v = _t10544._val;
          _t10545 = Serialize$serialize_value(v);
          break _t10546;
        }
        _match_fail("line 15950");
      }
      const payload_str_10547 = _t10545;
      const _t10548 = (((((("{\"t\":\"V\",\"tag\":" + __dict_Show_int.show(tag)) + ",\"name\":") + __dict_Show_string.show(Serialize$json_escape_string(name))) + ",\"payload\":") + __dict_Show_string.show(payload_str_10547)) + "}");
      _t10540 = _t10548;
      break _t10541;
    }
    if (true) {
      _t10540 = failwith("serialize_value: unsupported value type in constants");
      break _t10541;
    }
    _match_fail("line 15950");
  }
  return _t10540;
}
function Serialize$serialize_prototype(proto) {
  const code_strs_10549 = Array$to_list(Array$map(Serialize$serialize_opcode, proto.code));
  const const_strs_10551 = Array$to_list(Array$map(Serialize$serialize_value, proto.constants));
  const line_strs_10553 = Array$to_list(Array$map(string_of_int, proto.line_table));
  const _t10554 = (((((((((((("{\"name\":" + __dict_Show_string.show(Serialize$json_escape_string(proto.name))) + ",\"arity\":") + __dict_Show_int.show(proto.arity)) + ",\"num_locals\":") + __dict_Show_int.show(proto.num_locals)) + ",\"code\":[") + __dict_Show_string.show(String$concat(",", code_strs_10549))) + "],\"constants\":[") + __dict_Show_string.show(String$concat(",", const_strs_10551))) + "],\"line_table\":[") + __dict_Show_string.show(String$concat(",", line_strs_10553))) + "]}");
  const _t10552 = _t10554;
  const _t10550 = _t10552;
  return _t10550;
}
function Serialize$serialize_native_global(idx, value) {
  let _t10556;
  const _t10555 = value;
  _t10557: {
    if (_t10555._tag === 14) {
      const ext = _t10555._val;
      _t10556 = ({_tag: 1, _name: "Some", _val: (((((__dict_Show_string.show(Serialize$json_escape_string(string_of_int(idx))) + ":{\"type\":\"external\",\"name\":") + __dict_Show_string.show(Serialize$json_escape_string(ext.ext_name))) + ",\"arity\":") + __dict_Show_int.show(ext.ext_arity)) + "}")});
      break _t10557;
    }
    if (_t10555._tag === 9) {
      const shape = _t10555._val[0];
      const values = _t10555._val[1];
      function _t10558(v) {
        let _t10560;
        const _t10559 = v;
        _t10561: {
          if (_t10559._tag === 14) {
            _t10560 = true;
            break _t10561;
          }
          if (true) {
            _t10560 = false;
            break _t10561;
          }
          _match_fail("line 15950");
        }
        return _t10560;
      }
      const all_external_10562 = Array$forall(_t10558, values);
      let _t10564;
      if ((all_external_10562 && (Array$length(values) > 0))) {
        function _t10565(i) {
          const name_10566 = Array$get(shape.rs_fields, i);
          let _t10569;
          const _t10568 = Array$get(values, i);
          _t10570: {
            if (_t10568._tag === 14) {
              const ext = _t10568._val;
              _t10569 = (((((__dict_Show_string.show(Serialize$json_escape_string(name_10566)) + ":{\"name\":") + __dict_Show_string.show(Serialize$json_escape_string(ext.ext_name))) + ",\"arity\":") + __dict_Show_int.show(ext.ext_arity)) + "}");
              break _t10570;
            }
            if (true) {
              _t10569 = failwith("assert false");
              break _t10570;
            }
            _match_fail("line 15950");
          }
          const _t10567 = _t10569;
          return _t10567;
        }
        const field_strs_10571 = List$init(Array$length(shape.rs_fields), _t10565);
        const _t10572 = ({_tag: 1, _name: "Some", _val: (((__dict_Show_string.show(Serialize$json_escape_string(string_of_int(idx))) + ":{\"type\":\"dict\",\"fields\":{") + __dict_Show_string.show(String$concat(",", field_strs_10571))) + "}}")});
        _t10564 = _t10572;
      } else {
        _t10564 = ({_tag: 0, _name: "None"});
      }
      const _t10563 = _t10564;
      _t10556 = _t10563;
      break _t10557;
    }
    if (true) {
      _t10556 = ({_tag: 0, _name: "None"});
      break _t10557;
    }
    _match_fail("line 15950");
  }
  return _t10556;
}
function Serialize$serialize_native_ext(__dict_Show_0, idx, name, arity) {
  return (((((__dict_Show_string.show(Serialize$json_escape_string(string_of_int(idx))) + ":{\"type\":\"external\",\"name\":") + __dict_Show_string.show(Serialize$json_escape_string(name))) + ",\"arity\":") + __dict_Show_0.show(arity)) + "}");
}
function Serialize$serialize_native_dict(__dict_Show_0, idx, fields) {
  function _t10573(__p337) {
    let _t10575;
    const _t10574 = __p337;
    _t10576: {
      if (true) {
        const name = _t10574[0];
        const ext_name = _t10574[1];
        const arity = _t10574[2];
        _t10575 = (((((__dict_Show_string.show(Serialize$json_escape_string(name)) + ":{\"name\":") + __dict_Show_string.show(Serialize$json_escape_string(ext_name))) + ",\"arity\":") + __dict_Show_0.show(arity)) + "}");
        break _t10576;
      }
      _match_fail("line 15950");
    }
    return _t10575;
  }
  const field_strs_10577 = List$map(_t10573, fields);
  const _t10578 = (((__dict_Show_string.show(Serialize$json_escape_string(string_of_int(idx))) + ":{\"type\":\"dict\",\"fields\":{") + __dict_Show_string.show(String$concat(",", field_strs_10577))) + "}}");
  return _t10578;
}
function Serialize$build_native_globals_json(globals) {
  const parts_10579 = Ref$create(null);
  function _t10581(idx, value) {
    let _t10583;
    const _t10582 = Serialize$serialize_native_global(idx, value);
    _t10584: {
      if (_t10582._tag === 1) {
        const s = _t10582._val;
        _t10583 = Ref$set(parts_10579, ({_hd: s, _tl: Ref$get(parts_10579)}));
        break _t10584;
      }
      if (_t10582._tag === 0) {
        _t10583 = undefined;
        break _t10584;
      }
      _match_fail("line 15950");
    }
    return _t10583;
  }
  Hashtbl$iter(_t10581, globals);
  const _t10580 = String$concat(",", Ref$get(parts_10579));
  return _t10580;
}
function Serialize$serialize_bundle(global_names, native_globals_json, setup_protos, main_proto) {
  const buf_10585 = Buffer$create(4096);
  Buffer$add_string(buf_10585, "{\"version\":1");
  const names_10587 = Dynarray$to_array(global_names);
  Buffer$add_string(buf_10585, ",\"global_names\":[");
  function _t10589(i, name) {
    let _t10590;
    if ((i > 0)) {
      _t10590 = Buffer$add_byte(buf_10585, 44);
    } else {
      _t10590 = undefined;
    }
    _t10590;
    return Buffer$add_string(buf_10585, Serialize$json_escape_string(name));
  }
  Array$iteri(_t10589, names_10587);
  Buffer$add_string(buf_10585, "]");
  Buffer$add_string(buf_10585, ",\"native_globals\":{");
  Buffer$add_string(buf_10585, native_globals_json);
  Buffer$add_string(buf_10585, "}");
  Buffer$add_string(buf_10585, ",\"setup\":[");
  function _t10591(i, proto) {
    let _t10592;
    if ((i > 0)) {
      _t10592 = Buffer$add_byte(buf_10585, 44);
    } else {
      _t10592 = undefined;
    }
    _t10592;
    return Buffer$add_string(buf_10585, Serialize$serialize_prototype(proto));
  }
  List$iteri(_t10591, setup_protos);
  Buffer$add_string(buf_10585, "]");
  Buffer$add_string(buf_10585, ",\"main\":");
  Buffer$add_string(buf_10585, Serialize$serialize_prototype(main_proto));
  Buffer$add_string(buf_10585, "}");
  const _t10588 = Buffer$contents(buf_10585);
  const _t10586 = _t10588;
  return _t10586;
}
function Js_codegen$error(msg) {
  return _trampoline(function() {
    return _h["codegen_error"](msg, function(_t10593) {
      return _bounce(function() {
        return _t10593;
      });
    });
  }, Js_codegen$error);
}
const Js_codegen$js_runtime = "\"use strict\";\nfunction _call(f, args) {\n  while (args.length > 0) {\n    const a = f._arity !== undefined ? f._arity : f.length;\n    if (a === 0) { f = f(); continue; }\n    if (args.length < a) return _partial(f, a, args);\n    const taken = args.splice(0, a);\n    f = f.apply(null, taken);\n  }\n  return f;\n}\nfunction _partial(fn, arity, args) {\n  const p = function() {\n    return _call(fn, args.concat(Array.from(arguments)));\n  };\n  p._arity = arity - args.length;\n  return p;\n}\nfunction _eq(a, b) {\n  if (a === b) return true;\n  if (a == null || b == null) return a === b;\n  if (typeof a !== \"object\") return false;\n  if (Array.isArray(a)) {\n    if (!Array.isArray(b) || a.length !== b.length) return false;\n    for (let i = 0; i < a.length; i++) if (!_eq(a[i], b[i])) return false;\n    return true;\n  }\n  if (\"_arr\" in a && \"_arr\" in b) {\n    if (a._arr.length !== b._arr.length) return false;\n    for (let i = 0; i < a._arr.length; i++) if (!_eq(a._arr[i], b._arr[i])) return false;\n    return true;\n  }\n  if (\"_hd\" in a && \"_hd\" in b) {\n    let ca = a, cb = b;\n    while (ca !== null && cb !== null) {\n      if (!(\"_hd\" in ca) || !(\"_hd\" in cb)) return ca === cb;\n      if (!_eq(ca._hd, cb._hd)) return false;\n      ca = ca._tl; cb = cb._tl;\n    }\n    return ca === cb;\n  }\n  if (\"_tag\" in a) return a._tag === b._tag && _eq(a._val, b._val);\n  if (\"_ref\" in a) return _eq(a._ref, b._ref);\n  const ka = Object.keys(a), kb = Object.keys(b);\n  if (ka.length !== kb.length) return false;\n  for (const k of ka) if (!_eq(a[k], b[k])) return false;\n  return true;\n}\nfunction _compare(a, b) {\n  if (a < b) return -1;\n  if (a > b) return 1;\n  return 0;\n}\nfunction _match_fail(loc) { throw new Error(\"Match failure at \" + loc); }\nfunction _pp(v) {\n  if (v === undefined) return \"()\";\n  if (v === null) return \"[]\";\n  if (typeof v === \"number\") {\n    if (!Number.isInteger(v)) {\n      const s = String(v);\n      return s.includes(\".\") || s.includes(\"e\") ? s : s + \".\";\n    }\n    return String(v);\n  }\n  if (typeof v === \"boolean\") return String(v);\n  if (typeof v === \"string\") return v;\n  if (Array.isArray(v)) return \"(\" + v.map(_pp).join(\", \") + \")\";\n  if (v !== null && typeof v === \"object\") {\n    if (\"_arr\" in v) return \"#[\" + v._arr.map(_pp).join(\"; \") + \"]\";\n    if (\"_hd\" in v) {\n      const r = [];\n      let c = v;\n      while (c !== null && typeof c === \"object\" && \"_hd\" in c) { r.push(_pp(c._hd)); c = c._tl; }\n      return \"[\" + r.join(\"; \") + \"]\";\n    }\n    if (\"_tag\" in v) {\n      if (v._val !== undefined) {\n        const pv = _pp(v._val);\n        if (Array.isArray(v._val) || (typeof v._val === \"object\" && v._val !== null && \"_tag\" in v._val && v._val._val !== undefined))\n          return v._name + \" (\" + pv + \")\";\n        return v._name + \" \" + pv;\n      }\n      return v._name;\n    }\n    if (\"_ref\" in v) return \"ref(\" + _pp(v._ref) + \")\";\n    if (v instanceof Map) {\n      const entries = Array.from(v.entries());\n      const isSet = entries.every(([_,val]) => val === undefined);\n      if (isSet) return \"#{\" + entries.map(([k]) => _pp(k)).join(\"; \") + \"}\";\n      return \"#{\" + entries.map(([k,val]) => _pp(k) + \": \" + _pp(val)).join(\"; \") + \"}\";\n    }\n    return \"{ \" + Object.entries(v).map(([k,val]) => k + \" = \" + _pp(val)).join(\"; \") + \" }\";\n  }\n  return String(v);\n}\nlet _h = {};\nfunction _bounce(fn) { fn._tramp = true; return fn; }\nconst _trampolining = new Set();\nfunction _trampoline(fn, tag) {\n  if (tag !== undefined && _trampolining.has(tag)) return fn();\n  if (tag !== undefined) _trampolining.add(tag);\n  try {\n    let result = fn();\n    while (typeof result === 'function' && result._tramp) {\n      result = result();\n    }\n    return result;\n  } finally { if (tag !== undefined) _trampolining.delete(tag); }\n}\n";
const Js_codegen$js_reserved = ({_hd: "abstract", _tl: ({_hd: "arguments", _tl: ({_hd: "await", _tl: ({_hd: "boolean", _tl: ({_hd: "break", _tl: ({_hd: "byte", _tl: ({_hd: "case", _tl: ({_hd: "catch", _tl: ({_hd: "char", _tl: ({_hd: "class", _tl: ({_hd: "const", _tl: ({_hd: "continue", _tl: ({_hd: "debugger", _tl: ({_hd: "default", _tl: ({_hd: "delete", _tl: ({_hd: "do", _tl: ({_hd: "double", _tl: ({_hd: "else", _tl: ({_hd: "enum", _tl: ({_hd: "eval", _tl: ({_hd: "export", _tl: ({_hd: "extends", _tl: ({_hd: "false", _tl: ({_hd: "final", _tl: ({_hd: "finally", _tl: ({_hd: "float", _tl: ({_hd: "for", _tl: ({_hd: "function", _tl: ({_hd: "goto", _tl: ({_hd: "if", _tl: ({_hd: "implements", _tl: ({_hd: "import", _tl: ({_hd: "in", _tl: ({_hd: "instanceof", _tl: ({_hd: "int", _tl: ({_hd: "interface", _tl: ({_hd: "let", _tl: ({_hd: "long", _tl: ({_hd: "native", _tl: ({_hd: "new", _tl: ({_hd: "null", _tl: ({_hd: "package", _tl: ({_hd: "private", _tl: ({_hd: "protected", _tl: ({_hd: "public", _tl: ({_hd: "return", _tl: ({_hd: "short", _tl: ({_hd: "static", _tl: ({_hd: "super", _tl: ({_hd: "switch", _tl: ({_hd: "synchronized", _tl: ({_hd: "this", _tl: ({_hd: "throw", _tl: ({_hd: "throws", _tl: ({_hd: "transient", _tl: ({_hd: "true", _tl: ({_hd: "try", _tl: ({_hd: "typeof", _tl: ({_hd: "undefined", _tl: ({_hd: "var", _tl: ({_hd: "void", _tl: ({_hd: "volatile", _tl: ({_hd: "while", _tl: ({_hd: "with", _tl: ({_hd: "yield", _tl: ({_hd: "of", _tl: null})})})})})})})})})})})})})})})})})})})})})})})})})})})})})})})})})})})})})})})})})})})})})})})})})})})})})})})})})})})})})})})})})});
function Js_codegen$is_js_reserved(name) {
  return List$mem(name, Js_codegen$js_reserved);
}
function Js_codegen$mangle_name(name) {
  const buf_10594 = Buffer$create(String$length(name));
  function _t10596(c) {
    let _t10598;
    const _t10597 = c;
    _t10599: {
      if (true) {
        const _c = _t10597;
        if ((_c === 46)) {
          _t10598 = Buffer$add_byte(buf_10594, 36);
          break _t10599;
        }
      }
      if (true) {
        const _c = _t10597;
        if ((_c === 39)) {
          _t10598 = Buffer$add_string(buf_10594, "$p");
          break _t10599;
        }
      }
      if (true) {
        const _c = _t10597;
        if ((_c === 43)) {
          _t10598 = Buffer$add_string(buf_10594, "$plus");
          break _t10599;
        }
      }
      if (true) {
        const _c = _t10597;
        if ((_c === 45)) {
          _t10598 = Buffer$add_string(buf_10594, "$minus");
          break _t10599;
        }
      }
      if (true) {
        const _c = _t10597;
        if ((_c === 42)) {
          _t10598 = Buffer$add_string(buf_10594, "$star");
          break _t10599;
        }
      }
      if (true) {
        const _c = _t10597;
        if ((_c === 47)) {
          _t10598 = Buffer$add_string(buf_10594, "$slash");
          break _t10599;
        }
      }
      if (true) {
        const _c = _t10597;
        if ((_c === 94)) {
          _t10598 = Buffer$add_string(buf_10594, "$caret");
          break _t10599;
        }
      }
      if (true) {
        const _c = _t10597;
        if ((_c === 61)) {
          _t10598 = Buffer$add_string(buf_10594, "$eq");
          break _t10599;
        }
      }
      if (true) {
        const _c = _t10597;
        if ((_c === 60)) {
          _t10598 = Buffer$add_string(buf_10594, "$lt");
          break _t10599;
        }
      }
      if (true) {
        const _c = _t10597;
        if ((_c === 62)) {
          _t10598 = Buffer$add_string(buf_10594, "$gt");
          break _t10599;
        }
      }
      if (true) {
        const _c = _t10597;
        if ((_c === 33)) {
          _t10598 = Buffer$add_string(buf_10594, "$bang");
          break _t10599;
        }
      }
      if (true) {
        const _c = _t10597;
        if ((_c === 58)) {
          _t10598 = Buffer$add_string(buf_10594, "$colon");
          break _t10599;
        }
      }
      if (true) {
        const _c = _t10597;
        if ((_c === 126)) {
          _t10598 = Buffer$add_string(buf_10594, "$tilde");
          break _t10599;
        }
      }
      if (true) {
        const _c = _t10597;
        if ((_c === 35)) {
          _t10598 = Buffer$add_string(buf_10594, "$hash");
          break _t10599;
        }
      }
      if (true) {
        const c = _t10597;
        _t10598 = Buffer$add_byte(buf_10594, c);
        break _t10599;
      }
      _match_fail("line 15950");
    }
    return _t10598;
  }
  String$iter(_t10596, name);
  const result_10600 = Buffer$contents(buf_10594);
  let _t10602;
  if (Js_codegen$is_js_reserved(result_10600)) {
    _t10602 = ("_mml$" + result_10600);
  } else {
    _t10602 = result_10600;
  }
  const _t10601 = _t10602;
  const _t10595 = _t10601;
  return _t10595;
}
function Js_codegen$create_ctx(type_env) {
  const tbl_10603 = Hashtbl$create(16);
  const _t10604 = ({break_flag_name: "_break_flag", break_val_name: "_break_val", buf: Buffer$create(4096), current_fn_name: ({_tag: 0, _name: "None"}), current_fn_params: null, current_module: ({_tag: 0, _name: "None"}), direct_dispatch_ops: null, handler_tail_resume: false, in_cps: false, in_tail_position: false, indent: 0, scopes: ({_hd: tbl_10603, _tl: null}), simple_handler_mode: false, tco_used: false, tmp_counter: 0, top_level_exports: null, trywith_ops: null, type_env: type_env});
  return _t10604;
}
function Js_codegen$push_scope(ctx) {
  return (ctx.scopes = ({_hd: Hashtbl$create(8), _tl: ctx.scopes}), undefined);
}
function Js_codegen$pop_scope(ctx) {
  let _t10606;
  const _t10605 = ctx.scopes;
  _t10607: {
    if (_t10605 !== null) {
      const rest = _t10605._tl;
      _t10606 = (ctx.scopes = rest, undefined);
      break _t10607;
    }
    if (_t10605 === null) {
      _t10606 = failwith("pop_scope: empty");
      break _t10607;
    }
    _match_fail("line 15950");
  }
  return _t10606;
}
function Js_codegen$bind_var(ctx, mml_name, js_name) {
  let _t10609;
  const _t10608 = ctx.scopes;
  _t10610: {
    if (_t10608 !== null) {
      const tbl = _t10608._hd;
      _t10609 = _call(Hashtbl$set, [__dict_Hash_string, __dict_Eq_string, tbl, mml_name, js_name]);
      break _t10610;
    }
    if (_t10608 === null) {
      _t10609 = failwith("bind_var: empty scope");
      break _t10610;
    }
    _match_fail("line 15950");
  }
  return _t10609;
}
function Js_codegen$lookup_var(ctx, name) {
  function search(__x) {
    while (true) {
      let _t10612;
      const _t10611 = __x;
      _t10613: {
        if (_t10611 === null) {
          _t10612 = Js_codegen$mangle_name(name);
          break _t10613;
        }
        if (_t10611 !== null) {
          const tbl = _t10611._hd;
          const rest = _t10611._tl;
          let _t10615;
          const _t10614 = _call(Hashtbl$get, [__dict_Hash_string, __dict_Eq_string, tbl, name]);
          _t10616: {
            if (_t10614._tag === 1) {
              const js = _t10614._val;
              _t10615 = js;
              break _t10616;
            }
            if (_t10614._tag === 0) {
              const _t10617 = rest;
              __x = _t10617;
              continue;
              _t10615 = undefined;
              break _t10616;
            }
            _match_fail("line 15950");
          }
          _t10612 = _t10615;
          break _t10613;
        }
        _match_fail("line 15950");
      }
      return _t10612;
    }
  }
  const _t10618 = search(ctx.scopes);
  return _t10618;
}
function Js_codegen$fresh_tmp(ctx) {
  const n_10619 = ctx.tmp_counter;
  (ctx.tmp_counter = (n_10619 + 1), undefined);
  const _t10620 = ("_t" + __dict_Show_int.show(n_10619));
  return _t10620;
}
function Js_codegen$dedup_js_params(params) {
  const seen_10621 = Hashtbl$create(8);
  function _t10623(p) {
    let _t10625;
    const _t10624 = _call(Hashtbl$get, [__dict_Hash_string, __dict_Eq_string, seen_10621, p]);
    _t10626: {
      if (_t10624._tag === 1) {
        const n = _t10624._val;
        _t10625 = n;
        break _t10626;
      }
      if (_t10624._tag === 0) {
        _t10625 = 0;
        break _t10626;
      }
      _match_fail("line 15950");
    }
    const count_10627 = _t10625;
    _call(Hashtbl$set, [__dict_Hash_string, __dict_Eq_string, seen_10621, p, (count_10627 + 1)]);
    let _t10629;
    if ((count_10627 === 0)) {
      _t10629 = p;
    } else {
      _t10629 = (p + ("_" + string_of_int((count_10627 + 1))));
    }
    const _t10628 = _t10629;
    return _t10628;
  }
  const _t10622 = List$map(_t10623, params);
  return _t10622;
}
function Js_codegen$emit(ctx, s) {
  return Buffer$add_string(ctx.buf, s);
}
function Js_codegen$emit_indent(ctx) {
  let _loop_var_10630 = 1;
  let _t10632 = undefined;
  let _t10633 = false, _t10634;
  while (true) {
    if (!((_loop_var_10630 <= ctx.indent))) break;
    Buffer$add_string(ctx.buf, "  ");
    (_loop_var_10630 = (_loop_var_10630 + 1), undefined);
    if (_t10633) break;
  }
  _t10632 = _t10633 ? _t10634 : undefined;
  const _t10631 = _t10632;
  return _t10631;
}
function Js_codegen$emit_line(ctx, s) {
  Js_codegen$emit_indent(ctx);
  Js_codegen$emit(ctx, s);
  return Js_codegen$emit(ctx, "\n");
}
function Js_codegen$escape_js_string(s) {
  const buf_10635 = Buffer$create((String$length(s) + 2));
  Buffer$add_byte(buf_10635, 34);
  function _t10637(c) {
    let _t10639;
    const _t10638 = c;
    _t10640: {
      if (true) {
        const _c = _t10638;
        if ((_c === 34)) {
          _t10639 = Buffer$add_string(buf_10635, "\\\"");
          break _t10640;
        }
      }
      if (true) {
        const _c = _t10638;
        if ((_c === 92)) {
          _t10639 = Buffer$add_string(buf_10635, "\\\\");
          break _t10640;
        }
      }
      if (true) {
        const _c = _t10638;
        if ((_c === 10)) {
          _t10639 = Buffer$add_string(buf_10635, "\\n");
          break _t10640;
        }
      }
      if (true) {
        const _c = _t10638;
        if ((_c === 13)) {
          _t10639 = Buffer$add_string(buf_10635, "\\r");
          break _t10640;
        }
      }
      if (true) {
        const _c = _t10638;
        if ((_c === 9)) {
          _t10639 = Buffer$add_string(buf_10635, "\\t");
          break _t10640;
        }
      }
      if (true) {
        const c = _t10638;
        if ((Byte$to_int(c) < 32)) {
          _t10639 = Buffer$add_string(buf_10635, ("\\x" + __fmt_zero_pad(2, __fmt_hex(Byte$to_int(c)))));
          break _t10640;
        }
      }
      if (true) {
        const c = _t10638;
        _t10639 = Buffer$add_byte(buf_10635, c);
        break _t10640;
      }
      _match_fail("line 15950");
    }
    return _t10639;
  }
  String$iter(_t10637, s);
  Buffer$add_byte(buf_10635, 34);
  const _t10636 = Buffer$contents(buf_10635);
  return _t10636;
}
function Js_codegen$tag_for_constructor(type_env, name) {
  let _t10642;
  const _t10641 = List$assoc_opt(name, type_env.constructors);
  _t10643: {
    if (_t10641._tag === 0) {
      _t10642 = Js_codegen$error(("unknown constructor: " + __dict_Show_string.show(name)));
      break _t10643;
    }
    if (_t10641._tag === 1) {
      const info = _t10641._val;
      function _t10644(__p338) {
        let _t10646;
        const _t10645 = __p338;
        _t10647: {
          if (true) {
            const n = _t10645[0];
            _t10646 = (n === info.ctor_type_name);
            break _t10647;
          }
          _match_fail("line 15950");
        }
        return _t10646;
      }
      let _t10649;
      const _t10648 = list_find(_t10644, type_env.variants);
      _t10650: {
        if (true) {
          const variant_def = _t10648[2];
          let _t10652;
          const _t10651 = String$rindex_opt(name, 46);
          _t10653: {
            if (_t10651._tag === 1) {
              const i = _t10651._val;
              _t10652 = String$sub(name, (i + 1), ((String$length(name) - i) - 1));
              break _t10653;
            }
            if (_t10651._tag === 0) {
              _t10652 = name;
              break _t10653;
            }
            _match_fail("line 15950");
          }
          const short_name_10654 = _t10652;
          function find_tag(idx, __x) {
            while (true) {
              let _t10657;
              const _t10656 = __x;
              _t10658: {
                if (_t10656 === null) {
                  _t10657 = Js_codegen$error((("constructor " + __dict_Show_string.show(name)) + " not found in variant"));
                  break _t10658;
                }
                if (_t10656 !== null) {
                  const cname = _t10656._hd[0];
                  if ((cname === short_name_10654)) {
                    _t10657 = idx;
                    break _t10658;
                  }
                }
                if (_t10656 !== null) {
                  const rest = _t10656._tl;
                  const _t10659 = (idx + 1);
                  const _t10660 = rest;
                  idx = _t10659;
                  __x = _t10660;
                  continue;
                  _t10657 = undefined;
                  break _t10658;
                }
                _match_fail("line 15950");
              }
              return _t10657;
            }
          }
          const _t10661 = find_tag(0, variant_def);
          const _t10655 = _t10661;
          _t10649 = _t10655;
          break _t10650;
        }
        _match_fail("line 15950");
      }
      _t10642 = _t10649;
      break _t10643;
    }
    _match_fail("line 15950");
  }
  return _t10642;
}
function Js_codegen$short_constructor_name(name) {
  let _t10663;
  const _t10662 = String$rindex_opt(name, 46);
  _t10664: {
    if (_t10662._tag === 1) {
      const i = _t10662._val;
      _t10663 = String$sub(name, (i + 1), ((String$length(name) - i) - 1));
      break _t10664;
    }
    if (_t10662._tag === 0) {
      _t10663 = name;
      break _t10664;
    }
    _match_fail("line 15950");
  }
  return _t10663;
}
function Js_codegen$expr_has_perform(te) {
  while (true) {
    let _t10666;
    const _t10665 = te.expr;
    _t10667: {
      if (_t10665._tag === 29) {
        _t10666 = true;
        break _t10667;
      }
      if (_t10665._tag === 31) {
        _t10666 = true;
        break _t10667;
      }
      if ((_t10665._tag === 8 || _t10665._tag === 28)) {
        const e1 = (_t10665._tag === 8 ? _t10665._val[2] : _t10665._val[0]);
        const e2 = (_t10665._tag === 8 ? _t10665._val[3] : _t10665._val[1]);
        _t10666 = (Js_codegen$expr_has_perform(e1) || Js_codegen$expr_has_perform(e2));
        break _t10667;
      }
      if (_t10665._tag === 12) {
        const cond = _t10665._val[0];
        const e1 = _t10665._val[1];
        const e2 = _t10665._val[2];
        _t10666 = (Js_codegen$expr_has_perform(cond) || (Js_codegen$expr_has_perform(e1) || Js_codegen$expr_has_perform(e2)));
        break _t10667;
      }
      if (_t10665._tag === 24) {
        const scrut = _t10665._val[0];
        const arms = _t10665._val[1];
        let _t10676;
        if (Js_codegen$expr_has_perform(scrut)) {
          _t10676 = true;
        } else {
        function _t10668(__p339) {
          let _t10670;
          const _t10669 = __p339;
          _t10671: {
            if (true) {
              const g = _t10669[1];
              const body = _t10669[2];
              let _t10675;
              if (Js_codegen$expr_has_perform(body)) {
                _t10675 = true;
              } else {
              let _t10673;
              const _t10672 = g;
              _t10674: {
                if (_t10672._tag === 1) {
                  const g = _t10672._val;
                  _t10673 = Js_codegen$expr_has_perform(g);
                  break _t10674;
                }
                if (_t10672._tag === 0) {
                  _t10673 = false;
                  break _t10674;
                }
                _match_fail("line 15950");
              }
                _t10675 = _t10673;
              }
              _t10670 = _t10675;
              break _t10671;
            }
            _match_fail("line 15950");
          }
          return _t10670;
        }
          _t10676 = List$exists(_t10668, arms);
        }
        _t10666 = _t10676;
        break _t10667;
      }
      if (_t10665._tag === 9) {
        const fn_e = _t10665._val[2];
        const body = _t10665._val[3];
        _t10666 = (Js_codegen$expr_has_perform(fn_e) || Js_codegen$expr_has_perform(body));
        break _t10667;
      }
      if (_t10665._tag === 37) {
        const bindings = _t10665._val[0];
        const body = _t10665._val[1];
        function _t10677(__p340) {
          let _t10679;
          const _t10678 = __p340;
          _t10680: {
            if (true) {
              const e = _t10678[1];
              _t10679 = Js_codegen$expr_has_perform(e);
              break _t10680;
            }
            _match_fail("line 15950");
          }
          return _t10679;
        }
        _t10666 = (List$exists(_t10677, bindings) || Js_codegen$expr_has_perform(body));
        break _t10667;
      }
      if (_t10665._tag === 10) {
        const body = _t10665._val[1];
        const _t10681 = body;
        te = _t10681;
        continue;
        _t10666 = undefined;
        break _t10667;
      }
      if (_t10665._tag === 11) {
        const fn_ = _t10665._val[0];
        const arg = _t10665._val[1];
        _t10666 = (Js_codegen$expr_has_perform(fn_) || Js_codegen$expr_has_perform(arg));
        break _t10667;
      }
      if (_t10665._tag === 30) {
        const body = _t10665._val[0];
        const arms = _t10665._val[1];
        let _t10686;
        if (Js_codegen$expr_has_perform(body)) {
          _t10686 = true;
        } else {
        function _t10682(arm) {
          let _t10684;
          const _t10683 = arm;
          _t10685: {
            if (_t10683._tag === 0) {
              const e = _t10683._val[1];
              _t10684 = Js_codegen$expr_has_perform(e);
              break _t10685;
            }
            if (_t10683._tag === 1) {
              const e = _t10683._val[3];
              _t10684 = Js_codegen$expr_has_perform(e);
              break _t10685;
            }
            _match_fail("line 15950");
          }
          return _t10684;
        }
          _t10686 = List$exists(_t10682, arms);
        }
        _t10666 = _t10686;
        break _t10667;
      }
      if (_t10665._tag === 25) {
        const e1 = _t10665._val[1];
        const e2 = _t10665._val[2];
        _t10666 = (Js_codegen$expr_has_perform(e1) || Js_codegen$expr_has_perform(e2));
        break _t10667;
      }
      if (_t10665._tag === 32) {
        const c = _t10665._val[0];
        const b = _t10665._val[1];
        _t10666 = (Js_codegen$expr_has_perform(c) || Js_codegen$expr_has_perform(b));
        break _t10667;
      }
      if (_t10665._tag === 21) {
        const e1 = _t10665._val[0];
        const e2 = _t10665._val[1];
        _t10666 = (Js_codegen$expr_has_perform(e1) || Js_codegen$expr_has_perform(e2));
        break _t10667;
      }
      if (_t10665._tag === 15) {
        const es = _t10665._val;
        _t10666 = List$exists(Js_codegen$expr_has_perform, es);
        break _t10667;
      }
      if (_t10665._tag === 16) {
        const fields = _t10665._val;
        function _t10687(__p341) {
          let _t10689;
          const _t10688 = __p341;
          _t10690: {
            if (true) {
              const e = _t10688[1];
              _t10689 = Js_codegen$expr_has_perform(e);
              break _t10690;
            }
            _match_fail("line 15950");
          }
          return _t10689;
        }
        _t10666 = List$exists(_t10687, fields);
        break _t10667;
      }
      if (_t10665._tag === 13) {
        const e1 = _t10665._val[1];
        const e2 = _t10665._val[2];
        _t10666 = (Js_codegen$expr_has_perform(e1) || Js_codegen$expr_has_perform(e2));
        break _t10667;
      }
      if (_t10665._tag === 14) {
        const e = _t10665._val[1];
        const _t10691 = e;
        te = _t10691;
        continue;
        _t10666 = undefined;
        break _t10667;
      }
      if (true) {
        _t10666 = false;
        break _t10667;
      }
      _match_fail("line 15950");
    }
    return _t10666;
  }
}
function Js_codegen$all_resumes_are_tail(te) {
  while (true) {
    let _t10693;
    const _t10692 = te.expr;
    _t10694: {
      if (_t10692._tag === 31) {
        _t10693 = true;
        break _t10694;
      }
      if (_t10692._tag === 28) {
        const e2 = _t10692._val[1];
        const _t10695 = e2;
        te = _t10695;
        continue;
        _t10693 = undefined;
        break _t10694;
      }
      if (_t10692._tag === 8) {
        const e1 = _t10692._val[2];
        const e2 = _t10692._val[3];
        _t10693 = ((!Js_codegen$expr_has_perform(e1)) && Js_codegen$all_resumes_are_tail(e2));
        break _t10694;
      }
      if (_t10692._tag === 9) {
        const e2 = _t10692._val[3];
        const _t10696 = e2;
        te = _t10696;
        continue;
        _t10693 = undefined;
        break _t10694;
      }
      if (_t10692._tag === 25) {
        const e1 = _t10692._val[1];
        const e2 = _t10692._val[2];
        _t10693 = ((!Js_codegen$expr_has_perform(e1)) && Js_codegen$all_resumes_are_tail(e2));
        break _t10694;
      }
      if (_t10692._tag === 12) {
        const then_e = _t10692._val[1];
        const else_e = _t10692._val[2];
        _t10693 = (Js_codegen$all_resumes_are_tail(then_e) && Js_codegen$all_resumes_are_tail(else_e));
        break _t10694;
      }
      if (_t10692._tag === 24) {
        const arms = _t10692._val[1];
        function _t10697(__p342) {
          let _t10699;
          const _t10698 = __p342;
          _t10700: {
            if (true) {
              const body = _t10698[2];
              _t10699 = Js_codegen$all_resumes_are_tail(body);
              break _t10700;
            }
            _match_fail("line 15950");
          }
          return _t10699;
        }
        _t10693 = List$forall(_t10697, arms);
        break _t10694;
      }
      if (true) {
        _t10693 = true;
        break _t10694;
      }
      _match_fail("line 15950");
    }
    return _t10693;
  }
}
function Js_codegen$body_contains_resume(te) {
  while (true) {
    let _t10702;
    const _t10701 = te.expr;
    _t10703: {
      if (_t10701._tag === 31) {
        _t10702 = true;
        break _t10703;
      }
      if (((_t10701._tag === 8 || _t10701._tag === 28) || _t10701._tag === 25)) {
        const e1 = ((_t10701._tag === 8 || _t10701._tag === 28) ? (_t10701._tag === 8 ? _t10701._val[2] : _t10701._val[0]) : _t10701._val[1]);
        const e2 = ((_t10701._tag === 8 || _t10701._tag === 28) ? (_t10701._tag === 8 ? _t10701._val[3] : _t10701._val[1]) : _t10701._val[2]);
        _t10702 = (Js_codegen$body_contains_resume(e1) || Js_codegen$body_contains_resume(e2));
        break _t10703;
      }
      if (_t10701._tag === 12) {
        const e1 = _t10701._val[1];
        const e2 = _t10701._val[2];
        _t10702 = (Js_codegen$body_contains_resume(e1) || Js_codegen$body_contains_resume(e2));
        break _t10703;
      }
      if (_t10701._tag === 24) {
        const arms = _t10701._val[1];
        function _t10704(__p343) {
          let _t10706;
          const _t10705 = __p343;
          _t10707: {
            if (true) {
              const body = _t10705[2];
              _t10706 = Js_codegen$body_contains_resume(body);
              break _t10707;
            }
            _match_fail("line 15950");
          }
          return _t10706;
        }
        _t10702 = List$exists(_t10704, arms);
        break _t10703;
      }
      if (_t10701._tag === 9) {
        const e2 = _t10701._val[3];
        const _t10708 = e2;
        te = _t10708;
        continue;
        _t10702 = undefined;
        break _t10703;
      }
      if (_t10701._tag === 37) {
        const e2 = _t10701._val[1];
        const _t10709 = e2;
        te = _t10709;
        continue;
        _t10702 = undefined;
        break _t10703;
      }
      if (true) {
        _t10702 = false;
        break _t10703;
      }
      _match_fail("line 15950");
    }
    return _t10702;
  }
}
function Js_codegen$all_branches_resume(te) {
  while (true) {
    let _t10711;
    const _t10710 = te.expr;
    _t10712: {
      if (_t10710._tag === 31) {
        _t10711 = true;
        break _t10712;
      }
      if (_t10710._tag === 8) {
        const e2 = _t10710._val[3];
        const _t10713 = e2;
        te = _t10713;
        continue;
        _t10711 = undefined;
        break _t10712;
      }
      if (_t10710._tag === 9) {
        const e2 = _t10710._val[3];
        const _t10714 = e2;
        te = _t10714;
        continue;
        _t10711 = undefined;
        break _t10712;
      }
      if (_t10710._tag === 37) {
        const e2 = _t10710._val[1];
        const _t10715 = e2;
        te = _t10715;
        continue;
        _t10711 = undefined;
        break _t10712;
      }
      if (_t10710._tag === 25) {
        const e2 = _t10710._val[2];
        const _t10716 = e2;
        te = _t10716;
        continue;
        _t10711 = undefined;
        break _t10712;
      }
      if (_t10710._tag === 28) {
        const e2 = _t10710._val[1];
        const _t10717 = e2;
        te = _t10717;
        continue;
        _t10711 = undefined;
        break _t10712;
      }
      if (_t10710._tag === 12) {
        const then_e = _t10710._val[1];
        const else_e = _t10710._val[2];
        _t10711 = (Js_codegen$all_branches_resume(then_e) && Js_codegen$all_branches_resume(else_e));
        break _t10712;
      }
      if (_t10710._tag === 24) {
        const arms = _t10710._val[1];
        function _t10718(__p344) {
          let _t10720;
          const _t10719 = __p344;
          _t10721: {
            if (true) {
              const body = _t10719[2];
              _t10720 = Js_codegen$all_branches_resume(body);
              break _t10721;
            }
            _match_fail("line 15950");
          }
          return _t10720;
        }
        _t10711 = List$forall(_t10718, arms);
        break _t10712;
      }
      if (true) {
        _t10711 = false;
        break _t10712;
      }
      _match_fail("line 15950");
    }
    return _t10711;
  }
}
function Js_codegen$is_simple_handler_body(te) {
  return (Js_codegen$body_contains_resume(te) && (Js_codegen$all_branches_resume(te) && Js_codegen$all_resumes_are_tail(te)));
}
function Js_codegen$is_trywith_arm(te) {
  return ((!Js_codegen$body_contains_resume(te)) && (!Js_codegen$expr_has_perform(te)));
}
function Js_codegen$expr_has_unhandled_perform(handled_ops, te) {
  while (true) {
    let _t10723;
    const _t10722 = te.expr;
    _t10724: {
      if (_t10722._tag === 29) {
        const op_name = _t10722._val[0];
        _t10723 = (!List$mem(op_name, handled_ops));
        break _t10724;
      }
      if (_t10722._tag === 31) {
        _t10723 = true;
        break _t10724;
      }
      if ((_t10722._tag === 8 || _t10722._tag === 28)) {
        const e1 = (_t10722._tag === 8 ? _t10722._val[2] : _t10722._val[0]);
        const e2 = (_t10722._tag === 8 ? _t10722._val[3] : _t10722._val[1]);
        _t10723 = (Js_codegen$expr_has_unhandled_perform(handled_ops, e1) || Js_codegen$expr_has_unhandled_perform(handled_ops, e2));
        break _t10724;
      }
      if (_t10722._tag === 12) {
        const cond = _t10722._val[0];
        const e1 = _t10722._val[1];
        const e2 = _t10722._val[2];
        _t10723 = (Js_codegen$expr_has_unhandled_perform(handled_ops, cond) || (Js_codegen$expr_has_unhandled_perform(handled_ops, e1) || Js_codegen$expr_has_unhandled_perform(handled_ops, e2)));
        break _t10724;
      }
      if (_t10722._tag === 24) {
        const scrut = _t10722._val[0];
        const arms = _t10722._val[1];
        let _t10733;
        if (Js_codegen$expr_has_unhandled_perform(handled_ops, scrut)) {
          _t10733 = true;
        } else {
        function _t10725(__p345) {
          let _t10727;
          const _t10726 = __p345;
          _t10728: {
            if (true) {
              const g = _t10726[1];
              const body = _t10726[2];
              let _t10732;
              if (Js_codegen$expr_has_unhandled_perform(handled_ops, body)) {
                _t10732 = true;
              } else {
              let _t10730;
              const _t10729 = g;
              _t10731: {
                if (_t10729._tag === 1) {
                  const g = _t10729._val;
                  _t10730 = Js_codegen$expr_has_unhandled_perform(handled_ops, g);
                  break _t10731;
                }
                if (_t10729._tag === 0) {
                  _t10730 = false;
                  break _t10731;
                }
                _match_fail("line 15950");
              }
                _t10732 = _t10730;
              }
              _t10727 = _t10732;
              break _t10728;
            }
            _match_fail("line 15950");
          }
          return _t10727;
        }
          _t10733 = List$exists(_t10725, arms);
        }
        _t10723 = _t10733;
        break _t10724;
      }
      if (_t10722._tag === 9) {
        const fn_e = _t10722._val[2];
        const body = _t10722._val[3];
        _t10723 = (Js_codegen$expr_has_unhandled_perform(handled_ops, fn_e) || Js_codegen$expr_has_unhandled_perform(handled_ops, body));
        break _t10724;
      }
      if (_t10722._tag === 37) {
        const bindings = _t10722._val[0];
        const body = _t10722._val[1];
        function _t10734(__p346) {
          let _t10736;
          const _t10735 = __p346;
          _t10737: {
            if (true) {
              const e = _t10735[1];
              _t10736 = Js_codegen$expr_has_unhandled_perform(handled_ops, e);
              break _t10737;
            }
            _match_fail("line 15950");
          }
          return _t10736;
        }
        _t10723 = (List$exists(_t10734, bindings) || Js_codegen$expr_has_unhandled_perform(handled_ops, body));
        break _t10724;
      }
      if (_t10722._tag === 10) {
        const body = _t10722._val[1];
        const _t10738 = handled_ops;
        const _t10739 = body;
        handled_ops = _t10738;
        te = _t10739;
        continue;
        _t10723 = undefined;
        break _t10724;
      }
      if (_t10722._tag === 11) {
        const fn_ = _t10722._val[0];
        const arg = _t10722._val[1];
        _t10723 = (Js_codegen$expr_has_unhandled_perform(handled_ops, fn_) || Js_codegen$expr_has_unhandled_perform(handled_ops, arg));
        break _t10724;
      }
      if (_t10722._tag === 30) {
        const body = _t10722._val[0];
        const arms = _t10722._val[1];
        let _t10744;
        if (Js_codegen$expr_has_unhandled_perform(handled_ops, body)) {
          _t10744 = true;
        } else {
        function _t10740(arm) {
          let _t10742;
          const _t10741 = arm;
          _t10743: {
            if (_t10741._tag === 0) {
              const e = _t10741._val[1];
              _t10742 = Js_codegen$expr_has_unhandled_perform(handled_ops, e);
              break _t10743;
            }
            if (_t10741._tag === 1) {
              const e = _t10741._val[3];
              _t10742 = Js_codegen$expr_has_unhandled_perform(handled_ops, e);
              break _t10743;
            }
            _match_fail("line 15950");
          }
          return _t10742;
        }
          _t10744 = List$exists(_t10740, arms);
        }
        _t10723 = _t10744;
        break _t10724;
      }
      if (_t10722._tag === 25) {
        const e1 = _t10722._val[1];
        const e2 = _t10722._val[2];
        _t10723 = (Js_codegen$expr_has_unhandled_perform(handled_ops, e1) || Js_codegen$expr_has_unhandled_perform(handled_ops, e2));
        break _t10724;
      }
      if (_t10722._tag === 32) {
        const c = _t10722._val[0];
        const b = _t10722._val[1];
        _t10723 = (Js_codegen$expr_has_unhandled_perform(handled_ops, c) || Js_codegen$expr_has_unhandled_perform(handled_ops, b));
        break _t10724;
      }
      if (_t10722._tag === 21) {
        const e1 = _t10722._val[0];
        const e2 = _t10722._val[1];
        _t10723 = (Js_codegen$expr_has_unhandled_perform(handled_ops, e1) || Js_codegen$expr_has_unhandled_perform(handled_ops, e2));
        break _t10724;
      }
      if (_t10722._tag === 15) {
        const es = _t10722._val;
        _t10723 = List$exists(_call(Js_codegen$expr_has_unhandled_perform, [handled_ops]), es);
        break _t10724;
      }
      if (_t10722._tag === 16) {
        const fields = _t10722._val;
        function _t10745(__p347) {
          let _t10747;
          const _t10746 = __p347;
          _t10748: {
            if (true) {
              const e = _t10746[1];
              _t10747 = Js_codegen$expr_has_unhandled_perform(handled_ops, e);
              break _t10748;
            }
            _match_fail("line 15950");
          }
          return _t10747;
        }
        _t10723 = List$exists(_t10745, fields);
        break _t10724;
      }
      if (_t10722._tag === 13) {
        const e1 = _t10722._val[1];
        const e2 = _t10722._val[2];
        _t10723 = (Js_codegen$expr_has_unhandled_perform(handled_ops, e1) || Js_codegen$expr_has_unhandled_perform(handled_ops, e2));
        break _t10724;
      }
      if (_t10722._tag === 14) {
        const e = _t10722._val[1];
        const _t10749 = handled_ops;
        const _t10750 = e;
        handled_ops = _t10749;
        te = _t10750;
        continue;
        _t10723 = undefined;
        break _t10724;
      }
      if (true) {
        _t10723 = false;
        break _t10724;
      }
      _match_fail("line 15950");
    }
    return _t10723;
  }
}
function Js_codegen$is_exportable_name(name) {
  return (!((String$length(name) >= 2) && ((String$get(name, 0) === 95) && (String$get(name, 1) === 95))));
}
function Js_codegen$compile_non_tail(ctx, te) {
  const saved_10751 = ctx.in_tail_position;
  (ctx.in_tail_position = false, undefined);
  const r_10753 = Js_codegen$compile_expr(ctx, te);
  (ctx.in_tail_position = saved_10751, undefined);
  const _t10754 = r_10753;
  const _t10752 = _t10754;
  return _t10752;
}
function Js_codegen$compile_expr(ctx, te) {
  while (true) {
    let _t10756;
    const _t10755 = te.expr;
    _t10757: {
      if (_t10755._tag === 0) {
        const n = _t10755._val;
        let _t10758;
        if ((n < 0)) {
          _t10758 = (("(" + __dict_Show_int.show(n)) + ")");
        } else {
          _t10758 = string_of_int(n);
        }
        _t10756 = _t10758;
        break _t10757;
      }
      if (_t10755._tag === 1) {
        const f = _t10755._val;
        const s_10759 = __dict_Show_float.show(f);
        let _t10761;
        if ((String$contains(".", s_10759) || (String$contains("e", s_10759) || String$contains("i", s_10759)))) {
          _t10761 = s_10759;
        } else {
          _t10761 = (s_10759 + ".0");
        }
        const _t10760 = _t10761;
        _t10756 = _t10760;
        break _t10757;
      }
      if (_t10755._tag === 2 && _t10755._val) {
        _t10756 = "true";
        break _t10757;
      }
      if (_t10755._tag === 2 && !_t10755._val) {
        _t10756 = "false";
        break _t10757;
      }
      if (_t10755._tag === 3) {
        const s = _t10755._val;
        _t10756 = Js_codegen$escape_js_string(s);
        break _t10757;
      }
      if (_t10755._tag === 4) {
        const n = _t10755._val;
        _t10756 = string_of_int(n);
        break _t10757;
      }
      if (_t10755._tag === 5) {
        const n = _t10755._val;
        _t10756 = string_of_int(n);
        break _t10757;
      }
      if (_t10755._tag === 6) {
        _t10756 = "undefined";
        break _t10757;
      }
      if (_t10755._tag === 22) {
        _t10756 = "null";
        break _t10757;
      }
      if (_t10755._tag === 7) {
        const name = _t10755._val;
        _t10756 = Js_codegen$lookup_var(ctx, name);
        break _t10757;
      }
      if (_t10755._tag === 8) {
        const name = _t10755._val[0];
        const _scheme = _t10755._val[1];
        const e1 = _t10755._val[2];
        const e2 = _t10755._val[3];
        _t10756 = Js_codegen$compile_let(ctx, name, e1, e2);
        break _t10757;
      }
      if (_t10755._tag === 9) {
        const name = _t10755._val[0];
        const _scheme = _t10755._val[1];
        const fn_expr = _t10755._val[2];
        const body = _t10755._val[3];
        _t10756 = Js_codegen$compile_letrec(ctx, name, fn_expr, body);
        break _t10757;
      }
      if (_t10755._tag === 37) {
        const bindings = _t10755._val[0];
        const body = _t10755._val[1];
        _t10756 = Js_codegen$compile_letrec_and(ctx, bindings, body);
        break _t10757;
      }
      if (_t10755._tag === 10) {
        const param = _t10755._val[0];
        const body = _t10755._val[1];
        const _has_return = _t10755._val[2];
        _t10756 = Js_codegen$compile_fun(ctx, param, body);
        break _t10757;
      }
      if (_t10755._tag === 11) {
        const fn_ = _t10755._val[0];
        const arg = _t10755._val[1];
        _t10756 = Js_codegen$compile_app(ctx, te, fn_, arg);
        break _t10757;
      }
      if (_t10755._tag === 13) {
        const op = _t10755._val[0];
        const e1 = _t10755._val[1];
        const e2 = _t10755._val[2];
        _t10756 = Js_codegen$compile_binop(ctx, op, e1, e2);
        break _t10757;
      }
      if (_t10755._tag === 14) {
        const op = _t10755._val[0];
        const e = _t10755._val[1];
        _t10756 = Js_codegen$compile_unop(ctx, op, e);
        break _t10757;
      }
      if (_t10755._tag === 12) {
        const cond = _t10755._val[0];
        const then_e = _t10755._val[1];
        const else_e = _t10755._val[2];
        _t10756 = Js_codegen$compile_if(ctx, cond, then_e, else_e);
        break _t10757;
      }
      if (_t10755._tag === 15) {
        const exprs = _t10755._val;
        const elts_10762 = List$map(_call(Js_codegen$compile_non_tail, [ctx]), exprs);
        const _t10763 = ("[" + (String$concat(", ", elts_10762) + "]"));
        _t10756 = _t10763;
        break _t10757;
      }
      if (_t10755._tag === 16) {
        const fields = _t10755._val;
        function _t10764(__p348, __p349) {
          let _t10766;
          const _t10765 = __p348;
          _t10767: {
            if (true) {
              const a = _t10765[0];
              let _t10769;
              const _t10768 = __p349;
              _t10770: {
                if (true) {
                  const b = _t10768[0];
                  _t10769 = String$compare(a, b);
                  break _t10770;
                }
                _match_fail("line 15950");
              }
              _t10766 = _t10769;
              break _t10767;
            }
            _match_fail("line 15950");
          }
          return _t10766;
        }
        const sorted_10771 = List$sort(_t10764, fields);
        function _t10773(__p350) {
          let _t10775;
          const _t10774 = __p350;
          _t10776: {
            if (true) {
              const name = _t10774[0];
              const e = _t10774[1];
              const js_name_10777 = Js_codegen$mangle_name(name);
              const v_10779 = Js_codegen$compile_non_tail(ctx, e);
              let _t10781;
              if ((js_name_10777 === name)) {
                _t10781 = (name + (": " + v_10779));
              } else {
                _t10781 = ((__dict_Show_string.show(js_name_10777) + ": ") + __dict_Show_string.show(v_10779));
              }
              const _t10780 = _t10781;
              const _t10778 = _t10780;
              _t10775 = _t10778;
              break _t10776;
            }
            _match_fail("line 15950");
          }
          return _t10775;
        }
        const field_strs_10782 = List$map(_t10773, sorted_10771);
        const _t10783 = ("({" + (String$concat(", ", field_strs_10782) + "})"));
        const _t10772 = _t10783;
        _t10756 = _t10772;
        break _t10757;
      }
      if (_t10755._tag === 17) {
        const base = _t10755._val[0];
        const overrides = _t10755._val[1];
        const base_js_10784 = Js_codegen$compile_non_tail(ctx, base);
        function _t10786(__p351) {
          let _t10788;
          const _t10787 = __p351;
          _t10789: {
            if (true) {
              const name = _t10787[0];
              const e = _t10787[1];
              const js_name_10790 = Js_codegen$mangle_name(name);
              const _t10791 = (js_name_10790 + (": " + Js_codegen$compile_non_tail(ctx, e)));
              _t10788 = _t10791;
              break _t10789;
            }
            _match_fail("line 15950");
          }
          return _t10788;
        }
        const field_strs_10792 = List$map(_t10786, overrides);
        const _t10793 = ("({..." + (base_js_10784 + (", " + (String$concat(", ", field_strs_10792) + "})"))));
        const _t10785 = _t10793;
        _t10756 = _t10785;
        break _t10757;
      }
      if (_t10755._tag === 18) {
        const base = _t10755._val[0];
        const pairs = _t10755._val[1];
        const tmp_10794 = Js_codegen$fresh_tmp(ctx);
        const base_js_10796 = Js_codegen$compile_non_tail(ctx, base);
        function _t10798(__p352) {
          let _t10800;
          const _t10799 = __p352;
          _t10801: {
            if (true) {
              const idx_e = _t10799[0];
              const val_e = _t10799[1];
              const idx_js_10802 = Js_codegen$compile_non_tail(ctx, idx_e);
              const val_js_10804 = Js_codegen$compile_non_tail(ctx, val_e);
              const _t10805 = ((("[" + __dict_Show_string.show(idx_js_10802)) + "]: ") + __dict_Show_string.show(val_js_10804));
              const _t10803 = _t10805;
              _t10800 = _t10803;
              break _t10801;
            }
            _match_fail("line 15950");
          }
          return _t10800;
        }
        const pair_strs_10806 = List$map(_t10798, pairs);
        const _t10807 = (((((((("(" + __dict_Show_string.show(tmp_10794)) + " = {...") + __dict_Show_string.show(base_js_10796)) + ", ") + __dict_Show_string.show(String$concat(", ", pair_strs_10806))) + "}, ") + __dict_Show_string.show(tmp_10794)) + ")");
        const _t10797 = _t10807;
        const _t10795 = _t10797;
        _t10756 = _t10795;
        break _t10757;
      }
      if (_t10755._tag === 19) {
        const e = _t10755._val[0];
        const field = _t10755._val[1];
        const base_10808 = Js_codegen$compile_non_tail(ctx, e);
        const _t10809 = (base_10808 + ("." + Js_codegen$mangle_name(field)));
        _t10756 = _t10809;
        break _t10757;
      }
      if (_t10755._tag === 20) {
        const base_e = _t10755._val[0];
        const idx_e = _t10755._val[1];
        const base_10810 = Js_codegen$compile_non_tail(ctx, base_e);
        const idx_10812 = Js_codegen$compile_non_tail(ctx, idx_e);
        const resolved_10814 = Types$repr(base_e.ty);
        let _t10817;
        const _t10816 = resolved_10814;
        _t10818: {
          if (_t10816._tag === 13) {
            _t10817 = (base_10810 + (".get(" + (idx_10812 + ")")));
            break _t10818;
          }
          if (_t10816._tag === 3) {
            _t10817 = (base_10810 + (".charCodeAt(" + (idx_10812 + ")")));
            break _t10818;
          }
          if (_t10816._tag === 14) {
            _t10817 = (base_10810 + ("._arr[" + (idx_10812 + "]")));
            break _t10818;
          }
          if (true) {
            _t10817 = (base_10810 + ("[" + (idx_10812 + "]")));
            break _t10818;
          }
          _match_fail("line 15950");
        }
        const _t10815 = _t10817;
        const _t10813 = _t10815;
        const _t10811 = _t10813;
        _t10756 = _t10811;
        break _t10757;
      }
      if (_t10755._tag === 21) {
        const hd = _t10755._val[0];
        const tl = _t10755._val[1];
        const hd_js_10819 = Js_codegen$compile_non_tail(ctx, hd);
        const tl_js_10821 = Js_codegen$compile_non_tail(ctx, tl);
        const _t10822 = ("({_hd: " + (hd_js_10819 + (", _tl: " + (tl_js_10821 + "})"))));
        const _t10820 = _t10822;
        _t10756 = _t10820;
        break _t10757;
      }
      if (_t10755._tag === 23) {
        const name = _t10755._val[0];
        const arg = _t10755._val[1];
        let _t10823;
        if (((String$length(name) > 0) && (String$get(name, 0) === 96))) {
          _t10823 = (__dict_Hash_string.hash(String$sub(name, 1, (String$length(name) - 1))) & 1073741823);
        } else {
          _t10823 = Js_codegen$tag_for_constructor(ctx.type_env, name);
        }
        const tag_10824 = _t10823;
        const sname_10826 = Js_codegen$short_constructor_name(name);
        let _t10829;
        const _t10828 = arg;
        _t10830: {
          if (_t10828._tag === 1) {
            const e = _t10828._val;
            const v_10831 = Js_codegen$compile_non_tail(ctx, e);
            const _t10832 = (((((("({_tag: " + __dict_Show_int.show(tag_10824)) + ", _name: ") + __dict_Show_string.show(Js_codegen$escape_js_string(sname_10826))) + ", _val: ") + __dict_Show_string.show(v_10831)) + "})");
            _t10829 = _t10832;
            break _t10830;
          }
          if (_t10828._tag === 0) {
            _t10829 = (((("({_tag: " + __dict_Show_int.show(tag_10824)) + ", _name: ") + __dict_Show_string.show(Js_codegen$escape_js_string(sname_10826))) + "})");
            break _t10830;
          }
          _match_fail("line 15950");
        }
        const _t10827 = _t10829;
        const _t10825 = _t10827;
        _t10756 = _t10825;
        break _t10757;
      }
      if (_t10755._tag === 24) {
        const scrut = _t10755._val[0];
        const arms = _t10755._val[1];
        const _partial = _t10755._val[2];
        _t10756 = Js_codegen$compile_match(ctx, scrut, arms, te.loc);
        break _t10757;
      }
      if (_t10755._tag === 28) {
        const e1 = _t10755._val[0];
        const e2 = _t10755._val[1];
        _t10756 = Js_codegen$compile_seq(ctx, e1, e2);
        break _t10757;
      }
      if (_t10755._tag === 25) {
        const name = _t10755._val[0];
        const init = _t10755._val[1];
        const body = _t10755._val[2];
        _t10756 = Js_codegen$compile_let_mut(ctx, name, init, body);
        break _t10757;
      }
      if (_t10755._tag === 26) {
        const name = _t10755._val[0];
        const e = _t10755._val[1];
        const js_name_10833 = Js_codegen$lookup_var(ctx, name);
        const v_10835 = Js_codegen$compile_non_tail(ctx, e);
        const _t10836 = ("(" + (js_name_10833 + (" = " + (v_10835 + ", undefined)"))));
        const _t10834 = _t10836;
        _t10756 = _t10834;
        break _t10757;
      }
      if (_t10755._tag === 27) {
        const record_e = _t10755._val[0];
        const field = _t10755._val[1];
        const value_e = _t10755._val[2];
        const base_10837 = Js_codegen$compile_non_tail(ctx, record_e);
        const v_10839 = Js_codegen$compile_non_tail(ctx, value_e);
        const _t10840 = ("(" + (base_10837 + ("." + (Js_codegen$mangle_name(field) + (" = " + (v_10839 + ", undefined)"))))));
        const _t10838 = _t10840;
        _t10756 = _t10838;
        break _t10757;
      }
      if (_t10755._tag === 32) {
        const cond = _t10755._val[0];
        const body = _t10755._val[1];
        _t10756 = Js_codegen$compile_while(ctx, cond, body);
        break _t10757;
      }
      if (_t10755._tag === 33) {
        const value_te = _t10755._val;
        const v_10841 = Js_codegen$compile_non_tail(ctx, value_te);
        const _t10842 = ("(" + (ctx.break_val_name + (" = " + (v_10841 + (", " + (ctx.break_flag_name + " = true, undefined)"))))));
        _t10756 = _t10842;
        break _t10757;
      }
      if (_t10755._tag === 34) {
        _t10756 = "(_cont_flag = true, undefined)";
        break _t10757;
      }
      if (_t10755._tag === 35) {
        const value_te = _t10755._val;
        const v_10843 = Js_codegen$compile_non_tail(ctx, value_te);
        const _t10844 = ("(_fold_cont_val = " + (v_10843 + ", _fold_cont_flag = true, undefined)"));
        _t10756 = _t10844;
        break _t10757;
      }
      if (_t10755._tag === 36) {
        const fold_te = _t10755._val;
        const _t10845 = ctx;
        const _t10846 = fold_te;
        ctx = _t10845;
        te = _t10846;
        continue;
        _t10756 = undefined;
        break _t10757;
      }
      if (_t10755._tag === 38) {
        const pairs = _t10755._val;
        function _t10847(__p353) {
          let _t10849;
          const _t10848 = __p353;
          _t10850: {
            if (true) {
              const k = _t10848[0];
              const v = _t10848[1];
              _t10849 = ("[" + (Js_codegen$compile_non_tail(ctx, k) + (", " + (Js_codegen$compile_non_tail(ctx, v) + "]"))));
              break _t10850;
            }
            _match_fail("line 15950");
          }
          return _t10849;
        }
        const pair_strs_10851 = List$map(_t10847, pairs);
        const _t10852 = ("new Map([" + (String$concat(", ", pair_strs_10851) + "])"));
        _t10756 = _t10852;
        break _t10757;
      }
      if (_t10755._tag === 39) {
        const elts = _t10755._val;
        const elt_strs_10853 = List$map(_call(Js_codegen$compile_non_tail, [ctx]), elts);
        const _t10854 = ("{_arr: [" + (String$concat(", ", elt_strs_10853) + "]}"));
        _t10756 = _t10854;
        break _t10757;
      }
      if (_t10755._tag === 40) {
        const value_te = _t10755._val;
        const v_10855 = Js_codegen$compile_non_tail(ctx, value_te);
        const _t10856 = ("(_ret_val = " + (v_10855 + ", _ret_flag = true, undefined)"));
        _t10756 = _t10856;
        break _t10757;
      }
      if (_t10755._tag === 29) {
        const op_name = _t10755._val[0];
        const arg = _t10755._val[1];
        let _t10858;
        const _t10857 = List$assoc_opt(op_name, ctx.direct_dispatch_ops);
        _t10859: {
          if (_t10857._tag === 1) {
            const direct_fn = _t10857._val;
            const arg_js_10860 = Js_codegen$compile_non_tail(ctx, arg);
            const _t10861 = (direct_fn + ("(" + (arg_js_10860 + ")")));
            _t10858 = _t10861;
            break _t10859;
          }
          if (_t10857._tag === 0) {
            if (List$mem(op_name, ctx.trywith_ops)) {
              const arg_js_10862 = Js_codegen$compile_non_tail(ctx, arg);
              const result_10864 = Js_codegen$fresh_tmp(ctx);
              Js_codegen$emit_line(ctx, (((("throw {_e: \"" + __dict_Show_string.show(op_name)) + "\", _v: ") + __dict_Show_string.show(arg_js_10862)) + "};"));
              Js_codegen$emit_line(ctx, (("const " + __dict_Show_string.show(result_10864)) + " = undefined;"));
              const _t10865 = result_10864;
              const _t10863 = _t10865;
              _t10858 = _t10863;
              break _t10859;
            }
          }
          if (_t10857._tag === 0) {
            const arg_js_10866 = Js_codegen$compile_non_tail(ctx, arg);
            const result_10868 = Js_codegen$fresh_tmp(ctx);
            Js_codegen$emit_line(ctx, (((((("const " + __dict_Show_string.show(result_10868)) + " = _trampoline(function() { return _h[\"") + __dict_Show_string.show(op_name)) + "\"](") + __dict_Show_string.show(arg_js_10866)) + ", function(_r) { return _r; }); });"));
            const _t10869 = result_10868;
            const _t10867 = _t10869;
            _t10858 = _t10867;
            break _t10859;
          }
          _match_fail("line 15950");
        }
        _t10756 = _t10858;
        break _t10757;
      }
      if (_t10755._tag === 30) {
        const body = _t10755._val[0];
        const arms = _t10755._val[1];
        _t10756 = Js_codegen$compile_handle(ctx, body, arms);
        break _t10757;
      }
      if (_t10755._tag === 31) {
        const _k_expr = _t10755._val[0];
        const val_expr = _t10755._val[1];
        if (ctx.simple_handler_mode) {
          _t10756 = Js_codegen$compile_non_tail(ctx, val_expr);
          break _t10757;
        }
      }
      if (_t10755._tag === 31) {
        const k_expr = _t10755._val[0];
        const val_expr = _t10755._val[1];
        const k_js_10870 = Js_codegen$compile_non_tail(ctx, k_expr);
        const v_js_10872 = Js_codegen$compile_non_tail(ctx, val_expr);
        let _t10874;
        if (ctx.handler_tail_resume) {
          _t10874 = (k_js_10870 + ("(" + (v_js_10872 + ")")));
        } else {
          _t10874 = ("_trampoline(function() { return " + (k_js_10870 + ("(" + (v_js_10872 + "); })"))));
        }
        const _t10873 = _t10874;
        const _t10871 = _t10873;
        _t10756 = _t10871;
        break _t10757;
      }
      _match_fail("line 15950");
    }
    return _t10756;
  }
}
function Js_codegen$compile_let(ctx, name, e1, e2) {
  const v1_10875 = Js_codegen$compile_non_tail(ctx, e1);
  const js_name_10877 = Js_codegen$mangle_name(name);
  let _t10879;
  if ((js_name_10877 === "_")) {
    _t10879 = Js_codegen$fresh_tmp(ctx);
  } else {
    function _t10880(n) {
      (ctx.tmp_counter = (ctx.tmp_counter + 1), undefined);
      return n;
    }
    _t10879 = _call(_t10880, [(js_name_10877 + ("_" + (string_of_int(ctx.tmp_counter) + "")))]);
  }
  const actual_name_10881 = _t10879;
  Js_codegen$push_scope(ctx);
  Js_codegen$bind_var(ctx, name, actual_name_10881);
  const result_10883 = Js_codegen$fresh_tmp(ctx);
  Js_codegen$emit_line(ctx, (((("const " + __dict_Show_string.show(actual_name_10881)) + " = ") + __dict_Show_string.show(v1_10875)) + ";"));
  const v2_10885 = Js_codegen$compile_expr(ctx, e2);
  Js_codegen$emit_line(ctx, (((("const " + __dict_Show_string.show(result_10883)) + " = ") + __dict_Show_string.show(v2_10885)) + ";"));
  Js_codegen$pop_scope(ctx);
  const _t10886 = result_10883;
  const _t10884 = _t10886;
  const _t10882 = _t10884;
  const _t10878 = _t10882;
  const _t10876 = _t10878;
  return _t10876;
}
function Js_codegen$compile_letrec(ctx, name, fn_expr, body) {
  const js_name_10887 = Js_codegen$mangle_name(name);
  Js_codegen$push_scope(ctx);
  Js_codegen$bind_var(ctx, name, js_name_10887);
  Js_codegen$compile_named_function(ctx, js_name_10887, fn_expr);
  const result_10889 = Js_codegen$fresh_tmp(ctx);
  const v_10891 = Js_codegen$compile_expr(ctx, body);
  Js_codegen$emit_line(ctx, (((("const " + __dict_Show_string.show(result_10889)) + " = ") + __dict_Show_string.show(v_10891)) + ";"));
  Js_codegen$pop_scope(ctx);
  const _t10892 = result_10889;
  const _t10890 = _t10892;
  const _t10888 = _t10890;
  return _t10888;
}
function Js_codegen$compile_letrec_and(ctx, bindings, body) {
  Js_codegen$push_scope(ctx);
  function _t10893(__p354) {
    let _t10895;
    const _t10894 = __p354;
    _t10896: {
      if (true) {
        const name = _t10894[0];
        const js_name_10897 = Js_codegen$mangle_name(name);
        const _t10898 = Js_codegen$bind_var(ctx, name, js_name_10897);
        _t10895 = _t10898;
        break _t10896;
      }
      _match_fail("line 15950");
    }
    return _t10895;
  }
  List$iter(_t10893, bindings);
  function _t10899(__p355) {
    let _t10901;
    const _t10900 = __p355;
    _t10902: {
      if (true) {
        const name = _t10900[0];
        const fn_expr = _t10900[1];
        const js_name_10903 = Js_codegen$mangle_name(name);
        const _t10904 = Js_codegen$compile_named_function(ctx, js_name_10903, fn_expr);
        _t10901 = _t10904;
        break _t10902;
      }
      _match_fail("line 15950");
    }
    return _t10901;
  }
  List$iter(_t10899, bindings);
  const result_10905 = Js_codegen$fresh_tmp(ctx);
  const v_10907 = Js_codegen$compile_expr(ctx, body);
  Js_codegen$emit_line(ctx, (((("const " + __dict_Show_string.show(result_10905)) + " = ") + __dict_Show_string.show(v_10907)) + ";"));
  Js_codegen$pop_scope(ctx);
  const _t10908 = result_10905;
  const _t10906 = _t10908;
  return _t10906;
}
function Js_codegen$compile_fun(ctx, param, body) {
  function collect_params(params, body_expr) {
    while (true) {
      let _t10910;
      const _t10909 = body_expr.expr;
      _t10911: {
        if (_t10909._tag === 10) {
          const p = _t10909._val[0];
          const inner = _t10909._val[1];
          const _t10912 = ({_hd: p, _tl: params});
          const _t10913 = inner;
          params = _t10912;
          body_expr = _t10913;
          continue;
          _t10910 = undefined;
          break _t10911;
        }
        if (true) {
          _t10910 = [List$rev(params), body_expr];
          break _t10911;
        }
        _match_fail("line 15950");
      }
      return _t10910;
    }
  }
  let _t10916;
  const _t10915 = collect_params(({_hd: param, _tl: null}), body);
  _t10917: {
    if (true) {
      const all_params = _t10915[0];
      const final_body = _t10915[1];
      const js_params_10918 = Js_codegen$dedup_js_params(List$map(Js_codegen$mangle_name, all_params));
      const fn_name_10920 = Js_codegen$fresh_tmp(ctx);
      Js_codegen$emit_indent(ctx);
      Js_codegen$emit(ctx, (((("function " + __dict_Show_string.show(fn_name_10920)) + "(") + __dict_Show_string.show(String$concat(", ", js_params_10918))) + ") "));
      Js_codegen$emit(ctx, "{\n");
      (ctx.indent = (ctx.indent + 1), undefined);
      Js_codegen$push_scope(ctx);
      function _t10922(mml_name, js_name) {
        return Js_codegen$bind_var(ctx, mml_name, js_name);
      }
      List$iter2(_t10922, all_params, js_params_10918);
      const saved_fn_10923 = ctx.current_fn_name;
      const saved_params_10925 = ctx.current_fn_params;
      const saved_tco_10927 = ctx.tco_used;
      (ctx.current_fn_name = ({_tag: 0, _name: "None"}), undefined);
      (ctx.current_fn_params = null, undefined);
      (ctx.tco_used = false, undefined);
      const saved_ddo_10929 = ctx.direct_dispatch_ops;
      const saved_two_10931 = ctx.trywith_ops;
      (ctx.direct_dispatch_ops = null, undefined);
      (ctx.trywith_ops = null, undefined);
      let _t10933;
      if (Js_codegen$expr_has_perform(final_body)) {
        Js_codegen$emit_line(ctx, "return _trampoline(function() {");
        (ctx.indent = (ctx.indent + 1), undefined);
        function _t10934(v) {
          return Js_codegen$emit_line(ctx, (("return " + __dict_Show_string.show(v)) + ";"));
        }
        Js_codegen$compile_cps(ctx, final_body, _t10934);
        (ctx.indent = (ctx.indent - 1), undefined);
        _t10933 = Js_codegen$emit_line(ctx, "});");
      } else {
        const v_10935 = Js_codegen$compile_expr(ctx, final_body);
        const _t10936 = Js_codegen$emit_line(ctx, (("return " + __dict_Show_string.show(v_10935)) + ";"));
        _t10933 = _t10936;
      }
      _t10933;
      (ctx.direct_dispatch_ops = saved_ddo_10929, undefined);
      (ctx.trywith_ops = saved_two_10931, undefined);
      (ctx.current_fn_name = saved_fn_10923, undefined);
      (ctx.current_fn_params = saved_params_10925, undefined);
      (ctx.tco_used = saved_tco_10927, undefined);
      Js_codegen$pop_scope(ctx);
      (ctx.indent = (ctx.indent - 1), undefined);
      Js_codegen$emit_line(ctx, "}");
      const _t10932 = fn_name_10920;
      const _t10930 = _t10932;
      const _t10928 = _t10930;
      const _t10926 = _t10928;
      const _t10924 = _t10926;
      const _t10921 = _t10924;
      const _t10919 = _t10921;
      _t10916 = _t10919;
      break _t10917;
    }
    _match_fail("line 15950");
  }
  const _t10914 = _t10916;
  return _t10914;
}
function Js_codegen$compile_named_function(ctx, js_name, fn_expr) {
  function collect_params(params, body_expr) {
    while (true) {
      let _t10938;
      const _t10937 = body_expr.expr;
      _t10939: {
        if (_t10937._tag === 10) {
          const p = _t10937._val[0];
          const inner = _t10937._val[1];
          const _t10940 = ({_hd: p, _tl: params});
          const _t10941 = inner;
          params = _t10940;
          body_expr = _t10941;
          continue;
          _t10938 = undefined;
          break _t10939;
        }
        if (true) {
          _t10938 = [List$rev(params), body_expr];
          break _t10939;
        }
        _match_fail("line 15950");
      }
      return _t10938;
    }
  }
  let _t10944;
  const _t10943 = fn_expr.expr;
  _t10945: {
    if (_t10943._tag === 10) {
      const param = _t10943._val[0];
      const body = _t10943._val[1];
      const has_return = _t10943._val[2];
      let _t10947;
      const _t10946 = collect_params(({_hd: param, _tl: null}), body);
      _t10948: {
        if (true) {
          const all_params = _t10946[0];
          const final_body = _t10946[1];
          const js_params_10949 = Js_codegen$dedup_js_params(List$map(Js_codegen$mangle_name, all_params));
          Js_codegen$emit_indent(ctx);
          Js_codegen$emit(ctx, (((("function " + __dict_Show_string.show(js_name)) + "(") + __dict_Show_string.show(String$concat(", ", js_params_10949))) + ") "));
          Js_codegen$emit(ctx, "{\n");
          (ctx.indent = (ctx.indent + 1), undefined);
          Js_codegen$push_scope(ctx);
          function _t10951(mml_name, js_nm) {
            return Js_codegen$bind_var(ctx, mml_name, js_nm);
          }
          List$iter2(_t10951, all_params, js_params_10949);
          const saved_fn_10952 = ctx.current_fn_name;
          const saved_params_10954 = ctx.current_fn_params;
          const saved_tco_10956 = ctx.tco_used;
          (ctx.current_fn_name = ({_tag: 1, _name: "Some", _val: js_name}), undefined);
          (ctx.current_fn_params = js_params_10949, undefined);
          (ctx.tco_used = false, undefined);
          (ctx.in_tail_position = true, undefined);
          const saved_ddo_10958 = ctx.direct_dispatch_ops;
          const saved_two_10960 = ctx.trywith_ops;
          (ctx.direct_dispatch_ops = null, undefined);
          (ctx.trywith_ops = null, undefined);
          const body_code_start_10962 = Buffer$length(ctx.buf);
          let _t10964;
          if (Js_codegen$expr_has_perform(final_body)) {
            Js_codegen$emit_line(ctx, "return _trampoline(function() {");
            (ctx.indent = (ctx.indent + 1), undefined);
            function _t10965(v) {
              return Js_codegen$emit_line(ctx, (("return " + __dict_Show_string.show(v)) + ";"));
            }
            Js_codegen$compile_cps(ctx, final_body, _t10965);
            (ctx.indent = (ctx.indent - 1), undefined);
            _t10964 = Js_codegen$emit_line(ctx, (("}, " + __dict_Show_string.show(js_name)) + ");"));
          } else {
            let _t10966;
            if (has_return) {
              Js_codegen$emit_line(ctx, "let _ret_flag = false, _ret_val;");
              const v_10967 = Js_codegen$compile_expr(ctx, final_body);
              const _t10968 = Js_codegen$emit_line(ctx, (("return _ret_flag ? _ret_val : " + __dict_Show_string.show(v_10967)) + ";"));
              _t10966 = _t10968;
            } else {
              const v_10969 = Js_codegen$compile_expr(ctx, final_body);
              const _t10970 = Js_codegen$emit_line(ctx, (("return " + __dict_Show_string.show(v_10969)) + ";"));
              _t10966 = _t10970;
            }
            _t10964 = _t10966;
          }
          _t10964;
          const tco_was_used_10971 = ctx.tco_used;
          (ctx.direct_dispatch_ops = saved_ddo_10958, undefined);
          (ctx.trywith_ops = saved_two_10960, undefined);
          (ctx.current_fn_name = saved_fn_10952, undefined);
          (ctx.current_fn_params = saved_params_10954, undefined);
          (ctx.tco_used = saved_tco_10956, undefined);
          (ctx.in_tail_position = false, undefined);
          Js_codegen$pop_scope(ctx);
          (ctx.indent = (ctx.indent - 1), undefined);
          let _t10973;
          if (tco_was_used_10971) {
            const full_code_10974 = Buffer$contents(ctx.buf);
            const body_code_10976 = String$sub(full_code_10974, body_code_start_10962, (String$length(full_code_10974) - body_code_start_10962));
            const before_body_10978 = String$sub(full_code_10974, 0, body_code_start_10962);
            Buffer$clear(ctx.buf);
            Buffer$add_string(ctx.buf, before_body_10978);
            const indent_str_10980 = String$make(((ctx.indent + 1) * 2), 32);
            Buffer$add_string(ctx.buf, (indent_str_10980 + "while (true) {\n"));
            const body_lines_10982 = String$split("\n", body_code_10976);
            function _t10984(line) {
              let _t10985;
              if ((String$length(line) > 0)) {
                _t10985 = Buffer$add_string(ctx.buf, ("  " + (line + "\n")));
              } else {
                _t10985 = undefined;
              }
              return _t10985;
            }
            List$iter(_t10984, body_lines_10982);
            const _t10983 = Buffer$add_string(ctx.buf, (indent_str_10980 + "}\n"));
            const _t10981 = _t10983;
            const _t10979 = _t10981;
            const _t10977 = _t10979;
            const _t10975 = _t10977;
            _t10973 = _t10975;
          } else {
            _t10973 = undefined;
          }
          _t10973;
          const _t10972 = Js_codegen$emit_line(ctx, "}");
          const _t10963 = _t10972;
          const _t10961 = _t10963;
          const _t10959 = _t10961;
          const _t10957 = _t10959;
          const _t10955 = _t10957;
          const _t10953 = _t10955;
          const _t10950 = _t10953;
          _t10947 = _t10950;
          break _t10948;
        }
        _match_fail("line 15950");
      }
      _t10944 = _t10947;
      break _t10945;
    }
    if (true) {
      const v_10986 = Js_codegen$compile_expr(ctx, fn_expr);
      const _t10987 = Js_codegen$emit_line(ctx, (((("const " + __dict_Show_string.show(js_name)) + " = ") + __dict_Show_string.show(v_10986)) + ";"));
      _t10944 = _t10987;
      break _t10945;
    }
    _match_fail("line 15950");
  }
  const _t10942 = _t10944;
  return _t10942;
}
function Js_codegen$compile_app(ctx, _te, fn_, arg) {
  function collect_args(expr, acc) {
    while (true) {
      let _t10989;
      const _t10988 = expr.expr;
      _t10990: {
        if (_t10988._tag === 11) {
          const inner_fn = _t10988._val[0];
          const inner_arg = _t10988._val[1];
          const _t10991 = inner_fn;
          const _t10992 = ({_hd: inner_arg, _tl: acc});
          expr = _t10991;
          acc = _t10992;
          continue;
          _t10989 = undefined;
          break _t10990;
        }
        if (true) {
          _t10989 = [expr, acc];
          break _t10990;
        }
        _match_fail("line 15950");
      }
      return _t10989;
    }
  }
  let _t10995;
  const _t10994 = collect_args(fn_, ({_hd: arg, _tl: null}));
  _t10996: {
    if (true) {
      const base_fn = _t10994[0];
      const all_args = _t10994[1];
      const n_10997 = List$length(all_args);
      let _t11000;
      const _t10999 = [ctx.current_fn_name, base_fn.expr];
      _t11001: {
        if (_t10999[0]._tag === 1 && _t10999[1]._tag === 7) {
          const fn_name = _t10999[0]._val;
          const var_name = _t10999[1]._val;
          _t11000 = ((Js_codegen$mangle_name(var_name) === fn_name) && (n_10997 === List$length(ctx.current_fn_params)));
          break _t11001;
        }
        if (true) {
          _t11000 = false;
          break _t11001;
        }
        _match_fail("line 15950");
      }
      const is_self_call_11002 = _t11000;
      let _t11004;
      if ((is_self_call_11002 && ctx.in_tail_position)) {
        (ctx.tco_used = true, undefined);
        function _t11005(a) {
          const tmp_11006 = Js_codegen$fresh_tmp(ctx);
          const v_11008 = Js_codegen$compile_non_tail(ctx, a);
          Js_codegen$emit_line(ctx, (((("const " + __dict_Show_string.show(tmp_11006)) + " = ") + __dict_Show_string.show(v_11008)) + ";"));
          const _t11009 = tmp_11006;
          const _t11007 = _t11009;
          return _t11007;
        }
        const arg_tmps_11010 = List$map(_t11005, all_args);
        function _t11012(param, tmp) {
          return Js_codegen$emit_line(ctx, (((__dict_Show_string.show(param) + " = ") + __dict_Show_string.show(tmp)) + ";"));
        }
        List$iter2(_t11012, ctx.current_fn_params, arg_tmps_11010);
        Js_codegen$emit_line(ctx, "continue;");
        const _t11011 = "undefined";
        _t11004 = _t11011;
      } else {
        const fn_js_11013 = Js_codegen$compile_non_tail(ctx, base_fn);
        const args_js_11015 = List$map(_call(Js_codegen$compile_non_tail, [ctx]), all_args);
        const known_arity_11017 = Js_codegen$count_arrows(base_fn.ty);
        function _t11019(a) {
          let _t11021;
          const _t11020 = a.expr;
          _t11022: {
            if (_t11020._tag === 7) {
              const name = _t11020._val;
              _t11021 = (((String$length(name) >= 7) && (String$sub(name, 0, 7) === "__dict_")) || ((String$length(name) >= 5) && (String$sub(name, 0, 5) === "__ev_")));
              break _t11022;
            }
            if (true) {
              _t11021 = false;
              break _t11022;
            }
            _match_fail("line 15950");
          }
          return _t11021;
        }
        const has_implicit_args_11023 = List$exists(_t11019, all_args);
        let _t11025;
        if ((_eq(known_arity_11017, ({_tag: 1, _name: "Some", _val: n_10997})) && (!has_implicit_args_11023))) {
          _t11025 = (fn_js_11013 + ("(" + (String$concat(", ", args_js_11015) + ")")));
        } else {
          _t11025 = ("_call(" + (fn_js_11013 + (", [" + (String$concat(", ", args_js_11015) + "])"))));
        }
        const _t11024 = _t11025;
        const _t11018 = _t11024;
        const _t11016 = _t11018;
        const _t11014 = _t11016;
        _t11004 = _t11014;
      }
      const _t11003 = _t11004;
      const _t10998 = _t11003;
      _t10995 = _t10998;
      break _t10996;
    }
    _match_fail("line 15950");
  }
  const _t10993 = _t10995;
  return _t10993;
}
function Js_codegen$count_arrows(ty) {
  function go(ty, n) {
    while (true) {
      let _t11027;
      const _t11026 = Types$repr(ty);
      _t11028: {
        if (_t11026._tag === 7) {
          const ret = _t11026._val[2];
          const _t11029 = ret;
          const _t11030 = (n + 1);
          ty = _t11029;
          n = _t11030;
          continue;
          _t11027 = undefined;
          break _t11028;
        }
        if (true) {
          _t11027 = n;
          break _t11028;
        }
        _match_fail("line 15950");
      }
      return _t11027;
    }
  }
  const n_11032 = go(ty, 0);
  let _t11034;
  if ((n_11032 > 0)) {
    _t11034 = ({_tag: 1, _name: "Some", _val: n_11032});
  } else {
    _t11034 = ({_tag: 0, _name: "None"});
  }
  const _t11033 = _t11034;
  const _t11031 = _t11033;
  return _t11031;
}
function Js_codegen$compile_binop(ctx, op, e1, e2) {
  let _t11036;
  const _t11035 = op;
  _t11037: {
    if (_t11035._tag === 11) {
      const a_11038 = Js_codegen$compile_non_tail(ctx, e1);
      const buf_before_11040 = Buffer$length(ctx.buf);
      const b_11042 = Js_codegen$compile_non_tail(ctx, e2);
      let _t11044;
      if ((Buffer$length(ctx.buf) === buf_before_11040)) {
        _t11044 = ("(" + (a_11038 + (" && " + (b_11042 + ")"))));
      } else {
        const stmts_11045 = Buffer$sub(ctx.buf, buf_before_11040, (Buffer$length(ctx.buf) - buf_before_11040));
        Buffer$truncate(ctx.buf, buf_before_11040);
        const result_11047 = Js_codegen$fresh_tmp(ctx);
        Js_codegen$emit_line(ctx, (("let " + __dict_Show_string.show(result_11047)) + ";"));
        Js_codegen$emit_line(ctx, (("if (" + __dict_Show_string.show(a_11038)) + ") {"));
        (ctx.indent = (ctx.indent + 1), undefined);
        Buffer$add_string(ctx.buf, stmts_11045);
        Js_codegen$emit_line(ctx, (((__dict_Show_string.show(result_11047) + " = ") + __dict_Show_string.show(b_11042)) + ";"));
        (ctx.indent = (ctx.indent - 1), undefined);
        Js_codegen$emit_line(ctx, "} else {");
        (ctx.indent = (ctx.indent + 1), undefined);
        Js_codegen$emit_line(ctx, (__dict_Show_string.show(result_11047) + " = false;"));
        (ctx.indent = (ctx.indent - 1), undefined);
        Js_codegen$emit_line(ctx, "}");
        const _t11048 = result_11047;
        const _t11046 = _t11048;
        _t11044 = _t11046;
      }
      const _t11043 = _t11044;
      const _t11041 = _t11043;
      const _t11039 = _t11041;
      _t11036 = _t11039;
      break _t11037;
    }
    if (_t11035._tag === 12) {
      const a_11049 = Js_codegen$compile_non_tail(ctx, e1);
      const buf_before_11051 = Buffer$length(ctx.buf);
      const b_11053 = Js_codegen$compile_non_tail(ctx, e2);
      let _t11055;
      if ((Buffer$length(ctx.buf) === buf_before_11051)) {
        _t11055 = ("(" + (a_11049 + (" || " + (b_11053 + ")"))));
      } else {
        const stmts_11056 = Buffer$sub(ctx.buf, buf_before_11051, (Buffer$length(ctx.buf) - buf_before_11051));
        Buffer$truncate(ctx.buf, buf_before_11051);
        const result_11058 = Js_codegen$fresh_tmp(ctx);
        Js_codegen$emit_line(ctx, (("let " + __dict_Show_string.show(result_11058)) + ";"));
        Js_codegen$emit_line(ctx, (("if (" + __dict_Show_string.show(a_11049)) + ") {"));
        (ctx.indent = (ctx.indent + 1), undefined);
        Js_codegen$emit_line(ctx, (__dict_Show_string.show(result_11058) + " = true;"));
        (ctx.indent = (ctx.indent - 1), undefined);
        Js_codegen$emit_line(ctx, "} else {");
        (ctx.indent = (ctx.indent + 1), undefined);
        Buffer$add_string(ctx.buf, stmts_11056);
        Js_codegen$emit_line(ctx, (((__dict_Show_string.show(result_11058) + " = ") + __dict_Show_string.show(b_11053)) + ";"));
        (ctx.indent = (ctx.indent - 1), undefined);
        Js_codegen$emit_line(ctx, "}");
        const _t11059 = result_11058;
        const _t11057 = _t11059;
        _t11055 = _t11057;
      }
      const _t11054 = _t11055;
      const _t11052 = _t11054;
      const _t11050 = _t11052;
      _t11036 = _t11050;
      break _t11037;
    }
    if ((((_t11035._tag === 0 || _t11035._tag === 1) || _t11035._tag === 2) || _t11035._tag === 3)) {
      const resolved_11060 = Types$repr(e1.ty);
      let _t11063;
      const _t11062 = resolved_11060;
      _t11064: {
        if ((_t11062._tag === 0 || _t11062._tag === 1)) {
          const a_11065 = Js_codegen$compile_non_tail(ctx, e1);
          const b_11067 = Js_codegen$compile_non_tail(ctx, e2);
          let _t11070;
          const _t11069 = op;
          _t11071: {
            if (_t11069._tag === 0) {
              _t11070 = "+";
              break _t11071;
            }
            if (_t11069._tag === 1) {
              _t11070 = "-";
              break _t11071;
            }
            if (_t11069._tag === 2) {
              _t11070 = "*";
              break _t11071;
            }
            if (_t11069._tag === 3) {
              _t11070 = "/";
              break _t11071;
            }
            if (true) {
              _t11070 = failwith("assert false");
              break _t11071;
            }
            _match_fail("line 15950");
          }
          const js_op_11072 = _t11070;
          let _t11074;
          if ((_eq(resolved_11060, ({_tag: 0, _name: "TInt"})) && _eq(op, ({_tag: 3, _name: "Div"})))) {
            _t11074 = ("((" + (a_11065 + (" " + (js_op_11072 + (" " + (b_11067 + ") | 0)"))))));
          } else {
            _t11074 = ("(" + (a_11065 + (" " + (js_op_11072 + (" " + (b_11067 + ")"))))));
          }
          const _t11073 = _t11074;
          const _t11068 = _t11073;
          const _t11066 = _t11068;
          _t11063 = _t11066;
          break _t11064;
        }
        if (true) {
          let _t11076;
          const _t11075 = op;
          _t11077: {
            if (_t11075._tag === 0) {
              _t11076 = "+";
              break _t11077;
            }
            if (_t11075._tag === 1) {
              _t11076 = "-";
              break _t11077;
            }
            if (_t11075._tag === 2) {
              _t11076 = "*";
              break _t11077;
            }
            if (_t11075._tag === 3) {
              _t11076 = "/";
              break _t11077;
            }
            if (true) {
              _t11076 = failwith("assert false");
              break _t11077;
            }
            _match_fail("line 15950");
          }
          const method_name_11078 = _t11076;
          const _t11079 = Js_codegen$compile_class_binop(ctx, "Num", method_name_11078, e1, e2);
          _t11063 = _t11079;
          break _t11064;
        }
        _match_fail("line 15950");
      }
      const _t11061 = _t11063;
      _t11036 = _t11061;
      break _t11037;
    }
    if (_t11035._tag === 4) {
      const a_11080 = Js_codegen$compile_non_tail(ctx, e1);
      const b_11082 = Js_codegen$compile_non_tail(ctx, e2);
      const _t11083 = ("(" + (a_11080 + (" % " + (b_11082 + ")"))));
      const _t11081 = _t11083;
      _t11036 = _t11081;
      break _t11037;
    }
    if ((_t11035._tag === 5 || _t11035._tag === 6)) {
      const resolved_11084 = Types$repr(e1.ty);
      let _t11087;
      const _t11086 = resolved_11084;
      _t11088: {
        if (((((((_t11086._tag === 0 || _t11086._tag === 1) || _t11086._tag === 2) || _t11086._tag === 3) || _t11086._tag === 4) || _t11086._tag === 5) || _t11086._tag === 6)) {
          _t11087 = true;
          break _t11088;
        }
        if (true) {
          _t11087 = false;
          break _t11088;
        }
        _match_fail("line 15950");
      }
      const is_primitive_11089 = _t11087;
      const a_11091 = Js_codegen$compile_non_tail(ctx, e1);
      const b_11093 = Js_codegen$compile_non_tail(ctx, e2);
      let _t11095;
      if (is_primitive_11089) {
        let _t11096;
        if (_eq(op, ({_tag: 5, _name: "Eq"}))) {
          _t11096 = "===";
        } else {
          _t11096 = "!==";
        }
        const js_op_11097 = _t11096;
        const _t11098 = ("(" + (a_11091 + (" " + (js_op_11097 + (" " + (b_11093 + ")"))))));
        _t11095 = _t11098;
      } else {
        const eq_call_11099 = ("_eq(" + (a_11091 + (", " + (b_11093 + ")"))));
        let _t11101;
        if (_eq(op, ({_tag: 5, _name: "Eq"}))) {
          _t11101 = eq_call_11099;
        } else {
          _t11101 = ("!" + eq_call_11099);
        }
        const _t11100 = _t11101;
        _t11095 = _t11100;
      }
      const _t11094 = _t11095;
      const _t11092 = _t11094;
      const _t11090 = _t11092;
      const _t11085 = _t11090;
      _t11036 = _t11085;
      break _t11037;
    }
    if ((((_t11035._tag === 7 || _t11035._tag === 8) || _t11035._tag === 9) || _t11035._tag === 10)) {
      const resolved_11102 = Types$repr(e1.ty);
      let _t11105;
      const _t11104 = resolved_11102;
      _t11106: {
        if ((((((_t11104._tag === 0 || _t11104._tag === 1) || _t11104._tag === 3) || _t11104._tag === 4) || _t11104._tag === 5) || _t11104._tag === 16 && _t11104._val.contents._tag === 0)) {
          _t11105 = true;
          break _t11106;
        }
        if (true) {
          _t11105 = false;
          break _t11106;
        }
        _match_fail("line 15950");
      }
      const is_builtin_11107 = _t11105;
      let _t11109;
      if (is_builtin_11107) {
        const a_11110 = Js_codegen$compile_non_tail(ctx, e1);
        const b_11112 = Js_codegen$compile_non_tail(ctx, e2);
        let _t11115;
        const _t11114 = op;
        _t11116: {
          if (_t11114._tag === 7) {
            _t11115 = "<";
            break _t11116;
          }
          if (_t11114._tag === 8) {
            _t11115 = ">";
            break _t11116;
          }
          if (_t11114._tag === 9) {
            _t11115 = "<=";
            break _t11116;
          }
          if (_t11114._tag === 10) {
            _t11115 = ">=";
            break _t11116;
          }
          if (true) {
            _t11115 = failwith("assert false");
            break _t11116;
          }
          _match_fail("line 15950");
        }
        const js_op_11117 = _t11115;
        const _t11118 = ("(" + (a_11110 + (" " + (js_op_11117 + (" " + (b_11112 + ")"))))));
        const _t11113 = _t11118;
        const _t11111 = _t11113;
        _t11109 = _t11111;
      } else {
        let _t11120;
        const _t11119 = op;
        _t11121: {
          if (_t11119._tag === 7) {
            _t11120 = "<";
            break _t11121;
          }
          if (_t11119._tag === 8) {
            _t11120 = ">";
            break _t11121;
          }
          if (_t11119._tag === 9) {
            _t11120 = "<=";
            break _t11121;
          }
          if (_t11119._tag === 10) {
            _t11120 = ">=";
            break _t11121;
          }
          if (true) {
            _t11120 = failwith("assert false");
            break _t11121;
          }
          _match_fail("line 15950");
        }
        const method_name_11122 = _t11120;
        const _t11123 = Js_codegen$compile_class_binop(ctx, "Ord", method_name_11122, e1, e2);
        _t11109 = _t11123;
      }
      const _t11108 = _t11109;
      const _t11103 = _t11108;
      _t11036 = _t11103;
      break _t11037;
    }
    if (_t11035._tag === 13) {
      const a_11124 = Js_codegen$compile_non_tail(ctx, e1);
      const b_11126 = Js_codegen$compile_non_tail(ctx, e2);
      const _t11127 = ("(" + (a_11124 + (" + " + (b_11126 + ")"))));
      const _t11125 = _t11127;
      _t11036 = _t11125;
      break _t11037;
    }
    if (((((_t11035._tag === 14 || _t11035._tag === 15) || _t11035._tag === 16) || _t11035._tag === 17) || _t11035._tag === 18)) {
      const resolved_11128 = Types$repr(e1.ty);
      let _t11131;
      const _t11130 = resolved_11128;
      _t11132: {
        if (_t11130._tag === 0) {
          const a_11133 = Js_codegen$compile_non_tail(ctx, e1);
          const b_11135 = Js_codegen$compile_non_tail(ctx, e2);
          let _t11138;
          const _t11137 = op;
          _t11139: {
            if (_t11137._tag === 14) {
              _t11138 = "&";
              break _t11139;
            }
            if (_t11137._tag === 15) {
              _t11138 = "|";
              break _t11139;
            }
            if (_t11137._tag === 16) {
              _t11138 = "^";
              break _t11139;
            }
            if (_t11137._tag === 17) {
              _t11138 = "<<";
              break _t11139;
            }
            if (_t11137._tag === 18) {
              _t11138 = ">>";
              break _t11139;
            }
            if (true) {
              _t11138 = failwith("assert false");
              break _t11139;
            }
            _match_fail("line 15950");
          }
          const js_op_11140 = _t11138;
          const _t11141 = ("(" + (a_11133 + (" " + (js_op_11140 + (" " + (b_11135 + ")"))))));
          const _t11136 = _t11141;
          const _t11134 = _t11136;
          _t11131 = _t11134;
          break _t11132;
        }
        if (true) {
          let _t11143;
          const _t11142 = op;
          _t11144: {
            if (_t11142._tag === 14) {
              _t11143 = "land";
              break _t11144;
            }
            if (_t11142._tag === 15) {
              _t11143 = "lor";
              break _t11144;
            }
            if (_t11142._tag === 16) {
              _t11143 = "lxor";
              break _t11144;
            }
            if (_t11142._tag === 17) {
              _t11143 = "lsl";
              break _t11144;
            }
            if (_t11142._tag === 18) {
              _t11143 = "lsr";
              break _t11144;
            }
            if (true) {
              _t11143 = failwith("assert false");
              break _t11144;
            }
            _match_fail("line 15950");
          }
          const method_name_11145 = _t11143;
          const _t11146 = Js_codegen$compile_class_binop(ctx, "Bitwise", method_name_11145, e1, e2);
          _t11131 = _t11146;
          break _t11132;
        }
        _match_fail("line 15950");
      }
      const _t11129 = _t11131;
      _t11036 = _t11129;
      break _t11037;
    }
    if (_t11035._tag === 19) {
      const fn_js_11147 = Js_codegen$compile_non_tail(ctx, e2);
      const arg_js_11149 = Js_codegen$compile_non_tail(ctx, e1);
      const _t11150 = ("_call(" + (fn_js_11147 + (", [" + (arg_js_11149 + "])"))));
      const _t11148 = _t11150;
      _t11036 = _t11148;
      break _t11037;
    }
    _match_fail("line 15950");
  }
  return _t11036;
}
function Js_codegen$compile_class_binop(ctx, class_name, method_name, e1, e2) {
  const conc_ty_11151 = Types$repr(e1.ty);
  function _t11153(c) {
    return (c.class_name === class_name);
  }
  let _t11155;
  const _t11154 = List$find(_t11153, ctx.type_env.classes);
  _t11156: {
    if (_t11154._tag === 1) {
      const cd = _t11154._val;
      _t11155 = cd;
      break _t11156;
    }
    if (_t11154._tag === 0) {
      _t11155 = Js_codegen$error((("class " + __dict_Show_string.show(class_name)) + " not found"));
      break _t11156;
    }
    _match_fail("line 15950");
  }
  const class_def_11157 = _t11155;
  const num_params_11159 = List$length(class_def_11157.class_params);
  function _t11161(_) {
    return ({_tag: 1, _name: "Some", _val: conc_ty_11151});
  }
  const partial_11162 = List$init(num_params_11159, _t11161);
  function _t11164(opt) {
    let _t11166;
    const _t11165 = opt;
    _t11167: {
      if (_t11165._tag === 1) {
        const ty = _t11165._val;
        let _t11169;
        const _t11168 = Types$repr(ty);
        _t11170: {
          if (_t11168._tag === 16 && _t11168._val.contents._tag === 0) {
            _t11169 = ({_tag: 0, _name: "None"});
            break _t11170;
          }
          if (true) {
            _t11169 = ({_tag: 1, _name: "Some", _val: Types$repr(ty)});
            break _t11170;
          }
          _match_fail("line 15950");
        }
        _t11166 = _t11169;
        break _t11167;
      }
      if (_t11165._tag === 0) {
        _t11166 = ({_tag: 0, _name: "None"});
        break _t11167;
      }
      _match_fail("line 15950");
    }
    return _t11166;
  }
  const concrete_partial_11171 = List$map(_t11164, partial_11162);
  function _t11173(inst) {
    return ((inst.inst_class === class_name) && ((List$length(inst.inst_tys) === num_params_11159) && Types$match_partial_inst(inst.inst_tys, concrete_partial_11171)));
  }
  const matching_11174 = List$filter(_t11173, ctx.type_env.instances);
  let _t11177;
  const _t11176 = matching_11174;
  _t11178: {
    if (_t11176 !== null && _t11176._tl === null) {
      const inst = _t11176._hd;
      const dict_access_11179 = (Js_codegen$mangle_name(inst.inst_dict_name) + ("." + Js_codegen$mangle_name(method_name)));
      const a_11181 = Js_codegen$compile_non_tail(ctx, e1);
      const b_11183 = Js_codegen$compile_non_tail(ctx, e2);
      const _t11184 = ("_call(" + (dict_access_11179 + (", [" + (a_11181 + (", " + (b_11183 + "])"))))));
      const _t11182 = _t11184;
      const _t11180 = _t11182;
      _t11177 = _t11180;
      break _t11178;
    }
    if (_t11176 === null) {
      _t11177 = Js_codegen$error(((("no instance of " + __dict_Show_string.show(class_name)) + " for type ") + __dict_Show_string.show(Types$pp_ty(conc_ty_11151))));
      break _t11178;
    }
    if (true) {
      let _t11186;
      const _t11185 = Types$most_specific_inst(matching_11174);
      _t11187: {
        if (_t11185._tag === 1) {
          const inst = _t11185._val;
          let _t11188;
          if (_eq(inst.inst_constraints, null)) {
            _t11188 = Js_codegen$mangle_name((inst.inst_dict_name + ("$" + method_name)));
          } else {
            _t11188 = (Js_codegen$mangle_name(inst.inst_dict_name) + ("." + Js_codegen$mangle_name(method_name)));
          }
          const dict_access_11189 = _t11188;
          const a_11191 = Js_codegen$compile_non_tail(ctx, e1);
          const b_11193 = Js_codegen$compile_non_tail(ctx, e2);
          const _t11194 = ("_call(" + (dict_access_11189 + (", [" + (a_11191 + (", " + (b_11193 + "])"))))));
          const _t11192 = _t11194;
          const _t11190 = _t11192;
          _t11186 = _t11190;
          break _t11187;
        }
        if (_t11185._tag === 0) {
          _t11186 = Js_codegen$error(((("ambiguous instance for " + __dict_Show_string.show(class_name)) + " method ") + __dict_Show_string.show(method_name)));
          break _t11187;
        }
        _match_fail("line 15950");
      }
      _t11177 = _t11186;
      break _t11178;
    }
    _match_fail("line 15950");
  }
  const _t11175 = _t11177;
  const _t11172 = _t11175;
  const _t11163 = _t11172;
  const _t11160 = _t11163;
  const _t11158 = _t11160;
  const _t11152 = _t11158;
  return _t11152;
}
function Js_codegen$compile_unop(ctx, op, e) {
  let _t11196;
  const _t11195 = op;
  _t11197: {
    if (_t11195._tag === 0) {
      const resolved_11198 = Types$repr(e.ty);
      let _t11201;
      const _t11200 = resolved_11198;
      _t11202: {
        if ((_t11200._tag === 0 || _t11200._tag === 1)) {
          const v_11203 = Js_codegen$compile_non_tail(ctx, e);
          const _t11204 = ("(-" + (v_11203 + ")"));
          _t11201 = _t11204;
          break _t11202;
        }
        if (true) {
          _t11201 = Js_codegen$compile_class_unop(ctx, "Num", "neg", e);
          break _t11202;
        }
        _match_fail("line 15950");
      }
      const _t11199 = _t11201;
      _t11196 = _t11199;
      break _t11197;
    }
    if (_t11195._tag === 1) {
      const v_11205 = Js_codegen$compile_non_tail(ctx, e);
      const _t11206 = ("(!" + (v_11205 + ")"));
      _t11196 = _t11206;
      break _t11197;
    }
    if (_t11195._tag === 2) {
      const resolved_11207 = Types$repr(e.ty);
      let _t11210;
      const _t11209 = resolved_11207;
      _t11211: {
        if (_t11209._tag === 0) {
          const v_11212 = Js_codegen$compile_non_tail(ctx, e);
          const _t11213 = ("(~" + (v_11212 + ")"));
          _t11210 = _t11213;
          break _t11211;
        }
        if (true) {
          _t11210 = Js_codegen$compile_class_unop(ctx, "Bitwise", "lnot", e);
          break _t11211;
        }
        _match_fail("line 15950");
      }
      const _t11208 = _t11210;
      _t11196 = _t11208;
      break _t11197;
    }
    _match_fail("line 15950");
  }
  return _t11196;
}
function Js_codegen$compile_class_unop(ctx, class_name, method_name, e) {
  const conc_ty_11214 = Types$repr(e.ty);
  function _t11216(c) {
    return (c.class_name === class_name);
  }
  let _t11218;
  const _t11217 = List$find(_t11216, ctx.type_env.classes);
  _t11219: {
    if (_t11217._tag === 1) {
      const cd = _t11217._val;
      _t11218 = cd;
      break _t11219;
    }
    if (_t11217._tag === 0) {
      _t11218 = Js_codegen$error((("class " + __dict_Show_string.show(class_name)) + " not found"));
      break _t11219;
    }
    _match_fail("line 15950");
  }
  const class_def_11220 = _t11218;
  const num_params_11222 = List$length(class_def_11220.class_params);
  function _t11224(_) {
    return ({_tag: 1, _name: "Some", _val: conc_ty_11214});
  }
  const partial_11225 = List$init(num_params_11222, _t11224);
  function _t11227(opt) {
    let _t11229;
    const _t11228 = opt;
    _t11230: {
      if (_t11228._tag === 1) {
        const ty = _t11228._val;
        let _t11232;
        const _t11231 = Types$repr(ty);
        _t11233: {
          if (_t11231._tag === 16 && _t11231._val.contents._tag === 0) {
            _t11232 = ({_tag: 0, _name: "None"});
            break _t11233;
          }
          if (true) {
            _t11232 = ({_tag: 1, _name: "Some", _val: Types$repr(ty)});
            break _t11233;
          }
          _match_fail("line 15950");
        }
        _t11229 = _t11232;
        break _t11230;
      }
      if (_t11228._tag === 0) {
        _t11229 = ({_tag: 0, _name: "None"});
        break _t11230;
      }
      _match_fail("line 15950");
    }
    return _t11229;
  }
  const concrete_partial_11234 = List$map(_t11227, partial_11225);
  function _t11236(inst) {
    return ((inst.inst_class === class_name) && ((List$length(inst.inst_tys) === num_params_11222) && Types$match_partial_inst(inst.inst_tys, concrete_partial_11234)));
  }
  const matching_11237 = List$filter(_t11236, ctx.type_env.instances);
  let _t11240;
  const _t11239 = matching_11237;
  _t11241: {
    if (_t11239 !== null && _t11239._tl === null) {
      const inst = _t11239._hd;
      const dict_access_11242 = (Js_codegen$mangle_name(inst.inst_dict_name) + ("." + Js_codegen$mangle_name(method_name)));
      const v_11244 = Js_codegen$compile_non_tail(ctx, e);
      const _t11245 = ("_call(" + (dict_access_11242 + (", [" + (v_11244 + "])"))));
      const _t11243 = _t11245;
      _t11240 = _t11243;
      break _t11241;
    }
    if (_t11239 === null) {
      _t11240 = Js_codegen$error(((("no instance of " + __dict_Show_string.show(class_name)) + " for type ") + __dict_Show_string.show(Types$pp_ty(conc_ty_11214))));
      break _t11241;
    }
    if (true) {
      _t11240 = Js_codegen$error(("ambiguous instance for " + __dict_Show_string.show(class_name)));
      break _t11241;
    }
    _match_fail("line 15950");
  }
  const _t11238 = _t11240;
  const _t11235 = _t11238;
  const _t11226 = _t11235;
  const _t11223 = _t11226;
  const _t11221 = _t11223;
  const _t11215 = _t11221;
  return _t11215;
}
function Js_codegen$compile_if(ctx, cond, then_e, else_e) {
  const c_11246 = Js_codegen$compile_expr(ctx, cond);
  const result_11248 = Js_codegen$fresh_tmp(ctx);
  Js_codegen$emit_line(ctx, (("let " + __dict_Show_string.show(result_11248)) + ";"));
  Js_codegen$emit_line(ctx, (("if (" + __dict_Show_string.show(c_11246)) + ") {"));
  (ctx.indent = (ctx.indent + 1), undefined);
  const t_11250 = Js_codegen$compile_expr(ctx, then_e);
  Js_codegen$emit_line(ctx, (((__dict_Show_string.show(result_11248) + " = ") + __dict_Show_string.show(t_11250)) + ";"));
  (ctx.indent = (ctx.indent - 1), undefined);
  Js_codegen$emit_line(ctx, "} else {");
  (ctx.indent = (ctx.indent + 1), undefined);
  const e_11252 = Js_codegen$compile_expr(ctx, else_e);
  Js_codegen$emit_line(ctx, (((__dict_Show_string.show(result_11248) + " = ") + __dict_Show_string.show(e_11252)) + ";"));
  (ctx.indent = (ctx.indent - 1), undefined);
  Js_codegen$emit_line(ctx, "}");
  const _t11253 = result_11248;
  const _t11251 = _t11253;
  const _t11249 = _t11251;
  const _t11247 = _t11249;
  return _t11247;
}
function Js_codegen$compile_seq(ctx, e1, e2) {
  const v1_11254 = Js_codegen$compile_non_tail(ctx, e1);
  Js_codegen$emit_line(ctx, (v1_11254 + ";"));
  const _t11255 = Js_codegen$compile_expr(ctx, e2);
  return _t11255;
}
function Js_codegen$compile_let_mut(ctx, name, init, body) {
  const v_11256 = Js_codegen$compile_expr(ctx, init);
  const js_name_11258 = Js_codegen$mangle_name(name);
  const actual_name_11260 = (js_name_11258 + ("_" + string_of_int(ctx.tmp_counter)));
  (ctx.tmp_counter = (ctx.tmp_counter + 1), undefined);
  Js_codegen$push_scope(ctx);
  Js_codegen$bind_var(ctx, name, actual_name_11260);
  Js_codegen$emit_line(ctx, (((("let " + __dict_Show_string.show(actual_name_11260)) + " = ") + __dict_Show_string.show(v_11256)) + ";"));
  const result_11262 = Js_codegen$fresh_tmp(ctx);
  const b_11264 = Js_codegen$compile_expr(ctx, body);
  Js_codegen$emit_line(ctx, (((("const " + __dict_Show_string.show(result_11262)) + " = ") + __dict_Show_string.show(b_11264)) + ";"));
  Js_codegen$pop_scope(ctx);
  const _t11265 = result_11262;
  const _t11263 = _t11265;
  const _t11261 = _t11263;
  const _t11259 = _t11261;
  const _t11257 = _t11259;
  return _t11257;
}
function Js_codegen$compile_while(ctx, cond, body) {
  const result_11266 = Js_codegen$fresh_tmp(ctx);
  const break_flag_11268 = Js_codegen$fresh_tmp(ctx);
  const break_val_11270 = Js_codegen$fresh_tmp(ctx);
  const saved_break_flag_11272 = ctx.break_flag_name;
  const saved_break_val_11274 = ctx.break_val_name;
  (ctx.break_flag_name = break_flag_11268, undefined);
  (ctx.break_val_name = break_val_11270, undefined);
  Js_codegen$emit_line(ctx, (("let " + __dict_Show_string.show(result_11266)) + " = undefined;"));
  Js_codegen$emit_line(ctx, (((("let " + __dict_Show_string.show(break_flag_11268)) + " = false, ") + __dict_Show_string.show(break_val_11270)) + ";"));
  Js_codegen$emit_line(ctx, "while (true) {");
  (ctx.indent = (ctx.indent + 1), undefined);
  const c_11276 = Js_codegen$compile_expr(ctx, cond);
  Js_codegen$emit_line(ctx, (("if (!(" + __dict_Show_string.show(c_11276)) + ")) break;"));
  const v_body_11278 = Js_codegen$compile_expr(ctx, body);
  Js_codegen$emit_line(ctx, (v_body_11278 + ";"));
  Js_codegen$emit_line(ctx, (("if (" + __dict_Show_string.show(break_flag_11268)) + ") break;"));
  (ctx.indent = (ctx.indent - 1), undefined);
  Js_codegen$emit_line(ctx, "}");
  Js_codegen$emit_line(ctx, (((((__dict_Show_string.show(result_11266) + " = ") + __dict_Show_string.show(break_flag_11268)) + " ? ") + __dict_Show_string.show(break_val_11270)) + " : undefined;"));
  (ctx.break_flag_name = saved_break_flag_11272, undefined);
  (ctx.break_val_name = saved_break_val_11274, undefined);
  const _t11279 = result_11266;
  const _t11277 = _t11279;
  const _t11275 = _t11277;
  const _t11273 = _t11275;
  const _t11271 = _t11273;
  const _t11269 = _t11271;
  const _t11267 = _t11269;
  return _t11267;
}
function Js_codegen$compile_match(ctx, scrut, arms, loc) {
  const scrut_js_11280 = Js_codegen$compile_non_tail(ctx, scrut);
  const scrut_tmp_11282 = Js_codegen$fresh_tmp(ctx);
  const result_11284 = Js_codegen$fresh_tmp(ctx);
  const label_11286 = Js_codegen$fresh_tmp(ctx);
  Js_codegen$emit_line(ctx, (("let " + __dict_Show_string.show(result_11284)) + ";"));
  Js_codegen$emit_line(ctx, (((("const " + __dict_Show_string.show(scrut_tmp_11282)) + " = ") + __dict_Show_string.show(scrut_js_11280)) + ";"));
  Js_codegen$emit_line(ctx, (__dict_Show_string.show(label_11286) + ": {"));
  (ctx.indent = (ctx.indent + 1), undefined);
  function _t11288(__p356) {
    let _t11290;
    const _t11289 = __p356;
    _t11291: {
      if (true) {
        const pat = _t11289[0];
        const guard = _t11289[1];
        const body = _t11289[2];
        let _t11293;
        const _t11292 = Js_codegen$compile_pattern(ctx, scrut_tmp_11282, pat);
        _t11294: {
          if (true) {
            const conds = _t11292[0];
            const bindings = _t11292[1];
            let _t11296;
            const _t11295 = conds;
            _t11297: {
              if (_t11295 === null) {
                _t11296 = "true";
                break _t11297;
              }
              if (true) {
                _t11296 = String$concat(" && ", conds);
                break _t11297;
              }
              _match_fail("line 15950");
            }
            const cond_str_11298 = _t11296;
            Js_codegen$emit_line(ctx, (("if (" + __dict_Show_string.show(cond_str_11298)) + ") {"));
            (ctx.indent = (ctx.indent + 1), undefined);
            Js_codegen$push_scope(ctx);
            function _t11300(__p357) {
              let _t11302;
              const _t11301 = __p357;
              _t11303: {
                if (true) {
                  const mml_name = _t11301[0];
                  const js_expr = _t11301[1];
                  const js_name_11304 = Js_codegen$mangle_name(mml_name);
                  Js_codegen$bind_var(ctx, mml_name, js_name_11304);
                  const _t11305 = Js_codegen$emit_line(ctx, (((("const " + __dict_Show_string.show(js_name_11304)) + " = ") + __dict_Show_string.show(js_expr)) + ";"));
                  _t11302 = _t11305;
                  break _t11303;
                }
                _match_fail("line 15950");
              }
              return _t11302;
            }
            List$iter(_t11300, bindings);
            let _t11307;
            const _t11306 = guard;
            _t11308: {
              if (_t11306._tag === 1) {
                const g = _t11306._val;
                const guard_js_11309 = Js_codegen$compile_expr(ctx, g);
                Js_codegen$emit_line(ctx, (("if (" + __dict_Show_string.show(guard_js_11309)) + ") {"));
                (ctx.indent = (ctx.indent + 1), undefined);
                const b_11311 = Js_codegen$compile_expr(ctx, body);
                Js_codegen$emit_line(ctx, (((__dict_Show_string.show(result_11284) + " = ") + __dict_Show_string.show(b_11311)) + ";"));
                Js_codegen$emit_line(ctx, (("break " + __dict_Show_string.show(label_11286)) + ";"));
                (ctx.indent = (ctx.indent - 1), undefined);
                const _t11312 = Js_codegen$emit_line(ctx, "}");
                const _t11310 = _t11312;
                _t11307 = _t11310;
                break _t11308;
              }
              if (_t11306._tag === 0) {
                const b_11313 = Js_codegen$compile_expr(ctx, body);
                Js_codegen$emit_line(ctx, (((__dict_Show_string.show(result_11284) + " = ") + __dict_Show_string.show(b_11313)) + ";"));
                const _t11314 = Js_codegen$emit_line(ctx, (("break " + __dict_Show_string.show(label_11286)) + ";"));
                _t11307 = _t11314;
                break _t11308;
              }
              _match_fail("line 15950");
            }
            _t11307;
            Js_codegen$pop_scope(ctx);
            (ctx.indent = (ctx.indent - 1), undefined);
            const _t11299 = Js_codegen$emit_line(ctx, "}");
            _t11293 = _t11299;
            break _t11294;
          }
          _match_fail("line 15950");
        }
        _t11290 = _t11293;
        break _t11291;
      }
      _match_fail("line 15950");
    }
    return _t11290;
  }
  List$iter(_t11288, arms);
  Js_codegen$emit_line(ctx, (("_match_fail(\"line " + __dict_Show_int.show(loc.line)) + "\");"));
  (ctx.indent = (ctx.indent - 1), undefined);
  Js_codegen$emit_line(ctx, "}");
  const _t11287 = result_11284;
  const _t11285 = _t11287;
  const _t11283 = _t11285;
  const _t11281 = _t11283;
  return _t11281;
}
function Js_codegen$compile_pattern(ctx, scrutinee, pat) {
  while (true) {
    let _t11316;
    const _t11315 = pat;
    _t11317: {
      if (_t11315._tag === 0) {
        _t11316 = [null, null];
        break _t11317;
      }
      if (_t11315._tag === 1) {
        const name = _t11315._val;
        _t11316 = [null, ({_hd: [name, scrutinee], _tl: null})];
        break _t11317;
      }
      if (_t11315._tag === 2) {
        const n = _t11315._val;
        _t11316 = [({_hd: ((__dict_Show_string.show(scrutinee) + " === ") + __dict_Show_int.show(n)), _tl: null}), null];
        break _t11317;
      }
      if (_t11315._tag === 3) {
        const f = _t11315._val;
        _t11316 = [({_hd: ((__dict_Show_string.show(scrutinee) + " === ") + __dict_Show_string.show(__dict_Show_float.show(f))), _tl: null}), null];
        break _t11317;
      }
      if (_t11315._tag === 4 && _t11315._val) {
        _t11316 = [({_hd: scrutinee, _tl: null}), null];
        break _t11317;
      }
      if (_t11315._tag === 4 && !_t11315._val) {
        _t11316 = [({_hd: ("!" + scrutinee), _tl: null}), null];
        break _t11317;
      }
      if (_t11315._tag === 5) {
        const s = _t11315._val;
        _t11316 = [({_hd: ((__dict_Show_string.show(scrutinee) + " === ") + __dict_Show_string.show(Js_codegen$escape_js_string(s))), _tl: null}), null];
        break _t11317;
      }
      if (_t11315._tag === 6) {
        _t11316 = [null, null];
        break _t11317;
      }
      if (_t11315._tag === 9) {
        _t11316 = [({_hd: (scrutinee + " === null"), _tl: null}), null];
        break _t11317;
      }
      if (_t11315._tag === 8) {
        const hd_pat = _t11315._val[0];
        const tl_pat = _t11315._val[1];
        const hd_expr_11318 = (scrutinee + "._hd");
        const tl_expr_11320 = (scrutinee + "._tl");
        let _t11323;
        const _t11322 = Js_codegen$compile_pattern(ctx, hd_expr_11318, hd_pat);
        _t11324: {
          if (true) {
            const hd_conds = _t11322[0];
            const hd_binds = _t11322[1];
            let _t11326;
            const _t11325 = Js_codegen$compile_pattern(ctx, tl_expr_11320, tl_pat);
            _t11327: {
              if (true) {
                const tl_conds = _t11325[0];
                const tl_binds = _t11325[1];
                const conds_11328 = List$concat(({_hd: (scrutinee + " !== null"), _tl: hd_conds}), tl_conds);
                const _t11329 = [conds_11328, List$concat(hd_binds, tl_binds)];
                _t11326 = _t11329;
                break _t11327;
              }
              _match_fail("line 15950");
            }
            _t11323 = _t11326;
            break _t11324;
          }
          _match_fail("line 15950");
        }
        const _t11321 = _t11323;
        const _t11319 = _t11321;
        _t11316 = _t11319;
        break _t11317;
      }
      if (_t11315._tag === 7) {
        const pats = _t11315._val;
        const all_conds_11330 = Ref$create(null);
        const all_binds_11332 = Ref$create(null);
        function _t11334(i, sub_pat) {
          const elem_expr_11335 = (((__dict_Show_string.show(scrutinee) + "[") + __dict_Show_int.show(i)) + "]");
          let _t11338;
          const _t11337 = Js_codegen$compile_pattern(ctx, elem_expr_11335, sub_pat);
          _t11339: {
            if (true) {
              const c = _t11337[0];
              const b = _t11337[1];
              Ref$set(all_conds_11330, List$concat(Ref$get(all_conds_11330), c));
              _t11338 = Ref$set(all_binds_11332, List$concat(Ref$get(all_binds_11332), b));
              break _t11339;
            }
            _match_fail("line 15950");
          }
          const _t11336 = _t11338;
          return _t11336;
        }
        List$iteri(_t11334, pats);
        const _t11333 = [Ref$get(all_conds_11330), Ref$get(all_binds_11332)];
        const _t11331 = _t11333;
        _t11316 = _t11331;
        break _t11317;
      }
      if (_t11315._tag === 10) {
        const name = _t11315._val[0];
        const arg_pat = _t11315._val[1];
        let _t11340;
        if (((String$length(name) > 0) && (String$get(name, 0) === 96))) {
          _t11340 = (__dict_Hash_string.hash(String$sub(name, 1, (String$length(name) - 1))) & 1073741823);
        } else {
          _t11340 = Js_codegen$tag_for_constructor(ctx.type_env, name);
        }
        const tag_11341 = _t11340;
        const conds_11343 = ({_hd: ((__dict_Show_string.show(scrutinee) + "._tag === ") + __dict_Show_int.show(tag_11341)), _tl: null});
        let _t11346;
        const _t11345 = arg_pat;
        _t11347: {
          if (_t11345._tag === 0) {
            _t11346 = [conds_11343, null];
            break _t11347;
          }
          if (_t11345._tag === 1) {
            const sub_pat = _t11345._val;
            const payload_expr_11348 = (scrutinee + "._val");
            let _t11351;
            const _t11350 = Js_codegen$compile_pattern(ctx, payload_expr_11348, sub_pat);
            _t11352: {
              if (true) {
                const sub_conds = _t11350[0];
                const sub_binds = _t11350[1];
                _t11351 = [List$concat(conds_11343, sub_conds), sub_binds];
                break _t11352;
              }
              _match_fail("line 15950");
            }
            const _t11349 = _t11351;
            _t11346 = _t11349;
            break _t11347;
          }
          _match_fail("line 15950");
        }
        const _t11344 = _t11346;
        const _t11342 = _t11344;
        _t11316 = _t11342;
        break _t11317;
      }
      if (_t11315._tag === 11) {
        const field_pats = _t11315._val;
        const all_conds_11353 = Ref$create(null);
        const all_binds_11355 = Ref$create(null);
        function _t11357(__p358) {
          let _t11359;
          const _t11358 = __p358;
          _t11360: {
            if (true) {
              const fname = _t11358[0];
              const sub_pat = _t11358[1];
              const field_expr_11361 = (scrutinee + ("." + Js_codegen$mangle_name(fname)));
              let _t11364;
              const _t11363 = Js_codegen$compile_pattern(ctx, field_expr_11361, sub_pat);
              _t11365: {
                if (true) {
                  const c = _t11363[0];
                  const b = _t11363[1];
                  Ref$set(all_conds_11353, List$concat(Ref$get(all_conds_11353), c));
                  _t11364 = Ref$set(all_binds_11355, List$concat(Ref$get(all_binds_11355), b));
                  break _t11365;
                }
                _match_fail("line 15950");
              }
              const _t11362 = _t11364;
              _t11359 = _t11362;
              break _t11360;
            }
            _match_fail("line 15950");
          }
          return _t11359;
        }
        List$iter(_t11357, field_pats);
        const _t11356 = [Ref$get(all_conds_11353), Ref$get(all_binds_11355)];
        const _t11354 = _t11356;
        _t11316 = _t11354;
        break _t11317;
      }
      if (_t11315._tag === 12) {
        const inner_pat = _t11315._val[0];
        const name = _t11315._val[1];
        let _t11367;
        const _t11366 = Js_codegen$compile_pattern(ctx, scrutinee, inner_pat);
        _t11368: {
          if (true) {
            const conds = _t11366[0];
            const binds = _t11366[1];
            _t11367 = [conds, List$concat(binds, ({_hd: [name, scrutinee], _tl: null}))];
            break _t11368;
          }
          _match_fail("line 15950");
        }
        _t11316 = _t11367;
        break _t11317;
      }
      if (_t11315._tag === 13) {
        const p1 = _t11315._val[0];
        const p2 = _t11315._val[1];
        let _t11370;
        const _t11369 = Js_codegen$compile_pattern(ctx, scrutinee, p1);
        _t11371: {
          if (true) {
            const conds1 = _t11369[0];
            const binds1 = _t11369[1];
            let _t11373;
            const _t11372 = Js_codegen$compile_pattern(ctx, scrutinee, p2);
            _t11374: {
              if (true) {
                const conds2 = _t11372[0];
                const binds2 = _t11372[1];
                let _t11376;
                const _t11375 = conds1;
                _t11377: {
                  if (_t11375 === null) {
                    _t11376 = "true";
                    break _t11377;
                  }
                  if (true) {
                    const cs = _t11375;
                    _t11376 = String$concat(" && ", cs);
                    break _t11377;
                  }
                  _match_fail("line 15950");
                }
                const cond1_11378 = _t11376;
                let _t11381;
                const _t11380 = conds2;
                _t11382: {
                  if (_t11380 === null) {
                    _t11381 = "true";
                    break _t11382;
                  }
                  if (true) {
                    const cs = _t11380;
                    _t11381 = String$concat(" && ", cs);
                    break _t11382;
                  }
                  _match_fail("line 15950");
                }
                const cond2_11383 = _t11381;
                const or_cond_11385 = ("(" + (cond1_11378 + (" || " + (cond2_11383 + ")"))));
                let _t11387;
                if (_eq(binds1, binds2)) {
                  _t11387 = binds1;
                } else {
                  function _t11388(__p359) {
                    let _t11390;
                    const _t11389 = __p359;
                    _t11391: {
                      if (true) {
                        const name = _t11389[0];
                        const expr1 = _t11389[1];
                        const expr2_11392 = List$assoc(name, binds2);
                        let _t11394;
                        if ((expr1 === expr2_11392)) {
                          _t11394 = [name, expr1];
                        } else {
                          _t11394 = [name, (((((("(" + __dict_Show_string.show(cond1_11378)) + " ? ") + __dict_Show_string.show(expr1)) + " : ") + __dict_Show_string.show(expr2_11392)) + ")")];
                        }
                        const _t11393 = _t11394;
                        _t11390 = _t11393;
                        break _t11391;
                      }
                      _match_fail("line 15950");
                    }
                    return _t11390;
                  }
                  _t11387 = List$map(_t11388, binds1);
                }
                const binds_11395 = _t11387;
                const _t11396 = [({_hd: or_cond_11385, _tl: null}), binds_11395];
                const _t11386 = _t11396;
                const _t11384 = _t11386;
                const _t11379 = _t11384;
                _t11373 = _t11379;
                break _t11374;
              }
              _match_fail("line 15950");
            }
            _t11370 = _t11373;
            break _t11371;
          }
          _match_fail("line 15950");
        }
        _t11316 = _t11370;
        break _t11317;
      }
      if (_t11315._tag === 14) {
        const pats = _t11315._val;
        const len_cond_11397 = ((__dict_Show_string.show(scrutinee) + "._arr.length === ") + __dict_Show_int.show(List$length(pats)));
        const all_conds_11399 = Ref$create(({_hd: len_cond_11397, _tl: null}));
        const all_binds_11401 = Ref$create(null);
        function _t11403(i, sub_pat) {
          const elem_expr_11404 = (((__dict_Show_string.show(scrutinee) + "._arr[") + __dict_Show_int.show(i)) + "]");
          let _t11407;
          const _t11406 = Js_codegen$compile_pattern(ctx, elem_expr_11404, sub_pat);
          _t11408: {
            if (true) {
              const c = _t11406[0];
              const b = _t11406[1];
              Ref$set(all_conds_11399, List$concat(Ref$get(all_conds_11399), c));
              _t11407 = Ref$set(all_binds_11401, List$concat(Ref$get(all_binds_11401), b));
              break _t11408;
            }
            _match_fail("line 15950");
          }
          const _t11405 = _t11407;
          return _t11405;
        }
        List$iteri(_t11403, pats);
        const _t11402 = [Ref$get(all_conds_11399), Ref$get(all_binds_11401)];
        const _t11400 = _t11402;
        const _t11398 = _t11400;
        _t11316 = _t11398;
        break _t11317;
      }
      if (_t11315._tag === 15) {
        _t11316 = Js_codegen$error("map patterns not yet supported in JS backend");
        break _t11317;
      }
      if (_t11315._tag === 16) {
        const tag = _t11315._val[0];
        const arg_pat = _t11315._val[1];
        const num_tag_11409 = (__dict_Hash_string.hash(tag) & 1073741823);
        const conds_11411 = ({_hd: ((__dict_Show_string.show(scrutinee) + "._tag === ") + __dict_Show_int.show(num_tag_11409)), _tl: null});
        let _t11414;
        const _t11413 = arg_pat;
        _t11415: {
          if (_t11413._tag === 0) {
            _t11414 = [conds_11411, null];
            break _t11415;
          }
          if (_t11413._tag === 1) {
            const sub_pat = _t11413._val;
            const payload_expr_11416 = (scrutinee + "._val");
            let _t11419;
            const _t11418 = Js_codegen$compile_pattern(ctx, payload_expr_11416, sub_pat);
            _t11420: {
              if (true) {
                const sub_conds = _t11418[0];
                const sub_binds = _t11418[1];
                _t11419 = [List$concat(conds_11411, sub_conds), sub_binds];
                break _t11420;
              }
              _match_fail("line 15950");
            }
            const _t11417 = _t11419;
            _t11414 = _t11417;
            break _t11415;
          }
          _match_fail("line 15950");
        }
        const _t11412 = _t11414;
        const _t11410 = _t11412;
        _t11316 = _t11410;
        break _t11317;
      }
      if (_t11315._tag === 17) {
        const name = _t11315._val;
        const js_name_11421 = Js_codegen$lookup_var(ctx, name);
        const _t11422 = [({_hd: (((("_eq(" + __dict_Show_string.show(scrutinee)) + ", ") + __dict_Show_string.show(js_name_11421)) + ")"), _tl: null}), null];
        _t11316 = _t11422;
        break _t11317;
      }
      if (_t11315._tag === 18) {
        const inner_pat = _t11315._val[0];
        const _t11423 = ctx;
        const _t11424 = scrutinee;
        const _t11425 = inner_pat;
        ctx = _t11423;
        scrutinee = _t11424;
        pat = _t11425;
        continue;
        _t11316 = undefined;
        break _t11317;
      }
      _match_fail("line 15950");
    }
    return _t11316;
  }
}
function Js_codegen$compile_handle_trywith(ctx, body, op_arms, return_arm, result) {
  Js_codegen$emit_line(ctx, (("const " + __dict_Show_string.show(result)) + " = (function() {"));
  (ctx.indent = (ctx.indent + 1), undefined);
  const h_saved_11426 = Js_codegen$fresh_tmp(ctx);
  Js_codegen$emit_line(ctx, (("const " + __dict_Show_string.show(h_saved_11426)) + " = _h;"));
  Js_codegen$emit_line(ctx, (("_h = Object.assign({}, " + __dict_Show_string.show(h_saved_11426)) + ", {"));
  (ctx.indent = (ctx.indent + 1), undefined);
  function _t11428(__p360) {
    let _t11430;
    const _t11429 = __p360;
    _t11431: {
      if (true) {
        const op_name = _t11429[0];
        const arg_name = _t11429[1];
        const k_name = _t11429[2];
        const arg_js_11432 = Js_codegen$mangle_name(arg_name);
        const k_js_11434 = Js_codegen$mangle_name(k_name);
        const _t11435 = Js_codegen$emit_line(ctx, (((((((((("\"" + __dict_Show_string.show(op_name)) + "\": function(") + __dict_Show_string.show(arg_js_11432)) + ", ") + __dict_Show_string.show(k_js_11434)) + ") { throw {_e: \"") + __dict_Show_string.show(op_name)) + "\", _v: ") + __dict_Show_string.show(arg_js_11432)) + "}; },"));
        const _t11433 = _t11435;
        _t11430 = _t11433;
        break _t11431;
      }
      _match_fail("line 15950");
    }
    return _t11430;
  }
  List$iter(_t11428, op_arms);
  (ctx.indent = (ctx.indent - 1), undefined);
  Js_codegen$emit_line(ctx, "});");
  Js_codegen$emit_line(ctx, "try {");
  (ctx.indent = (ctx.indent + 1), undefined);
  const saved_two_11436 = ctx.trywith_ops;
  function _t11438(__p361) {
    let _t11440;
    const _t11439 = __p361;
    _t11441: {
      if (true) {
        const op = _t11439[0];
        _t11440 = op;
        break _t11441;
      }
      _match_fail("line 15950");
    }
    return _t11440;
  }
  const handled_op_names_11442 = List$map(_t11438, op_arms);
  (ctx.trywith_ops = List$concat(handled_op_names_11442, ctx.trywith_ops), undefined);
  const body_needs_cps_11444 = Js_codegen$expr_has_unhandled_perform(handled_op_names_11442, body);
  let _t11446;
  if (body_needs_cps_11444) {
    Js_codegen$emit_line(ctx, "return _trampoline(function() {");
    (ctx.indent = (ctx.indent + 1), undefined);
    function _t11447(body_result) {
      let _t11449;
      const _t11448 = return_arm;
      _t11450: {
        if (_t11448._tag === 1) {
          const ret_name = _t11448._val[0];
          const ret_body = _t11448._val[1];
          const ret_js_11451 = Js_codegen$mangle_name(ret_name);
          const actual_ret_11453 = (ret_js_11451 + ("_" + string_of_int(ctx.tmp_counter)));
          (ctx.tmp_counter = (ctx.tmp_counter + 1), undefined);
          Js_codegen$push_scope(ctx);
          Js_codegen$bind_var(ctx, ret_name, actual_ret_11453);
          Js_codegen$emit_line(ctx, (((("const " + __dict_Show_string.show(actual_ret_11453)) + " = ") + __dict_Show_string.show(body_result)) + ";"));
          const v_11455 = Js_codegen$compile_non_tail(ctx, ret_body);
          Js_codegen$emit_line(ctx, (("return " + __dict_Show_string.show(v_11455)) + ";"));
          const _t11456 = Js_codegen$pop_scope(ctx);
          const _t11454 = _t11456;
          const _t11452 = _t11454;
          _t11449 = _t11452;
          break _t11450;
        }
        if (_t11448._tag === 0) {
          _t11449 = Js_codegen$emit_line(ctx, (("return " + __dict_Show_string.show(body_result)) + ";"));
          break _t11450;
        }
        _match_fail("line 15950");
      }
      return _t11449;
    }
    Js_codegen$compile_cps(ctx, body, _t11447);
    (ctx.indent = (ctx.indent - 1), undefined);
    _t11446 = Js_codegen$emit_line(ctx, "});");
  } else {
    const body_v_11457 = Js_codegen$compile_non_tail(ctx, body);
    let _t11460;
    const _t11459 = return_arm;
    _t11461: {
      if (_t11459._tag === 1) {
        const ret_name = _t11459._val[0];
        const ret_body = _t11459._val[1];
        const ret_js_11462 = Js_codegen$mangle_name(ret_name);
        const actual_ret_11464 = (ret_js_11462 + ("_" + string_of_int(ctx.tmp_counter)));
        (ctx.tmp_counter = (ctx.tmp_counter + 1), undefined);
        Js_codegen$push_scope(ctx);
        Js_codegen$bind_var(ctx, ret_name, actual_ret_11464);
        Js_codegen$emit_line(ctx, (((("const " + __dict_Show_string.show(actual_ret_11464)) + " = ") + __dict_Show_string.show(body_v_11457)) + ";"));
        const rv_11466 = Js_codegen$compile_non_tail(ctx, ret_body);
        Js_codegen$emit_line(ctx, (("return " + __dict_Show_string.show(rv_11466)) + ";"));
        const _t11467 = Js_codegen$pop_scope(ctx);
        const _t11465 = _t11467;
        const _t11463 = _t11465;
        _t11460 = _t11463;
        break _t11461;
      }
      if (_t11459._tag === 0) {
        _t11460 = Js_codegen$emit_line(ctx, (("return " + __dict_Show_string.show(body_v_11457)) + ";"));
        break _t11461;
      }
      _match_fail("line 15950");
    }
    const _t11458 = _t11460;
    _t11446 = _t11458;
  }
  _t11446;
  (ctx.trywith_ops = saved_two_11436, undefined);
  (ctx.indent = (ctx.indent - 1), undefined);
  Js_codegen$emit_line(ctx, "} catch (_exc) {");
  (ctx.indent = (ctx.indent + 1), undefined);
  const first_11468 = Ref$create(true);
  function _t11470(__p362) {
    let _t11472;
    const _t11471 = __p362;
    _t11473: {
      if (true) {
        const op_name = _t11471[0];
        const arg_name = _t11471[1];
        const _k_name = _t11471[2];
        const handler_body = _t11471[3];
        let _t11474;
        if (Ref$get(first_11468)) {
          _t11474 = "if";
        } else {
          _t11474 = "} else if";
        }
        const prefix_11475 = _t11474;
        Ref$set(first_11468, false);
        Js_codegen$emit_line(ctx, (((__dict_Show_string.show(prefix_11475) + " (_exc && _exc._e === \"") + __dict_Show_string.show(op_name)) + "\") {"));
        (ctx.indent = (ctx.indent + 1), undefined);
        Js_codegen$push_scope(ctx);
        const arg_js_11477 = Js_codegen$mangle_name(arg_name);
        Js_codegen$bind_var(ctx, arg_name, arg_js_11477);
        Js_codegen$emit_line(ctx, (("const " + __dict_Show_string.show(arg_js_11477)) + " = _exc._v;"));
        const v_11479 = Js_codegen$compile_non_tail(ctx, handler_body);
        Js_codegen$emit_line(ctx, (("return " + __dict_Show_string.show(v_11479)) + ";"));
        Js_codegen$pop_scope(ctx);
        const _t11480 = (ctx.indent = (ctx.indent - 1), undefined);
        const _t11478 = _t11480;
        const _t11476 = _t11478;
        _t11472 = _t11476;
        break _t11473;
      }
      _match_fail("line 15950");
    }
    return _t11472;
  }
  List$iter(_t11470, op_arms);
  Js_codegen$emit_line(ctx, "} else { throw _exc; }");
  (ctx.indent = (ctx.indent - 1), undefined);
  Js_codegen$emit_line(ctx, (("} finally { _h = " + __dict_Show_string.show(h_saved_11426)) + "; }"));
  (ctx.indent = (ctx.indent - 1), undefined);
  const _t11469 = Js_codegen$emit_line(ctx, "})();");
  const _t11445 = _t11469;
  const _t11443 = _t11445;
  const _t11437 = _t11443;
  const _t11427 = _t11437;
  return _t11427;
}
function Js_codegen$compile_handle(ctx, body, arms) {
  const result_11481 = Js_codegen$fresh_tmp(ctx);
  const return_arm_11483 = Ref$create(({_tag: 0, _name: "None"}));
  const op_arms_11485 = Ref$create(null);
  function _t11487(arm) {
    let _t11489;
    const _t11488 = arm;
    _t11490: {
      if (_t11488._tag === 0) {
        const name = _t11488._val[0];
        const body = _t11488._val[1];
        _t11489 = Ref$set(return_arm_11483, ({_tag: 1, _name: "Some", _val: [name, body]}));
        break _t11490;
      }
      if (_t11488._tag === 1) {
        const op = _t11488._val[0];
        const arg = _t11488._val[1];
        const k = _t11488._val[2];
        const body = _t11488._val[3];
        _t11489 = Ref$set(op_arms_11485, ({_hd: [op, arg, k, body], _tl: Ref$get(op_arms_11485)}));
        break _t11490;
      }
      _match_fail("line 15950");
    }
    return _t11489;
  }
  List$iter(_t11487, arms);
  const op_arms_11491 = List$rev(Ref$get(op_arms_11485));
  let _t11497;
  if (!_eq(op_arms_11491, null)) {
  function _t11493(__p363) {
    let _t11495;
    const _t11494 = __p363;
    _t11496: {
      if (true) {
        const hb = _t11494[3];
        _t11495 = Js_codegen$is_trywith_arm(hb);
        break _t11496;
      }
      _match_fail("line 15950");
    }
    return _t11495;
  }
    _t11497 = List$forall(_t11493, op_arms_11491);
  } else {
    _t11497 = false;
  }
  const all_trywith_11498 = _t11497;
  let _t11501;
  const _t11500 = Ref$get(return_arm_11483);
  _t11502: {
    if (_t11500._tag === 1) {
      const rb = _t11500._val[1];
      _t11501 = (!Js_codegen$expr_has_perform(rb));
      break _t11502;
    }
    if (_t11500._tag === 0) {
      _t11501 = true;
      break _t11502;
    }
    _match_fail("line 15950");
  }
  const return_arm_pure_11503 = _t11501;
  let _t11505;
  if ((all_trywith_11498 && return_arm_pure_11503)) {
    _t11505 = Js_codegen$compile_handle_trywith(ctx, body, op_arms_11491, Ref$get(return_arm_11483), result_11481);
  } else {
    function _t11506(__p364) {
      let _t11508;
      const _t11507 = __p364;
      _t11509: {
        if (true) {
          const op_name = _t11507[0];
          const hb = _t11507[3];
          let _t11510;
          if (Js_codegen$is_simple_handler_body(hb)) {
            _t11510 = ({_tag: 1, _name: "Some", _val: op_name});
          } else {
            _t11510 = ({_tag: 0, _name: "None"});
          }
          _t11508 = _t11510;
          break _t11509;
        }
        _match_fail("line 15950");
      }
      return _t11508;
    }
    const simple_ops_11511 = List$filter_map(_t11506, op_arms_11491);
    Js_codegen$emit_line(ctx, (("const " + __dict_Show_string.show(result_11481)) + " = (function() {"));
    (ctx.indent = (ctx.indent + 1), undefined);
    const h_saved_11513 = Js_codegen$fresh_tmp(ctx);
    Js_codegen$emit_line(ctx, (("const " + __dict_Show_string.show(h_saved_11513)) + " = _h;"));
    const saved_direct_ops_11515 = ctx.direct_dispatch_ops;
    function _t11517(__p365) {
      let _t11519;
      const _t11518 = __p365;
      _t11520: {
        if (true) {
          const op_name = _t11518[0];
          const arg_name = _t11518[1];
          const k_name = _t11518[2];
          const handler_body = _t11518[3];
          let _t11521;
          if (List$mem(op_name, simple_ops_11511)) {
            const direct_fn_11522 = Js_codegen$fresh_tmp(ctx);
            const arg_js_11524 = Js_codegen$mangle_name(arg_name);
            Js_codegen$emit_line(ctx, (((("function " + __dict_Show_string.show(direct_fn_11522)) + "(") + __dict_Show_string.show(arg_js_11524)) + ") {"));
            (ctx.indent = (ctx.indent + 1), undefined);
            Js_codegen$push_scope(ctx);
            Js_codegen$bind_var(ctx, arg_name, arg_js_11524);
            Js_codegen$bind_var(ctx, k_name, "undefined");
            const saved_shm_11526 = ctx.simple_handler_mode;
            (ctx.simple_handler_mode = true, undefined);
            const v_11528 = Js_codegen$compile_non_tail(ctx, handler_body);
            (ctx.simple_handler_mode = saved_shm_11526, undefined);
            Js_codegen$emit_line(ctx, (("return " + __dict_Show_string.show(v_11528)) + ";"));
            Js_codegen$pop_scope(ctx);
            (ctx.indent = (ctx.indent - 1), undefined);
            Js_codegen$emit_line(ctx, "}");
            const _t11529 = (ctx.direct_dispatch_ops = ({_hd: [op_name, direct_fn_11522], _tl: ctx.direct_dispatch_ops}), undefined);
            const _t11527 = _t11529;
            const _t11525 = _t11527;
            const _t11523 = _t11525;
            _t11521 = _t11523;
          } else {
            _t11521 = undefined;
          }
          _t11519 = _t11521;
          break _t11520;
        }
        _match_fail("line 15950");
      }
      return _t11519;
    }
    List$iter(_t11517, op_arms_11491);
    Js_codegen$emit_line(ctx, (("_h = Object.assign({}, " + __dict_Show_string.show(h_saved_11513)) + ", {"));
    (ctx.indent = (ctx.indent + 1), undefined);
    function _t11530(__p366) {
      let _t11532;
      const _t11531 = __p366;
      _t11533: {
        if (true) {
          const op_name = _t11531[0];
          const arg_name = _t11531[1];
          const k_name = _t11531[2];
          const handler_body = _t11531[3];
          const arg_js_11534 = Js_codegen$mangle_name(arg_name);
          const k_js_11536 = Js_codegen$mangle_name(k_name);
          let _t11538;
          if (List$mem(op_name, simple_ops_11511)) {
            const direct_fn_11539 = List$assoc(op_name, ctx.direct_dispatch_ops);
            const _t11540 = Js_codegen$emit_line(ctx, (((((((((((("\"" + __dict_Show_string.show(op_name)) + "\": function(") + __dict_Show_string.show(arg_js_11534)) + ", ") + __dict_Show_string.show(k_js_11536)) + ") { return _bounce(function() { return ") + __dict_Show_string.show(k_js_11536)) + "(") + __dict_Show_string.show(direct_fn_11539)) + "(") + __dict_Show_string.show(arg_js_11534)) + ")); }); },"));
            _t11538 = _t11540;
          } else {
            Js_codegen$emit_line(ctx, (((((("\"" + __dict_Show_string.show(op_name)) + "\": function(") + __dict_Show_string.show(arg_js_11534)) + ", ") + __dict_Show_string.show(k_js_11536)) + ") {"));
            (ctx.indent = (ctx.indent + 1), undefined);
            Js_codegen$push_scope(ctx);
            Js_codegen$bind_var(ctx, arg_name, arg_js_11534);
            Js_codegen$bind_var(ctx, k_name, k_js_11536);
            const saved_htr_11541 = ctx.handler_tail_resume;
            (ctx.handler_tail_resume = Js_codegen$all_resumes_are_tail(handler_body), undefined);
            const v_11543 = Js_codegen$compile_non_tail(ctx, handler_body);
            (ctx.handler_tail_resume = saved_htr_11541, undefined);
            Js_codegen$emit_line(ctx, (("return _bounce(function() { return " + __dict_Show_string.show(v_11543)) + "; });"));
            Js_codegen$pop_scope(ctx);
            (ctx.indent = (ctx.indent - 1), undefined);
            const _t11544 = Js_codegen$emit_line(ctx, "},");
            const _t11542 = _t11544;
            _t11538 = _t11542;
          }
          const _t11537 = _t11538;
          const _t11535 = _t11537;
          _t11532 = _t11535;
          break _t11533;
        }
        _match_fail("line 15950");
      }
      return _t11532;
    }
    List$iter(_t11530, op_arms_11491);
    (ctx.indent = (ctx.indent - 1), undefined);
    Js_codegen$emit_line(ctx, "});");
    let _t11545;
    if (_eq(simple_ops_11511, null)) {
      _t11545 = Js_codegen$expr_has_perform(body);
    } else {
      _t11545 = Js_codegen$expr_has_unhandled_perform(simple_ops_11511, body);
    }
    const body_needs_cps_11546 = _t11545;
    Js_codegen$emit_line(ctx, "try {");
    (ctx.indent = (ctx.indent + 1), undefined);
    let _t11548;
    if (body_needs_cps_11546) {
      Js_codegen$emit_line(ctx, "return _trampoline(function() {");
      (ctx.indent = (ctx.indent + 1), undefined);
      function _t11549(body_result) {
        let _t11551;
        const _t11550 = Ref$get(return_arm_11483);
        _t11552: {
          if (_t11550._tag === 1) {
            const ret_name = _t11550._val[0];
            const ret_body = _t11550._val[1];
            const ret_js_11553 = Js_codegen$mangle_name(ret_name);
            const actual_ret_11555 = (ret_js_11553 + ("_" + string_of_int(ctx.tmp_counter)));
            (ctx.tmp_counter = (ctx.tmp_counter + 1), undefined);
            Js_codegen$push_scope(ctx);
            Js_codegen$bind_var(ctx, ret_name, actual_ret_11555);
            Js_codegen$emit_line(ctx, (((("const " + __dict_Show_string.show(actual_ret_11555)) + " = ") + __dict_Show_string.show(body_result)) + ";"));
            const v_11557 = Js_codegen$compile_non_tail(ctx, ret_body);
            Js_codegen$emit_line(ctx, (("return " + __dict_Show_string.show(v_11557)) + ";"));
            const _t11558 = Js_codegen$pop_scope(ctx);
            const _t11556 = _t11558;
            const _t11554 = _t11556;
            _t11551 = _t11554;
            break _t11552;
          }
          if (_t11550._tag === 0) {
            _t11551 = Js_codegen$emit_line(ctx, (("return " + __dict_Show_string.show(body_result)) + ";"));
            break _t11552;
          }
          _match_fail("line 15950");
        }
        return _t11551;
      }
      Js_codegen$compile_cps(ctx, body, _t11549);
      (ctx.indent = (ctx.indent - 1), undefined);
      _t11548 = Js_codegen$emit_line(ctx, "});");
    } else {
      const body_v_11559 = Js_codegen$compile_non_tail(ctx, body);
      let _t11562;
      const _t11561 = Ref$get(return_arm_11483);
      _t11563: {
        if (_t11561._tag === 1) {
          const ret_name = _t11561._val[0];
          const ret_body = _t11561._val[1];
          const ret_js_11564 = Js_codegen$mangle_name(ret_name);
          const actual_ret_11566 = (ret_js_11564 + ("_" + string_of_int(ctx.tmp_counter)));
          (ctx.tmp_counter = (ctx.tmp_counter + 1), undefined);
          Js_codegen$push_scope(ctx);
          Js_codegen$bind_var(ctx, ret_name, actual_ret_11566);
          Js_codegen$emit_line(ctx, (((("const " + __dict_Show_string.show(actual_ret_11566)) + " = ") + __dict_Show_string.show(body_v_11559)) + ";"));
          const rv_11568 = Js_codegen$compile_non_tail(ctx, ret_body);
          Js_codegen$emit_line(ctx, (("return " + __dict_Show_string.show(rv_11568)) + ";"));
          const _t11569 = Js_codegen$pop_scope(ctx);
          const _t11567 = _t11569;
          const _t11565 = _t11567;
          _t11562 = _t11565;
          break _t11563;
        }
        if (_t11561._tag === 0) {
          _t11562 = Js_codegen$emit_line(ctx, (("return " + __dict_Show_string.show(body_v_11559)) + ";"));
          break _t11563;
        }
        _match_fail("line 15950");
      }
      const _t11560 = _t11562;
      _t11548 = _t11560;
    }
    _t11548;
    (ctx.indent = (ctx.indent - 1), undefined);
    Js_codegen$emit_line(ctx, (("} finally { _h = " + __dict_Show_string.show(h_saved_11513)) + "; }"));
    (ctx.direct_dispatch_ops = saved_direct_ops_11515, undefined);
    (ctx.indent = (ctx.indent - 1), undefined);
    const _t11547 = Js_codegen$emit_line(ctx, "})();");
    const _t11516 = _t11547;
    const _t11514 = _t11516;
    const _t11512 = _t11514;
    _t11505 = _t11512;
  }
  _t11505;
  const _t11504 = result_11481;
  const _t11499 = _t11504;
  const _t11492 = _t11499;
  const _t11486 = _t11492;
  const _t11484 = _t11486;
  const _t11482 = _t11484;
  return _t11482;
}
function Js_codegen$compile_cps(ctx, te, cont) {
  while (true) {
    let _t11570;
    if ((!Js_codegen$expr_has_perform(te))) {
      const v_11571 = Js_codegen$compile_non_tail(ctx, te);
      const _t11572 = cont(v_11571);
      _t11570 = _t11572;
    } else {
      let _t11574;
      const _t11573 = te.expr;
      _t11575: {
        if (_t11573._tag === 29) {
          const op_name = _t11573._val[0];
          const arg = _t11573._val[1];
          _t11574 = Js_codegen$compile_perform_cps(ctx, op_name, arg, cont);
          break _t11575;
        }
        if (_t11573._tag === 30) {
          const v_11576 = Js_codegen$compile_non_tail(ctx, te);
          const _t11577 = cont(v_11576);
          _t11574 = _t11577;
          break _t11575;
        }
        if (_t11573._tag === 31) {
          const k_expr = _t11573._val[0];
          const val_expr = _t11573._val[1];
          const k_js_11578 = Js_codegen$compile_non_tail(ctx, k_expr);
          const v_js_11580 = Js_codegen$compile_non_tail(ctx, val_expr);
          const _t11581 = Js_codegen$emit_line(ctx, (((("return _bounce(function() { return " + __dict_Show_string.show(k_js_11578)) + "(") + __dict_Show_string.show(v_js_11580)) + "); });"));
          const _t11579 = _t11581;
          _t11574 = _t11579;
          break _t11575;
        }
        if (_t11573._tag === 8) {
          const name = _t11573._val[0];
          const e1 = _t11573._val[2];
          const e2 = _t11573._val[3];
          _t11574 = Js_codegen$compile_let_cps(ctx, name, e1, e2, cont);
          break _t11575;
        }
        if (_t11573._tag === 9) {
          const name = _t11573._val[0];
          const fn_expr = _t11573._val[2];
          const body = _t11573._val[3];
          _t11574 = Js_codegen$compile_letrec_cps(ctx, name, fn_expr, body, cont);
          break _t11575;
        }
        if (_t11573._tag === 28) {
          const e1 = _t11573._val[0];
          const e2 = _t11573._val[1];
          _t11574 = Js_codegen$compile_seq_cps(ctx, e1, e2, cont);
          break _t11575;
        }
        if (_t11573._tag === 12) {
          const cond = _t11573._val[0];
          const then_e = _t11573._val[1];
          const else_e = _t11573._val[2];
          _t11574 = Js_codegen$compile_if_cps(ctx, cond, then_e, else_e, cont);
          break _t11575;
        }
        if (_t11573._tag === 24) {
          const scrut = _t11573._val[0];
          const arms = _t11573._val[1];
          const _partial = _t11573._val[2];
          _t11574 = Js_codegen$compile_match_cps(ctx, scrut, arms, te.loc, cont);
          break _t11575;
        }
        if (_t11573._tag === 11) {
          const fn_ = _t11573._val[0];
          const arg = _t11573._val[1];
          _t11574 = Js_codegen$compile_app_cps(ctx, te, fn_, arg, cont);
          break _t11575;
        }
        if (_t11573._tag === 10) {
          const v_11582 = Js_codegen$compile_non_tail(ctx, te);
          const _t11583 = cont(v_11582);
          _t11574 = _t11583;
          break _t11575;
        }
        if (_t11573._tag === 25) {
          const name = _t11573._val[0];
          const init = _t11573._val[1];
          const body = _t11573._val[2];
          let _t11584;
          if (Js_codegen$expr_has_perform(init)) {
            const _t11585 = ctx;
            const _t11586 = init;
            function _t11588(init_v) {
              const js_name_11589 = Js_codegen$mangle_name(name);
              const actual_name_11591 = (js_name_11589 + ("_" + string_of_int(ctx.tmp_counter)));
              (ctx.tmp_counter = (ctx.tmp_counter + 1), undefined);
              Js_codegen$push_scope(ctx);
              Js_codegen$bind_var(ctx, name, actual_name_11591);
              Js_codegen$emit_line(ctx, (((("let " + __dict_Show_string.show(actual_name_11591)) + " = ") + __dict_Show_string.show(init_v)) + ";"));
              Js_codegen$compile_cps(ctx, body, cont);
              const _t11592 = Js_codegen$pop_scope(ctx);
              const _t11590 = _t11592;
              return _t11590;
            }
            const _t11587 = _t11588;
            ctx = _t11585;
            te = _t11586;
            cont = _t11587;
            continue;
            _t11584 = undefined;
          } else {
            const v_11593 = Js_codegen$compile_non_tail(ctx, init);
            const js_name_11595 = Js_codegen$mangle_name(name);
            const actual_name_11597 = (js_name_11595 + ("_" + string_of_int(ctx.tmp_counter)));
            (ctx.tmp_counter = (ctx.tmp_counter + 1), undefined);
            Js_codegen$push_scope(ctx);
            Js_codegen$bind_var(ctx, name, actual_name_11597);
            Js_codegen$emit_line(ctx, (((("let " + __dict_Show_string.show(actual_name_11597)) + " = ") + __dict_Show_string.show(v_11593)) + ";"));
            Js_codegen$compile_cps(ctx, body, cont);
            const _t11598 = Js_codegen$pop_scope(ctx);
            const _t11596 = _t11598;
            const _t11594 = _t11596;
            _t11584 = _t11594;
          }
          _t11574 = _t11584;
          break _t11575;
        }
        if (_t11573._tag === 32) {
          const cond = _t11573._val[0];
          const body = _t11573._val[1];
          _t11574 = Js_codegen$compile_while_cps(ctx, cond, body, cont);
          break _t11575;
        }
        if (true) {
          const v_11599 = Js_codegen$compile_non_tail(ctx, te);
          const _t11600 = cont(v_11599);
          _t11574 = _t11600;
          break _t11575;
        }
        _match_fail("line 15950");
      }
      _t11570 = _t11574;
    }
    return _t11570;
  }
}
function Js_codegen$compile_while_cps(ctx, cond, body, cont) {
  const loop_fn_11601 = Js_codegen$fresh_tmp(ctx);
  const break_flag_11603 = Js_codegen$fresh_tmp(ctx);
  const break_val_11605 = Js_codegen$fresh_tmp(ctx);
  const saved_break_flag_11607 = ctx.break_flag_name;
  const saved_break_val_11609 = ctx.break_val_name;
  (ctx.break_flag_name = break_flag_11603, undefined);
  (ctx.break_val_name = break_val_11605, undefined);
  Js_codegen$emit_line(ctx, (((("let " + __dict_Show_string.show(break_flag_11603)) + " = false, ") + __dict_Show_string.show(break_val_11605)) + ";"));
  Js_codegen$emit_line(ctx, (("function " + __dict_Show_string.show(loop_fn_11601)) + "() {"));
  (ctx.indent = (ctx.indent + 1), undefined);
  const c_11611 = Js_codegen$compile_non_tail(ctx, cond);
  Js_codegen$emit_line(ctx, (("if (!(" + __dict_Show_string.show(c_11611)) + ")) {"));
  (ctx.indent = (ctx.indent + 1), undefined);
  cont("undefined");
  (ctx.indent = (ctx.indent - 1), undefined);
  Js_codegen$emit_line(ctx, "}");
  function _t11613(body_val) {
    Js_codegen$emit_line(ctx, (__dict_Show_string.show(body_val) + ";"));
    Js_codegen$emit_line(ctx, (("if (" + __dict_Show_string.show(break_flag_11603)) + ") {"));
    (ctx.indent = (ctx.indent + 1), undefined);
    cont(break_val_11605);
    (ctx.indent = (ctx.indent - 1), undefined);
    Js_codegen$emit_line(ctx, "}");
    return Js_codegen$emit_line(ctx, (("return _bounce(" + __dict_Show_string.show(loop_fn_11601)) + ");"));
  }
  Js_codegen$compile_cps(ctx, body, _t11613);
  (ctx.indent = (ctx.indent - 1), undefined);
  Js_codegen$emit_line(ctx, "}");
  Js_codegen$emit_line(ctx, (("return _bounce(" + __dict_Show_string.show(loop_fn_11601)) + ");"));
  (ctx.break_flag_name = saved_break_flag_11607, undefined);
  const _t11612 = (ctx.break_val_name = saved_break_val_11609, undefined);
  const _t11610 = _t11612;
  const _t11608 = _t11610;
  const _t11606 = _t11608;
  const _t11604 = _t11606;
  const _t11602 = _t11604;
  return _t11602;
}
function Js_codegen$compile_perform_cps(ctx, op_name, arg, cont) {
  let _t11615;
  const _t11614 = List$assoc_opt(op_name, ctx.direct_dispatch_ops);
  _t11616: {
    if (_t11614._tag === 1) {
      const direct_fn = _t11614._val;
      const arg_js_11617 = Js_codegen$compile_non_tail(ctx, arg);
      const result_var_11619 = Js_codegen$fresh_tmp(ctx);
      Js_codegen$emit_line(ctx, (((((("const " + __dict_Show_string.show(result_var_11619)) + " = ") + __dict_Show_string.show(direct_fn)) + "(") + __dict_Show_string.show(arg_js_11617)) + ");"));
      const _t11620 = cont(result_var_11619);
      const _t11618 = _t11620;
      _t11615 = _t11618;
      break _t11616;
    }
    if (_t11614._tag === 0) {
      if (List$mem(op_name, ctx.trywith_ops)) {
        const arg_js_11621 = Js_codegen$compile_non_tail(ctx, arg);
        const _t11622 = Js_codegen$emit_line(ctx, (((("throw {_e: \"" + __dict_Show_string.show(op_name)) + "\", _v: ") + __dict_Show_string.show(arg_js_11621)) + "};"));
        _t11615 = _t11622;
        break _t11616;
      }
    }
    if (_t11614._tag === 0) {
      const arg_js_11623 = Js_codegen$compile_non_tail(ctx, arg);
      const result_var_11625 = Js_codegen$fresh_tmp(ctx);
      Js_codegen$emit_line(ctx, (((((("return _h[\"" + __dict_Show_string.show(op_name)) + "\"](") + __dict_Show_string.show(arg_js_11623)) + ", function(") + __dict_Show_string.show(result_var_11625)) + ") {"));
      (ctx.indent = (ctx.indent + 1), undefined);
      Js_codegen$emit_line(ctx, "return _bounce(function() {");
      (ctx.indent = (ctx.indent + 1), undefined);
      cont(result_var_11625);
      (ctx.indent = (ctx.indent - 1), undefined);
      Js_codegen$emit_line(ctx, "});");
      (ctx.indent = (ctx.indent - 1), undefined);
      const _t11626 = Js_codegen$emit_line(ctx, "});");
      const _t11624 = _t11626;
      _t11615 = _t11624;
      break _t11616;
    }
    _match_fail("line 15950");
  }
  return _t11615;
}
function Js_codegen$compile_let_cps(ctx, name, e1, e2, cont) {
  let _t11627;
  if (Js_codegen$expr_has_perform(e1)) {
    function _t11628(v1) {
      const js_name_11629 = Js_codegen$mangle_name(name);
      let _t11631;
      if ((js_name_11629 === "_")) {
        _t11631 = Js_codegen$fresh_tmp(ctx);
      } else {
        function _t11632(n) {
          (ctx.tmp_counter = (ctx.tmp_counter + 1), undefined);
          return n;
        }
        _t11631 = _call(_t11632, [(js_name_11629 + ("_" + string_of_int(ctx.tmp_counter)))]);
      }
      const actual_name_11633 = _t11631;
      Js_codegen$push_scope(ctx);
      Js_codegen$bind_var(ctx, name, actual_name_11633);
      Js_codegen$emit_line(ctx, (((("const " + __dict_Show_string.show(actual_name_11633)) + " = ") + __dict_Show_string.show(v1)) + ";"));
      Js_codegen$compile_cps(ctx, e2, cont);
      const _t11634 = Js_codegen$pop_scope(ctx);
      const _t11630 = _t11634;
      return _t11630;
    }
    _t11627 = Js_codegen$compile_cps(ctx, e1, _t11628);
  } else {
    const v1_11635 = Js_codegen$compile_non_tail(ctx, e1);
    const js_name_11637 = Js_codegen$mangle_name(name);
    let _t11639;
    if ((js_name_11637 === "_")) {
      _t11639 = Js_codegen$fresh_tmp(ctx);
    } else {
      function _t11640(n) {
        (ctx.tmp_counter = (ctx.tmp_counter + 1), undefined);
        return n;
      }
      _t11639 = _call(_t11640, [(js_name_11637 + ("_" + string_of_int(ctx.tmp_counter)))]);
    }
    const actual_name_11641 = _t11639;
    Js_codegen$push_scope(ctx);
    Js_codegen$bind_var(ctx, name, actual_name_11641);
    Js_codegen$emit_line(ctx, (((("const " + __dict_Show_string.show(actual_name_11641)) + " = ") + __dict_Show_string.show(v1_11635)) + ";"));
    Js_codegen$compile_cps(ctx, e2, cont);
    const _t11642 = Js_codegen$pop_scope(ctx);
    const _t11638 = _t11642;
    const _t11636 = _t11638;
    _t11627 = _t11636;
  }
  return _t11627;
}
function Js_codegen$compile_letrec_cps(ctx, name, fn_expr, body, cont) {
  const js_name_11643 = Js_codegen$mangle_name(name);
  Js_codegen$push_scope(ctx);
  Js_codegen$bind_var(ctx, name, js_name_11643);
  Js_codegen$compile_named_function(ctx, js_name_11643, fn_expr);
  Js_codegen$compile_cps(ctx, body, cont);
  const _t11644 = Js_codegen$pop_scope(ctx);
  return _t11644;
}
function Js_codegen$compile_seq_cps(ctx, e1, e2, cont) {
  let _t11645;
  if (Js_codegen$expr_has_perform(e1)) {
    function _t11646(v1) {
      Js_codegen$emit_line(ctx, (__dict_Show_string.show(v1) + ";"));
      return Js_codegen$compile_cps(ctx, e2, cont);
    }
    _t11645 = Js_codegen$compile_cps(ctx, e1, _t11646);
  } else {
    const v1_11647 = Js_codegen$compile_non_tail(ctx, e1);
    Js_codegen$emit_line(ctx, (__dict_Show_string.show(v1_11647) + ";"));
    const _t11648 = Js_codegen$compile_cps(ctx, e2, cont);
    _t11645 = _t11648;
  }
  return _t11645;
}
function Js_codegen$compile_if_cps(ctx, cond, then_e, else_e, cont) {
  const c_11649 = Js_codegen$compile_non_tail(ctx, cond);
  Js_codegen$emit_line(ctx, (("if (" + __dict_Show_string.show(c_11649)) + ") {"));
  (ctx.indent = (ctx.indent + 1), undefined);
  Js_codegen$compile_cps(ctx, then_e, cont);
  (ctx.indent = (ctx.indent - 1), undefined);
  Js_codegen$emit_line(ctx, "} else {");
  (ctx.indent = (ctx.indent + 1), undefined);
  Js_codegen$compile_cps(ctx, else_e, cont);
  (ctx.indent = (ctx.indent - 1), undefined);
  const _t11650 = Js_codegen$emit_line(ctx, "}");
  return _t11650;
}
function Js_codegen$compile_match_cps(ctx, scrut, arms, loc, cont) {
  const scrut_js_11651 = Js_codegen$compile_non_tail(ctx, scrut);
  const scrut_tmp_11653 = Js_codegen$fresh_tmp(ctx);
  Js_codegen$emit_line(ctx, (((("const " + __dict_Show_string.show(scrut_tmp_11653)) + " = ") + __dict_Show_string.show(scrut_js_11651)) + ";"));
  const matched_11655 = Js_codegen$fresh_tmp(ctx);
  Js_codegen$emit_line(ctx, (("let " + __dict_Show_string.show(matched_11655)) + " = false;"));
  function _t11657(__p367) {
    let _t11659;
    const _t11658 = __p367;
    _t11660: {
      if (true) {
        const pat = _t11658[0];
        const guard = _t11658[1];
        const body = _t11658[2];
        let _t11662;
        const _t11661 = Js_codegen$compile_pattern(ctx, scrut_tmp_11653, pat);
        _t11663: {
          if (true) {
            const conds = _t11661[0];
            const bindings = _t11661[1];
            let _t11665;
            const _t11664 = conds;
            _t11666: {
              if (_t11664 === null) {
                _t11665 = "true";
                break _t11666;
              }
              if (true) {
                _t11665 = String$concat(" && ", conds);
                break _t11666;
              }
              _match_fail("line 15950");
            }
            const cond_str_11667 = _t11665;
            Js_codegen$emit_line(ctx, (((("if (!" + __dict_Show_string.show(matched_11655)) + " && ") + __dict_Show_string.show(cond_str_11667)) + ") {"));
            (ctx.indent = (ctx.indent + 1), undefined);
            Js_codegen$push_scope(ctx);
            function _t11669(__p368) {
              let _t11671;
              const _t11670 = __p368;
              _t11672: {
                if (true) {
                  const mml_name = _t11670[0];
                  const js_expr = _t11670[1];
                  const js_nm_11673 = Js_codegen$mangle_name(mml_name);
                  Js_codegen$bind_var(ctx, mml_name, js_nm_11673);
                  const _t11674 = Js_codegen$emit_line(ctx, (((("const " + __dict_Show_string.show(js_nm_11673)) + " = ") + __dict_Show_string.show(js_expr)) + ";"));
                  _t11671 = _t11674;
                  break _t11672;
                }
                _match_fail("line 15950");
              }
              return _t11671;
            }
            List$iter(_t11669, bindings);
            let _t11676;
            const _t11675 = guard;
            _t11677: {
              if (_t11675._tag === 1) {
                const g = _t11675._val;
                const guard_js_11678 = Js_codegen$compile_non_tail(ctx, g);
                Js_codegen$emit_line(ctx, (("if (" + __dict_Show_string.show(guard_js_11678)) + ") {"));
                (ctx.indent = (ctx.indent + 1), undefined);
                Js_codegen$emit_line(ctx, (__dict_Show_string.show(matched_11655) + " = true;"));
                Js_codegen$compile_cps(ctx, body, cont);
                (ctx.indent = (ctx.indent - 1), undefined);
                const _t11679 = Js_codegen$emit_line(ctx, "}");
                _t11676 = _t11679;
                break _t11677;
              }
              if (_t11675._tag === 0) {
                Js_codegen$emit_line(ctx, (__dict_Show_string.show(matched_11655) + " = true;"));
                _t11676 = Js_codegen$compile_cps(ctx, body, cont);
                break _t11677;
              }
              _match_fail("line 15950");
            }
            _t11676;
            Js_codegen$pop_scope(ctx);
            (ctx.indent = (ctx.indent - 1), undefined);
            const _t11668 = Js_codegen$emit_line(ctx, "}");
            _t11662 = _t11668;
            break _t11663;
          }
          _match_fail("line 15950");
        }
        _t11659 = _t11662;
        break _t11660;
      }
      _match_fail("line 15950");
    }
    return _t11659;
  }
  List$iter(_t11657, arms);
  const _t11656 = Js_codegen$emit_line(ctx, (((("if (!" + __dict_Show_string.show(matched_11655)) + ") _match_fail(\"line ") + __dict_Show_int.show(loc.line)) + "\");"));
  const _t11654 = _t11656;
  const _t11652 = _t11654;
  return _t11652;
}
function Js_codegen$compile_app_cps(ctx, _te, fn_, arg, cont) {
  function collect_args(expr, acc) {
    while (true) {
      let _t11681;
      const _t11680 = expr.expr;
      _t11682: {
        if (_t11680._tag === 11) {
          const inner_fn = _t11680._val[0];
          const inner_arg = _t11680._val[1];
          const _t11683 = inner_fn;
          const _t11684 = ({_hd: inner_arg, _tl: acc});
          expr = _t11683;
          acc = _t11684;
          continue;
          _t11681 = undefined;
          break _t11682;
        }
        if (true) {
          _t11681 = [expr, acc];
          break _t11682;
        }
        _match_fail("line 15950");
      }
      return _t11681;
    }
  }
  let _t11687;
  const _t11686 = collect_args(fn_, ({_hd: arg, _tl: null}));
  _t11688: {
    if (true) {
      const base_fn = _t11686[0];
      const all_args = _t11686[1];
      const fn_js_11689 = Js_codegen$compile_non_tail(ctx, base_fn);
      const args_js_11691 = List$map(_call(Js_codegen$compile_non_tail, [ctx]), all_args);
      const n_11693 = List$length(all_args);
      const known_arity_11695 = Js_codegen$count_arrows(base_fn.ty);
      let _t11697;
      if (_eq(known_arity_11695, ({_tag: 1, _name: "Some", _val: n_11693}))) {
        _t11697 = (fn_js_11689 + ("(" + (String$concat(", ", args_js_11691) + ")")));
      } else {
        _t11697 = ("_call(" + (fn_js_11689 + (", [" + (String$concat(", ", args_js_11691) + "])"))));
      }
      const call_expr_11698 = _t11697;
      const result_var_11700 = Js_codegen$fresh_tmp(ctx);
      Js_codegen$emit_line(ctx, (((("const " + __dict_Show_string.show(result_var_11700)) + " = ") + __dict_Show_string.show(call_expr_11698)) + ";"));
      const _t11701 = cont(result_var_11700);
      const _t11699 = _t11701;
      const _t11696 = _t11699;
      const _t11694 = _t11696;
      const _t11692 = _t11694;
      const _t11690 = _t11692;
      _t11687 = _t11690;
      break _t11688;
    }
    _match_fail("line 15950");
  }
  const _t11685 = _t11687;
  return _t11685;
}
function Js_codegen$compile_decl(ctx, decl) {
  let _t11703;
  const _t11702 = decl;
  _t11704: {
    if (_t11702._tag === 0) {
      const name = _t11702._val[0];
      const te = _t11702._val[1];
      let _t11705;
      if ((name === "_")) {
        const v_11706 = Js_codegen$compile_expr(ctx, te);
        const _t11707 = Js_codegen$emit_line(ctx, (__dict_Show_string.show(v_11706) + ";"));
        _t11705 = _t11707;
      } else {
        const base_name_11708 = Js_codegen$mangle_name(name);
        let _t11711;
        const _t11710 = ctx.scopes;
        _t11712: {
          if (_t11710 !== null) {
            const tbl = _t11710._hd;
            if (_call(Hashtbl$has, [__dict_Hash_string, __dict_Eq_string, tbl, name])) {
              _t11711 = (Js_codegen$fresh_tmp(ctx) + ("_" + base_name_11708));
              break _t11712;
            }
          }
          if (true) {
            _t11711 = base_name_11708;
            break _t11712;
          }
          _match_fail("line 15950");
        }
        const js_name_11713 = _t11711;
        let _t11716;
        const _t11715 = te.expr;
        _t11717: {
          if (_t11715._tag === 10) {
            Js_codegen$compile_named_function(ctx, js_name_11713, te);
            _t11716 = Js_codegen$bind_var(ctx, name, js_name_11713);
            break _t11717;
          }
          if (true) {
            const v_11718 = Js_codegen$compile_expr(ctx, te);
            Js_codegen$emit_line(ctx, (((("const " + __dict_Show_string.show(js_name_11713)) + " = ") + __dict_Show_string.show(v_11718)) + ";"));
            const _t11719 = Js_codegen$bind_var(ctx, name, js_name_11713);
            _t11716 = _t11719;
            break _t11717;
          }
          _match_fail("line 15950");
        }
        _t11716;
        let _t11720;
        if (((List$length(ctx.scopes) === 1) && Js_codegen$is_exportable_name(name))) {
          _t11720 = (ctx.top_level_exports = ({_hd: [name, js_name_11713], _tl: ctx.top_level_exports}), undefined);
        } else {
          _t11720 = undefined;
        }
        const _t11714 = _t11720;
        const _t11709 = _t11714;
        _t11705 = _t11709;
      }
      _t11703 = _t11705;
      break _t11704;
    }
    if (_t11702._tag === 1) {
      const name = _t11702._val[0];
      const te = _t11702._val[1];
      const js_name_11721 = Js_codegen$mangle_name(name);
      const v_11723 = Js_codegen$compile_expr(ctx, te);
      Js_codegen$emit_line(ctx, (((("let " + __dict_Show_string.show(js_name_11721)) + " = ") + __dict_Show_string.show(v_11723)) + ";"));
      Js_codegen$bind_var(ctx, name, js_name_11721);
      let _t11725;
      if (((List$length(ctx.scopes) === 1) && Js_codegen$is_exportable_name(name))) {
        _t11725 = (ctx.top_level_exports = ({_hd: [name, js_name_11721], _tl: ctx.top_level_exports}), undefined);
      } else {
        _t11725 = undefined;
      }
      const _t11724 = _t11725;
      const _t11722 = _t11724;
      _t11703 = _t11722;
      break _t11704;
    }
    if (_t11702._tag === 2) {
      const name = _t11702._val[0];
      const te = _t11702._val[1];
      const js_name_11726 = Js_codegen$mangle_name(name);
      Js_codegen$bind_var(ctx, name, js_name_11726);
      Js_codegen$compile_named_function(ctx, js_name_11726, te);
      let _t11728;
      if (((List$length(ctx.scopes) === 1) && Js_codegen$is_exportable_name(name))) {
        _t11728 = (ctx.top_level_exports = ({_hd: [name, js_name_11726], _tl: ctx.top_level_exports}), undefined);
      } else {
        _t11728 = undefined;
      }
      const _t11727 = _t11728;
      _t11703 = _t11727;
      break _t11704;
    }
    if (_t11702._tag === 3) {
      const bindings = _t11702._val;
      function _t11729(__p369) {
        let _t11731;
        const _t11730 = __p369;
        _t11732: {
          if (true) {
            const name = _t11730[0];
            const js_name_11733 = Js_codegen$mangle_name(name);
            Js_codegen$bind_var(ctx, name, js_name_11733);
            let _t11735;
            if (((List$length(ctx.scopes) === 1) && Js_codegen$is_exportable_name(name))) {
              _t11735 = (ctx.top_level_exports = ({_hd: [name, js_name_11733], _tl: ctx.top_level_exports}), undefined);
            } else {
              _t11735 = undefined;
            }
            const _t11734 = _t11735;
            _t11731 = _t11734;
            break _t11732;
          }
          _match_fail("line 15950");
        }
        return _t11731;
      }
      List$iter(_t11729, bindings);
      function _t11736(__p370) {
        let _t11738;
        const _t11737 = __p370;
        _t11739: {
          if (true) {
            const name = _t11737[0];
            const fn_expr = _t11737[1];
            const js_name_11740 = Js_codegen$mangle_name(name);
            const _t11741 = Js_codegen$compile_named_function(ctx, js_name_11740, fn_expr);
            _t11738 = _t11741;
            break _t11739;
          }
          _match_fail("line 15950");
        }
        return _t11738;
      }
      _t11703 = List$iter(_t11736, bindings);
      break _t11704;
    }
    if (_t11702._tag === 4) {
      _t11703 = undefined;
      break _t11704;
    }
    if (_t11702._tag === 6) {
      _t11703 = undefined;
      break _t11704;
    }
    if (_t11702._tag === 7) {
      _t11703 = undefined;
      break _t11704;
    }
    if (_t11702._tag === 5) {
      const te = _t11702._val;
      const v_11742 = Js_codegen$compile_expr(ctx, te);
      const _t11743 = Js_codegen$emit_line(ctx, (("_last_val = " + __dict_Show_string.show(v_11742)) + ";"));
      _t11703 = _t11743;
      break _t11704;
    }
    if (_t11702._tag === 8) {
      const name = _t11702._val[0];
      const _scheme = _t11702._val[1];
      const js_name_11744 = Js_codegen$mangle_name(name);
      Js_codegen$emit_line(ctx, (((((((((("if (typeof " + __dict_Show_string.show(js_name_11744)) + " === \"undefined\") { if (globalThis._mmlExterns && globalThis._mmlExterns[") + __dict_Show_string.show(Js_codegen$escape_js_string(name))) + "]) var ") + __dict_Show_string.show(js_name_11744)) + " = globalThis._mmlExterns[") + __dict_Show_string.show(Js_codegen$escape_js_string(name))) + "]; else throw new Error(\"extern \" + ") + __dict_Show_string.show(Js_codegen$escape_js_string(name))) + " + \" not provided\"); }"));
      const _t11745 = Js_codegen$bind_var(ctx, name, js_name_11744);
      _t11703 = _t11745;
      break _t11704;
    }
    if (_t11702._tag === 9) {
      const mod_name = _t11702._val[0];
      const decls = _t11702._val[1];
      const saved_module_11746 = ctx.current_module;
      (ctx.current_module = ({_tag: 1, _name: "Some", _val: mod_name}), undefined);
      Js_codegen$push_scope(ctx);
      List$iter(_call(Js_codegen$compile_decl, [ctx]), decls);
      (ctx.current_module = saved_module_11746, undefined);
      let _t11749;
      const _t11748 = ctx.scopes;
      _t11750: {
        if (_t11748 !== null) {
          const current = _t11748._hd;
          function _t11751(mml_name, js_name) {
            const qualified_11752 = (mod_name + ("." + mml_name));
            let _t11755;
            const _t11754 = ctx.scopes;
            _t11756: {
              if (_t11754 !== null && _t11754._tl !== null) {
                const parent = _t11754._tl._hd;
                _call(Hashtbl$set, [__dict_Hash_string, __dict_Eq_string, parent, qualified_11752, js_name]);
                _t11755 = _call(Hashtbl$set, [__dict_Hash_string, __dict_Eq_string, parent, mml_name, js_name]);
                break _t11756;
              }
              if (true) {
                _t11755 = undefined;
                break _t11756;
              }
              _match_fail("line 15950");
            }
            const _t11753 = _t11755;
            return _t11753;
          }
          _t11749 = Hashtbl$iter(_t11751, current);
          break _t11750;
        }
        if (_t11748 === null) {
          _t11749 = undefined;
          break _t11750;
        }
        _match_fail("line 15950");
      }
      _t11749;
      const _t11747 = Js_codegen$pop_scope(ctx);
      _t11703 = _t11747;
      break _t11704;
    }
    if (_t11702._tag === 10) {
      const aliases = _t11702._val;
      function _t11757(__p371) {
        let _t11759;
        const _t11758 = __p371;
        _t11760: {
          if (true) {
            const short_name = _t11758[0];
            const qualified_name = _t11758[1];
            const js_name_11761 = Js_codegen$lookup_var(ctx, qualified_name);
            const _t11762 = Js_codegen$bind_var(ctx, short_name, js_name_11761);
            _t11759 = _t11762;
            break _t11760;
          }
          _match_fail("line 15950");
        }
        return _t11759;
      }
      _t11703 = List$iter(_t11757, aliases);
      break _t11704;
    }
    _match_fail("line 15950");
  }
  return _t11703;
}
const Js_codegen$js_builtins = "// --- Builtins ---\nfunction print(v) {\n  const s = (typeof v === \"string\") ? v : _pp(v);\n  if (typeof globalThis._jsOutput === \"function\") globalThis._jsOutput(s);\n  else if (typeof process !== \"undefined\") process.stdout.write(s);\n  return undefined;\n}\nfunction println(v) {\n  const s = (typeof v === \"string\") ? v : _pp(v);\n  if (typeof globalThis._jsOutput === \"function\") globalThis._jsOutput(s + \"\\n\");\n  else if (typeof process !== \"undefined\") process.stdout.write(s + \"\\n\");\n  return undefined;\n}\nfunction string_of_int(n) { return String(n); }\nfunction int_of_string(s) { const n = parseInt(s, 10); if (isNaN(n)) throw new Error(\"int_of_string: \" + s); return n; }\nfunction float_of_int(n) { return n; }\nfunction int_of_float(f) { return Math.trunc(f); }\nfunction float_of_string(s) { const f = parseFloat(s); if (isNaN(f)) throw new Error(\"float_of_string: \" + s); return f; }\nfunction string_of_float(f) {\n  const s = String(f);\n  return s.includes(\".\") || s.includes(\"e\") ? s : s + \".\";\n}\nfunction string_of_bool(b) { return String(b); }\nfunction failwith(msg) { throw new Error(msg); }\nconst not = (b) => !b;\nfunction $caret(a, b) { return a + b; }\nfunction $mod(a, b) { return a % b; }\nfunction __show_value(v) { return _pp(v); }\nfunction copy_continuation(k) { return k; }\nconst ignore = (_) => undefined;\nfunction fst(t) { return t[0]; }\nfunction snd(t) { return t[1]; }\nfunction string_length(s) { return s.length; }\nfunction string_sub(s, start, len) { return s.substring(start, start + len); }\nfunction string_get(s, i) { return s.charCodeAt(i); }\nfunction string_contains(s, sub) { return s.includes(sub); }\nfunction string_concat(sep, parts) {\n  const arr = [];\n  let c = parts;\n  while (c !== null) { arr.push(c._hd); c = c._tl; }\n  return arr.join(sep);\n}\nfunction array_length(a) { return a._arr.length; }\nfunction array_get(a, i) { return a._arr[i]; }\nfunction array_set(a, i, v) { a._arr[i] = v; return undefined; }\nfunction array_make(n, v) { return {_arr: new Array(n).fill(v)}; }\nfunction array_of_list(lst) {\n  const arr = [];\n  let c = lst;\n  while (c !== null) { arr.push(c._hd); c = c._tl; }\n  return {_arr: arr};\n}\nfunction array_to_list(arr) {\n  const a = arr._arr;\n  let result = null;\n  for (let i = a.length - 1; i >= 0; i--) result = {_hd: a[i], _tl: result};\n  return result;\n}\nfunction array_copy(a) { return {_arr: a._arr.slice()}; }\nfunction array_sub(a, start, len) { return {_arr: a._arr.slice(start, start + len)}; }\nfunction __math_pow(a, b) { return Math.pow(a, b); }\nfunction __math_sqrt(x) { return Math.sqrt(x); }\nfunction __math_floor(x) { return Math.floor(x); }\nfunction __math_ceil(x) { return Math.ceil(x); }\nfunction __math_round(x) { return Math.round(x); }\nfunction __math_abs(x) { return Math.abs(x); }\nfunction __math_sin(x) { return Math.sin(x); }\nfunction __math_cos(x) { return Math.cos(x); }\nfunction __math_abs_float(x) { return Math.abs(x); }\nfunction __byte_to_char(b) { return String.fromCharCode(b); }\nfunction __byte_to_int(b) { return b; }\nfunction __byte_of_int(n) { return n & 0xFF; }\nfunction __byte_to_string(b) { return String.fromCharCode(b); }\nfunction __char_to_byte(s) { return s.charCodeAt(0); }\nfunction __rune_to_string(cp) {\n  return String.fromCodePoint(cp);\n}\nfunction __string_to_runes(s) {\n  const cps = Array.from(s).map(c => c.codePointAt(0));\n  let result = null;\n  for (let i = cps.length - 1; i >= 0; i--) result = {_hd: cps[i], _tl: result};\n  return result;\n}\nfunction __map_has(m, k) { return m.has(k); }\nfunction __map_get(m, k) { return m.get(k); }\nfunction __rune_to_int(r) { return r; }\nfunction __rune_of_int(n) { return n; }\nfunction __int_to_hex(n) { return n.toString(16); }\nfunction __int_to_oct(n) { return n.toString(8); }\nfunction __int_to_bin(n) { return n.toString(2); }\nfunction __fmt_float(prec, f) { return f.toFixed(prec); }\nfunction __fmt_hex(n) { return n.toString(16); }\nfunction __fmt_hex_upper(n) { return n.toString(16).toUpperCase(); }\nfunction __fmt_oct(n) { return n.toString(8); }\nfunction __fmt_bin(n) { return n.toString(2); }\nfunction __fmt_zero_pad(width, s) { return s.padStart(width, \"0\"); }\nfunction __fmt_pad_left(width, s) { return s.padStart(width, \" \"); }\nfunction __fmt_pad_right(width, s) { return s.padEnd(width, \" \"); }\nfunction __sys_time() { return Date.now() / 1000.0; }\nfunction __sys_exit(code) { if (typeof process !== \"undefined\") process.exit(code); throw new Error(\"exit: \" + code); }\n// --- Module extern stubs ---\n// String module\nfunction String$length(s) { return s.length; }\nfunction String$sub(s, start, len) {\n  if (start < 0 || len < 0 || start + len > s.length)\n    throw new Error(\"String.sub: index out of bounds\");\n  return s.substring(start, start + len);\n}\nfunction String$split(delim, input) {\n  if (delim.length === 0) {\n    let r = null;\n    for (let i = input.length - 1; i >= 0; i--) r = {_hd: input[i], _tl: r};\n    return r;\n  }\n  const parts = input.split(delim);\n  let r = null;\n  for (let i = parts.length - 1; i >= 0; i--) r = {_hd: parts[i], _tl: r};\n  return r;\n}\nfunction String$trim(s) { return s.trim(); }\nfunction String$starts_with(prefix, s) { return s.startsWith(prefix); }\nfunction String$contains(sub, s) { return s.includes(sub); }\nfunction String$replace(old_s, new_s, input) {\n  if (old_s.length === 0) return input;\n  return input.split(old_s).join(new_s);\n}\nfunction String$to_int(s) { const n = parseInt(s,10); return isNaN(n) ? {_tag:0,_name:\"None\"} : {_tag:1,_name:\"Some\",_val:n}; }\nfunction String$to_float(s) { const f = parseFloat(s); return isNaN(f) ? {_tag:0,_name:\"None\"} : {_tag:1,_name:\"Some\",_val:f}; }\nfunction String$uppercase(s) { return s.toUpperCase(); }\nfunction String$lowercase(s) { return s.toLowerCase(); }\nfunction String$get(s, i) {\n  if (i < 0 || i >= s.length) throw new Error(\"String.get: index \" + i + \" out of bounds (length \" + s.length + \")\");\n  return s.charCodeAt(i);\n}\nfunction String$to_bytes(s) {\n  let r = null;\n  for (let i = s.length - 1; i >= 0; i--) r = {_hd: s.charCodeAt(i), _tl: r};\n  return r;\n}\nfunction String$of_bytes(lst) {\n  let r = \"\";\n  let c = lst;\n  while (c !== null) { r += String.fromCharCode(c._hd); c = c._tl; }\n  return r;\n}\nfunction String$to_byte_array(s) {\n  const a = new Array(s.length);\n  for (let i = 0; i < s.length; i++) a[i] = s.charCodeAt(i);\n  return {_arr: a};\n}\nfunction String$of_byte_array(a) {\n  let r = \"\";\n  for (let i = 0; i < a._arr.length; i++) r += String.fromCharCode(a._arr[i]);\n  return r;\n}\nfunction String$to_runes(s) { return __string_to_runes(s); }\nfunction String$of_runes(lst) {\n  let r = \"\";\n  let c = lst;\n  while (c !== null) { r += String.fromCodePoint(c._hd); c = c._tl; }\n  return r;\n}\nfunction String$get_rune(s, n) {\n  const cps = Array.from(s);\n  if (n < 0 || n >= cps.length) throw new Error(\"String.get_rune: index \" + n + \" out of bounds\");\n  return cps[n].codePointAt(0);\n}\nfunction String$of_byte(b) { return String.fromCharCode(b); }\nfunction String$rune_length(s) { return Array.from(s).length; }\nfunction String$make(n, b) {\n  if (n < 0) throw new Error(\"String.make: negative length\");\n  return String.fromCharCode(b).repeat(n);\n}\nfunction String$index_opt(s, b) { const i=s.indexOf(String.fromCharCode(b)); return i<0?{_tag:0,_name:\"None\"}:{_tag:1,_name:\"Some\",_val:i}; }\nfunction String$rindex_opt(s, b) { const i=s.lastIndexOf(String.fromCharCode(b)); return i<0?{_tag:0,_name:\"None\"}:{_tag:1,_name:\"Some\",_val:i}; }\nfunction String$concat(sep, lst) { return string_concat(sep, lst); }\nfunction String$compare(a, b) { return a < b ? -1 : a > b ? 1 : 0; }\n// Array module\nfunction Array$make(n, v) { return array_make(n, v); }\nfunction Array$get(a, i) { return array_get(a, i); }\nfunction Array$set(a, i, v) { return array_set(a, i, v); }\nfunction Array$length(a) { return array_length(a); }\nfunction Array$to_list(a) { return array_to_list(a); }\nfunction Array$of_list(l) { return array_of_list(l); }\nfunction Array$copy(a) { return array_copy(a); }\nfunction Array$sub(a, s, l) { return array_sub(a, s, l); }\n// IO module\nfunction IO$read_file(path) {\n  if (typeof globalThis._jsReadFile === \"function\") return globalThis._jsReadFile(path);\n  if (typeof require !== \"undefined\") return require(\"fs\").readFileSync(path,\"utf8\");\n  throw new Error(\"IO.read_file: not available in this environment\");\n}\nfunction IO$write_file(path, data) {\n  if (typeof require !== \"undefined\") { require(\"fs\").writeFileSync(path,data); return undefined; }\n  throw new Error(\"IO.write_file: not available in this environment\");\n}\nfunction IO$append_file(path, data) {\n  if (typeof require !== \"undefined\") { require(\"fs\").appendFileSync(path,data); return undefined; }\n  throw new Error(\"IO.append_file: not available in this environment\");\n}\nfunction IO$read_line(u) {\n  if (typeof require !== \"undefined\") {\n    const buf = Buffer.alloc(1);\n    let line = \"\";\n    const fd = require(\"fs\").openSync(\"/dev/stdin\", \"rs\");\n    while (true) {\n      const n = require(\"fs\").readSync(fd, buf, 0, 1);\n      if (n === 0 || buf[0] === 10) break;\n      line += String.fromCharCode(buf[0]);\n    }\n    return line;\n  }\n  return \"\";\n}\nfunction IO$file_exists(path) {\n  if (typeof require !== \"undefined\") return require(\"fs\").existsSync(path);\n  return false;\n}\n// Sys module\nfunction Sys$args(u) {\n  if (globalThis._jsSysArgs) {\n    const a = globalThis._jsSysArgs;\n    let r = null;\n    for (let i = a.length - 1; i >= 0; i--) r = {_hd: a[i], _tl: r};\n    return r;\n  }\n  if (typeof process !== \"undefined\") {\n    const a = process.argv.slice(1);\n    let r = null;\n    for (let i = a.length - 1; i >= 0; i--) r = {_hd: a[i], _tl: r};\n    return r;\n  }\n  return null;\n}\nfunction Sys$getenv(name) {\n  if (typeof process !== \"undefined\") {\n    const v = process.env[name];\n    return v === undefined ? {_tag:0,_name:\"None\"} : {_tag:1,_name:\"Some\",_val:v};\n  }\n  return {_tag:0,_name:\"None\"};\n}\nfunction Sys$exit(code) { __sys_exit(code); }\nfunction Sys$time(u) { return __sys_time(); }\n// Runtime module (stubs â€” eval not supported in compiled JS)\nfunction Runtime$eval(s) { throw new Error(\"Runtime.eval: not supported in compiled JS\"); }\nfunction Runtime$eval_file(s) { throw new Error(\"Runtime.eval_file: not supported in compiled JS\"); }\n// --- Typeclass Dictionaries ---\nconst __dict_Num_int = { $star: (a, b) => a * b, $plus: (a, b) => a + b, $minus: (a, b) => a - b, $slash: (a, b) => (a / b) | 0, neg: (a) => -a };\nconst __dict_Num_float = { $star: (a, b) => a * b, $plus: (a, b) => a + b, $minus: (a, b) => a - b, $slash: (a, b) => a / b, neg: (a) => -a };\nconst __dict_Eq_int = { $lt$gt: (a, b) => a !== b, $eq: (a, b) => a === b };\nconst __dict_Eq_float = { $lt$gt: (a, b) => a !== b, $eq: (a, b) => a === b };\nconst __dict_Eq_string = { $lt$gt: (a, b) => a !== b, $eq: (a, b) => a === b };\nconst __dict_Eq_bool = { $lt$gt: (a, b) => a !== b, $eq: (a, b) => a === b };\nconst __dict_Eq_byte = { $lt$gt: (a, b) => a !== b, $eq: (a, b) => a === b };\nconst __dict_Eq_rune = { $lt$gt: (a, b) => a !== b, $eq: (a, b) => a === b };\nconst __dict_Ord_int = { $lt: (a, b) => a < b, $lt$eq: (a, b) => a <= b, $gt: (a, b) => a > b, $gt$eq: (a, b) => a >= b };\nconst __dict_Ord_float = { $lt: (a, b) => a < b, $lt$eq: (a, b) => a <= b, $gt: (a, b) => a > b, $gt$eq: (a, b) => a >= b };\nconst __dict_Ord_string = { $lt: (a, b) => a < b, $lt$eq: (a, b) => a <= b, $gt: (a, b) => a > b, $gt$eq: (a, b) => a >= b };\nconst __dict_Ord_byte = { $lt: (a, b) => a < b, $lt$eq: (a, b) => a <= b, $gt: (a, b) => a > b, $gt$eq: (a, b) => a >= b };\nconst __dict_Ord_rune = { $lt: (a, b) => a < b, $lt$eq: (a, b) => a <= b, $gt: (a, b) => a > b, $gt$eq: (a, b) => a >= b };\nconst __dict_Bitwise_int = { land: (a, b) => a & b, lnot: (a) => ~a, lor: (a, b) => a | b, lsl: (a, b) => a << b, lsr: (a, b) => a >> b, lxor: (a, b) => a ^ b };\nconst __dict_Show_int = { show: (a) => String(a) };\nconst __dict_Show_float = { show: string_of_float };\nconst __dict_Show_bool = { show: (a) => String(a) };\nconst __dict_Show_string = { show: (a) => a };\nconst __dict_Show_unit = { show: (_) => \"()\" };\nconst __dict_Show_byte = { show: (a) => \"#\" + a.toString(16).padStart(2, \"0\") };\nconst __dict_Show_rune = { show: (a) => String.fromCodePoint(a) };\n// --- Canvas builtins (browser only) ---\nfunction Canvas$init(w, h) {\n  if (typeof globalThis._canvasInit === \"function\") globalThis._canvasInit(w, h);\n  return undefined;\n}\nfunction Canvas$clear(color) {\n  const ctx = globalThis._canvasCtx;\n  if (ctx) { ctx.fillStyle = color; ctx.fillRect(0, 0, ctx.canvas.width, ctx.canvas.height); }\n  return undefined;\n}\nfunction Canvas$fill_rect(x, y, w, h, color) {\n  const ctx = globalThis._canvasCtx;\n  if (ctx) { ctx.fillStyle = color; ctx.fillRect(x, y, w, h); }\n  return undefined;\n}\nfunction Canvas$stroke_rect(x, y, w, h, color) {\n  const ctx = globalThis._canvasCtx;\n  if (ctx) { ctx.strokeStyle = color; ctx.lineWidth = 1; ctx.strokeRect(x, y, w, h); }\n  return undefined;\n}\nfunction Canvas$fill_circle(x, y, r, color) {\n  const ctx = globalThis._canvasCtx;\n  if (ctx) { ctx.fillStyle = color; ctx.beginPath(); ctx.arc(x, y, r, 0, 2*Math.PI); ctx.fill(); }\n  return undefined;\n}\nfunction Canvas$draw_text(text, x, y, color) {\n  const ctx = globalThis._canvasCtx;\n  if (ctx) { ctx.fillStyle = color; ctx.textBaseline = \"top\"; ctx.fillText(text, x, y); }\n  return undefined;\n}\nfunction Canvas$set_font(font) {\n  const ctx = globalThis._canvasCtx;\n  if (ctx) { ctx.font = font; }\n  return undefined;\n}\nfunction Canvas$mouse_x(_) { return globalThis._canvasMouseX || 0; }\nfunction Canvas$mouse_y(_) { return globalThis._canvasMouseY || 0; }\nfunction Canvas$mouse_down(_) { return !!globalThis._canvasMouseDown; }\nfunction Canvas$mouse_clicked(_) { return !!globalThis._canvasMouseClicked; }\nfunction Canvas$key_down(key) { return !!(globalThis._canvasKeysDown && globalThis._canvasKeysDown[key]); }\nfunction Canvas$key_pressed(key) { return !!(globalThis._canvasKeysPressed && globalThis._canvasKeysPressed[key]); }\nfunction Canvas$start_app(init_fn, frame_fn) {\n  globalThis._canvasApp = { initFn: init_fn, frameFn: frame_fn, jsMode: true, call: _call };\n  return undefined;\n}\n";
function Js_codegen$emit_exports(ctx) {
  Js_codegen$emit(ctx, "var _mml_exports = {\"_result\": _last_val, \"_call\": _call, \"_pp\": _pp");
  function _t11763(__p372) {
    let _t11765;
    const _t11764 = __p372;
    _t11766: {
      if (true) {
        const mml_name = _t11764[0];
        const js_name = _t11764[1];
        _t11765 = Js_codegen$emit(ctx, (((", " + __dict_Show_string.show(Js_codegen$escape_js_string(mml_name))) + ": ") + __dict_Show_string.show(js_name)));
        break _t11766;
      }
      _match_fail("line 15950");
    }
    return _t11765;
  }
  List$iter(_t11763, List$rev(ctx.top_level_exports));
  Js_codegen$emit(ctx, "};\n");
  return Js_codegen$emit(ctx, "if (typeof globalThis !== \"undefined\") globalThis._mmlExports = _mml_exports;\n");
}
function Js_codegen$compile_program(type_env, program) {
  const ctx_11767 = Js_codegen$create_ctx(type_env);
  Js_codegen$emit(ctx_11767, Js_codegen$js_runtime);
  Js_codegen$emit(ctx_11767, Js_codegen$js_builtins);
  Js_codegen$emit(ctx_11767, "// --- Compiled MiniML ---\n");
  Js_codegen$emit(ctx_11767, "let _last_val;\n");
  List$iter(_call(Js_codegen$compile_decl, [ctx_11767]), program);
  Js_codegen$emit(ctx_11767, "if (_last_val !== undefined) println(_pp(_last_val));\n");
  Js_codegen$emit_exports(ctx_11767);
  const _t11768 = Buffer$contents(ctx_11767.buf);
  return _t11768;
}
function Js_codegen$compile_program_with_stdlib(type_env, stdlib_programs, user_program) {
  const ctx_11769 = Js_codegen$create_ctx(type_env);
  Js_codegen$emit(ctx_11769, Js_codegen$js_runtime);
  Js_codegen$emit(ctx_11769, Js_codegen$js_builtins);
  Js_codegen$emit(ctx_11769, "// --- Stdlib ---\n");
  function _t11771(__p373) {
    let _t11773;
    const _t11772 = __p373;
    _t11774: {
      if (true) {
        const _te = _t11772[0];
        const prog = _t11772[1];
        function _t11775(decl) {
          const saved_pos_11776 = Buffer$length(ctx_11769.buf);
          const saved_indent_11778 = ctx_11769.indent;
          const _t11780 = (function() {
            const _t11781 = _h;
            _h = Object.assign({}, _t11781, {
              "codegen_error": function(_, __k) { throw {_e: "codegen_error", _v: _}; },
            });
            try {
              const __x_11782 = Js_codegen$compile_decl(ctx_11769, decl);
              return __x_11782;
            } catch (_exc) {
              if (_exc && _exc._e === "codegen_error") {
                const _ = _exc._v;
                const full_11783 = Buffer$contents(ctx_11769.buf);
                Buffer$clear(ctx_11769.buf);
                Buffer$add_string(ctx_11769.buf, String$sub(full_11783, 0, saved_pos_11776));
                const _t11784 = (ctx_11769.indent = saved_indent_11778, undefined);
                return _t11784;
              } else { throw _exc; }
            } finally { _h = _t11781; }
          })();
          const _t11779 = _t11780;
          const _t11777 = _t11779;
          return _t11777;
        }
        _t11773 = List$iter(_t11775, prog);
        break _t11774;
      }
      _match_fail("line 15950");
    }
    return _t11773;
  }
  List$iter(_t11771, stdlib_programs);
  Js_codegen$emit(ctx_11769, "// --- Compiled MiniML ---\n");
  Js_codegen$emit(ctx_11769, "let _last_val;\n");
  const stdlib_exports_11785 = ctx_11769.top_level_exports;
  (ctx_11769.top_level_exports = null, undefined);
  List$iter(_call(Js_codegen$compile_decl, [ctx_11769]), user_program);
  Js_codegen$emit(ctx_11769, "if (_last_val !== undefined) println(_pp(_last_val));\n");
  const user_exports_11787 = ctx_11769.top_level_exports;
  (ctx_11769.top_level_exports = user_exports_11787, undefined);
  stdlib_exports_11785;
  undefined;
  Js_codegen$emit_exports(ctx_11769);
  const _t11788 = Buffer$contents(ctx_11769.buf);
  const _t11786 = _t11788;
  const _t11770 = _t11786;
  return _t11770;
}
function Main$list_iter(f, xs) {
  while (true) {
    let _t11790;
    const _t11789 = xs;
    _t11791: {
      if (_t11789 === null) {
        _t11790 = undefined;
        break _t11791;
      }
      if (_t11789 !== null) {
        const x = _t11789._hd;
        const rest = _t11789._tl;
        f(x);
        const _t11792 = f;
        const _t11793 = rest;
        f = _t11792;
        xs = _t11793;
        continue;
        _t11790 = undefined;
        break _t11791;
      }
      _match_fail("line 15950");
    }
    return _t11790;
  }
}
function Main$list_iteri_aux(f, i, xs) {
  while (true) {
    let _t11795;
    const _t11794 = xs;
    _t11796: {
      if (_t11794 === null) {
        _t11795 = undefined;
        break _t11796;
      }
      if (_t11794 !== null) {
        const x = _t11794._hd;
        const rest = _t11794._tl;
        f(i, x);
        const _t11797 = f;
        const _t11798 = (i + 1);
        const _t11799 = rest;
        f = _t11797;
        i = _t11798;
        xs = _t11799;
        continue;
        _t11795 = undefined;
        break _t11796;
      }
      _match_fail("line 15950");
    }
    return _t11795;
  }
}
function Main$list_iteri(f, xs) {
  return Main$list_iteri_aux(f, 0, xs);
}
let Main$native_global_entries = null;
function Main$register_native_ext(idx, name, arity) {
  return (Main$native_global_entries = ({_hd: _call(Serialize$serialize_native_ext, [({show: __show_value}), idx, name, arity]), _tl: Main$native_global_entries}), undefined);
}
function Main$register_native_dict(idx, fields) {
  return (Main$native_global_entries = ({_hd: _call(Serialize$serialize_native_dict, [({show: __show_value}), idx, fields]), _tl: Main$native_global_entries}), undefined);
}
function _t11800_Main$build_native_globals_json(_) {
  return String$concat(",", List$rev(Main$native_global_entries));
}
function Main$add_global(global_names, name) {
  const idx_11801 = Dynarray$length(global_names);
  Dynarray$push(global_names, name);
  const _t11802 = idx_11801;
  return _t11802;
}
function Main$register_builtin(ctx, global_names, name, ty, quant, arity) {
  const scheme_11803 = ({body: ty, constraints: null, equant: 0, pvquant: 0, quant: quant, record_evidences: null, rquant: 0});
  const idx_11805 = Main$add_global(global_names, name);
  Main$register_native_ext(idx_11805, name, arity);
  const stdlib_name_11807 = ("Stdlib." + name);
  const sidx_11809 = Main$add_global(global_names, stdlib_name_11807);
  Main$register_native_ext(sidx_11809, name, arity);
  const vars_11811 = ({_hd: [stdlib_name_11807, scheme_11803], _tl: ({_hd: [name, scheme_11803], _tl: ctx.vars})});
  const __rec_upd_11813 = ctx;
  const _t11814 = ({constraint_tvars: __rec_upd_11813.constraint_tvars, current_eff: __rec_upd_11813.current_eff, current_module: __rec_upd_11813.current_module, inside_handler: __rec_upd_11813.inside_handler, loop_info: __rec_upd_11813.loop_info, mutable_vars: __rec_upd_11813.mutable_vars, return_type: __rec_upd_11813.return_type, return_used: __rec_upd_11813.return_used, type_env: __rec_upd_11813.type_env, vars: vars_11811});
  const _t11812 = [scheme_11803, _t11814];
  const _t11810 = _t11812;
  const _t11808 = _t11810;
  const _t11806 = _t11808;
  const _t11804 = _t11806;
  return _t11804;
}
function Main$register_module_fn(ctx, global_names, mod_name, fn_name, ty, arity) {
  const qualified_11815 = ((mod_name + ".") + fn_name);
  const idx_11817 = Main$add_global(global_names, qualified_11815);
  Main$register_native_ext(idx_11817, qualified_11815, arity);
  const max_gen_11819 = Typechecker$max_tgen_in_ty(ty);
  let _t11821;
  if ((max_gen_11819 >= 0)) {
    _t11821 = ({body: ty, constraints: null, equant: 0, pvquant: 0, quant: (max_gen_11819 + 1), record_evidences: null, rquant: 0});
  } else {
    _t11821 = Types$mono(ty);
  }
  const scheme_11822 = _t11821;
  const vars_11824 = ({_hd: [qualified_11815, scheme_11822], _tl: ctx.vars});
  const __rec_upd_11826 = ctx;
  const _t11827 = ({constraint_tvars: __rec_upd_11826.constraint_tvars, current_eff: __rec_upd_11826.current_eff, current_module: __rec_upd_11826.current_module, inside_handler: __rec_upd_11826.inside_handler, loop_info: __rec_upd_11826.loop_info, mutable_vars: __rec_upd_11826.mutable_vars, return_type: __rec_upd_11826.return_type, return_used: __rec_upd_11826.return_used, type_env: __rec_upd_11826.type_env, vars: vars_11824});
  const _t11825 = [[fn_name, scheme_11822], _t11827];
  const _t11823 = _t11825;
  const _t11820 = _t11823;
  const _t11818 = _t11820;
  const _t11816 = _t11818;
  return _t11816;
}
function Main$register_class_in_ctx(ctx, name, tyvars, methods) {
  const num_params_11828 = List$length(tyvars);
  const class_def_11830 = ({class_fundeps: null, class_methods: methods, class_name: name, class_params: tyvars});
  function _t11832(vars, __p374) {
    let _t11834;
    const _t11833 = __p374;
    _t11835: {
      if (true) {
        const mname = _t11833[0];
        const mty = _t11833[1];
        const max_gen_11836 = Typechecker$max_tgen_in_ty(mty);
        let _t11838;
        if (((max_gen_11836 + 1) > num_params_11828)) {
          _t11838 = (max_gen_11836 + 1);
        } else {
          _t11838 = num_params_11828;
        }
        const quant_11839 = _t11838;
        const _t11840 = ({_hd: [mname, ({body: mty, constraints: null, equant: 0, pvquant: 0, quant: quant_11839, record_evidences: null, rquant: 0})], _tl: vars});
        const _t11837 = _t11840;
        _t11834 = _t11837;
        break _t11835;
      }
      _match_fail("line 15950");
    }
    return _t11834;
  }
  const new_vars_11841 = List$fold(_t11832, ctx.vars, methods);
  const __rec_upd_11843 = ctx.type_env;
  const _t11844 = ({classes: ({_hd: class_def_11830, _tl: ctx.type_env.classes}), constructors: __rec_upd_11843.constructors, effects: __rec_upd_11843.effects, instances: __rec_upd_11843.instances, modules: __rec_upd_11843.modules, mutable_fields: __rec_upd_11843.mutable_fields, records: __rec_upd_11843.records, type_aliases: __rec_upd_11843.type_aliases, type_synonyms: __rec_upd_11843.type_synonyms, variants: __rec_upd_11843.variants});
  const type_env_11845 = _t11844;
  const __rec_upd_11847 = ctx;
  const _t11848 = ({constraint_tvars: __rec_upd_11847.constraint_tvars, current_eff: __rec_upd_11847.current_eff, current_module: __rec_upd_11847.current_module, inside_handler: __rec_upd_11847.inside_handler, loop_info: __rec_upd_11847.loop_info, mutable_vars: __rec_upd_11847.mutable_vars, return_type: __rec_upd_11847.return_type, return_used: __rec_upd_11847.return_used, type_env: type_env_11845, vars: new_vars_11841});
  const _t11846 = _t11848;
  const _t11842 = _t11846;
  const _t11831 = _t11842;
  const _t11829 = _t11831;
  return _t11829;
}
function Main$register_native_instance(ctx, global_names, class_name, tys, methods) {
  const dname_11849 = _call(Types$dict_name, [__dict_Show_string, class_name, tys]);
  const idx_11851 = Main$add_global(global_names, dname_11849);
  function _t11853(__p375) {
    let _t11855;
    const _t11854 = __p375;
    _t11856: {
      if (true) {
        const mname = _t11854[0];
        const ext_name = _t11854[1];
        const arity = _t11854[2];
        _t11855 = [mname, ext_name, arity];
        break _t11856;
      }
      _match_fail("line 15950");
    }
    return _t11855;
  }
  const dict_fields_11857 = List$map(_t11853, methods);
  Main$register_native_dict(idx_11851, dict_fields_11857);
  function _t11859(__p376, __p377) {
    let _t11861;
    const _t11860 = __p376;
    _t11862: {
      if (true) {
        const a = _t11860[0];
        let _t11864;
        const _t11863 = __p377;
        _t11865: {
          if (true) {
            const b = _t11863[0];
            _t11864 = String$compare(a, b);
            break _t11865;
          }
          _match_fail("line 15950");
        }
        _t11861 = _t11864;
        break _t11862;
      }
      _match_fail("line 15950");
    }
    return _t11861;
  }
  const sorted_11866 = List$sort(_t11859, methods);
  function _t11868(__p378) {
    let _t11870;
    const _t11869 = __p378;
    _t11871: {
      if (true) {
        const mname = _t11869[0];
        const ext_name = _t11869[1];
        const arity = _t11869[2];
        const midx_11872 = Main$add_global(global_names, ((dname_11849 + "$") + mname));
        const _t11873 = Main$register_native_ext(midx_11872, ext_name, arity);
        _t11870 = _t11873;
        break _t11871;
      }
      _match_fail("line 15950");
    }
    return _t11870;
  }
  List$iter(_t11868, sorted_11866);
  const inst_11874 = ({inst_class: class_name, inst_constraints: null, inst_dict_name: dname_11849, inst_tys: tys});
  const __rec_upd_11876 = ctx.type_env;
  const _t11877 = ({classes: __rec_upd_11876.classes, constructors: __rec_upd_11876.constructors, effects: __rec_upd_11876.effects, instances: ({_hd: inst_11874, _tl: ctx.type_env.instances}), modules: __rec_upd_11876.modules, mutable_fields: __rec_upd_11876.mutable_fields, records: __rec_upd_11876.records, type_aliases: __rec_upd_11876.type_aliases, type_synonyms: __rec_upd_11876.type_synonyms, variants: __rec_upd_11876.variants});
  const type_env_11878 = _t11877;
  const __rec_upd_11880 = ctx;
  const _t11881 = ({constraint_tvars: __rec_upd_11880.constraint_tvars, current_eff: __rec_upd_11880.current_eff, current_module: __rec_upd_11880.current_module, inside_handler: __rec_upd_11880.inside_handler, loop_info: __rec_upd_11880.loop_info, mutable_vars: __rec_upd_11880.mutable_vars, return_type: __rec_upd_11880.return_type, return_used: __rec_upd_11880.return_used, type_env: type_env_11878, vars: __rec_upd_11880.vars});
  const _t11879 = _t11881;
  const _t11875 = _t11879;
  const _t11867 = _t11875;
  const _t11858 = _t11867;
  const _t11852 = _t11858;
  const _t11850 = _t11852;
  return _t11850;
}
let Main$js_capture_mode = false;
let Main$captured_typed_setups = null;
function Main$compile_setup(ctx, global_names, mutable_globals, source) {
  const tokens_11882 = Lexer$tokenize(source);
  const program_11884 = Parser$parse_program(tokens_11882);
  let _t11887;
  const _t11886 = Typechecker$check_program_in_ctx(ctx, program_11884);
  _t11888: {
    if (true) {
      const ctx2 = _t11886[0];
      const typed_program = _t11886[1];
      const typed_program2_11889 = Typechecker$transform_constraints(ctx2, typed_program);
      let _t11891;
      if (Main$js_capture_mode) {
        (Main$captured_typed_setups = List$concat(Main$captured_typed_setups, ({_hd: [ctx2.type_env, typed_program2_11889], _tl: null})), undefined);
        _t11891 = [ctx2, ({arity: 0, code: Array$of_list(null), constants: Array$of_list(null), line_table: Array$of_list(null), name: "", num_locals: 0})];
      } else {
        const compiled_11892 = Compiler$compile_program_with_globals(ctx2.type_env, global_names, mutable_globals, typed_program2_11889);
        const _t11893 = [ctx2, compiled_11892.main];
        _t11891 = _t11893;
      }
      const _t11890 = _t11891;
      _t11887 = _t11890;
      break _t11888;
    }
    _match_fail("line 15950");
  }
  const _t11885 = _t11887;
  const _t11883 = _t11885;
  return _t11883;
}
function Main$arr(a, b) {
  return ({_tag: 7, _name: "TArrow", _val: [a, ({_tag: 1, _name: "EffEmpty"}), b]});
}
function Main$arr2(a, b, c) {
  return Main$arr(a, Main$arr(b, c));
}
function Main$arr3(a, b, c, d) {
  return Main$arr(a, Main$arr(b, Main$arr(c, d)));
}
function Main$setup_builtins(_) {
  const global_names_11894 = Dynarray$create(256, "");
  const mutable_globals_11896 = Hashtbl$create(8);
  let stdlib_pub_vars_11898 = null;
  const int2_11900 = Main$arr2(({_tag: 0, _name: "TInt"}), ({_tag: 0, _name: "TInt"}), ({_tag: 0, _name: "TInt"}));
  const bool2_11902 = Main$arr2(({_tag: 2, _name: "TBool"}), ({_tag: 2, _name: "TBool"}), ({_tag: 2, _name: "TBool"}));
  let ctx_11904 = Typechecker$empty_ctx;
  let _t11907;
  const _t11906 = Main$register_builtin(ctx_11904, global_names_11894, "mod", int2_11900, 0, 2);
  _t11908: {
    if (true) {
      const sch = _t11906[0];
      const ctx2 = _t11906[1];
      (ctx_11904 = ctx2, undefined);
      (stdlib_pub_vars_11898 = ({_hd: ["mod", sch], _tl: stdlib_pub_vars_11898}), undefined);
      let _t11910;
      const _t11909 = Main$register_builtin(ctx_11904, global_names_11894, "print", Main$arr(({_tag: 17, _name: "TGen", _val: 0}), ({_tag: 6, _name: "TUnit"})), 1, 1);
      _t11911: {
        if (true) {
          const sch = _t11909[0];
          const ctx2 = _t11909[1];
          (ctx_11904 = ctx2, undefined);
          (stdlib_pub_vars_11898 = ({_hd: ["print", sch], _tl: stdlib_pub_vars_11898}), undefined);
          let _t11913;
          const _t11912 = Main$register_builtin(ctx_11904, global_names_11894, "failwith", Main$arr(({_tag: 3, _name: "TString"}), ({_tag: 17, _name: "TGen", _val: 0})), 1, 1);
          _t11914: {
            if (true) {
              const sch = _t11912[0];
              const ctx2 = _t11912[1];
              (ctx_11904 = ctx2, undefined);
              (stdlib_pub_vars_11898 = ({_hd: ["failwith", sch], _tl: stdlib_pub_vars_11898}), undefined);
              let _t11916;
              const _t11915 = Main$register_builtin(ctx_11904, global_names_11894, "^", Main$arr2(({_tag: 3, _name: "TString"}), ({_tag: 3, _name: "TString"}), ({_tag: 3, _name: "TString"})), 0, 2);
              _t11917: {
                if (true) {
                  const sch = _t11915[0];
                  const ctx2 = _t11915[1];
                  (ctx_11904 = ctx2, undefined);
                  (stdlib_pub_vars_11898 = ({_hd: ["^", sch], _tl: stdlib_pub_vars_11898}), undefined);
                  let _t11919;
                  const _t11918 = Main$register_builtin(ctx_11904, global_names_11894, "&&", bool2_11902, 0, 2);
                  _t11920: {
                    if (true) {
                      const sch = _t11918[0];
                      const ctx2 = _t11918[1];
                      (ctx_11904 = ctx2, undefined);
                      (stdlib_pub_vars_11898 = ({_hd: ["&&", sch], _tl: stdlib_pub_vars_11898}), undefined);
                      let _t11922;
                      const _t11921 = Main$register_builtin(ctx_11904, global_names_11894, "||", bool2_11902, 0, 2);
                      _t11923: {
                        if (true) {
                          const sch = _t11921[0];
                          const ctx2 = _t11921[1];
                          (ctx_11904 = ctx2, undefined);
                          (stdlib_pub_vars_11898 = ({_hd: ["||", sch], _tl: stdlib_pub_vars_11898}), undefined);
                          let _t11925;
                          const _t11924 = Main$register_builtin(ctx_11904, global_names_11894, "not", Main$arr(({_tag: 2, _name: "TBool"}), ({_tag: 2, _name: "TBool"})), 0, 1);
                          _t11926: {
                            if (true) {
                              const sch = _t11924[0];
                              const ctx2 = _t11924[1];
                              (ctx_11904 = ctx2, undefined);
                              (stdlib_pub_vars_11898 = ({_hd: ["not", sch], _tl: stdlib_pub_vars_11898}), undefined);
                              let _t11928;
                              const _t11927 = Main$register_builtin(ctx_11904, global_names_11894, "phys_equal", Main$arr2(({_tag: 17, _name: "TGen", _val: 0}), ({_tag: 17, _name: "TGen", _val: 0}), ({_tag: 2, _name: "TBool"})), 1, 2);
                              _t11929: {
                                if (true) {
                                  const sch = _t11927[0];
                                  const ctx2 = _t11927[1];
                                  (ctx_11904 = ctx2, undefined);
                                  (stdlib_pub_vars_11898 = ({_hd: ["phys_equal", sch], _tl: stdlib_pub_vars_11898}), undefined);
                                  let _t11931;
                                  const _t11930 = Main$register_builtin(ctx_11904, global_names_11894, "float_of_int", Main$arr(({_tag: 0, _name: "TInt"}), ({_tag: 1, _name: "TFloat"})), 0, 1);
                                  _t11932: {
                                    if (true) {
                                      const sch = _t11930[0];
                                      const ctx2 = _t11930[1];
                                      (ctx_11904 = ctx2, undefined);
                                      (stdlib_pub_vars_11898 = ({_hd: ["float_of_int", sch], _tl: stdlib_pub_vars_11898}), undefined);
                                      let _t11934;
                                      const _t11933 = Main$register_builtin(ctx_11904, global_names_11894, "int_of_float", Main$arr(({_tag: 1, _name: "TFloat"}), ({_tag: 0, _name: "TInt"})), 0, 1);
                                      _t11935: {
                                        if (true) {
                                          const sch = _t11933[0];
                                          const ctx2 = _t11933[1];
                                          (ctx_11904 = ctx2, undefined);
                                          (stdlib_pub_vars_11898 = ({_hd: ["int_of_float", sch], _tl: stdlib_pub_vars_11898}), undefined);
                                          let _t11937;
                                          const _t11936 = Main$register_builtin(ctx_11904, global_names_11894, "string_of_int", Main$arr(({_tag: 0, _name: "TInt"}), ({_tag: 3, _name: "TString"})), 0, 1);
                                          _t11938: {
                                            if (true) {
                                              const sch = _t11936[0];
                                              const ctx2 = _t11936[1];
                                              (ctx_11904 = ctx2, undefined);
                                              (stdlib_pub_vars_11898 = ({_hd: ["string_of_int", sch], _tl: stdlib_pub_vars_11898}), undefined);
                                              let _t11940;
                                              const _t11939 = Main$register_builtin(ctx_11904, global_names_11894, "string_of_float", Main$arr(({_tag: 1, _name: "TFloat"}), ({_tag: 3, _name: "TString"})), 0, 1);
                                              _t11941: {
                                                if (true) {
                                                  const sch = _t11939[0];
                                                  const ctx2 = _t11939[1];
                                                  (ctx_11904 = ctx2, undefined);
                                                  (stdlib_pub_vars_11898 = ({_hd: ["string_of_float", sch], _tl: stdlib_pub_vars_11898}), undefined);
                                                  let _t11943;
                                                  const _t11942 = Main$register_builtin(ctx_11904, global_names_11894, "string_of_bool", Main$arr(({_tag: 2, _name: "TBool"}), ({_tag: 3, _name: "TString"})), 0, 1);
                                                  _t11944: {
                                                    if (true) {
                                                      const sch = _t11942[0];
                                                      const ctx2 = _t11942[1];
                                                      (ctx_11904 = ctx2, undefined);
                                                      (stdlib_pub_vars_11898 = ({_hd: ["string_of_bool", sch], _tl: stdlib_pub_vars_11898}), undefined);
                                                      let _t11946;
                                                      const _t11945 = Main$register_builtin(ctx_11904, global_names_11894, "__map_has", Main$arr2(({_tag: 13, _name: "TMap", _val: [({_tag: 17, _name: "TGen", _val: 0}), ({_tag: 17, _name: "TGen", _val: 1})]}), ({_tag: 17, _name: "TGen", _val: 0}), ({_tag: 2, _name: "TBool"})), 2, 2);
                                                      _t11947: {
                                                        if (true) {
                                                          const sch = _t11945[0];
                                                          const ctx2 = _t11945[1];
                                                          (ctx_11904 = ctx2, undefined);
                                                          (stdlib_pub_vars_11898 = ({_hd: ["__map_has", sch], _tl: stdlib_pub_vars_11898}), undefined);
                                                          let _t11949;
                                                          const _t11948 = Main$register_builtin(ctx_11904, global_names_11894, "__map_get", Main$arr2(({_tag: 13, _name: "TMap", _val: [({_tag: 17, _name: "TGen", _val: 0}), ({_tag: 17, _name: "TGen", _val: 1})]}), ({_tag: 17, _name: "TGen", _val: 0}), ({_tag: 17, _name: "TGen", _val: 1})), 2, 2);
                                                          _t11950: {
                                                            if (true) {
                                                              const sch = _t11948[0];
                                                              const ctx2 = _t11948[1];
                                                              (ctx_11904 = ctx2, undefined);
                                                              (stdlib_pub_vars_11898 = ({_hd: ["__map_get", sch], _tl: stdlib_pub_vars_11898}), undefined);
                                                              let _t11952;
                                                              const _t11951 = Main$register_builtin(ctx_11904, global_names_11894, "array_get", Main$arr2(({_tag: 14, _name: "TArray", _val: ({_tag: 17, _name: "TGen", _val: 0})}), ({_tag: 0, _name: "TInt"}), ({_tag: 17, _name: "TGen", _val: 0})), 1, 2);
                                                              _t11953: {
                                                                if (true) {
                                                                  const sch = _t11951[0];
                                                                  const ctx2 = _t11951[1];
                                                                  (ctx_11904 = ctx2, undefined);
                                                                  (stdlib_pub_vars_11898 = ({_hd: ["array_get", sch], _tl: stdlib_pub_vars_11898}), undefined);
                                                                  let _t11955;
                                                                  const _t11954 = Main$register_builtin(ctx_11904, global_names_11894, "array_length", Main$arr(({_tag: 14, _name: "TArray", _val: ({_tag: 17, _name: "TGen", _val: 0})}), ({_tag: 0, _name: "TInt"})), 1, 1);
                                                                  _t11956: {
                                                                    if (true) {
                                                                      const sch = _t11954[0];
                                                                      const ctx2 = _t11954[1];
                                                                      (ctx_11904 = ctx2, undefined);
                                                                      (stdlib_pub_vars_11898 = ({_hd: ["array_length", sch], _tl: stdlib_pub_vars_11898}), undefined);
                                                                      let _t11958;
                                                                      const _t11957 = Main$register_builtin(ctx_11904, global_names_11894, "__byte_to_int", Main$arr(({_tag: 4, _name: "TByte"}), ({_tag: 0, _name: "TInt"})), 0, 1);
                                                                      _t11959: {
                                                                        if (true) {
                                                                          const sch = _t11957[0];
                                                                          const ctx2 = _t11957[1];
                                                                          (ctx_11904 = ctx2, undefined);
                                                                          (stdlib_pub_vars_11898 = ({_hd: ["__byte_to_int", sch], _tl: stdlib_pub_vars_11898}), undefined);
                                                                          let _t11961;
                                                                          const _t11960 = Main$register_builtin(ctx_11904, global_names_11894, "__byte_of_int", Main$arr(({_tag: 0, _name: "TInt"}), ({_tag: 4, _name: "TByte"})), 0, 1);
                                                                          _t11962: {
                                                                            if (true) {
                                                                              const sch = _t11960[0];
                                                                              const ctx2 = _t11960[1];
                                                                              (ctx_11904 = ctx2, undefined);
                                                                              (stdlib_pub_vars_11898 = ({_hd: ["__byte_of_int", sch], _tl: stdlib_pub_vars_11898}), undefined);
                                                                              let _t11964;
                                                                              const _t11963 = Main$register_builtin(ctx_11904, global_names_11894, "__byte_to_string", Main$arr(({_tag: 4, _name: "TByte"}), ({_tag: 3, _name: "TString"})), 0, 1);
                                                                              _t11965: {
                                                                                if (true) {
                                                                                  const sch = _t11963[0];
                                                                                  const ctx2 = _t11963[1];
                                                                                  (ctx_11904 = ctx2, undefined);
                                                                                  (stdlib_pub_vars_11898 = ({_hd: ["__byte_to_string", sch], _tl: stdlib_pub_vars_11898}), undefined);
                                                                                  let _t11967;
                                                                                  const _t11966 = Main$register_builtin(ctx_11904, global_names_11894, "__rune_to_int", Main$arr(({_tag: 5, _name: "TRune"}), ({_tag: 0, _name: "TInt"})), 0, 1);
                                                                                  _t11968: {
                                                                                    if (true) {
                                                                                      const sch = _t11966[0];
                                                                                      const ctx2 = _t11966[1];
                                                                                      (ctx_11904 = ctx2, undefined);
                                                                                      (stdlib_pub_vars_11898 = ({_hd: ["__rune_to_int", sch], _tl: stdlib_pub_vars_11898}), undefined);
                                                                                      let _t11970;
                                                                                      const _t11969 = Main$register_builtin(ctx_11904, global_names_11894, "__rune_of_int", Main$arr(({_tag: 0, _name: "TInt"}), ({_tag: 5, _name: "TRune"})), 0, 1);
                                                                                      _t11971: {
                                                                                        if (true) {
                                                                                          const sch = _t11969[0];
                                                                                          const ctx2 = _t11969[1];
                                                                                          (ctx_11904 = ctx2, undefined);
                                                                                          (stdlib_pub_vars_11898 = ({_hd: ["__rune_of_int", sch], _tl: stdlib_pub_vars_11898}), undefined);
                                                                                          let _t11973;
                                                                                          const _t11972 = Main$register_builtin(ctx_11904, global_names_11894, "__rune_to_string", Main$arr(({_tag: 5, _name: "TRune"}), ({_tag: 3, _name: "TString"})), 0, 1);
                                                                                          _t11974: {
                                                                                            if (true) {
                                                                                              const sch = _t11972[0];
                                                                                              const ctx2 = _t11972[1];
                                                                                              (ctx_11904 = ctx2, undefined);
                                                                                              (stdlib_pub_vars_11898 = ({_hd: ["__rune_to_string", sch], _tl: stdlib_pub_vars_11898}), undefined);
                                                                                              let _t11976;
                                                                                              const _t11975 = Main$register_builtin(ctx_11904, global_names_11894, "__math_pow", Main$arr2(({_tag: 1, _name: "TFloat"}), ({_tag: 1, _name: "TFloat"}), ({_tag: 1, _name: "TFloat"})), 0, 2);
                                                                                              _t11977: {
                                                                                                if (true) {
                                                                                                  const sch = _t11975[0];
                                                                                                  const ctx2 = _t11975[1];
                                                                                                  (ctx_11904 = ctx2, undefined);
                                                                                                  (stdlib_pub_vars_11898 = ({_hd: ["__math_pow", sch], _tl: stdlib_pub_vars_11898}), undefined);
                                                                                                  let _t11979;
                                                                                                  const _t11978 = Main$register_builtin(ctx_11904, global_names_11894, "__math_sqrt", Main$arr(({_tag: 1, _name: "TFloat"}), ({_tag: 1, _name: "TFloat"})), 0, 1);
                                                                                                  _t11980: {
                                                                                                    if (true) {
                                                                                                      const sch = _t11978[0];
                                                                                                      const ctx2 = _t11978[1];
                                                                                                      (ctx_11904 = ctx2, undefined);
                                                                                                      (stdlib_pub_vars_11898 = ({_hd: ["__math_sqrt", sch], _tl: stdlib_pub_vars_11898}), undefined);
                                                                                                      let _t11982;
                                                                                                      const _t11981 = Main$register_builtin(ctx_11904, global_names_11894, "__math_floor", Main$arr(({_tag: 1, _name: "TFloat"}), ({_tag: 0, _name: "TInt"})), 0, 1);
                                                                                                      _t11983: {
                                                                                                        if (true) {
                                                                                                          const sch = _t11981[0];
                                                                                                          const ctx2 = _t11981[1];
                                                                                                          (ctx_11904 = ctx2, undefined);
                                                                                                          (stdlib_pub_vars_11898 = ({_hd: ["__math_floor", sch], _tl: stdlib_pub_vars_11898}), undefined);
                                                                                                          let _t11985;
                                                                                                          const _t11984 = Main$register_builtin(ctx_11904, global_names_11894, "__math_ceil", Main$arr(({_tag: 1, _name: "TFloat"}), ({_tag: 0, _name: "TInt"})), 0, 1);
                                                                                                          _t11986: {
                                                                                                            if (true) {
                                                                                                              const sch = _t11984[0];
                                                                                                              const ctx2 = _t11984[1];
                                                                                                              (ctx_11904 = ctx2, undefined);
                                                                                                              (stdlib_pub_vars_11898 = ({_hd: ["__math_ceil", sch], _tl: stdlib_pub_vars_11898}), undefined);
                                                                                                              let _t11988;
                                                                                                              const _t11987 = Main$register_builtin(ctx_11904, global_names_11894, "__math_round", Main$arr(({_tag: 1, _name: "TFloat"}), ({_tag: 0, _name: "TInt"})), 0, 1);
                                                                                                              _t11989: {
                                                                                                                if (true) {
                                                                                                                  const sch = _t11987[0];
                                                                                                                  const ctx2 = _t11987[1];
                                                                                                                  (ctx_11904 = ctx2, undefined);
                                                                                                                  (stdlib_pub_vars_11898 = ({_hd: ["__math_round", sch], _tl: stdlib_pub_vars_11898}), undefined);
                                                                                                                  let _t11991;
                                                                                                                  const _t11990 = Main$register_builtin(ctx_11904, global_names_11894, "__fmt_float", Main$arr2(({_tag: 0, _name: "TInt"}), ({_tag: 1, _name: "TFloat"}), ({_tag: 3, _name: "TString"})), 0, 2);
                                                                                                                  _t11992: {
                                                                                                                    if (true) {
                                                                                                                      const sch = _t11990[0];
                                                                                                                      const ctx2 = _t11990[1];
                                                                                                                      (ctx_11904 = ctx2, undefined);
                                                                                                                      (stdlib_pub_vars_11898 = ({_hd: ["__fmt_float", sch], _tl: stdlib_pub_vars_11898}), undefined);
                                                                                                                      let _t11994;
                                                                                                                      const _t11993 = Main$register_builtin(ctx_11904, global_names_11894, "__fmt_hex", Main$arr(({_tag: 0, _name: "TInt"}), ({_tag: 3, _name: "TString"})), 0, 1);
                                                                                                                      _t11995: {
                                                                                                                        if (true) {
                                                                                                                          const sch = _t11993[0];
                                                                                                                          const ctx2 = _t11993[1];
                                                                                                                          (ctx_11904 = ctx2, undefined);
                                                                                                                          (stdlib_pub_vars_11898 = ({_hd: ["__fmt_hex", sch], _tl: stdlib_pub_vars_11898}), undefined);
                                                                                                                          let _t11997;
                                                                                                                          const _t11996 = Main$register_builtin(ctx_11904, global_names_11894, "__fmt_hex_upper", Main$arr(({_tag: 0, _name: "TInt"}), ({_tag: 3, _name: "TString"})), 0, 1);
                                                                                                                          _t11998: {
                                                                                                                            if (true) {
                                                                                                                              const sch = _t11996[0];
                                                                                                                              const ctx2 = _t11996[1];
                                                                                                                              (ctx_11904 = ctx2, undefined);
                                                                                                                              (stdlib_pub_vars_11898 = ({_hd: ["__fmt_hex_upper", sch], _tl: stdlib_pub_vars_11898}), undefined);
                                                                                                                              let _t12000;
                                                                                                                              const _t11999 = Main$register_builtin(ctx_11904, global_names_11894, "__fmt_oct", Main$arr(({_tag: 0, _name: "TInt"}), ({_tag: 3, _name: "TString"})), 0, 1);
                                                                                                                              _t12001: {
                                                                                                                                if (true) {
                                                                                                                                  const sch = _t11999[0];
                                                                                                                                  const ctx2 = _t11999[1];
                                                                                                                                  (ctx_11904 = ctx2, undefined);
                                                                                                                                  (stdlib_pub_vars_11898 = ({_hd: ["__fmt_oct", sch], _tl: stdlib_pub_vars_11898}), undefined);
                                                                                                                                  let _t12003;
                                                                                                                                  const _t12002 = Main$register_builtin(ctx_11904, global_names_11894, "__fmt_bin", Main$arr(({_tag: 0, _name: "TInt"}), ({_tag: 3, _name: "TString"})), 0, 1);
                                                                                                                                  _t12004: {
                                                                                                                                    if (true) {
                                                                                                                                      const sch = _t12002[0];
                                                                                                                                      const ctx2 = _t12002[1];
                                                                                                                                      (ctx_11904 = ctx2, undefined);
                                                                                                                                      (stdlib_pub_vars_11898 = ({_hd: ["__fmt_bin", sch], _tl: stdlib_pub_vars_11898}), undefined);
                                                                                                                                      let _t12006;
                                                                                                                                      const _t12005 = Main$register_builtin(ctx_11904, global_names_11894, "__fmt_zero_pad", Main$arr2(({_tag: 0, _name: "TInt"}), ({_tag: 3, _name: "TString"}), ({_tag: 3, _name: "TString"})), 0, 2);
                                                                                                                                      _t12007: {
                                                                                                                                        if (true) {
                                                                                                                                          const sch = _t12005[0];
                                                                                                                                          const ctx2 = _t12005[1];
                                                                                                                                          (ctx_11904 = ctx2, undefined);
                                                                                                                                          (stdlib_pub_vars_11898 = ({_hd: ["__fmt_zero_pad", sch], _tl: stdlib_pub_vars_11898}), undefined);
                                                                                                                                          let _t12009;
                                                                                                                                          const _t12008 = Main$register_builtin(ctx_11904, global_names_11894, "__fmt_pad_left", Main$arr2(({_tag: 0, _name: "TInt"}), ({_tag: 3, _name: "TString"}), ({_tag: 3, _name: "TString"})), 0, 2);
                                                                                                                                          _t12010: {
                                                                                                                                            if (true) {
                                                                                                                                              const sch = _t12008[0];
                                                                                                                                              const ctx2 = _t12008[1];
                                                                                                                                              (ctx_11904 = ctx2, undefined);
                                                                                                                                              (stdlib_pub_vars_11898 = ({_hd: ["__fmt_pad_left", sch], _tl: stdlib_pub_vars_11898}), undefined);
                                                                                                                                              let _t12012;
                                                                                                                                              const _t12011 = Main$register_builtin(ctx_11904, global_names_11894, "__fmt_pad_right", Main$arr2(({_tag: 0, _name: "TInt"}), ({_tag: 3, _name: "TString"}), ({_tag: 3, _name: "TString"})), 0, 2);
                                                                                                                                              _t12013: {
                                                                                                                                                if (true) {
                                                                                                                                                  const sch = _t12011[0];
                                                                                                                                                  const ctx2 = _t12011[1];
                                                                                                                                                  (ctx_11904 = ctx2, undefined);
                                                                                                                                                  (stdlib_pub_vars_11898 = ({_hd: ["__fmt_pad_right", sch], _tl: stdlib_pub_vars_11898}), undefined);
                                                                                                                                                  let _t12015;
                                                                                                                                                  const _t12014 = Main$register_builtin(ctx_11904, global_names_11894, "__show_value", Main$arr(({_tag: 17, _name: "TGen", _val: 0}), ({_tag: 3, _name: "TString"})), 1, 1);
                                                                                                                                                  _t12016: {
                                                                                                                                                    if (true) {
                                                                                                                                                      const sch = _t12014[0];
                                                                                                                                                      const ctx2 = _t12014[1];
                                                                                                                                                      (ctx_11904 = ctx2, undefined);
                                                                                                                                                      (stdlib_pub_vars_11898 = ({_hd: ["__show_value", sch], _tl: stdlib_pub_vars_11898}), undefined);
                                                                                                                                                      const copy_ty_12017 = Main$arr(({_tag: 17, _name: "TGen", _val: 0}), ({_tag: 17, _name: "TGen", _val: 0}));
                                                                                                                                                      const copy_scheme_12019 = ({body: copy_ty_12017, constraints: null, equant: 0, pvquant: 0, quant: 1, record_evidences: null, rquant: 0});
                                                                                                                                                      const cidx_12021 = Main$add_global(global_names_11894, "copy_continuation");
                                                                                                                                                      Main$register_native_ext(cidx_12021, "copy_continuation", 1);
                                                                                                                                                      const csidx_12023 = Main$add_global(global_names_11894, "Stdlib.copy_continuation");
                                                                                                                                                      Main$register_native_ext(csidx_12023, "copy_continuation", 1);
                                                                                                                                                      (stdlib_pub_vars_11898 = ({_hd: ["copy_continuation", copy_scheme_12019], _tl: stdlib_pub_vars_11898}), undefined);
                                                                                                                                                      const __rec_upd_12025 = ctx_11904;
                                                                                                                                                      const _t12026 = ({constraint_tvars: __rec_upd_12025.constraint_tvars, current_eff: __rec_upd_12025.current_eff, current_module: __rec_upd_12025.current_module, inside_handler: __rec_upd_12025.inside_handler, loop_info: __rec_upd_12025.loop_info, mutable_vars: __rec_upd_12025.mutable_vars, return_type: __rec_upd_12025.return_type, return_used: __rec_upd_12025.return_used, type_env: __rec_upd_12025.type_env, vars: ({_hd: ["Stdlib.copy_continuation", copy_scheme_12019], _tl: ({_hd: ["copy_continuation", copy_scheme_12019], _tl: ctx_11904.vars})})});
                                                                                                                                                      (ctx_11904 = _t12026, undefined);
                                                                                                                                                      const _t12024 = [ctx_11904, global_names_11894, mutable_globals_11896, stdlib_pub_vars_11898];
                                                                                                                                                      const _t12022 = _t12024;
                                                                                                                                                      const _t12020 = _t12022;
                                                                                                                                                      const _t12018 = _t12020;
                                                                                                                                                      _t12015 = _t12018;
                                                                                                                                                      break _t12016;
                                                                                                                                                    }
                                                                                                                                                    _match_fail("line 15950");
                                                                                                                                                  }
                                                                                                                                                  _t12012 = _t12015;
                                                                                                                                                  break _t12013;
                                                                                                                                                }
                                                                                                                                                _match_fail("line 15950");
                                                                                                                                              }
                                                                                                                                              _t12009 = _t12012;
                                                                                                                                              break _t12010;
                                                                                                                                            }
                                                                                                                                            _match_fail("line 15950");
                                                                                                                                          }
                                                                                                                                          _t12006 = _t12009;
                                                                                                                                          break _t12007;
                                                                                                                                        }
                                                                                                                                        _match_fail("line 15950");
                                                                                                                                      }
                                                                                                                                      _t12003 = _t12006;
                                                                                                                                      break _t12004;
                                                                                                                                    }
                                                                                                                                    _match_fail("line 15950");
                                                                                                                                  }
                                                                                                                                  _t12000 = _t12003;
                                                                                                                                  break _t12001;
                                                                                                                                }
                                                                                                                                _match_fail("line 15950");
                                                                                                                              }
                                                                                                                              _t11997 = _t12000;
                                                                                                                              break _t11998;
                                                                                                                            }
                                                                                                                            _match_fail("line 15950");
                                                                                                                          }
                                                                                                                          _t11994 = _t11997;
                                                                                                                          break _t11995;
                                                                                                                        }
                                                                                                                        _match_fail("line 15950");
                                                                                                                      }
                                                                                                                      _t11991 = _t11994;
                                                                                                                      break _t11992;
                                                                                                                    }
                                                                                                                    _match_fail("line 15950");
                                                                                                                  }
                                                                                                                  _t11988 = _t11991;
                                                                                                                  break _t11989;
                                                                                                                }
                                                                                                                _match_fail("line 15950");
                                                                                                              }
                                                                                                              _t11985 = _t11988;
                                                                                                              break _t11986;
                                                                                                            }
                                                                                                            _match_fail("line 15950");
                                                                                                          }
                                                                                                          _t11982 = _t11985;
                                                                                                          break _t11983;
                                                                                                        }
                                                                                                        _match_fail("line 15950");
                                                                                                      }
                                                                                                      _t11979 = _t11982;
                                                                                                      break _t11980;
                                                                                                    }
                                                                                                    _match_fail("line 15950");
                                                                                                  }
                                                                                                  _t11976 = _t11979;
                                                                                                  break _t11977;
                                                                                                }
                                                                                                _match_fail("line 15950");
                                                                                              }
                                                                                              _t11973 = _t11976;
                                                                                              break _t11974;
                                                                                            }
                                                                                            _match_fail("line 15950");
                                                                                          }
                                                                                          _t11970 = _t11973;
                                                                                          break _t11971;
                                                                                        }
                                                                                        _match_fail("line 15950");
                                                                                      }
                                                                                      _t11967 = _t11970;
                                                                                      break _t11968;
                                                                                    }
                                                                                    _match_fail("line 15950");
                                                                                  }
                                                                                  _t11964 = _t11967;
                                                                                  break _t11965;
                                                                                }
                                                                                _match_fail("line 15950");
                                                                              }
                                                                              _t11961 = _t11964;
                                                                              break _t11962;
                                                                            }
                                                                            _match_fail("line 15950");
                                                                          }
                                                                          _t11958 = _t11961;
                                                                          break _t11959;
                                                                        }
                                                                        _match_fail("line 15950");
                                                                      }
                                                                      _t11955 = _t11958;
                                                                      break _t11956;
                                                                    }
                                                                    _match_fail("line 15950");
                                                                  }
                                                                  _t11952 = _t11955;
                                                                  break _t11953;
                                                                }
                                                                _match_fail("line 15950");
                                                              }
                                                              _t11949 = _t11952;
                                                              break _t11950;
                                                            }
                                                            _match_fail("line 15950");
                                                          }
                                                          _t11946 = _t11949;
                                                          break _t11947;
                                                        }
                                                        _match_fail("line 15950");
                                                      }
                                                      _t11943 = _t11946;
                                                      break _t11944;
                                                    }
                                                    _match_fail("line 15950");
                                                  }
                                                  _t11940 = _t11943;
                                                  break _t11941;
                                                }
                                                _match_fail("line 15950");
                                              }
                                              _t11937 = _t11940;
                                              break _t11938;
                                            }
                                            _match_fail("line 15950");
                                          }
                                          _t11934 = _t11937;
                                          break _t11935;
                                        }
                                        _match_fail("line 15950");
                                      }
                                      _t11931 = _t11934;
                                      break _t11932;
                                    }
                                    _match_fail("line 15950");
                                  }
                                  _t11928 = _t11931;
                                  break _t11929;
                                }
                                _match_fail("line 15950");
                              }
                              _t11925 = _t11928;
                              break _t11926;
                            }
                            _match_fail("line 15950");
                          }
                          _t11922 = _t11925;
                          break _t11923;
                        }
                        _match_fail("line 15950");
                      }
                      _t11919 = _t11922;
                      break _t11920;
                    }
                    _match_fail("line 15950");
                  }
                  _t11916 = _t11919;
                  break _t11917;
                }
                _match_fail("line 15950");
              }
              _t11913 = _t11916;
              break _t11914;
            }
            _match_fail("line 15950");
          }
          _t11910 = _t11913;
          break _t11911;
        }
        _match_fail("line 15950");
      }
      _t11907 = _t11910;
      break _t11908;
    }
    _match_fail("line 15950");
  }
  const _t11905 = _t11907;
  const _t11903 = _t11905;
  const _t11901 = _t11903;
  const _t11899 = _t11901;
  const _t11897 = _t11899;
  const _t11895 = _t11897;
  return _t11895;
}
function Main$setup_option_type(ctx) {
  const __rec_upd_12027 = ctx.type_env;
  const _t12028 = ({classes: __rec_upd_12027.classes, constructors: ({_hd: ["None", ({ctor_arg_ty: ({_tag: 0, _name: "None"}), ctor_existentials: 0, ctor_num_params: 1, ctor_return_ty_params: ({_tag: 0, _name: "None"}), ctor_type_name: "option"})], _tl: ({_hd: ["Some", ({ctor_arg_ty: ({_tag: 1, _name: "Some", _val: ({_tag: 17, _name: "TGen", _val: 0})}), ctor_existentials: 0, ctor_num_params: 1, ctor_return_ty_params: ({_tag: 0, _name: "None"}), ctor_type_name: "option"})], _tl: ctx.type_env.constructors})}), effects: __rec_upd_12027.effects, instances: __rec_upd_12027.instances, modules: __rec_upd_12027.modules, mutable_fields: __rec_upd_12027.mutable_fields, records: __rec_upd_12027.records, type_aliases: __rec_upd_12027.type_aliases, type_synonyms: __rec_upd_12027.type_synonyms, variants: ({_hd: ["option", 1, ({_hd: ["None", ({_tag: 0, _name: "None"})], _tl: ({_hd: ["Some", ({_tag: 1, _name: "Some", _val: ({_tag: 17, _name: "TGen", _val: 0})})], _tl: null})}), false], _tl: ctx.type_env.variants})});
  const type_env_12029 = _t12028;
  const __rec_upd_12031 = ctx;
  const _t12032 = ({constraint_tvars: __rec_upd_12031.constraint_tvars, current_eff: __rec_upd_12031.current_eff, current_module: __rec_upd_12031.current_module, inside_handler: __rec_upd_12031.inside_handler, loop_info: __rec_upd_12031.loop_info, mutable_vars: __rec_upd_12031.mutable_vars, return_type: __rec_upd_12031.return_type, return_used: __rec_upd_12031.return_used, type_env: type_env_12029, vars: __rec_upd_12031.vars});
  const _t12030 = _t12032;
  return _t12030;
}
function Main$setup_classes(ctx, global_names, mutable_globals, stdlib_pub_vars) {
  const a2a_12033 = Main$arr2(({_tag: 17, _name: "TGen", _val: 0}), ({_tag: 17, _name: "TGen", _val: 0}), ({_tag: 17, _name: "TGen", _val: 0}));
  const a_a_12035 = Main$arr(({_tag: 17, _name: "TGen", _val: 0}), ({_tag: 17, _name: "TGen", _val: 0}));
  const a2bool_12037 = Main$arr2(({_tag: 17, _name: "TGen", _val: 0}), ({_tag: 17, _name: "TGen", _val: 0}), ({_tag: 2, _name: "TBool"}));
  let ctx_12039 = ctx;
  let setup_protos_12041 = null;
  function _t12043(name) {
    let _t12045;
    const _t12044 = Main$compile_setup(ctx_12039, global_names, mutable_globals, IO$read_file((("stdlib/" + name) + ".mml")));
    _t12046: {
      if (true) {
        const ctx2 = _t12044[0];
        const proto = _t12044[1];
        (ctx_12039 = ctx2, undefined);
        _t12045 = (setup_protos_12041 = ({_hd: proto, _tl: setup_protos_12041}), undefined);
        break _t12046;
      }
      _match_fail("line 15950");
    }
    return _t12045;
  }
  const load_12047 = _t12043;
  function _t12049(class_name, fundeps) {
    const __rec_upd_12050 = ctx_12039;
    const __rec_upd_12052 = ctx_12039.type_env;
    function _t12054(cd) {
      let _t12055;
      if ((cd.class_name === class_name)) {
        const __rec_upd_12056 = cd;
        const _t12057 = ({class_fundeps: fundeps, class_methods: __rec_upd_12056.class_methods, class_name: __rec_upd_12056.class_name, class_params: __rec_upd_12056.class_params});
        _t12055 = _t12057;
      } else {
        _t12055 = cd;
      }
      return _t12055;
    }
    const _t12053 = ({classes: List$map(_t12054, ctx_12039.type_env.classes), constructors: __rec_upd_12052.constructors, effects: __rec_upd_12052.effects, instances: __rec_upd_12052.instances, modules: __rec_upd_12052.modules, mutable_fields: __rec_upd_12052.mutable_fields, records: __rec_upd_12052.records, type_aliases: __rec_upd_12052.type_aliases, type_synonyms: __rec_upd_12052.type_synonyms, variants: __rec_upd_12052.variants});
    const _t12051 = ({constraint_tvars: __rec_upd_12050.constraint_tvars, current_eff: __rec_upd_12050.current_eff, current_module: __rec_upd_12050.current_module, inside_handler: __rec_upd_12050.inside_handler, loop_info: __rec_upd_12050.loop_info, mutable_vars: __rec_upd_12050.mutable_vars, return_type: __rec_upd_12050.return_type, return_used: __rec_upd_12050.return_used, type_env: _t12053, vars: __rec_upd_12050.vars});
    return (ctx_12039 = _t12051, undefined);
  }
  const set_fundeps_12058 = _t12049;
  (ctx_12039 = Main$register_class_in_ctx(ctx_12039, "Num", ({_hd: "a", _tl: null}), ({_hd: ["+", a2a_12033], _tl: ({_hd: ["-", a2a_12033], _tl: ({_hd: ["*", a2a_12033], _tl: ({_hd: ["/", a2a_12033], _tl: ({_hd: ["neg", a_a_12035], _tl: null})})})})})), undefined);
  (ctx_12039 = Main$register_native_instance(ctx_12039, global_names, "Num", ({_hd: ({_tag: 0, _name: "TInt"}), _tl: null}), ({_hd: ["+", "num_add_int", 2], _tl: ({_hd: ["-", "num_sub_int", 2], _tl: ({_hd: ["*", "num_mul_int", 2], _tl: ({_hd: ["/", "num_div_int", 2], _tl: ({_hd: ["neg", "num_neg_int", 1], _tl: null})})})})})), undefined);
  (ctx_12039 = Main$register_native_instance(ctx_12039, global_names, "Num", ({_hd: ({_tag: 1, _name: "TFloat"}), _tl: null}), ({_hd: ["+", "num_add_float", 2], _tl: ({_hd: ["-", "num_sub_float", 2], _tl: ({_hd: ["*", "num_mul_float", 2], _tl: ({_hd: ["/", "num_div_float", 2], _tl: ({_hd: ["neg", "num_neg_float", 1], _tl: null})})})})})), undefined);
  (ctx_12039 = Main$register_class_in_ctx(ctx_12039, "Eq", ({_hd: "a", _tl: null}), ({_hd: ["=", a2bool_12037], _tl: ({_hd: ["<>", a2bool_12037], _tl: null})})), undefined);
  (ctx_12039 = Main$register_native_instance(ctx_12039, global_names, "Eq", ({_hd: ({_tag: 0, _name: "TInt"}), _tl: null}), ({_hd: ["=", "eq_int", 2], _tl: ({_hd: ["<>", "neq_int", 2], _tl: null})})), undefined);
  (ctx_12039 = Main$register_native_instance(ctx_12039, global_names, "Eq", ({_hd: ({_tag: 1, _name: "TFloat"}), _tl: null}), ({_hd: ["=", "eq_float", 2], _tl: ({_hd: ["<>", "neq_float", 2], _tl: null})})), undefined);
  (ctx_12039 = Main$register_native_instance(ctx_12039, global_names, "Eq", ({_hd: ({_tag: 3, _name: "TString"}), _tl: null}), ({_hd: ["=", "eq_string", 2], _tl: ({_hd: ["<>", "neq_string", 2], _tl: null})})), undefined);
  (ctx_12039 = Main$register_native_instance(ctx_12039, global_names, "Eq", ({_hd: ({_tag: 2, _name: "TBool"}), _tl: null}), ({_hd: ["=", "eq_bool", 2], _tl: ({_hd: ["<>", "neq_bool", 2], _tl: null})})), undefined);
  (ctx_12039 = Main$register_native_instance(ctx_12039, global_names, "Eq", ({_hd: ({_tag: 4, _name: "TByte"}), _tl: null}), ({_hd: ["=", "eq_byte", 2], _tl: ({_hd: ["<>", "neq_byte", 2], _tl: null})})), undefined);
  (ctx_12039 = Main$register_native_instance(ctx_12039, global_names, "Eq", ({_hd: ({_tag: 5, _name: "TRune"}), _tl: null}), ({_hd: ["=", "eq_rune", 2], _tl: ({_hd: ["<>", "neq_rune", 2], _tl: null})})), undefined);
  (ctx_12039 = Main$register_class_in_ctx(ctx_12039, "Ord", ({_hd: "a", _tl: null}), ({_hd: ["<", a2bool_12037], _tl: ({_hd: [">", a2bool_12037], _tl: ({_hd: ["<=", a2bool_12037], _tl: ({_hd: [">=", a2bool_12037], _tl: null})})})})), undefined);
  (ctx_12039 = Main$register_native_instance(ctx_12039, global_names, "Ord", ({_hd: ({_tag: 0, _name: "TInt"}), _tl: null}), ({_hd: ["<", "lt_int", 2], _tl: ({_hd: [">", "gt_int", 2], _tl: ({_hd: ["<=", "le_int", 2], _tl: ({_hd: [">=", "ge_int", 2], _tl: null})})})})), undefined);
  (ctx_12039 = Main$register_native_instance(ctx_12039, global_names, "Ord", ({_hd: ({_tag: 1, _name: "TFloat"}), _tl: null}), ({_hd: ["<", "lt_float", 2], _tl: ({_hd: [">", "gt_float", 2], _tl: ({_hd: ["<=", "le_float", 2], _tl: ({_hd: [">=", "ge_float", 2], _tl: null})})})})), undefined);
  (ctx_12039 = Main$register_native_instance(ctx_12039, global_names, "Ord", ({_hd: ({_tag: 3, _name: "TString"}), _tl: null}), ({_hd: ["<", "lt_string", 2], _tl: ({_hd: [">", "gt_string", 2], _tl: ({_hd: ["<=", "le_string", 2], _tl: ({_hd: [">=", "ge_string", 2], _tl: null})})})})), undefined);
  (ctx_12039 = Main$register_native_instance(ctx_12039, global_names, "Ord", ({_hd: ({_tag: 4, _name: "TByte"}), _tl: null}), ({_hd: ["<", "lt_byte", 2], _tl: ({_hd: [">", "gt_byte", 2], _tl: ({_hd: ["<=", "le_byte", 2], _tl: ({_hd: [">=", "ge_byte", 2], _tl: null})})})})), undefined);
  (ctx_12039 = Main$register_native_instance(ctx_12039, global_names, "Ord", ({_hd: ({_tag: 5, _name: "TRune"}), _tl: null}), ({_hd: ["<", "lt_rune", 2], _tl: ({_hd: [">", "gt_rune", 2], _tl: ({_hd: ["<=", "le_rune", 2], _tl: ({_hd: [">=", "ge_rune", 2], _tl: null})})})})), undefined);
  (ctx_12039 = Main$register_class_in_ctx(ctx_12039, "Bitwise", ({_hd: "a", _tl: null}), ({_hd: ["land", a2a_12033], _tl: ({_hd: ["lor", a2a_12033], _tl: ({_hd: ["lxor", a2a_12033], _tl: ({_hd: ["lsl", a2a_12033], _tl: ({_hd: ["lsr", a2a_12033], _tl: ({_hd: ["lnot", a_a_12035], _tl: null})})})})})})), undefined);
  (ctx_12039 = Main$register_native_instance(ctx_12039, global_names, "Bitwise", ({_hd: ({_tag: 0, _name: "TInt"}), _tl: null}), ({_hd: ["land", "band_int", 2], _tl: ({_hd: ["lor", "bor_int", 2], _tl: ({_hd: ["lxor", "bxor_int", 2], _tl: ({_hd: ["lsl", "bshl_int", 2], _tl: ({_hd: ["lsr", "bshr_int", 2], _tl: ({_hd: ["lnot", "bnot_int", 1], _tl: null})})})})})})), undefined);
  (ctx_12039 = Main$register_class_in_ctx(ctx_12039, "Show", ({_hd: "a", _tl: null}), ({_hd: ["show", Main$arr(({_tag: 17, _name: "TGen", _val: 0}), ({_tag: 3, _name: "TString"}))], _tl: null})), undefined);
  (ctx_12039 = Main$register_native_instance(ctx_12039, global_names, "Show", ({_hd: ({_tag: 0, _name: "TInt"}), _tl: null}), ({_hd: ["show", "show_int", 1], _tl: null})), undefined);
  (ctx_12039 = Main$register_native_instance(ctx_12039, global_names, "Show", ({_hd: ({_tag: 1, _name: "TFloat"}), _tl: null}), ({_hd: ["show", "show_float", 1], _tl: null})), undefined);
  (ctx_12039 = Main$register_native_instance(ctx_12039, global_names, "Show", ({_hd: ({_tag: 2, _name: "TBool"}), _tl: null}), ({_hd: ["show", "show_bool", 1], _tl: null})), undefined);
  (ctx_12039 = Main$register_native_instance(ctx_12039, global_names, "Show", ({_hd: ({_tag: 3, _name: "TString"}), _tl: null}), ({_hd: ["show", "show_string", 1], _tl: null})), undefined);
  (ctx_12039 = Main$register_native_instance(ctx_12039, global_names, "Show", ({_hd: ({_tag: 6, _name: "TUnit"}), _tl: null}), ({_hd: ["show", "show_unit", 1], _tl: null})), undefined);
  (ctx_12039 = Main$register_native_instance(ctx_12039, global_names, "Show", ({_hd: ({_tag: 4, _name: "TByte"}), _tl: null}), ({_hd: ["show", "show_byte", 1], _tl: null})), undefined);
  (ctx_12039 = Main$register_native_instance(ctx_12039, global_names, "Show", ({_hd: ({_tag: 5, _name: "TRune"}), _tl: null}), ({_hd: ["show", "show_rune", 1], _tl: null})), undefined);
  const fold_ty_12060 = Main$arr(Main$arr2(({_tag: 17, _name: "TGen", _val: 2}), ({_tag: 17, _name: "TGen", _val: 1}), ({_tag: 17, _name: "TGen", _val: 2})), Main$arr2(({_tag: 17, _name: "TGen", _val: 2}), ({_tag: 17, _name: "TGen", _val: 0}), ({_tag: 17, _name: "TGen", _val: 2})));
  (ctx_12039 = Main$register_class_in_ctx(ctx_12039, "Iter", ({_hd: "a", _tl: ({_hd: "b", _tl: null})}), ({_hd: ["fold", fold_ty_12060], _tl: null})), undefined);
  set_fundeps_12058("Iter", ({_hd: ({fd_from: ({_hd: 0, _tl: null}), fd_to: ({_hd: 1, _tl: null})}), _tl: null}));
  const option_v_12062 = ({_tag: 12, _name: "TVariant", _val: ["option", ({_hd: ({_tag: 17, _name: "TGen", _val: 2}), _tl: null})]});
  const kv_pair_12064 = ({_tag: 9, _name: "TTuple", _val: ({_hd: ({_tag: 17, _name: "TGen", _val: 1}), _tl: ({_hd: ({_tag: 17, _name: "TGen", _val: 2}), _tl: null})})});
  (ctx_12039 = Main$register_class_in_ctx(ctx_12039, "Map", ({_hd: "m", _tl: ({_hd: "k", _tl: ({_hd: "v", _tl: null})})}), ({_hd: ["of_list", Main$arr(({_tag: 10, _name: "TList", _val: kv_pair_12064}), ({_tag: 17, _name: "TGen", _val: 0}))], _tl: ({_hd: ["get", Main$arr2(({_tag: 17, _name: "TGen", _val: 1}), ({_tag: 17, _name: "TGen", _val: 0}), option_v_12062)], _tl: ({_hd: ["set", Main$arr3(({_tag: 17, _name: "TGen", _val: 1}), ({_tag: 17, _name: "TGen", _val: 2}), ({_tag: 17, _name: "TGen", _val: 0}), ({_tag: 17, _name: "TGen", _val: 0}))], _tl: ({_hd: ["has", Main$arr2(({_tag: 17, _name: "TGen", _val: 1}), ({_tag: 17, _name: "TGen", _val: 0}), ({_tag: 2, _name: "TBool"}))], _tl: ({_hd: ["remove", Main$arr2(({_tag: 17, _name: "TGen", _val: 1}), ({_tag: 17, _name: "TGen", _val: 0}), ({_tag: 17, _name: "TGen", _val: 0}))], _tl: ({_hd: ["size", Main$arr(({_tag: 17, _name: "TGen", _val: 0}), ({_tag: 0, _name: "TInt"}))], _tl: ({_hd: ["keys", Main$arr(({_tag: 17, _name: "TGen", _val: 0}), ({_tag: 10, _name: "TList", _val: ({_tag: 17, _name: "TGen", _val: 1})}))], _tl: ({_hd: ["values", Main$arr(({_tag: 17, _name: "TGen", _val: 0}), ({_tag: 10, _name: "TList", _val: ({_tag: 17, _name: "TGen", _val: 2})}))], _tl: ({_hd: ["to_list", Main$arr(({_tag: 17, _name: "TGen", _val: 0}), ({_tag: 10, _name: "TList", _val: kv_pair_12064}))], _tl: null})})})})})})})})})), undefined);
  set_fundeps_12058("Map", ({_hd: ({fd_from: ({_hd: 0, _tl: null}), fd_to: ({_hd: 1, _tl: ({_hd: 2, _tl: null})})}), _tl: null}));
  (ctx_12039 = Main$register_native_instance(ctx_12039, global_names, "Map", ({_hd: ({_tag: 13, _name: "TMap", _val: [({_tag: 17, _name: "TGen", _val: 0}), ({_tag: 17, _name: "TGen", _val: 1})]}), _tl: ({_hd: ({_tag: 17, _name: "TGen", _val: 0}), _tl: ({_hd: ({_tag: 17, _name: "TGen", _val: 1}), _tl: null})})}), ({_hd: ["of_list", "map_of_list", 1], _tl: ({_hd: ["get", "map_get", 2], _tl: ({_hd: ["set", "map_set", 3], _tl: ({_hd: ["has", "map_has", 2], _tl: ({_hd: ["remove", "map_remove", 2], _tl: ({_hd: ["size", "map_size", 1], _tl: ({_hd: ["keys", "map_keys", 1], _tl: ({_hd: ["values", "map_values", 1], _tl: ({_hd: ["to_list", "map_to_list", 1], _tl: null})})})})})})})})})), undefined);
  const at_ty_12066 = Main$arr(({_tag: 17, _name: "TGen", _val: 1}), Main$arr(({_tag: 17, _name: "TGen", _val: 0}), ({_tag: 17, _name: "TGen", _val: 2})));
  (ctx_12039 = Main$register_class_in_ctx(ctx_12039, "Index", ({_hd: "c", _tl: ({_hd: "k", _tl: ({_hd: "v", _tl: null})})}), ({_hd: ["at", at_ty_12066], _tl: null})), undefined);
  set_fundeps_12058("Index", ({_hd: ({fd_from: ({_hd: 0, _tl: null}), fd_to: ({_hd: 1, _tl: ({_hd: 2, _tl: null})})}), _tl: null}));
  (ctx_12039 = Main$register_native_instance(ctx_12039, global_names, "Index", ({_hd: ({_tag: 14, _name: "TArray", _val: ({_tag: 17, _name: "TGen", _val: 0})}), _tl: ({_hd: ({_tag: 0, _name: "TInt"}), _tl: ({_hd: ({_tag: 17, _name: "TGen", _val: 0}), _tl: null})})}), ({_hd: ["at", "index_at_array", 2], _tl: null})), undefined);
  (ctx_12039 = Main$register_native_instance(ctx_12039, global_names, "Index", ({_hd: ({_tag: 3, _name: "TString"}), _tl: ({_hd: ({_tag: 0, _name: "TInt"}), _tl: ({_hd: ({_tag: 4, _name: "TByte"}), _tl: null})})}), ({_hd: ["at", "index_at_string", 2], _tl: null})), undefined);
  (ctx_12039 = Main$register_native_instance(ctx_12039, global_names, "Index", ({_hd: ({_tag: 13, _name: "TMap", _val: [({_tag: 17, _name: "TGen", _val: 0}), ({_tag: 17, _name: "TGen", _val: 1})]}), _tl: ({_hd: ({_tag: 17, _name: "TGen", _val: 0}), _tl: ({_hd: ({_tag: 17, _name: "TGen", _val: 1}), _tl: null})})}), ({_hd: ["at", "index_at_map", 2], _tl: null})), undefined);
  load_12047("iter");
  load_12047("show");
  load_12047("iter_map");
  (ctx_12039 = Main$register_native_instance(ctx_12039, global_names, "Show", ({_hd: ({_tag: 13, _name: "TMap", _val: [({_tag: 17, _name: "TGen", _val: 0}), ({_tag: 17, _name: "TGen", _val: 1})]}), _tl: null}), ({_hd: ["show", "show_map", 1], _tl: null})), undefined);
  function _t12068(__p379) {
    let _t12070;
    const _t12069 = __p379;
    _t12071: {
      if (true) {
        const name = _t12069[0];
        _t12070 = ((name === "None") || (name === "Some"));
        break _t12071;
      }
      _match_fail("line 15950");
    }
    return _t12070;
  }
  const stdlib_constructors_12072 = List$filter(_t12068, ctx_12039.type_env.constructors);
  const stdlib_info_12074 = ({mod_instances: null, mod_name: "Stdlib", mod_opaque_types: null, mod_pub_classes: null, mod_pub_constructors: stdlib_constructors_12072, mod_pub_mutable_vars: null, mod_pub_types: null, mod_pub_vars: stdlib_pub_vars, mod_submodules: null});
  const __rec_upd_12076 = ctx_12039;
  const __rec_upd_12078 = ctx_12039.type_env;
  const _t12079 = ({classes: __rec_upd_12078.classes, constructors: __rec_upd_12078.constructors, effects: __rec_upd_12078.effects, instances: __rec_upd_12078.instances, modules: ({_hd: ["Stdlib", stdlib_info_12074], _tl: ctx_12039.type_env.modules}), mutable_fields: __rec_upd_12078.mutable_fields, records: __rec_upd_12078.records, type_aliases: __rec_upd_12078.type_aliases, type_synonyms: __rec_upd_12078.type_synonyms, variants: __rec_upd_12078.variants});
  const _t12077 = ({constraint_tvars: __rec_upd_12076.constraint_tvars, current_eff: __rec_upd_12076.current_eff, current_module: __rec_upd_12076.current_module, inside_handler: __rec_upd_12076.inside_handler, loop_info: __rec_upd_12076.loop_info, mutable_vars: __rec_upd_12076.mutable_vars, return_type: __rec_upd_12076.return_type, return_used: __rec_upd_12076.return_used, type_env: _t12079, vars: __rec_upd_12076.vars});
  (ctx_12039 = _t12077, undefined);
  const _t12075 = [ctx_12039, List$rev(setup_protos_12041)];
  const _t12073 = _t12075;
  const _t12067 = _t12073;
  const _t12065 = _t12067;
  const _t12063 = _t12065;
  const _t12061 = _t12063;
  const _t12059 = _t12061;
  const _t12048 = _t12059;
  const _t12042 = _t12048;
  const _t12040 = _t12042;
  const _t12038 = _t12040;
  const _t12036 = _t12038;
  const _t12034 = _t12036;
  return _t12034;
}
function Main$setup_modules(ctx, global_names, mutable_globals) {
  let pub_vars_12080 = null;
  let ctx_12082 = ctx;
  let setup_protos_12084 = null;
  function _t12086(__dict_Show_0, mod_name, fn_name, ty, arity) {
    let _t12088;
    const _t12087 = Main$register_module_fn(ctx_12082, global_names, mod_name, fn_name, ty, arity);
    _t12089: {
      if (true) {
        const pv = _t12087[0];
        const ctx2 = _t12087[1];
        (pub_vars_12080 = ({_hd: pv, _tl: pub_vars_12080}), undefined);
        _t12088 = (ctx_12082 = ctx2, undefined);
        break _t12089;
      }
      _match_fail("line 15950");
    }
    return _t12088;
  }
  const register_fn_12090 = _t12086;
  function _t12092(name) {
    let _t12094;
    const _t12093 = Main$compile_setup(ctx_12082, global_names, mutable_globals, IO$read_file((("stdlib/" + name) + ".mml")));
    _t12095: {
      if (true) {
        const ctx2 = _t12093[0];
        const proto = _t12093[1];
        (ctx_12082 = ctx2, undefined);
        _t12094 = (setup_protos_12084 = ({_hd: proto, _tl: setup_protos_12084}), undefined);
        break _t12095;
      }
      _match_fail("line 15950");
    }
    return _t12094;
  }
  const load_12096 = _t12092;
  function _t12098(source) {
    let _t12100;
    const _t12099 = Main$compile_setup(ctx_12082, global_names, mutable_globals, source);
    _t12101: {
      if (true) {
        const ctx2 = _t12099[0];
        const proto = _t12099[1];
        (ctx_12082 = ctx2, undefined);
        _t12100 = (setup_protos_12084 = ({_hd: proto, _tl: setup_protos_12084}), undefined);
        break _t12101;
      }
      _match_fail("line 15950");
    }
    return _t12100;
  }
  const load_source_12102 = _t12098;
  (pub_vars_12080 = null, undefined);
  _call(register_fn_12090, [__dict_Show_int, "String", "length", Main$arr(({_tag: 3, _name: "TString"}), ({_tag: 0, _name: "TInt"})), 1]);
  _call(register_fn_12090, [__dict_Show_int, "String", "sub", Main$arr3(({_tag: 3, _name: "TString"}), ({_tag: 0, _name: "TInt"}), ({_tag: 0, _name: "TInt"}), ({_tag: 3, _name: "TString"})), 3]);
  _call(register_fn_12090, [__dict_Show_int, "String", "split", Main$arr2(({_tag: 3, _name: "TString"}), ({_tag: 3, _name: "TString"}), ({_tag: 10, _name: "TList", _val: ({_tag: 3, _name: "TString"})})), 2]);
  _call(register_fn_12090, [__dict_Show_int, "String", "trim", Main$arr(({_tag: 3, _name: "TString"}), ({_tag: 3, _name: "TString"})), 1]);
  _call(register_fn_12090, [__dict_Show_int, "String", "starts_with", Main$arr2(({_tag: 3, _name: "TString"}), ({_tag: 3, _name: "TString"}), ({_tag: 2, _name: "TBool"})), 2]);
  _call(register_fn_12090, [__dict_Show_int, "String", "contains", Main$arr2(({_tag: 3, _name: "TString"}), ({_tag: 3, _name: "TString"}), ({_tag: 2, _name: "TBool"})), 2]);
  _call(register_fn_12090, [__dict_Show_int, "String", "replace", Main$arr3(({_tag: 3, _name: "TString"}), ({_tag: 3, _name: "TString"}), ({_tag: 3, _name: "TString"}), ({_tag: 3, _name: "TString"})), 3]);
  _call(register_fn_12090, [__dict_Show_int, "String", "to_int", Main$arr(({_tag: 3, _name: "TString"}), ({_tag: 12, _name: "TVariant", _val: ["option", ({_hd: ({_tag: 0, _name: "TInt"}), _tl: null})]})), 1]);
  _call(register_fn_12090, [__dict_Show_int, "String", "to_float", Main$arr(({_tag: 3, _name: "TString"}), ({_tag: 12, _name: "TVariant", _val: ["option", ({_hd: ({_tag: 1, _name: "TFloat"}), _tl: null})]})), 1]);
  _call(register_fn_12090, [__dict_Show_int, "String", "uppercase", Main$arr(({_tag: 3, _name: "TString"}), ({_tag: 3, _name: "TString"})), 1]);
  _call(register_fn_12090, [__dict_Show_int, "String", "lowercase", Main$arr(({_tag: 3, _name: "TString"}), ({_tag: 3, _name: "TString"})), 1]);
  _call(register_fn_12090, [__dict_Show_int, "String", "get", Main$arr2(({_tag: 3, _name: "TString"}), ({_tag: 0, _name: "TInt"}), ({_tag: 4, _name: "TByte"})), 2]);
  _call(register_fn_12090, [__dict_Show_int, "String", "to_bytes", Main$arr(({_tag: 3, _name: "TString"}), ({_tag: 10, _name: "TList", _val: ({_tag: 4, _name: "TByte"})})), 1]);
  _call(register_fn_12090, [__dict_Show_int, "String", "of_bytes", Main$arr(({_tag: 10, _name: "TList", _val: ({_tag: 4, _name: "TByte"})}), ({_tag: 3, _name: "TString"})), 1]);
  _call(register_fn_12090, [__dict_Show_int, "String", "to_byte_array", Main$arr(({_tag: 3, _name: "TString"}), ({_tag: 14, _name: "TArray", _val: ({_tag: 4, _name: "TByte"})})), 1]);
  _call(register_fn_12090, [__dict_Show_int, "String", "of_byte_array", Main$arr(({_tag: 14, _name: "TArray", _val: ({_tag: 4, _name: "TByte"})}), ({_tag: 3, _name: "TString"})), 1]);
  _call(register_fn_12090, [__dict_Show_int, "String", "to_runes", Main$arr(({_tag: 3, _name: "TString"}), ({_tag: 10, _name: "TList", _val: ({_tag: 5, _name: "TRune"})})), 1]);
  _call(register_fn_12090, [__dict_Show_int, "String", "of_runes", Main$arr(({_tag: 10, _name: "TList", _val: ({_tag: 5, _name: "TRune"})}), ({_tag: 3, _name: "TString"})), 1]);
  _call(register_fn_12090, [__dict_Show_int, "String", "get_rune", Main$arr2(({_tag: 3, _name: "TString"}), ({_tag: 0, _name: "TInt"}), ({_tag: 5, _name: "TRune"})), 2]);
  _call(register_fn_12090, [__dict_Show_int, "String", "of_byte", Main$arr(({_tag: 4, _name: "TByte"}), ({_tag: 3, _name: "TString"})), 1]);
  _call(register_fn_12090, [__dict_Show_int, "String", "rune_length", Main$arr(({_tag: 3, _name: "TString"}), ({_tag: 0, _name: "TInt"})), 1]);
  _call(register_fn_12090, [__dict_Show_int, "String", "make", Main$arr2(({_tag: 0, _name: "TInt"}), ({_tag: 4, _name: "TByte"}), ({_tag: 3, _name: "TString"})), 2]);
  _call(register_fn_12090, [__dict_Show_int, "String", "index_opt", Main$arr2(({_tag: 3, _name: "TString"}), ({_tag: 4, _name: "TByte"}), ({_tag: 12, _name: "TVariant", _val: ["option", ({_hd: ({_tag: 0, _name: "TInt"}), _tl: null})]})), 2]);
  _call(register_fn_12090, [__dict_Show_int, "String", "rindex_opt", Main$arr2(({_tag: 3, _name: "TString"}), ({_tag: 4, _name: "TByte"}), ({_tag: 12, _name: "TVariant", _val: ["option", ({_hd: ({_tag: 0, _name: "TInt"}), _tl: null})]})), 2]);
  _call(register_fn_12090, [__dict_Show_int, "String", "concat", Main$arr2(({_tag: 3, _name: "TString"}), ({_tag: 10, _name: "TList", _val: ({_tag: 3, _name: "TString"})}), ({_tag: 3, _name: "TString"})), 2]);
  _call(register_fn_12090, [__dict_Show_int, "String", "compare", Main$arr2(({_tag: 3, _name: "TString"}), ({_tag: 3, _name: "TString"}), ({_tag: 0, _name: "TInt"})), 2]);
  const string_info_12104 = ({mod_instances: null, mod_name: "String", mod_opaque_types: null, mod_pub_classes: null, mod_pub_constructors: null, mod_pub_mutable_vars: null, mod_pub_types: null, mod_pub_vars: pub_vars_12080, mod_submodules: null});
  const __rec_upd_12106 = ctx_12082;
  const __rec_upd_12108 = ctx_12082.type_env;
  const _t12109 = ({classes: __rec_upd_12108.classes, constructors: __rec_upd_12108.constructors, effects: __rec_upd_12108.effects, instances: __rec_upd_12108.instances, modules: ({_hd: ["String", string_info_12104], _tl: ctx_12082.type_env.modules}), mutable_fields: __rec_upd_12108.mutable_fields, records: __rec_upd_12108.records, type_aliases: __rec_upd_12108.type_aliases, type_synonyms: __rec_upd_12108.type_synonyms, variants: __rec_upd_12108.variants});
  const _t12107 = ({constraint_tvars: __rec_upd_12106.constraint_tvars, current_eff: __rec_upd_12106.current_eff, current_module: __rec_upd_12106.current_module, inside_handler: __rec_upd_12106.inside_handler, loop_info: __rec_upd_12106.loop_info, mutable_vars: __rec_upd_12106.mutable_vars, return_type: __rec_upd_12106.return_type, return_used: __rec_upd_12106.return_used, type_env: _t12109, vars: __rec_upd_12106.vars});
  (ctx_12082 = _t12107, undefined);
  load_source_12102("module String = pub let iter f s = let n = String.length s in let rec go i = if i >= n do () else (f (String.get s i); go (i + 1)) in go 0 end");
  load_12096("list");
  (pub_vars_12080 = null, undefined);
  _call(register_fn_12090, [__dict_Show_int, "Array", "make", Main$arr2(({_tag: 0, _name: "TInt"}), ({_tag: 17, _name: "TGen", _val: 0}), ({_tag: 14, _name: "TArray", _val: ({_tag: 17, _name: "TGen", _val: 0})})), 2]);
  _call(register_fn_12090, [__dict_Show_int, "Array", "get", Main$arr2(({_tag: 14, _name: "TArray", _val: ({_tag: 17, _name: "TGen", _val: 0})}), ({_tag: 0, _name: "TInt"}), ({_tag: 17, _name: "TGen", _val: 0})), 2]);
  _call(register_fn_12090, [__dict_Show_int, "Array", "set", Main$arr3(({_tag: 14, _name: "TArray", _val: ({_tag: 17, _name: "TGen", _val: 0})}), ({_tag: 0, _name: "TInt"}), ({_tag: 17, _name: "TGen", _val: 0}), ({_tag: 6, _name: "TUnit"})), 3]);
  _call(register_fn_12090, [__dict_Show_int, "Array", "length", Main$arr(({_tag: 14, _name: "TArray", _val: ({_tag: 17, _name: "TGen", _val: 0})}), ({_tag: 0, _name: "TInt"})), 1]);
  _call(register_fn_12090, [__dict_Show_int, "Array", "to_list", Main$arr(({_tag: 14, _name: "TArray", _val: ({_tag: 17, _name: "TGen", _val: 0})}), ({_tag: 10, _name: "TList", _val: ({_tag: 17, _name: "TGen", _val: 0})})), 1]);
  _call(register_fn_12090, [__dict_Show_int, "Array", "of_list", Main$arr(({_tag: 10, _name: "TList", _val: ({_tag: 17, _name: "TGen", _val: 0})}), ({_tag: 14, _name: "TArray", _val: ({_tag: 17, _name: "TGen", _val: 0})})), 1]);
  _call(register_fn_12090, [__dict_Show_int, "Array", "copy", Main$arr(({_tag: 14, _name: "TArray", _val: ({_tag: 17, _name: "TGen", _val: 0})}), ({_tag: 14, _name: "TArray", _val: ({_tag: 17, _name: "TGen", _val: 0})})), 1]);
  _call(register_fn_12090, [__dict_Show_int, "Array", "sub", Main$arr3(({_tag: 14, _name: "TArray", _val: ({_tag: 17, _name: "TGen", _val: 0})}), ({_tag: 0, _name: "TInt"}), ({_tag: 0, _name: "TInt"}), ({_tag: 14, _name: "TArray", _val: ({_tag: 17, _name: "TGen", _val: 0})})), 3]);
  const array_info_12110 = ({mod_instances: null, mod_name: "Array", mod_opaque_types: null, mod_pub_classes: null, mod_pub_constructors: null, mod_pub_mutable_vars: null, mod_pub_types: null, mod_pub_vars: pub_vars_12080, mod_submodules: null});
  const __rec_upd_12112 = ctx_12082;
  const __rec_upd_12114 = ctx_12082.type_env;
  const _t12115 = ({classes: __rec_upd_12114.classes, constructors: __rec_upd_12114.constructors, effects: __rec_upd_12114.effects, instances: __rec_upd_12114.instances, modules: ({_hd: ["Array", array_info_12110], _tl: ctx_12082.type_env.modules}), mutable_fields: __rec_upd_12114.mutable_fields, records: __rec_upd_12114.records, type_aliases: __rec_upd_12114.type_aliases, type_synonyms: __rec_upd_12114.type_synonyms, variants: __rec_upd_12114.variants});
  const _t12113 = ({constraint_tvars: __rec_upd_12112.constraint_tvars, current_eff: __rec_upd_12112.current_eff, current_module: __rec_upd_12112.current_module, inside_handler: __rec_upd_12112.inside_handler, loop_info: __rec_upd_12112.loop_info, mutable_vars: __rec_upd_12112.mutable_vars, return_type: __rec_upd_12112.return_type, return_used: __rec_upd_12112.return_used, type_env: _t12115, vars: __rec_upd_12112.vars});
  (ctx_12082 = _t12113, undefined);
  load_12096("array_extra");
  (pub_vars_12080 = null, undefined);
  _call(register_fn_12090, [__dict_Show_int, "IO", "read_file", Main$arr(({_tag: 3, _name: "TString"}), ({_tag: 3, _name: "TString"})), 1]);
  _call(register_fn_12090, [__dict_Show_int, "IO", "write_file", Main$arr2(({_tag: 3, _name: "TString"}), ({_tag: 3, _name: "TString"}), ({_tag: 6, _name: "TUnit"})), 2]);
  _call(register_fn_12090, [__dict_Show_int, "IO", "append_file", Main$arr2(({_tag: 3, _name: "TString"}), ({_tag: 3, _name: "TString"}), ({_tag: 6, _name: "TUnit"})), 2]);
  _call(register_fn_12090, [__dict_Show_int, "IO", "read_line", Main$arr(({_tag: 6, _name: "TUnit"}), ({_tag: 3, _name: "TString"})), 1]);
  _call(register_fn_12090, [__dict_Show_int, "IO", "file_exists", Main$arr(({_tag: 3, _name: "TString"}), ({_tag: 2, _name: "TBool"})), 1]);
  const io_info_12116 = ({mod_instances: null, mod_name: "IO", mod_opaque_types: null, mod_pub_classes: null, mod_pub_constructors: null, mod_pub_mutable_vars: null, mod_pub_types: null, mod_pub_vars: pub_vars_12080, mod_submodules: null});
  const __rec_upd_12118 = ctx_12082;
  const __rec_upd_12120 = ctx_12082.type_env;
  const _t12121 = ({classes: __rec_upd_12120.classes, constructors: __rec_upd_12120.constructors, effects: __rec_upd_12120.effects, instances: __rec_upd_12120.instances, modules: ({_hd: ["IO", io_info_12116], _tl: ctx_12082.type_env.modules}), mutable_fields: __rec_upd_12120.mutable_fields, records: __rec_upd_12120.records, type_aliases: __rec_upd_12120.type_aliases, type_synonyms: __rec_upd_12120.type_synonyms, variants: __rec_upd_12120.variants});
  const _t12119 = ({constraint_tvars: __rec_upd_12118.constraint_tvars, current_eff: __rec_upd_12118.current_eff, current_module: __rec_upd_12118.current_module, inside_handler: __rec_upd_12118.inside_handler, loop_info: __rec_upd_12118.loop_info, mutable_vars: __rec_upd_12118.mutable_vars, return_type: __rec_upd_12118.return_type, return_used: __rec_upd_12118.return_used, type_env: _t12121, vars: __rec_upd_12118.vars});
  (ctx_12082 = _t12119, undefined);
  (pub_vars_12080 = null, undefined);
  _call(register_fn_12090, [__dict_Show_int, "Sys", "args", Main$arr(({_tag: 6, _name: "TUnit"}), ({_tag: 10, _name: "TList", _val: ({_tag: 3, _name: "TString"})})), 1]);
  _call(register_fn_12090, [__dict_Show_int, "Sys", "getenv", Main$arr(({_tag: 3, _name: "TString"}), ({_tag: 12, _name: "TVariant", _val: ["option", ({_hd: ({_tag: 3, _name: "TString"}), _tl: null})]})), 1]);
  _call(register_fn_12090, [__dict_Show_int, "Sys", "exit", Main$arr(({_tag: 0, _name: "TInt"}), ({_tag: 6, _name: "TUnit"})), 1]);
  _call(register_fn_12090, [__dict_Show_int, "Sys", "time", Main$arr(({_tag: 6, _name: "TUnit"}), ({_tag: 1, _name: "TFloat"})), 1]);
  const sys_info_12122 = ({mod_instances: null, mod_name: "Sys", mod_opaque_types: null, mod_pub_classes: null, mod_pub_constructors: null, mod_pub_mutable_vars: null, mod_pub_types: null, mod_pub_vars: pub_vars_12080, mod_submodules: null});
  const __rec_upd_12124 = ctx_12082;
  const __rec_upd_12126 = ctx_12082.type_env;
  const _t12127 = ({classes: __rec_upd_12126.classes, constructors: __rec_upd_12126.constructors, effects: __rec_upd_12126.effects, instances: __rec_upd_12126.instances, modules: ({_hd: ["Sys", sys_info_12122], _tl: ctx_12082.type_env.modules}), mutable_fields: __rec_upd_12126.mutable_fields, records: __rec_upd_12126.records, type_aliases: __rec_upd_12126.type_aliases, type_synonyms: __rec_upd_12126.type_synonyms, variants: __rec_upd_12126.variants});
  const _t12125 = ({constraint_tvars: __rec_upd_12124.constraint_tvars, current_eff: __rec_upd_12124.current_eff, current_module: __rec_upd_12124.current_module, inside_handler: __rec_upd_12124.inside_handler, loop_info: __rec_upd_12124.loop_info, mutable_vars: __rec_upd_12124.mutable_vars, return_type: __rec_upd_12124.return_type, return_used: __rec_upd_12124.return_used, type_env: _t12127, vars: __rec_upd_12124.vars});
  (ctx_12082 = _t12125, undefined);
  load_12096("math");
  load_12096("result");
  load_12096("byte");
  load_12096("rune");
  load_12096("set");
  load_12096("enum");
  load_12096("seq");
  load_12096("option");
  load_12096("buffer");
  load_12096("fmt");
  load_12096("hash");
  load_12096("hashtbl");
  load_12096("ref");
  load_12096("dynarray");
  load_12096("compat");
  (pub_vars_12080 = null, undefined);
  _call(register_fn_12090, [__dict_Show_int, "Runtime", "eval", Main$arr(({_tag: 3, _name: "TString"}), ({_tag: 6, _name: "TUnit"})), 1]);
  _call(register_fn_12090, [__dict_Show_int, "Runtime", "eval_file", Main$arr(({_tag: 3, _name: "TString"}), ({_tag: 6, _name: "TUnit"})), 1]);
  const runtime_info_12128 = ({mod_instances: null, mod_name: "Runtime", mod_opaque_types: null, mod_pub_classes: null, mod_pub_constructors: null, mod_pub_mutable_vars: null, mod_pub_types: null, mod_pub_vars: pub_vars_12080, mod_submodules: null});
  const __rec_upd_12130 = ctx_12082;
  const __rec_upd_12132 = ctx_12082.type_env;
  const _t12133 = ({classes: __rec_upd_12132.classes, constructors: __rec_upd_12132.constructors, effects: __rec_upd_12132.effects, instances: __rec_upd_12132.instances, modules: ({_hd: ["Runtime", runtime_info_12128], _tl: ctx_12082.type_env.modules}), mutable_fields: __rec_upd_12132.mutable_fields, records: __rec_upd_12132.records, type_aliases: __rec_upd_12132.type_aliases, type_synonyms: __rec_upd_12132.type_synonyms, variants: __rec_upd_12132.variants});
  const _t12131 = ({constraint_tvars: __rec_upd_12130.constraint_tvars, current_eff: __rec_upd_12130.current_eff, current_module: __rec_upd_12130.current_module, inside_handler: __rec_upd_12130.inside_handler, loop_info: __rec_upd_12130.loop_info, mutable_vars: __rec_upd_12130.mutable_vars, return_type: __rec_upd_12130.return_type, return_used: __rec_upd_12130.return_used, type_env: _t12133, vars: __rec_upd_12130.vars});
  (ctx_12082 = _t12131, undefined);
  const _t12129 = [ctx_12082, List$rev(setup_protos_12084)];
  const _t12123 = _t12129;
  const _t12117 = _t12123;
  const _t12111 = _t12117;
  const _t12105 = _t12111;
  const _t12103 = _t12105;
  const _t12097 = _t12103;
  const _t12091 = _t12097;
  const _t12085 = _t12091;
  const _t12083 = _t12085;
  const _t12081 = _t12083;
  return _t12081;
}
function Main$run_batch(manifest_file) {
  const _t12134 = (function() {
    const _t12135 = _h;
    _h = Object.assign({}, _t12135, {
      "lex_error": function(arg, _k) { throw {_e: "lex_error", _v: arg}; },
      "parse_error": function(arg, _k) { throw {_e: "parse_error", _v: arg}; },
      "type_error": function(arg, _k) { throw {_e: "type_error", _v: arg}; },
      "compile_error": function(msg, _k) { throw {_e: "compile_error", _v: msg}; },
      "unify_error": function(msg, _k) { throw {_e: "unify_error", _v: msg}; },
    });
    try {
      const manifest_12136 = IO$read_file(manifest_file);
      function _t12138(s) {
        return (s !== "");
      }
      const files_12139 = List$filter(_t12138, String$split("\n", manifest_12136));
      let _t12142;
      const _t12141 = Main$setup_builtins(undefined);
      _t12143: {
        if (true) {
          const ctx = _t12141[0];
          const global_names = _t12141[1];
          const mutable_globals = _t12141[2];
          const stdlib_pub_vars = _t12141[3];
          const ctx_12144 = Main$setup_option_type(ctx);
          let _t12147;
          const _t12146 = Main$setup_classes(ctx_12144, global_names, mutable_globals, stdlib_pub_vars);
          _t12148: {
            if (true) {
              const ctx = _t12146[0];
              const class_protos = _t12146[1];
              let _t12150;
              const _t12149 = Main$setup_modules(ctx, global_names, mutable_globals);
              _t12151: {
                if (true) {
                  const ctx = _t12149[0];
                  const module_protos = _t12149[1];
                  const setup_protos_12152 = List$concat(class_protos, module_protos);
                  const base_gn_len_12154 = Dynarray$length(global_names);
                  const base_native_12156 = Main$native_global_entries;
                  const base_mutable_12158 = Hashtbl$to_list(mutable_globals);
                  function _t12160(filename) {
                    (global_names.count = base_gn_len_12154, undefined);
                    (Main$native_global_entries = base_native_12156, undefined);
                    Hashtbl$clear(mutable_globals);
                    function _t12161(__p380) {
                      let _t12163;
                      const _t12162 = __p380;
                      _t12164: {
                        if (true) {
                          const k = _t12162[0];
                          const v = _t12162[1];
                          _t12163 = _call(Hashtbl$set, [__dict_Hash_string, __dict_Eq_string, mutable_globals, k, v]);
                          break _t12164;
                        }
                        _match_fail("line 15950");
                      }
                      return _t12163;
                    }
                    Main$list_iter(_t12161, base_mutable_12158);
                    const _t12165 = (function() {
                      const _t12166 = _h;
                      _h = Object.assign({}, _t12166, {
                        "lex_error": function(arg, _k) { throw {_e: "lex_error", _v: arg}; },
                        "parse_error": function(arg, _k) { throw {_e: "parse_error", _v: arg}; },
                        "type_error": function(arg, _k) { throw {_e: "type_error", _v: arg}; },
                        "compile_error": function(msg, _k) { throw {_e: "compile_error", _v: msg}; },
                        "unify_error": function(msg, _k) { throw {_e: "unify_error", _v: msg}; },
                      });
                      try {
                        const source_12167 = IO$read_file(filename);
                        const tokens_12169 = Lexer$tokenize(source_12167);
                        const program_12171 = Parser$parse_program(tokens_12169);
                        let _t12174;
                        const _t12173 = Typechecker$check_program_in_ctx(ctx, program_12171);
                        _t12175: {
                          if (true) {
                            const ctx2 = _t12173[0];
                            const typed_program = _t12173[1];
                            const typed_program2_12176 = Typechecker$transform_constraints(ctx2, typed_program);
                            const compiled_12178 = Compiler$compile_program_with_globals(ctx2.type_env, global_names, mutable_globals, typed_program2_12176);
                            const ng_json_12180 = _t11800_Main$build_native_globals_json(undefined);
                            const json_12182 = Serialize$serialize_bundle(global_names, ng_json_12180, setup_protos_12152, compiled_12178.main);
                            print(json_12182);
                            const _t12183 = print("===BATCH-SEP===");
                            const _t12181 = _t12183;
                            const _t12179 = _t12181;
                            const _t12177 = _t12179;
                            _t12174 = _t12177;
                            break _t12175;
                          }
                          _match_fail("line 15950");
                        }
                        const _t12172 = _t12174;
                        const _t12170 = _t12172;
                        const _t12168 = _t12170;
                        const x_12184 = _t12168;
                        return x_12184;
                      } catch (_exc) {
                        if (_exc && _exc._e === "lex_error") {
                          const arg = _exc._v;
                          let _t12186;
                          const _t12185 = arg;
                          _t12187: {
                            if (true) {
                              const msg = _t12185[0];
                              const _loc = _t12185[1];
                              print(("COMPILE-ERROR:" + msg));
                              _t12186 = print("===BATCH-SEP===");
                              break _t12187;
                            }
                            _match_fail("line 15950");
                          }
                          return _t12186;
                        } else if (_exc && _exc._e === "parse_error") {
                          const arg = _exc._v;
                          let _t12189;
                          const _t12188 = arg;
                          _t12190: {
                            if (true) {
                              const msg = _t12188[0];
                              const _loc = _t12188[1];
                              print(("COMPILE-ERROR:" + msg));
                              _t12189 = print("===BATCH-SEP===");
                              break _t12190;
                            }
                            _match_fail("line 15950");
                          }
                          return _t12189;
                        } else if (_exc && _exc._e === "type_error") {
                          const arg = _exc._v;
                          let _t12192;
                          const _t12191 = arg;
                          _t12193: {
                            if (true) {
                              const msg = _t12191[0];
                              const _loc = _t12191[1];
                              print(("COMPILE-ERROR:" + msg));
                              _t12192 = print("===BATCH-SEP===");
                              break _t12193;
                            }
                            _match_fail("line 15950");
                          }
                          return _t12192;
                        } else if (_exc && _exc._e === "compile_error") {
                          const msg = _exc._v;
                          print(("COMPILE-ERROR:" + msg));
                          return print("===BATCH-SEP===");
                        } else if (_exc && _exc._e === "unify_error") {
                          const msg = _exc._v;
                          print(("COMPILE-ERROR:" + msg));
                          return print("===BATCH-SEP===");
                        } else { throw _exc; }
                      } finally { _h = _t12166; }
                    })();
                    return _t12165;
                  }
                  const _t12159 = Main$list_iter(_t12160, files_12139);
                  const _t12157 = _t12159;
                  const _t12155 = _t12157;
                  const _t12153 = _t12155;
                  _t12150 = _t12153;
                  break _t12151;
                }
                _match_fail("line 15950");
              }
              _t12147 = _t12150;
              break _t12148;
            }
            _match_fail("line 15950");
          }
          const _t12145 = _t12147;
          _t12142 = _t12145;
          break _t12143;
        }
        _match_fail("line 15950");
      }
      const _t12140 = _t12142;
      const _t12137 = _t12140;
      const x_12194 = _t12137;
      return x_12194;
    } catch (_exc) {
      if (_exc && _exc._e === "lex_error") {
        const arg = _exc._v;
        let _t12196;
        const _t12195 = arg;
        _t12197: {
          if (true) {
            const msg = _t12195[0];
            const _loc = _t12195[1];
            _t12196 = failwith(msg);
            break _t12197;
          }
          _match_fail("line 15950");
        }
        return _t12196;
      } else if (_exc && _exc._e === "parse_error") {
        const arg = _exc._v;
        let _t12199;
        const _t12198 = arg;
        _t12200: {
          if (true) {
            const msg = _t12198[0];
            const _loc = _t12198[1];
            _t12199 = failwith(msg);
            break _t12200;
          }
          _match_fail("line 15950");
        }
        return _t12199;
      } else if (_exc && _exc._e === "type_error") {
        const arg = _exc._v;
        let _t12202;
        const _t12201 = arg;
        _t12203: {
          if (true) {
            const msg = _t12201[0];
            const _loc = _t12201[1];
            _t12202 = failwith(msg);
            break _t12203;
          }
          _match_fail("line 15950");
        }
        return _t12202;
      } else if (_exc && _exc._e === "compile_error") {
        const msg = _exc._v;
        return failwith(msg);
      } else if (_exc && _exc._e === "unify_error") {
        const msg = _exc._v;
        return failwith(msg);
      } else { throw _exc; }
    } finally { _h = _t12135; }
  })();
  return _t12134;
}
function Main$run_emit_js(args) {
  const _t12204 = (function() {
    const _t12205 = _h;
    _h = Object.assign({}, _t12205, {
      "lex_error": function(arg, _k) { throw {_e: "lex_error", _v: arg}; },
      "parse_error": function(arg, _k) { throw {_e: "parse_error", _v: arg}; },
      "type_error": function(arg, _k) { throw {_e: "type_error", _v: arg}; },
      "compile_error": function(msg, _k) { throw {_e: "compile_error", _v: msg}; },
      "unify_error": function(msg, _k) { throw {_e: "unify_error", _v: msg}; },
      "codegen_error": function(msg, _k) { throw {_e: "codegen_error", _v: msg}; },
    });
    try {
      (Main$js_capture_mode = true, undefined);
      (Main$captured_typed_setups = null, undefined);
      let _t12207;
      const _t12206 = Main$setup_builtins(undefined);
      _t12208: {
        if (true) {
          const ctx = _t12206[0];
          const global_names = _t12206[1];
          const mutable_globals = _t12206[2];
          const stdlib_pub_vars = _t12206[3];
          const ctx_12209 = Main$setup_option_type(ctx);
          let _t12212;
          const _t12211 = Main$setup_classes(ctx_12209, global_names, mutable_globals, stdlib_pub_vars);
          _t12213: {
            if (true) {
              const ctx = _t12211[0];
              const _class_protos = _t12211[1];
              let _t12215;
              const _t12214 = Main$setup_modules(ctx, global_names, mutable_globals);
              _t12216: {
                if (true) {
                  const ctx = _t12214[0];
                  const _module_protos = _t12214[1];
                  let _t12218;
                  const _t12217 = args;
                  _t12219: {
                    if (_t12217 !== null && _t12217._tl !== null) {
                      const file = _t12217._tl._hd;
                      _t12218 = file;
                      break _t12219;
                    }
                    if (true) {
                      _t12218 = failwith("Usage: compiler --emit-js <source-file>");
                      break _t12219;
                    }
                    _match_fail("line 15950");
                  }
                  const filename_12220 = _t12218;
                  const source_12222 = IO$read_file(filename_12220);
                  const tokens_12224 = Lexer$tokenize(source_12222);
                  const program_12226 = Parser$parse_program(tokens_12224);
                  let _t12229;
                  const _t12228 = Typechecker$check_program_in_ctx(ctx, program_12226);
                  _t12230: {
                    if (true) {
                      const ctx2 = _t12228[0];
                      const typed_program = _t12228[1];
                      const typed_program2_12231 = Typechecker$transform_constraints(ctx2, typed_program);
                      const js_12233 = Js_codegen$compile_program_with_stdlib(ctx2.type_env, Main$captured_typed_setups, typed_program2_12231);
                      const _t12234 = print(js_12233);
                      const _t12232 = _t12234;
                      _t12229 = _t12232;
                      break _t12230;
                    }
                    _match_fail("line 15950");
                  }
                  const _t12227 = _t12229;
                  const _t12225 = _t12227;
                  const _t12223 = _t12225;
                  const _t12221 = _t12223;
                  _t12215 = _t12221;
                  break _t12216;
                }
                _match_fail("line 15950");
              }
              _t12212 = _t12215;
              break _t12213;
            }
            _match_fail("line 15950");
          }
          const _t12210 = _t12212;
          _t12207 = _t12210;
          break _t12208;
        }
        _match_fail("line 15950");
      }
      const x_12235 = _t12207;
      return x_12235;
    } catch (_exc) {
      if (_exc && _exc._e === "lex_error") {
        const arg = _exc._v;
        let _t12237;
        const _t12236 = arg;
        _t12238: {
          if (true) {
            const msg = _t12236[0];
            const _loc = _t12236[1];
            _t12237 = failwith(msg);
            break _t12238;
          }
          _match_fail("line 15950");
        }
        return _t12237;
      } else if (_exc && _exc._e === "parse_error") {
        const arg = _exc._v;
        let _t12240;
        const _t12239 = arg;
        _t12241: {
          if (true) {
            const msg = _t12239[0];
            const _loc = _t12239[1];
            _t12240 = failwith(msg);
            break _t12241;
          }
          _match_fail("line 15950");
        }
        return _t12240;
      } else if (_exc && _exc._e === "type_error") {
        const arg = _exc._v;
        let _t12243;
        const _t12242 = arg;
        _t12244: {
          if (true) {
            const msg = _t12242[0];
            const _loc = _t12242[1];
            _t12243 = failwith(msg);
            break _t12244;
          }
          _match_fail("line 15950");
        }
        return _t12243;
      } else if (_exc && _exc._e === "compile_error") {
        const msg = _exc._v;
        return failwith(msg);
      } else if (_exc && _exc._e === "unify_error") {
        const msg = _exc._v;
        return failwith(msg);
      } else if (_exc && _exc._e === "codegen_error") {
        const msg = _exc._v;
        return failwith(("JS codegen error: " + msg));
      } else { throw _exc; }
    } finally { _h = _t12205; }
  })();
  return _t12204;
}
const args_12246 = Sys$args(undefined);
let _t12249;
const _t12248 = args_12246;
_t12250: {
  if (_t12248 !== null && _t12248._tl !== null && _t12248._tl._hd === "--batch" && _t12248._tl._tl !== null) {
    const f = _t12248._tl._tl._hd;
    _t12249 = ({_tag: 1, _name: "Some", _val: f});
    break _t12250;
  }
  if (true) {
    _t12249 = ({_tag: 0, _name: "None"});
    break _t12250;
  }
  _match_fail("line 15950");
}
const batch_file_12251 = _t12249;
function _t12253(a) {
  return (a === "--emit-js");
}
const emit_js_12254 = List$exists(_t12253, args_12246);
function _t12256(a) {
  return (a === "--no-optimize");
}
const no_optimize_12257 = List$exists(_t12256, args_12246);
let _t12259;
if (no_optimize_12257) {
  _t12259 = Ref$set(Compiler$optimize_enabled, false);
} else {
  _t12259 = undefined;
}
_t12259;
function _t12260(a) {
  return ((a !== "--no-optimize") && (a !== "--emit-js"));
}
const args_12261 = List$filter(_t12260, args_12246);
let _t12264;
const _t12263 = batch_file_12251;
_t12265: {
  if (_t12263._tag === 1) {
    const f = _t12263._val;
    _t12264 = Main$run_batch(f);
    break _t12265;
  }
  if (_t12263._tag === 0) {
    let _t12266;
    if (emit_js_12254) {
      _t12266 = Main$run_emit_js(args_12261);
    } else {
      const _t12267 = (function() {
        const _t12268 = _h;
        _h = Object.assign({}, _t12268, {
          "lex_error": function(arg, _k) { throw {_e: "lex_error", _v: arg}; },
          "parse_error": function(arg, _k) { throw {_e: "parse_error", _v: arg}; },
          "type_error": function(arg, _k) { throw {_e: "type_error", _v: arg}; },
          "compile_error": function(msg, _k) { throw {_e: "compile_error", _v: msg}; },
          "unify_error": function(msg, _k) { throw {_e: "unify_error", _v: msg}; },
        });
        try {
          let _t12270;
          const _t12269 = args_12261;
          _t12271: {
            if (_t12269 !== null && _t12269._tl !== null && _t12269._tl._hd === "--emit-json" && _t12269._tl._tl !== null) {
              const file = _t12269._tl._tl._hd;
              _t12270 = file;
              break _t12271;
            }
            if (_t12269 !== null && _t12269._tl !== null) {
              const file = _t12269._tl._hd;
              _t12270 = file;
              break _t12271;
            }
            if (true) {
              _t12270 = failwith("Usage: compiler [--emit-json | --emit-js | --batch <manifest>] <source-file>");
              break _t12271;
            }
            _match_fail("line 15950");
          }
          const filename_12272 = _t12270;
          const source_12274 = IO$read_file(filename_12272);
          let _t12277;
          const _t12276 = Main$setup_builtins(undefined);
          _t12278: {
            if (true) {
              const ctx = _t12276[0];
              const global_names = _t12276[1];
              const mutable_globals = _t12276[2];
              const stdlib_pub_vars = _t12276[3];
              const ctx_12279 = Main$setup_option_type(ctx);
              let _t12282;
              const _t12281 = Main$setup_classes(ctx_12279, global_names, mutable_globals, stdlib_pub_vars);
              _t12283: {
                if (true) {
                  const ctx = _t12281[0];
                  const class_protos = _t12281[1];
                  let _t12285;
                  const _t12284 = Main$setup_modules(ctx, global_names, mutable_globals);
                  _t12286: {
                    if (true) {
                      const ctx = _t12284[0];
                      const module_protos = _t12284[1];
                      const setup_protos_12287 = List$concat(class_protos, module_protos);
                      const tokens_12289 = Lexer$tokenize(source_12274);
                      const program_12291 = Parser$parse_program(tokens_12289);
                      let _t12294;
                      const _t12293 = Typechecker$check_program_in_ctx(ctx, program_12291);
                      _t12295: {
                        if (true) {
                          const ctx2 = _t12293[0];
                          const typed_program = _t12293[1];
                          const typed_program2_12296 = Typechecker$transform_constraints(ctx2, typed_program);
                          const compiled_12298 = Compiler$compile_program_with_globals(ctx2.type_env, global_names, mutable_globals, typed_program2_12296);
                          const ng_json_12300 = _t11800_Main$build_native_globals_json(undefined);
                          const json_12302 = Serialize$serialize_bundle(global_names, ng_json_12300, setup_protos_12287, compiled_12298.main);
                          const _t12303 = print(json_12302);
                          const _t12301 = _t12303;
                          const _t12299 = _t12301;
                          const _t12297 = _t12299;
                          _t12294 = _t12297;
                          break _t12295;
                        }
                        _match_fail("line 15950");
                      }
                      const _t12292 = _t12294;
                      const _t12290 = _t12292;
                      const _t12288 = _t12290;
                      _t12285 = _t12288;
                      break _t12286;
                    }
                    _match_fail("line 15950");
                  }
                  _t12282 = _t12285;
                  break _t12283;
                }
                _match_fail("line 15950");
              }
              const _t12280 = _t12282;
              _t12277 = _t12280;
              break _t12278;
            }
            _match_fail("line 15950");
          }
          const _t12275 = _t12277;
          const _t12273 = _t12275;
          const x_12304 = _t12273;
          return x_12304;
        } catch (_exc) {
          if (_exc && _exc._e === "lex_error") {
            const arg = _exc._v;
            let _t12306;
            const _t12305 = arg;
            _t12307: {
              if (true) {
                const msg = _t12305[0];
                const _loc = _t12305[1];
                _t12306 = failwith(msg);
                break _t12307;
              }
              _match_fail("line 15950");
            }
            return _t12306;
          } else if (_exc && _exc._e === "parse_error") {
            const arg = _exc._v;
            let _t12309;
            const _t12308 = arg;
            _t12310: {
              if (true) {
                const msg = _t12308[0];
                const _loc = _t12308[1];
                _t12309 = failwith(msg);
                break _t12310;
              }
              _match_fail("line 15950");
            }
            return _t12309;
          } else if (_exc && _exc._e === "type_error") {
            const arg = _exc._v;
            let _t12312;
            const _t12311 = arg;
            _t12313: {
              if (true) {
                const msg = _t12311[0];
                const _loc = _t12311[1];
                _t12312 = failwith(msg);
                break _t12313;
              }
              _match_fail("line 15950");
            }
            return _t12312;
          } else if (_exc && _exc._e === "compile_error") {
            const msg = _exc._v;
            return failwith(msg);
          } else if (_exc && _exc._e === "unify_error") {
            const msg = _exc._v;
            return failwith(msg);
          } else { throw _exc; }
        } finally { _h = _t12268; }
      })();
      _t12266 = _t12267;
    }
    _t12264 = _t12266;
    break _t12265;
  }
  _match_fail("line 15950");
}
const _t12262 = _t12264;
const _t12258 = _t12262;
const _t12255 = _t12258;
const _t12252 = _t12255;
const _t12247 = _t12252;
const _t12245_Main$__destruct = _t12247;
if (_last_val !== undefined) println(_pp(_last_val));
var _mml_exports = {"_result": _last_val, "_call": _call, "_pp": _pp};
if (typeof globalThis !== "undefined") globalThis._mmlExports = _mml_exports;
